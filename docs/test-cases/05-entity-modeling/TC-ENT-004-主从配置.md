# TC-ENT-004 主从配置

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-ENT-004 |
| **用例名称** | 主从配置 |
| **所属领域** | 实体建模 |
| **测试类型** | 功能测试 |
| **优先级** | P1 - 重要功能 |
| **版本** | 1.0 |

---

## 1. 测试场景描述

### 1.1 业务背景
系统支持配置实体间的主从关系（如订单-订单明细），用于实现嵌套数据管理。

### 1.2 涉及页面
- `/entity-definitions/{EntityId}/master-detail` - 主从配置页面

---

## 2. 前置条件

| 条件编号 | 条件描述 |
|----------|----------|
| PRE-001 | 已存在至少两个已发布的实体 |
| PRE-002 | 以管理员身份登录 |

---

## 3. 测试数据

```json
{
  "masterEntity": "Order",
  "detailEntity": "OrderItem",
  "foreignKeyField": "OrderId"
}
```

---

## 4. 测试步骤

### 场景 A: 进入主从配置页面

| 步骤 | 操作描述 | 预期结果 | 截图 |
|------|----------|----------|------|
| A1 | 在实体定义页面选择主实体 | 进入实体详情 | - |
| A2 | 导航到主从配置标签页 | 显示主从配置界面 | ✓ |

### 场景 B: 添加从表关系

| 步骤 | 操作描述 | 预期结果 | 截图 |
|------|----------|----------|------|
| B1 | 点击"添加从表"按钮 | 显示从表选择界面 | - |
| B2 | 选择从表实体 | 实体选择成功 | - |
| B3 | 配置外键字段 | 外键映射成功 | - |
| B4 | 保存配置 | 主从关系创建成功 | ✓ |

### 场景 C: 验证主从关系在数据录入中的效果

| 步骤 | 操作描述 | 预期结果 | 截图 |
|------|----------|----------|------|
| C1 | 打开主实体数据页面 | 显示数据列表 | - |
| C2 | 进入某条主记录详情 | 显示从表数据区域 | ✓ |
| C3 | 在从表区域添加数据 | 从表数据创建成功，关联到主记录 | ✓ |

### 场景 D: 删除主从关系

| 步骤 | 操作描述 | 预期结果 | 截图 |
|------|----------|----------|------|
| D1 | 在主从配置中删除关系 | 显示确认对话框 | - |
| D2 | 确认删除 | 关系移除成功 | ✓ |

---

## 5. 预期结果汇总

| 结果编号 | 场景 | 预期结果 |
|----------|------|----------|
| EXP-001 | 查看配置 | 正确显示主从配置界面 |
| EXP-002 | 添加从表 | 主从关系创建成功 |
| EXP-003 | 数据联动 | 从表数据正确关联主记录 |
| EXP-004 | 删除关系 | 关系删除成功 |

---

## 6. AI 自动化测试注释

```yaml
test_type: e2e
requires_auth: admin
test_order: sequential

cleanup:
  strategy: database
  steps:
    # 删除主从关系配置
    - sql: DELETE FROM MasterDetailConfigs WHERE MasterEntityName = 'Order' AND DetailEntityName = 'OrderItem'
      description: 删除测试创建的主从关系
  on_error: ignore
  
cleanup_order: after_test

verify_cleanup:
  - sql: SELECT COUNT(*) FROM MasterDetailConfigs WHERE MasterEntityName = 'Order'
    expected: 0
```
