# TC-USER-004 权限配置

| 项目 | 内容 |
|------|------|
| **用例编号** | TC-USER-004 |
| **用例名称** | 权限配置 |
| **所属领域** | 用户与权限管理 |
| **测试类型** | 功能测试 / 安全测试 |
| **优先级** | P1 - 重要功能 |
| **版本** | 1.0 |

---

## 1. 测试场景描述

### 1.1 业务背景
除了角色的 CRUD 外，管理员需要为角色分配具体的系统权限（Permission），控制用户对资源的访问。

### 1.2 涉及页面
- `/roles` - 角色列表
- `/roles/edit/{Id}` - 角色编辑（含权限树）

---

## 2. 前置条件

| 条件编号 | 条件描述 |
|----------|----------|
| PRE-001 | 以管理员身份登录 |
| PRE-002 | 已存在测试角色 `TestRole`（TC-USER-002） |

---

## 3. 测试步骤

### 场景 A: 查看权限树

| 步骤 | 操作描述 | 预期结果 | 截图 |
|------|----------|----------|------|
| A1 | 导航到角色编辑页面 | 显示角色详情和权限配置区域 | ✓ |
| A2 | 确认显示权限树形结构 | 树形控件显示系统所有权限节点 | - |

### 场景 B: 分配权限

| 步骤 | 操作描述 | 预期结果 | 截图 |
|------|----------|----------|------|
| B1 | 勾选某个权限节点（如"用户管理"） | 复选框被选中，父节点状态联动 | - |
| B2 | 点击保存 | 权限配置保存成功 | ✓ |

### 场景 C: 验证权限生效

| 步骤 | 操作描述 | 预期结果 | 截图 |
|------|----------|----------|------|
| C1 | 登出当前管理员 | 登出成功 | - |
| C2 | 使用拥有 `TestRole` 的用户登录 | 登录成功 | - |
| C3 | 访问已授权的功能（如用户管理） | 访问成功 | ✓ |
| C4 | 访问未授权的功能（如系统设置） | 访问被拒绝或菜单不可见 | ✓ |

---

## 4. 预期结果汇总

| 结果编号 | 场景 | 预期结果 |
|----------|------|----------|
| EXP-001 | 权限分配 | 权限保存成功 |
| EXP-002 | 权限生效 | 用户只能访问获授权的资源 |
| EXP-003 | 权限拒绝 | 未授权资源访问受限 |

---

## 5. AI 自动化测试注释

```yaml
test_type: e2e
requires_auth: admin

cleanup:
  strategy: database
  steps:
    # 清理角色权限关联
    - sql: DELETE FROM AspNetRoleClaims WHERE RoleId IN (SELECT Id FROM AspNetRoles WHERE Name = 'TestRole')
  on_error: ignore
  
cleanup_order: after_test
```
