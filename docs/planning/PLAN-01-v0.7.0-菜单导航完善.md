# v0.7.0 开发计划 - 菜单导航完善与体验优化

## 概述

本文档是 BobCRM v0.7.0 的详细开发计划，聚焦于**完善现有的菜单导航系统**，确保核心功能稳定可用后再扩展新功能。

**来源**：基于用户反馈和 [ROADMAP.md](../ROADMAP.md) 1.2 节的功能完成度审查

**版本目标**：
1. 完善菜单编辑器的用户体验（图标选择器、导入/导出）
2. 编写完整的使用指南文档
3. 优化菜单导航的性能和稳定性
4. 为后续功能打下坚实基础

---

## 任务优先级

| 编号 | 任务名称 | 优先级 | 估算时间 | 依赖 | 状态 |
|------|----------|--------|----------|------|------|
| T1 | 编写菜单编辑器使用指南 | 高 | 1天 | 无 | ⏳ 待开始 |
| T2 | 图标选择器组件 | 高 | 1-2天 | 无 | ⏳ 待开始 |
| T3 | 菜单导入/导出功能 | 中 | 1天 | 无 | ⏳ 待开始 |
| T4 | 菜单实时预览优化 | 中 | 1天 | 无 | ⏳ 待开始 |
| T5 | 菜单编辑器错误处理增强 | 中 | 1天 | 无 | ⏳ 待开始 |
| T6 | 菜单权限验证测试 | 低 | 1天 | 无 | ⏳ 待开始 |

---

## T1: 编写菜单编辑器使用指南 ✅

### 目标
更新 GUIDE-06，将其从"计划文档"改为真正的"使用指南"，反映已实现的功能。

### 当前问题
- ❌ GUIDE-06 开头写着"计划中 - 功能尚未实现"，但实际功能已完成
- ❌ 内容是"规划使用步骤"而不是"实际使用步骤"
- ❌ 缺少截图和实际操作指导

### 任务清单
- [ ] 更新文档状态：从"计划中"改为"已实现"
- [ ] 编写实际使用步骤：
  - [ ] 如何访问菜单编辑器（/menus）
  - [ ] 如何新增菜单节点
  - [ ] 如何配置路由/模板双模式
  - [ ] 如何拖拽排序
  - [ ] 如何设置图标
  - [ ] 如何保存和验证
- [ ] 添加常见问题（FAQ）
- [ ] 添加截图（可选，手动完成）

### 验收标准
- ✅ 文档准确反映当前实现
- ✅ 用户可以按文档操作使用菜单编辑器
- ✅ 包含所有关键功能说明

---

## T2: 图标选择器组件

### 目标
提供可视化的图标选择器，替代当前的文本输入方式。

### 当前问题
- ❌ 用户需要手动输入图标名称（如 "user"）
- ❌ 不知道有哪些可用图标
- ❌ 容易输入错误导致图标不显示

### 任务清单
- [ ] 创建 `IconSelector.razor` 组件
- [ ] 列出 Ant Design 常用图标
- [ ] 实现图标搜索功能
- [ ] 实现图标预览
- [ ] 集成到 MenuManagement.razor
- [ ] 支持自定义图片 URL（可选）

### 验收标准
- ✅ 用户可以通过选择器选择图标
- ✅ 支持搜索过滤
- ✅ 选择后实时预览
- ✅ 向后兼容文本输入

### 实施细节
**文件**:
- `src/BobCrm.App/Components/Shared/IconSelector.razor`

**参考**: Ant Design Blazor 图标库

---

## T3: 菜单导入/导出功能

### 目标
支持菜单配置的导入/导出，便于在不同环境之间迁移配置。

### 当前问题
- ❌ GUIDE-06 提到导入/导出，但未实现
- ❌ 无法快速复制菜单配置到测试/生产环境

### 任务清单
- [ ] 后端 API:
  - [ ] GET `/api/access/functions/export` - 导出菜单树为 JSON
  - [ ] POST `/api/access/functions/import` - 导入菜单树
- [ ] 前端 UI:
  - [ ] 添加"导出"按钮（下载 JSON 文件）
  - [ ] 添加"导入"按钮（上传 JSON 文件）
  - [ ] 导入前预览和验证
- [ ] 错误处理：
  - [ ] 检测冲突的功能码
  - [ ] 提供合并策略选项

### 验收标准
- ✅ 可以导出完整的菜单树为 JSON
- ✅ 可以导入 JSON 恢复菜单结构
- ✅ 导入前显示冲突警告
- ✅ 支持增量导入（合并模式）

### 实施细节
**JSON 格式示例**:
```json
{
  "version": "1.0",
  "exportDate": "2025-11-20T16:00:00Z",
  "functions": [
    {
      "code": "SYS",
      "displayName": {"zh": "系统管理", "en": "System"},
      "icon": "setting",
      "children": [...]
    }
  ]
}
```

---

## T4: 菜单实时预览优化

### 目标
改进菜单保存后的实时预览机制。

### 当前问题
- ⚠️ 保存后需要手动刷新页面才能看到菜单变化
- ⚠️ 没有明确的"预览"功能

### 任务清单
- [ ] 实现 SignalR 或轮询机制通知菜单变更
- [ ] 菜单组件订阅变更事件
- [ ] 保存成功后自动刷新菜单显示
- [ ] 添加"预览"按钮（可选）

### 验收标准
- ✅ 保存菜单后，左侧导航自动更新
- ✅ 无需手动刷新页面
- ✅ 变更在 2 秒内生效

### 实施细节
**方案选择**:
- 简单方案：保存成功后调用 `LayoutState.RefreshMenu()`
- 高级方案：使用 SignalR 推送变更通知

---

## T5: 菜单编辑器错误处理增强

### 目标
改进错误提示和数据验证。

### 当前问题
- ⚠️ 循环依赖检测可能不够完善
- ⚠️ 错误消息不够友好

### 任务清单
- [ ] 增强前端验证：
  - [ ] 功能码格式验证
  - [ ] 显示名必填验证
  - [ ] 循环依赖检测优化
- [ ] 改进错误提示：
  - [ ] 使用 Toast 显示错误
  - [ ] 错误消息多语言化
  - [ ] 字段级错误标记
- [ ] 添加保存前确认（对于批量操作）

### 验收标准
- ✅ 所有必填字段有清晰提示
- ✅ 错误消息具体且可操作
- ✅ 防止意外删除或移动

---

## T6: 菜单权限验证测试

### 目标
确保菜单权限与实际访问权限的一致性。

### 任务清单
- [ ] 编写集成测试：
  - [ ] 菜单可见性与角色权限一致
  - [ ] 路由访问与菜单权限一致
  - [ ] 模板绑定与权限一致
- [ ] 手动测试场景：
  - [ ] 创建测试角色
  - [ ] 分配部分菜单权限
  - [ ] 验证菜单显示和页面访问
- [ ] 文档记录测试结果

### 验收标准
- ✅ 至少 5 个自动化测试
- ✅ 角色权限与菜单可见性 100% 一致
- ✅ 无权限时正确跳转到 403 页面

---

## 里程碑

| 里程碑 | 包含任务 | 完成标志 | 目标日期 | 状态 |
|--------|----------|----------|----------|------|
| **M1: 文档完善** | T1 | 菜单编辑器使用指南发布 | Week 1 | ⏳ 计划中 |
| **M2: 体验优化** | T2, T3, T4 | 图标选择、导入导出、实时预览 | Week 2 | ⏳ 计划中 |
| **M3: 稳定性增强** | T5, T6 | 错误处理和测试完成 | Week 3 | ⏳ 计划中 |
| **M4: v0.7.0 发布** | 所有任务 | 功能完善，测试通过 | Week 3 | ⏳ 计划中 |

---

## 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| **图标选择器UI复杂度** | 延期 1-2 天 | 先实现简单版本（列表选择），后续迭代 |
| **SignalR 集成成本** | 可能不实现实时预览 | 使用简单的手动刷新方案 |
| **测试覆盖不足** | 上线后发现 bug | 优先测试核心场景，其余手动测试 |

---

## 为什么不做仪表盘？

**原因**：
1. **稳定性优先**：菜单导航是核心功能，必须先完善
2. **文档欠缺**：GUIDE-06 状态不准确，影响用户使用
3. **用户体验**：图标输入、导入导出等功能缺失影响可用性
4. **技术债务**：先完善现有功能，再扩展新功能

**仪表盘推迟到 v0.8.0**。

---

## 参考文档

- [ROADMAP.md](../ROADMAP.md) - 产品路线图
- [GUIDE-06-菜单编辑器使用指南](../guides/GUIDE-06-菜单编辑器使用指南.md) - 待更新
- [ARCH-24-紧凑型顶部菜单导航设计](../design/ARCH-24-紧凑型顶部菜单导航设计.md)

---

## 更新日志

| 日期 | 更新内容 | 更新人 |
|------|----------|--------|
| 2025-11-20 | 初始创建（仪表盘主题） | AI Assistant |
| 2025-11-20 | 重写为菜单完善主题（根据用户反馈） | AI Assistant |

