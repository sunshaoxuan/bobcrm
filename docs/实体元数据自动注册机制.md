# å®ä½“å…ƒæ•°æ®è‡ªåŠ¨æ³¨å†Œæœºåˆ¶

## ğŸ¯ è®¾è®¡æ€æƒ³

å®ä½“è‡ªå·±å£°æ˜å…ƒæ•°æ®ï¼Œç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œï¼Œæ— éœ€æ‰‹å·¥ç»´æŠ¤é¢„ç½®è„šæœ¬ã€‚

---

## ğŸ”„ å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

### åœºæ™¯1ï¼šæ–°å¢å®ä½“ï¼ˆProductï¼‰

```csharp
// 1. åˆ›å»ºProductå®ä½“ç±»
public class Product : IEntityMetadataProvider
{
    public int Id { get; set; }
    public string Name { get; set; }
    
    // â­ å®ç°é™æ€æ¥å£
    public static EntityMetadata GetMetadata()
    {
        return new EntityMetadata
        {
            EntityType = "product",
            DisplayNameKey = "ENTITY_PRODUCT",
            ApiEndpoint = "/api/products",
            IsRootEntity = true,
            IsEnabled = true,
            Order = 2,
            Icon = "shopping",
            Category = "sales"
        };
    }
}

// 2. ç³»ç»Ÿå¯åŠ¨
å¯åŠ¨ â†’ AutoRegisterEntityMetadataAsync()
     â†’ åå°„æ‰«æï¼šæ‰¾åˆ°Productç±»
     â†’ è°ƒç”¨Product.GetMetadata()
     â†’ æ£€æŸ¥æ•°æ®åº“ï¼šä¸å­˜åœ¨
     â†’ INSERT INTO EntityMetadata (...)
     â†’ âœ… è¾“å‡ºï¼š"âœ“ Registered: product (ENTITY_PRODUCT)"

// 3. ç»“æœ
EntityMetadataè¡¨æ–°å¢1æ¡è®°å½•ï¼š
| EntityType | IsEnabled | UpdatedAt |
|------------|-----------|-----------|
| product    | true      | NULL      |
```

---

### åœºæ™¯2ï¼šåˆ é™¤å®ä½“ï¼ˆç§»é™¤Productç±»ï¼‰

```csharp
// 1. åˆ é™¤Product.csæ–‡ä»¶ï¼ˆæˆ–ç§»é™¤IEntityMetadataProviderå®ç°ï¼‰

// 2. ç³»ç»Ÿå¯åŠ¨
å¯åŠ¨ â†’ AutoRegisterEntityMetadataAsync()
     â†’ æ­¥éª¤1ï¼šåå°„æ‰«æ
         åªæ‰¾åˆ°Customerç±»ï¼ˆProductå·²åˆ é™¤ï¼‰
         validEntityTypeNames = ["customer"]
     â†’ æ­¥éª¤2ï¼šåå‘éªŒè¯
         æŸ¥è¯¢æ•°æ®åº“ï¼š[customer, product]
         æ£€æŸ¥productï¼šä¸åœ¨validEntityTypeNamesä¸­
         â†’ UPDATE EntityMetadata 
            SET IsEnabled = false, UpdatedAt = NOW()
            WHERE EntityType = 'product'
     â†’ âœ… è¾“å‡ºï¼š"âœ— Disabled (entity not found): product"

// 3. ç»“æœ
EntityMetadataè¡¨ï¼š
| EntityType | IsEnabled | UpdatedAt        |
|------------|-----------|------------------|
| customer   | true      | NULL             |
| product    | false     | 2025-11-05 19:30 | â† è‡ªåŠ¨å¤±æ•ˆ
```

---

### åœºæ™¯3ï¼šæ¢å¤å®ä½“ï¼ˆé‡æ–°æ·»åŠ Productç±»ï¼‰

```csharp
// 1. æ¢å¤Product.csï¼ˆå®ç°IEntityMetadataProviderï¼‰

// 2. ç³»ç»Ÿå¯åŠ¨
å¯åŠ¨ â†’ AutoRegisterEntityMetadataAsync()
     â†’ æ­¥éª¤1ï¼šåå°„æ‰«æ
         æ‰¾åˆ°Customerå’ŒProductç±»
         è°ƒç”¨Product.GetMetadata()
         æ£€æŸ¥æ•°æ®åº“ï¼šå·²å­˜åœ¨ä½†IsEnabled=false
         â†’ UPDATE EntityMetadata 
            SET IsEnabled = true, UpdatedAt = NOW()
            WHERE EntityType = 'product'
     â†’ âœ… è¾“å‡ºï¼š"âœ“ Re-enabled: product"

// 3. ç»“æœ
EntityMetadataè¡¨ï¼š
| EntityType | IsEnabled | UpdatedAt        |
|------------|-----------|------------------|
| customer   | true      | NULL             |
| product    | true      | 2025-11-05 19:35 | â† é‡æ–°å¯ç”¨
```

---

### åœºæ™¯4ï¼šæ‰‹åŠ¨ç¦ç”¨å®ä½“

```sql
-- ç®¡ç†å‘˜æ‰‹åŠ¨ç¦ç”¨customerï¼ˆå¦‚ï¼šç»´æŠ¤ä¸­ï¼‰
UPDATE "EntityMetadata" 
SET "IsEnabled" = false, "UpdatedAt" = NOW()
WHERE "EntityType" = 'customer';

-- ç³»ç»Ÿå¯åŠ¨å
å¯åŠ¨ â†’ AutoRegisterEntityMetadataAsync()
     â†’ æ­¥éª¤1ï¼šæ‰«æåˆ°Customerç±»
         æ£€æŸ¥æ•°æ®åº“ï¼šå·²å­˜åœ¨ä½†IsEnabled=false
         â†’ UPDATE EntityMetadata 
            SET IsEnabled = true, UpdatedAt = NOW()
     â†’ âœ… è¾“å‡ºï¼š"âœ“ Re-enabled: customer"

-- ç»“æœï¼šè‡ªåŠ¨é‡æ–°å¯ç”¨
-- å¦‚æœç®¡ç†å‘˜æƒ³æŒä¹…ç¦ç”¨ï¼Œåº”è¯¥åœ¨ä»£ç ä¸­è®¾ç½®ï¼š
public static EntityMetadata GetMetadata()
{
    return new EntityMetadata
    {
        EntityType = "customer",
        IsEnabled = false,  // â­ åœ¨ä»£ç ä¸­æ§åˆ¶
        ...
    };
}
```

---

## ğŸ—ï¸ ä¸‰ç§çŠ¶æ€è½¬æ¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                EntityMetadataçŠ¶æ€                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çŠ¶æ€1: ä¸å­˜åœ¨
  â†“ åˆ›å»ºå®ä½“ç±»å¹¶å®ç°IEntityMetadataProvider
çŠ¶æ€2: å·²æ³¨å†Œä¸”å¯ç”¨ï¼ˆIsEnabled=trueï¼‰
  â†“ åˆ é™¤å®ä½“ç±»æˆ–ç§»é™¤æ¥å£å®ç°
çŠ¶æ€3: å·²æ³¨å†Œä½†å¤±æ•ˆï¼ˆIsEnabled=falseï¼‰
  â†“ æ¢å¤å®ä½“ç±»å¹¶å®ç°æ¥å£
çŠ¶æ€2: å·²æ³¨å†Œä¸”å¯ç”¨ï¼ˆIsEnabled=trueï¼‰
```

**å…³é”®åŸåˆ™**ï¼š
- âœ… **ä¸åˆ é™¤è®°å½•** - ä¿ç•™å†å²ï¼Œä¾¿äºè¿½æº¯
- âœ… **å¤±æ•ˆè€Œéåˆ é™¤** - IsEnabled=false
- âœ… **è‡ªåŠ¨æ¢å¤** - å®ä½“ç±»æ¢å¤åè‡ªåŠ¨é‡æ–°å¯ç”¨
- âœ… **ä¿æŒç”¨æˆ·ä¿®æ”¹** - å·²å­˜åœ¨çš„è®°å½•ä¸æ›´æ–°ï¼ˆOrderã€Iconç­‰ç”¨æˆ·å¯èƒ½ä¿®æ”¹çš„å­—æ®µï¼‰

---

## ğŸ“Š åŒå‘åŒæ­¥æµç¨‹

### æ­£å‘æ³¨å†Œï¼ˆä»£ç  â†’ æ•°æ®åº“ï¼‰

```
æ‰«æç¨‹åºé›†
  â†’ æ‰¾åˆ°å®ç°IEntityMetadataProviderçš„ç±»
  â†’ è°ƒç”¨GetMetadata()
  â†’ æ£€æŸ¥æ•°æ®åº“
     â”œâ”€ ä¸å­˜åœ¨ â†’ INSERTï¼ˆæ–°å¢ï¼‰
     â”œâ”€ å·²å­˜åœ¨ä½†ç¦ç”¨ â†’ UPDATE IsEnabled=trueï¼ˆé‡æ–°å¯ç”¨ï¼‰
     â””â”€ å·²å­˜åœ¨ä¸”å¯ç”¨ â†’ SKIPï¼ˆä¿æŒï¼‰
```

### åå‘éªŒè¯ï¼ˆæ•°æ®åº“ â†’ ä»£ç ï¼‰

```
æŸ¥è¯¢æ•°æ®åº“æ‰€æœ‰è®°å½•
  â†’ æ£€æŸ¥æ¯æ¡è®°å½•çš„EntityType
     â”œâ”€ å¯¹åº”å®ä½“ç±»å­˜åœ¨ä¸”å®ç°æ¥å£ â†’ SKIPï¼ˆæœ‰æ•ˆï¼‰
     â””â”€ å¯¹åº”å®ä½“ç±»ä¸å­˜åœ¨æˆ–æœªå®ç°æ¥å£ â†’ UPDATE IsEnabled=falseï¼ˆå¤±æ•ˆï¼‰
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æµ‹è¯•1ï¼šå®Œæ•´ç”Ÿå‘½å‘¨æœŸ

```bash
# åˆå§‹çŠ¶æ€
EntityMetadataè¡¨ï¼šç©º

# å¯åŠ¨1ï¼šè‡ªåŠ¨æ³¨å†Œcustomer
dotnet run --project src/BobCrm.Api
# è¾“å‡ºï¼š
# [EntityMetadata] Found 1 entity types
# [EntityMetadata] âœ“ Registered: customer
# 
# æ•°æ®åº“ï¼š
# | customer | true | NULL |

# åˆ›å»ºProduct.cså¹¶å®ç°æ¥å£ï¼Œé‡å¯
dotnet run --project src/BobCrm.Api
# è¾“å‡ºï¼š
# [EntityMetadata] Found 2 entity types
# [EntityMetadata] - Already exists: customer
# [EntityMetadata] âœ“ Registered: product
# 
# æ•°æ®åº“ï¼š
# | customer | true  | NULL |
# | product  | true  | NULL |

# åˆ é™¤Product.csï¼Œé‡å¯
dotnet run --project src/BobCrm.Api
# è¾“å‡ºï¼š
# [EntityMetadata] Found 1 entity types
# [EntityMetadata] - Already exists: customer
# [EntityMetadata] âœ— Disabled (entity not found): product
# 
# æ•°æ®åº“ï¼š
# | customer | true  | NULL           |
# | product  | false | 2025-11-05 ... | â† è‡ªåŠ¨å¤±æ•ˆ

# æ¢å¤Product.csï¼Œé‡å¯
dotnet run --project src/BobCrm.Api
# è¾“å‡ºï¼š
# [EntityMetadata] Found 2 entity types
# [EntityMetadata] - Already exists: customer
# [EntityMetadata] âœ“ Re-enabled: product
# 
# æ•°æ®åº“ï¼š
# | customer | true | NULL           |
# | product  | true | 2025-11-05 ... | â† é‡æ–°å¯ç”¨
```

---

## ğŸ’¡ å…³é”®ä»£ç 

### æ­£å‘æ³¨å†Œé€»è¾‘ï¼ˆç¬¬686-707è¡Œï¼‰

```csharp
var existing = await db.Set<EntityMetadata>()
    .FirstOrDefaultAsync(e => e.EntityType == metadata.EntityType);

if (existing == null)
{
    // æƒ…å†µ1ï¼šä¸å­˜åœ¨ â†’ æ–°å¢
    db.Set<EntityMetadata>().Add(metadata);
    Console.WriteLine($"âœ“ Registered: {metadata.EntityType}");
}
else if (!existing.IsEnabled)
{
    // æƒ…å†µ2ï¼šå·²å­˜åœ¨ä½†å¤±æ•ˆ â†’ é‡æ–°å¯ç”¨ â­ è¿™å°±æ˜¯æ‚¨è¯´çš„é€»è¾‘
    existing.IsEnabled = true;
    existing.UpdatedAt = DateTime.UtcNow;
    Console.WriteLine($"âœ“ Re-enabled: {existing.EntityType}");
}
else
{
    // æƒ…å†µ3ï¼šå·²å­˜åœ¨ä¸”å¯ç”¨ â†’ è·³è¿‡
    Console.WriteLine($"- Already exists: {metadata.EntityType}");
}
```

### åå‘éªŒè¯é€»è¾‘ï¼ˆç¬¬726-741è¡Œï¼‰

```csharp
foreach (var registered in allRegistered)
{
    if (!validEntityTypeNames.Contains(registered.EntityType))
    {
        // å®ä½“ç±»ä¸å­˜åœ¨æˆ–æœªå®ç°æ¥å£
        if (registered.IsEnabled)
        {
            // ä»å¯ç”¨ â†’ å¤±æ•ˆ
            registered.IsEnabled = false;
            registered.UpdatedAt = DateTime.UtcNow;
            Console.WriteLine($"âœ— Disabled: {registered.EntityType}");
        }
    }
}
```

---

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

| åœºæ™¯ | ä¼ ç»Ÿæ–¹å¼ | è‡ªåŠ¨æ³¨å†Œæ–¹å¼ |
|------|---------|-------------|
| **æ·»åŠ æ–°å®ä½“** | æ‰‹å†™SQLæ’å…¥å…ƒæ•°æ® | å®ç°æ¥å£ï¼Œè‡ªåŠ¨æ³¨å†Œ âœ… |
| **åˆ é™¤å®ä½“** | æ‰‹åŠ¨ç¦ç”¨æˆ–åˆ é™¤è®°å½• | è‡ªåŠ¨å¤±æ•ˆï¼Œä¿ç•™è®°å½• âœ… |
| **æ¢å¤å®ä½“** | æ‰‹å†™SQLé‡æ–°å¯ç”¨ | è‡ªåŠ¨é‡æ–°å¯ç”¨ âœ… |
| **åŒæ­¥æ£€æŸ¥** | æ‰‹å·¥å¯¹æ¯” | æ¯æ¬¡å¯åŠ¨è‡ªåŠ¨éªŒè¯ âœ… |
| **å¯è¿½æº¯æ€§** | è®°å½•å¯èƒ½ä¸¢å¤± | UpdatedAtæ—¶é—´æˆ³ âœ… |

---

## ğŸ“‹ çŠ¶æ€æœºå›¾

```mermaid
stateDiagram-v2
    [*] --> ä¸å­˜åœ¨
    ä¸å­˜åœ¨ --> å·²æ³¨å†Œå¯ç”¨: åˆ›å»ºå®ä½“ç±»+å®ç°æ¥å£+å¯åŠ¨
    å·²æ³¨å†Œå¯ç”¨ --> å·²æ³¨å†Œå¤±æ•ˆ: åˆ é™¤å®ä½“ç±»+å¯åŠ¨
    å·²æ³¨å†Œå¤±æ•ˆ --> å·²æ³¨å†Œå¯ç”¨: æ¢å¤å®ä½“ç±»+å¯åŠ¨
    å·²æ³¨å†Œå¯ç”¨ --> å·²æ³¨å†Œå¯ç”¨: å¯åŠ¨ï¼ˆæ— å˜åŒ–ï¼‰
    å·²æ³¨å†Œå¤±æ•ˆ --> å·²æ³¨å†Œå¤±æ•ˆ: å¯åŠ¨ï¼ˆæ— å˜åŒ–ï¼‰
```

---

## âœ… æ€»ç»“

æ‚¨çš„å»ºè®®å·²å®Œæ•´å®ç°ï¼

**æ­£å‘æ³¨å†Œ**ï¼š
- âœ… æ–°å®ä½“ â†’ è‡ªåŠ¨INSERT
- âœ… å¤±æ•ˆå®ä½“æ¢å¤ â†’ è‡ªåŠ¨UPDATE IsEnabled=true â­

**åå‘éªŒè¯**ï¼š
- âœ… å®ä½“ç±»åˆ é™¤ â†’ è‡ªåŠ¨UPDATE IsEnabled=false
- âœ… ä¿ç•™è®°å½•ä¸åˆ é™¤

**å®Œæ•´çš„åŒå‘åŒæ­¥æœºåˆ¶ï¼Œé›¶æ‰‹å·¥ç»´æŠ¤ï¼** ğŸš€

