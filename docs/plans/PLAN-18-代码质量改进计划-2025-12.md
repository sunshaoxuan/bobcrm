# PLAN-18: BobCRM 代码质量改进计划

**创建日期**: 2025-12-25  
**基于审查**: `c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md`、`c:\workspace\bobcrm\docs\reviews\REVIEW-13-Code-Quality-Review-2025-12.md`  
**计划执行周期**: 2025-12-26 ~ 2026-01-17  
**负责人**: BobCRM 开发团队

---

## 一、计划概要

### 1.1 问题总览

| 优先级 | 问题数 | 预计工时 | 负责人 |
|--------|--------|----------|--------|
| P0 (阻断) | 3 | 40h | 后端 |
| P1 (重要) | 8 | 76h | 后端/前端 |
| P2 (一般) | 3 | 24h | 后端/前端 |
| P3 (优化) | 3 | 24h | 后端/前端 |
| **总计** | **17** | **164h** | BobCRM 开发团队 |

### 1.2 按类别分布

| 类别 | P0 | P1 | P2 | P3 | 总计 |
|------|----|----|----|----|------|
| 功能缺陷 | 0 | 0 | 0 | 0 | 0 |
| 代码质量 | 1 | 5 | 1 | 2 | 9 |
| 安全问题 | 2 | 0 | 0 | 0 | 2 |
| 性能问题 | 0 | 0 | 1 | 1 | 2 |
| I18n问题 | 0 | 2 | 0 | 0 | 2 |
| 文档问题 | 0 | 1 | 0 | 0 | 1 |

### 1.3 里程碑

| 里程碑 | 目标 | 截止日期 | 状态 |
|--------|------|----------|------|
| M1 | P0 问题全部修复 | 2026-01-03 | ⬜ |
| M2 | P1 问题全部修复 | 2026-01-10 | ⬜ |
| M3 | P2 问题 50% 修复 | 2026-01-14 | ⬜ |
| M4 | 回归测试通过 | 2026-01-17 | ⬜ |

### 1.4 依赖关系与执行顺序

| 依赖 | 原因 | 建议顺序 |
|------|------|----------|
| P1-002 → P1-001 | 异常/成功响应的“文案策略”需要统一：先确定错误/成功返回契约与 i18n 归属，再处理默认成功消息 | 先 P1-002，后 P1-001 |
| P1-003 ↔ P1-004 | `async void` 与空 `catch` 往往成对出现；建议同时修正并引入统一的安全调用封装 | 同步推进 |
| P0-003 → P1-006 / P1-007 | 端点逻辑下沉与服务拆分会影响 DI 注册与旧 API 的迁移面，先定边界再迁移/拆分更稳 | 先 P0-003，再 P1-006/P1-007 |

---

## 二、P0 问题修复计划

> P0 = 阻断级别，必须立即修复，影响系统核心功能或存在严重安全漏洞

### P0-001: JWT 密钥存在默认回退值（生产可能以弱密钥启动）

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md` “严重 (必须修复) #1”  
**发现日期**: 2025-12-26  
**修复截止**: 2025-12-31

#### 问题描述
在 `Jwt:Key` 配置缺失时使用硬编码默认值生成签名密钥，存在被误部署到生产环境的风险，导致令牌可被伪造或被离线爆破。

#### 影响范围
- 影响模块：认证授权（JWT）
- 影响用户：全体用户
- 风险等级：高

#### 根本原因
启动配置未强制校验关键安全配置；以开发便利为由提供了“可运行”的默认值。

#### 修复方案

**方案概述**：在非开发环境强制要求 `Jwt:Key/Issuer/Audience` 配置存在且满足强度约束；开发环境允许使用开发密钥但必须显式声明。  

**涉及文件**：
- `c:\workspace\bobcrm\src\BobCrm.Api\Program.cs`

**修复步骤**：
1. 在 `Program.cs` 读取 JWT 配置时，替换默认回退逻辑为“缺失即失败”（至少在非 Development 环境）。
2. 增加密钥最小长度校验（例如 >= 32 bytes）与明确错误信息。
3. 补充测试：缺失配置时启动失败；提供有效配置时启动成功。

**代码变更**：
```csharp
// 修改前
var key = Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Key"] ?? "dev-secret-change-in-prod-1234567890");

// 修改后（示例）
var jwtKey = builder.Configuration["Jwt:Key"];
if (!builder.Environment.IsDevelopment() && string.IsNullOrWhiteSpace(jwtKey))
    throw new InvalidOperationException("Jwt:Key is required in non-development environments.");
```

#### 验收标准
- [ ] 非开发环境缺失 `Jwt:Key` 时应用启动失败（错误信息明确）
- [ ] 开发环境仍可启动，但密钥来源可追溯且不再默默回退
- [ ] `dotnet test` 全量通过
- [ ] 代码审查通过

#### 回归测试
- [ ] 登录/刷新令牌流程
- [ ] 受保护端点访问（401/403 行为）
- [ ] Swagger + Bearer 认证联调

#### 状态追踪
| 状态 | 日期 | 备注 |
|------|------|------|
| ⬜ 待开始 | | |
| 🔄 进行中 | | |
| ✅ 已完成 | | |
| 🔍 待验证 | | |

---

### P0-002: CORS 策略默认全开放（误用于生产将扩大攻击面）

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md` “严重 (必须修复) #2”  
**发现日期**: 2025-12-26  
**修复截止**: 2025-12-31

#### 问题描述
当前默认 CORS 策略 `AllowAnyOrigin/AllowAnyHeader/AllowAnyMethod`，若生产环境未收敛，将显著扩大跨域攻击面，并可能与 Cookie/Token 策略产生风险耦合。

#### 影响范围
- 影响模块：API 网关层 / 浏览器调用链
- 影响用户：Web 客户端用户
- 风险等级：高

#### 根本原因
缺少“按环境切换”的默认策略；缺少配置化的允许域名白名单。

#### 修复方案

**方案概述**：按环境启用不同策略：Development 允许本地调试，Production 必须指定允许域名（AllowedOrigins），并按需要限制 Header/Method。  

**涉及文件**：
- `c:\workspace\bobcrm\src\BobCrm.Api\Program.cs`
- （如新增配置）`c:\workspace\bobcrm\src\BobCrm.Api\appsettings.Production.json`

**修复步骤**：
1. 引入配置项 `Cors:AllowedOrigins`（数组/分号分隔均可，需明确规范）。
2. Development：允许常用本地来源（例如 `http://localhost:*`）或继续全开放但必须通过显式开关启用。
3. Production：未配置 AllowedOrigins 则启动失败，或至少记录 Error 并拒绝启动。

#### 验收标准
- [ ] Production 模式下 CORS 仅允许白名单来源
- [ ] 预检（OPTIONS）请求行为符合预期
- [ ] `dotnet test` 全量通过
- [ ] 前端调用关键 API 验证通过

#### 回归测试
- [ ] 登录、刷新、业务接口跨域调用
- [ ] 文件上传/下载跨域调用

#### 状态追踪
| 状态 | 日期 | 备注 |
|------|------|------|
| ⬜ 待开始 | | |
| 🔄 进行中 | | |
| ✅ 已完成 | | |
| 🔍 待验证 | | |

---

### P0-003: 架构违规：Endpoint 层存在逻辑泄漏（业务逻辑未下沉到 Service）

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-13-Code-Quality-Review-2025-12.md:26`（P0-1）  
**发现日期**: 2025-12-25  
**修复截止**: 2026-01-03

#### 问题描述
Endpoint（`MapGet/MapPost`）委托中存在复杂业务逻辑（EF 查询、过滤、数据变换、编排多步写入），导致：
- 单元测试难以覆盖（需要启动完整 WebHost）
- 逻辑不可复用（后台任务/CLI 无法复用）
- Endpoint 与 EF Core 强耦合，架构层次被破坏

#### 影响范围
- 影响模块：模板/实体定义/用户/权限相关端点
- 影响用户：管理端与业务端相关功能用户
- 风险等级：高（架构层面阻断后续演进与测试）

#### 根本原因
缺少明确的“Endpoint 只负责路由/认证/参数校验/调用应用服务”的边界约束；业务编排缺少应用层服务承载。

#### 修复方案

**方案概述**：将 Endpoint 中的业务逻辑抽取到应用/服务层（Service / Application），Endpoint 仅做请求映射与权限检查；复杂多步写入使用事务边界并补齐测试。  

**涉及文件（REVIEW-13 证据）**：
- `c:\workspace\bobcrm\src\BobCrm.Api\Endpoints\TemplateEndpoints.cs`（REVIEW-13 指出 `MapGet("/menu-bindings")` 逻辑过重）
- `c:\workspace\bobcrm\src\BobCrm.Api\Endpoints\EntityDefinitionEndpoints.cs`（REVIEW-13 指出 Create/Update 逻辑泄漏）
- `c:\workspace\bobcrm\src\BobCrm.Api\Endpoints\UserEndpoints.cs`（REVIEW-13 指出多步创建缺少事务）
- `c:\workspace\bobcrm\src\BobCrm.Api\Endpoints\AccessEndpoints.cs`（REVIEW-13 指出 Import/Merge 逻辑内联）

**修复步骤**：
1. 为上述端点分别定义应用服务接口（例如 `ITemplateBindingAppService`、`IEntityDefinitionAppService`、`IUserProvisioningService`、`IAccessImportService`）。
2. 将 EF Core 查询/映射/编排逻辑迁移到服务层；Endpoint 仅保留参数读取、`EnsureFunctionAccessAsync`、返回 `SuccessResponse/ErrorResponse`。
3. 对多步写入（例如用户创建+角色绑定）引入事务边界（`DbContext.Database.BeginTransactionAsync` 或 `IUnitOfWork`）。
4. 补齐集成测试：验证旧行为不变（返回契约、错误码、权限行为）。

#### 验收标准
- [ ] 目标端点委托中不再出现“长逻辑块”（以 `rg -n \"Map(Get|Post).*\\{\"` + 代码审查确认）
- [ ] 服务层可被单测/集成测覆盖（无需启动完整 WebHost 才能验证核心逻辑）
- [ ] `dotnet test` 全量通过
- [ ] 代码审查通过（Endpoint 层无 EF 查询/复杂编排）

#### 回归测试
- [ ] 模板绑定查询与返回字段一致性
- [ ] 实体定义创建/更新流程
- [ ] 用户创建+角色分配一致性（含失败回滚）
- [ ] 权限导入/合并流程

#### 状态追踪
| 状态 | 日期 | 备注 |
|------|------|------|
| ⬜ 待开始 | | |
| 🔄 进行中 | | |
| ✅ 已完成 | | |
| 🔍 待验证 | | |

---

## 三、P1 问题修复计划

> P1 = 重要级别，影响主要功能，需要在当前迭代内修复

### P1-001: API 成功消息存在硬编码中文默认值

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md` “重要 (建议修复) #1”  
**发现日期**: 2025-12-26  
**修复截止**: 2026-01-03

#### 问题描述
`SuccessResponse` 的默认 message 为 `"操作成功"`，导致不同语言客户端/不同入口返回文案不一致，且难以统一为资源键策略。

#### 修复方案
将默认 message 改为 `null` 或固定 `messageKey`/`code`，由上层（端点/前端）结合 `ILocalization` 决定展示；避免后端输出用户可见自然语言默认值。

#### 涉及文件
- `c:\workspace\bobcrm\src\BobCrm.Api\Contracts\ApiResponseExtensions.cs`

#### 验收标准
- [ ] 默认成功响应不再携带硬编码中文
- [ ] 关键端点仍能返回一致的成功提示（通过资源键或前端统一处理）
- [ ] `dotnet test` 全量通过

#### 状态
⬜ 待开始 | 🔄 进行中 | ✅ 已完成

---

### P1-002: 全局异常处理存在实现重复且返回文案硬编码中文

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md` “重要 (建议修复) #2”  
**发现日期**: 2025-12-26  
**修复截止**: 2026-01-03

#### 问题描述
存在 `GlobalExceptionMiddleware` 与 `GlobalExceptionFilter` 两套逻辑，且生产环境返回中文固定文案，难以与 I18n 机制统一；维护成本高且容易出现映射不一致。

#### 修复方案
统一到单一异常处理策略（建议保留中间件，移除/禁用过滤器或确保只启用一处）；错误响应返回 `errorCode/messageKey/traceId`，用户可见文案由前端 I18n 渲染。

#### 涉及文件
- `c:\workspace\bobcrm\src\BobCrm.Api\Middleware\GlobalExceptionMiddleware.cs`
- `c:\workspace\bobcrm\src\BobCrm.Api\Filters\GlobalExceptionFilter.cs`
- `c:\workspace\bobcrm\src\BobCrm.Api\Program.cs`（注册位置与启用方式）

#### 验收标准
- [ ] 全局异常捕获路径唯一且一致（不会重复包装/重复日志）
- [ ] 响应字段契约稳定（含 traceId、timestamp、errorCode/messageKey）
- [ ] `dotnet test` 全量通过

#### 状态
⬜ 待开始 | 🔄 进行中 | ✅ 已完成

---

### P1-003: 前端存在大量空 catch（吞异常）

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md` “重要 (建议修复) #3”  
**发现日期**: 2025-12-26  
**修复截止**: 2026-01-03

#### 问题描述
大量 `catch { }` 出现在 JS 互操作/状态刷新等路径，可能吞掉关键错误，导致线上问题难定位，且出现“表面正常但状态不一致”的隐性故障。

#### 修复方案
收敛为统一的 `SafeInvokeAsync`/`TryJsAsync` 辅助方法：限定异常类型（如 `JSException`）、记录日志（console 或 `ILogger`），并在可恢复场景明确降级策略；仅允许“可忽略”的场景保留空 catch 且必须写明原因。

#### 涉及文件（全量清单）

生成方式（已执行）：
`rg -n "catch\\s*\\{\\s*\\}" c:\workspace\bobcrm\src\BobCrm.App --glob "*.cs" --glob "*.razor"`

统计结果：`21` 个文件，`80` 处空 `catch { }`/`catch{}`。

| 文件 | 空 catch 行号（逗号分隔） | 数量 |
|------|---------------------------|------|
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Layout\MainLayout.razor` | 185,194,304 | 3 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Layout\SiderLayout.razor` | 41 | 1 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Layout\SimpleLayout.razor` | 37 | 1 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Pages\Activate.razor` | 63,65,94 | 3 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Pages\BackgroundJobMonitor.razor` | 297 | 1 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Pages\CustomerNew.razor` | 53,74 | 2 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Pages\Login.razor` | 88,99,112,125,129,147,162,281,283,312,315 | 11 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Pages\PageLoader.razor` | 352,802 | 2 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Pages\Profile.razor` | 201 | 1 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Pages\Register.razor` | 62,64,87 | 3 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Pages\Setup.razor` | 154,155,161,185,215,222,231,234,295,296,297,300,377,378,389,390,413,414,482,498,501 | 21 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Pages\Templates.razor` | 262 | 1 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Routes.razor` | 56 | 1 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Shared\AppHeader.razor` | 107,138,163,245 | 4 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Shared\CustomerSider.razor` | 65,160,178 | 3 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Shared\DataGridRuntime.razor` | 372 | 1 |
| `c:\workspace\bobcrm\src\BobCrm.App\Components\Shared\EntityListSiderBase.cs` | 53 | 1 |
| `c:\workspace\bobcrm\src\BobCrm.App\Program.cs` | 122 | 1 |
| `c:\workspace\bobcrm\src\BobCrm.App\Services\AuthService.cs` | 48,49,53,67,76,86,150,184,195,215,224,239,252,265,280 | 15 |
| `c:\workspace\bobcrm\src\BobCrm.App\Services\I18nService.cs` | 192,194 | 2 |
| `c:\workspace\bobcrm\src\BobCrm.App\Services\LangHeaderHandler.cs` | 18,24 | 2 |

#### 验收标准
- [ ] 空 catch 数量显著下降（原则：默认不允许无理由吞异常）
- [ ] 关键路径（登录/设置/语言切换）异常能被记录并可定位
- [ ] `dotnet test` 全量通过

#### 状态
⬜ 待开始 | 🔄 进行中 | ✅ 已完成

---

### P1-004: Blazor 事件处理使用 async void

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md` “重要 (建议修复) #4”  
**发现日期**: 2025-12-26  
**修复截止**: 2026-01-03

#### 问题描述
`async void` 会导致异常无法被调用方捕获，且测试/诊断困难；在 UI 事件链中容易产生未观察异常。

#### 修复方案
将 `async void` 迁移为 `async Task`，在事件绑定处使用 `EventCallback`/`async () => await ...` 方式调用；配合 P1-003 的统一异常处理工具。

#### 涉及文件
- `c:\workspace\bobcrm\src\BobCrm.App\Components\Shared\EntitySelector.razor`
- `c:\workspace\bobcrm\src\BobCrm.App\Components\Pages\Profile.razor`
- `c:\workspace\bobcrm\src\BobCrm.App\Components\Pages\Templates.razor`

#### 验收标准
- [ ] 代码库中 `async void` 仅保留框架强制的事件签名（如有）
- [ ] 相关 UI 操作流程手测通过
- [ ] `dotnet test` 全量通过

#### 状态
⬜ 待开始 | 🔄 进行中 | ✅ 已完成

---

### P1-005: 可空性告警与潜在空引用风险（CS8602/CS8604 等）

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md` “重要 (建议修复) #5”  
**发现日期**: 2025-12-26  
**修复截止**: 2026-01-03

#### 问题描述
`ThrowDomain` 后编译器仍认为对象可能为 null；运行时构造中存在将潜在 null 传入非空参数/使用潜在 null 成员的风险，编译告警已出现。

#### 修复方案
为抛异常的 helper 增加 `[DoesNotReturn]`（或改为内联 `throw` 语句）以让编译器理解控制流；对运行时构造逻辑进行参数归一化（使用 normalized entityType）并补齐 null guard。

#### 涉及文件
- `c:\workspace\bobcrm\src\BobCrm.Api\Base\Aggregates\EntityDefinitionAggregate.cs`
- `c:\workspace\bobcrm\src\BobCrm.Api\Services\TemplateRuntimeService.cs`

#### 验收标准
- [ ] 相关项目 `dotnet build -t:Rebuild` 的可空性告警显著下降且不再出现在上述文件
- [ ] 关键运行时接口回归测试通过（模板运行时/实体定义相关）

#### 状态
⬜ 待开始 | 🔄 进行中 | ✅ 已完成

---

### P1-006: 过时 API 大量残留（CS0618：TemplateBinding/TemplateId/TemplateBindingId）

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md` “重要 (建议修复) #6”  
**发现日期**: 2025-12-26  
**修复截止**: 2026-01-03

#### 问题描述
大量代码仍在使用已标记废弃的字段/扩展方法，迁移成本会随时间扩大，并可能阻碍未来的模型清理。

#### 修复方案
以编译告警列表为准分批迁移到 `TemplateStateBinding/TemplateStateBindingId`；迁移过程中补齐相关测试（至少覆盖 Access/Template 关键流程），避免行为回归。

#### 涉及文件（示例）
- `c:\workspace\bobcrm\src\BobCrm.Api\Services\AccessService.cs`
- `c:\workspace\bobcrm\src\BobCrm.Api\Services\TemplateRuntimeService.cs`
- `c:\workspace\bobcrm\src\BobCrm.Api\Endpoints\AccessEndpoints.cs`
- `c:\workspace\bobcrm\tests\BobCrm.Api.Tests\AccessServiceTests.cs`

#### 验收标准
- [ ] `dotnet build -t:Rebuild -c Release` 的 CS0618 告警显著下降（目标：清零或仅保留明确的迁移阻塞项）
- [ ] 关键端点与测试全部通过

#### 状态
⬜ 待开始 | 🔄 进行中 | ✅ 已完成

---

### P1-007: 单文件过大（>=800 行）导致 SRP/可维护性风险

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md` “重要 (建议修复) #7”  
**发现日期**: 2025-12-26  
**修复截止**: 2026-01-03

#### 问题描述
存在多处超大文件（审查统计：28 个），易产生耦合、回归风险与可测试性问题，变更成本持续升高。

#### 修复方案
以 `AccessService` 为首批拆分对象：拆成菜单/功能树构建、权限判定、数据范围评估、初始化种子数据等子服务，并以接口暴露；拆分需同时调整 DI 注册与测试结构。

#### 工时预估（校准）
预计工时：20h（建议区间 16h-24h；含 DI 调整、测试重构、回归验证）。

#### 涉及文件（示例）
- `c:\workspace\bobcrm\src\BobCrm.Api\Services\AccessService.cs`
- `c:\workspace\bobcrm\src\BobCrm.Api\Program.cs`（DI 注册）
- `c:\workspace\bobcrm\tests\BobCrm.Api.Tests\AccessServiceTests.cs`

#### 验收标准
- [ ] 目标文件拆分完成且职责边界清晰
- [ ] 关键测试用例覆盖保持或提升
- [ ] `dotnet test` 全量通过

#### 状态
⬜ 待开始 | 🔄 进行中 | ✅ 已完成

---

### P1-008: DTO 非空字段可能接收 null（CS8601）与输出契约不稳定

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md` “重要 (建议修复) #8”  
**发现日期**: 2025-12-26  
**修复截止**: 2026-01-03

#### 问题描述
部分 DTO 属性为非空但实际赋值路径可能为 null，既导致编译告警，也可能导致客户端契约不稳定（字段缺失/为空）。

#### 修复方案
对 DTO 的必填字段进行明确兜底：在映射处确保非空（例如 name 回退到 `node.Name`），或将 DTO 属性改为可空并更新接口契约与前端处理逻辑。

#### 涉及文件
- `c:\workspace\bobcrm\src\BobCrm.Api\Endpoints\TemplateEndpoints.cs`
- `c:\workspace\bobcrm\src\BobCrm.Api\Endpoints\EntityDefinitionEndpoints.cs`

#### 验收标准
- [ ] 对应 CS8601 告警清零
- [ ] 相关 API 契约/前端展示不回归

#### 状态
⬜ 待开始 | 🔄 进行中 | ✅ 已完成

---

## 四、P2 问题改进计划

> P2 = 一般级别，影响用户体验或代码质量，建议在下个版本前修复

### P2-001: 时间来源分散（DateTime.UtcNow/Now 多处直接使用）

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md` “改进 (可选优化) #1”  
**修复优先级**: 中

#### 问题描述
直接使用系统时间不利于测试与一致性（例如审计/回放/跨时区问题），且难以进行可控时间注入。

#### 改进建议
引入 `TimeProvider`/`ISystemClock` 并在关键领域（审计、令牌、种子、时间戳）优先落地；渐进迁移而非一次性全库替换。

#### 涉及文件
- `c:\workspace\bobcrm\src\BobCrm.Api\**\*.cs`（按关键域逐步迁移）

#### 状态
✅ 已完成 (2025-12-26)
- **Commit**: `90bd1b7`
- **验证**: `dotnet test -c Release` 全量通过；`AccessService` / `AuthService` 等核心服务已接入 `TimeProvider`。

---

### P2-002: Program.cs 启动初始化逻辑偏重（包含业务/种子/I18n Upsert）

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md` “改进 (可选优化) #2”  
**修复优先级**: 中

#### 问题描述
启动过程包含较多业务初始化与写入逻辑，增加启动失败面与维护复杂度，并可能导致环境差异（Dev/Prod）行为不一致。

#### 改进建议
将初始化拆分为可独立运行的 Seeder/Migration 步骤，并提供明确开关与幂等性；运行方式可为启动后台任务/命令行工具/一次性迁移。
(本次迭代主要抽取配置校验逻辑，清理 Program.cs 结构)

#### 涉及文件
- `c:\workspace\bobcrm\src\BobCrm.Api\Program.cs`
- `c:\workspace\bobcrm\src\BobCrm.Api\Extensions\BobCrmBootstrapExtensions.cs` (New)
- `c:\workspace\bobcrm\src\BobCrm.Api\Extensions\BobCrmConfigurationValidation.cs` (New)

#### 状态
✅ 已完成 (2025-12-26)
- **Commit**: `90bd1b7`
- **验证**: 
  - 新增 `ConfigurationValidationTests` 覆盖配置边界。
  - `Program.cs` 逻辑已拆分至 `BobCrmBootstrapExtensions`。

---

### P2-003: 端点 Summary/Description 文案中英混用（文档一致性）

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md` “改进 (可选优化) #3”  
**修复优先级**: 中

#### 问题描述
Swagger 文案中英混用，影响可读性与团队协作一致性。

#### 改进建议
统一规则：对外 API 文档统一中文或英文；如需多语，明确生成策略（例如基于资源键生成不同语言的 Swagger 文案）。

#### 涉及文件
- `c:\workspace\bobcrm\src\BobCrm.Api\Endpoints\*.cs`

#### 状态
✅ 已完成 (2025-12-26)
- **Unified**: Swagger Docs 已全面中文化（`DataSet`, `Domain`, `FieldPermission`, `Settings`, `Lookup`, `FieldAction`, `EntityAggregate`）。
- **CI**: 新增 `scripts/check-i18n-completeness.ps1` 并集成至 GitHub Actions，强制检查 `i18n-resources.json` 的 `zh/ja/en` 完整性。

---

## 五、P3 问题优化建议

> P3 = 优化级别，代码可以正常工作，但有改进空间

### P3-001: 统一前端 JS 互操作的错误处理与日志策略

**类型**: 代码质量

#### 现状
同类 JS 调用在多处手写 try/catch，且大量吞异常，行为与记录策略不统一。

#### 优化建议
封装统一工具（例如 `TryJsAsync<T>`），默认记录错误并提供降级路径；对“可忽略失败”的场景使用显式的 `IgnoreJsFailureAsync` 并写明原因。

#### 预期收益
显著提升线上可诊断性，减少隐性状态不一致故障。

#### 实施复杂度
中

#### 状态
⬜ 备选

---

### P3-002: 后端异常码/资源键体系进一步标准化（面向 I18n/客户端一致性）

**类型**: I18n问题 / 代码质量

#### 现状
部分响应仍返回自然语言文案；异常码/资源键/HTTP 状态码的映射策略存在分散与重复。

#### 优化建议
制定统一错误响应契约（errorCode + messageKey + args + traceId），全局异常处理只做映射与记录；前端统一通过 `I18nService.T()` 渲染。

#### 预期收益
减少多语言一致性问题，提升 API 契约稳定性与可测试性。

#### 实施复杂度
高

#### 状态
⬜ 备选

---

### P3-003: 将“编译告警基线”纳入 PR Gate

**类型**: 工程化 / 代码质量

#### 现状
Release Rebuild 存在可空性、过时 API、测试警告等告警，容易被长期忽略。

#### 优化建议
在 CI 中增加 `dotnet build -t:Rebuild -c Release` 告警基线检查（先基线冻结，再逐步清零），并对新增告警阻断合入。

#### 预期收益
持续收敛技术债，降低回归风险。

#### 实施复杂度
中

#### 状态
⬜ 备选

---

## 六、技术债务清单

> 来自本次审查发现的技术债务，纳入长期跟踪

| ID | 类型 | 描述 | 影响 | 优先级 | 状态 |
|----|------|------|------|--------|------|
| TD-001 | 架构 | `AccessService` 等超大文件拆分与接口化 | 可维护性/可测试性 | P1 | ⬜ |
| TD-002 | 代码 | 全局异常处理重复与错误契约标准化 | 一致性/运维 | P1 | ⬜ |
| TD-003 | 测试 | 编译告警（CS0618/CS86xx）收敛与告警门禁 | 质量基线 | P3 | ⬜ |

---

## 七、文档同步计划

> 修复问题后需要同步更新的文档

| 问题ID | 需更新文档 | 更新内容 | 状态 |
|--------|------------|----------|------|
| P0-001 | `c:\workspace\bobcrm\docs\reference\API-01-接口文档.md` | 补充 JWT 配置必填项与环境差异说明 | ⬜ |
| P0-002 | `c:\workspace\bobcrm\docs\reference\API-01-接口文档.md` | 补充 CORS 策略与 AllowedOrigins 配置说明 | ⬜ |
| P1-002 | `c:\workspace\bobcrm\docs\guides\I18N-01-多语机制设计文档.md` | 明确“错误响应只返回 code/key，前端渲染文案”的统一规则 | ⬜ |
| P0-003 | `c:\workspace\bobcrm\docs\process\PROC-01-PR检查清单.md` | 增加“Endpoint 层不允许业务逻辑泄漏（只做路由/校验/授权/调用服务）”检查项 | ⬜ |

---

## 八、测试计划

### 8.1 单元测试

| 问题ID | 需新增测试 | 测试文件 | 状态 |
|--------|------------|----------|------|
| P0-001 | 非开发环境缺失 Jwt:Key 启动失败 | `c:\workspace\bobcrm\tests\BobCrm.Api.Tests\*`（新增/扩展） | ⬜ |
| P1-005 | ThrowDomain 控制流标注后可空性场景覆盖 | `c:\workspace\bobcrm\tests\BobCrm.Api.Tests\*`（新增/扩展） | ⬜ |

### 8.2 集成测试

| 问题ID | 测试场景 | 测试文件 | 状态 |
|--------|----------|----------|------|
| P0-002 | CORS 预检与跨域调用（AllowedOrigins 生效） | `c:\workspace\bobcrm\tests\BobCrm.Api.Tests\*`（新增/扩展） | ⬜ |
| P1-002 | 未处理异常返回契约（traceId/errorCode/messageKey） | `c:\workspace\bobcrm\tests\BobCrm.Api.Tests\*`（新增/扩展） | ⬜ |

### 8.3 回归测试范围

- [ ] 实体系统完整流程
- [ ] 权限系统验证
- [ ] 表单系统功能
- [ ] 多语言切换
- [ ] 菜单导航

---

## 九、发布检查清单

修复完成后，发布前必须确认：

### 9.1 代码检查
- [ ] 所有 P0 问题已修复
- [ ] 所有 P1 问题已修复
- [ ] 代码已通过审查
- [ ] 无新引入的问题

### 9.2 测试检查
- [ ] 单元测试 100% 通过
- [ ] 集成测试 100% 通过
- [ ] 回归测试通过
- [ ] 性能测试通过（如适用）

### 9.3 文档检查
- [ ] API 文档已更新
- [ ] 设计文档已同步
- [ ] CHANGELOG 已更新
- [ ] 发布说明已准备

### 9.4 部署检查
- [ ] 数据库迁移脚本准备
- [ ] 配置变更确认
- [ ] 回滚方案就绪

---

## 十、执行进度追踪

### 10.1 每日进度

| 日期 | P0完成 | P1完成 | P2完成 | 备注 |
|------|--------|--------|--------|------|
| 12-26 | /3 | /8 | /3 | |

### 10.2 问题状态总览

```
P0: ░░░░░░░░░░ 0% (0/3)
P1: ░░░░░░░░░░ 0% (0/8)
P2: ▓▓▓▓▓▓▓▓▓▓ 100% (3/3)
P3: ░░░░░░░░░░ 0% (0/3)
```

### 10.3 风险和障碍

| 风险/障碍 | 影响 | 缓解措施 | 状态 |
|-----------|------|----------|------|
| 迁移过时 API（CS0618）涉及面广 | 可能引发行为回归 | 以告警清单分批迁移 + 契约测试兜底 | ⬜ |
| 异常处理策略调整影响前后端契约 | 可能影响前端错误展示 | 提前定义响应字段契约 + 前端适配 + 回归测试 | ⬜ |
| AccessService 拆分影响权限/菜单 | 回归风险高 | 先抽象接口与快照测试，再逐步拆分 | ⬜ |
| Endpoint 逻辑下沉改动面大（多端点/多服务/事务/测试） | 可能牵连权限、模板、实体定义关键链路 | 以端点为单位逐步提取 + 保持 API 契约不变 + 增量回归测试 | ⬜ |

---

## 附录

### A. 相关文档

- 审查报告：`c:\workspace\bobcrm\docs\reviews\REVIEW-14-代码质量评审-2025-12.md`
- 审查报告：`c:\workspace\bobcrm\docs\reviews\REVIEW-13-Code-Quality-Review-2025-12.md`

### B. 参考规范

- STD-01: 开发质量标准
- PROC-01: PR检查清单
- PROC-02: 文档同步规范

### C. 变更日志

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2025-12-25 | 初始创建 | BobCRM 开发团队 |

---

**计划创建日期**: 2025-12-25  
**最后更新日期**: 2025-12-25  
**下次审查日期**: 2026-01-17  
