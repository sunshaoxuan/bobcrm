# PLAN-24: 测试覆盖率 90% 目标计划

**创建日期**: 2025-12-28
**背景**: PLAN-22 完成后，需全面提升覆盖率至 90% 以满足 STD-04 规范
**状态**: 待开始
**目标**: BobCrm.Api 行覆盖率 ≥ 90%

---

## 一、现状全面分析

### 1.1 代码规模统计

| 模块 | 文件数 | 代码行数 | 当前覆盖率 | 优先级 |
|------|--------|----------|-----------|--------|
| Services | 85 | ~15,202 | 35% | 高 |
| Endpoints | 22 | ~6,288 | 60% | 中 |
| Infrastructure | 35+ | ~3,425 | 9% | **极高** |
| Middleware | 1 | 54 | **0%** | **极高** |
| Utils | 4 | 287 | 25% | 中 |
| **合计** | **150+** | **~25,256** | **~47%** | - |

### 1.2 测试资源统计

| 项目 | 测试文件数 | 测试代码行数 |
|------|-----------|-------------|
| BobCrm.Api.Tests | 76 | ~20,223 |

### 1.3 覆盖率目标

| 阶段 | 目标覆盖率 | 预计完成时间 |
|------|-----------|-------------|
| Phase 1 | 55% | 1 周 |
| Phase 2 | 70% | 2 周 |
| Phase 3 | 80% | 3 周 |
| Phase 4 | 90% | 4 周 |

---

## 二、缺少测试的关键模块

### 2.1 安全关键组件（无测试 - 极高风险）

| 组件 | 位置 | 行数 | 风险说明 |
|------|------|------|----------|
| **FunctionPermissionFilter** | Middleware | 54 | 权限绕过风险 |
| **AppDbContext** | Infrastructure | 766 | EF 映射错误风险 |
| **EfRefreshTokenStore** | Infrastructure | 66 | JWT 安全风险 |

### 2.2 核心业务逻辑（无测试 - 高风险）

| 服务 | 行数 | 用途 |
|------|------|------|
| FunctionService | 770 | 功能节点与权限管理 |
| EntityDefinitionAppService | 464 | 实体定义管理应用层 |
| EntityLockService | 274 | 乐观锁并发控制 |
| DDLExecutionService | 232 | 数据库 DDL 执行 |
| TemplateService | 473 | 核心模板管理 |
| EntityMenuRegistrar | 396 | 动态菜单注册 |

### 2.3 业务功能（无测试 - 中等风险）

| 服务 | 行数 | 用途 |
|------|------|------|
| FieldFilterService | 237 | 字段权限过滤 |
| MultilingualFieldService | 221 | 多语言字段处理 |
| UserAppService | 250 | 用户管理应用层 |
| TemplateBindingAppService | 214 | 模板绑定应用层 |
| SystemMenuSeeder | 229 | 系统菜单初始化 |
| I18nAdminService | 184 | i18n 管理服务 |

### 2.4 端点层（部分无测试）

| 端点 | 行数 | 状态 |
|------|------|------|
| FieldPermissionEndpoints | 198 | 无专门测试 |
| SettingsEndpoints | 135 | 无专门测试 |
| DataSetEndpoints | 143 | 无专门测试 |
| FileEndpoints | 51 | 无专门测试 |

### 2.5 EF 配置（全部无测试）

- AuditLogConfiguration.cs (49 LOC)
- FunctionNodeConfiguration.cs (43 LOC)
- RoleProfileConfiguration.cs (39 LOC)
- CustomerConfiguration.cs
- FieldDefinitionConfiguration.cs
- RoleAssignmentConfiguration.cs
- RoleDataScopeConfiguration.cs
- RoleFunctionPermissionConfiguration.cs
- 等 10+ 个配置文件

---

## 三、详细任务分解

### 3.1 Phase 1：安全关键（极高优先级）

#### P1-001: FunctionPermissionFilter 测试

**目标**: 覆盖端点级权限过滤

**测试用例**:
- [ ] 授权用户可访问受保护端点
- [ ] 未授权用户被拒绝（401/403）
- [ ] 缺少令牌处理
- [ ] 权限继承检查
- [ ] 多角色权限合并

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/FunctionPermissionFilterTests.cs`

**预计工时**: 4h

---

#### P1-002: AppDbContext 测试

**目标**: 验证 EF Core 映射正确性

**测试用例**:
- [ ] 实体映射完整性
- [ ] 导航属性正确加载
- [ ] 关系配置正确性（一对多、多对多）
- [ ] 软删除过滤器
- [ ] 审计字段自动填充

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/AppDbContextTests.cs`

**预计工时**: 8h

---

#### P1-003: EntityLockService 测试

**目标**: 覆盖乐观锁并发控制

**测试用例**:
- [ ] 锁定实体（成功/已锁定）
- [ ] 解锁实体
- [ ] 检查锁定状态
- [ ] 并发更新检测
- [ ] 版本号冲突处理
- [ ] 验证修改请求（锁定时拒绝危险操作）

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/EntityLockServiceTests.cs`

**预计工时**: 5h

---

#### P1-004: DDLExecutionService 测试

**目标**: 覆盖 DDL 执行与记录

**测试用例**:
- [ ] 执行 DDL（成功记录）
- [ ] 执行 DDL（失败记录）
- [ ] 事务回滚
- [ ] DDL 脚本状态更新
- [ ] 获取执行历史

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/DDLExecutionServiceTests.cs`

**预计工时**: 5h

---

#### P1-005: EfRefreshTokenStore 测试

**目标**: 覆盖 JWT 令牌存储

**测试用例**:
- [ ] 存储刷新令牌
- [ ] 验证刷新令牌
- [ ] 撤销刷新令牌
- [ ] 过期令牌处理
- [ ] 并发令牌刷新

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/EfRefreshTokenStoreTests.cs`

**预计工时**: 3h

---

### 3.2 Phase 2：核心业务逻辑（高优先级）

#### P2-001: FunctionService 测试

**目标**: 覆盖功能节点管理

**测试用例**:
- [ ] 创建功能节点（含多语言显示名）
- [ ] 更新功能节点
- [ ] 删除功能节点（存在子节点时阻止）
- [ ] 功能节点层级管理
- [ ] 权限查询准确性
- [ ] 重复 Code 校验

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/FunctionServiceTests.cs`

**预计工时**: 8h

---

#### P2-002: EntityDefinitionAppService 测试

**目标**: 覆盖实体定义应用层

**测试用例**:
- [ ] 创建实体定义
- [ ] 更新字段配置
- [ ] 接口关联管理
- [ ] 发布工作流集成
- [ ] 验证规则检查

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/EntityDefinitionAppServiceTests.cs`

**预计工时**: 8h

---

#### P2-003: TemplateService 测试

**目标**: 覆盖模板管理核心逻辑

**测试用例**:
- [ ] 模板 CRUD 操作
- [ ] 模板克隆
- [ ] 绑定关系管理
- [ ] 状态验证
- [ ] 权限检查

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/TemplateServiceTests.cs`

**预计工时**: 6h

---

#### P2-004: EntityMenuRegistrar 测试

**目标**: 覆盖动态菜单注册

**测试用例**:
- [ ] 注册实体菜单（新建）
- [ ] 更新实体菜单
- [ ] 删除实体菜单
- [ ] 菜单层级验证
- [ ] 权限节点关联

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/EntityMenuRegistrarTests.cs`

**预计工时**: 5h

---

### 3.3 Phase 3：业务功能（中等优先级）

#### P3-001: FieldFilterService 测试

**目标**: 覆盖字段权限过滤

**测试用例**:
- [ ] 按权限过滤字段
- [ ] 按可见性过滤字段
- [ ] 敏感数据隐藏
- [ ] 批量过滤

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/FieldFilterServiceTests.cs`

**预计工时**: 4h

---

#### P3-002: MultilingualFieldService 测试

**目标**: 覆盖多语言字段处理

**测试用例**:
- [ ] 解析多语言字段
- [ ] 更新多语言字段
- [ ] 语言回退逻辑
- [ ] 空值处理

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/MultilingualFieldServiceTests.cs`

**预计工时**: 3h

---

#### P3-003: UserAppService 测试

**目标**: 覆盖用户应用服务

**测试用例**:
- [ ] 获取当前用户信息
- [ ] 更新用户偏好
- [ ] 用户会话管理
- [ ] 密码变更

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/UserAppServiceTests.cs`

**预计工时**: 4h

---

#### P3-004: TemplateBindingAppService 测试

**目标**: 覆盖模板绑定应用层

**测试用例**:
- [ ] 创建绑定
- [ ] 更新绑定
- [ ] 删除绑定
- [ ] 绑定冲突检测

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/TemplateBindingAppServiceTests.cs`

**预计工时**: 3h

---

#### P3-005: 端点层补充测试

**目标**: 覆盖缺少测试的端点

**测试用例**:
- [ ] FieldPermissionEndpoints 完整测试
- [ ] SettingsEndpoints 完整测试
- [ ] DataSetEndpoints 完整测试
- [ ] FileEndpoints 完整测试

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/FieldPermissionEndpointsTests.cs`
- 新增: `tests/BobCrm.Api.Tests/SettingsEndpointsTests.cs`
- 新增: `tests/BobCrm.Api.Tests/DataSetEndpointsTests.cs`
- 新增: `tests/BobCrm.Api.Tests/FileEndpointsTests.cs`

**预计工时**: 8h

---

### 3.4 Phase 4：支持服务与配置（低优先级）

#### P4-001: I18n 相关服务测试

**测试用例**:
- [ ] I18nAdminService 完整测试
- [ ] I18nResourceSynchronizer 测试
- [ ] I18nResourceLoader 测试

**预计工时**: 4h

---

#### P4-002: Seeder 服务测试

**测试用例**:
- [ ] SystemMenuSeeder 测试
- [ ] ViewStateSeeder 测试
- [ ] AggregateMetadataPublisher 测试

**预计工时**: 4h

---

#### P4-003: EF 配置测试

**测试用例**:
- [ ] 所有 Configuration 类的映射验证
- [ ] 关系约束测试
- [ ] 索引配置测试

**预计工时**: 6h

---

#### P4-004: Utils 补充测试

**测试用例**:
- [ ] FieldFilterExtensions 测试
- [ ] FileNameHelper 测试

**预计工时**: 2h

---

## 四、执行计划

### 4.1 阶段划分

| 阶段 | 任务 | 工时 | 目标覆盖率 |
|------|------|------|-----------|
| Phase 1 | P1-001 ~ P1-005 | 25h | 47% → 55% |
| Phase 2 | P2-001 ~ P2-004 | 27h | 55% → 70% |
| Phase 3 | P3-001 ~ P3-005 | 22h | 70% → 80% |
| Phase 4 | P4-001 ~ P4-004 | 16h | 80% → 90% |
| **总计** | - | **90h** | **90%** |

### 4.2 里程碑

- [ ] **M1**: Phase 1 完成，覆盖率 > 55%
- [ ] **M2**: Phase 2 完成，覆盖率 > 70%
- [ ] **M3**: Phase 3 完成，覆盖率 > 80%
- [ ] **M4**: Phase 4 完成，覆盖率 ≥ 90%

---

## 五、测试策略

### 5.1 测试类型

| 类型 | 适用场景 | 工具 |
|------|----------|------|
| 单元测试 | Services、Utils | xUnit + Moq |
| 集成测试 | Endpoints、Infrastructure | TestServer + InMemoryDb |
| EF 映射测试 | AppDbContext、Configurations | InMemoryDb |

### 5.2 Mock 策略

```csharp
// 服务层 Mock 示例
var mockDb = new Mock<AppDbContext>();
var mockLogger = new Mock<ILogger<FunctionService>>();
var service = new FunctionService(mockDb.Object, mockLogger.Object);
```

### 5.3 测试命名规范

```csharp
// 格式：MethodName_Scenario_ExpectedBehavior
[Fact]
public async Task LockEntityAsync_WhenEntityExists_ShouldSetIsLockedTrue()
{
    // Arrange
    // Act
    // Assert
}
```

---

## 六、验收标准

### 6.1 覆盖率指标

- [ ] BobCrm.Api 行覆盖率 ≥ 90%
- [ ] 分支覆盖率 ≥ 60%
- [ ] 安全关键代码 100% 覆盖

### 6.2 质量要求

- [ ] 所有新增测试通过
- [ ] 测试代码符合命名规范
- [ ] 测试覆盖正常路径和异常路径
- [ ] 无跳过测试（除非有充分理由）

---

## 七、风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 某些服务难以 Mock | 中 | 中 | 重构为可测试设计，引入接口 |
| 测试执行时间过长 | 中 | 低 | 使用并行测试，优化 InMemory 数据库 |
| EF 配置测试复杂 | 高 | 中 | 使用真实数据库进行集成测试 |
| 覆盖率提升不及预期 | 中 | 高 | 持续监控覆盖率，调整任务优先级 |

---

## 八、依赖关系

- PLAN-22: 已完成，提供基础测试框架
- STD-04: 定义 90% 覆盖率要求
- STD-06: 集成测试规范

---

## 九、变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2025-12-28 | 初始创建（基于全面代码分析） |

---

**计划创建日期**: 2025-12-28
**最后更新日期**: 2025-12-28
