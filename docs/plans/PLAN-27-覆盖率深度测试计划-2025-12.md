# PLAN-27: 测试覆盖率深度测试计划

**创建日期**: 2025-12-29
**背景**: PLAN-26 评审发现测试深度不足，覆盖率仅提升 0.11%，需重新规划
**状态**: 待开始
**目标**: BobCrm.Api 行覆盖率 ≥ 90%

---

## 一、问题分析

### 1.1 PLAN-26 问题总结

| 问题 | 影响 | 解决方案 |
|------|------|----------|
| 端点测试仅验证认证边界 | 仅覆盖 2-3 行代码 | 测试完整业务流程 |
| 服务测试覆盖 DTO 而非核心逻辑 | 几乎无覆盖提升 | 测试实际服务方法 |
| AggVO 测试用私有测试类 | 未覆盖生产代码 | 测试真实 AggVOService |

### 1.2 覆盖率现状

| 指标 | 数值 |
|------|------|
| 当前行覆盖率 | 82.45% |
| 目标覆盖率 | 90.00% |
| 差距 | 7.55% |
| 需覆盖行数 | ~6,438 行 |

### 1.3 关键发现

**测试 13 个核心类可弥补 45.9% 的差距**

| 类别 | 数量 | 未覆盖行 | 占差距比例 |
|------|------|----------|-----------|
| 低覆盖率端点 (<70%) | 10 | 2,524 | 39.2% |
| 低覆盖率服务 (<60%) | 3 | 432 | 6.7% |
| **合计** | **13** | **2,956** | **45.9%** |

---

## 二、优先级排序

### 2.1 极高优先级 (P0) - 最大覆盖率提升

| 排名 | 文件 | 覆盖率 | 未覆盖行 | 占差距 |
|------|------|--------|----------|--------|
| 1 | **EntityDefinitionEndpoints.cs** | 53.3% | 918 | 14.3% |
| 2 | **AdminEndpoints.cs** | 65.8% | 328 | 5.1% |
| 3 | **EntityAggregateEndpoints.cs** | 42.2% | 266 | 4.1% |
| 4 | **ReflectionPersistenceService.cs** | 0% | 214 | 3.3% |
| 5 | **AccessEndpoints.cs** | 65.9% | 208 | 3.2% |

### 2.2 高优先级 (P1) - 快速提升

| 排名 | 文件 | 覆盖率 | 未覆盖行 | 占差距 |
|------|------|--------|----------|--------|
| 6 | TemplateEndpoints.cs | 65.3% | 200 | 3.1% |
| 7 | DynamicEntityEndpoints.cs | 68.6% | 164 | 2.5% |
| 8 | SetupEndpoints.cs | 65.6% | 124 | 1.9% |
| 9 | FieldPermissionEndpoints.cs | 61.4% | 122 | 1.9% |
| 10 | EntityDefinitionAppService.cs | 47.2% | 112 | 1.7% |

### 2.3 中等优先级 (P2) - 零覆盖类

| 文件 | 未覆盖行 | 说明 |
|------|----------|------|
| AggVOService.cs | 106 | 聚合值对象核心服务 |
| InterfaceFieldMapping.cs | 86 | 接口字段映射 |
| Result.cs / Result<T>.cs | 82 | 结果包装类 |

---

## 三、测试策略改进

### 3.1 端点测试深度策略

**错误示范** (PLAN-26):
```csharp
// 仅测试认证边界，覆盖 ~2 行
[Fact]
public async Task GetEntities_WithAuth_ShouldReturn200()
{
    var response = await client.GetAsync("/api/entities");
    response.StatusCode.Should().Be(HttpStatusCode.OK);
}
```

**正确示范** (PLAN-27):
```csharp
// 测试完整业务流程，覆盖 ~50+ 行
[Fact]
public async Task CreateEntity_WithValidData_ShouldCreateAndReturnEntity()
{
    // Arrange - 准备完整请求数据
    var request = new CreateEntityRequest
    {
        EntityName = "TestEntity",
        Namespace = "Test",
        DisplayName = new Dictionary<string, string> { ["zh"] = "测试实体" },
        Fields = new List<FieldRequest>
        {
            new() { PropertyName = "code", DataType = "String", IsRequired = true },
            new() { PropertyName = "name", DataType = "String", IsRequired = true }
        }
    };

    // Act - 执行创建
    var response = await client.PostAsJsonAsync("/api/entity-definitions", request);

    // Assert - 验证响应和数据库状态
    response.StatusCode.Should().Be(HttpStatusCode.Created);
    var result = await response.Content.ReadFromJsonAsync<EntityDefinitionDto>();
    result.Should().NotBeNull();
    result!.EntityName.Should().Be("TestEntity");
    result.Fields.Should().HaveCount(2);

    // 验证数据库
    var saved = await _context.EntityDefinitions
        .Include(e => e.Fields)
        .FirstAsync(e => e.EntityName == "TestEntity");
    saved.Fields.Should().HaveCount(2);
}

[Fact]
public async Task CreateEntity_WithDuplicateName_ShouldReturn400()
{
    // 测试错误路径
}

[Fact]
public async Task UpdateEntity_WhenLocked_ShouldReturn400()
{
    // 测试锁定状态
}
```

### 3.2 服务测试深度策略

**错误示范** (PLAN-26):
```csharp
// 测试 DTO 属性，不覆盖服务代码
[Fact]
public void QueryOptions_DefaultValues_ShouldBeCorrect()
{
    var options = new QueryOptions();
    options.Skip.Should().BeNull();
}
```

**正确示范** (PLAN-27):
```csharp
// 测试服务核心方法
[Fact]
public async Task ReflectionPersistenceService_GetEntityByType_ShouldReturnEntity()
{
    // Arrange
    var service = CreateService();
    var entity = await SeedTestEntity();

    // Act - 调用真实服务方法
    var result = await service.GetByIdAsync("Customer", entity.Id);

    // Assert
    result.Should().NotBeNull();
}

[Fact]
public async Task ReflectionPersistenceService_SaveEntity_ShouldPersist()
{
    // 测试保存逻辑
}

[Fact]
public async Task ReflectionPersistenceService_ApplyFilters_ShouldFilterCorrectly()
{
    // 测试过滤逻辑
}
```

### 3.3 复杂服务测试策略

对于依赖动态类型的服务（如 `ReflectionPersistenceService`），使用以下策略：

```csharp
// 策略 1: 使用已知的系统实体类型
[Fact]
public async Task Service_WithCustomerEntity_ShouldWork()
{
    var result = await service.GetAllAsync("Customer", new QueryOptions());
    // Customer 是已知的系统实体
}

// 策略 2: 使用 Testable 子类
internal class TestableReflectionPersistenceService : ReflectionPersistenceService
{
    public new object? ConvertValue(object? value, Type targetType)
        => base.ConvertValue(value, targetType);
}

// 策略 3: 直接测试内部方法（通过 InternalsVisibleTo）
```

---

## 四、任务分解

### Phase 1: 端点深度测试 - EntityDefinition (预计 12h)

#### P1-001: EntityDefinitionEndpoints 完整 CRUD 测试

**当前覆盖率**: 53.3% (918 行未覆盖)

**测试场景**:

| 场景 | 预计覆盖行数 | 优先级 |
|------|-------------|--------|
| 创建实体定义（完整数据） | ~80 | P0 |
| 更新实体定义 | ~60 | P0 |
| 添加/更新/删除字段 | ~150 | P0 |
| 添加/移除接口 | ~100 | P0 |
| 发布流程（生成代码→编译→DDL） | ~200 | P0 |
| 锁定/解锁操作 | ~50 | P1 |
| 验证错误路径 | ~100 | P1 |
| 权限检查路径 | ~50 | P1 |

**新增文件**:
- `tests/BobCrm.Api.Tests/EntityDefinitionEndpointsCrudTests.cs`
- `tests/BobCrm.Api.Tests/EntityDefinitionFieldsTests.cs`
- `tests/BobCrm.Api.Tests/EntityDefinitionPublishTests.cs`

**预计工时**: 12h

---

### Phase 2: 端点深度测试 - 其他端点 (预计 10h)

#### P2-001: AdminEndpoints 完整测试

**当前覆盖率**: 65.8% (328 行未覆盖)

**测试场景**:
- [ ] 数据库健康检查
- [ ] 数据库重建（开发环境）
- [ ] 密码重置
- [ ] 系统信息查询
- [ ] 错误路径测试

**新增文件**:
- `tests/BobCrm.Api.Tests/AdminEndpointsCrudTests.cs`

**预计工时**: 3h

---

#### P2-002: EntityAggregateEndpoints 完整测试

**当前覆盖率**: 42.2% (266 行未覆盖)

**测试场景**:
- [ ] 聚合查询（分页、排序、过滤）
- [ ] 聚合保存（主从数据）
- [ ] 聚合删除（级联）
- [ ] 字段权限过滤
- [ ] 错误路径测试

**新增文件**:
- `tests/BobCrm.Api.Tests/EntityAggregateEndpointsCrudTests.cs`

**预计工时**: 4h

---

#### P2-003: AccessEndpoints 完整测试

**当前覆盖率**: 65.9% (208 行未覆盖)

**测试场景**:
- [ ] 功能节点 CRUD
- [ ] 角色权限分配
- [ ] 数据范围设置
- [ ] 用户角色分配
- [ ] 权限树查询

**新增文件**:
- `tests/BobCrm.Api.Tests/AccessEndpointsCrudTests.cs`

**预计工时**: 3h

---

### Phase 3: 核心服务深度测试 (预计 8h)

#### P3-001: ReflectionPersistenceService 测试

**当前覆盖率**: 0% (214 行未覆盖)

**测试场景**:
- [ ] 使用 Customer 实体测试 CRUD
- [ ] 使用 RoleProfile 实体测试 CRUD
- [ ] 过滤条件应用
- [ ] 排序逻辑
- [ ] 分页逻辑
- [ ] 类型转换

**测试策略**: 使用已知系统实体类型

**新增文件**:
- `tests/BobCrm.Api.Tests/ReflectionPersistenceServiceCrudTests.cs`

**预计工时**: 4h

---

#### P3-002: EntityDefinitionAppService 补充测试

**当前覆盖率**: 47.2% (112 行未覆盖)

**测试场景**:
- [ ] 复杂验证规则
- [ ] 接口冲突检测
- [ ] 字段依赖检查
- [ ] 状态转换验证

**新增文件**:
- `tests/BobCrm.Api.Tests/EntityDefinitionAppServiceCrudTests.cs`

**预计工时**: 2h

---

#### P3-003: AggVOService 测试（真实服务）

**当前覆盖率**: 0% (106 行未覆盖)

**测试场景**:
- [ ] 测试真实 AggVOService 类
- [ ] 使用已发布的聚合实体
- [ ] 主从数据操作

**新增文件**:
- `tests/BobCrm.Api.Tests/AggVOServiceRealTests.cs`

**预计工时**: 2h

---

### Phase 4: 补充端点测试 (预计 6h)

#### P4-001: TemplateEndpoints 完整测试

**测试场景**:
- [ ] 模板 CRUD
- [ ] 模板绑定
- [ ] 默认模板生成

**预计工时**: 2h

---

#### P4-002: DynamicEntityEndpoints 完整测试

**测试场景**:
- [ ] 动态实体 CRUD
- [ ] 查询过滤
- [ ] 分页排序

**预计工时**: 2h

---

#### P4-003: FieldPermissionEndpoints 完整测试

**测试场景**:
- [ ] 字段权限配置
- [ ] 权限检查

**预计工时**: 2h

---

## 五、执行计划

### 5.1 阶段目标

| 阶段 | 任务 | 工时 | 预期覆盖提升 | 预期覆盖率 |
|------|------|------|-------------|-----------|
| Phase 1 | EntityDefinition 深度测试 | 12h | +4% | 82% → 86% |
| Phase 2 | 其他端点深度测试 | 10h | +2.5% | 86% → 88.5% |
| Phase 3 | 核心服务深度测试 | 8h | +1.5% | 88.5% → 90% |
| Phase 4 | 补充端点测试 | 6h | +0.5% | 90% → 90.5% |
| **总计** | - | **36h** | **+8.5%** | **≥ 90%** |

### 5.2 里程碑

- [ ] **M1**: Phase 1 完成，覆盖率 ≥ 86%
- [ ] **M2**: Phase 2 完成，覆盖率 ≥ 88.5%
- [ ] **M3**: Phase 3 完成，覆盖率 ≥ 90%
- [ ] **M4**: Phase 4 完成，覆盖率 ≥ 90.5%

---

## 六、测试检查清单

### 6.1 端点测试必须包含

- [ ] 成功创建（201 + 返回数据 + 数据库验证）
- [ ] 成功读取（200 + 数据完整性）
- [ ] 成功更新（200 + 数据变更验证）
- [ ] 成功删除（204 + 数据库验证）
- [ ] 验证失败（400 + 错误消息）
- [ ] 未找到（404）
- [ ] 业务规则违反（400/409）
- [ ] 权限不足（403）

### 6.2 服务测试必须包含

- [ ] 核心方法测试（非 DTO）
- [ ] 边界条件
- [ ] 异常路径
- [ ] 依赖交互验证

---

## 七、预期成果

### 7.1 新增测试文件

| 阶段 | 新增文件数 | 预计测试用例数 |
|------|-----------|---------------|
| Phase 1 | 3 | ~40 |
| Phase 2 | 3 | ~30 |
| Phase 3 | 3 | ~25 |
| Phase 4 | 3 | ~15 |
| **总计** | **12** | **~110** |

### 7.2 最终指标

- 测试文件: 58 + 12 = **70 个**
- 测试用例: 866 + 110 = **~976 个**
- 覆盖率: **≥ 90%**

---

## 八、风险与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 动态实体测试困难 | 高 | 中 | 使用已知系统实体类型 |
| 端点依赖复杂数据 | 中 | 中 | 创建专用测试数据工厂 |
| 发布流程测试复杂 | 高 | 高 | 分解为独立步骤测试 |

---

## 九、验收标准

### 9.1 覆盖率指标

- [ ] BobCrm.Api 行覆盖率 ≥ 90%
- [ ] 分支覆盖率 ≥ 60%
- [ ] EntityDefinitionEndpoints 覆盖率 ≥ 80%
- [ ] ReflectionPersistenceService 覆盖率 ≥ 70%

### 9.2 质量要求

- [ ] 每个端点测试包含完整 CRUD 场景
- [ ] 每个测试验证数据库状态变更
- [ ] 测试错误路径和边界条件

---

## 十、变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2025-12-29 | 初始创建（基于 PLAN-26 评审反馈） |

---

**计划创建日期**: 2025-12-29
**最后更新日期**: 2025-12-29
