# PLAN-26: 测试覆盖率 90% 最终冲刺计划

**创建日期**: 2025-12-29
**背景**: PLAN-25 完成后覆盖率达到 82.34%，距离 90% 目标仍有 7.66% 差距
**状态**: 待开始
**目标**: BobCrm.Api 行覆盖率 ≥ 90%

---

## 一、现状分析

### 1.1 覆盖率现状

| 指标 | 数值 |
|------|------|
| 当前行覆盖率 | 82.34% |
| 目标覆盖率 | 90.00% |
| 差距 | 7.66% |
| 需新增覆盖行数 | ~1,852 行 |
| 当前测试数 | 814 个 |

### 1.2 各层覆盖率

| 层级 | 当前覆盖率 | 目标 | 未覆盖行数 |
|------|-----------|------|-----------|
| Endpoints | 67.5% | 85%+ | 1,721 行 |
| Services | 80.3% | 90%+ | 809 行 |
| Infrastructure | 82.78% | 90%+ | 较少 |

### 1.3 关键未覆盖文件 (TOP 10)

| 排名 | 文件 | 覆盖率 | 未覆盖行 | 优先级 |
|------|------|--------|----------|--------|
| 1 | EntityDefinitionEndpoints.cs | 53.2% | 460 | **极高** |
| 2 | LayoutEndpoints.cs | 73.8% | 178 | 高 |
| 3 | AdminEndpoints.cs | 65.8% | 164 | 高 |
| 4 | EntityAggregateEndpoints.cs | 42.2% | 133 | **极高** |
| 5 | AccessEndpoints.cs | 61.0% | 119 | 高 |
| 6 | TemplateEndpoints.cs | 60.8% | 113 | 高 |
| 7 | ReflectionPersistenceService.cs | 8.4% | 98 | **极高** |
| 8 | AggregateMetadataPublisher.cs | 0% | 65 | **极高** |
| 9 | DynamicEntityEndpoints.cs | 68.6% | 82 | 中 |
| 10 | AggVOService.cs | 0% | 53 | **极高** |

---

## 二、任务分解

### Phase 1: 零覆盖关键服务 (预计 8h)

#### P1-001: AggregateMetadataPublisher 测试

**当前覆盖率**: 0% (65 行未覆盖)

**测试用例**:
- [ ] 发布实体聚合元数据
- [ ] 更新已有元数据
- [ ] 异步发布流程
- [ ] 错误处理与重试
- [ ] 元数据验证

**新增文件**:
- `tests/BobCrm.Api.Tests/AggregateMetadataPublisherTests.cs`

**预计工时**: 3h

---

#### P1-002: AggVOService 测试

**当前覆盖率**: 0% (53 行未覆盖)

**测试用例**:
- [ ] 聚合值对象创建
- [ ] 聚合值对象加载
- [ ] 主从实体保存
- [ ] 级联删除
- [ ] 事务一致性

**新增文件**:
- `tests/BobCrm.Api.Tests/AggVOServiceTests.cs`

**预计工时**: 3h

---

#### P1-003: ReflectionPersistenceService 测试

**当前覆盖率**: 8.4% (98 行未覆盖)

**测试用例**:
- [ ] 反射属性获取
- [ ] 反射属性设置
- [ ] 动态实体持久化
- [ ] 类型转换处理
- [ ] 空值处理

**新增文件**:
- `tests/BobCrm.Api.Tests/ReflectionPersistenceServiceTests.cs`

**预计工时**: 2h

---

### Phase 2: 端点层补充 (预计 18h)

#### P2-001: EntityDefinitionEndpoints 补充测试

**当前覆盖率**: 53.2% (460 行未覆盖)

**测试用例**:
- [ ] 字段 CRUD 端点（添加/更新/删除字段）
- [ ] 接口关联端点（添加/移除接口）
- [ ] 发布流程端点（生成代码/编译/执行DDL）
- [ ] 验证错误路径
- [ ] 权限验证
- [ ] 锁定状态检查

**新增文件**:
- `tests/BobCrm.Api.Tests/EntityDefinitionEndpointsExtendedTests.cs`

**预计工时**: 6h

---

#### P2-002: EntityAggregateEndpoints 测试

**当前覆盖率**: 42.2% (133 行未覆盖)

**测试用例**:
- [ ] 聚合查询端点
- [ ] 聚合保存端点（主从数据）
- [ ] 聚合删除端点
- [ ] 分页与排序
- [ ] 字段过滤
- [ ] 权限验证

**新增文件**:
- `tests/BobCrm.Api.Tests/EntityAggregateEndpointsTests.cs`

**预计工时**: 4h

---

#### P2-003: AccessEndpoints 补充测试

**当前覆盖率**: 61.0% (119 行未覆盖)

**测试用例**:
- [ ] 功能节点 CRUD
- [ ] 角色权限分配
- [ ] 数据范围设置
- [ ] 权限继承验证
- [ ] 批量操作

**新增文件**:
- `tests/BobCrm.Api.Tests/AccessEndpointsExtendedTests.cs`

**预计工时**: 3h

---

#### P2-004: TemplateEndpoints 补充测试

**当前覆盖率**: 60.8% (113 行未覆盖)

**测试用例**:
- [ ] 模板绑定端点
- [ ] 模板克隆端点
- [ ] 模板预览端点
- [ ] 默认模板生成
- [ ] 权限验证

**新增文件**:
- `tests/BobCrm.Api.Tests/TemplateEndpointsExtendedTests.cs`

**预计工时**: 3h

---

#### P2-005: LayoutEndpoints 测试

**当前覆盖率**: 73.8% (178 行未覆盖)

**测试用例**:
- [ ] 布局保存
- [ ] 布局加载
- [ ] 布局验证
- [ ] 用户布局偏好

**新增文件**:
- `tests/BobCrm.Api.Tests/LayoutEndpointsTests.cs`

**预计工时**: 2h

---

### Phase 3: 服务层补充 (预计 10h)

#### P3-001: EntityDefinitionAppService 补充测试

**当前覆盖率**: 47.2% (56 行未覆盖)

**测试用例**:
- [ ] 复杂验证场景
- [ ] 接口冲突检测
- [ ] 字段依赖检查
- [ ] 发布前验证

**预计工时**: 2h

---

#### P3-002: EntityMenuRegistrar 补充测试

**当前覆盖率**: 66.2% (25 行未覆盖)

**测试用例**:
- [ ] 菜单更新场景
- [ ] 菜单删除场景
- [ ] 权限节点同步

**预计工时**: 2h

---

#### P3-003: FunctionService 补充测试

**当前覆盖率**: 61.9% (24 行未覆盖)

**测试用例**:
- [ ] 批量权限更新
- [ ] 层级权限计算
- [ ] 缓存刷新

**预计工时**: 2h

---

#### P3-004: RoslynCompiler 补充测试

**当前覆盖率**: 78.9% (42 行未覆盖)

**测试用例**:
- [ ] 编译错误处理
- [ ] 引用解析失败
- [ ] 超时处理

**预计工时**: 2h

---

#### P3-005: AggVOCodeGenerator 补充测试

**当前覆盖率**: 81.3% (51 行未覆盖)

**测试用例**:
- [ ] 3层聚合代码生成
- [ ] 特殊字段类型处理
- [ ] 命名空间冲突

**预计工时**: 2h

---

### Phase 4: 边界与异常路径 (预计 6h)

#### P4-001: 错误路径补充

**测试用例**:
- [ ] 各端点的 400/404/500 错误路径
- [ ] 验证失败场景
- [ ] 并发冲突场景
- [ ] 超时场景

**预计工时**: 3h

---

#### P4-002: 边界条件测试

**测试用例**:
- [ ] 空集合处理
- [ ] 极端长度字符串
- [ ] 特殊字符处理
- [ ] 大数据量分页

**预计工时**: 3h

---

## 三、执行计划

### 3.1 阶段目标

| 阶段 | 任务 | 工时 | 预期新增覆盖 | 预期覆盖率 |
|------|------|------|-------------|-----------|
| Phase 1 | 零覆盖关键服务 | 8h | +500 行 | 82% → 84% |
| Phase 2 | 端点层补充 | 18h | +800 行 | 84% → 87% |
| Phase 3 | 服务层补充 | 10h | +350 行 | 87% → 89% |
| Phase 4 | 边界与异常 | 6h | +200 行 | 89% → 90%+ |
| **总计** | - | **42h** | **+1,850 行** | **≥ 90%** |

### 3.2 里程碑

- [ ] **M1**: Phase 1 完成，覆盖率 ≥ 84%
- [ ] **M2**: Phase 2 完成，覆盖率 ≥ 87%
- [ ] **M3**: Phase 3 完成，覆盖率 ≥ 89%
- [ ] **M4**: Phase 4 完成，覆盖率 ≥ 90%

---

## 四、预期成果

### 4.1 新增测试文件

| 阶段 | 新增文件数 | 预计测试用例数 |
|------|-----------|---------------|
| Phase 1 | 3 | ~30 |
| Phase 2 | 5 | ~60 |
| Phase 3 | 5 | ~40 |
| Phase 4 | 2 | ~20 |
| **总计** | **15** | **~150** |

### 4.2 最终指标

- 测试文件: 50 + 15 = **65 个**
- 测试用例: 814 + 150 = **~964 个**
- 覆盖率: **≥ 90%**

---

## 五、测试策略

### 5.1 端点测试模式

```csharp
// 使用 TestWebAppFactory 进行集成测试
public class XxxEndpointsTests : IClassFixture<TestWebAppFactory>
{
    private readonly HttpClient _client;
    private readonly TestWebAppFactory _factory;

    public XxxEndpointsTests(TestWebAppFactory factory)
    {
        _factory = factory;
        _client = factory.CreateClient();
    }

    private async Task<HttpClient> GetAuthenticatedClientAsync()
    {
        var client = _factory.CreateClient();
        var (accessToken, _) = await client.LoginAsAdminAsync();
        client.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Bearer", accessToken);
        return client;
    }
}
```

### 5.2 服务测试模式

```csharp
// 使用 SQLite 内存数据库
public class XxxServiceTests : IDisposable
{
    private readonly SqliteConnection _connection;

    public XxxServiceTests()
    {
        _connection = new SqliteConnection("DataSource=:memory:");
        _connection.Open();
    }

    private AppDbContext CreateContext()
    {
        var options = new DbContextOptionsBuilder<AppDbContext>()
            .UseSqlite(_connection)
            .Options;
        var ctx = new AppDbContext(options);
        ctx.Database.EnsureCreated();
        return ctx;
    }

    public void Dispose() => _connection.Dispose();
}
```

---

## 六、风险与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 端点依赖复杂数据 | 高 | 中 | 使用 TestWebAppFactory 预设数据 |
| 反射服务难以测试 | 中 | 高 | 使用 Testable 子类模式 |
| 覆盖率提升不及预期 | 中 | 中 | 阶段性检查，动态调整优先级 |

---

## 七、验收标准

### 7.1 覆盖率指标

- [ ] BobCrm.Api 行覆盖率 ≥ 90%
- [ ] 分支覆盖率 ≥ 60%
- [ ] 零覆盖类降至 < 10 个

### 7.2 质量要求

- [ ] 所有新增测试通过
- [ ] 遵循 STD-04 命名规范
- [ ] 包含中文 XML 文档注释
- [ ] 覆盖正常路径和异常路径

---

## 八、依赖关系

- **PLAN-24**: 已完成，覆盖率 81%
- **PLAN-25**: 已完成，覆盖率 82.34%
- **STD-04**: 定义 90% 覆盖率要求

---

## 九、变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2025-12-29 | 初始创建（基于 PLAN-25 评审结果） |

---

**计划创建日期**: 2025-12-29
**最后更新日期**: 2025-12-29
