# PLAN-28: 覆盖率深度测试计划 v2 (冲刺 90%)

**创建日期**: 2025-12-29
**背景**: PLAN-27 成功验证了"深度测试策略"的有效性，覆盖率提升至 82.91%。当前距离 90% 目标还有 7.09% 的差距。
**状态**: 进行中（已补齐 Phase 1-3 基础用例）
**目标**: BobCrm.Api 行覆盖率 ≥ 90%

---

## 一、问题分析

### 1.1 现状与差距
| 指标 | 数值 | 说明 |
|------|------|------|
| 当前覆盖率 | 82.91% | PLAN-27 完成后 |

### 核心策略
*   **真实场景模拟**: 不仅仅测试 HTTP 状态码，而是模拟完整的"定义实体 -> 插入数据 -> 查询数据 -> 修改布局"的业务闭环。
*   **服务层直测**: 对于 `DefaultTemplateGenerator` 这种计算密集型逻辑，直接测试服务类而非仅通过 API。

---

## 三、任务分解 (Sprint Plan)

### Phase 1: 动态实体运行时 (High Risk, High Value) - 预计 10h

**目标**: 攻克最核心的动态数据处理引擎。

| 模块 | 关键类 | 预计工时 | 测试重点 |
|------|-------|----------|----------|
| **Dynamic Data** | `DynamicEntityEndpoints.cs` <br> `DynamicEntityService.cs` | 6h | - 动态实体的完整 CRUD <br> - 复杂查询过滤 (Filter/Sort) <br> - 关联字段处理 (Lookup) |
| **Locking** | `EntityLockService.cs` | 4h | - 并发锁定逻辑 <br> - 锁过期与心跳机制 |

**新增文件**:
*   `tests/BobCrm.Api.Tests/DynamicEntityEndpointsCrudTests.cs`
*   `tests/BobCrm.Api.Tests/EntityLockServiceTests.cs`

---

### Phase 2: 模板与UI系统 (Complexity) - 预计 8h

**目标**: 覆盖复杂的 UI 模板生成与绑定逻辑。

| 模块 | 关键类 | 预计工时 | 测试重点 |
|------|-------|----------|----------|
| **Templates** | `TemplateEndpoints.cs` <br> `TemplateService.cs` | 4h | - 模板 CRUD <br> - 模板复制 (Copy) 与应用 (Apply) <br> - 系统/用户默认模板优先级 |
| **Generator** | `DefaultTemplateGenerator.cs` | 4h | - 自动生成表单逻辑 <br> - 响应式布局计算 (Row/Col) <br> - 字段类型映射 |

**新增文件**:
*   `tests/BobCrm.Api.Tests/TemplateEndpointsCrudTests.cs`
*   `tests/BobCrm.Api.Tests/DefaultTemplateGeneratorTests.cs`

---

### Phase 3: 系统与认证 (Stability) - 预计 6h

**目标**: 补全系统基础功能的边缘场景。

| 模块 | 关键类 | 预计工时 | 测试重点 |
|------|-------|----------|----------|
| **Auth** | `AuthEndpoints.cs` | 3h | - 登录失败/锁定 <br> - 刷新令牌流程 <br> - 密码策略验证 |
| **System** | `SystemEndpoints.cs` <br> `EnumDefinitionEndpoints.cs` | 3h | - 枚举管理 CRUD <br> - 菜单树结构验证 |

**新增文件**:
*   `tests/BobCrm.Api.Tests/AuthEndpointsTests.cs`
*   `tests/BobCrm.Api.Tests/SystemEndpointsTests.cs`

---

## 四、预期成果

| 阶段 | 新增测试文件 | 预计用例数 | 预期覆盖率提升 |
|------|-------------|------------|---------------|
| Phase 1 | 2 | ~40 | +3.5% |
| Phase 2 | 2 | ~30 | +2.5% |
| Phase 3 | 2 | ~20 | +1.5% |
| **总计** | **6** | **~90** | **+7.5% (总计 >90%)** |

## 五、验收标准

1.  **覆盖率**: 全局行覆盖率达到 90%。
2.  **质量**: 所有新测试通过，且包含数据库状态验证。
3.  **文档**: 更新 `task.md` 和评审报告。

---

## 六、执行记录

- 2025-12-29：已补齐 Phase 1/2/3 对应端点深度用例（新增 `DynamicEntityEndpointsCrudTests`、`TemplateEndpointsCrudTests`、`AuthEndpointsTests`、`SystemEndpointsTests`），并修复测试与基础模型的可空性问题；门禁通过（`pwsh scripts/check-warning-baseline.ps1`=0/0，`dotnet test -c Release` 全通过）。
- 2025-12-29：新增覆盖率分析脚本 `scripts/coverage-summary.ps1`（用于生成覆盖率盲区清单）；补齐动态实体 raw/count、枚举端点 CRUD、系统端点权限覆盖与刷新令牌异常路径；修复系统模板 Apply 流程中“新副本未落库却 Update 导致临时主键异常”的缺陷（`TemplateService.ApplyTemplateAsync`）。
- 下一步：生成覆盖率报告并定位剩余盲区（按“动态实体运行时 / 模板系统 / 系统与认证”继续补齐用例），直至达到 ≥90%。
