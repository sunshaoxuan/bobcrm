# PLAN-22: 测试覆盖率提升计划

**创建日期**: 2025-12-28
**背景**: PLAN-18~21 完成后，进入测试覆盖率提升阶段
**状态**: 进行中

---

## 一、现状分析

### 1.1 测试统计

| 项目 | 测试数 | 通过 | 跳过 | 备注 |
|------|--------|------|------|------|
| BobCrm.Api.Tests | 518 | 505 | 13 | 跳过项为需真实环境的集成测试 |
| BobCrm.App.Tests | 8 | 8 | 0 | UI 组件测试 |
| BobCrm.Tests | 13 | 13 | 0 | Widget 测试（bUnit） |
| **总计** | **539** | **526** | **13** | |

### 1.2 覆盖率概况

| 指标 | 当前值 | 目标值 |
|------|--------|--------|
| 行覆盖率 | ~2% | >40% |
| 分支覆盖率 | ~0.4% | >30% |
| 测试文件数 | 70 | +15 |

> 注：当前覆盖率数值包含全部源码（含 UI、配置、启动代码），实际业务逻辑覆盖率更高。

### 1.3 测试覆盖分布

#### 已覆盖的关键服务

| 服务 | 测试文件 | 覆盖程度 |
|------|----------|----------|
| CSharpCodeGenerator | CSharpCodeGeneratorTests | 高 |
| DynamicEntityService | DynamicEntityServiceTests | 高 |
| EntityDefinitionAppService | 多个测试文件 | 高 |
| ReflectionPersistenceService | ReflectionPersistenceServiceTests | 高 |
| AggVOCodeGenerator | AggVOCodeGeneratorTests | 高 |
| PostgreSQLDDLGenerator | PostgreSQLDDLGeneratorTests | 高 |
| AccessService | AccessServiceTests, AccessIntegrationTests | 高 |
| TemplateBindingService | TemplateBindingServiceTests | 高 |
| RoslynCompiler | RoslynCompilerTests | 高 |
| AuthEndpoints | AuthTests, AuthBoundaryTests, AuthFlowTests | 高 |

#### 未覆盖/低覆盖的关键服务

| 服务 | 优先级 | 风险等级 | 说明 |
|------|--------|----------|------|
| FieldPermissionService | P1 | 高 | 字段级权限控制，核心安全功能 |
| DataSetService | P2 | 中 | 数据集执行逻辑 |
| AuditService / AuditLogService | P2 | 中 | 审计日志功能 |
| S3FileStorageService | P3 | 低 | 需 Mock S3 |
| SettingsService | P2 | 中 | 系统/用户设置 |
| RoleService | P1 | 高 | 角色管理，权限核心 |
| EntityPublishingService | P1 | 高 | 实体发布流程（部分覆盖） |
| LookupResolveService | P3 | 低 | Lookup 解析 |

---

## 二、改进计划

### 2.1 P1 高优先级（安全/权限相关）

#### P1-001: FieldPermissionService 测试

**目标**: 覆盖字段级权限的核心逻辑

**测试用例**:
- [x] 获取角色字段权限（聚合逻辑）
- [x] 创建/更新字段权限
- [x] 批量设置权限
- [x] 用户权限检查（canRead/canWrite）
- [ ] 可读/可写字段列表获取
- [x] 权限继承逻辑（多角色取最宽松）

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/FieldPermissionServiceTests.cs`

**预计工时**: 4h

---

#### P1-002: RoleService 测试

**目标**: 覆盖角色管理核心逻辑

**测试用例**:
- [x] 角色创建（含 Functions/DataScopes）
- [x] 角色删除（存在 Assignments 时阻止）
- [x] 角色权限分配（FunctionIds + FunctionPermissions 合并）
- [x] 角色数据范围设置（替换逻辑）
- [ ] 用户角色分配

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/RoleServiceTests.cs`

**预计工时**: 3h

---

#### P1-003: EntityPublishingService 补充测试

**目标**: 完善实体发布流程测试

**测试用例**:
- [x] 发布前验证（枚举引用、Lookup 约束）
- [x] 发布回滚（Lock 异常时事务回滚）
- [x] 并发发布处理（二次发布被拒绝）
- [x] 发布状态转换（Draft → Published）
- [x] 撤回流程（Published → Withdrawn）

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/EntityPublishingServiceTests.cs`

**预计工时**: 4h

---

### 2.2 P2 中优先级（业务功能）

#### P2-001: DataSetService 测试

**目标**: 覆盖数据集执行逻辑

**测试用例**:
- [x] 数据集创建/更新/删除
- [x] 数据集执行（带参数）
- [x] 分页处理
- [x] 字段元数据获取

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/DataSetServiceTests.cs`

**预计工时**: 3h

---

#### P2-002: AuditLogService 测试

**目标**: 覆盖审计日志功能

**测试用例**:
- [x] 日志记录（持久化 + DTO 映射）
- [x] 日志查询（分页、过滤）
- [x] 模块列表获取
- [ ] 日志清理策略（当前 AuditLogService 未提供清理接口，后续如新增再补）

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/AuditLogServiceTests.cs`

**预计工时**: 2h

---

#### P2-003: SettingsService 测试

**目标**: 覆盖系统/用户设置逻辑

**测试用例**:
- [x] 系统设置读取/更新
- [x] 用户设置覆盖
- [x] 有效设置计算
- [x] SMTP 配置处理（端口 clamp、密码加密标记）

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/SettingsServiceTests.cs`

**预计工时**: 2h

---

### 2.3 P3 低优先级（辅助功能）

#### P3-001: S3FileStorageService 测试

**目标**: 覆盖文件存储逻辑

**测试用例**:
- [ ] 文件上传（Mock S3）
- [ ] 文件下载
- [ ] 文件删除
- [ ] 预签名 URL 生成

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/S3FileStorageServiceTests.cs`

**预计工时**: 3h

---

#### P3-002: LookupResolveService 测试

**目标**: 覆盖 Lookup 解析逻辑

**测试用例**:
- [ ] 单个 ID 解析
- [ ] 批量 ID 解析
- [ ] 不存在 ID 处理
- [ ] 缓存行为

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/LookupResolveServiceTests.cs`

**预计工时**: 2h

---

#### P3-003: Health Check 测试

**目标**: 覆盖健康检查逻辑

**测试用例**:
- [ ] 数据库连接检查
- [ ] S3 连接检查
- [ ] SMTP 连接检查
- [ ] 磁盘空间检查

**涉及文件**:
- 新增: `tests/BobCrm.Api.Tests/HealthCheckTests.cs`

**预计工时**: 2h

---

## 三、启用跳过的集成测试

### 3.1 当前跳过的测试

| 测试类 | 跳过数 | 原因 |
|--------|--------|------|
| IntegrationTests | 10 | 需真实数据库 |
| AdminEnvironmentTests | 2 | 需开发环境 |
| AdminAndAccessTests | 1 | 需真实数据库 |

### 3.2 启用方案

**方案 A**: Docker 测试容器

使用 Testcontainers 在测试时启动 PostgreSQL 容器：

```csharp
// 示例代码
public class IntegrationTestBase : IAsyncLifetime
{
    private readonly PostgreSqlContainer _postgres = new PostgreSqlBuilder()
        .WithImage("postgres:15-alpine")
        .Build();

    public async Task InitializeAsync()
    {
        await _postgres.StartAsync();
        // 配置连接字符串
    }
}
```

**预计工时**: 8h

**方案 B**: SQLite 内存数据库（备选）

对于不依赖 PostgreSQL 特性的测试，可使用 SQLite 内存数据库：

```csharp
services.AddDbContext<AppDbContext>(options =>
    options.UseSqlite("DataSource=:memory:"));
```

**预计工时**: 4h

---

## 四、里程碑

| 里程碑 | 内容 | 目标覆盖率 | 截止日期 |
|--------|------|------------|----------|
| M1 | P1 测试完成 | >25% | 2026-01-10 |
| M2 | P2 测试完成 | >35% | 2026-01-17 |
| M3 | P3 测试完成 | >40% | 2026-01-24 |
| M4 | 集成测试启用 | >45% | 2026-01-31 |

---

## 五、验收门禁

### 5.1 必跑命令

```powershell
# 运行测试（含覆盖率）
dotnet test --collect:"XPlat Code Coverage" -c Release

# 生成覆盖率报告（需安装 reportgenerator）
reportgenerator -reports:"**/coverage.cobertura.xml" -targetdir:"coverage-html" -reporttypes:Html

# 验证警告基线
pwsh scripts/check-warning-baseline.ps1
```

### 5.2 验收标准

- [ ] 所有新增测试通过
- [ ] 行覆盖率 > 40%
- [ ] 无新增编译警告
- [ ] 测试执行时间 < 120s

---

## 六、资源估算

| 工作项 | 预计工时 |
|--------|----------|
| P1 测试（3 项） | 11h |
| P2 测试（3 项） | 7h |
| P3 测试（3 项） | 7h |
| 集成测试启用 | 8h |
| **总计** | **33h** |

---

## 七、依赖项

### 7.1 NuGet 包

| 包名 | 用途 |
|------|------|
| Testcontainers.PostgreSql | PostgreSQL 测试容器 |
| Moq | Mock 框架（已有） |
| FluentAssertions | 断言库（已有） |

### 7.2 工具

| 工具 | 用途 |
|------|------|
| reportgenerator | 覆盖率报告生成 |
| Docker | 运行测试容器 |

---

## 八、变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2025-12-28 | 初始创建 |
| 1.1 | 2025-12-28 | 完成 P1-001/P1-002：新增 FieldPermissionServiceTests、RoleServiceTests（并修复 RoleService.UpdateRolePermissionsAsync 的持久化逻辑） |
| 1.2 | 2025-12-28 | 完成 P1-003：新增 EntityPublishingServiceTests（覆盖发布前验证/回滚/并发/状态转换/撤回流程），并加强 Lookup 校验（SetNull + NOT NULL） |
| 1.3 | 2025-12-28 | 完成 P2-001/P2-002/P2-003：新增 DataSetServiceTests、AuditLogServiceTests、SettingsServiceTests（覆盖分页/过滤、用户设置合并等关键逻辑） |

---

**计划创建日期**: 2025-12-28
**最后更新日期**: 2025-12-28
