# PLAN-25: 测试覆盖率 90% 冲刺计划

**创建日期**: 2025-12-29
**背景**: PLAN-24 完成后覆盖率达到 81%，距离 90% 目标仍有 9% 差距
**状态**: 待开始
**目标**: BobCrm.Api 行覆盖率 ≥ 90%

---

## 一、现状分析

### 1.1 覆盖率现状

| 指标 | 数值 |
|------|------|
| 当前行覆盖率 | 81.00% |
| 目标覆盖率 | 90.00% |
| 差距 | 9.00% |
| 当前覆盖行数 | 36,868 行 |
| 总代码行数 | 45,467 行 |
| 需新增覆盖 | ~4,052 行 |

### 1.2 各目录覆盖率

| 目录 | 覆盖率 | 状态 | 优先级 |
|------|--------|------|--------|
| Middleware | 90.91% | ✅ 达标 | - |
| Infrastructure | 82.78% | 接近达标 | 低 |
| Abstractions | 81.08% | 接近达标 | 低 |
| Application | 79.88% | 接近达标 | 低 |
| Base | 78.45% | 需提升 | 中 |
| **Services** | **71.92%** | ⚠️ 关键缺口 | **高** |
| Core | 70.09% | ⚠️ 需提升 | 高 |
| **Endpoints** | **65.70%** | ⚠️ 关键缺口 | **高** |

### 1.3 完全未测试的类 (0% 覆盖)

**统计**: 94 个类，共 4,239 行未覆盖代码

| 类别 | 类数量 | 未覆盖行数 |
|------|--------|-----------|
| Migrations (自动生成) | ~10 | 2,348 |
| Services | 42 | 1,089 |
| Contracts/DTOs | 26 | 210 |
| Base Models | 5 | 173 |
| Infrastructure | 5 | 103 |
| Endpoints | 4 | 92 |
| Filters | 1 | 66 |
| Utils | 3 | 57 |

---

## 二、优先级排序 (TOP 20)

### 2.1 极高优先级 (0% 覆盖 + 业务关键)

| 序号 | 文件 | 未覆盖行 | 说明 |
|------|------|----------|------|
| 1 | AggBaseVO.cs | 91 | AggVO 系统核心基类 |
| 2 | AggVOService.cs (4个变体) | 206 | 主从实体 CRUD |
| 3 | TemplateService.cs | 70 | 另一个模板服务 |
| 4 | ViewStateSeeder.cs | 68 | 视图状态初始化 |
| 5 | I18nResourceSynchronizer.cs | 67 | i18n 资源同步 |
| 6 | GlobalExceptionFilter.cs | 66 | 全局异常处理 |
| 7 | AggregateMetadataPublisher.cs | 65 | 聚合元数据发布 |
| 8 | FunctionService.cs (另一个) | 53 | 功能服务变体 |
| 9 | EntityDataSourceHandler.cs | 46 | 实体数据源处理 |

### 2.2 高优先级 (覆盖率 < 30%)

| 序号 | 文件 | 当前覆盖率 | 未覆盖行 |
|------|------|-----------|----------|
| 10 | ReflectionPersistenceService.cs | 8.41% | 98 |
| 11 | DefaultTemplateGenerator.cs | 20.21% | 75 |

### 2.3 中等优先级 (覆盖率 30-70%)

| 序号 | 文件 | 当前覆盖率 | 未覆盖行 |
|------|------|-----------|----------|
| 12 | EntityDefinitionEndpoints.cs | 53.20% | 460 |
| 13 | EntityAggregateEndpoints.cs | 42.17% | 133 |
| 14 | SetupEndpoints.cs | 44.44% | 100 |
| 15 | AdminEndpoints.cs | 65.76% | 164 |
| 16 | SettingsEndpoints.cs | 39.47% | 69 |
| 17 | InMemoryBackgroundJobClient.cs | 36.88% | 77 |

---

## 三、任务分解

### Phase 1: 未测试核心系统 (预计 12h)

#### P1-001: AggVO 系统测试

**目标**: 覆盖 AggVO 主从实体操作

**需测试组件**:
- `AggBaseVO.cs` (91 行)
- `AggVOService.cs` 4个变体 (206 行)
- `AggregateMetadataPublisher.cs` (65 行)

**测试用例**:
- [ ] 主从实体创建（2层结构）
- [ ] 主从实体更新（增删子记录）
- [ ] 主从实体删除（级联）
- [ ] 3层结构操作（主-从-孙）
- [ ] 元数据发布流程

**新增文件**:
- `tests/BobCrm.Api.Tests/AggVOServiceTests.cs`
- `tests/BobCrm.Api.Tests/AggregateMetadataPublisherTests.cs`

**预计工时**: 5h

---

#### P1-002: 全局异常处理测试

**目标**: 覆盖 GlobalExceptionFilter

**测试用例**:
- [ ] 业务异常处理 (BusinessException)
- [ ] 验证异常处理 (ValidationException)
- [ ] 未授权异常处理 (UnauthorizedAccessException)
- [ ] 未知异常处理 (Exception)
- [ ] 异常日志记录

**新增文件**:
- `tests/BobCrm.Api.Tests/GlobalExceptionFilterTests.cs`

**预计工时**: 2h

---

#### P1-003: Seeder 服务测试

**目标**: 覆盖初始化服务

**需测试组件**:
- `ViewStateSeeder.cs` (68 行)
- `I18nResourceSynchronizer.cs` (67 行)

**测试用例**:
- [ ] ViewState 初始化（幂等性）
- [ ] i18n 资源同步（新增/更新/删除）
- [ ] 资源冲突处理

**新增文件**:
- `tests/BobCrm.Api.Tests/ViewStateSeederTests.cs`
- `tests/BobCrm.Api.Tests/I18nResourceSynchronizerTests.cs`

**预计工时**: 3h

---

#### P1-004: 数据源处理测试

**目标**: 覆盖 EntityDataSourceHandler

**测试用例**:
- [ ] 数据源解析
- [ ] 查询构建
- [ ] 参数绑定
- [ ] 错误处理

**新增文件**:
- `tests/BobCrm.Api.Tests/EntityDataSourceHandlerTests.cs`

**预计工时**: 2h

---

### Phase 2: 低覆盖率服务提升 (预计 8h)

#### P2-001: ReflectionPersistenceService 测试

**当前覆盖率**: 8.41% (需覆盖 98 行)

**测试用例**:
- [ ] 动态实体 CRUD 操作
- [ ] 反射属性访问
- [ ] 类型转换
- [ ] 空值处理

**新增文件**:
- `tests/BobCrm.Api.Tests/ReflectionPersistenceServiceTests.cs`

**预计工时**: 4h

---

#### P2-002: DefaultTemplateGenerator 测试

**当前覆盖率**: 20.21% (需覆盖 75 行)

**测试用例**:
- [ ] 默认模板生成（各实体类型）
- [ ] 字段布局计算
- [ ] 异步生成流程
- [ ] 异常情况处理

**新增文件**:
- `tests/BobCrm.Api.Tests/DefaultTemplateGeneratorTests.cs`

**预计工时**: 3h

---

#### P2-003: BackgroundJob 测试

**当前覆盖率**: 36.88% (需覆盖 77 行)

**测试用例**:
- [ ] 作业调度
- [ ] 作业执行
- [ ] 重试机制
- [ ] 失败处理

**新增文件**:
- `tests/BobCrm.Api.Tests/InMemoryBackgroundJobClientTests.cs`

**预计工时**: 1h

---

### Phase 3: 端点层覆盖率提升 (预计 15h)

#### P3-001: EntityDefinitionEndpoints 补充测试

**当前覆盖率**: 53.20% (需覆盖 460 行)

**测试用例**:
- [ ] 字段管理端点（增删改）
- [ ] 接口关联端点
- [ ] 发布流程端点
- [ ] 代码生成端点
- [ ] DDL 预览端点
- [ ] 错误路径测试

**新增文件**:
- `tests/BobCrm.Api.Tests/EntityDefinitionEndpointsAdditionalTests.cs`

**预计工时**: 6h

---

#### P3-002: EntityAggregateEndpoints 测试

**当前覆盖率**: 42.17% (需覆盖 133 行)

**测试用例**:
- [ ] 聚合查询端点
- [ ] 聚合保存端点
- [ ] 聚合删除端点
- [ ] 权限验证

**新增文件**:
- `tests/BobCrm.Api.Tests/EntityAggregateEndpointsTests.cs`

**预计工时**: 3h

---

#### P3-003: SetupEndpoints 测试

**当前覆盖率**: 44.44% (需覆盖 100 行)

**测试用例**:
- [ ] 初始化检查端点
- [ ] 数据库设置端点
- [ ] 管理员创建端点
- [ ] 错误处理

**新增文件**:
- `tests/BobCrm.Api.Tests/SetupEndpointsTests.cs`

**预计工时**: 2h

---

#### P3-004: AdminEndpoints 补充测试

**当前覆盖率**: 65.76% (需覆盖 164 行)

**测试用例**:
- [ ] 系统健康检查
- [ ] 数据库重建（开发环境）
- [ ] 密码重置
- [ ] 错误路径

**新增文件**:
- `tests/BobCrm.Api.Tests/AdminEndpointsAdditionalTests.cs`

**预计工时**: 2h

---

#### P3-005: SettingsEndpoints 测试

**当前覆盖率**: 39.47% (需覆盖 69 行)

**测试用例**:
- [ ] 设置读取
- [ ] 设置更新
- [ ] 设置验证
- [ ] 权限检查

**新增文件**:
- `tests/BobCrm.Api.Tests/SettingsEndpointsTests.cs`

**预计工时**: 2h

---

### Phase 4: 补充覆盖 (预计 5h)

#### P4-001: DTO/Contracts 测试

**目标**: 覆盖 26 个 DTO 类 (210 行)

**测试用例**:
- [ ] 构造函数测试
- [ ] 属性默认值测试
- [ ] 验证属性测试

**预计工时**: 2h

---

#### P4-002: Base Models 测试

**目标**: 覆盖 5 个基类 (173 行)

**测试用例**:
- [ ] 基类属性测试
- [ ] 继承关系测试
- [ ] 接口实现测试

**预计工时**: 2h

---

#### P4-003: Utils 补充测试

**目标**: 覆盖剩余工具类 (57 行)

**预计工时**: 1h

---

## 四、执行计划

### 4.1 阶段目标

| 阶段 | 任务 | 工时 | 预期覆盖行数 | 预期覆盖率 |
|------|------|------|-------------|-----------|
| Phase 1 | 未测试核心系统 | 12h | +1,000 行 | 81% → 83% |
| Phase 2 | 低覆盖率服务 | 8h | +600 行 | 83% → 85% |
| Phase 3 | 端点层提升 | 15h | +1,800 行 | 85% → 89% |
| Phase 4 | 补充覆盖 | 5h | +500 行 | 89% → 90%+ |
| **总计** | - | **40h** | **+3,900 行** | **≥ 90%** |

### 4.2 里程碑

- [ ] **M1**: Phase 1 完成，覆盖率 ≥ 83%
- [ ] **M2**: Phase 2 完成，覆盖率 ≥ 85%
- [ ] **M3**: Phase 3 完成，覆盖率 ≥ 89%
- [ ] **M4**: Phase 4 完成，覆盖率 ≥ 90%

---

## 五、测试策略

### 5.1 测试模式复用

基于 PLAN-24 已建立的测试模式：

```csharp
// 1. InMemoryDatabase 隔离
private static AppDbContext CreateContext()
{
    var options = new DbContextOptionsBuilder<AppDbContext>()
        .UseInMemoryDatabase(Guid.NewGuid().ToString())
        .Options;
    return new AppDbContext(options);
}

// 2. Testable 子类模式（用于难以 Mock 的服务）
internal class TestableXxxService : XxxService
{
    protected override Task ExecuteRealOperation() => Task.CompletedTask;
}

// 3. Mock 依赖注入
var mockService = new Mock<IMyService>();
mockService.Setup(s => s.DoSomething()).ReturnsAsync(expected);
```

### 5.2 端点测试模式

```csharp
// 使用 WebApplicationFactory
public class EndpointTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly HttpClient _client;

    public EndpointTests(WebApplicationFactory<Program> factory)
    {
        _client = factory.CreateClient();
    }
}
```

### 5.3 命名规范

遵循 STD-04:
- 类名: `{被测类名}Tests`
- 方法名: `{方法名}_{场景}_{预期结果}`

---

## 六、验收标准

### 6.1 覆盖率指标

- [ ] BobCrm.Api 行覆盖率 ≥ 90%
- [ ] 分支覆盖率 ≥ 60%
- [ ] 新增测试全部通过

### 6.2 质量要求

- [ ] 遵循 AAA 模式
- [ ] 符合命名规范
- [ ] 包含中文 XML 文档注释
- [ ] 测试边界条件和异常路径

---

## 七、风险与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| AggVO 系统复杂难测 | 高 | 高 | 使用 Testable 子类模式 |
| 端点测试需要完整上下文 | 中 | 中 | 使用 WebApplicationFactory |
| 某些代码不可达 | 低 | 低 | 排除自动生成代码 |
| 测试执行时间过长 | 中 | 低 | 并行执行测试 |

---

## 八、依赖关系

- **PLAN-24**: 已完成，提供 81% 基线覆盖率
- **STD-04**: 定义 90% 覆盖率要求
- **现有测试**: 41 个测试文件，711 个测试用例

---

## 九、预期成果

### 9.1 新增测试文件

| 阶段 | 新增文件数 | 预计测试用例数 |
|------|-----------|---------------|
| Phase 1 | 5 | ~50 |
| Phase 2 | 3 | ~30 |
| Phase 3 | 5 | ~60 |
| Phase 4 | 3 | ~20 |
| **总计** | **16** | **~160** |

### 9.2 最终指标

- 测试文件: 41 + 16 = **57 个**
- 测试用例: 711 + 160 = **~871 个**
- 覆盖率: **≥ 90%**

---

## 十、变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2025-12-29 | 初始创建（基于 PLAN-24 评审结果） |

---

**计划创建日期**: 2025-12-29
**最后更新日期**: 2025-12-29
