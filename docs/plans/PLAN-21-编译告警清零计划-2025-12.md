# PLAN-21: 编译告警清零计划

**创建日期**: 2025-12-28
**背景**: PLAN-20 完成后，warning-baseline.json 剩余 18 条警告
**状态**: 已完成 ✅（warning-baseline = 0）
**完成日期**: 2025-12-28

---

## 一、警告分析总览

### 1.1 统计摘要

| 警告代码 | 数量 | 来源 | 分类 |
|----------|------|------|------|
| BL0006 | 18 | 测试代码 | 第三方框架约束 |
| **总计** | **18** | | |

### 1.2 分类说明

| 分类 | 说明 | 处理策略 |
|------|------|----------|
| 业务代码 | 生产环境代码中的警告 | 必须修复 |
| 测试代码 | 单元测试/集成测试中的警告 | 推荐修复 |
| 第三方 | 引用库产生的警告 | 可忽略或升级 |
| 可忽略 | 误报或无实际影响 | 抑制并记录 |

---

## 二、警告详情

### 2.1 BL0006 警告（18 条）

**警告含义**: `Do not access internal members of RenderTreeBuilder or RenderTreeFrame from application code`

**来源文件**: `src/BobCrm.Tests/Components/Widgets/ButtonWidgetTests.cs`

**问题行分布**:

| 行号 | 列号 | 问题代码 |
|------|------|----------|
| 36 | 22 | `builder.GetFrames().Array` |
| 38 | 13 | `frame.FrameType` |
| 38 | 32 | `RenderTreeFrameType.Component` |
| 39 | 13 | `frame.ComponentType` |
| 108 | 26 | `builder.GetFrames().Array` |
| 110 | 17 | `f.FrameType` |
| 110 | 32 | `RenderTreeFrameType.Attribute` |
| 111 | 17 | `f.AttributeName` |
| 112 | 13 | `typeAttribute.AttributeValue` |
| 128 | 22 | `builder.GetFrames().Array` |
| 130 | 13 | `f.FrameType` |
| 130 | 28 | `RenderTreeFrameType.Attribute` |
| 131 | 13 | `f.AttributeName` |
| 132 | 9 | `disabledAttribute.AttributeValue` |
| 152 | 22 | `builder.GetFrames().Array` |
| 153 | 32 | `f.FrameType` |
| 153 | 47 | `RenderTreeFrameType.Attribute` |
| 154 | 32 | `f.AttributeName` |

**根本原因**:

测试代码直接访问 Blazor 内部 API（`RenderTreeBuilder.GetFrames()` 和 `RenderTreeFrame` 的内部属性），这在 .NET 6+ 中被标记为不推荐使用。

---

## 三、修复方案

### 3.1 推荐方案：重写测试使用 bUnit

**方案概述**：使用 bUnit 测试框架重写 `ButtonWidgetTests.cs`，替代直接访问 RenderTreeBuilder 内部成员。

**优势**：
- 符合 Blazor 官方推荐的测试方式
- 更清晰的测试意图表达
- 更好的可维护性
- 完全消除 BL0006 警告

**涉及文件**：
- `src/BobCrm.Tests/Components/Widgets/ButtonWidgetTests.cs`

**预计工时**: 3h

**修复示例**:

```csharp
// 修改前 - 直接访问内部 API
var frames = builder.GetFrames().Array;
frames.Should().Contain(frame =>
    frame.FrameType == RenderTreeFrameType.Component &&
    frame.ComponentType == typeof(Button));

// 修改后 - 使用 bUnit
using var ctx = new Bunit.TestContext();
var cut = ctx.RenderComponent<ButtonWidget>(parameters => parameters
    .Add(p => p.Label, "Test Button")
    .Add(p => p.Variant, "primary"));

cut.FindComponent<Button>().Should().NotBeNull();
```

### 3.2 备选方案：pragma 抑制

**方案概述**：在测试文件顶部使用 `#pragma warning disable BL0006` 抑制警告。

**优势**：
- 零工时
- 无需修改测试逻辑

**劣势**：
- 不符合 PLAN-20 约定（禁止继续用 `#pragma` 掩盖）
- 技术债务积累

**结论**：**不推荐**

---

## 四、实施计划

### 4.1 任务分解

| 任务 | 描述 | 预计工时 | 验收标准 |
|------|------|----------|----------|
| T1 | 添加 bUnit 包引用 | 0.5h | 项目编译通过 |
| T2 | 重写 `RenderRuntime_Should_Use_AntDesign_Button` 测试 | 0.5h | 测试通过 |
| T3 | 重写 `WithAction_OpenUrl` 测试 | 0.5h | 测试通过 |
| T4 | 重写 `WithAction_Download` 测试 | 0.5h | 测试通过 |
| T5 | 重写 `Variant_Should_Map_To_ButtonType` 测试 | 0.5h | 测试通过 |
| T6 | 重写 `BrowseMode_Should_Disable_Button` 测试 | 0.5h | 测试通过 |
| T7 | 删除 `CreateContext` 和 `HasAttribute` 辅助方法 | 0.25h | 无未使用代码 |
| T8 | 验证并刷新 warning-baseline | 0.25h | 基线降为 0 |

**总工时**: 3.5h

### 4.2 里程碑

| 里程碑 | 内容 | 截止日期 |
|--------|------|----------|
| M1 | BL0006 警告全部消除 | 2025-12-30 |

---

## 五、验收门禁

### 5.1 必跑命令

```powershell
# 构建并检查警告
dotnet build -c Release BobCrm.sln

# 验证警告基线（应为 0）
pwsh scripts/check-warning-baseline.ps1

# 运行测试
dotnet test -c Release
```

### 5.2 验收标准

- [x] `dotnet build -c Release` 无警告（或警告数 = 0）
- [x] `check-warning-baseline.ps1` 通过（基线=0）
- [x] 所有测试通过
- [x] warning-baseline.json 更新为 0 条

---

## 六、风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| bUnit 与现有测试框架不兼容 | 低 | 中 | 验证 bUnit 版本与 .NET 8 兼容性 |
| 测试覆盖范围缩小 | 低 | 低 | 确保新测试覆盖原有场景 |

---

## 七、依赖项

### 7.1 NuGet 包

| 包名 | 版本 | 用途 |
|------|------|------|
| bunit | 1.x | Blazor 组件测试框架 |

### 7.2 前置条件

- PLAN-20 已完成（warning-baseline 降至 18）

---

## 八、变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2025-12-28 | 初始创建 |
| 1.1 | 2025-12-28 | 完成：使用 bUnit 重写 ButtonWidgetTests，warning-baseline 清零并修复脚本对 0 警告的处理 |

---

**计划创建日期**: 2025-12-28
**最后更新日期**: 2025-12-28
