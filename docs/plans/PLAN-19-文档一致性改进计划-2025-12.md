# PLAN-19: 文档一致性改进计划

**创建日期**: 2025-12-27
**基于审查**: `c:\workspace\bobcrm\docs\reviews\REVIEW-16-文档一致性评审-2025-12.md`
**计划执行周期**: 2025-12-27 ~ 2026-01-10
**负责人**: BobCRM 开发团队

---

## 一、计划概要

### 1.1 问题总览

| 优先级 | 问题数 | 预计工时 | 负责人 |
|--------|--------|----------|--------|
| P1 (代码修复) | 2 | 8h | 后端 |
| P2 (文档补充) | 1 | 16h | 全员 |
| P3 (优化建议) | 2 | 4h | 后端 |
| **总计** | **5** | **28h** | BobCRM 开发团队 |

### 1.2 按类别分布

| 类别 | P1 | P2 | P3 | 总计 |
|------|----|----|----|----|
| 代码实现偏差 | 2 | 0 | 1 | 3 |
| 文档缺失 | 0 | 1 | 1 | 2 |

### 1.3 里程碑

| 里程碑 | 目标 | 截止日期 | 状态 |
|--------|------|----------|------|
| M1 | P1 代码问题修复 | 2025-12-30 | ✅ |
| M2 | P2 文档补充（高优先级端点） | 2026-01-05 | ✅ |
| M3 | P3 优化完成 | 2026-01-10 | ⬜ |

---

## 二、P1 问题修复计划

> P1 = 代码与设计文档不一致，需要修复代码以符合设计

### P1-001: 字段 Source 保护未实现

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-16-文档一致性评审-2025-12.md` D16-001
**发现日期**: 2025-12-27
**修复截止**: 2025-12-30

#### 问题描述

ARCH-20 设计要求按字段来源（Source）限制可修改的属性：
- **System 字段**: 仅允许修改 `DisplayName`, `SortOrder`
- **Interface 字段**: 仅允许修改 `DisplayName`, `SortOrder`, `DefaultValue`
- **Custom 字段**: 可修改所有属性

当前实现未检查 Source，所有字段属性均可被修改。

#### 影响范围
- 影响模块：实体定义管理
- 风险等级：中（系统/接口字段可能被误修改）

#### 涉及文件
- `c:\workspace\bobcrm\src\BobCrm.Api\Services\EntityDefinitionAppService.cs:254-268`

#### 修复方案

```csharp
// 在 UpdateEntityDefinitionAsync 方法中，字段更新逻辑前添加 Source 检查
foreach (var fieldDto in dto.Fields.Where(f => f.Id.HasValue))
{
    var existingField = definition.Fields.FirstOrDefault(f => f.Id == fieldDto.Id!.Value);
    if (existingField == null) continue;

    // Source-based protection
    switch (existingField.Source)
    {
        case FieldSource.System:
            // System fields: only DisplayName and SortOrder can be updated
            if (fieldDto.DisplayName != null) existingField.DisplayName = fieldDto.DisplayName;
            if (fieldDto.SortOrder.HasValue) existingField.SortOrder = fieldDto.SortOrder.Value;
            existingField.UpdatedAt = DateTime.UtcNow;
            continue; // Skip other property updates

        case FieldSource.Interface:
            // Interface fields: DisplayName, SortOrder, DefaultValue can be updated
            if (fieldDto.DisplayName != null) existingField.DisplayName = fieldDto.DisplayName;
            if (fieldDto.SortOrder.HasValue) existingField.SortOrder = fieldDto.SortOrder.Value;
            existingField.DefaultValue = fieldDto.DefaultValue;
            existingField.UpdatedAt = DateTime.UtcNow;
            continue; // Skip other property updates

        case FieldSource.Custom:
        default:
            // Custom fields: all properties can be updated (existing logic)
            break;
    }

    // Existing update logic for Custom fields...
}
```

#### 验收标准
- [ ] System 字段仅 DisplayName/SortOrder 可修改，其他属性忽略
- [ ] Interface 字段仅 DisplayName/SortOrder/DefaultValue 可修改
- [ ] Custom 字段所有属性可修改（行为不变）
- [ ] 新增单元测试覆盖三种 Source 类型
- [ ] `dotnet test` 全量通过

#### 状态追踪
| 状态 | 日期 | 备注 |
|------|------|------|
| ✅ 已完成 | 2025-12-27 | commit: `4172d43` |

---

### P1-002: 枚举字段属性未赋值

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-16-文档一致性评审-2025-12.md` D16-002
**发现日期**: 2025-12-27
**修复截止**: 2025-12-30

#### 问题描述

ARCH-26 设计要求当字段 `DataType = Enum` 时，应赋值 `EnumDefinitionId` 和 `IsMultiSelect`。

当前字段创建/更新逻辑未包含这两个属性的处理。

#### 影响范围
- 影响模块：实体定义管理、枚举系统
- 风险等级：中（枚举字段无法正确关联枚举定义）

#### 涉及文件
- `c:\workspace\bobcrm\src\BobCrm.Api\Services\EntityDefinitionAppService.cs:88-106` (创建)
- `c:\workspace\bobcrm\src\BobCrm.Api\Services\EntityDefinitionAppService.cs:275-296` (更新)

#### 修复方案

**创建字段时 (lines 88-106)**:
```csharp
definition.Fields.Add(new FieldMetadata
{
    PropertyName = fieldDto.PropertyName,
    DisplayName = fieldDto.DisplayName,
    DataType = fieldDto.DataType,
    // ... existing properties ...

    // Add enum properties
    EnumDefinitionId = fieldDto.DataType == FieldDataType.Enum ? fieldDto.EnumDefinitionId : null,
    IsMultiSelect = fieldDto.DataType == FieldDataType.Enum && (fieldDto.IsMultiSelect ?? false)
});
```

**更新字段时 (lines 275-296)**:
```csharp
var newField = new FieldMetadata
{
    PropertyName = fieldDto.PropertyName ?? string.Empty,
    // ... existing properties ...

    // Add enum properties
    EnumDefinitionId = fieldDto.DataType == FieldDataType.Enum ? fieldDto.EnumDefinitionId : null,
    IsMultiSelect = fieldDto.DataType == FieldDataType.Enum && (fieldDto.IsMultiSelect ?? false)
};
```

**更新现有字段时**:
```csharp
if (existingField != null)
{
    // ... existing updates ...

    // Update enum properties
    if (fieldDto.DataType == FieldDataType.Enum)
    {
        existingField.EnumDefinitionId = fieldDto.EnumDefinitionId;
        existingField.IsMultiSelect = fieldDto.IsMultiSelect ?? existingField.IsMultiSelect;
    }
    else
    {
        existingField.EnumDefinitionId = null;
        existingField.IsMultiSelect = false;
    }
}
```

#### 验收标准
- [ ] 创建枚举字段时 EnumDefinitionId 正确赋值
- [ ] 创建枚举字段时 IsMultiSelect 正确赋值
- [ ] 更新为枚举类型时属性正确设置
- [ ] 从枚举改为其他类型时属性正确清空
- [ ] 新增集成测试覆盖枚举字段场景
- [ ] `dotnet test` 全量通过

#### 状态追踪
| 状态 | 日期 | 备注 |
|------|------|------|
| ✅ 已完成 | 2025-12-27 | commit: `4172d43` |

---

## 三、P2 问题改进计划

> P2 = 文档缺失，需要补充

### P2-001: API 文档补充

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-16-文档一致性评审-2025-12.md` D16-003
**发现日期**: 2025-12-27
**修复截止**: 2026-01-05

#### 问题描述

API-01-接口文档.md 当前仅覆盖约 35% 的端点（~35/95），缺失约 60 个端点的文档。

#### 涉及文件
- `c:\workspace\bobcrm\docs\reference\API-01-接口文档.md`

#### 补充计划（按优先级分批）

**批次 1：高优先级（12 个端点）** - 截止 2025-12-30

| 模块 | 端点 | 方法 |
|------|------|------|
| 用户管理 | `/api/users` | GET |
| 用户管理 | `/api/users/{id}` | GET |
| 用户管理 | `/api/users` | POST |
| 用户管理 | `/api/users/{id}` | PUT |
| 用户管理 | `/api/users/{id}/roles` | PUT |
| 认证补充 | `/api/auth/me` | GET |
| 认证补充 | `/api/auth/change-password` | POST |
| 设置 | `/api/settings/system` | GET/PUT |
| 设置 | `/api/settings/user` | GET/PUT |
| 初始化 | `/api/setup/admin` | GET/POST |

**批次 2：中优先级（15 个端点）** - 截止 2026-01-03

| 模块 | 端点数 |
|------|--------|
| 系统管理 (audit-logs, jobs, i18n, info) | 9 |
| 组织管理 | 4 |
| SMTP 测试 | 1 |
| Lookup 解析 | 1 |

**批次 3：低优先级（~35 个端点）** - 截止 2026-01-10

| 模块 | 端点数 |
|------|--------|
| 数据集管理 | 6 |
| 字段权限 | 11 |
| 实体聚合 | 5 |
| 管理端点 | 8 |
| 字段操作 | 3 |
| 其他 | 2 |

#### 文档格式要求

每个端点需包含：
```markdown
- 方法：GET/POST/PUT/DELETE `/api/xxx`
- 认证：需要/无
- Query: 参数说明（如有）
- Body: 请求体示例（如有）
- Resp: 响应示例
```

#### 验收标准
- [x] 批次 1 高优先级端点文档完成
- [x] 批次 2 中优先级端点文档完成
- [x] 批次 3 低优先级端点文档完成
- [x] 所有端点包含请求/响应示例
- [x] 文档版本号更新为 v0.4

#### 状态追踪
| 状态 | 日期 | 备注 |
|------|------|------|
| ✅ 已完成 | 2025-12-27 | 全部 3 批次完成（~60 端点） |

---

## 四、P3 问题优化建议

> P3 = 优化建议，可选实施

### P3-001: 接口字段删除异常处理

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-16-文档一致性评审-2025-12.md` D16-004

#### 现状
删除 Interface/System 字段时静默跳过，不返回错误。

#### 优化建议
改为抛出明确异常，告知用户该字段不可删除：

```csharp
if (field.Source == FieldSource.System || field.Source == FieldSource.Interface)
{
    throw new ServiceException(
        _loc.T("ERR_FIELD_PROTECTED_BY_SOURCE", lang),
        ErrorCodes.BusinessRuleViolation
    );
}
```

#### 预期收益
- 用户获得明确反馈
- 避免误认为删除成功

#### 实施复杂度
低

#### 状态
⬜ 备选

---

### P3-002: API 响应示例更新

**来源**: `c:\workspace\bobcrm\docs\reviews\REVIEW-16-文档一致性评审-2025-12.md` D16-005

#### 现状
部分已记录端点的响应示例与实际格式有差异。

#### 优化建议
使用实际 API 响应更新文档中的示例，确保一致性。

可通过以下方式获取最新响应：
```bash
# 启动开发服务器后
curl -X GET http://localhost:5200/api/xxx -H "Authorization: Bearer {token}" | jq
```

#### 预期收益
- 文档与实现保持一致
- 减少开发者困惑

#### 实施复杂度
低

#### 状态
⬜ 备选

---

## 五、文档同步计划

| 问题ID | 需更新文档 | 更新内容 | 状态 |
|--------|------------|----------|------|
| P1-001 | `ARCH-20-实体定义管理设计.md` | 补充实现说明（如有偏差）或确认实现已符合 | ⬜ |
| P1-002 | `ARCH-26-动态枚举系统设计.md` | 确认枚举字段创建流程文档 | ⬜ |
| P2-001 | `API-01-接口文档.md` | 补充 60+ 端点文档 | ⬜ |

---

## 六、测试计划

### 6.1 单元测试

| 问题ID | 需新增测试 | 测试文件 | 状态 |
|--------|------------|----------|------|
| P1-001 | 字段 Source 保护测试 | `EntityDefinitionAppServiceTests.cs` | ⬜ |
| P1-002 | 枚举字段属性赋值测试 | `EntityDefinitionAppServiceTests.cs` | ⬜ |

### 6.2 测试用例

**P1-001 测试场景**:
- [ ] 更新 System 字段的 DisplayName → 成功
- [ ] 更新 System 字段的 DataType → 被忽略
- [ ] 更新 Interface 字段的 DefaultValue → 成功
- [ ] 更新 Interface 字段的 IsRequired → 被忽略
- [ ] 更新 Custom 字段的所有属性 → 成功

**P1-002 测试场景**:
- [ ] 创建 Enum 类型字段并指定 EnumDefinitionId → 正确保存
- [ ] 创建 Enum 类型字段并指定 IsMultiSelect=true → 正确保存
- [ ] 将字段从 String 改为 Enum → EnumDefinitionId 正确赋值
- [ ] 将字段从 Enum 改为 String → EnumDefinitionId 清空

---

## 七、执行进度追踪

### 7.1 每日进度

| 日期 | P1完成 | P2完成 | P3完成 | 备注 |
|------|--------|--------|--------|------|
| 12-27 | 2/2 | 3/3 批次 | /2 | P1+P2 完成（~60端点文档补充） |

### 7.2 问题状态总览

```
P1: ██████████ 100% (2/2)
P2: ██████████ 100% (3/3 批次)
P3: ░░░░░░░░░░ 0% (0/2) [可选]
```

### 7.3 风险和障碍

| 风险/障碍 | 影响 | 缓解措施 | 状态 |
|-----------|------|----------|------|
| P1-001 可能影响现有字段更新行为 | 低 | 仅影响 System/Interface 字段，Custom 字段行为不变 | ⬜ |
| P2-001 文档量大 | 工时超预期 | 分批次完成，优先高频端点 | ⬜ |

---

## 附录

### A. 相关文档

- 评审报告：`c:\workspace\bobcrm\docs\reviews\REVIEW-16-文档一致性评审-2025-12.md`
- 设计文档：`c:\workspace\bobcrm\docs\design\ARCH-20-实体定义管理设计.md`
- 设计文档：`c:\workspace\bobcrm\docs\design\ARCH-26-动态枚举系统设计.md`
- API 文档：`c:\workspace\bobcrm\docs\reference\API-01-接口文档.md`

### B. 变更日志

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2025-12-27 | 初始创建 | Claude Code |
| 1.1 | 2025-12-27 | P2-001 批次1完成：补充12个高优先级端点文档 | Claude Code |
| 1.2 | 2025-12-27 | P2-001 全部完成：补充~60个端点文档，API文档升级至v0.4 | Claude Code |

---

**计划创建日期**: 2025-12-27
**最后更新日期**: 2025-12-27
**下次审查日期**: 2026-01-10
