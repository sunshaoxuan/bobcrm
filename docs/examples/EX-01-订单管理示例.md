# 订单管理系统 - AggVO完整示例

本示例演示如何使用BobCRM的AggVO系统创建一个完整的主子孙三层结构的订单管理系统。

## 业务场景

一个典型的电商订单系统，包含：
- **Order（订单主表）**：订单基本信息
- **OrderLine（订单明细）**：订单中的商品行项
- **OrderLineAttribute（行项属性）**：每个行项的自定义属性（如颜色、尺寸等）

这是一个三层主子孙结构，完美展示了AggVO系统的能力。

## 实体结构

```
Order (主实体)
├── Id: int
├── OrderNo: string (50)
├── CustomerName: string (100)
├── OrderDate: DateTime
├── TotalAmount: decimal (18,2)
├── Status: string (20)
├── Notes: text
└── OrderLines: List<OrderLineAggVO>
    │
    └── OrderLine (子实体 - 本身也是聚合根)
        ├── Id: int
        ├── OrderId: int (外键)
        ├── ProductCode: string (50)
        ├── ProductName: string (200)
        ├── Quantity: int
        ├── UnitPrice: decimal (18,2)
        ├── Subtotal: decimal (18,2)
        └── Attributes: List<OrderLineAttributeVO>
            │
            └── OrderLineAttribute (孙实体)
                ├── Id: int
                ├── OrderLineId: int (外键)
                ├── AttributeKey: string (50)
                ├── AttributeValue: string (200)
```

## 创建步骤

### 步骤1：创建实体定义

通过前端界面或API创建三个实体定义。

#### 1.1 创建Order实体（主实体）

```json
POST /api/entity-definitions

{
  "namespace": "BobCrm.Base.Orders",
  "entityName": "Order",
  "displayNameKey": "ENTITY_ORDER",
  "descriptionKey": "ENTITY_ORDER_DESC",
  "structureType": "MasterDetailGrandchild",
  "interfaces": [
    {
      "interfaceType": "Base",
      "isEnabled": true
    },
    {
      "interfaceType": "Archive",
      "isEnabled": true
    },
    {
      "interfaceType": "Audit",
      "isEnabled": true
    }
  ],
  "fields": [
    {
      "propertyName": "OrderNo",
      "displayNameKey": "FIELD_ORDER_NO",
      "dataType": "String",
      "length": 50,
      "isRequired": true,
      "sortOrder": 1
    },
    {
      "propertyName": "CustomerName",
      "displayNameKey": "FIELD_CUSTOMER_NAME",
      "dataType": "String",
      "length": 100,
      "isRequired": true,
      "sortOrder": 2
    },
    {
      "propertyName": "OrderDate",
      "displayNameKey": "FIELD_ORDER_DATE",
      "dataType": "DateTime",
      "isRequired": true,
      "defaultValue": "NOW",
      "sortOrder": 3
    },
    {
      "propertyName": "TotalAmount",
      "displayNameKey": "FIELD_TOTAL_AMOUNT",
      "dataType": "Decimal",
      "precision": 18,
      "scale": 2,
      "isRequired": true,
      "defaultValue": "0",
      "sortOrder": 4
    },
    {
      "propertyName": "Status",
      "displayNameKey": "FIELD_STATUS",
      "dataType": "String",
      "length": 20,
      "isRequired": true,
      "defaultValue": "Draft",
      "sortOrder": 5
    },
    {
      "propertyName": "Notes",
      "displayNameKey": "FIELD_NOTES",
      "dataType": "Text",
      "isRequired": false,
      "sortOrder": 6
    }
  ]
}
```

#### 1.2 创建OrderLine实体（子实体）

```json
POST /api/entity-definitions

{
  "namespace": "BobCrm.Base.Orders",
  "entityName": "OrderLine",
  "displayNameKey": "ENTITY_ORDER_LINE",
  "descriptionKey": "ENTITY_ORDER_LINE_DESC",
  "structureType": "MasterDetail",
  "interfaces": [
    {
      "interfaceType": "Base",
      "isEnabled": true
    },
    {
      "interfaceType": "Audit",
      "isEnabled": true
    }
  ],
  "fields": [
    {
      "propertyName": "OrderId",
      "displayNameKey": "FIELD_ORDER_ID",
      "dataType": "Integer",
      "isRequired": true,
      "sortOrder": 1
    },
    {
      "propertyName": "ProductCode",
      "displayNameKey": "FIELD_PRODUCT_CODE",
      "dataType": "String",
      "length": 50,
      "isRequired": true,
      "sortOrder": 2
    },
    {
      "propertyName": "ProductName",
      "displayNameKey": "FIELD_PRODUCT_NAME",
      "dataType": "String",
      "length": 200,
      "isRequired": true,
      "sortOrder": 3
    },
    {
      "propertyName": "Quantity",
      "displayNameKey": "FIELD_QUANTITY",
      "dataType": "Integer",
      "isRequired": true,
      "defaultValue": "1",
      "sortOrder": 4
    },
    {
      "propertyName": "UnitPrice",
      "displayNameKey": "FIELD_UNIT_PRICE",
      "dataType": "Decimal",
      "precision": 18,
      "scale": 2,
      "isRequired": true,
      "sortOrder": 5
    },
    {
      "propertyName": "Subtotal",
      "displayNameKey": "FIELD_SUBTOTAL",
      "dataType": "Decimal",
      "precision": 18,
      "scale": 2,
      "isRequired": true,
      "defaultValue": "0",
      "sortOrder": 6
    }
  ]
}
```

#### 1.3 创建OrderLineAttribute实体（孙实体）

```json
POST /api/entity-definitions

{
  "namespace": "BobCrm.Base.Orders",
  "entityName": "OrderLineAttribute",
  "displayNameKey": "ENTITY_ORDER_LINE_ATTRIBUTE",
  "descriptionKey": "ENTITY_ORDER_LINE_ATTRIBUTE_DESC",
  "structureType": "Single",
  "interfaces": [
    {
      "interfaceType": "Base",
      "isEnabled": true
    }
  ],
  "fields": [
    {
      "propertyName": "OrderLineId",
      "displayNameKey": "FIELD_ORDER_LINE_ID",
      "dataType": "Integer",
      "isRequired": true,
      "sortOrder": 1
    },
    {
      "propertyName": "AttributeKey",
      "displayNameKey": "FIELD_ATTRIBUTE_KEY",
      "dataType": "String",
      "length": 50,
      "isRequired": true,
      "sortOrder": 2
    },
    {
      "propertyName": "AttributeValue",
      "displayNameKey": "FIELD_ATTRIBUTE_VALUE",
      "dataType": "String",
      "length": 200,
      "isRequired": true,
      "sortOrder": 3
    }
  ]
}
```

### 步骤2：配置主子表关系

#### 2.1 配置Order -> OrderLine关系

```json
POST /api/entity-advanced/{orderId}/configure-master-detail

{
  "structureType": "MasterDetailGrandchild",
  "children": [
    {
      "childEntityId": "{orderLineId}",
      "foreignKeyField": "OrderId",
      "collectionProperty": "OrderLines",
      "cascadeDeleteBehavior": "Cascade",
      "autoCascadeSave": true
    }
  ]
}
```

#### 2.2 配置OrderLine -> OrderLineAttribute关系

```json
POST /api/entity-advanced/{orderLineId}/configure-master-detail

{
  "structureType": "MasterDetail",
  "children": [
    {
      "childEntityId": "{orderLineAttributeId}",
      "foreignKeyField": "OrderLineId",
      "collectionProperty": "Attributes",
      "cascadeDeleteBehavior": "Cascade",
      "autoCascadeSave": true
    }
  ]
}
```

### 步骤3：生成AggVO代码

#### 3.1 生成Order的AggVO

```http
POST /api/entity-advanced/{orderId}/generate-aggvo
```

返回结果示例：

```csharp
// OrderAggVO.cs
public class OrderAggVO : AggBaseVO
{
    public OrderVO HeadVO { get; set; }
    public List<OrderLineAggVO> OrderLineAggVOs { get; set; }

    public OrderAggVO()
    {
        HeadVO = new OrderVO();
        OrderLineAggVOs = new List<OrderLineAggVO>();
    }

    public override Type GetHeadEntityType() => typeof(Order);

    public override List<Type> GetSubEntityTypes() => new List<Type>
    {
        typeof(OrderLine)
    };

    public override object GetHeadVO() => HeadVO;

    public override void SetHeadVO(object headVO)
    {
        if (headVO is OrderVO vo)
            HeadVO = vo;
    }

    public override async Task<int> SaveAsync()
    {
        // 保存主实体
        var masterService = ServiceLocator.GetService<AggVOService>();
        var orderId = await masterService.SaveHeadAsync(this);

        // 级联保存子实体
        foreach (var lineAggVO in OrderLineAggVOs)
        {
            lineAggVO.HeadVO.OrderId = orderId;
            await lineAggVO.SaveAsync();
        }

        return orderId;
    }

    public override async Task LoadAsync(int id)
    {
        var service = ServiceLocator.GetService<AggVOService>();
        await service.LoadAsync(this, id);
    }

    public override async Task DeleteAsync()
    {
        var service = ServiceLocator.GetService<AggVOService>();
        await service.DeleteAsync(this);
    }
}
```

#### 3.2 生成OrderLine的AggVO

```csharp
// OrderLineAggVO.cs
public class OrderLineAggVO : AggBaseVO
{
    public OrderLineVO HeadVO { get; set; }
    public List<OrderLineAttributeVO> AttributeVOs { get; set; }

    public OrderLineAggVO()
    {
        HeadVO = new OrderLineVO();
        AttributeVOs = new List<OrderLineAttributeVO>();
    }

    public override Type GetHeadEntityType() => typeof(OrderLine);

    public override List<Type> GetSubEntityTypes() => new List<Type>
    {
        typeof(OrderLineAttribute)
    };

    public override object GetHeadVO() => HeadVO;

    public override void SetHeadVO(object headVO)
    {
        if (headVO is OrderLineVO vo)
            HeadVO = vo;
    }

    public override async Task<int> SaveAsync()
    {
        var service = ServiceLocator.GetService<AggVOService>();
        var lineId = await service.SaveHeadAsync(this);

        // 级联保存属性
        foreach (var attr in AttributeVOs)
        {
            attr.OrderLineId = lineId;
            await service.SaveSubAsync(attr);
        }

        return lineId;
    }

    public override async Task LoadAsync(int id)
    {
        var service = ServiceLocator.GetService<AggVOService>();
        await service.LoadAsync(this, id);
    }

    public override async Task DeleteAsync()
    {
        var service = ServiceLocator.GetService<AggVOService>();
        await service.DeleteAsync(this);
    }
}
```

### 步骤4：发布实体

```http
POST /api/entity-definitions/{orderId}/publish
POST /api/entity-definitions/{orderLineId}/publish
POST /api/entity-definitions/{orderLineAttributeId}/publish
```

发布后会：
1. 生成C#代码并编译
2. 动态加载到运行时
3. 执行DDL创建数据库表
4. 注册到EntityMetadata

### 步骤5：使用AggVO保存订单

```csharp
// 创建订单聚合根
var orderAgg = new OrderAggVO
{
    HeadVO = new OrderVO
    {
        OrderNo = "ORD-2025-001",
        CustomerName = "张三",
        OrderDate = DateTime.Now,
        Status = "Draft",
        Notes = "测试订单"
    }
};

// 添加订单行
var line1 = new OrderLineAggVO
{
    HeadVO = new OrderLineVO
    {
        ProductCode = "P001",
        ProductName = "iPhone 15 Pro",
        Quantity = 1,
        UnitPrice = 8999.00m,
        Subtotal = 8999.00m
    }
};

// 添加行项属性
line1.AttributeVOs.Add(new OrderLineAttributeVO
{
    AttributeKey = "Color",
    AttributeValue = "深空黑"
});

line1.AttributeVOs.Add(new OrderLineAttributeVO
{
    AttributeKey = "Storage",
    AttributeValue = "256GB"
});

orderAgg.OrderLineAggVOs.Add(line1);

// 再添加第二个订单行
var line2 = new OrderLineAggVO
{
    HeadVO = new OrderLineVO
    {
        ProductCode = "P002",
        ProductName = "AirPods Pro 2",
        Quantity = 1,
        UnitPrice = 1899.00m,
        Subtotal = 1899.00m
    }
};

line2.AttributeVOs.Add(new OrderLineAttributeVO
{
    AttributeKey = "Color",
    AttributeValue = "白色"
});

orderAgg.OrderLineAggVOs.Add(line2);

// 计算总金额
orderAgg.HeadVO.TotalAmount = orderAgg.OrderLineAggVOs.Sum(l => l.HeadVO.Subtotal);

// 保存整个聚合根（一次性保存所有层级）
var orderId = await orderAgg.SaveAsync();

Console.WriteLine($"订单创建成功，ID: {orderId}");
```

### 步骤6：加载订单

```csharp
// 创建空聚合根
var loadedOrder = new OrderAggVO();

// 加载订单及所有子实体
await loadedOrder.LoadAsync(orderId);

// 访问数据
Console.WriteLine($"订单号: {loadedOrder.HeadVO.OrderNo}");
Console.WriteLine($"客户: {loadedOrder.HeadVO.CustomerName}");
Console.WriteLine($"总金额: {loadedOrder.HeadVO.TotalAmount:C}");

foreach (var line in loadedOrder.OrderLineAggVOs)
{
    Console.WriteLine($"  商品: {line.HeadVO.ProductName}");
    Console.WriteLine($"  数量: {line.HeadVO.Quantity}");
    Console.WriteLine($"  单价: {line.HeadVO.UnitPrice:C}");

    foreach (var attr in line.AttributeVOs)
    {
        Console.WriteLine($"    {attr.AttributeKey}: {attr.AttributeValue}");
    }
}
```

### 步骤7：更新订单

```csharp
// 加载订单
var order = new OrderAggVO();
await order.LoadAsync(orderId);

// 修改订单状态
order.HeadVO.Status = "Confirmed";

// 修改第一个订单行的数量
if (order.OrderLineAggVOs.Any())
{
    order.OrderLineAggVOs[0].HeadVO.Quantity = 2;
    order.OrderLineAggVOs[0].HeadVO.Subtotal =
        order.OrderLineAggVOs[0].HeadVO.UnitPrice * 2;
}

// 重新计算总金额
order.HeadVO.TotalAmount = order.OrderLineAggVOs.Sum(l => l.HeadVO.Subtotal);

// 保存（自动更新所有修改的子实体）
await order.SaveAsync();
```

### 步骤8：删除订单（逻辑删除）

```csharp
// 加载订单
var order = new OrderAggVO();
await order.LoadAsync(orderId);

// 删除订单（会级联逻辑删除所有子实体和孙实体）
await order.DeleteAsync();

// 验证删除
var deletedOrder = new OrderAggVO();
await deletedOrder.LoadAsync(orderId); // 返回null，因为已被逻辑删除
```

## 数据库表结构

发布后自动创建的表：

```sql
-- Orders表
CREATE TABLE "orders" (
    "Id" SERIAL PRIMARY KEY,
    "IsDeleted" BOOLEAN NOT NULL DEFAULT FALSE,
    "DeletedAt" TIMESTAMP WITHOUT TIME ZONE NULL,
    "DeletedBy" VARCHAR(100) NULL,
    "Code" VARCHAR(100) NOT NULL,
    "Name" VARCHAR(200) NOT NULL,
    "OrderNo" VARCHAR(50) NOT NULL,
    "CustomerName" VARCHAR(100) NOT NULL,
    "OrderDate" TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "TotalAmount" NUMERIC(18,2) NOT NULL DEFAULT 0,
    "Status" VARCHAR(20) NOT NULL DEFAULT 'Draft',
    "Notes" TEXT NULL,
    "CreatedAt" TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "CreatedBy" VARCHAR(100) NULL,
    "UpdatedAt" TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "UpdatedBy" VARCHAR(100) NULL,
    "Version" INTEGER NOT NULL DEFAULT 1
);

-- OrderLines表
CREATE TABLE "orderlines" (
    "Id" SERIAL PRIMARY KEY,
    "IsDeleted" BOOLEAN NOT NULL DEFAULT FALSE,
    "DeletedAt" TIMESTAMP WITHOUT TIME ZONE NULL,
    "DeletedBy" VARCHAR(100) NULL,
    "OrderId" INTEGER NOT NULL,
    "ProductCode" VARCHAR(50) NOT NULL,
    "ProductName" VARCHAR(200) NOT NULL,
    "Quantity" INTEGER NOT NULL DEFAULT 1,
    "UnitPrice" NUMERIC(18,2) NOT NULL,
    "Subtotal" NUMERIC(18,2) NOT NULL DEFAULT 0,
    "CreatedAt" TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "CreatedBy" VARCHAR(100) NULL,
    "UpdatedAt" TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "UpdatedBy" VARCHAR(100) NULL,
    "Version" INTEGER NOT NULL DEFAULT 1,
    CONSTRAINT "FK_OrderLines_Orders" FOREIGN KEY ("OrderId")
        REFERENCES "orders"("Id") ON DELETE RESTRICT
);

-- OrderLineAttributes表
CREATE TABLE "orderlineattributes" (
    "Id" SERIAL PRIMARY KEY,
    "IsDeleted" BOOLEAN NOT NULL DEFAULT FALSE,
    "DeletedAt" TIMESTAMP WITHOUT TIME ZONE NULL,
    "DeletedBy" VARCHAR(100) NULL,
    "OrderLineId" INTEGER NOT NULL,
    "AttributeKey" VARCHAR(50) NOT NULL,
    "AttributeValue" VARCHAR(200) NOT NULL,
    CONSTRAINT "FK_OrderLineAttributes_OrderLines" FOREIGN KEY ("OrderLineId")
        REFERENCES "orderlines"("Id") ON DELETE RESTRICT
);

-- 索引
CREATE INDEX "IX_OrderLines_OrderId" ON "orderlines"("OrderId");
CREATE INDEX "IX_OrderLineAttributes_OrderLineId" ON "orderlineattributes"("OrderLineId");
```

## 关键特性演示

### 1. 事务一致性

所有保存操作在一个事务中完成，要么全部成功，要么全部回滚：

```csharp
// 如果保存过程中任何一步失败，整个事务回滚
try
{
    await orderAgg.SaveAsync();
}
catch (Exception ex)
{
    // 整个订单（包括所有行项和属性）都不会保存
    Console.WriteLine($"保存失败: {ex.Message}");
}
```

### 2. 级联删除

根据配置的级联删除行为，自动处理子实体：

```csharp
// 配置为Cascade时，删除订单会自动逻辑删除所有关联的行项和属性
await orderAgg.DeleteAsync();
```

### 3. 版本控制

自动处理并发控制和版本号：

```csharp
// 每次保存自动递增版本号
var version1 = order.HeadVO.Version; // 1
await order.SaveAsync();
var version2 = order.HeadVO.Version; // 2
```

### 4. 审计追踪

自动记录创建和修改信息：

```csharp
Console.WriteLine($"创建时间: {order.HeadVO.CreatedAt}");
Console.WriteLine($"创建人: {order.HeadVO.CreatedBy}");
Console.WriteLine($"最后修改时间: {order.HeadVO.UpdatedAt}");
Console.WriteLine($"最后修改人: {order.HeadVO.UpdatedBy}");
```

### 5. 逻辑删除

所有删除操作都是逻辑删除，数据永不丢失：

```csharp
// 查询时自动过滤已删除记录
var orders = await service.QueryAsync("BobCrm.Base.Orders.Order");
// 不包含IsDeleted=true的记录
```

## API端点

完整的RESTful API自动生成：

```
GET    /api/orders              # 查询订单列表
GET    /api/orders/{id}         # 获取单个订单（含所有子实体）
POST   /api/orders              # 创建订单
PUT    /api/orders/{id}         # 更新订单
DELETE /api/orders/{id}         # 逻辑删除订单

GET    /api/orders/{id}/lines   # 获取订单的所有行项
POST   /api/orders/{id}/lines   # 为订单添加行项

GET    /api/orderlines/{id}/attributes    # 获取行项的所有属性
POST   /api/orderlines/{id}/attributes    # 为行项添加属性
```

## 前端集成

### Blazor组件示例

```razor
@page "/orders/create"
@inject AggVOService AggVOService

<h3>创建订单</h3>

<EditForm Model="@orderAgg" OnValidSubmit="HandleSubmit">
    <div class="form-group">
        <label>订单号：</label>
        <InputText @bind-Value="orderAgg.HeadVO.OrderNo" class="form-control" />
    </div>

    <div class="form-group">
        <label>客户名称：</label>
        <InputText @bind-Value="orderAgg.HeadVO.CustomerName" class="form-control" />
    </div>

    <h4>订单行项</h4>
    @foreach (var line in orderAgg.OrderLineAggVOs)
    {
        <div class="order-line">
            <InputText @bind-Value="line.HeadVO.ProductCode" placeholder="商品编码" />
            <InputText @bind-Value="line.HeadVO.ProductName" placeholder="商品名称" />
            <InputNumber @bind-Value="line.HeadVO.Quantity" placeholder="数量" />
            <InputNumber @bind-Value="line.HeadVO.UnitPrice" placeholder="单价" />

            <button type="button" @onclick="() => AddAttribute(line)">添加属性</button>

            @foreach (var attr in line.AttributeVOs)
            {
                <div class="attribute">
                    <InputText @bind-Value="attr.AttributeKey" placeholder="属性名" />
                    <InputText @bind-Value="attr.AttributeValue" placeholder="属性值" />
                </div>
            }
        </div>
    }

    <button type="button" @onclick="AddOrderLine">添加行项</button>
    <button type="submit">保存订单</button>
</EditForm>

@code {
    private OrderAggVO orderAgg = new OrderAggVO();

    private void AddOrderLine()
    {
        orderAgg.OrderLineAggVOs.Add(new OrderLineAggVO());
    }

    private void AddAttribute(OrderLineAggVO line)
    {
        line.AttributeVOs.Add(new OrderLineAttributeVO());
    }

    private async Task HandleSubmit()
    {
        await orderAgg.SaveAsync();
        // 导航到订单列表
    }
}
```

## 总结

这个示例完整展示了AggVO系统的核心能力：
1. ✅ 三层主子孙结构
2. ✅ 自动级联保存
3. ✅ 自动级联删除（逻辑）
4. ✅ 事务一致性
5. ✅ 版本控制
6. ✅ 审计追踪
7. ✅ 动态代码生成
8. ✅ RESTful API
9. ✅ 前端集成

通过这个示例，您可以快速理解并使用BobCRM的AggVO系统构建复杂的业务场景。
