# ARCH-24: 紧凑型顶部菜单导航设计

> **创建日期**: 2025-11-13
> **状态**: 草案
> **相关文档**: [ARCH-23-功能体系规划](./ARCH-23-功能体系规划.md)

---

## 1. 背景与目标

### 1.1 现状问题

当前 BobCRM 采用左侧固定导航栏布局：
- **左侧 Rail**：显示领域（Domain）一级菜单图标
- **左侧内容区域**：展开显示当前领域的二、三级菜单模块和功能
- **占用空间大**：左侧导航栏固定占用约 200-300px 宽度，在笔记本或小屏幕上空间局促
- **信息密度低**：大量页面实际不需要持续显示菜单，但菜单始终占用空间

### 1.2 设计目标

参考业界成熟产品（如截图所示的 One人事 等系统），实现紧凑型顶部菜单导航：

1. **最大化内容区域**：移除左侧固定导航栏，将菜单折叠到顶部
2. **按需显示**：仅在需要导航时展开菜单，默认隐藏以节省空间
3. **保持三级结构**：领域（Domain）→ 模块（Module）→ 功能（Function）
4. **响应式友好**：在移动端和桌面端都有良好体验
5. **权限联动**：继续基于用户权限动态显示菜单项

---

## 2. 设计方案

### 2.1 整体布局结构

```
┌─────────────────────────────────────────────────────────┐
│  [Logo] [Domain Selector ▼] [User] [Settings] [Theme]  │ ← App Header
├─────────────────────────────────────────────────────────┤
│                                                         │
│                   Page Content Area                     │
│              (Full Width, No Side Nav)                  │
│                                                         │
└─────────────────────────────────────────────────────────┘

点击 Domain Selector 时展开下拉菜单：

┌─────────────────────────────────────────────────────────┐
│  [Logo] [系统管理 ▼] [User] [Settings] [Theme]          │
├─────────────────────────────────────────────────────────┤
│  ┌────────────────────┐                                 │
│  │ 系统管理           │                                 │
│  │ ─────────────────  │                                 │
│  │ [图标] 系统设置    │                                 │
│  │ [图标] 邮件与消息  │                                 │
│  │ [图标] 实体管理    │                                 │
│  │ [图标] 模板管理    │                                 │
│  └────────────────────┘                                 │
│                                                         │
│                   Page Content Area                     │
└─────────────────────────────────────────────────────────┘
```

### 2.2 领域切换器（Domain Selector）

#### 2.2.1 默认状态
- 位置：Header 左侧，Logo 右侧
- 样式：类似下拉按钮，显示当前选中的领域名称
- 格式：`[Icon] 领域名称 [下箭头]`
- 示例：`[🏢] 基本设置 ▼`

#### 2.2.2 展开状态
点击领域切换器后，显示领域列表 Popover：

```
┌───────────────────────┐
│ 系统管理       [图标]  │ ← 领域1
│ 基本设置       [图标]  │ ← 领域2（当前选中，高亮）
│ 客户关系       [图标]  │ ← 领域3
│ 工作协作       [图标]  │ ← 领域4
└───────────────────────┘
```

**交互逻辑**：
1. 点击领域项 → 切换到该领域，关闭 Popover
2. 如果当前页面不属于该领域 → 自动导航到该领域的第一个可用功能页面
3. 支持键盘导航（上下箭头、Enter 确认、Esc 关闭）

### 2.3 二级、三级菜单展开

#### 2.3.1 触发方式
有两种触发方式展开当前领域的二、三级菜单：

**方式一：再次点击领域切换器**
- 如果当前已选中某个领域，再次点击 → 展开该领域的完整菜单

**方式二：独立的菜单图标按钮**
- 在 Header 上增加一个 "菜单" 图标按钮（📋 或 ≡）
- 点击后展开当前领域的二、三级菜单

**推荐：方式一** - 减少 Header 按钮数量，保持简洁

#### 2.3.2 菜单面板布局

展开的菜单面板覆盖在内容区域上方（类似 Ant Design Drawer 或 Popover）：

```
┌─────────────────────────────────────────────────────────┐
│  [Logo] [系统管理 ▼] [User] [Settings]                  │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────┐        │
│  │  [返回领域列表]          系统管理           │        │
│  │  ─────────────────────────────────────────  │        │
│  │  自分の勤怠 (我的数据)                     │        │
│  │  ┌──────┐ ┌──────┐ ┌──────┐               │        │
│  │  │[图标]│ │[图标]│ │[图标]│               │        │
│  │  │ 打刻 │ │ 勤務表│ │工数実績│              │        │
│  │  └──────┘ └──────┘ └──────┘               │        │
│  │                                            │        │
│  │  従業員の勤怠 (员工管理)                  │        │
│  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐    │        │
│  │  │[图标]│ │[图标]│ │[图标]│ │[图标]│    │        │
│  │  │従業員│ │申請一│ │日次   │ │月次   │    │        │
│  │  │一覧  │ │覧    │ │データ │ │データ │    │        │
│  │  └──────┘ └──────┘ └──────┘ └──────┘    │        │
│  │                                            │        │
│  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐    │        │
│  │  │[图标]│ │[图标]│ │[图标]│ │[图标]│    │        │
│  │  │勤務予│ │エラー│ │データ│ │36協定│    │        │
│  │  │定管理│ │照会  │ │入力  │      │    │        │
│  │  └──────┘ └──────┘ └──────┘ └──────┘    │        │
│  │                                            │        │
│  │  ... (其他模块)                           │        │
│  └─────────────────────────────────────────────┘        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**面板特性**：
1. **位置**：从 Header 下方展开，覆盖在内容区域上方
2. **宽度**：占满整个视口宽度，或限制最大宽度（如 1200px）居中
3. **高度**：根据内容自适应，最大不超过视口高度的 80%，超出则滚动
4. **背景**：半透明遮罩（mask）覆盖内容区域，点击遮罩关闭菜单
5. **关闭方式**：
   - 点击菜单项 → 导航到目标页面并关闭菜单
   - 点击遮罩区域 → 关闭菜单
   - 按 ESC 键 → 关闭菜单
   - 点击 Header 上的关闭按钮（可选）

#### 2.3.3 菜单内容组织

**模块分组**：
- 二级节点（Module）作为分组标题
- 三级节点（Function）以卡片形式平铺在模块下方

**卡片样式**：
```
┌─────────────┐
│   [图标]     │
│             │
│  功能名称    │
└─────────────┘
```

- 尺寸：约 100-120px 宽，80-100px 高
- 布局：响应式网格，自动换行
- 状态：
  - 默认：浅色背景
  - 悬停：高亮背景
  - 当前页面：蓝色边框或背景
  - 禁用：灰色且不可点击

### 2.4 快捷方式功能（未来扩展）

参考截图中的"自分の勤怠"区域，支持用户自定义常用功能快捷方式：

**位置**：菜单面板顶部单独区域
**交互**：
1. 初始为空，显示"添加常用功能"提示
2. 用户可从完整菜单中拖拽或点击"收藏"按钮添加
3. 支持排序和删除
4. 存储在用户偏好设置中

**本次设计暂不实现**，预留扩展空间。

---

## 3. 技术实现要点

### 3.1 组件结构

```
AppHeader.razor
  ├── Logo
  ├── DomainSelector         ← 新增组件
  │   ├── DomainButton       (显示当前领域，可点击)
  │   └── DomainPopover      (领域列表)
  ├── MenuPanel              ← 新增组件
  │   ├── QuickAccess        (快捷方式，未来)
  │   ├── ModuleGroups       (模块分组)
  │   └── FunctionCards      (功能卡片)
  ├── UserMenu
  ├── ThemeToggle
  └── SettingsIcon

MainLayout.razor
  ├── AppHeader              (整合上述组件)
  └── PageContent            (移除左侧 Rail 和 Sider)
```

### 3.2 状态管理

在 `LayoutState` 服务中新增：

```csharp
public class LayoutState
{
    public bool IsMenuPanelOpen { get; private set; }
    public bool IsDomainPopoverOpen { get; private set; }
    public string? CurrentDomainCode { get; private set; }

    public void ToggleMenuPanel();
    public void OpenMenuPanel();
    public void CloseMenuPanel();
    public void ToggleDomainPopover();
    public void SetCurrentDomain(string? code);
}
```

### 3.3 CSS 关键类

```css
/* 领域切换器 */
.domain-selector { }
.domain-button { }
.domain-popover { }

/* 菜单面板 */
.menu-panel-overlay { }  /* 遮罩 */
.menu-panel { }           /* 面板容器 */
.menu-panel-header { }    /* 面板头部 */
.menu-panel-body { }      /* 面板内容 */

/* 模块分组 */
.module-group { }
.module-group-title { }

/* 功能卡片 */
.function-cards { }
.function-card { }
.function-card-icon { }
.function-card-label { }
```

### 3.4 响应式策略

#### 桌面端（>= 1024px）
- 菜单面板宽度：占满或最大 1200px 居中
- 功能卡片：每行 6-8 个

#### 平板端（768px - 1023px）
- 菜单面板宽度：占满
- 功能卡片：每行 4-6 个

#### 移动端（< 768px）
- 菜单面板宽度：占满
- 功能卡片：每行 3-4 个
- 领域切换器：简化显示，只显示名称

---

## 4. 实现步骤规划

### 阶段一：基础结构（必需）
1. 创建 `DomainSelector` 组件
2. 实现领域列表 Popover
3. 创建 `MenuPanel` 组件基本框架
4. 更新 `LayoutState` 状态管理
5. 移除 MainLayout 中的左侧 Rail 和 Sider

### 阶段二：菜单面板内容（必需）
1. 实现模块分组渲染
2. 实现功能卡片网格布局
3. 添加菜单展开/关闭动画
4. 实现点击导航和关闭逻辑
5. 键盘导航支持（ESC 关闭）

### 阶段三：样式与交互（必需）
1. 实现 CSS 样式
2. 当前页面高亮
3. 响应式布局适配
4. 遮罩点击关闭
5. 滚动优化（菜单内滚动）

### 阶段四：优化与扩展（可选）
1. 添加菜单面板头部"返回领域列表"按钮
2. 快捷方式功能预留
3. 菜单搜索功能
4. 动画性能优化
5. 多语言完善

---

## 5. 数据流与权限

### 5.1 数据来源
- 菜单数据：继续使用 `/api/access/functions/me` 获取用户权限内的功能树
- 领域（Domain）：FunctionTree 第一级子节点，`ParentCode = "APP.ROOT"`
- 模块（Module）：领域的子节点
- 功能（Function）：模块的子节点或孙节点（递归展平）

### 5.2 权限过滤
- 后端返回的功能树已经过权限过滤
- 前端只需渲染有 `Route` 的叶子节点
- 空模块（无任何可访问功能）不显示

### 5.3 路由联动
- 当前路由匹配 → 高亮对应功能卡片
- 当前路由所属领域 → 领域切换器显示该领域名称
- 切换领域时无匹配路由 → 导航到该领域第一个可用功能

---

## 6. 与现有设计的对比

| 特性 | 现有设计（左侧导航） | 新设计（顶部菜单） |
|------|---------------------|-------------------|
| 内容区域宽度 | 约 70-80% | 100% |
| 菜单可见性 | 始终可见 | 按需展开 |
| 空间利用率 | 低 | 高 |
| 菜单层级展示 | 树形列表 | 卡片网格 |
| 移动端友好 | 需要折叠处理 | 天然适配 |
| 用户熟悉度 | 传统布局 | 现代化趋势 |

---

## 7. 注意事项

### 7.1 用户习惯迁移
- 首次使用时，可显示引导提示："点击顶部领域名称可展开菜单"
- 在设置中提供"布局偏好"选项（未来可支持切换回左侧导航）

### 7.2 性能考虑
- 菜单面板按需渲染，关闭时卸载 DOM
- 功能卡片数量多时（>50），考虑虚拟滚动
- 动画使用 CSS Transform，避免重排

### 7.3 可访问性
- 键盘导航支持（Tab、Enter、ESC、Arrow Keys）
- ARIA 标签完善（role="menu", aria-expanded, aria-current）
- 焦点管理（打开菜单时聚焦第一个项，关闭时返回触发按钮）

---

## 8. 设计验收标准

### 功能验收
- [ ] 领域切换器正确显示当前领域
- [ ] 点击领域切换器可展开领域列表
- [ ] 选择领域后正确切换并导航
- [ ] 再次点击（或独立菜单按钮）展开二、三级菜单面板
- [ ] 菜单面板显示所有有权限的模块和功能
- [ ] 点击功能卡片正确导航到目标页面
- [ ] 当前页面对应的功能卡片高亮显示
- [ ] 点击遮罩或按 ESC 关闭菜单

### 样式验收
- [ ] 布局在桌面端/平板端/移动端正确响应
- [ ] 功能卡片网格自动换行
- [ ] 动画流畅，无卡顿
- [ ] 主题切换时样式正确（Light/Dark）

### 性能验收
- [ ] 菜单展开时间 < 300ms
- [ ] 大量功能时（>50）滚动流畅
- [ ] 内存无泄漏（打开关闭多次后无增长）

---

## 9. 未来扩展方向

1. **个性化快捷方式**：用户自定义常用功能，拖拽排序
2. **菜单搜索**：在菜单面板顶部增加搜索框，快速过滤功能
3. **最近访问**：记录用户最近访问的 5-10 个功能，优先展示
4. **多工作区**：支持多个"工作区"（Workspace），每个工作区有独立的菜单配置
5. **布局切换**：用户可在设置中选择"顶部菜单"或"左侧导航"布局偏好

---

## 10. 参考资料

- 参考产品：One人事、钉钉、飞书等 SaaS 产品的顶部导航设计
- Ant Design Popover: https://ant.design/components/popover/
- Ant Design Drawer: https://ant.design/components/drawer/
- Material Design Navigation Drawer: https://m3.material.io/components/navigation-drawer/overview

---

**审核人**: _待定_
**审核日期**: _待定_
**状态**: 草案 → 待审核 → 已批准 → 实现中 → 已完成
