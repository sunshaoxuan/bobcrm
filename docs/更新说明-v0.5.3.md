# BobCRM æ›´æ–°è¯´æ˜ v0.5.3

**å‘å¸ƒæ—¥æœŸ**ï¼š2025-11-05  
**ç‰ˆæœ¬**ï¼šv0.5.3  
**ä¸»é¢˜**ï¼šå®ä½“å…ƒæ•°æ®è§„èŒƒåŒ– + é€šç”¨å®ä½“é€‰æ‹©å™¨ç»„ä»¶

---

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### 1. EntityMetadata ç»“æ„è§„èŒƒåŒ–

**é—®é¢˜**ï¼šä¹‹å‰çš„ EntityMetadata ç¼ºå°‘ç±»å…¨åï¼Œæ— æ³•å‡†ç¡®è¿›è¡Œåå‘æ£€æŸ¥ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **EntityType**ï¼ˆä¸»é”®ï¼‰ï¼šå­˜å‚¨ç±»çš„å…¨åï¼ˆå¦‚ `BobCrm.Api.Domain.Customer`ï¼‰
  - ç”¨é€”ï¼šåå°„æŸ¥æ‰¾ç±»ã€ç²¾ç¡®å®šä½
- **EntityName**ï¼ˆæ–°å¢ï¼‰ï¼šå­˜å‚¨ç±»çš„çŸ­åï¼ˆå¦‚ `Customer`ï¼‰
  - ç”¨é€”ï¼šæ—¥å¿—è¾“å‡ºã€UIæ˜¾ç¤º
- **EntityRoute**ï¼ˆæ–°å¢ï¼‰ï¼šå­˜å‚¨URLè·¯ç”±åï¼ˆå¦‚ `customer`ï¼‰
  - ç”¨é€”ï¼šå‰ç«¯è·¯ç”±ã€APIç«¯ç‚¹æ„å»º

**æ•°æ®åº“ç»“æ„**ï¼š
```csharp
public class EntityMetadata
{
    public string EntityType { get; set; }    // PK: BobCrm.Api.Domain.Customer
    public string EntityName { get; set; }    // Customer
    public string EntityRoute { get; set; }   // customer
    public string DisplayNameKey { get; set; } // ENTITY_CUSTOMER
    public string? DescriptionKey { get; set; }
    public string? ApiEndpoint { get; set; }   // /api/customers
    public string? Icon { get; set; }
    public string? Category { get; set; }
    public bool IsRootEntity { get; set; }
    public bool IsEnabled { get; set; }
    public int Order { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
}
```

**ç¤ºä¾‹ï¼ˆCustomer.GetMetadata()ï¼‰**ï¼š
```csharp
public static EntityMetadata GetMetadata()
{
    var type = typeof(Customer);
    return new EntityMetadata
    {
        EntityType = type.FullName ?? "BobCrm.Api.Domain.Customer",
        EntityName = type.Name,
        EntityRoute = "customer",
        DisplayNameKey = "ENTITY_CUSTOMER",
        DescriptionKey = "ENTITY_CUSTOMER_DESC",
        ApiEndpoint = "/api/customers",
        IsRootEntity = true,
        IsEnabled = true,
        Order = 1,
        Icon = "user",
        Category = "core"
    };
}
```

---

### 2. é€šç”¨å®ä½“é€‰æ‹©å™¨ç»„ä»¶ï¼ˆEntitySelectorï¼‰

**é—®é¢˜**ï¼šAntDesign Select ç»„ä»¶åœ¨åŠ¨æ€é€‰é¡¹åŠ è½½å’Œæ¸²æŸ“æ—¶å­˜åœ¨è¯¸å¤šé—®é¢˜ï¼Œå°è¯•äº†å¤šç§æ–¹æ¡ˆå‡æ— æ³•ç¨³å®šæ˜¾ç¤ºé€‰é¡¹ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»ºé€šç”¨çš„ EntitySelector ç»„ä»¶ï¼Œä½¿ç”¨ Modal å¼¹å‡ºæ¡†ä»£æ›¿ä¸‹æ‹‰æ¡†ã€‚

**ç»„ä»¶ç‰¹æ€§**ï¼š
- ğŸ“¦ **æ³›å‹æ”¯æŒ**ï¼š`<EntitySelector TEntity="T">`ï¼Œå¯ç”¨äºä»»ä½•å®ä½“ç±»å‹
- ğŸ¨ **ç”¨æˆ·å‹å¥½ç•Œé¢**ï¼šè¾“å…¥æ¡† + æ”¾å¤§é•œå›¾æ ‡ï¼Œç¬¦åˆç”¨æˆ·æŸ¥æ‰¾ä¹ æƒ¯
- ğŸš€ **æ‡’åŠ è½½**ï¼šé¦–æ¬¡ç‚¹å‡»æ—¶æ‰åŠ è½½æ•°æ®ï¼Œé¿å…ä¸å¿…è¦çš„APIè°ƒç”¨
- ğŸ” **æœç´¢è¿‡æ»¤**ï¼šæ•°æ®è¶…è¿‡5æ¡æ—¶è‡ªåŠ¨æ˜¾ç¤ºæœç´¢æ¡†
- ğŸ¯ **è‡ªå®šä¹‰æ¸²æŸ“**ï¼šæ”¯æŒè‡ªå®šä¹‰å›¾æ ‡ã€æ ‡é¢˜ã€æè¿°ã€å…ƒæ•°æ®æ˜¾ç¤º
- âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜å·²åŠ è½½æ•°æ®ï¼Œä¸é‡å¤è¯·æ±‚
- ğŸ›¡ï¸ **é”™è¯¯å¤„ç†**ï¼šåŠ è½½å¤±è´¥æ˜¾ç¤ºé‡è¯•æŒ‰é’®

**æ¥å£çº¦æŸï¼ˆISelectableEntityï¼‰**ï¼š
```csharp
public interface ISelectableEntity
{
    string Value { get; }         // å”¯ä¸€æ ‡è¯†
    string DisplayName { get; }   // æ˜¾ç¤ºåç§°ï¼ˆå·²ç¿»è¯‘ï¼‰
    string? Description { get; }  // æè¿°ï¼ˆå·²ç¿»è¯‘ï¼‰
    string? Icon { get; }        // å›¾æ ‡
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```razor
<EntitySelector TEntity="EntityTypeItem"
                @bind-Value="entityType"
                Title="@I18n.T("LBL_SELECT_ENTITY_TYPE")"
                Placeholder="@I18n.T("LBL_CLICK_TO_SELECT_ENTITY")"
                DataLoader="LoadEntitiesMethod"
                ValueGetter="@(e => e.EntityType)"
                DisplayTextGetter="@(e => e.DisplayName)"
                EnableSearch="true">
    <TitleRenderer>@context.DisplayName</TitleRenderer>
    <DescriptionRenderer>@context.Description</DescriptionRenderer>
    <IconRenderer>
        <Icon Type="@context.Icon" Style="font-size:28px; color:#1890ff" />
    </IconRenderer>
    <MetadataRenderer>
        <Tag Color="blue">@context.EntityName</Tag>
        <Tag Color="default">@context.ApiEndpoint</Tag>
    </MetadataRenderer>
</EntitySelector>
```

**æ•ˆæœå›¾æè¿°**ï¼š
- è¾“å…¥æ¡†æ˜¾ç¤ºå·²é€‰æ‹©çš„å®ä½“åç§°ï¼ˆç¿»è¯‘åï¼Œå¦‚"é¡§å®¢"ï¼‰
- ç‚¹å‡»æ”¾å¤§é•œå›¾æ ‡æ‰“å¼€Modal
- Modalä¸­æ˜¾ç¤ºå¡ç‰‡å¼åˆ—è¡¨ï¼Œæ¯ä¸ªå®ä½“åŒ…å«ï¼šå›¾æ ‡ã€åç§°ã€æè¿°ã€æŠ€æœ¯ä¿¡æ¯
- é¼ æ ‡æ‚¬åœæ•ˆæœï¼Œç‚¹å‡»é€‰æ‹©åè‡ªåŠ¨å…³é—­

---

### 3. å…¨å±€å¸ƒå±€æ»šåŠ¨æ¡ä¿®å¤

**é—®é¢˜**ï¼š
- æ‰€æœ‰é¡µé¢éƒ½å‡ºç°å‚ç›´æ»šåŠ¨æ¡
- FormDesignerç­‰å…¨å±é¡µé¢ä¹Ÿæœ‰ä¸å¿…è¦çš„æ»šåŠ¨æ¡

**æ ¹æœ¬åŸå› **ï¼š
- `html/body` æœªé™åˆ¶é«˜åº¦å’Œoverflow
- `.app-shell` ä½¿ç”¨ `min-height: 100vh`ï¼Œå¯èƒ½è¶…å‡ºè§†å£
- `.app-content` æœªè®¾ç½®ä¸ºç‹¬ç«‹æ»šåŠ¨åŒºåŸŸ

**è§£å†³æ–¹æ¡ˆï¼ˆtheme.cssï¼‰**ï¼š
```css
/* å…¨å±€æ ·å¼ï¼šé˜²æ­¢ html/body äº§ç”Ÿæ»šåŠ¨æ¡ */
html, body {
  height: 100%;
  overflow: hidden;
  margin: 0;
  padding: 0;
}

/* App shell - å›ºå®šé«˜åº¦ï¼Œé˜²æ­¢é¡µé¢æ»šåŠ¨ */
.app-shell { 
  height: 100vh; 
  overflow: hidden; 
  display: flex; 
}

/* App Main - ä¸æ»šåŠ¨ */
.app-main { 
  flex: 1; 
  display: flex; 
  flex-direction: column; 
  overflow: hidden; 
}

/* App Content - ç‹¬ç«‹æ»šåŠ¨åŒºåŸŸ */
.app-content { 
  padding: 16px; 
  flex: 1; 
  overflow-y: auto; 
}
```

**å¸ƒå±€ç»“æ„ï¼ˆç¬¦åˆè®¾è®¡å™¨è§„èŒƒï¼‰**ï¼š
- âŒ é¡µé¢æ•´ä½“ï¼šä¸æ»šåŠ¨
- âœ… ä¾§è¾¹æ å®¢æˆ·åˆ—è¡¨ï¼šç‹¬ç«‹æ»šåŠ¨
- âœ… ä¸»å†…å®¹åŒºåŸŸï¼šç‹¬ç«‹æ»šåŠ¨
- âœ… FormDesigner ä¸‰ä¸ªé¢æ¿ï¼šå„è‡ªç‹¬ç«‹æ»šåŠ¨
  - å·¦ä¾§å·¥å…·æ ï¼š`overflow-y: auto`
  - ä¸­é—´ç”»å¸ƒï¼š`overflow: auto`
  - å³ä¾§å±æ€§æ ï¼š`overflow-y: auto`

---

### 4. FormDesigner å®ä½“ç±»å‹é€‰æ‹©ä¼˜åŒ–

**æ”¹è¿›ç‚¹**ï¼š
- ä½¿ç”¨ EntitySelector æ›¿ä»£ä¸‹æ‹‰æ¡†
- æ•°æ®åŠ è½½æ—¶è‡ªåŠ¨ç¿»è¯‘ DisplayNameKey â†’ DisplayName
- è¾“å…¥æ¡†ç›´æ¥æ˜¾ç¤ºç¿»è¯‘åçš„åç§°ï¼ˆå¦‚"é¡§å®¢"è€Œé"customer"ï¼‰
- å·²æœ‰ç»„ä»¶çš„æ¨¡æ¿é”å®šå®ä½“ç±»å‹ï¼Œé˜²æ­¢è¯¯ä¿®æ”¹

**ä¸šåŠ¡é€»è¾‘è§„èŒƒ**ï¼š
1. **æ–°å»ºæ¨¡æ¿**ï¼š
   - entityType ä¸ºç©º
   - å…è®¸é€šè¿‡ EntitySelector é€‰æ‹©å®ä½“ç±»å‹
   - é€‰æ‹©åå³é”å®šï¼ˆæ·»åŠ ç»„ä»¶åï¼‰

2. **ç¼–è¾‘å·²æœ‰æ¨¡æ¿**ï¼š
   - ä» TemplateId è§£æ entityType
   - å¦‚æœå·²æœ‰ç»„ä»¶ï¼Œé”å®šå®ä½“ç±»å‹ï¼ˆæ˜¾ç¤ºç¦ç”¨è¾“å…¥æ¡† + é”å®šæç¤ºï¼‰
   - é˜²æ­¢ä¿®æ”¹å®ä½“ç±»å‹å¯¼è‡´æ•´ä¸ªæ¨¡æ¿å¤±æ•ˆ

---

## ğŸ› é—®é¢˜ä¿®å¤

### 1. AntDesign Select åŠ¨æ€é€‰é¡¹ä¸æ˜¾ç¤º
- **ç°è±¡**ï¼šæ•°æ®å·²æˆåŠŸåŠ è½½å¹¶ç¿»è¯‘ï¼Œä½†ä¸‹æ‹‰æ¡†å§‹ç»ˆä¸ºç©º
- **å°è¯•æ–¹æ¡ˆ**ï¼š
  - SelectOption Label vs å­å†…å®¹
  - æ‡’åŠ è½½ vs é¢„åŠ è½½
  - OnDropdownVisibleChange äº‹ä»¶
  - å¤–å±‚ div åŒ…è£¹ @onclick/@onfocus
  - async void vs async Task
  - StateHasChanged è°ƒç”¨æ—¶æœº
  - @key å±æ€§å¼ºåˆ¶é‡æ¸²æŸ“
- **æœ€ç»ˆæ–¹æ¡ˆ**ï¼šæ”¾å¼ƒ Selectï¼Œæ”¹ç”¨ EntitySelectorï¼ˆModal + å¡ç‰‡åˆ—è¡¨ï¼‰

### 2. FormDesigner å±æ€§é¢æ¿é—´è·ä¼˜åŒ–
- å‡å°‘å„å…ƒç´  margin/padding
- æ›¿æ¢ Alert ç»„ä»¶ä¸ºè‡ªå®šä¹‰ç´§å‡‘æç¤ºæ¡†
- ä¼˜åŒ– Divider é—´è·

---

## ğŸ“ å¤šè¯­è¨€èµ„æºè¡¥å……

æ–°å¢å¤šè¯­è¨€é”®ï¼ˆä¸­æ–‡/æ—¥æ–‡/è‹±æ–‡ï¼‰ï¼š
- `LBL_SELECT_ENTITY_TYPE` - è¯·é€‰æ‹©å®ä½“ç±»å‹
- `LBL_CLICK_TO_SELECT_ENTITY` - ç‚¹å‡»é€‰æ‹©å®ä½“ç±»å‹
- `LBL_ENTITY_TYPE_LOCKED` - å®ä½“ç±»å‹å·²é”å®šï¼Œä¸å¯ä¿®æ”¹
- `LBL_ENTITY_TYPE_NOT_SET` - æœªè®¾ç½®
- `LBL_CHANGE_ENTITY_TYPE` - æ›´æ¢å®ä½“ç±»å‹
- `LBL_LOADING` - åŠ è½½ä¸­...
- `LBL_NO_AVAILABLE_ENTITIES` - æš‚æ— å¯ç”¨å®ä½“ç±»å‹
- `LBL_LOAD_FAILED` - åŠ è½½å¤±è´¥
- `LBL_RETRY` - é‡è¯•
- `LBL_SEARCH_PLACEHOLDER` - æœç´¢...
- `LBL_SHOWING` - æ˜¾ç¤º
- `LBL_ITEMS` - é¡¹

---

## ğŸ“Š ç»Ÿè®¡

### ä»£ç å˜æ›´
- **æ–°å¢æ–‡ä»¶**ï¼š
  - `src/BobCrm.App/Components/Shared/EntitySelector.razor` (237è¡Œ)
  - `src/BobCrm.App/Abstractions/ISelectableEntity.cs` (30è¡Œ)
- **ä¿®æ”¹æ–‡ä»¶**ï¼š
  - `src/BobCrm.Api/Data/Entities/EntityMetadata.cs` - æ·»åŠ  EntityName, EntityRoute å­—æ®µ
  - `src/BobCrm.Api/Domain/Models/Customer.cs` - æ›´æ–° GetMetadata() æ–¹æ³•
  - `src/BobCrm.Api/Infrastructure/DatabaseInitializer.cs` - æ›´æ–°è‡ªåŠ¨æ³¨å†Œé€»è¾‘ï¼Œä½¿ç”¨ç±»å…¨åæŸ¥æ‰¾
  - `src/BobCrm.Api/Endpoints/EntityMetadataEndpoints.cs` - æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼Œè¿”å› EntityRoute
  - `src/BobCrm.App/Components/Pages/FormDesigner.razor` - ä½¿ç”¨ EntitySelectorï¼Œä¼˜åŒ–é—´è·
  - `src/BobCrm.App/wwwroot/css/theme.css` - å…¨å±€å¸ƒå±€æ»šåŠ¨æ¡ä¿®å¤
- **æ›´æ–°æ–‡æ¡£**ï¼š
  - `docs/å®ä½“å…ƒæ•°æ®è‡ªåŠ¨æ³¨å†Œæœºåˆ¶.md` - æ›´æ–° EntityMetadata ç»“æ„ç¤ºä¾‹
  - `docs/å®¢æˆ·ä¿¡æ¯ç®¡ç†ç³»ç»Ÿè®¾è®¡æ–‡æ¡£.md` - æ·»åŠ  EntitySelector ç»„ä»¶è¯´æ˜

### è¡Œæ•°ç»Ÿè®¡
- EntitySelectorç»„ä»¶: 237è¡Œ
- ISelectableEntityæ¥å£: 30è¡Œ
- FormDesignerä¼˜åŒ–: -40è¡Œï¼ˆé—´è·ä¼˜åŒ–ã€ç§»é™¤åºŸå¼ƒä»£ç ï¼‰
- æ–‡æ¡£æ›´æ–°: +100è¡Œ

---

## ğŸ”„ åç»­è®¡åˆ’

1. **EntitySelector å¢å¼º**ï¼š
   - æ”¯æŒå¤šé€‰æ¨¡å¼
   - æ”¯æŒåˆ†é¡µåŠ è½½ï¼ˆæ•°æ®é‡å¤§æ—¶ï¼‰
   - æ”¯æŒè‡ªå®šä¹‰æ’åº

2. **æ›´å¤šå®ä½“æ¥å…¥**ï¼š
   - Productï¼ˆäº§å“ï¼‰
   - Orderï¼ˆè®¢å•ï¼‰
   - Contactï¼ˆè”ç³»äººï¼‰
   - æ‰€æœ‰å®ä½“éƒ½å®ç° IEntityMetadataProvider å’Œ ISelectableEntity

3. **æ¨¡æ¿ç®¡ç†å®Œå–„**ï¼š
   - Template è¡¨è®¾è®¡ï¼ˆæ›¿ä»£å½“å‰çš„ UserLayoutï¼‰
   - æ¨¡æ¿åˆ†ç±»ã€æ ‡ç­¾ã€æƒé™æ§åˆ¶
   - æ¨¡æ¿å¯¼å…¥/å¯¼å‡º

---

## ğŸ™ è‡´è°¢

æœ¬æ¬¡æ›´æ–°ä¸»è¦è§£å†³äº†ï¼š
1. EntityMetadata çš„è§„èŒƒåŒ–é—®é¢˜ï¼Œç¡®ä¿åå‘æ£€æŸ¥çš„å‡†ç¡®æ€§
2. Select ç»„ä»¶åŠ¨æ€é€‰é¡¹æ¸²æŸ“çš„é•¿æœŸå›°æ‰°ï¼Œé€šè¿‡åˆ›æ–°çš„ EntitySelector æ–¹æ¡ˆå½»åº•è§£å†³
3. å…¨å±€æ»šåŠ¨æ¡é—®é¢˜ï¼Œç¡®ä¿ç¬¦åˆä¸“ä¸šè®¾è®¡å™¨çš„å¸ƒå±€è§„èŒƒ

æ„Ÿè°¢ç”¨æˆ·çš„è€å¿ƒæµ‹è¯•å’Œå®è´µå»ºè®®ï¼

---

**å®Œæ•´æ›´æ–°æ—¥å¿—**ï¼šè¯·æŸ¥çœ‹ Git æäº¤è®°å½•ã€‚

