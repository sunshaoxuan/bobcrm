# ARCH-30 阶段2工作计划

**阶段名称**: 中频API改造  
**预计工作量**: 3-4小时  
**任务数量**: 4个  
**状态**: ⏳ 待开始  
**优先级**: 🔸 中（管理界面优化）

---

## 📊 阶段概览

### 阶段目标

改造用户在管理界面频繁访问的列表API，优化管理员用户体验。

### 核心任务

| 任务 | 端点 | 复杂度 | 预计工作量 | 优先级 |
|------|------|--------|-----------|--------|
| Task 2.1 | /api/entity-definitions | 中 | 1小时 | 高 |
| Task 2.2 | /api/enums | 低 | 0.5小时 | 中 |
| Task 2.3 | /api/entity-domains | 低 | 0.5小时 | 中 |
| Task 2.4 | /api/access/functions (树) | 高 | 1.5小时 | 高 |

---

## 🎯 与阶段1的对比

### 相似点

1. ✅ 使用相同的实现模式（`LangHelper` + `ToSummaryDto`）
2. ✅ 需要完整的测试覆盖（单语/多语模式）
3. ✅ 保持向后兼容性
4. ✅ 一次性通过，无返工

### 差异点

| 维度 | 阶段1 | 阶段2 |
|------|------|------|
| 调用频率 | 高（每次登录/刷新） | 中（管理界面） |
| 影响用户 | 100% 用户 | 管理员用户 |
| 数据结构复杂度 | 中（菜单树） | 高（元数据+字段） |
| 需要 DisplayNameKey | 否 | **是**（Task 2.1） |
| 性能优化目标 | 15-65% | 30-50% |

---

## 📋 详细任务清单

### Task 2.1: 实体定义接口改造 ⭐⭐⭐

**端点**: 
- `/api/entity-definitions` (GET)
- `/api/entity-definitions/{id}` (GET)
- `/api/entity-definitions/{id}/fields` (GET)

**核心挑战**: 
- 包含字段元数据（`Fields`）
- 字段可能有 `DisplayNameKey`（资源Key）或 `DisplayName`（多语字典）
- 需要优先级解析：`DisplayNameKey` > `DisplayName` > `PropertyName`

**工作内容**:
1. 端点添加 `lang` 参数
2. 实体定义使用 `ToSummaryDto(lang)`
3. **字段元数据使用 `ToFieldDto(loc, lang)`**（关键）
4. 测试覆盖字段的 `DisplayNameKey` 解析

**预计工作量**: 1小时

---

### Task 2.2: 枚举接口改造 ⭐

**端点**:
- `/api/enums` (GET)
- `/api/enums/{id}` (GET)

**核心挑战**:
- 枚举值（`EnumValue`）也有多语显示名
- 需要同时处理枚举定义和枚举值的语言过滤

**工作内容**:
1. 端点添加 `lang` 参数
2. 枚举定义使用 `ToSummaryDto(lang)`
3. 枚举值应用语言过滤（可能需要扩展方法）
4. 测试覆盖枚举值的语言模式

**预计工作量**: 0.5小时

---

### Task 2.3: 实体域接口改造 ⭐

**端点**:
- `/api/entity-domains` (GET)
- `/api/entity-domains/{id}` (GET)

**核心挑战**:
- 实体域（`EntityDomain`）结构相对简单
- 类似于 Task 1.3（实体列表）

**工作内容**:
1. 端点添加 `lang` 参数
2. 使用 `ToSummaryDto(lang)`（如果有）或手动映射
3. 测试覆盖

**预计工作量**: 0.5小时

---

### Task 2.4: 功能节点管理接口改造 ⭐⭐⭐

**端点**:
- `/api/access/functions` (GET) - 管理员视图（所有节点）
- `/api/access/functions/manage` (GET) - 管理界面
- `/api/access/functions/export` (GET) - 导出功能

**核心挑战**:
- 与 Task 1.1 (`/me`) 不同，这些端点返回**完整功能树**（无权限过滤）
- 可能需要支持批量导出（Excel/JSON）
- 需要考虑管理员视图的特殊需求

**工作内容**:
1. 三个端点都添加 `lang` 参数
2. 复用 `FunctionTreeBuilder.BuildAsync(nodes, lang)`
3. 确保与 Task 1.1 的一致性
4. 测试覆盖完整树（包括子节点）

**预计工作量**: 1.5小时

---

## 🎯 质量目标

### 代码质量

| 指标 | 目标 |
|------|------|
| 评分 | ≥ 4.8/5.0 |
| 一次性通过率 | 100% |
| 技术债累积 | 0 |

### 测试覆盖

| 指标 | 目标 |
|------|------|
| 单元测试通过率 | 100% |
| 集成测试通过率 | 100% |
| 测试用例数 | ≥ 3/任务 |

### 性能目标

| 端点 | 目标减少 |
|------|---------|
| /api/entity-definitions | 30-40% |
| /api/enums | 40-50% |
| /api/entity-domains | 30-40% |
| /api/access/functions | 15-20%（与Task 1.1相似） |

---

## 📅 实施计划

### 建议顺序

**推荐顺序**: 2.2 → 2.3 → 2.1 → 2.4

**原因**:
1. **Task 2.2, 2.3**（简单任务）：快速完成，建立信心
2. **Task 2.1**（中等复杂）：处理字段元数据，积累经验
3. **Task 2.4**（复杂任务）：最后完成，避免阻塞

### 时间估算

| 天数 | 任务 | 累计工作量 |
|------|------|-----------|
| Day 1 上午 | Task 2.2 + 2.3 | 1小时 |
| Day 1 下午 | Task 2.1 | 2小时 |
| Day 2 上午 | Task 2.4 | 3.5小时 |
| Day 2 下午 | 代码评审 + 文档 | 4小时 |

**总计**: 2天（4小时实际开发）

---

## 🔧 技术准备

### 需要的扩展方法

**Task 2.1 可能需要**:
- `ToFieldDto(FieldMetadata field, ILocalization loc, string? lang)` ✅ 已有（Task 0.2）

**Task 2.2 可能需要**:
- `ToEnumValueDto(EnumValue value, string? lang)` ⚠️ 可能需要新增

**Task 2.3 可能需要**:
- `ToDomainDto(EntityDomain domain, string? lang)` ⚠️ 可能需要新增（或手动映射）

**Task 2.4**:
- `FunctionTreeBuilder.BuildAsync(nodes, lang)` ✅ 已有（Task 1.1）

---

## ⚠️ 风险点

### 风险1: DisplayNameKey 解析复杂度 ⚠️

**Task 2.1** 涉及字段元数据，需要处理：
1. `DisplayNameKey`（资源Key）
2. `DisplayName`（多语字典）
3. `PropertyName`（属性名）

**缓解措施**: 
- 使用现有的 `ToFieldDto` 扩展方法（Task 0.2）
- 参考 Task 1.1 的优先级解析逻辑

### 风险2: 枚举值多语处理 ⚠️

**Task 2.2** 的枚举值可能没有现成的扩展方法。

**缓解措施**:
- 如果简单，直接在端点内手动映射
- 如果复杂，创建 `ToEnumValueDto` 扩展方法

### 风险3: 批量导出功能 ⚠️

**Task 2.4** 的 `/export` 端点可能涉及 Excel 导出。

**缓解措施**:
- 先关注 JSON 导出
- Excel 导出如需多语支持，按相同模式处理

---

## 📊 成功标准

### 阶段2完成的定义

- [x] 4个任务全部完成
- [x] 所有测试通过（≥ 12个测试）
- [x] 代码评审通过（平均 ≥ 4.8/5.0）
- [x] 零技术债累积
- [x] 文档更新完成

### 对比阶段1

**期望**:
- 阶段1平均分: 4.97/5.0
- **阶段2目标**: ≥ 4.8/5.0（允许略低，因复杂度更高）
- 保持一次性通过率: 100%

---

## 📚 参考资料

### 设计文档

- [ARCH-30 主设计文档](../../design/ARCH-30-实体字段显示名多语元数据驱动设计.md) - 第2112-2167行
- [阶段0 总结](PHASE-0-SUMMARY.md)
- [阶段1 完成情况](README.md)

### 已完成任务参考

**简单任务参考**: Task 1.3（实体列表）
- 3行核心逻辑
- 直接使用 `ToSummaryDto`
- 8个测试覆盖

**复杂任务参考**: Task 1.1（功能菜单）
- 递归树结构
- 使用 TreeBuilder
- 6个测试覆盖

**中等复杂参考**: Task 1.2（导航菜单）
- 实体+菜单双重解析
- 回退链设计
- 3个测试覆盖

---

## 🚀 开始行动

### 立即可行动

**下一步**: 开始 Task 2.2 或 Task 2.3（简单任务）

**建议**:
1. 先阅读任务设计文档（`task-2.2-api-enums.md`）
2. 理解端点当前实现
3. 按设计文档实施改造
4. 编写测试
5. 提交代码

---

**文档类型**: 阶段工作计划  
**创建日期**: 2025-12-11  
**维护者**: ARCH-30 架构组  
**下次更新**: 阶段2完成后

