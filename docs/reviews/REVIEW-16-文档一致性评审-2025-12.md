# REVIEW-16: 文档一致性评审报告

**评审日期**: 2025-12-27
**评审范围**: Phase 4 - 文档与代码一致性
**评审人**: Claude Code

---

## 一、评审概要

| 维度 | 检查项数 | 通过 | 不一致 | 通过率 |
|------|----------|------|--------|--------|
| API 文档 vs 端点 | 22 个端点文件 | 部分 | 60+ 缺失 | **~35%** |
| 设计文档 vs 代码 | 3 个 ARCH 文档 | 大部分 | 3 项 | **~85%** |
| CHANGELOG 完整性 | 最近变更 | 全部 | 0 | **100%** |
| 文档命名规范 | STD-02 | 全部 | 0 | **100%** |

---

## 二、API 文档一致性

### 2.1 文档覆盖率

**API-01-接口文档.md** 当前版本：v0.2

| 已记录端点数 | 实际端点数 | 缺失端点数 | 覆盖率 |
|--------------|------------|------------|--------|
| ~35 | ~95 | ~60 | **~35%** |

### 2.2 缺失文档的端点（按模块）

#### 用户管理 (UserEndpoints.cs)
| 路由 | 方法 | 描述 |
|------|------|------|
| `/api/users` | GET | 用户列表 |
| `/api/users/{id}` | GET | 用户详情 |
| `/api/users` | POST | 创建用户 |
| `/api/users/{id}` | PUT | 更新用户 |
| `/api/users/{id}/roles` | PUT | 更新用户角色 |

#### 系统管理 (SystemEndpoints.cs)
| 路由 | 方法 | 描述 |
|------|------|------|
| `/api/system/audit-logs` | GET | 审计日志列表 |
| `/api/system/audit-logs/modules` | GET | 审计日志模块 |
| `/api/system/jobs` | GET | 后台任务列表 |
| `/api/system/jobs/{id}` | GET | 任务详情 |
| `/api/system/jobs/{id}/logs` | GET | 任务日志 |
| `/api/system/jobs/{id}/cancel` | POST | 取消任务 |
| `/api/system/i18n` | GET/POST | I18n 资源管理 |
| `/api/system/i18n/reload` | POST | 刷新 I18n 缓存 |
| `/api/system/info` | GET | 系统运行信息 |

#### 设置管理 (SettingsEndpoints.cs)
| 路由 | 方法 | 描述 |
|------|------|------|
| `/api/settings/system` | GET/PUT | 系统设置 |
| `/api/settings/system/smtp/test` | POST | SMTP 测试 |
| `/api/settings/user` | GET/PUT | 用户设置 |

#### 组织管理 (OrganizationEndpoints.cs)
| 路由 | 方法 | 描述 |
|------|------|------|
| `/api/organizations/tree` | GET | 组织树 |
| `/api/organizations` | POST/PUT/DELETE | 组织 CRUD |

#### 数据集 (DataSetEndpoints.cs)
| 路由 | 方法 | 描述 |
|------|------|------|
| `/api/datasets` | GET/POST/DELETE | 数据集 CRUD |
| `/api/datasets/{id}` | GET/PUT | 数据集详情/更新 |
| `/api/datasets/by-code/{code}` | GET | 按代码获取 |
| `/api/datasets/{id}/execute` | POST | 执行查询 |
| `/api/datasets/{id}/fields` | GET | 字段元数据 |

#### 字段权限 (FieldPermissionEndpoints.cs)
| 路由 | 方法 | 描述 |
|------|------|------|
| `/api/field-permissions/role/{roleId}` | GET | 角色字段权限 |
| `/api/field-permissions/...` | GET/POST/DELETE | 完整 CRUD（10+ 端点） |

#### 实体聚合 (EntityAggregateEndpoints.cs)
| 路由 | 方法 | 描述 |
|------|------|------|
| `/api/entity-aggregates/{id}` | GET | 获取聚合 |
| `/api/entity-aggregates` | POST | 保存聚合 |
| `/api/entity-aggregates/validate` | POST | 验证聚合 |
| `/api/entity-aggregates/sub-entities/{id}` | DELETE | 删除子实体 |

#### 管理端点 (AdminEndpoints.cs)
| 路由 | 方法 | 描述 |
|------|------|------|
| `/api/admin/db/health` | GET | 数据库健康检查 |
| `/api/admin/db/recreate` | POST | 重建数据库 |
| `/api/admin/reset-password` | POST | 重置管理员密码 |
| `/api/admin/templates/regenerate-defaults` | POST | 重生成默认模板 |
| `/api/admin/templates/{entityRoute}/regenerate` | POST | 重生成指定实体模板 |

#### 其他端点
- `SetupEndpoints.cs` - `/api/setup/admin` (GET/POST)
- `LookupEndpoints.cs` - `/api/lookups/resolve` (POST)
- `FieldActionEndpoints.cs` - RDP/File/Mailto 操作端点

### 2.3 已记录但需更新的端点

| 端点 | 问题 | 建议 |
|------|------|------|
| `/api/customers/{id}` PUT | 响应格式已变更 | 更新响应示例 |
| `/api/admin/dbconfig` | 标注"后续实现" | 确认是否已实现并更新 |

---

## 三、设计文档一致性

### 3.1 ARCH-20 实体定义管理设计

| 设计点 | 预期 | 实际 | 状态 |
|--------|------|------|------|
| 软删除字段 | IsDeleted, DeletedAt, DeletedBy | 已实现 | ✅ |
| 查询过滤 | 自动过滤 `!IsDeleted` | 已实现 | ✅ |
| 字段来源保护 | System/Interface 字段限制修改属性 | **未强制执行** | ❌ |
| 接口字段删除 | 抛出异常 | 静默跳过 | ⚠️ |

**问题 D16-001**: `EntityDefinitionAppService.cs` 未按 Source 类型限制字段属性修改

**涉及文件**: `c:\workspace\bobcrm\src\BobCrm.Api\Services\EntityDefinitionAppService.cs:254-268`

**设计要求**:
- System 字段：只能修改 DisplayName, SortOrder
- Interface 字段：只能修改 DisplayName, SortOrder, DefaultValue
- Custom 字段：可修改所有属性

**现状**: 所有字段属性统一更新，无 Source 检查

---

### 3.2 ARCH-21 组织与权限体系设计

| 设计点 | 预期 | 实际 | 状态 |
|--------|------|------|------|
| OrganizationNode 模型 | ParentId, Level, PathCode | 已实现 | ✅ |
| FunctionNode 模型 | Code, Name, Route, Icon, etc. | 已实现 | ✅ |
| RoleProfile 模型 | 完整字段 | 已实现 | ✅ |
| 权限过滤 | `.RequireFunction()` | 已实现 | ✅ |
| 数据范围 | All/Self/Organization/OrgSubTree | 已实现 | ✅ |
| SYS.ADMIN 种子 | 启动时自动创建 | 已实现 | ✅ |

**结论**: ARCH-21 设计与实现一致

---

### 3.3 ARCH-26 动态枚举系统设计

| 设计点 | 预期 | 实际 | 状态 |
|--------|------|------|------|
| EnumDefinition 模型 | 完整字段 | 已实现 | ✅ |
| EnumOption 模型 | 完整字段 | 已实现 | ✅ |
| FieldDataType.Enum | 枚举类型支持 | 已实现 | ✅ |
| FieldMetadata 扩展 | EnumDefinitionId, IsMultiSelect | 已实现 | ✅ |
| API 端点 | CRUD 完整 | 已实现 | ✅ |
| 枚举字段赋值 | 创建/更新时赋值 EnumDefinitionId | **未实现** | ❌ |

**问题 D16-002**: 创建/更新字段时未处理 EnumDefinitionId 赋值

**涉及文件**: `c:\workspace\bobcrm\src\BobCrm.Api\Services\EntityDefinitionAppService.cs:275-296`

**设计要求**: 当 `DataType = Enum` 时，应赋值 `EnumDefinitionId` 和 `IsMultiSelect`

**现状**: 字段创建/更新逻辑未包含枚举相关属性

---

## 四、CHANGELOG 完整性

### 4.1 最近变更覆盖检查

| 变更项 | PLAN-18 ID | CHANGELOG 记录 | 状态 |
|--------|------------|----------------|------|
| JWT 配置校验 | P0-001 | ✅ Security 节 | 通过 |
| CORS 配置校验 | P0-002 | ✅ Security 节 | 通过 |
| TimeProvider 引入 | P2-001 | ✅ Security 节 | 通过 |
| 启动配置重构 | P2-002 | ✅ Security 节 | 通过 |
| GlobalExceptionHandler | P1-002 | ✅ Changed 节 | 通过 |
| JsInterop 重构 | P3-001 | ✅ Changed 节 | 通过 |
| ErrorCodes 标准化 | P3-002 | ✅ Changed 节 | 通过 |

**结论**: CHANGELOG 完整覆盖近期所有重要变更

### 4.2 版本记录

| 版本 | 日期 | 状态 |
|------|------|------|
| [未发布] | 进行中 | 包含 P0-P3 修复 |
| [0.9.5] | 2025-12-25 | 已发布 |
| [0.8.0] | 2025-11-21 | 已发布 |

---

## 五、文档规范符合性

### 5.1 STD-02 文档命名规范

| 检查项 | 状态 |
|--------|------|
| ARCH-XX 命名 | ✅ 符合 |
| PROD-XX 命名 | ✅ 符合 |
| REVIEW-XX 命名 | ✅ 符合 |
| PLAN-XX 命名 | ✅ 符合 |
| 存放位置正确 | ✅ 符合 |

### 5.2 文档数量统计

| 目录 | 文件数 |
|------|--------|
| docs/design/ | 16 个 ARCH 文档 |
| docs/reviews/ | 16 个 REVIEW 文档 |
| docs/plans/ | 18 个 PLAN 文档 |
| docs/guides/ | 11 个 GUIDE 文档 |
| docs/process/ | 7 个 STD/PROC 文档 |

---

## 六、问题汇总

### 6.1 P1 问题（需修复）

| ID | 问题 | 涉及文件 | 影响 |
|----|------|----------|------|
| D16-001 | 字段 Source 保护未实现 | EntityDefinitionAppService.cs | 系统/接口字段可被误修改 |
| D16-002 | 枚举字段属性未赋值 | EntityDefinitionAppService.cs | 枚举字段无法正确关联定义 |

### 6.2 P2 问题（需补充）

| ID | 问题 | 涉及文件 | 建议 |
|----|------|----------|------|
| D16-003 | API 文档覆盖率低 (~35%) | API-01-接口文档.md | 补充 60+ 缺失端点文档 |

### 6.3 P3 问题（建议优化）

| ID | 问题 | 建议 |
|----|------|------|
| D16-004 | 接口字段删除无异常 | 改为抛出明确异常而非静默跳过 |
| D16-005 | 部分响应示例过时 | 更新 API 文档中的响应示例 |

---

## 七、改进建议

### 7.1 立即修复（P1）

1. **D16-001**: 在 `EntityDefinitionAppService.UpdateEntityDefinitionAsync` 中增加 Source 检查逻辑
   ```csharp
   if (existingField.Source == FieldSource.System)
   {
       // 仅允许修改 DisplayName, SortOrder
   }
   ```

2. **D16-002**: 在字段创建/更新逻辑中添加枚举属性处理
   ```csharp
   if (fieldDto.DataType == FieldDataType.Enum)
   {
       newField.EnumDefinitionId = fieldDto.EnumDefinitionId;
       newField.IsMultiSelect = fieldDto.IsMultiSelect ?? false;
   }
   ```

### 7.2 文档补充（P2）

建议分批补充 API 文档：

| 优先级 | 模块 | 端点数 |
|--------|------|--------|
| 高 | 用户管理、系统管理 | ~15 |
| 中 | 设置、组织、数据集 | ~15 |
| 低 | 字段权限、实体聚合、管理端点 | ~30 |

---

## 八、评审结论

| 维度 | 评分 | 说明 |
|------|------|------|
| API 文档完整性 | 4/10 | 仅覆盖 ~35% 端点 |
| 设计文档一致性 | 8/10 | 2 项实现偏差 |
| CHANGELOG 维护 | 10/10 | 完整覆盖近期变更 |
| 文档规范符合性 | 10/10 | 命名和存放均规范 |
| **总体** | **7/10** | API 文档需大量补充 |

**建议**:
- P1 问题应在下一迭代优先修复
- API 文档补充可分阶段进行，优先补充高频使用的端点

---

**评审完成时间**: 2025-12-27
**下次评审日期**: 2026-01-17
