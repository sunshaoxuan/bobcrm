# AUDIT-GAP-01: v1.0 目标对齐详细偏差分析报告

**报告日期**: 2026-01-13
**状态**: 关键偏差已识别

---

## 1. 偏差摘要
经过对 `BobCrm.Api` 与 `BobCrm.App` 核心源码的细节审计，当前实现与 [STD-08](file:///c:/workspace/bobcrm/docs/process/STD-08-v1.0-平台全功能验收标准.md) 目标的偏差主要集中在 **“模板多态与权限导航闭环”**。

## 2. 细节偏差矩阵 (Gap Details)

### 2.1 实体热发布 (80% 对齐)
*   **当前**: 能够生成 CRUD 物理表，支持添加列和修改长度。
*   **偏差 (Gap)**: 
    *   不支持列的物理删除和更名。物理表与元数据不一致时，缺乏自动修复/警告逻辑。
    *   `EntityPublishingService` 的增量发布依赖于手动操作，缺乏“元数据变更自动感知”机制。

### 2.2 模板自定义与热更新 (90% 对齐)
*   **当前**: 设计器可拖拽、可保存。
*   **偏差 (Gap)**: 实体字段变更后，已修改过的自定义模板不会“智能合并”新字段，需要用户手动在设计器中拉取。

### 2.3 多态视图渲染 (Polymorphic Rendering) - (30% 对齐)
*   **核心偏差**: **链路断裂。**
    *   **后端**: `TemplateRuntimeService` 拥有基于数据规则的选择引擎，但尚未支持基于“用户请求上下文（如菜单 ID）”的强行指定。
    *   **前端**: `PageLoaderViewModel` 目前仅调用无参数的 `GetRuntimeAsync`。即使 URL 指向不同的功能菜单，PageLoader 始终只加载该实体的“默认有效模板”。
    *   **结果**: 无法实现“销售看销售模板，财务看财务模板”的多态路由。

### 2.4 权限与菜单闭环 (Security Loop) - (20% 对齐)
*   **核心偏差**: **拦截器失效。**
    *   **控制台**: `TemplateBindingAppService` 能够计算权限交集。
    *   **运行态**: 进入 `/{entity}/{id}` 路由时，系统没有校验“该用户是否通过合法的菜单路径进入”。
    *   **数据安全**: 动态实体的 REST API 未与模板定义的字段可见性进行强校验（API 仍然会返回所有字段给前端）。

## 3. 风险评估
> [!CAUTION]
> 如果不修复上述“多态链路断裂”问题，BobCRM 将仅是一个“单一表单生成器”，而非一个“具备业务隔离能力的平台”。

## 4. 纠偏行动建议
1.  **打通 PageLoader 上下文**: 必须让 URL 携带 `viewState` 或 `templateId` 参数。
2.  **闭环服务端校验**: 在请求动态数据时，后端必须校验当前用户对该模板的访问权。

---
**分析人**: Antigravity (Architect)
