# 下一步开发计划

> **创建日期**: 2025-11-20  
> **状态**: 规划中  
> **优先级**: 高

## 📊 现状分析

### ✅ 已完成功能

#### 1. 列表视图模板化（已完成）
- ✅ `ListTemplateHost` 组件已实现并投入使用
- ✅ `DataGridRuntime` 支持行操作（Edit/Delete）和导航
- ✅ `Customers.razor` 已迁移到模板驱动方式
- ✅ `EntityDefinitionSynchronizer` 自动为系统实体创建模板和绑定
- ✅ `DefaultTemplateGenerator` 生成包含 `RowActionsJson` 的List模板

#### 2. 模板绑定UI（部分完成）
- ✅ `/templates/bindings` 页面已实现
- ✅ 支持实体类型和用途筛选
- ✅ 支持系统绑定/用户绑定切换
- ✅ 在角色权限页面（`Roles.razor`）中已集成模板绑定选择器
- ⚠️ **待完善**: 上下文感知绑定（角色/组织级别的绑定UI需要增强）

#### 3. 模板系统基础设施（已完成）
- ✅ 表单设计器（FormDesigner）
- ✅ 模板管理页面（Templates.razor）
- ✅ 模板运行时（TemplateRuntime）
- ✅ 默认模板生成服务

### ❌ 待完成功能

#### 1. 系统实体迁移（高优先级）
**现状**:
- `Users.razor`: 硬编码实现，包含侧边栏列表和详情表单
- `Roles.razor`: 硬编码实现，包含侧边栏列表、详情表单和权限树

**需要迁移**:
- [ ] **Users实体迁移**:
  - 创建 `user` 实体的 EntityDefinition（如果不存在）
  - 为 `user` 实体生成默认模板（List/Detail/Edit）
  - 将 `Users.razor` 改为使用 `ListTemplateHost` 和 `PageLoader`
  - 保留必要的业务逻辑（如锁定/解锁、密码重置）

- [ ] **Roles实体迁移**:
  - 创建 `role` 实体的 EntityDefinition（如果不存在）
  - 为 `role` 实体生成默认模板（List/Detail/Edit）
  - 将 `Roles.razor` 改为使用 `ListTemplateHost` 和 `PageLoader`
  - **特殊处理**: 权限树功能需要保留，可能需要作为自定义Widget集成

- [ ] **Organizations实体迁移**（如果存在）:
  - 检查是否存在 Organizations 页面
  - 如存在，按相同方式迁移

#### 2. 菜单与导航管理（高优先级）
**现状**:
- ✅ 后端API已实现（菜单CRUD、排序、模板绑定）
- ✅ 菜单数据模型完整（FunctionMenuNode、菜单多语言支持）
- ❌ **缺少**: 可视化菜单编辑器UI

**需要实现**:
- [ ] **菜单管理页面** (`/system/menus`):
  - 树形结构展示菜单层级
  - 拖拽排序功能
  - 菜单项CRUD（创建、编辑、删除）
  - 菜单属性编辑（名称、路由、图标、权限码）

- [ ] **拖拽式菜单编辑器**:
  - 使用拖拽库（如 Blazor.DragDrop 或自定义实现）
  - 支持拖拽调整菜单顺序和层级
  - 实时预览菜单结构

- [ ] **菜单与权限集成**:
  - 菜单项自动生成或关联功能权限码
  - 菜单可见性与用户权限严格同步
  - 在菜单编辑器中显示权限状态

- [ ] **菜单与模板绑定集成**:
  - 在菜单编辑器中支持选择模板
  - 支持菜单项直接链接到动态实体或自定义页面

#### 3. 模板绑定UI增强（中优先级）
- [ ] **上下文感知绑定UI**:
  - 在实体定义页面显示当前绑定状态
  - 支持快速切换模板绑定
  - 显示绑定范围（系统/用户/角色/组织）

- [ ] **批量绑定操作**:
  - 支持为多个实体批量设置模板
  - 支持复制绑定配置

---

## 🎯 开发优先级建议

### Phase 1: 系统实体迁移（预计2-3天）
**目标**: 完成Users和Roles实体的模板化迁移

**任务清单**:
1. **后端准备**:
   - [ ] 检查并创建 `user` 和 `role` 的 EntityDefinition
   - [ ] 确保 `EntityDefinitionSynchronizer` 能识别这些实体
   - [ ] 验证默认模板生成逻辑

2. **Users迁移**:
   - [ ] 分析 `Users.razor` 的业务逻辑
   - [ ] 提取必要的业务逻辑到服务层
   - [ ] 创建 `user` 实体的默认模板
   - [ ] 重构 `Users.razor` 使用 `ListTemplateHost`
   - [ ] 测试用户列表、详情、编辑功能

3. **Roles迁移**:
   - [ ] 分析 `Roles.razor` 的业务逻辑（特别是权限树）
   - [ ] 考虑权限树作为自定义Widget或独立组件
   - [ ] 创建 `role` 实体的默认模板
   - [ ] 重构 `Roles.razor` 使用 `ListTemplateHost`
   - [ ] 测试角色列表、详情、编辑、权限分配功能

4. **测试与验证**:
   - [ ] 单元测试覆盖
   - [ ] 集成测试验证
   - [ ] 手动测试所有功能

### Phase 2: 菜单管理UI（预计3-4天）
**目标**: 实现完整的可视化菜单编辑器

**任务清单**:
1. **菜单管理页面基础**:
   - [ ] 创建 `/system/menus` 路由和页面
   - [ ] 实现菜单树形结构展示
   - [ ] 实现菜单项CRUD功能

2. **拖拽功能**:
   - [ ] 选择拖拽库（推荐: Blazor.DragDrop 或 SortableJS）
   - [ ] 实现菜单项拖拽排序
   - [ ] 实现菜单项层级调整（拖拽到父节点下）

3. **菜单属性编辑**:
   - [ ] 菜单名称多语言编辑
   - [ ] 路由路径编辑
   - [ ] 图标选择器
   - [ ] 权限码关联/生成

4. **菜单与模板集成**:
   - [ ] 在菜单编辑器中显示模板绑定选项
   - [ ] 支持选择实体类型和模板
   - [ ] 支持自定义页面路由

5. **权限集成**:
   - [ ] 菜单可见性权限检查
   - [ ] 自动生成功能权限码
   - [ ] 权限状态可视化

### Phase 3: 模板绑定UI增强（预计1-2天）
**目标**: 增强模板绑定管理体验

**任务清单**:
1. **实体定义页面集成**:
   - [ ] 在实体定义编辑页面显示模板绑定状态
   - [ ] 快速跳转到模板绑定页面
   - [ ] 显示当前使用的模板

2. **批量操作**:
   - [ ] 批量设置模板绑定
   - [ ] 复制绑定配置

---

## 📝 技术考虑

### 1. 系统实体迁移的技术挑战

#### Users实体
- **挑战**: Identity框架的User实体可能不是IBizEntity
- **方案**: 
  - 创建独立的User实体定义（不直接使用IdentityUser）
  - 或者扩展IdentityUser实现IBizEntity接口
  - 推荐: 创建独立的User实体定义，通过服务层桥接IdentityUser

#### Roles实体
- **挑战**: 权限树是复杂UI组件，需要保留
- **方案**:
  - 将权限树作为自定义Widget集成到模板系统
  - 或者保留权限树为独立组件，其他部分使用模板
  - 推荐: 混合方案 - 列表和详情使用模板，权限树保留为独立组件

### 2. 菜单管理UI的技术选型

#### 拖拽库选择
- **选项1**: Blazor.DragDrop (NuGet包)
  - 优点: 专为Blazor设计，易于集成
  - 缺点: 可能功能有限
  
- **选项2**: SortableJS (JavaScript库)
  - 优点: 功能强大，成熟稳定
  - 缺点: 需要JS互操作

- **推荐**: 先尝试 Blazor.DragDrop，如不满足需求再考虑 SortableJS

### 3. 权限集成策略

- **菜单权限码生成规则**: `MENU.{实体类型}.{操作}` 或使用菜单路径
- **权限检查时机**: 菜单加载时、页面渲染前
- **权限缓存**: 考虑缓存用户权限，减少API调用

---

## 🧪 测试策略

### 单元测试
- [ ] EntityDefinitionSynchronizer 对 user/role 实体的处理
- [ ] 默认模板生成包含必要字段
- [ ] 菜单API的CRUD操作

### 集成测试
- [ ] Users页面完整流程（列表→详情→编辑）
- [ ] Roles页面完整流程（列表→详情→编辑→权限分配）
- [ ] 菜单管理完整流程（创建→编辑→排序→删除）

### 手动测试
- [ ] 所有系统实体页面功能验证
- [ ] 菜单拖拽排序和层级调整
- [ ] 菜单权限可见性验证
- [ ] 模板绑定切换验证

---

## 📅 时间估算

| 阶段 | 任务 | 预计时间 |
|------|------|----------|
| Phase 1 | 系统实体迁移 | 2-3天 |
| Phase 2 | 菜单管理UI | 3-4天 |
| Phase 3 | 模板绑定增强 | 1-2天 |
| **总计** | | **6-9天** |

---

## 🔗 相关文档

- [ARCH-22: 标准实体模板化与权限联动设计](../design/ARCH-22-标准实体模板化与权限联动设计.md)
- [ROADMAP.md](../ROADMAP.md)
- [PROC-00-文档索引.md](PROC-00-文档索引.md)

---

## 📌 注意事项

1. **向后兼容**: 迁移系统实体时，确保不影响现有功能
2. **数据迁移**: 如有现有菜单数据，确保迁移脚本正确
3. **权限安全**: 菜单管理功能需要严格的权限控制
4. **性能考虑**: 菜单树可能很大，需要懒加载或虚拟滚动
5. **用户体验**: 拖拽操作需要流畅，提供视觉反馈

---

**最后更新**: 2025-11-20

