# 客户信息管理系统设计文档（核心需求）

> 本文件为核心需求文档，作为唯一权威来源。任何需求变更请先更新本文件，再据此调整开发与测试。

## 版本与决策（v0.2）

- 表单设计器（由简至难）
  - 所有可见组件可拖拽；提供组件工具栏（容器 Frame/Grid、ListBox、标签、文本框、表格等）。
  - 明确自由布局与流式布局在不同容器中的支持；除严格结构化数据外尽量避免表格布局。
  - 输出 LayoutJson（兼容 UserLayout/模板），运行态按 LayoutJson 渲染 Ant Design 组件。
- 认证从最小 JWT 迁移到 Identity + JWT
  - 支持注册、邮件激活、登录、登出、刷新令牌、会话重连（服务器重启不掉线）。
  - 采用 ASP.NET Identity + JWT（Access/Refresh）；DataProtection Key 持久化；SMTP 可配置。
- 数据库：以 PostgreSQL 为主，保留 SQLite 最小模式
  - Provider：`postgres`（JSONB 原生支持）/`sqlite`（本地开发）。
  - 支持通过配置切换 Provider 与连接串；后续提供管理员页面进行连接管理与校验。
  - 分层：持久化层（EF Core 多 Provider）/通用业务实体层/商用业务实体层；动态字段 JSONB + 反射式映射。

---

## 目标与范围

- 目标：构建一套以“前端可用性为中心”的客户信息管理系统，支持动态字段、布局设计、权限与国际化，逐步迭代。
- 运行模式：最小可运行（任何时刻可启动）、严格按文档实现，不越权扩展。

## 架构与技术栈

- 前端：Blazor Server + Ant Design Blazor（组件、消息、布局）。
- 后端：ASP.NET Core、Minimal API/Controller 混合；ASP.NET Identity + JWT。
- 数据库：PostgreSQL（主）/SQLite（最小）；EF Core。
- 国际化：资源表 `LocalizationResource` + UI 语言切换。

## 表单设计器

### 组件与工具栏
- 组件：
  - 容器：Frame/Panel（自由/流式）、Grid（结构化数据）、Tabs。
  - 输入：TextBox、Number、Date、Select、Textarea、ListBox、Button、Label。
- 工具栏：组件搜索/分类、拖拽放置、删除/复制、属性编辑（通用 + 组件特性）。

### 布局模式与支持矩阵（简）
- 自由布局：绝对定位（x,y,w,h）；对齐/吸附/网格线。
- 流式布局：Flex/Grid 响应式；跨列/顺序。
- 示意：Frame 支持自由/流式；Grid 仅流式；输入类遵循容器模式。

### 数据结构（LayoutJson）
```
{
  "version": 1,
  "nodes": [
    { "id": "n1", "type": "Frame", "layout": { "mode": "free", "x":10, "y":10, "w":400, "h":200 }, "props": { "title":"基本信息" }, "children": [
      { "id":"n2", "type":"TextBox", "props": { "label":"名称", "field":"name" }, "layout": { "mode":"free", "x":20, "y":20, "w":200, "h":32 } }
    ]}
  ],
  "metadata": { "owner": 1, "tags": ["customer"] }
}
```

### 设计与运行闭环
- 设计态：拖拽 → 属性编辑 → 生成并保存 LayoutJson（模板或 UserLayout）。
- 运行态：按 LayoutJson 渲染；字段绑定依据 `FieldDefinition` + `FieldValue`；动作由 `actions` 驱动。

## 认证与会话

### 能力
- 注册（邮件激活）、登录/登出、刷新令牌、会话重连（服务器重启不丢状态）。

### 方案
- ASP.NET Identity + JWT（Access/Refresh）。
- RefreshToken 持久化表（支持撤销/轮换）；DataProtection Key 持久化。
- SMTP 配置：服务器、端口、凭据、发件人；模板化邮件。

## 数据库与持久化

### Provider 与配置
- 主推：PostgreSQL（JSONB 查询/索引、并发控制）。
- 最小：SQLite（开发与本地验证）。
- 切换（API）：`Db:Provider=postgres|sqlite`，`ConnectionStrings:Default=...`。
- 本地测试建议：使用 `docker-compose.yml` 启动 `postgres:16-alpine`（默认暴露 5432），一次配置多端复用。
- `AppSettings:Db:ConnectionString`：对应连接串
- 管理页（后续）：管理员可更新并校验连接；写入安全配置存储。

### 动态字段与查询
- `FieldValue.Value` 使用 JSON/JSONB 存储；
- PostgreSQL：JSONB 索引 + 路径查询；
- 通用实体层提供“属性映射器”以反射生成常用字段映射（可选）。

## ER 模型（Mermaid）

```mermaid
erDiagram
    User ||--o{ CustomerAccess : has
    Customer ||--o{ CustomerAccess : has
    Customer ||--o{ UserLayout : has
    Customer ||--o{ FieldValue : has
    FieldDefinition ||--o{ FieldValue : defines

    User {
        int Id
        string Username
        string PasswordHash
        string Role
        string PreferredLanguage
        string Email
        bool EmailConfirmed
    }

    Customer {
        int Id
        string Code
        string Name
        int Version
        json ExtData
    }

    CustomerAccess {
        int Id
        int CustomerId
        int UserId
        bool CanEdit
    }

    FieldDefinition {
        int Id
        string Key
        string DisplayName
        string DataType
        json Tags
        json Actions
    }

    FieldValue {
        int Id
        int CustomerId
        int FieldDefinitionId
        string Value
        int Version
    }

    UserLayout {
        int Id
        int UserId
        int CustomerId
        json LayoutJson
    }
```

## 非功能性
- 可运行性：任何提交可最小配置启动；未完成模块以最小实现/Mock 保活。
- 质量：每次修改均需构建与测试（如适用）通过后提交；`main` 随时可运行。
- 安全：生产密钥与连接串管理；最小权限；审计基本操作日志（后续）。
 - Mock 策略：前端可用性优先，允许只读 Mock 兜底；目标接口完成并有测试数据后删除 Mock，避免多源导致缺陷。
 - 端口与配置：后端可自定端口；默认 API 端口 8080；前端通过配置 `Api:BaseUrl` 指向 API。
