# 菜单编辑器使用指南

## 当前状态

**已实现** - 菜单编辑器功能已完整实现并可用。

## 概述

菜单编辑器是 BobCRM 提供的**可视化菜单配置工具**,允许管理员通过拖拽式界面管理系统的功能菜单结构。支持无限层级的菜单树、路由/模板双导航模式、以及实时拖拽排序。

## 访问方式

- **路由**: `/menus`
- **权限码**: `SYS.SET.MENU`
- **权限要求**: 需要管理员权限（默认 `SYS.ADMIN` 角色拥有此权限）
- **访问入口**: 系统管理域下的"菜单管理"功能

## 界面布局

菜单编辑器采用左右分栏布局：

- **左侧面板**: 菜单树形结构，支持拖拽操作
- **右侧面板**: 选中节点的详细信息和操作按钮

## 核心功能

### 1. 查看菜单树

进入菜单编辑器后，左侧会显示完整的菜单树结构。每个菜单节点显示：

- **菜单名称**: 根据当前语言显示多语言名称
- **功能码**: 菜单的唯一标识符（如 `SYS`, `SYS.USERS`）
- **路由/模板信息**: 显示配置的路由路径或模板名称

点击任意节点，右侧面板会显示该节点的详细信息：

- 菜单名称（多语言）
- 功能码
- 路由路径（如有）
- 关联模板（如有）
- 图标
- 排序值

### 2. 新增菜单节点

#### 新增根节点

1. 点击左上角的 **"添加根菜单"** 按钮
2. 在弹出的对话框中填写菜单信息（详见"菜单配置说明"）
3. 点击 **"保存"** 完成创建

#### 新增子节点

有两种方式：

**方式一：在右侧面板操作**
1. 在左侧选中父节点
2. 在右侧面板点击 **"添加子菜单"** 按钮
3. 在弹出的对话框中填写菜单信息
4. 点击 **"保存"** 完成创建

**方式二：在树节点上操作**
1. 将鼠标悬停在父节点上
2. 点击节点右侧的 **"+"** 按钮
3. 在弹出的对话框中填写菜单信息
4. 点击 **"保存"** 完成创建

### 3. 编辑菜单节点

**方式一：在右侧面板操作**
1. 在左侧选中要编辑的节点
2. 在右侧面板点击 **"编辑菜单"** 按钮
3. 在弹出的对话框中修改菜单信息
4. 点击 **"保存"** 保存更改

**方式二：在树节点上操作**
1. 将鼠标悬停在要编辑的节点上
2. 点击节点右侧的 **"编辑"** 图标（铅笔图标）
3. 在弹出的对话框中修改菜单信息
4. 点击 **"保存"** 保存更改

**注意**: 编辑时功能码（Code）不可修改，以确保权限系统的一致性。

### 4. 删除菜单节点

**方式一：在右侧面板操作**
1. 在左侧选中要删除的节点
2. 在右侧面板点击 **"删除菜单"** 按钮
3. 在确认对话框中点击 **"确认"**

**方式二：在树节点上操作**
1. 将鼠标悬停在要删除的节点上
2. 点击节点右侧的 **"删除"** 图标（红色垃圾桶图标）
3. 在确认对话框中点击 **"确认"**

**警告**: 删除父节点会同时删除其所有子节点，操作不可恢复，请谨慎操作。

### 5. 拖拽排序

菜单编辑器支持强大的拖拽功能，可以调整菜单的层级和顺序。

#### 拖拽操作步骤

1. **开始拖动**: 按住鼠标左键在菜单节点上
2. **移动节点**: 将节点拖动到目标位置
3. **放置节点**: 释放鼠标完成拖放

#### 三种放置位置

拖动时会显示三种不同的放置区域（drop zones）：

- **上方区域（Before）**: 将节点插入到目标节点**之前**（同级）
- **节点本身（Into）**: 将节点作为目标节点的**子节点**
- **下方区域（After）**: 将节点插入到目标节点**之后**（同级）

#### 拖到根节点

如果要将节点移动到根级别：

1. 将节点拖动到菜单树顶部的 **"拖放到此处作为根节点"** 区域
2. 释放鼠标，节点将成为根节点

#### 拖拽限制

- **循环依赖检测**: 不能将父节点拖动到自己的子节点下（会显示警告）
- **自动排序**: 放置后系统会自动重新计算所有受影响节点的 `SortOrder` 值

### 6. 菜单配置说明

#### 基本配置

| 字段 | 说明 | 是否必填 | 备注 |
|------|------|----------|------|
| **父菜单** | 显示父节点名称 | 自动填充 | 根节点显示"根节点" |
| **功能码** | 菜单的唯一标识符 | 是 | 创建后不可修改，如 `SYS.USERS` |
| **名称** | 内部名称（回退值） | 否 | 多语言未配置时显示此值 |
| **多语言名称** | 菜单的多语言显示名称 | 推荐 | 支持中文、英文、日文 |
| **图标** | 菜单图标名称 | 否 | 输入 Ant Design 图标名（如 `user`, `setting`） |
| **排序值** | 同级菜单的排序权重 | 是 | 默认值为100，越小越靠前 |
| **是否菜单** | 是否在菜单中显示 | 是 | 关闭后仅作为权限节点 |

#### 导航类型配置

每个菜单节点可以配置两种导航类型之一：

**类型 1: 路由导航**
- **适用场景**: 跳转到固定的前端页面路由
- **配置项**: 路由路径（如 `/customers`, `/settings`）
- **示例**:
  - 客户列表: `/customers`
  - 系统设置: `/settings`

**类型 2: 模板导航**
- **适用场景**: 打开动态实体的列表模板
- **配置项**: 选择实体模板（从下拉列表中选择）
- **示例**:
  - 选择"客户实体 - 列表模板"
  - 选择"订单实体 - 看板模板"

**注意**: 两种导航类型互斥，切换导航类型会清除另一类型的配置。

#### 图标配置

目前图标配置通过文本输入框实现，需要手动输入 Ant Design Blazor 的图标名称。

**常用图标示例**:
- `user` - 用户图标
- `setting` - 设置图标
- `dashboard` - 仪表盘图标
- `team` - 团队图标
- `file-text` - 文档图标
- `folder` - 文件夹图标
- `customer-service` - 客服图标

**获取更多图标**:
访问 [Ant Design Blazor 图标库](https://antblazor.com/en-US/components/icon) 查看所有可用图标。

**未来改进**: v0.7.0 将提供可视化图标选择器。

### 7. 菜单保存与刷新

- **自动保存**: 所有操作（新增、编辑、删除、拖拽）都会立即保存到数据库
- **刷新菜单树**: 点击左上角的 **"刷新"** 按钮重新加载菜单树
- **实时预览**: 保存成功后需要刷新页面才能在顶部菜单中看到变化（未来版本将支持自动刷新）

## 使用流程示例

### 场景1: 创建完整的"客户管理"模块菜单

1. **创建根节点**
   - 功能码: `CRM`
   - 多语言名称:
     - 中文: `客户关系管理`
     - 英文: `CRM`
   - 图标: `customer-service`
   - 导航类型: 路由导航
   - 路由: ` ` (留空，仅作为分组)

2. **创建"客户列表"子节点**
   - 选中 `CRM` 节点
   - 点击 **"添加子菜单"**
   - 功能码: `CRM.CUSTOMERS`
   - 多语言名称:
     - 中文: `客户列表`
     - 英文: `Customers`
   - 图标: `user`
   - 导航类型: 模板导航
   - 模板: 选择"客户实体 - 列表模板"

3. **创建"销售机会"子节点**
   - 选中 `CRM` 节点
   - 点击 **"添加子菜单"**
   - 功能码: `CRM.OPPORTUNITIES`
   - 多语言名称:
     - 中文: `销售机会`
     - 英文: `Opportunities`
   - 图标: `dollar`
   - 导航类型: 路由导航
   - 路由: `/opportunities`

### 场景2: 调整菜单顺序

假设当前菜单顺序为：
```
├── 系统管理
├── 客户管理
└── 报表中心
```

需要调整为：
```
├── 客户管理
├── 报表中心
└── 系统管理
```

**操作步骤**:
1. 将鼠标悬停在"客户管理"节点
2. 按住鼠标左键开始拖动
3. 移动到"系统管理"节点的**上方区域**（会高亮显示）
4. 释放鼠标，完成移动
5. 系统会自动重新计算排序值

### 场景3: 将子节点提升为根节点

假设"客户列表"当前是"客户管理"的子节点，需要提升为根节点。

**操作步骤**:
1. 将鼠标悬停在"客户列表"节点
2. 按住鼠标左键开始拖动
3. 移动到菜单树顶部的 **"拖放到此处作为根节点"** 区域
4. 释放鼠标，"客户列表"成为根节点

## 常见问题（FAQ）

### Q1: 菜单保存成功后，为什么顶部菜单没有立即更新？

**答**: 当前版本需要手动刷新页面才能看到菜单变化。v0.7.0 将支持自动刷新。

**临时解决方案**: 按 `F5` 或 `Ctrl+R` 刷新浏览器页面。

### Q2: 如何知道有哪些可用的图标名称？

**答**: 目前需要访问 [Ant Design Blazor 图标库](https://antblazor.com/en-US/components/icon) 手动查找图标名称。

**未来改进**: v0.7.0 将提供可视化图标选择器，支持预览和搜索。

### Q3: 拖拽时提示"无效的拖放操作"是什么原因？

**答**: 这是循环依赖检测机制，防止将父节点拖动到自己的子节点下。

**示例**: 不能将"客户管理"拖动到"客户列表"（其子节点）下，否则会造成循环引用。

### Q4: 删除菜单节点后，相关的权限配置会怎样？

**答**: 删除菜单节点会同时删除关联的功能权限（Function Code），已分配该权限的角色会失去相应访问权限。

**建议**: 删除前先检查哪些角色依赖该权限，必要时通知用户。

### Q5: "是否菜单"开关有什么用？

**答**:
- **开启**: 节点在菜单中显示，用户可以看到并点击
- **关闭**: 节点不在菜单中显示，但作为权限节点存在，可以用于控制页面/API的访问权限

**使用场景**: 某些页面需要权限控制，但不希望在菜单中显示（如隐藏的管理功能）。

### Q6: 功能码（Code）命名有什么规范？

**答**: 推荐使用以下规范：

- **格式**: `域.模块.功能` （使用英文大写和点分隔）
- **根节点**: 简短的域名（如 `SYS`, `CRM`, `REPORT`）
- **子节点**: 在父节点基础上追加（如 `SYS.USERS`, `CRM.CUSTOMERS`）
- **避免**: 使用特殊字符、空格、中文

**示例**:
```
SYS                   # 系统管理域
├── SYS.USERS         # 用户管理
├── SYS.ROLES         # 角色管理
└── SYS.MENUS         # 菜单管理
```

### Q7: 路由路径和模板导航如何选择？

**答**:

| 场景 | 推荐类型 | 说明 |
|------|----------|------|
| 固定的系统页面（如"设置"、"关于"） | 路由导航 | 直接跳转到 Blazor 页面组件 |
| 动态实体的列表/表单 | 模板导航 | 使用模板引擎渲染实体数据 |
| 外部链接（如"帮助文档"） | 路由导航 | 配置完整 URL（如 `https://docs.example.com`） |
| 仅作为分组（无跳转） | 两者都不配置 | 作为菜单分组节点，点击不跳转 |

### Q8: 如何导入/导出菜单配置？

**答**: 导入/导出功能将在 v0.7.0 中实现。届时可以：

- **导出**: 将完整菜单树导出为 JSON 文件
- **导入**: 从 JSON 文件恢复菜单配置
- **用途**: 在开发/测试/生产环境之间迁移菜单配置

### Q9: 多语言名称如何配置？

**答**: 点击"多语言名称"字段会弹出多语言输入组件：

1. 默认显示三个语言标签页：中文、英文、日文
2. 在每个标签页中输入对应语言的名称
3. 系统会根据用户的当前语言自动显示对应名称
4. 如果某个语言未配置，会回退到"名称"字段的值

**最佳实践**: 至少配置中文和英文，确保国际化支持。

### Q10: 排序值（SortOrder）如何设置？

**答**:

- **默认值**: 新节点默认为 100，或在同级最后一个节点基础上 +10
- **排序规则**: 同级节点按 `SortOrder` **从小到大**排序
- **建议间隔**: 使用 10 的倍数（如 10, 20, 30），便于后续插入新节点
- **拖拽自动调整**: 拖拽排序后，系统会自动重新计算 `SortOrder` 值

**示例**:
```
SYS (SortOrder: 10)
CRM (SortOrder: 20)
REPORT (SortOrder: 30)
```

如果要在 CRM 和 REPORT 之间插入新节点，可以设置 `SortOrder: 25`。

## 权限说明

菜单编辑器与权限系统紧密集成：

1. **功能码即权限码**: 每个菜单节点的功能码（Code）会自动注册为权限码
2. **角色关联**: 在角色管理中可以为角色分配菜单节点的访问权限
3. **自动过滤**: 用户登录后，顶部菜单会根据其角色权限自动过滤可见节点
4. **权限验证**: 即使用户直接访问 URL，后端也会验证权限

**详见**: [ARCH-21-组织与权限体系设计](../design/ARCH-21-组织与权限体系设计.md)

## 技术细节

### 实现文件

- **前端组件**: `src/BobCrm.App/Components/Pages/MenuManagement.razor` (782 行)
- **服务层**: `src/BobCrm.App/Services/MenuService.cs`
- **后端 API**: `src/BobCrm.Api/Endpoints/AccessEndpoints.cs`
- **数据模型**: `src/BobCrm.Api/Base/Models/FunctionNode.cs`

### 关键特性

- **循环依赖检测**: 使用访问集合（HashSet）检测拖拽操作是否会造成循环引用
- **批量排序更新**: 拖拽一个节点会批量更新受影响的所有同级节点的 `SortOrder`
- **多语言支持**: 集成 `MultilingualInput` 组件和 `I18nService`
- **模板绑定**: 支持将菜单节点绑定到动态实体的表单模板

## 下一步规划

v0.7.0 计划增强菜单编辑器功能：

- ✅ **T1**: 完善使用指南文档（本文档）
- ⏳ **T2**: 可视化图标选择器
- ⏳ **T3**: 菜单导入/导出功能
- ⏳ **T4**: 菜单实时预览（保存后自动刷新）
- ⏳ **T5**: 错误处理增强
- ⏳ **T6**: 权限验证测试

**详见**: [PLAN-01-v0.7.0-菜单导航完善](../plans/PLAN-01-v0.7.0-菜单导航完善.md)

## 参考文档

- [ARCH-24-紧凑型顶部菜单导航设计](../design/ARCH-24-紧凑型顶部菜单导航设计.md) - 菜单导航架构设计
- [ARCH-21-组织与权限体系设计](../design/ARCH-21-组织与权限体系设计.md) - 权限体系说明
- [ROADMAP.md](../ROADMAP.md) - 产品路线图

---

**最后更新**: 2025-01-06
**版本**: v0.7.0+
**状态**: 已实现
**评审**: 2025-01-06 架构组评审通过
