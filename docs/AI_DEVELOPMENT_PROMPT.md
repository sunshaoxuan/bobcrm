# BobCRM v0.7.0 å¼€å‘ä»»åŠ¡ - æ¨¡æ¿ç³»ç»Ÿå®Œæ•´é—­ç¯

## é¡¹ç›®æ¦‚è¿°

ä½ æ­£åœ¨ä¸º **BobCRM** é¡¹ç›®å¼€å‘ v0.7.0 ç‰ˆæœ¬çš„**æ ¸å¿ƒåŠŸèƒ½**ï¼š**æ¨¡æ¿ç³»ç»Ÿå®Œæ•´é—­ç¯**ã€‚

**æŠ€æœ¯æ ˆ**ï¼š
- åç«¯ï¼š.NET 8 (C#), Minimal API, EF Core
- å‰ç«¯ï¼šBlazor Server, Ant Design Blazor
- æ•°æ®åº“ï¼šPostgreSQL
- æ¶æ„ï¼šåŠ¨æ€å®ä½“ç³»ç»Ÿã€æ¨¡æ¿é©±åŠ¨UIã€RBACæƒé™

## å½“å‰çŠ¶æ€

âœ… **å·²å®Œæˆ** (T1-T3):
- èœå•ç¼–è¾‘å™¨ä½¿ç”¨æŒ‡å—å®Œå–„
- å›¾æ ‡é€‰æ‹©å™¨ç»„ä»¶
- èœå•å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½

âœ… **v0.7.0 å·²å®Œæˆ** (T4-T7):
- **T4**: è¡¨å•è®¾è®¡å™¨å¢å¼º - æ–°å¢ Cardã€SubForm æ§ä»¶
- **T5**: æ¨¡æ¿ç”Ÿæˆå¢å¼º - æ”¹è¿› List/Detail/Edit æ¨¡æ¿ç”Ÿæˆé€»è¾‘ï¼Œæ·»åŠ  Version å­—æ®µ
- **T6**: æ¨¡æ¿åˆ—è¡¨ç®¡ç† - å®ç°ç­›é€‰ã€å¤åˆ¶ã€åº”ç”¨åŠŸèƒ½
- **T7**: èœå•æ¨¡æ¿å…³è” - PageLoader.razor å·²å®ç°æ¨¡æ¿æ¸²æŸ“ï¼ˆæ— éœ€é¢å¤–å¼€å‘ï¼‰

**ğŸ‰ æ¨¡æ¿ç³»ç»Ÿé—­ç¯å·²å®Œæˆï¼** è®¾è®¡ â†’ åº”ç”¨ â†’ è®¾ç½® â†’ æ˜¾ç¤º âœ…

â¸ï¸ **æ¨è¿Ÿåˆ° v0.8.0**:
- èœå•å®æ—¶é¢„è§ˆä¼˜åŒ–
- èœå•ç¼–è¾‘å™¨é”™è¯¯å¤„ç†å¢å¼º
- èœå•æƒé™éªŒè¯æµ‹è¯•

## æ ¸å¿ƒä»»åŠ¡ï¼šæ¨¡æ¿ç³»ç»Ÿå®Œæ•´é—­ç¯

### ä»€ä¹ˆæ˜¯"æ¨¡æ¿ç³»ç»Ÿé—­ç¯"ï¼Ÿ

å®ç°ä»**è®¾è®¡**åˆ°**åº”ç”¨**åˆ°**è®¾ç½®**åˆ°**æ˜¾ç¤º**çš„å®Œæ•´é“¾è·¯ï¼š

1. **è®¾è®¡**ï¼šè¡¨å•è®¾è®¡å™¨å¼ºåŒ–ï¼Œæ”¯æŒæ‰€æœ‰é¡µé¢çº§æ§ä»¶ï¼ˆT4ï¼‰
2. **åº”ç”¨**ï¼šå®ä½“å‘å¸ƒæ—¶è‡ªåŠ¨ç”Ÿæˆé»˜è®¤æ¨¡æ¿ï¼ˆT5ï¼‰
3. **è®¾ç½®**ï¼šç”¨æˆ·å¯ä»¥ä»ç³»ç»Ÿæ¨¡æ¿å¤åˆ¶ã€ä¿®æ”¹ã€åº”ç”¨ä¸ªæ€§åŒ–æ¨¡æ¿ï¼ˆT6ï¼‰
4. **æ˜¾ç¤º**ï¼šèœå•å¯¼èˆªæ—¶ï¼Œæ ¹æ®å…³è”çš„æ¨¡æ¿åŠ¨æ€æ¸²æŸ“é¡µé¢ï¼ˆT7ï¼‰

### ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ï¼Ÿ

è¿™æ˜¯ BobCRM ä½œä¸º No-Code/Low-Code å¹³å°çš„æ ¸å¿ƒèƒ½åŠ›ï¼š
- ç®¡ç†å‘˜å¯ä»¥ä¸ºæ¯ä¸ªå®ä½“è®¾è®¡ä¸“ä¸šçš„åˆ—è¡¨ã€è¯¦æƒ…ã€ç¼–è¾‘é¡µé¢
- ç”¨æˆ·å¯ä»¥ä¸ªæ€§åŒ–è‡ªå·±çš„å·¥ä½œç•Œé¢
- èœå•å¯¼èˆªä¸æ¨¡æ¿æ¸²æŸ“æ— ç¼é›†æˆ
- çœŸæ­£å®ç°"æ— ä»£ç é…ç½®é¡µé¢"

---

## ä»»åŠ¡æ¸…å•

### T4: è¡¨å•è®¾è®¡å™¨åŠŸèƒ½å¼ºåŒ– (é«˜ä¼˜å…ˆçº§ï¼Œ3-4å¤©)

#### ç›®æ ‡
å¢å¼ºè¡¨å•è®¾è®¡å™¨ï¼Œæ”¯æŒé¡µé¢çº§æ§ä»¶ï¼Œä½¿å…¶æ»¡è¶³çœŸå®ä¸šåŠ¡é¡µé¢çš„éœ€æ±‚ã€‚

#### å½“å‰é—®é¢˜
- ç°æœ‰ 16 ç§æ§ä»¶ä¸»è¦æ˜¯è¡¨å•å­—æ®µçº§åˆ«ï¼ˆTextBox, Select ç­‰ï¼‰
- ç¼ºå°‘é¡µé¢çº§æ§ä»¶ï¼ˆå¦‚ DataGrid åˆ—è¡¨ã€Tab æ ‡ç­¾é¡µã€SubForm ä¸»ä»è¡¨å•ï¼‰
- æ— æ³•è®¾è®¡å¤æ‚çš„ä¸šåŠ¡é¡µé¢

#### æ ¸å¿ƒä»»åŠ¡

##### 4.1 æ–°å¢ DataGrid æ§ä»¶ï¼ˆæœ€é‡è¦ï¼‰

**ç”¨é€”**ï¼šåˆ—è¡¨é¡µé¢çš„æ ¸å¿ƒæ§ä»¶ï¼Œå±•ç¤ºå®ä½“æ•°æ®åˆ—è¡¨

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/BobCrm.App/Models/Widgets/DataGridWidget.cs`

**é…ç½®å±æ€§**ï¼š
```csharp
public class DataGridWidget : BaseWidget
{
    public string EntityType { get; set; } = string.Empty;  // æ•°æ®æºå®ä½“
    public List<DataGridColumn> Columns { get; set; } = new();  // åˆ—é…ç½®
    public List<RowAction> RowActions { get; set; } = new();  // è¡Œæ“ä½œ
    public int PageSize { get; set; } = 20;  // åˆ†é¡µå¤§å°
    public bool ShowSearch { get; set; } = true;  // æ˜¾ç¤ºæœç´¢æ¡†
    public bool ShowPagination { get; set; } = true;  // æ˜¾ç¤ºåˆ†é¡µå™¨
}

public class DataGridColumn
{
    public string FieldName { get; set; }  // å­—æ®µå
    public string Label { get; set; }  // åˆ—æ ‡é¢˜
    public int? Width { get; set; }  // åˆ—å®½åº¦
    public bool Sortable { get; set; } = true;  // å¯æ’åº
}

public class RowAction
{
    public string Label { get; set; }  // æŒ‰é’®æ–‡æœ¬
    public string ActionType { get; set; }  // edit, delete, view, custom
    public string Icon { get; set; }  // å›¾æ ‡
}
```

**è¿è¡Œæ—¶æ¸²æŸ“**ï¼š
- åˆ›å»º `src/BobCrm.App/Components/Runtime/DataGridRuntime.razor`
- è¯»å– `EntityType` å’Œ `Columns` é…ç½®
- è°ƒç”¨å®ä½“ API åŠ è½½æ•°æ®
- æ¸²æŸ“ Ant Design `<Table>` ç»„ä»¶

##### 4.2 æ–°å¢ SubForm æ§ä»¶

**ç”¨é€”**ï¼šä¸»ä»è¡¨å•ï¼Œå¤„ç†ä¸€å¯¹å¤šå…³ç³»ï¼ˆå¦‚è®¢å•-è®¢å•é¡¹ï¼‰

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/BobCrm.App/Models/Widgets/SubFormWidget.cs`

**é…ç½®å±æ€§**ï¼š
```csharp
public class SubFormWidget : BaseWidget
{
    public string RelatedEntityType { get; set; }  // å…³è”å®ä½“
    public string ForeignKeyField { get; set; }  // å¤–é”®å­—æ®µ
    public int? EmbeddedTemplateId { get; set; }  // åµŒå…¥çš„å­è¡¨å•æ¨¡æ¿
}
```

##### 4.3 æ–°å¢ TabContainer æ§ä»¶

**ç”¨é€”**ï¼šå¤šæ ‡ç­¾é¡µå¸ƒå±€

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/BobCrm.App/Models/Widgets/TabContainerWidget.cs`

**é…ç½®å±æ€§**ï¼š
```csharp
public class TabContainerWidget : ContainerWidget
{
    public List<TabItem> Tabs { get; set; } = new();
}

public class TabItem
{
    public string Label { get; set; }  // æ ‡ç­¾æ ‡é¢˜
    public List<BaseWidget> Children { get; set; } = new();  // å­æ§ä»¶
}
```

##### 4.4 æ–°å¢ Card å¡ç‰‡æ§ä»¶

**ç”¨é€”**ï¼šåˆ†ç»„å±•ç¤ºè¡¨å•å­—æ®µ

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/BobCrm.App/Models/Widgets/CardWidget.cs`

**é…ç½®å±æ€§**ï¼š
```csharp
public class CardWidget : ContainerWidget
{
    public string Title { get; set; }  // å¡ç‰‡æ ‡é¢˜
    public bool Collapsible { get; set; } = false;  // å¯æŠ˜å 
    public bool DefaultExpanded { get; set; } = true;  // é»˜è®¤å±•å¼€
}
```

##### 4.5 æ§ä»¶æ³¨å†Œ

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/BobCrm.App/Services/Widgets/WidgetRegistry.cs`

```csharp
// åœ¨é™æ€æ„é€ å‡½æ•°ä¸­æ·»åŠ 
new WidgetDefinition("datagrid", "LBL_DATAGRID", IconType.Outline.Table, WidgetCategory.Data, () => new DataGridWidget()),
new WidgetDefinition("subform", "LBL_SUBFORM", IconType.Outline.Subnode, WidgetCategory.Data, () => new SubFormWidget()),
new WidgetDefinition("tabcontainer", "LBL_TABCONTAINER", IconType.Outline.Tabs, WidgetCategory.Layout, () => new TabContainerWidget()),
new WidgetDefinition("card", "LBL_CARD", IconType.Outline.Container, WidgetCategory.Layout, () => new CardWidget())
```

##### 4.6 è¿è¡Œæ—¶æ¸²æŸ“æ”¯æŒ

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/BobCrm.App/Components/Runtime/RuntimeWidgetRenderer.razor`

æ·»åŠ æ–°æ§ä»¶çš„æ¸²æŸ“åˆ†æ”¯ï¼š
```csharp
case "datagrid":
    <DataGridRuntime Widget="@((DataGridWidget)widget)" Context="@Context" />
    break;
case "subform":
    <SubFormRuntime Widget="@((SubFormWidget)widget)" Context="@Context" />
    break;
// ... å…¶ä»–æ§ä»¶
```

#### éªŒæ”¶æ ‡å‡†
- âœ… 4 ç§æ–°æ§ä»¶å¯åœ¨è®¾è®¡å™¨ä¸­æ‹–æ‹½ä½¿ç”¨
- âœ… æ§ä»¶é…ç½®å±æ€§å¯åœ¨å±æ€§é¢æ¿ç¼–è¾‘
- âœ… æ§ä»¶åœ¨è¿è¡Œæ—¶æ­£ç¡®æ¸²æŸ“
- âœ… DataGrid å¯æ­£å¸¸åŠ è½½å’Œæ˜¾ç¤ºæ•°æ®

#### âœ… å®é™…å®ç° (2025-11-20)

**æ–°å¢æ–‡ä»¶**ï¼š
1. **`src/BobCrm.App/Models/Widgets/CardWidget.cs`**
   - å¡ç‰‡å®¹å™¨æ§ä»¶ï¼Œç”¨äºåˆ†ç»„å±•ç¤ºè¡¨å•å­—æ®µ
   - æ”¯æŒæ ‡é¢˜ï¼ˆTitleï¼‰ã€æ˜¾ç¤º/éšè—æ ‡é¢˜ï¼ˆShowTitleï¼‰
   - å¯æŠ˜å ï¼ˆCollapsibleï¼‰+ é»˜è®¤å±•å¼€çŠ¶æ€ï¼ˆDefaultExpandedï¼‰
   - è‡ªå®šä¹‰æ ·å¼ï¼šèƒŒæ™¯è‰²ã€è¾¹æ¡†ã€åœ†è§’ã€é˜´å½±
   - é»˜è®¤å¸ƒå±€ï¼šåˆ—æ–¹å‘ã€12px gapã€16px padding
   - è®¾è®¡æ€æ˜¾ç¤º"æ‹–æ”¾æ§ä»¶åˆ°è¿™é‡Œ"å ä½ç¬¦

2. **`src/BobCrm.App/Models/Widgets/SubFormWidget.cs`**
   - ä¸»ä»è¡¨å•æ§ä»¶ï¼Œå¤„ç† 1-to-many å…³ç³»ï¼ˆå¦‚è®¢å•â†’è®¢å•é¡¹ï¼‰
   - æ ¸å¿ƒé…ç½®ï¼š
     - `RelatedEntityType`: å­å®ä½“ç±»å‹
     - `ForeignKeyField`: å¤–é”®å­—æ®µå
     - `EmbeddedTemplateId`: åµŒå…¥å¼æ¨¡æ¿ ID
   - æ“ä½œæƒé™ï¼šAllowAddã€AllowEditã€AllowDelete
   - æ˜¾ç¤ºæ¨¡å¼ï¼štableï¼ˆè¡¨æ ¼ï¼‰/ cardsï¼ˆå¡ç‰‡ï¼‰
   - æ”¯æŒæœ€å¤§æ¡ç›®æ•°é™åˆ¶ï¼ˆMaxItemsï¼Œ0=æ— é™åˆ¶ï¼‰

3. **`src/BobCrm.App/Components/Shared/SubFormRuntime.razor`**
   - SubForm è¿è¡Œæ—¶æ¸²æŸ“ç»„ä»¶
   - æ ¹æ® MasterEntityId å’Œ ForeignKeyField è¿‡æ»¤åŠ è½½å­è®°å½•
   - æ”¯æŒæ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤å­è®°å½•
   - è¡¨æ ¼æ¨¡å¼ä½¿ç”¨ Ant Design `<Table>`ï¼Œå¡ç‰‡æ¨¡å¼ä½¿ç”¨ `<Card>`

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- **`src/BobCrm.App/Services/Widgets/WidgetRegistry.cs`**
  - æ³¨å†Œ `card` æ§ä»¶ï¼ˆIconType.Outline.Containerï¼ŒLayout ç±»åˆ«ï¼‰
  - æ³¨å†Œ `subform` æ§ä»¶ï¼ˆIconType.Outline.Subnodeï¼ŒData ç±»åˆ«ï¼‰

**Git æäº¤**ï¼š
```
feat(templates): add Card and SubForm widgets to form designer (T4)

- Add CardWidget for grouping form fields with title, collapse, and border customization
- Add SubFormWidget for master-detail relationships (1-to-many)
- Add SubFormRuntime component for runtime rendering of sub-forms
- Register new widgets in WidgetRegistry
- Support table and card display modes for SubForm
```

**æ³¨æ„**ï¼šDataGrid å’Œ TabContainer æ§ä»¶å·²åœ¨ä¹‹å‰ç‰ˆæœ¬å®ç°ï¼Œæ— éœ€é‡å¤å¼€å‘ã€‚

---

### T5: é»˜è®¤æ¨¡æ¿è‡ªåŠ¨ç”Ÿæˆ (é«˜ä¼˜å…ˆçº§ï¼Œ2-3å¤©)

#### ç›®æ ‡
ä¸ºæ‰€æœ‰å®ä½“è‡ªåŠ¨ç”Ÿæˆ Listï¼ˆåˆ—è¡¨ï¼‰ã€Detailï¼ˆè¯¦æƒ…ï¼‰ã€Editï¼ˆç¼–è¾‘ï¼‰ä¸‰ç§é»˜è®¤æ¨¡æ¿ã€‚

#### å½“å‰çŠ¶å†µ
- `DefaultTemplateGenerator.cs` å·²å­˜åœ¨ï¼Œä½†åªç”Ÿæˆç®€å•çš„ Detail æ¨¡æ¿
- ç¼ºå°‘ List æ¨¡æ¿ç”Ÿæˆ
- ç”Ÿæˆçš„æ¨¡æ¿è¾ƒç®€é™‹ï¼Œç¼ºå°‘å¸ƒå±€ä¼˜åŒ–

#### æ ¸å¿ƒä»»åŠ¡

##### 5.1 å¢å¼º DefaultTemplateGenerator

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/BobCrm.Api/Services/DefaultTemplateGenerator.cs`

##### 5.2 å®ç°åˆ—è¡¨æ¨¡æ¿ç”Ÿæˆ

**æ–°å¢æ–¹æ³•**ï¼š`BuildListTemplate(EntityDefinition entity)`

**æ¨¡æ¿ç»“æ„**ï¼š
```json
{
  "widgets": [
    {
      "type": "section",
      "label": "å·¥å…·æ ",
      "children": [
        {
          "type": "button",
          "label": "æ–°å¢",
          "action": "create",
          "icon": "plus"
        },
        {
          "type": "textbox",
          "id": "search",
          "placeholder": "æœç´¢..."
        }
      ]
    },
    {
      "type": "datagrid",
      "entityType": "customer",
      "columns": [
        { "fieldName": "name", "label": "åç§°", "sortable": true },
        { "fieldName": "email", "label": "é‚®ç®±", "sortable": true },
        // è‡ªåŠ¨é€‰æ‹©å‰ 5-8 ä¸ªå­—æ®µ
      ],
      "rowActions": [
        { "label": "æŸ¥çœ‹", "actionType": "view", "icon": "eye" },
        { "label": "ç¼–è¾‘", "actionType": "edit", "icon": "edit" },
        { "label": "åˆ é™¤", "actionType": "delete", "icon": "delete" }
      ]
    }
  ]
}
```

##### 5.3 ä¼˜åŒ–è¯¦æƒ…/ç¼–è¾‘æ¨¡æ¿

**æ”¹è¿›ç‚¹**ï¼š
- ä½¿ç”¨ Card/Section åˆ†ç»„å­—æ®µï¼ˆæŒ‰å­—æ®µæ ‡ç­¾æˆ–ç±»å‹åˆ†ç»„ï¼‰
- æ™ºèƒ½é€‰æ‹©æ§ä»¶ï¼ˆæ ¹æ®å­—æ®µç±»å‹ï¼‰
- æ·»åŠ é¡¶éƒ¨æ“ä½œæŒ‰é’®ï¼ˆä¿å­˜ã€å–æ¶ˆï¼‰

##### 5.4 æ¨¡æ¿ç”Ÿæˆè§¦å‘

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/BobCrm.Api/Services/EntityDefinitionSynchronizer.cs`

åœ¨ `EnsureTemplatesAndBindingsAsync` æ–¹æ³•ä¸­ï¼š
```csharp
// ç”Ÿæˆä¸‰ç§æ¨¡æ¿
var listTemplate = _defaultTemplateGenerator.BuildListTemplate(entity);
var detailTemplate = _defaultTemplateGenerator.BuildDetailTemplate(entity);
var editTemplate = _defaultTemplateGenerator.BuildEditTemplate(entity);

// æ ‡è®°ä¸ºç³»ç»Ÿé»˜è®¤æ¨¡æ¿
listTemplate.IsSystemDefault = true;
detailTemplate.IsSystemDefault = true;
editTemplate.IsSystemDefault = true;

// ä¿å­˜åˆ°æ•°æ®åº“
await _db.PageTemplates.AddAsync(listTemplate);
await _db.PageTemplates.AddAsync(detailTemplate);
await _db.PageTemplates.AddAsync(editTemplate);
```

##### 5.5 æ•°æ®åº“å˜æ›´

**è¿ç§»è„šæœ¬**ï¼š
```sql
ALTER TABLE "PageTemplates" ADD COLUMN "IsSystemDefault" boolean DEFAULT false;
ALTER TABLE "PageTemplates" ADD COLUMN "Version" integer DEFAULT 1;
ALTER TABLE "PageTemplates" ADD COLUMN "CreatedBy" uuid NULL;
```

**æ‰§è¡Œå‘½ä»¤**ï¼š
```bash
dotnet ef migrations add AddTemplateSystemFields -p src/BobCrm.Api
dotnet ef database update -p src/BobCrm.Api
```

#### éªŒæ”¶æ ‡å‡†
- âœ… æ¯ä¸ªå®ä½“è‡ªåŠ¨ç”Ÿæˆ 3 ç§æ¨¡æ¿
- âœ… åˆ—è¡¨æ¨¡æ¿åŒ…å« DataGrid å’Œå·¥å…·æ 
- âœ… è¯¦æƒ…/ç¼–è¾‘æ¨¡æ¿å­—æ®µåˆç†åˆ†ç»„
- âœ… æ‰€æœ‰æ¨¡æ¿æ ‡è®°ä¸º `IsSystemDefault = true`

#### âœ… å®é™…å®ç° (2025-11-20)

**ä¿®æ”¹æ–‡ä»¶**ï¼š

1. **`src/BobCrm.Api/Base/Models/FormTemplate.cs`**
   - æ·»åŠ  `Version` å­—æ®µï¼š`public int Version { get; set; } = 1;`
   - ç”¨äºè·Ÿè¸ªæ¨¡æ¿å˜æ›´å†å²

2. **`src/BobCrm.Api/Services/DefaultTemplateGenerator.cs`**
   - **List æ¨¡æ¿å¢å¼º**ï¼ˆline 169-249ï¼‰ï¼š
     - æ·»åŠ å·¥å…·æ  Sectionï¼ˆåŒ…å«æ–°å¢æŒ‰é’® + æœç´¢æ¡†ï¼‰
     - DataGrid é™åˆ¶å‰ 8 åˆ—ï¼ˆé¿å…è¿‡å®½ï¼‰
     - è¡Œæ“ä½œï¼šæŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤
     - å¸ƒå±€ï¼štoolbar ä½¿ç”¨ flexbox æ°´å¹³æ’åˆ—ï¼Œgap=12px

   - **Detail/Edit æ¨¡æ¿å¢å¼º**ï¼ˆline 252-355ï¼‰ï¼š
     - Edit æ¨¡å¼æ·»åŠ é¡¶éƒ¨æ“ä½œæŒ‰é’®ï¼ˆä¿å­˜ã€å–æ¶ˆï¼‰
     - æ‰€æœ‰å­—æ®µåŒ…è£¹åœ¨ Card æ§ä»¶ä¸­ï¼ˆtitle="LBL_BASIC_INFO"ï¼‰
     - Card å†…éƒ¨ä½¿ç”¨ flexbox å¸ƒå±€ï¼šflexDirection=row, flexWrap=true, gap=12px
     - å­—æ®µå®½åº¦è®¾ç½®ä¸º 48%ï¼ˆä¸¤åˆ—å¸ƒå±€ï¼‰

   - **ç‰¹å®šå®ä½“ä¸“ç”¨æ§ä»¶**ï¼ˆline 357-398ï¼‰ï¼š
     - User å®ä½“ï¼šè‡ªåŠ¨æ·»åŠ  UserRole æ§ä»¶ï¼ˆè§’è‰²åˆ†é…ï¼‰
     - Role å®ä½“ï¼šè‡ªåŠ¨æ·»åŠ  PermTree æ§ä»¶ï¼ˆæƒé™æ ‘ï¼‰

3. **æ•°æ®åº“è¿ç§»æ–‡æ¡£**ï¼š
   - åˆ›å»º `docs/migrations/MIGRATION-001-AddTemplateVersionField.md`
   - æä¾› EF è¿ç§»å‘½ä»¤å’Œæ‰‹åŠ¨ SQL è„šæœ¬
   - é»˜è®¤å€¼ï¼š`Version = 1`
   - è¿ç§»å‘½ä»¤ï¼š
     ```bash
     dotnet ef migrations add AddTemplateVersionField --project src/BobCrm.Api
     dotnet ef database update --project src/BobCrm.Api
     ```

**Layout JSON ç¤ºä¾‹**ï¼š

**List æ¨¡æ¿**ï¼š
```json
[
  {
    "type": "section",
    "showTitle": false,
    "children": [
      {"type": "button", "label": "BTN_ADD", "action": "create"},
      {"type": "textbox", "placeholder": "MSG_SEARCH_PLACEHOLDER"}
    ],
    "containerLayout": {
      "flexDirection": "row",
      "justifyContent": "space-between",
      "gap": 12
    }
  },
  {
    "type": "datagrid",
    "columnsJson": "[{\"field\":\"name\",\"label\":\"åç§°\",\"width\":150}]",
    "rowActionsJson": "[{\"action\":\"view\"},{\"action\":\"edit\"}]"
  }
]
```

**Detail/Edit æ¨¡æ¿**ï¼š
```json
[
  {
    "type": "card",
    "title": "LBL_BASIC_INFO",
    "children": [
      {"type": "text", "label": "åç§°", "dataField": "name", "width": 48}
    ],
    "containerLayout": {
      "flexDirection": "row",
      "flexWrap": true,
      "gap": 12
    }
  }
]
```

**Git æäº¤**ï¼š
```
feat(templates): enhance form designer and template generation system (T4-T5)

T4 - Form Designer Enhancement:
- Add CardWidget for grouping form fields with title, collapse, and customization
- Add SubFormWidget for master-detail relationships (1-to-many)
- Add SubFormRuntime component for runtime rendering
- Register new widgets in WidgetRegistry

T5 - Template Generation Enhancement:
- Add FormTemplate.Version field for change tracking
- Enhance List template: toolbar section + DataGrid with 8 columns + row actions
- Enhance Detail/Edit templates: wrap fields in Card + action buttons for Edit mode
- Add entity-specific widgets (UserRole for User, PermTree for Role)
- Create migration documentation for Version field
```

**å…³é”®æ”¹è¿›**ï¼š
- List æ¨¡æ¿æ›´ç¾è§‚ï¼Œå·¥å…·æ ä¸æ•°æ®åˆ†ç¦»
- Detail/Edit æ¨¡æ¿ä½¿ç”¨ Card åˆ†ç»„ï¼Œè§†è§‰å±‚æ¬¡æ¸…æ™°
- é™åˆ¶åˆ—æ•°é¿å…æ¨ªå‘æ»šåŠ¨
- è‡ªåŠ¨ä¸ºç³»ç»Ÿå®ä½“æ·»åŠ ä¸“ç”¨æ§ä»¶

---

### T6: æ¨¡æ¿åˆ—è¡¨ç®¡ç†ç³»ç»Ÿ (é«˜ä¼˜å…ˆçº§ï¼Œ3-4å¤©)

#### ç›®æ ‡
å®ç°å®Œæ•´çš„æ¨¡æ¿ç®¡ç†ç•Œé¢ï¼Œæ”¯æŒæŸ¥çœ‹ã€å¤åˆ¶ã€åº”ç”¨æ¨¡æ¿ï¼ŒåŒºåˆ†ç³»ç»Ÿæ¨¡æ¿å’Œç”¨æˆ·æ¨¡æ¿ã€‚

#### æ ¸å¿ƒéœ€æ±‚

**æ¨¡æ¿ç±»å‹**ï¼š
1. **ç³»ç»Ÿé»˜è®¤æ¨¡æ¿**ï¼š
   - è‡ªåŠ¨ç”Ÿæˆï¼Œ`IsSystemDefault = true`
   - ä»…ç®¡ç†å‘˜å¯ä¿®æ”¹
   - ä¸å¯åˆ é™¤
2. **ç”¨æˆ·æ¨¡æ¿**ï¼š
   - ç”¨æˆ·ä»ç³»ç»Ÿæ¨¡æ¿å¤åˆ¶åˆ›å»º
   - å¯è‡ªç”±ä¿®æ”¹å’Œåˆ é™¤
   - åªå¯¹åˆ›å»ºè€…å¯è§

#### æ ¸å¿ƒä»»åŠ¡

##### 6.1 åç«¯ API

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/BobCrm.Api/Endpoints/TemplateEndpoints.cs`

**API ç«¯ç‚¹**ï¼š
```csharp
app.MapGet("/api/templates", async (
    string? entityType,
    string? purpose,
    string? templateType,  // "system" or "user"
    TemplateService service,
    ClaimsPrincipal user) => 
{
    var userId = user.GetUserId();
    var templates = await service.GetTemplatesAsync(entityType, purpose, templateType, userId);
    return Results.Ok(templates);
});

app.MapPost("/api/templates/{id}/copy", async (
    int id,
    CopyTemplateRequest request,
    TemplateService service,
    ClaimsPrincipal user) =>
{
    var userId = user.GetUserId();
    var newTemplate = await service.CopyTemplateAsync(id, request.Name, userId);
    return Results.Ok(newTemplate);
});

app.MapPut("/api/templates/{id}/apply", async (
    int id,
    string? functionCode,  // å¯é€‰ï¼šåº”ç”¨åˆ°ç‰¹å®šèœå•èŠ‚ç‚¹
    TemplateBindingService bindingService,
    ClaimsPrincipal user) =>
{
    var userId = user.GetUserId();
    await bindingService.SetUserTemplateAsync(userId, id, functionCode);
    return Results.NoContent();
});

app.MapDelete("/api/templates/{id}", async (
    int id,
    TemplateService service,
    ClaimsPrincipal user) =>
{
    // æ£€æŸ¥æ˜¯å¦ä¸ºç³»ç»Ÿæ¨¡æ¿
    var template = await service.GetByIdAsync(id);
    if (template.IsSystemDefault)
        return Results.BadRequest("ä¸èƒ½åˆ é™¤ç³»ç»Ÿé»˜è®¤æ¨¡æ¿");
    
    await service.DeleteAsync(id);
    return Results.NoContent();
});
```

##### 6.2 å‰ç«¯æ¨¡æ¿åˆ—è¡¨é¡µ

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/BobCrm.App/Components/Pages/TemplateList.razor`

**é¡µé¢è·¯ç”±**ï¼š`@page "/templates"`

**é¡µé¢å¸ƒå±€**ï¼š
```razor
<PageHeader Title="@I18n.T("MENU_TEMPLATES")" />

<!-- ç­›é€‰å™¨ -->
<div class="filters">
    <Select @bind-Value="entityTypeFilter" Placeholder="å®ä½“ç±»å‹">
        <SelectOption Value="">å…¨éƒ¨</SelectOption>
        @foreach (var entity in entities)
        {
            <SelectOption Value="@entity.EntityRoute">@entity.DisplayName</SelectOption>
        }
    </Select>
    
    <Select @bind-Value="purposeFilter" Placeholder="ç”¨é€”">
        <SelectOption Value="">å…¨éƒ¨</SelectOption>
        <SelectOption Value="List">åˆ—è¡¨</SelectOption>
        <SelectOption Value="Detail">è¯¦æƒ…</SelectOption>
        <SelectOption Value="Edit">ç¼–è¾‘</SelectOption>
    </Select>
    
    <Select @bind-Value="templateTypeFilter" Placeholder="ç±»å‹">
        <SelectOption Value="">å…¨éƒ¨</SelectOption>
        <SelectOption Value="system">ç³»ç»Ÿæ¨¡æ¿</SelectOption>
        <SelectOption Value="user">æˆ‘çš„æ¨¡æ¿</SelectOption>
    </Select>
</div>

<!-- æ¨¡æ¿å¡ç‰‡ç½‘æ ¼ -->
<div class="template-grid">
    @foreach (var template in filteredTemplates)
    {
        <div class="template-card">
            <div class="card-header">
                <h3>@template.Name</h3>
                @if (template.IsSystemDefault)
                {
                    <Tag Color="blue">ç³»ç»Ÿ</Tag>
                    <Icon Type="@IconType.Outline.Lock" />
                }
                else
                {
                    <Tag Color="green">æˆ‘çš„</Tag>
                }
            </div>
            <div class="card-body">
                <p>å®ä½“: @template.EntityType</p>
                <p>ç”¨é€”: @template.Purpose</p>
            </div>
            <div class="card-actions">
                <Button Icon="@IconType.Outline.Eye" OnClick="() => ViewTemplate(template)">é¢„è§ˆ</Button>
                @if (!template.IsSystemDefault || IsAdmin)
                {
                    <Button Icon="@IconType.Outline.Edit" OnClick="() => EditTemplate(template)">ç¼–è¾‘</Button>
                }
                <Button Icon="@IconType.Outline.Copy" OnClick="() => CopyTemplate(template)">å¤åˆ¶</Button>
                <Button Type="@ButtonType.Primary" OnClick="() => ApplyTemplate(template)">åº”ç”¨</Button>
                @if (!template.IsSystemDefault)
                {
                    <Popconfirm Title="ç¡®è®¤åˆ é™¤?" OnConfirm="() => DeleteTemplate(template)">
                        <Button Danger Icon="@IconType.Outline.Delete">åˆ é™¤</Button>
                    </Popconfirm>
                }
            </div>
        </div>
    }
</div>
```

##### 6.3 æ¨¡æ¿å¤åˆ¶å¯¹è¯æ¡†

```razor
<Modal @bind-Visible="copyDialogVisible" Title="å¤åˆ¶æ¨¡æ¿">
    <Form>
        <FormItem Label="æ–°æ¨¡æ¿åç§°">
            <Input @bind-Value="copyTemplateName" />
        </FormItem>
        <FormItem Label="ç”¨é€”">
            <Select @bind-Value="copyTemplatePurpose">
                <SelectOption Value="@sourceTemplate.Purpose">ä¿æŒåŸæ ·</SelectOption>
                <SelectOption Value="List">åˆ—è¡¨</SelectOption>
                <SelectOption Value="Detail">è¯¦æƒ…</SelectOption>
                <SelectOption Value="Edit">ç¼–è¾‘</SelectOption>
            </Select>
        </FormItem>
    </Form>
</Modal>
```

##### 6.4 æ•°æ®åº“å˜æ›´

**TemplateBinding è¡¨æ·»åŠ  UserId**ï¼š
```sql
ALTER TABLE "TemplateBindings" ADD COLUMN "UserId" uuid NULL;
```

#### éªŒæ”¶æ ‡å‡†
- âœ… æ¨¡æ¿åˆ—è¡¨é¡µé¢æ­£å¸¸æ˜¾ç¤º
- âœ… å¯æŒ‰å®ä½“ã€ç”¨é€”ã€ç±»å‹ç­›é€‰
- âœ… å¯ä»ç³»ç»Ÿæ¨¡æ¿å¤åˆ¶ä¸ºç”¨æˆ·æ¨¡æ¿
- âœ… ç³»ç»Ÿæ¨¡æ¿æ˜¾ç¤ºé”å®šå›¾æ ‡ï¼Œä¸æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
- âœ… ç”¨æˆ·å¯åº”ç”¨æ¨¡æ¿

#### âœ… å®é™…å®ç° (2025-11-20)

**ä¿®æ”¹æ–‡ä»¶**ï¼š

1. **`src/BobCrm.Api/Endpoints/TemplateEndpoints.cs`**

   **å¢å¼ºæŸ¥è¯¢è¿‡æ»¤**ï¼ˆline ~50-90ï¼‰ï¼š
   - æ·»åŠ  `usageType` å‚æ•°ï¼šè¿‡æ»¤ List/Detail/Edit æ¨¡æ¿
   - æ·»åŠ  `templateType` å‚æ•°ï¼šè¿‡æ»¤ system/user æ¨¡æ¿
   - æ”¯æŒç»„åˆè¿‡æ»¤ï¼š`/api/templates?entityType=customer&usageType=List&templateType=system`

   **å¤åˆ¶æ¨¡æ¿ç«¯ç‚¹**ï¼ˆ`POST /api/templates/{id}/copy`ï¼‰ï¼š
   ```csharp
   // Request DTO
   public record CopyTemplateRequest(
       string? Name,
       string? EntityType,
       FormTemplateUsageType? UsageType,
       string? Description);

   // é€»è¾‘
   - ä»æºæ¨¡æ¿å¤åˆ¶ LayoutJson
   - è®¾ç½® UserId = å½“å‰ç”¨æˆ·
   - IsUserDefault = falseï¼ˆä¸è‡ªåŠ¨è®¾ä¸ºé»˜è®¤ï¼‰
   - IsSystemDefault = falseï¼ˆç”¨æˆ·ä¸èƒ½åˆ›å»ºç³»ç»Ÿæ¨¡æ¿ï¼‰
   - Version = 1ï¼ˆæ–°æ¨¡æ¿ä»ç‰ˆæœ¬1å¼€å§‹ï¼‰
   ```

   **åº”ç”¨æ¨¡æ¿ç«¯ç‚¹**ï¼ˆ`PUT /api/templates/{id}/apply`ï¼‰ï¼š
   ```csharp
   // é€»è¾‘
   1. æ£€æŸ¥æ˜¯å¦ä¸ºç³»ç»Ÿæ¨¡æ¿
      - å¦‚æœæ˜¯ç³»ç»Ÿæ¨¡æ¿ â†’ è‡ªåŠ¨å¤åˆ¶ä¸ºç”¨æˆ·æ¨¡æ¿ï¼ˆcopy-on-writeï¼‰
      - å¦‚æœæ˜¯ç”¨æˆ·æ¨¡æ¿ â†’ ç›´æ¥åº”ç”¨

   2. æ¸…é™¤åŒä¸€å®ä½“ç±»å‹+ç”¨é€”çš„å…¶ä»–é»˜è®¤æ¨¡æ¿
      - æŸ¥è¯¢ userId + entityType + usageType + isUserDefault
      - æ‰¹é‡è®¾ç½® IsUserDefault = false

   3. è®¾ç½®ç›®æ ‡æ¨¡æ¿ä¸ºç”¨æˆ·é»˜è®¤
      - template.IsUserDefault = true
   ```

2. **`src/BobCrm.App/Components/Pages/Templates.razor`**

   **ç­›é€‰é¢æ¿**ï¼ˆline ~30-60ï¼‰ï¼š
   ```razor
   <select @onchange="OnFilterChanged" name="usageType">
       <option value="">å…¨éƒ¨ç”¨é€”</option>
       <option value="List">åˆ—è¡¨</option>
       <option value="Detail">è¯¦æƒ…</option>
       <option value="Edit">ç¼–è¾‘</option>
   </select>

   <select @onchange="OnFilterChanged" name="templateType">
       <option value="">å…¨éƒ¨ç±»å‹</option>
       <option value="system">ç³»ç»Ÿæ¨¡æ¿</option>
       <option value="user">ç”¨æˆ·æ¨¡æ¿</option>
   </select>

   <input type="text" placeholder="æœç´¢æ¨¡æ¿åç§°..."
          @bind="searchKeyword" @onkeyup="OnSearchChanged" />
   ```

   **æ¨¡æ¿å¡ç‰‡å¢å¼º**ï¼ˆline ~80-150ï¼‰ï¼š
   - æ˜¾ç¤ºç”¨é€”æ ‡ç­¾ï¼ˆList/Detail/Editï¼‰+ å½©è‰² badge
   - ç³»ç»Ÿæ¨¡æ¿æ˜¾ç¤ºé”å®šå›¾æ ‡ï¼ˆğŸ”’ï¼‰ï¼Œç¦ç”¨ç¼–è¾‘æŒ‰é’®
   - ç”¨æˆ·é»˜è®¤æ¨¡æ¿æ˜¾ç¤ºæ˜Ÿæ ‡ï¼ˆâ­ï¼‰
   - æ“ä½œæŒ‰é’®ï¼š
     - âœï¸ ç¼–è¾‘ï¼ˆç³»ç»Ÿæ¨¡æ¿ç¦ç”¨ï¼‰
     - ğŸ“‹ å¤åˆ¶ï¼ˆæ‰€æœ‰æ¨¡æ¿å¯ç”¨ï¼‰
     - âœ“ åº”ç”¨ï¼ˆéé»˜è®¤æ¨¡æ¿å¯ç”¨ï¼‰
     - ğŸ—‘ï¸ åˆ é™¤ï¼ˆç³»ç»Ÿæ¨¡æ¿ç¦ç”¨ï¼‰

   **å¤åˆ¶æ¨¡æ¿å®ç°**ï¼ˆline ~200-230ï¼‰ï¼š
   ```csharp
   private async Task CopyTemplate(int templateId)
   {
       var newName = await JS.InvokeAsync<string>("prompt",
           $"è¯·è¾“å…¥æ–°æ¨¡æ¿åç§°:", $"{template.Name} (å‰¯æœ¬)");

       var payload = new
       {
           name = newName,
           entityType = template.EntityType,
           usageType = template.UsageType,
           description = $"ä» '{template.Name}' å¤åˆ¶"
       };

       var resp = await client.PostAsJsonAsync($"/api/templates/{templateId}/copy", payload);
       // æˆåŠŸååˆ·æ–°åˆ—è¡¨
   }
   ```

   **åº”ç”¨æ¨¡æ¿å®ç°**ï¼ˆline ~230-260ï¼‰ï¼š
   ```csharp
   private async Task ApplyTemplate(int templateId)
   {
       var confirm = await JS.InvokeAsync<bool>("confirm",
           $"ç¡®å®šè¦å°† '{template.Name}' è®¾ç½®ä¸ºé»˜è®¤æ¨¡æ¿å—ï¼Ÿ\nè¿™å°†æ›¿æ¢å½“å‰çš„é»˜è®¤æ¨¡æ¿ã€‚");

       var resp = await client.PutAsync($"/api/templates/{templateId}/apply", null);
       // æˆåŠŸåæ˜¾ç¤º Toast é€šçŸ¥
   }
   ```

   **è¾…åŠ©æ–¹æ³•**ï¼ˆline ~260-290ï¼‰ï¼š
   ```csharp
   private string GetUsageDisplayName(FormTemplateUsageType usageType)
       => usageType switch
       {
           FormTemplateUsageType.List => "åˆ—è¡¨",
           FormTemplateUsageType.Detail => "è¯¦æƒ…",
           FormTemplateUsageType.Edit => "ç¼–è¾‘",
           _ => usageType.ToString()
       };

   private string GetUsageBadgeClass(FormTemplateUsageType usageType)
       => usageType switch
       {
           FormTemplateUsageType.List => "badge badge-primary",
           FormTemplateUsageType.Detail => "badge badge-success",
           FormTemplateUsageType.Edit => "badge badge-warning",
           _ => "badge"
       };
   ```

**Git æäº¤**ï¼š
```
feat(templates): implement template management system (T6)

Backend (TemplateEndpoints.cs):
- Add usageType and templateType query filters
- Implement POST /api/templates/{id}/copy endpoint
- Implement PUT /api/templates/{id}/apply endpoint with copy-on-write for system templates
- Auto-clear existing user defaults when applying new default

Frontend (Templates.razor):
- Add comprehensive filter panel (usage, type, keyword search)
- Enhance template cards with usage badges and status icons
- Implement copy template dialog with user input
- Implement apply template with confirmation
- Add helper methods for display names and badge classes
- Show lock icon for system templates, disable edit/delete
- Show star icon for user default templates
```

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- **Copy-on-Write**ï¼šåº”ç”¨ç³»ç»Ÿæ¨¡æ¿æ—¶è‡ªåŠ¨å¤åˆ¶ä¸ºç”¨æˆ·æ¨¡æ¿ï¼Œä¿æŠ¤ç³»ç»Ÿé»˜è®¤
- **æ™ºèƒ½è¿‡æ»¤**ï¼šæ”¯æŒå¤šç»´åº¦ç»„åˆç­›é€‰ï¼ˆå®ä½“+ç”¨é€”+ç±»å‹+å…³é”®è¯ï¼‰
- **é»˜è®¤ç®¡ç†**ï¼šæ¯ä¸ªå®ä½“+ç”¨é€”åªèƒ½æœ‰ä¸€ä¸ªç”¨æˆ·é»˜è®¤æ¨¡æ¿
- **æƒé™æ§åˆ¶**ï¼šç³»ç»Ÿæ¨¡æ¿åªè¯»ï¼Œç”¨æˆ·æ¨¡æ¿å¯ç¼–è¾‘åˆ é™¤
- **è§†è§‰åé¦ˆ**ï¼šå½©è‰² badge åŒºåˆ†ç”¨é€”ï¼Œå›¾æ ‡æ ‡è¯†æ¨¡æ¿çŠ¶æ€

---

### T7: èœå•æ¨¡æ¿å…³è”ä¸æ¸²æŸ“ (é«˜ä¼˜å…ˆçº§ï¼Œ2-3å¤©)

#### ç›®æ ‡
å®ç°èœå•å¯¼èˆªä¸æ¨¡æ¿æ¸²æŸ“çš„æ— ç¼é›†æˆï¼Œå®Œæˆ"è®¾è®¡-åº”ç”¨-è®¾ç½®-æ˜¾ç¤º"é—­ç¯ã€‚

#### æ ¸å¿ƒä»»åŠ¡

##### 7.1 ç»Ÿä¸€æ¨¡æ¿æ¸²æŸ“é¡µé¢

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/BobCrm.App/Components/Pages/TemplatePage.razor`

**è·¯ç”±**ï¼š`@page "/page/{FunctionCode}"`

**é€»è¾‘**ï¼š
```csharp
protected override async Task OnInitializedAsync()
{
    // 1. æ ¹æ®åŠŸèƒ½ç æŸ¥è¯¢èœå•èŠ‚ç‚¹
    var function = await MenuService.GetByCodeAsync(FunctionCode);
    if (function == null)
    {
        error = "èœå•èŠ‚ç‚¹ä¸å­˜åœ¨";
        return;
    }
    
    // 2. æŸ¥è¯¢å…³è”çš„æ¨¡æ¿ï¼ˆä¼˜å…ˆç”¨æˆ·æ¨¡æ¿ï¼‰
    var template = await GetEffectiveTemplateAsync(function.TemplateId);
    if (template == null)
    {
        error = "æœªæ‰¾åˆ°å…³è”çš„æ¨¡æ¿";
        return;
    }
    
    // 3. æ ¹æ®æ¨¡æ¿ç”¨é€”æ¸²æŸ“ä¸åŒé¡µé¢
    templatePurpose = template.Purpose;
    templateId = template.Id;
    entityType = template.EntityType;
    
    // 4. åŠ è½½æ¨¡æ¿å¸ƒå±€
    layoutJson = template.LayoutJson;
}

private async Task<PageTemplate?> GetEffectiveTemplateAsync(int? systemTemplateId)
{
    if (systemTemplateId == null)
        return null;
    
    var userId = _currentUser.GetUserId();
    
    // ä¼˜å…ˆæŸ¥è¯¢ç”¨æˆ·ä¸ªäººæ¨¡æ¿ç»‘å®š
    var userBinding = await _db.TemplateBindings
        .Where(b => b.UserId == userId && b.TemplateId == systemTemplateId)
        .Include(b => b.UserTemplate)
        .FirstOrDefaultAsync();
    
    if (userBinding?.UserTemplate != null)
        return userBinding.UserTemplate;
    
    // å›é€€åˆ°ç³»ç»Ÿé»˜è®¤æ¨¡æ¿
    return await _db.PageTemplates
        .FirstOrDefaultAsync(t => t.Id == systemTemplateId);
}
```

##### 7.2 DataGrid è¿è¡Œæ—¶æ¸²æŸ“

**åˆ›å»ºæ–‡ä»¶**ï¼š`src/BobCrm.App/Components/Runtime/DataGridRuntime.razor`

**åŠŸèƒ½**ï¼š
- è¯»å– `DataGridWidget` é…ç½®
- è°ƒç”¨å®ä½“ API åŠ è½½æ•°æ®
- æ¸²æŸ“ Ant Design `<Table>` ç»„ä»¶
- å¤„ç†è¡Œæ“ä½œï¼ˆæŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤ï¼‰

```csharp
<Table TItem="Dictionary<string, object?>"
       DataSource="@data"
       Loading="@loading"
       RemoteDataSource>
    <PropertyColumn Property="@(item => item[col.FieldName])" 
                    Title="@col.Label"
                    Width="@col.Width"
                    Sortable="@col.Sortable"
                    foreach var col in Widget.Columns />
    
    <ActionColumn Title="æ“ä½œ">
        @foreach (var action in Widget.RowActions)
        {
            <Button Icon="@action.Icon" OnClick="() => HandleRowAction(action, context)">
                @action.Label
            </Button>
        }
    </ActionColumn>
</Table>
```

##### 7.3 æ¨¡æ¿ä¸Šä¸‹æ–‡ä¼ é€’

**æ‰©å±• RuntimeContext**ï¼š
```csharp
public class RuntimeContext
{
    public int TemplateId { get; set; }
    public string TemplatePurpose { get; set; }  // List, Detail, Edit
    public string EntityType { get; set; }
    public int? EntityId { get; set; }  // Detail/Edit æ¨¡å¼
    public Dictionary<string, object?> EntityData { get; set; }  // å®ä½“æ•°æ®
}
```

##### 7.4 ç”¨æˆ·æ¨¡æ¿ç»‘å®š

**æ–°å¢æ¨¡å‹**ï¼š`src/BobCrm.Api/Base/Models/UserTemplatePreference.cs`

```csharp
public class UserTemplatePreference
{
    public int Id { get; set; }
    public Guid UserId { get; set; }
    public string? FunctionCode { get; set; }  // å¯é€‰ï¼šç»‘å®šåˆ°ç‰¹å®šèœå•
    public int SystemTemplateId { get; set; }  // ç³»ç»Ÿé»˜è®¤æ¨¡æ¿
    public int UserTemplateId { get; set; }  // ç”¨æˆ·ä¸ªäººæ¨¡æ¿
}
```

#### éªŒæ”¶æ ‡å‡†
- âœ… èœå•å¯¼èˆªå¯è·³è½¬åˆ°æ¨¡æ¿æ¸²æŸ“é¡µ
- âœ… List æ¨¡æ¿æ­£ç¡®æ¸²æŸ“ DataGrid
- âœ… Detail/Edit æ¨¡æ¿æ­£ç¡®æ¸²æŸ“è¡¨å•
- âœ… ç”¨æˆ·æ¨¡æ¿ä¼˜å…ˆäºç³»ç»Ÿé»˜è®¤æ¨¡æ¿
- âœ… æ¨¡æ¿å˜æ›´ç«‹å³ç”Ÿæ•ˆ

#### å®é™…å®ç°è¯´æ˜

**æ³¨æ„**ï¼šT7 åŠŸèƒ½å·²åœ¨ç°æœ‰ä»£ç ä¸­å®ç°ï¼Œæ— éœ€é¢å¤–å¼€å‘ã€‚

**ç°æœ‰å®ç°**ï¼š`src/BobCrm.App/Components/Pages/PageLoader.razor`

**åŠŸèƒ½è¦†ç›–**ï¼š
1. âœ… **æ¨¡æ¿åŠ è½½**ï¼šé€šè¿‡ `/api/templates/effective/{entityType}` API åŠ è½½æœ‰æ•ˆæ¨¡æ¿
   - ä¼˜å…ˆçº§ï¼šç”¨æˆ·é»˜è®¤æ¨¡æ¿ â†’ ç³»ç»Ÿé»˜è®¤æ¨¡æ¿ â†’ ç¬¬ä¸€ä¸ªåˆ›å»ºçš„æ¨¡æ¿
   - å›é€€åˆ° UserLayout APIï¼ˆå…¼å®¹æ—§ç³»ç»Ÿï¼‰

2. âœ… **è¿è¡Œæ—¶æ¸²æŸ“**ï¼š
   - è§£æ LayoutJson ä¸º Widget æ ‘
   - ä½¿ç”¨ `RuntimeContext` ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆEntityType, EntityId, Modeï¼‰
   - æ”¯æŒ Browse/Edit æ¨¡å¼åˆ‡æ¢

3. âœ… **Widget è¿è¡Œæ—¶ç»„ä»¶**ï¼š
   - DataGridï¼šå·²å®ç°æ•°æ®åŠ è½½ã€åˆ†é¡µã€æ’åºã€è¡Œæ“ä½œ
   - Form æ§ä»¶ï¼šå·²å®ç°æ•°æ®ç»‘å®šå’ŒéªŒè¯
   - å®¹å™¨æ§ä»¶ï¼šå·²å®ç°åµŒå¥—å¸ƒå±€

**è·¯ç”±é›†æˆ**ï¼š
- èœå•èŠ‚ç‚¹é€šè¿‡å®ä½“è·¯ç”±ï¼ˆå¦‚ `/{EntityType}/{Id}`ï¼‰å¯¼èˆªåˆ° PageLoader
- PageLoader æ ¹æ®è·¯ç”±å‚æ•°åŠ è½½å¯¹åº”çš„æ¨¡æ¿å’Œå®ä½“æ•°æ®

**å·®å¼‚è¯´æ˜**ï¼š
- åŸè®¡åˆ’åˆ›å»ºç‹¬ç«‹çš„ `TemplatePage.razor`ï¼Œä½†å®é™… PageLoader å·²æä¾›ç›¸åŒåŠŸèƒ½
- åŸè®¡åˆ’çš„ `UserTemplatePreference` æ¨¡å‹æœªåˆ›å»ºï¼Œè€Œæ˜¯ä½¿ç”¨ FormTemplate çš„ `IsUserDefault` æ ‡è®°å®ç°ç”¨æˆ·åå¥½

**ç»“è®º**ï¼šT7 çš„æ ¸å¿ƒåŠŸèƒ½"èœå•å¯¼èˆª â†’ æ¨¡æ¿åŠ è½½ â†’ åŠ¨æ€æ¸²æŸ“"å·²å®Œæ•´å®ç°ï¼Œæ¨¡æ¿ç³»ç»Ÿé—­ç¯å·²æ‰“é€šã€‚

---

## å¼€å‘è§„èŒƒ

å‚è€ƒ `CLAUDE.md` ä¸­çš„é¡¹ç›®è§„èŒƒï¼š

- **å‘½å**ï¼šPascalCaseï¼ˆæ–‡ä»¶åã€ç±»åï¼‰ï¼ŒcamelCaseï¼ˆå˜é‡ï¼‰
- **å¤šè¯­è¨€**ï¼šæ‰€æœ‰ç”¨æˆ·å¯è§æ–‡æœ¬ä½¿ç”¨ `I18n.T("KEY")`
- **Git æäº¤**ï¼š`feat(<scope>): <subject>`

## éªŒæ”¶æ€»ç»“

å®Œæˆ T4-T7 åï¼Œåº”å®ç°ï¼š

1. âœ… **è¡¨å•è®¾è®¡å™¨**æ”¯æŒæ‰€æœ‰é¡µé¢çº§æ§ä»¶
2. âœ… **å®ä½“å‘å¸ƒ**æ—¶è‡ªåŠ¨ç”Ÿæˆ List/Detail/Edit æ¨¡æ¿
3. âœ… **æ¨¡æ¿åˆ—è¡¨é¡µ**å¯æŸ¥çœ‹ã€å¤åˆ¶ã€åº”ç”¨æ¨¡æ¿
4. âœ… **èœå•å¯¼èˆª**æ—¶æ ¹æ®æ¨¡æ¿æ¸²æŸ“é¡µé¢
5. âœ… **ç”¨æˆ·å¯ä»¥**ä¸ªæ€§åŒ–è‡ªå·±çš„é¡µé¢æ˜¾ç¤º

**é—­ç¯å®Œæˆ**ï¼šè®¾è®¡ â†’ åº”ç”¨ â†’ è®¾ç½® â†’ æ˜¾ç¤º âœ¨

---

## ğŸ‰ v0.7.0 å¼€å‘å®Œæˆæ€»ç»“

**å®Œæˆæ—¥æœŸ**ï¼š2025-11-20

### å®æ–½æ¦‚è§ˆ

| ä»»åŠ¡ | è®¡åˆ’æ—¶é—´ | å®é™…çŠ¶æ€ | ä¸»è¦äº§å‡º |
|------|----------|----------|----------|
| T4: è¡¨å•è®¾è®¡å™¨å¢å¼º | 3-4å¤© | âœ… å®Œæˆ | CardWidget, SubFormWidget, SubFormRuntime |
| T5: æ¨¡æ¿ç”Ÿæˆå¢å¼º | 2-3å¤© | âœ… å®Œæˆ | å¢å¼º DefaultTemplateGenerator, Version å­—æ®µ, è¿ç§»æ–‡æ¡£ |
| T6: æ¨¡æ¿åˆ—è¡¨ç®¡ç† | 3-4å¤© | âœ… å®Œæˆ | ç­›é€‰/å¤åˆ¶/åº”ç”¨ç«¯ç‚¹, Templates.razor å¢å¼º |
| T7: èœå•æ¨¡æ¿å…³è” | 2-3å¤© | âœ… å·²æœ‰å®ç° | PageLoader.razor æä¾›å®Œæ•´åŠŸèƒ½ |

### æ ¸å¿ƒæˆæœ

#### 1. æ–°å¢æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰
- `src/BobCrm.App/Models/Widgets/CardWidget.cs` - å¡ç‰‡å®¹å™¨æ§ä»¶
- `src/BobCrm.App/Models/Widgets/SubFormWidget.cs` - ä¸»ä»è¡¨å•æ§ä»¶
- `src/BobCrm.App/Components/Shared/SubFormRuntime.razor` - SubForm è¿è¡Œæ—¶ç»„ä»¶
- `docs/migrations/MIGRATION-001-AddTemplateVersionField.md` - Version å­—æ®µè¿ç§»æ–‡æ¡£

#### 2. ä¿®æ”¹æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰
- `src/BobCrm.App/Services/Widgets/WidgetRegistry.cs` - æ³¨å†Œæ–°æ§ä»¶
- `src/BobCrm.Api/Base/Models/FormTemplate.cs` - æ·»åŠ  Version å­—æ®µ
- `src/BobCrm.Api/Services/DefaultTemplateGenerator.cs` - å¢å¼ºæ¨¡æ¿ç”Ÿæˆé€»è¾‘
- `src/BobCrm.Api/Endpoints/TemplateEndpoints.cs` - æ·»åŠ ç­›é€‰/å¤åˆ¶/åº”ç”¨ç«¯ç‚¹
- `src/BobCrm.App/Components/Pages/Templates.razor` - æ¨¡æ¿ç®¡ç†é¡µé¢å¢å¼º

#### 3. Git æäº¤ï¼ˆ2ä¸ªï¼‰
1. **feat(templates): enhance form designer and template generation system (T4-T5)**
   - æ–°å¢ Card å’Œ SubForm æ§ä»¶
   - å¢å¼º List/Detail/Edit æ¨¡æ¿ç”Ÿæˆ
   - æ·»åŠ  Version å­—æ®µå’Œè¿ç§»æ–‡æ¡£

2. **feat(templates): implement template management system (T6)**
   - å®ç°æ¨¡æ¿ç­›é€‰ã€å¤åˆ¶ã€åº”ç”¨åŠŸèƒ½
   - Copy-on-Write æ¨¡å¼ä¿æŠ¤ç³»ç»Ÿæ¨¡æ¿
   - æ™ºèƒ½é»˜è®¤æ¨¡æ¿ç®¡ç†

### æŠ€æœ¯äº®ç‚¹

1. **Copy-on-Write æ¨¡å¼**ï¼šåº”ç”¨ç³»ç»Ÿæ¨¡æ¿æ—¶è‡ªåŠ¨å¤åˆ¶ä¸ºç”¨æˆ·æ¨¡æ¿ï¼Œç¡®ä¿ç³»ç»Ÿé»˜è®¤ä¸è¢«ä¿®æ”¹
2. **ç‰ˆæœ¬è·Ÿè¸ª**ï¼šFormTemplate.Version å­—æ®µä¸ºæœªæ¥æ¨¡æ¿å†å²è®°å½•åŠŸèƒ½æ‰“ä¸‹åŸºç¡€
3. **æ™ºèƒ½å¸ƒå±€**ï¼š
   - List æ¨¡æ¿ï¼šToolbar + DataGridï¼ˆé™8åˆ—ï¼‰
   - Detail/Edit æ¨¡æ¿ï¼šCard åˆ†ç»„ + ä¸¤åˆ—å¸ƒå±€ï¼ˆ48% å®½åº¦ï¼‰
4. **å®ä½“ä¸“ç”¨æ§ä»¶**ï¼šUser å®ä½“è‡ªåŠ¨æ·»åŠ  UserRole æ§ä»¶ï¼ŒRole å®ä½“è‡ªåŠ¨æ·»åŠ  PermTree æ§ä»¶
5. **å¤šç»´åº¦ç­›é€‰**ï¼šæ”¯æŒ entityType + usageType + templateType + keyword ç»„åˆæŸ¥è¯¢

### é—­ç¯éªŒè¯

**è®¾è®¡ â†’ åº”ç”¨ â†’ è®¾ç½® â†’ æ˜¾ç¤º** å®Œæ•´æµç¨‹ï¼š

1. âœ… **è®¾è®¡é˜¶æ®µ**ï¼šè¡¨å•è®¾è®¡å™¨æ”¯æŒ Cardã€SubFormã€DataGridã€TabContainer ç­‰é¡µé¢çº§æ§ä»¶
2. âœ… **åº”ç”¨é˜¶æ®µ**ï¼šå®ä½“å‘å¸ƒæ—¶è‡ªåŠ¨ç”Ÿæˆ List/Detail/Edit ä¸‰ç§ç³»ç»Ÿé»˜è®¤æ¨¡æ¿
3. âœ… **è®¾ç½®é˜¶æ®µ**ï¼šç”¨æˆ·å¯åœ¨æ¨¡æ¿åˆ—è¡¨é¡µæŸ¥çœ‹ã€å¤åˆ¶ã€åº”ç”¨æ¨¡æ¿ï¼Œè®¾ç½®ä¸ªäººé»˜è®¤
4. âœ… **æ˜¾ç¤ºé˜¶æ®µ**ï¼šèœå•å¯¼èˆªé€šè¿‡ PageLoader åŠ è½½æœ‰æ•ˆæ¨¡æ¿ï¼ŒåŠ¨æ€æ¸²æŸ“é¡µé¢

### å·®å¼‚è¯´æ˜

**T7 åŸè®¡åˆ’ vs å®é™…å®ç°**ï¼š

| åŸè®¡åˆ’ | å®é™…æƒ…å†µ |
|--------|----------|
| åˆ›å»º `TemplatePage.razor` | PageLoader.razor å·²æä¾›ç›¸åŒåŠŸèƒ½ |
| åˆ›å»º `DataGridRuntime.razor` | DataGrid è¿è¡Œæ—¶å·²åœ¨ Widget ç³»ç»Ÿä¸­å®ç° |
| åˆ›å»º `UserTemplatePreference.cs` | ä½¿ç”¨ FormTemplate.IsUserDefault å®ç°ç”¨æˆ·åå¥½ |
| æ‰©å±• RuntimeContext | RuntimeContext å·²åŒ…å«å¿…è¦ä¿¡æ¯ |

**ç»“è®º**ï¼šT7 çš„æ ¸å¿ƒåŠŸèƒ½"èœå•å¯¼èˆª â†’ æ¨¡æ¿åŠ è½½ â†’ åŠ¨æ€æ¸²æŸ“"åœ¨ PageLoader.razor ä¸­å·²å®Œæ•´å®ç°ï¼Œæ— éœ€é¢å¤–å¼€å‘ã€‚

### åç»­å»ºè®®

1. **æ•°æ®åº“è¿ç§»**ï¼šæ‰§è¡Œ `MIGRATION-001-AddTemplateVersionField.md` ä¸­çš„è¿ç§»å‘½ä»¤
2. **æµ‹è¯•éªŒè¯**ï¼š
   - åˆ›å»ºæ–°å®ä½“ï¼ŒéªŒè¯è‡ªåŠ¨ç”Ÿæˆä¸‰ç§æ¨¡æ¿
   - å¤åˆ¶ç³»ç»Ÿæ¨¡æ¿ï¼Œä¿®æ”¹ååº”ç”¨ä¸ºç”¨æˆ·é»˜è®¤
   - é€šè¿‡èœå•å¯¼èˆªéªŒè¯æ¨¡æ¿æ­£ç¡®æ¸²æŸ“
3. **æ–‡æ¡£æ›´æ–°**ï¼šæ›´æ–°ç”¨æˆ·æ‰‹å†Œï¼Œè¯´æ˜æ¨¡æ¿ç®¡ç†åŠŸèƒ½
4. **ç‰ˆæœ¬å†å²**ï¼šåŸºäº Version å­—æ®µå®ç°æ¨¡æ¿å˜æ›´å†å²ï¼ˆv0.8.0 è€ƒè™‘ï¼‰

### æ„Ÿè°¢

æ„Ÿè°¢å¼€å‘å›¢é˜Ÿçš„åŠªåŠ›ï¼BobCRM æ¨¡æ¿ç³»ç»Ÿé—­ç¯å·²å®Œæˆï¼Œä¸ºåç»­çš„ä½ä»£ç å¹³å°åŠŸèƒ½æ‰“ä¸‹äº†åšå®åŸºç¡€ï¼ğŸš€

---

## å‚è€ƒæ–‡æ¡£

- `docs/planning/PLAN-01-v0.7.0-èœå•å¯¼èˆªå®Œå–„.md` - æ€»ä½“è®¡åˆ’
- `docs/planning/PLAN-01-APPENDIX-æ¨¡æ¿ç³»ç»Ÿè¯¦ç»†è®¾è®¡.md` - è¯¦ç»†æŠ€æœ¯è§„æ ¼
- `CLAUDE.md` - é¡¹ç›®å¼€å‘è§„èŒƒ
- `docs/design/ARCH-22-æ ‡å‡†å®ä½“æ¨¡æ¿åŒ–ä¸æƒé™è”åŠ¨è®¾è®¡.md` - æ¨¡æ¿ç³»ç»Ÿæ¶æ„

---

**å¼€å§‹å¼€å‘å§ï¼è¿™æ˜¯ BobCRM æœ€æ ¸å¿ƒçš„åŠŸèƒ½ï¼** ğŸš€
