@using BobCrm.App.Models.Designer
@using BobCrm.App.Models.Widgets
@using BobCrm.App.Services.Widgets
@using System.Reflection
@using BobCrm.App.Components.Designer.PropertyEditors
@inject BobCrm.App.Services.I18nService I18n

@* Generic property editor - renders from metadata; adjusts Width max based on unit *@

@if (Properties != null && Properties.Any())
{
    string? currentGroup = null;
    foreach (var prop in Properties)
    {
        @* Conditional display check *@
        if (!string.IsNullOrEmpty(prop.VisibleWhen))
        {
            var conditionValue = GetPropertyValue(Widget, prop.VisibleWhen);
            if (conditionValue == null || !conditionValue.Equals(prop.VisibleWhenValue))
            {
                continue;
            }
        }

        @* Group separator *@
        if (prop.Group != null && prop.Group != currentGroup)
        {
            currentGroup = prop.Group;
            <Divider Plain Style="margin:12px 0 8px 0; font-size:11px">@I18n.T(currentGroup)</Divider>
        }

        @* Render property editor *@
        <div style="margin-bottom:16px; @(prop.EditorType == PropertyEditorType.Boolean ? "display:flex; justify-content:space-between; align-items:center" : "")">
            <label style="@(prop.EditorType == PropertyEditorType.Boolean ? "font-size:12px; color:#666" : "display:block; font-size:12px; color:#666; margin-bottom:4px")">
                @I18n.T(prop.Label)
            </label>
            
            @switch (prop.EditorType)
            {
                case PropertyEditorType.Text:
                    @if (prop.PropertyPath == "Code")
                    {
                        // Code property must be unique
                        var currentCode = GetPropertyValue(Widget, prop.PropertyPath)?.ToString() ?? "";
                        var isCodeValid = string.IsNullOrWhiteSpace(currentCode) ||
                                         WidgetCodeGenerator.IsCodeUnique(currentCode, Widget?.Id ?? "", AllWidgets ?? Enumerable.Empty<DraggableWidget>());

                        <Input Value="@currentCode"
                               Placeholder="@(!string.IsNullOrEmpty(prop.Placeholder) && prop.Placeholder.StartsWith("PROP_") ? I18n.T(prop.Placeholder) : prop.Placeholder)"
                               Status="@(isCodeValid ? "" : "error")"
                               OnChange="@((string val) => HandleCodeChange(val))" />

                        @if (!isCodeValid)
                        {
                            <div style="font-size:11px; color:#ff4d4f; margin-top:4px">@I18n.T("ERR_CODE_NOT_UNIQUE")</div>
                        }
                    }
                    else
                    {
                        <Input Value="@(GetPropertyValue(Widget, prop.PropertyPath)?.ToString() ?? "")"
                               Placeholder="@(!string.IsNullOrEmpty(prop.Placeholder) && prop.Placeholder.StartsWith("PROP_") ? I18n.T(prop.Placeholder) : prop.Placeholder)"
                               OnChange="@((string val) => SetPropertyValue(Widget, prop.PropertyPath, val))" />
                    }
                    break;
                
                case PropertyEditorType.Number:
                    {
                        // For Width, pull max from widget (responsive to WidthUnit)
                        var maxValue = prop.Max;
                        if (prop.PropertyPath == "Width" && Widget != null)
                        {
                            maxValue = Widget.GetMaxWidth();
                        }
                        
                        var numberInput = new RenderFragment(__builder =>
                        {
                            __builder.OpenComponent<AntDesign.InputNumber<int>>(0);
                            __builder.AddAttribute(1, "Value", Convert.ToInt32(GetPropertyValue(Widget, prop.PropertyPath) ?? 0));
                            __builder.AddAttribute(2, "Min", prop.Min ?? 0);
                            if (maxValue.HasValue)
                            {
                                __builder.AddAttribute(3, "Max", maxValue.Value);
                            }
                            __builder.AddAttribute(4, "Style", "width:100%");
                            __builder.AddAttribute(5, "OnChange", Microsoft.AspNetCore.Components.EventCallback.Factory.Create<int>(this, val => SetPropertyValue(Widget, prop.PropertyPath, val)));
                            __builder.CloseComponent();
                        });
                        @numberInput
                    }
                    break;
                
                case PropertyEditorType.Boolean:
                    <Switch Value="@(Convert.ToBoolean(GetPropertyValue(Widget, prop.PropertyPath) ?? false))"
                            OnChange="@((bool val) => SetPropertyValue(Widget, prop.PropertyPath, val))" />
                    break;
                
                case PropertyEditorType.Color:
                    <Input Value="@(GetPropertyValue(Widget, prop.PropertyPath)?.ToString() ?? "")"
                           Placeholder="@(!string.IsNullOrEmpty(prop.Placeholder) && prop.Placeholder.StartsWith("PROP_") ? I18n.T(prop.Placeholder) : prop.Placeholder)"
                           OnChange="@((string val) => SetPropertyValue(Widget, prop.PropertyPath, val))" />
                    break;
                
                case PropertyEditorType.Select:
                    {
                        var currentValue = GetPropertyValue(Widget, prop.PropertyPath)?.ToString() ?? "";
                        <AntDesign.Select TItemValue="string"
                                         TItem="string"
                                         Value="@currentValue"
                                         Style="width:100%"
                                         OnSelectedItemChanged="@((string val) => SetPropertyValue(Widget, prop.PropertyPath, val))">
                            <SelectOptions>
                                @if (prop.Options != null)
                                {
                                    @foreach (var opt in prop.Options)
                                    {
                                        <SelectOption TItemValue="string" TItem="string" Value="@opt.Value" Label="@I18n.T(opt.Label)" />
                                    }
                                }
                            </SelectOptions>
                        </AntDesign.Select>
                    }
                    break;
                
                case PropertyEditorType.Textarea:
                    <AntDesign.TextArea Value="@(GetPropertyValue(Widget, prop.PropertyPath)?.ToString() ?? "")"
                                       Placeholder="@(!string.IsNullOrEmpty(prop.Placeholder) && prop.Placeholder.StartsWith("PROP_") ? I18n.T(prop.Placeholder) : prop.Placeholder)"
                                       Rows="3"
                                       OnChange="@((string val) => SetPropertyValue(Widget, prop.PropertyPath, val))" />
                    break;

                case PropertyEditorType.ColumnDefinition:
                    {
                        var currentValue = GetPropertyValue(Widget, prop.PropertyPath)?.ToString();
                        <ColumnDefinitionEditor Value="currentValue"
                                                ValueChanged="@((string? val) => { SetPropertyValue(Widget, prop.PropertyPath, val); OnPropertyChanged?.Invoke(); })" />
                    }
                    break;

                case PropertyEditorType.DataSetPicker:
                    {
                        var currentValue = GetPropertyValue(Widget, prop.PropertyPath)?.ToString() ?? "";
                        <AntDesign.Select TItemValue="string"
                                         TItem="string"
                                         Value="@currentValue"
                                         Style="width:100%"
                                         Placeholder="@I18n.T("LBL_SELECT_DATASET")"
                                         OnSelectedItemChanged="@((string val) => SetPropertyValue(Widget, prop.PropertyPath, val))">
                            <SelectOptions>
                                @if (AllEntities != null)
                                {
                                    @foreach (var entity in AllEntities)
                                    {
                                        var name = entity.DisplayName != null && entity.DisplayName.TryGetValue(I18n.CurrentLang, out var dn) ? dn : entity.EntityName;
                                        <SelectOption TItemValue="string" TItem="string" Value="@entity.EntityRoute" Label="@name" />
                                    }
                                }
                            </SelectOptions>
                        </AntDesign.Select>
                    }
                    break;

                case PropertyEditorType.FieldPicker:
                    {
                        var currentValue = GetPropertyValue(Widget, prop.PropertyPath)?.ToString() ?? "";
                        <AntDesign.Select TItemValue="string"
                                         TItem="string"
                                         Value="@currentValue"
                                         Style="width:100%"
                                         ShowSearch="true"
                                         Placeholder="@I18n.T("LBL_SELECT_FIELD")"
                                         OnSelectedItemChanged="@((string val) => SetPropertyValue(Widget, prop.PropertyPath, val))">
                            <SelectOptions>
                                @if (EntityDefinition != null && EntityDefinition.Fields != null)
                                {
                                    @foreach (var field in EntityDefinition.Fields)
                                    {
                                        var name = field.DisplayName != null && field.DisplayName.TryGetValue(I18n.CurrentLang, out var dn) ? dn : field.PropertyName;
                                        <SelectOption TItemValue="string" TItem="string" Value="@field.PropertyName" Label="@($"{name} ({field.PropertyName})")" />
                                    }
                                }
                            </SelectOptions>
                        </AntDesign.Select>
                    }
                    break;

                 default:
                    <div style="font-size:12px; color:orange">Unsupported Editor: @prop.EditorType</div>
                    break;
            }
            
            @if (!string.IsNullOrEmpty(prop.HelpText))
            {
                <div style="font-size:11px; color:#999; margin-top:4px">@I18n.T(prop.HelpText)</div>
            }
        </div>
    }
}

@code {
    [Parameter, EditorRequired]
    public List<WidgetPropertyMetadata>? Properties { get; set; }

    [Parameter, EditorRequired]
    public DraggableWidget? Widget { get; set; }

    [Parameter]
    public Action? OnPropertyChanged { get; set; }

    /// <summary>
    /// All widgets (used for Code uniqueness)（widget list for Code uniqueness check）
    /// </summary>
    [Parameter]
    public IEnumerable<DraggableWidget>? AllWidgets { get; set; }

    [Parameter]
    public BobCrm.App.Models.EntityDefinitionDto? EntityDefinition { get; set; }

    [Parameter]
    public IEnumerable<BobCrm.App.Models.EntityDefinitionDto>? AllEntities { get; set; }

    /// <summary>
    /// Handle Code property changes
    /// </summary>
    private void HandleCodeChange(string newCode)
    {
        if (Widget == null)
            return;

        // Validate uniqueness
        if (string.IsNullOrWhiteSpace(newCode))
        {
            SetPropertyValue(Widget, "Code", newCode);
            return;
        }

        var isUnique = WidgetCodeGenerator.IsCodeUnique(newCode, Widget.Id, AllWidgets ?? Enumerable.Empty<DraggableWidget>());

        // Set value regardless so users see validation message
        SetPropertyValue(Widget, "Code", newCode);
    }

    /// <summary>
    /// Get property value (supports nested paths, e.g., "ContainerLayout.Gap")
    /// </summary>
    private object? GetPropertyValue(object? obj, string propertyPath)
    {
        if (obj == null || string.IsNullOrEmpty(propertyPath))
            return null;

        var parts = propertyPath.Split('.');
        object? current = obj;

        foreach (var part in parts)
        {
            if (current == null)
                return null;

            var prop = current.GetType().GetProperty(part);
            if (prop == null)
                return null;

            current = prop.GetValue(current);
        }

        return current;
    }

    /// <summary>
    /// Set property value (supports nested paths)
    /// </summary>
    private void SetPropertyValue(object? obj, string propertyPath, object? value)
    {
        if (obj == null || string.IsNullOrEmpty(propertyPath))
            return;

        var parts = propertyPath.Split('.');
        object? current = obj;

        // Navigate to the second-to-last segment
        for (int i = 0; i < parts.Length - 1; i++)
        {
            if (current == null)
                return;

            var prop = current.GetType().GetProperty(parts[i]);
            if (prop == null)
                return;

            current = prop.GetValue(current);
        }

        if (current == null)
            return;

        // Set the final property value
        var targetProp = current.GetType().GetProperty(parts[^1]);
        if (targetProp != null && targetProp.CanWrite)
        {
            targetProp.SetValue(current, value);
            OnPropertyChanged?.Invoke();
        }
    }
}


