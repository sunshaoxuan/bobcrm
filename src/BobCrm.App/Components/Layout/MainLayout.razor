@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Routing
@using System.Net.Http.Json
@using BobCrm.App.Services
@using AntDesign
@inject AuthService Auth
@inject NavigationManager Nav
@inject ThemeState ThemeState
@inject LayoutState Layout
@inject InteractionState Interaction
@inject I18nService I18n
@inject IJSRuntime JS
@implements IDisposable

@* Calm App Shell：左侧 rail + glass sider + 顶部导航 *@

<div class="chrome-shell @ThemeState.CurrentTheme @NavModeClass">
    <nav class="chrome-rail">
        <div class="rail-brand">
            <button class="rail-logo-button" @onclick="@(() => NavigateTo(RootHref))">
                <span class="rail-logo-wordmark">OneCRM</span>
            </button>
            <span class="rail-tagline">@_railTagline</span>
        </div>
        <div class="rail-group">
            @foreach (var item in _railItems)
            {
                <Tooltip Title="@I18n.T(item.LabelKey)" Placement="Placement.Right">
                    <button class="rail-item @(IsActiveRail(item) ? "active" : string.Empty)" @onclick="() => NavigateTo(item.Href)">
                        <span class="rail-item-icon"><Icon Type="@item.Icon" /></span>
                        <span class="rail-item-label">@I18n.T(item.LabelKey)</span>
                    </button>
                </Tooltip>
            }
        </div>
        <div class="rail-group rail-footer">
            <Tooltip Title="@I18n.T("MENU_SETTINGS")" Placement="Placement.Right">
                <button class="rail-item" @onclick="@(() => NavigateTo(SettingsHref))">
                    <span class="rail-item-icon"><Icon Type="@IconType.Outline.Setting" /></span>
                    <span class="rail-item-label">@I18n.T("MENU_SETTINGS")</span>
                </button>
            </Tooltip>
        </div>
    </nav>

    <div class="chrome-app app-shell layout-root @(Layout.IsSiderCollapsed ? "sider-collapsed" : "") @(Layout.IsSiderOverlayOpen ? "sider-overlay-open" : "")">
        <div class="layout-main">
            <AppHeader />
            <div class="layout-content">
                <div class="layout-body">
                    @if (Interaction.IsStickyBarVisible)
                    {
                        <div class="sticky-bar">
                            <div class="sticky-info">
                                <Icon Type="@IconType.Outline.Filter" />
                                <span>@Interaction.StickyBarMessage</span>
                            </div>
                            <div class="sticky-actions">
                                @foreach (var action in Interaction.StickyActions)
                                {
                                    <Button Type="@(action.Tone == InteractionState.InteractionActionTone.Primary ? ButtonType.Primary : ButtonType.Default)" OnClick="() => InvokeSticky(action.Callback)">
                                        @action.Label
                                    </Button>
                                }
                                <Button Ghost OnClick="HideSticky">关闭</Button>
                            </div>
                        </div>
                    }
                    @Body
                </div>
                @if (ShowCustomerSider)
                {
                    <aside class="layout-right-panel customer-panel">
                        <div class="customer-panel-header">
                            <div>
                                <p class="eyebrow">Workspace</p>
                                <h3>@I18n.T("MENU_CUSTOMERS")</h3>
                            </div>
                        </div>
                        <div class="customer-panel-body">
                            <CustomerSider />
                        </div>
                    </aside>
                }
                else if (Layout.IsRightPanelVisible)
                {
                    <aside class="layout-right-panel">
                        <div class="right-panel-header">
                            <span>工作栏</span>
                            <button class="panel-close" @onclick="ToggleRightPanel">
                                <Icon Type="@IconType.Outline.Close" />
                            </button>
                        </div>
                        <p class="text-muted">此区域预留给提醒、批量操作或时间线等上下文信息。</p>
                    </aside>
                }
            </div>
        </div>

        @if (Layout.IsSiderOverlayOpen)
        {
            <button class="sider-mask mobile-only" @onclick="CloseOverlay"></button>
        }

        <GlobalOverlayHost />
    </div>
</div>

@code {
    private const string RootHref = "/";
    private const string SettingsHref = "/settings";
    private record RailItem(string Icon, string LabelKey, string Href);

    private readonly RailItem[] _railItems =
    [
        new(IconType.Outline.Home, "MENU_DASHBOARD", RootHref),
        new(IconType.Outline.Team, "MENU_CUSTOMERS", "/customers"),
        new(IconType.Outline.Profile, "MENU_ENTITY", "/entity-definitions"),
        new(IconType.Outline.Appstore, "MENU_TEMPLATES", "/templates")
    ];

    [Parameter] public RenderFragment? Body { get; set; }

    private string _railTagline = "体验中枢";

    protected override void OnInitialized()
    {
        Auth.OnUnauthorized += HandleUnauthorized;
        ThemeState.OnChanged += HandleThemeChanged;
        Layout.OnChanged += HandleLayoutChanged;
        Nav.LocationChanged += HandleLocationChanged;
        I18n.OnChanged += HandleI18nChanged;
        UpdateRailTagline();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadNavModeAsync();
        }
    }

    private async Task LoadNavModeAsync()
    {
        try
        {
            var stored = await JS.InvokeAsync<string?>("localStorage.getItem", "navMode");
            if (!string.IsNullOrWhiteSpace(stored) && Enum.TryParse<LayoutState.NavDisplayMode>(stored, true, out var mode))
            {
                Layout.SetNavMode(mode);
            }
        }
        catch { }
    }

    private void HandleUnauthorized()
    {
        try
        {
            Nav.NavigateTo("/login", forceLoad: true);
        }
        catch { }
    }

    private void HandleThemeChanged() => SafeRender();
    private void HandleLayoutChanged() => SafeRender();
    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e) => SafeRender();
    private void HandleI18nChanged()
    {
        UpdateRailTagline();
        SafeRender();
    }

    private void SafeRender()
    {
        try { InvokeAsync(StateHasChanged); } catch { }
    }

    private void UpdateRailTagline()
    {
        var tagline = I18n.T("TXT_RAIL_TAGLINE");
        _railTagline = string.IsNullOrWhiteSpace(tagline) ? "体验中枢" : tagline!;
    }

    private static string NormalizeRelative(string relative)
    {
        var trimmed = relative?.Trim('/') ?? string.Empty;
        return string.IsNullOrEmpty(trimmed) ? "/" : trimmed;
    }

    private bool IsActiveRail(RailItem item)
    {
        var current = NormalizeRelative(Nav.ToBaseRelativePath(Nav.Uri));
        var target = NormalizeRelative(item.Href);
        if (target == "/")
        {
            return current == "/";
        }

        return current.StartsWith(target, StringComparison.OrdinalIgnoreCase);
    }

    private void NavigateTo(string href) => Nav.NavigateTo(href);

    private void CloseOverlay() => Layout.SetSiderOverlay(false);
    private void ToggleRightPanel() => Layout.ToggleRightPanel();
    private bool ShowCustomerSider => IsCustomerRoute();
    private bool IsCustomerRoute()
    {
        var current = NormalizeRelative(Nav.ToBaseRelativePath(Nav.Uri));
        return current.StartsWith("customers", StringComparison.OrdinalIgnoreCase) ||
               current.StartsWith("customer", StringComparison.OrdinalIgnoreCase);
    }
    private async Task InvokeSticky(Func<Task>? callback)
    {
        if (callback != null)
        {
            await callback();
        }
    }

    private void HideSticky() => Interaction.HideStickyBar();
    private string NavModeClass => $"nav-mode-{Layout.NavMode.ToString().ToLowerInvariant()}";

    public void Dispose()
    {
        Auth.OnUnauthorized -= HandleUnauthorized;
        ThemeState.OnChanged -= HandleThemeChanged;
        Layout.OnChanged -= HandleLayoutChanged;
        Nav.LocationChanged -= HandleLocationChanged;
        I18n.OnChanged -= HandleI18nChanged;
    }
}

