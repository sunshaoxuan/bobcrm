@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Routing
@using System.Net.Http.Json
@using System.Collections.Generic
@using System.Linq
@using BobCrm.App.Models
@using BobCrm.App.Services
@using AntDesign
@inject AuthService Auth
@inject NavigationManager Nav
@inject ThemeState ThemeState
@inject LayoutState Layout
@inject InteractionState Interaction
@inject I18nService I18n
@inject IJSRuntime JS
@implements IDisposable

@* Compact Top Menu Shell *@

<div class="chrome-shell @ThemeState.CurrentTheme compact-menu-layout">
    <div class="chrome-app app-shell layout-root">
        <div class="layout-main">
            <AppHeader Domains="@_domains"
                      ActiveDomain="@_activeDomain"
                      OnDomainChanged="OnDomainChanged" />
            <div class="layout-content">
                <div class="layout-body">
                    @if (Interaction.IsStickyBarVisible)
                    {
                        <div class="sticky-bar">
                            <div class="sticky-info">
                                <Icon Type="@IconType.Outline.Filter" />
                                <span>@Interaction.StickyBarMessage</span>
                            </div>
                            <div class="sticky-actions">
                                @foreach (var action in Interaction.StickyActions)
                                {
                                    <Button Type="@(action.Tone == InteractionState.InteractionActionTone.Primary ? ButtonType.Primary : ButtonType.Default)" OnClick="() => InvokeSticky(action.Callback)">
                                        @action.Label
                                    </Button>
                                }
                                <Button Ghost OnClick="HideSticky">关闭</Button>
                            </div>
                        </div>
                    }
                    @Body
                </div>
                @if (ShowCustomerSider)
                {
                    <aside class="layout-right-panel customer-panel">
                        <div class="customer-panel-header">
                            <div>
                                <p class="eyebrow">Workspace</p>
                                <h3>@I18n.T("MENU_CUSTOMERS")</h3>
                            </div>
                        </div>
                        <div class="customer-panel-body">
                            <CustomerSider />
                        </div>
                    </aside>
                }
                else if (Layout.IsRightPanelVisible)
                {
                    <aside class="layout-right-panel">
                        <div class="right-panel-header">
                            <span>工作栏</span>
                            <button class="panel-close" @onclick="ToggleRightPanel">
                                <Icon Type="@IconType.Outline.Close" />
                            </button>
                        </div>
                        <p class="text-muted">此区域预留给提醒、批量操作或时间线等上下文信息。</p>
                    </aside>
                }
            </div>
        </div>

        <GlobalOverlayHost />
        <AntContainer />
        <GlobalToast />
    </div>
</div>

@code {
    private const string RootHref = "/";
    private const string SettingsHref = "/settings";

    private readonly List<FunctionMenuNode> _domains = new();
    private FunctionMenuNode? _activeDomain;
    private string? _menuError;
    private string _currentRoute = "/";

    [Parameter] public RenderFragment? Body { get; set; }
    [CascadingParameter] public int I18nRenderVersion { get; set; }

    private string _railTagline = "体验中枢";
    private int _lastI18nVersion = -1;

    protected override void OnInitialized()
    {
        _currentRoute = NormalizeRelative(Nav.ToBaseRelativePath(Nav.Uri));
        Auth.OnUnauthorized += HandleUnauthorized;
        ThemeState.OnChanged += HandleThemeChanged;
        Layout.OnChanged += HandleLayoutChanged;
        Nav.LocationChanged += HandleLocationChanged;
        I18n.OnChanged += HandleI18nChanged;
        UpdateRailTagline();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadMenuAsync();
            await LoadNavModeAsync();
        }
    }

    protected override void OnParametersSet()
    {
        if (_lastI18nVersion != I18nRenderVersion)
        {
            _lastI18nVersion = I18nRenderVersion;
            UpdateRailTagline();
        }
    }

    private async Task LoadMenuAsync()
    {
        try
        {
            _menuError = null;
            var resp = await Auth.GetWithRefreshAsync("/api/access/functions/me");
            if (!resp.IsSuccessStatusCode)
            {
                _menuError = "菜单加载失败";
                _domains.Clear();
                _activeDomain = null;
            }
            else
            {
                var tree = await resp.Content.ReadFromJsonAsync<List<FunctionMenuNode>>();
                _domains.Clear();
                _domains.AddRange(ExtractDomainNodes(tree));
                var resolved = ResolveActiveDomain() ?? _domains.FirstOrDefault();
                _activeDomain = resolved;
                Layout.SetCurrentDomain(_activeDomain?.Code);
            }
        }
        catch (Exception ex)
        {
            _menuError = ex.Message;
            _domains.Clear();
            _activeDomain = null;
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private List<FunctionMenuNode> ExtractDomainNodes(List<FunctionMenuNode>? nodes)
    {
        if (nodes == null || nodes.Count == 0) return new();
        var root = nodes.FirstOrDefault(n => string.Equals(n.Code, "APP.ROOT", StringComparison.OrdinalIgnoreCase));
        var domains = (root?.Children ?? nodes)
            .Where(n => n.IsMenu)
            .OrderBy(n => n.SortOrder)
            .ToList();
        return domains;
    }

    private async Task LoadNavModeAsync()
    {
        try
        {
            var stored = await JS.InvokeAsync<string?>("localStorage.getItem", "navMode");
            if (!string.IsNullOrWhiteSpace(stored) && Enum.TryParse<LayoutState.NavDisplayMode>(stored, true, out var mode))
            {
                Layout.SetNavMode(mode);
            }
        }
        catch { }
    }

    private void HandleUnauthorized()
    {
        try
        {
            Nav.NavigateTo("/login", forceLoad: true);
        }
        catch { }
    }

    private void HandleThemeChanged() => SafeRender();
    private void HandleLayoutChanged() => SafeRender();
    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        _currentRoute = NormalizeRelative(Nav.ToBaseRelativePath(e.Location));
        SyncActiveDomainWithUri();
        SafeRender();
    }

    private void HandleI18nChanged()
    {
        UpdateRailTagline();
        SafeRender();
    }

    private void SafeRender()
    {
        try { InvokeAsync(StateHasChanged); } catch { }
    }

    private void UpdateRailTagline()
    {
        var tagline = I18n.T("TXT_RAIL_TAGLINE");
        _railTagline = string.IsNullOrWhiteSpace(tagline) ? "体验中枢" : tagline!;
    }

    private static string NormalizeRelative(string relative)
    {
        var trimmed = relative?.Trim('/') ?? string.Empty;
        return string.IsNullOrEmpty(trimmed) ? "/" : trimmed;
    }

    private void NavigateTo(string href)
    {
        if (string.IsNullOrWhiteSpace(href)) return;
        Nav.NavigateTo(href);
    }

    private void ToggleRightPanel() => Layout.ToggleRightPanel();
    private bool ShowCustomerSider => IsCustomerRoute();
    private bool IsCustomerRoute()
    {
        return _currentRoute.StartsWith("customers", StringComparison.OrdinalIgnoreCase) ||
               _currentRoute.StartsWith("customer", StringComparison.OrdinalIgnoreCase);
    }

    private async Task InvokeSticky(Func<Task>? callback)
    {
        if (callback != null)
        {
            await callback();
        }
    }

    private void HideSticky() => Interaction.HideStickyBar();

    private void OnDomainChanged(FunctionMenuNode domain)
    {
        if (_activeDomain?.Id == domain.Id)
        {
            return;
        }

        _activeDomain = domain;
        Layout.SetCurrentDomain(domain.Code);

        // 导航到该领域的第一个可用路由
        var firstRoute = FindFirstNavigableRoute(domain);
        if (!string.IsNullOrWhiteSpace(firstRoute))
        {
            NavigateTo(firstRoute!);
        }
        else
        {
            SafeRender();
        }
    }

    private void SyncActiveDomainWithUri()
    {
        if (_domains.Count == 0) return;
        var resolved = ResolveActiveDomain();
        if (resolved != null && (_activeDomain == null || resolved.Id != _activeDomain.Id))
        {
            _activeDomain = resolved;
            Layout.SetCurrentDomain(_activeDomain?.Code);
        }
    }

    private FunctionMenuNode? ResolveActiveDomain()
    {
        if (_domains.Count == 0) return null;
        foreach (var domain in _domains)
        {
            if (DomainContainsRoute(domain, _currentRoute))
            {
                return domain;
            }
        }
        return _domains.FirstOrDefault();
    }

    private bool DomainContainsRoute(FunctionMenuNode node, string route)
    {
        if (!string.IsNullOrWhiteSpace(node.Route) && PathMatches(node.Route, route))
        {
            return true;
        }

        foreach (var child in node.Children)
        {
            if (DomainContainsRoute(child, route))
            {
                return true;
            }
        }
        return false;
    }

    private bool PathMatches(string? route, string current)
    {
        var normalized = NormalizeRelative(route ?? string.Empty);
        if (normalized == "/")
        {
            return current == "/";
        }
        return current.StartsWith(normalized.TrimStart('/'), StringComparison.OrdinalIgnoreCase);
    }

    private string NormalizeRoute(string? route)
    {
        if (string.IsNullOrWhiteSpace(route)) return string.Empty;
        if (route.StartsWith("http", StringComparison.OrdinalIgnoreCase))
        {
            return route;
        }
        return route.StartsWith("/") ? route : "/" + route.Trim();
    }

    private string? FindFirstNavigableRoute(FunctionMenuNode node)
    {
        if (!string.IsNullOrWhiteSpace(node.Route))
        {
            return NormalizeRoute(node.Route);
        }

        foreach (var child in node.Children.OrderBy(c => c.SortOrder))
        {
            var candidate = FindFirstNavigableRoute(child);
            if (!string.IsNullOrWhiteSpace(candidate))
            {
                return candidate;
            }
        }

        return null;
    }

    private void RefreshMenu()
    {
        _ = LoadMenuAsync();
    }

    public void Dispose()
    {
        Auth.OnUnauthorized -= HandleUnauthorized;
        ThemeState.OnChanged -= HandleThemeChanged;
        Layout.OnChanged -= HandleLayoutChanged;
        Nav.LocationChanged -= HandleLocationChanged;
        I18n.OnChanged -= HandleI18nChanged;
    }
}


