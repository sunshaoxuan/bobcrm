@using Microsoft.AspNetCore.Components
@using System.Net.Http.Json
@using BobCrm.App.Services
@inject AuthService Auth
@inject NavigationManager Nav
@implements IDisposable

@* Moved theme.css to App.razor <head> for stable load order *@

<div class="app-shell">
    <div class="app-sider">
        <div class="logo-brand">
            <h1 class="logo-text">OneCRM</h1>
        </div>
        <CustomerSider />
    </div>
    <div class="app-main">
        <AppHeader />
        <div class="app-content">
            <div class="app-card">
                @Body
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public RenderFragment? Body { get; set; }

    protected override void OnInitialized()
    {
        // 全局订阅认证失败事件：当 token 过期且刷新失败时，统一跳转到登录页
        Auth.OnUnauthorized += HandleUnauthorized;
    }

    private void HandleUnauthorized()
    {
        try
        {
            // 强制导航到登录页（forceLoad 确保完全刷新）
            Nav.NavigateTo("/login", forceLoad: true);
        }
        catch
        {
            // 忽略导航错误
        }
    }

    public void Dispose()
    {
        Auth.OnUnauthorized -= HandleUnauthorized;
    }
}
