@page "/{EntityType}/{Id:int}"
@rendermode RenderMode.InteractiveServer
@implements IDisposable

@using AntDesign
@using BobCrm.App.Components.Runtime
@using BobCrm.App.ViewModels
@using System.ComponentModel

@inject BobCrm.App.Services.I18nService I18n
@inject PageLoaderViewModel ViewModel
@inject NavigationManager Nav

<AuthChecker>
    @if (ViewModel.Loading)
    {
        <div class="runtime-state loading">
            <strong>@I18n.T("LBL_LOADING")</strong>
            <span>@I18n.T("LBL_LOADING")...</span>
        </div>
    }
    else if (ViewModel.Error != null)
    {
        <div class="runtime-state error">
            <div>@ViewModel.Error</div>
            <Button Type="@ButtonType.Primary" OnClick="ReloadPage">@I18n.T("BTN_RETRY")</Button>
        </div>
    }
    else if (ViewModel.EntityData != null)
    {
        <div class="runtime-shell">
            <div id="e2e-debug-banner" style="display:none" class="e2e-only">
                TemplateId: @ViewModel.RuntimeContext?.Template?.Id
                WidgetCount: @ViewModel.LayoutWidgets.Count
            </div>
            <RuntimeHeader ViewModel="ViewModel"
                           OnEdit="EnterEditModeAsync"
                           OnSave="SaveChanges"
                           OnCancel="CancelEditAsync" />

            <RuntimeCanvas ViewModel="ViewModel"
                           OnReload="ReloadPage" />
        </div>
    }
</AuthChecker>

@code {
    [Parameter] public string EntityType { get; set; } = string.Empty;
    [Parameter] public int Id { get; set; }

    protected override void OnInitialized()
    {
        I18n.OnChanged += HandleI18nChanged;
        ViewModel.PropertyChanged += HandleViewModelChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        var (tid, mid) = ReadViewContextFromUrl();
        await ViewModel.LoadDataAsync(EntityType, Id, tid, mid);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!ViewModel.Loading)
        {
            var (tid, mid) = ReadViewContextFromUrl();
            await ViewModel.LoadDataAsync(EntityType, Id, tid, mid);
        }
    }

    private void HandleI18nChanged() => SafeRequestRender();

    private void HandleViewModelChanged(object? sender, PropertyChangedEventArgs e) => SafeRequestRender();

    private void SafeRequestRender()
    {
        try
        {
            _ = InvokeAsync(StateHasChanged);
        }
        catch
        {
            // ignore: component disposed / render not allowed
        }
    }

    private Task EnterEditModeAsync() => ViewModel.EnterEditModeAsync();

    private Task CancelEditAsync()
    {
        ViewModel.CancelEdit();
        return Task.CompletedTask;
    }

    private Task ReloadPage()
    {
        var (tid, mid) = ReadViewContextFromUrl();
        return ViewModel.LoadDataAsync(EntityType, Id, tid, mid);
    }

    private Task SaveChanges() => ViewModel.SaveChangesAsync();

    public void Dispose()
    {
        I18n.OnChanged -= HandleI18nChanged;
        ViewModel.PropertyChanged -= HandleViewModelChanged;
    }

    private (int? templateId, Guid? menuNodeId) ReadViewContextFromUrl()
    {
        try
        {
            var uri = new Uri(Nav.Uri);
            var query = uri.Query?.TrimStart('?') ?? string.Empty;
            if (string.IsNullOrWhiteSpace(query))
            {
                return (null, null);
            }

            int? templateId = null;
            Guid? menuNodeId = null;
            foreach (var part in query.Split('&', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
            {
                var kv = part.Split('=', 2);
                if (kv.Length == 0) continue;
                var key = Uri.UnescapeDataString(kv[0] ?? string.Empty).Trim();
                var value = kv.Length > 1 ? Uri.UnescapeDataString(kv[1] ?? string.Empty) : string.Empty;

                if (string.Equals(key, "tid", StringComparison.OrdinalIgnoreCase) &&
                    int.TryParse(value, out var tid))
                {
                    templateId = tid;
                }
                else if (string.Equals(key, "mid", StringComparison.OrdinalIgnoreCase) &&
                         Guid.TryParse(value, out var mid))
                {
                    menuNodeId = mid;
                }
            }

            return (templateId, menuNodeId);
        }
        catch
        {
            return (null, null);
        }
    }
}

