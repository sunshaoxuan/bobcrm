@page "/{EntityType}/{Id:int}"
@rendermode RenderMode.InteractiveServer
@implements IDisposable

@using AntDesign
@using BobCrm.App.Components.Runtime
@using BobCrm.App.ViewModels
@using System.ComponentModel

@inject BobCrm.App.Services.I18nService I18n
@inject PageLoaderViewModel ViewModel

<AuthChecker>
    @if (ViewModel.Loading)
    {
        <div class="runtime-state loading">
            <strong>@I18n.T("LBL_LOADING")</strong>
            <span>@I18n.T("LBL_LOADING")...</span>
        </div>
    }
    else if (ViewModel.Error != null)
    {
        <div class="runtime-state error">
            <div>@ViewModel.Error</div>
            <Button Type="@ButtonType.Primary" OnClick="ReloadPage">@I18n.T("BTN_RETRY")</Button>
        </div>
    }
    else if (ViewModel.EntityData != null)
    {
        <div class="runtime-shell">
            <RuntimeHeader ViewModel="ViewModel"
                           OnEdit="EnterEditModeAsync"
                           OnSave="SaveChanges"
                           OnCancel="CancelEditAsync" />

            <RuntimeCanvas ViewModel="ViewModel"
                           OnReload="ReloadPage" />
        </div>
    }
</AuthChecker>

@code {
    [Parameter] public string EntityType { get; set; } = string.Empty;
    [Parameter] public int Id { get; set; }

    protected override void OnInitialized()
    {
        I18n.OnChanged += HandleI18nChanged;
        ViewModel.PropertyChanged += HandleViewModelChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await ViewModel.LoadDataAsync(EntityType, Id);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!ViewModel.Loading)
        {
            await ViewModel.LoadDataAsync(EntityType, Id);
        }
    }

    private void HandleI18nChanged() => SafeRequestRender();

    private void HandleViewModelChanged(object? sender, PropertyChangedEventArgs e) => SafeRequestRender();

    private void SafeRequestRender()
    {
        try
        {
            _ = InvokeAsync(StateHasChanged);
        }
        catch
        {
            // ignore: component disposed / render not allowed
        }
    }

    private Task EnterEditModeAsync() => ViewModel.EnterEditModeAsync();

    private Task CancelEditAsync()
    {
        ViewModel.CancelEdit();
        return Task.CompletedTask;
    }

    private Task ReloadPage() => ViewModel.LoadDataAsync(EntityType, Id);

    private Task SaveChanges() => ViewModel.SaveChangesAsync();

    public void Dispose()
    {
        I18n.OnChanged -= HandleI18nChanged;
        ViewModel.PropertyChanged -= HandleViewModelChanged;
    }
}

