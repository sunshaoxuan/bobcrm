@page "/entity-definitions/{EntityId:guid}/master-detail"
@rendermode RenderMode.InteractiveServer
@inject HttpClient Http
@inject BobCrm.App.Services.I18nService I18n
@inject NavigationManager Nav
@inject IMessageService Message
@using System.Text.Json
@using System.Net.Http.Json

<AuthChecker>
    <PageHeader Title="主子表配置" OnBack="GoBack">
        <PageHeaderExtra>
            <Space>
                <SpaceItem>
                    <Button OnClick="HandleSave" Type="@ButtonType.Primary" Loading="@_saving" Disabled="@(!_hasChanges)">
                        <Icon Type="save" /> 保存配置
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button OnClick="PreviewStructure" Loading="@_previewing">
                        <Icon Type="eye" /> 预览结构
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button OnClick="GoBack">
                        取消
                    </Button>
                </SpaceItem>
            </Space>
        </PageHeaderExtra>
    </PageHeader>

    @if (_loading)
    {
        <div style="text-align: center; padding: 50px;">
            <Spin Size="large" />
        </div>
    }
    else if (_entity == null)
    {
        <Result Status="404" Title="实体不存在" SubTitle="未找到指定的实体定义" />
    }
    else
    {
        <!-- 实体基本信息 -->
        <Card Title="实体信息" Style="margin-bottom: 16px;">
            <Descriptions Bordered Column="2">
                <DescriptionsItem Title="实体名称">@_entity.EntityName</DescriptionsItem>
                <DescriptionsItem Title="显示名">@_entity.DisplayNameKey</DescriptionsItem>
                <DescriptionsItem Title="完整类型">@_entity.FullTypeName</DescriptionsItem>
                <DescriptionsItem Title="当前结构">
                    <Tag Color="@GetStructureTypeColor(_entity.StructureType)">@GetStructureTypeText(_entity.StructureType)</Tag>
                </DescriptionsItem>
            </Descriptions>
        </Card>

        <!-- 结构类型配置 -->
        <Card Title="结构类型" Style="margin-bottom: 16px;">
            <Form Model="@_config" LabelColSpan="4" WrapperColSpan="20">
                <FormItem Label="结构类型">
                    <RadioGroup @bind-Value="@_config.StructureType" OnChange="OnStructureTypeChange">
                        <Radio RadioButton Value="Single">
                            <Icon Type="file" /> 单一实体
                        </Radio>
                        <Radio RadioButton Value="MasterDetail">
                            <Icon Type="node-index" /> 主子结构（两层）
                        </Radio>
                        <Radio RadioButton Value="MasterDetailGrandchild">
                            <Icon Type="apartment" /> 主子孙结构（三层）
                        </Radio>
                    </RadioGroup>
                    <div class="ant-form-text" style="margin-top: 8px;">
                        @GetStructureTypeDescription(_config.StructureType)
                    </div>
                </FormItem>
            </Form>
        </Card>

        <!-- 子实体配置（仅在主子结构时显示） -->
        @if (_config.StructureType != "Single")
        {
            <Card Title="子实体配置" Style="margin-bottom: 16px;">
                <CardExtra>
                    <Button OnClick="ShowAddChildDialog" Type="@ButtonType.Dashed" Size="@ButtonSize.Small">
                        <Icon Type="plus" /> 添加子实体
                    </Button>
                </CardExtra>

                @if (_config.Children == null || !_config.Children.Any())
                {
                    <Empty Description="尚未配置子实体">
                        <EmptyFooter>
                            <Button Type="@ButtonType.Primary" OnClick="ShowAddChildDialog">
                                立即添加
                            </Button>
                        </EmptyFooter>
                    </Empty>
                }
                else
                {
                    <Table TItem="ChildEntityConfig" DataSource="@_config.Children" Bordered Size="@TableSize.Small">
                        <PropertyColumn Property="c => c.ChildEntityName" Title="子实体名称" />
                        <PropertyColumn Property="c => c.ForeignKeyField" Title="外键字段">
                            <Input @bind-Value="@context.ForeignKeyField" Size="@InputSize.Small" Placeholder="如: OrderId" />
                        </PropertyColumn>
                        <PropertyColumn Property="c => c.CollectionProperty" Title="集合属性名">
                            <Input @bind-Value="@context.CollectionProperty" Size="@InputSize.Small" Placeholder="如: OrderLines" />
                        </PropertyColumn>
                        <PropertyColumn Property="c => c.CascadeDeleteBehavior" Title="级联删除">
                            <Select @bind-Value="@context.CascadeDeleteBehavior" Size="@SelectSize.Small" Style="width: 120px;">
                                <SelectOption Value="NoAction" Label="无操作" />
                                <SelectOption Value="Cascade" Label="级联删除" />
                                <SelectOption Value="SetNull" Label="设置NULL" />
                                <SelectOption Value="Restrict" Label="限制" />
                            </Select>
                        </PropertyColumn>
                        <PropertyColumn Property="c => c.AutoCascadeSave" Title="自动保存">
                            <Switch @bind-Value="@context.AutoCascadeSave" Size="@SwitchSize.Small" />
                        </PropertyColumn>
                        <ActionColumn Title="操作">
                            <Space Size="@SpaceSize.Small">
                                <SpaceItem>
                                    <Button Size="@ButtonSize.Small" Danger OnClick="() => RemoveChild(context)">
                                        <Icon Type="delete" /> 移除
                                    </Button>
                                </SpaceItem>
                            </Space>
                        </ActionColumn>
                    </Table>
                }
            </Card>
        }

        <!-- 配置说明 -->
        <Card Title="配置说明">
            <Descriptions Bordered Column="1">
                <DescriptionsItem Title="外键字段">
                    子实体中指向父实体的外键字段名，如 OrderId（必须是父实体的主键类型）
                </DescriptionsItem>
                <DescriptionsItem Title="集合属性名">
                    在父实体的 AggVO 中，子实体的集合属性名称，如 OrderLines
                </DescriptionsItem>
                <DescriptionsItem Title="级联删除行为">
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><strong>无操作</strong>：删除父实体时不影响子实体（逻辑删除除外）</li>
                        <li><strong>级联删除</strong>：删除父实体时自动逻辑删除所有子实体</li>
                        <li><strong>设置NULL</strong>：删除父实体时将子实体的外键设置为NULL</li>
                        <li><strong>限制</strong>：如果有子实体存在，则阻止删除父实体</li>
                    </ul>
                </DescriptionsItem>
                <DescriptionsItem Title="自动级联保存">
                    启用后，保存父实体时会自动保存所有子实体的修改
                </DescriptionsItem>
            </Descriptions>
        </Card>
    }

    <!-- 添加子实体对话框 -->
    <Modal Title="添加子实体"
           @bind-Visible="@_showAddChildDialog"
           OnOk="HandleAddChild"
           OnCancel="() => _showAddChildDialog = false"
           OkText="添加"
           CancelText="取消">
        <Form Model="@_newChild" LabelColSpan="6" WrapperColSpan="18">
            <FormItem Label="子实体">
                <Select @bind-Value="@_newChild.ChildEntityId"
                        Placeholder="选择子实体"
                        AllowClear
                        ShowSearch
                        Loading="@_loadingCandidates">
                    @foreach (var candidate in _childCandidates)
                    {
                        <SelectOption Value="@candidate.Id" Label="@candidate.EntityName">
                            <Space>
                                <SpaceItem>@candidate.EntityName</SpaceItem>
                                <SpaceItem><Tag>@candidate.StructureType</Tag></SpaceItem>
                            </Space>
                        </SelectOption>
                    }
                </Select>
            </FormItem>

            <FormItem Label="外键字段">
                <Input @bind-Value="@_newChild.ForeignKeyField" Placeholder="如: OrderId" />
            </FormItem>

            <FormItem Label="集合属性名">
                <Input @bind-Value="@_newChild.CollectionProperty" Placeholder="如: OrderLines" />
            </FormItem>

            <FormItem Label="级联删除">
                <RadioGroup @bind-Value="@_newChild.CascadeDeleteBehavior">
                    <Radio Value="NoAction">无操作</Radio>
                    <Radio Value="Cascade">级联删除</Radio>
                    <Radio Value="SetNull">设置NULL</Radio>
                    <Radio Value="Restrict">限制</Radio>
                </RadioGroup>
            </FormItem>

            <FormItem Label="自动保存">
                <Switch @bind-Value="@_newChild.AutoCascadeSave" CheckedChildren="是" UnCheckedChildren="否" />
            </FormItem>
        </Form>
    </Modal>

    <!-- 结构预览对话框 -->
    <Modal Title="实体结构预览"
           @bind-Visible="@_showPreviewDialog"
           Width="800"
           Footer="null">
        @if (_structurePreview != null)
        {
            <div style="font-family: 'Courier New', monospace; background: #f5f5f5; padding: 16px; border-radius: 4px;">
                <pre>@_structurePreview</pre>
            </div>
        }
    </Modal>
</AuthChecker>

@code {
    [Parameter]
    public Guid EntityId { get; set; }

    private bool _loading = true;
    private bool _saving = false;
    private bool _previewing = false;
    private bool _hasChanges = false;
    private bool _loadingCandidates = false;
    private bool _showAddChildDialog = false;
    private bool _showPreviewDialog = false;

    private EntityDefinitionDto? _entity;
    private MasterDetailConfigRequest _config = new();
    private List<EntityCandidateDto> _childCandidates = new();
    private ChildEntityConfig _newChild = new();
    private string? _structurePreview;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntity();
        await LoadChildCandidates();
    }

    private async Task LoadEntity()
    {
        _loading = true;
        try
        {
            // 加载实体基本信息
            var response = await Http.GetAsync($"/api/entity-definitions/{EntityId}");
            if (response.IsSuccessStatusCode)
            {
                _entity = await response.Content.ReadFromJsonAsync<EntityDefinitionDto>();
                if (_entity != null)
                {
                    _config.StructureType = _entity.StructureType;

                    // 加载已配置的子实体
                    var childrenResponse = await Http.GetAsync($"/api/entity-advanced/{EntityId}/children");
                    if (childrenResponse.IsSuccessStatusCode)
                    {
                        var childrenData = await childrenResponse.Content.ReadFromJsonAsync<ChildrenResponseDto>();
                        if (childrenData?.Children != null)
                        {
                            _config.Children = childrenData.Children.Select(c => new ChildEntityConfig
                            {
                                ChildEntityId = c.Id,
                                ChildEntityName = c.EntityName,
                                ForeignKeyField = c.ParentForeignKeyField ?? "",
                                CollectionProperty = c.ParentCollectionProperty ?? "",
                                CascadeDeleteBehavior = c.CascadeDeleteBehavior ?? "NoAction",
                                AutoCascadeSave = c.AutoCascadeSave ?? true
                            }).ToList();
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            await Message.Error($"加载失败: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadChildCandidates()
    {
        _loadingCandidates = true;
        try
        {
            var response = await Http.GetAsync("/api/entity-advanced/detail-candidates");
            if (response.IsSuccessStatusCode)
            {
                _childCandidates = await response.Content.ReadFromJsonAsync<List<EntityCandidateDto>>() ?? new();
            }
        }
        catch (Exception ex)
        {
            await Message.Error($"加载候选实体失败: {ex.Message}");
        }
        finally
        {
            _loadingCandidates = false;
        }
    }

    private void OnStructureTypeChange(string newValue)
    {
        _hasChanges = true;
        if (newValue == "Single")
        {
            _config.Children?.Clear();
        }
    }

    private void ShowAddChildDialog()
    {
        _newChild = new ChildEntityConfig
        {
            CascadeDeleteBehavior = "NoAction",
            AutoCascadeSave = true
        };
        _showAddChildDialog = true;
    }

    private void HandleAddChild()
    {
        if (_newChild.ChildEntityId == Guid.Empty)
        {
            Message.Warning("请选择子实体");
            return;
        }

        if (string.IsNullOrWhiteSpace(_newChild.ForeignKeyField))
        {
            Message.Warning("请输入外键字段名");
            return;
        }

        if (string.IsNullOrWhiteSpace(_newChild.CollectionProperty))
        {
            Message.Warning("请输入集合属性名");
            return;
        }

        // 检查是否已添加
        if (_config.Children?.Any(c => c.ChildEntityId == _newChild.ChildEntityId) == true)
        {
            Message.Warning("该子实体已添加");
            return;
        }

        // 设置子实体名称
        var candidate = _childCandidates.FirstOrDefault(c => c.Id == _newChild.ChildEntityId);
        if (candidate != null)
        {
            _newChild.ChildEntityName = candidate.EntityName;
        }

        _config.Children ??= new List<ChildEntityConfig>();
        _config.Children.Add(_newChild);
        _hasChanges = true;
        _showAddChildDialog = false;
    }

    private void RemoveChild(ChildEntityConfig child)
    {
        _config.Children?.Remove(child);
        _hasChanges = true;
    }

    private async Task HandleSave()
    {
        _saving = true;
        try
        {
            var response = await Http.PostAsJsonAsync($"/api/entity-advanced/{EntityId}/configure-master-detail", _config);
            if (response.IsSuccessStatusCode)
            {
                await Message.Success("配置已保存");
                _hasChanges = false;
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await Message.Error($"保存失败: {error}");
            }
        }
        catch (Exception ex)
        {
            await Message.Error($"保存失败: {ex.Message}");
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task PreviewStructure()
    {
        _previewing = true;
        try
        {
            // 生成结构预览
            var sb = new System.Text.StringBuilder();
            sb.AppendLine($"实体：{_entity?.EntityName}");
            sb.AppendLine($"结构类型：{GetStructureTypeText(_config.StructureType)}");
            sb.AppendLine();

            if (_config.Children?.Any() == true)
            {
                sb.AppendLine("子实体：");
                foreach (var child in _config.Children)
                {
                    sb.AppendLine($"  ├─ {child.ChildEntityName}");
                    sb.AppendLine($"  │  外键：{child.ForeignKeyField}");
                    sb.AppendLine($"  │  集合：{child.CollectionProperty}");
                    sb.AppendLine($"  │  级联删除：{child.CascadeDeleteBehavior}");
                    sb.AppendLine($"  │  自动保存：{(child.AutoCascadeSave ? "是" : "否")}");
                    sb.AppendLine();
                }
            }

            _structurePreview = sb.ToString();
            _showPreviewDialog = true;
        }
        catch (Exception ex)
        {
            await Message.Error($"预览失败: {ex.Message}");
        }
        finally
        {
            _previewing = false;
        }
    }

    private void GoBack()
    {
        Nav.NavigateTo("/entity-definitions");
    }

    private string GetStructureTypeText(string type) => type switch
    {
        "Single" => "单一实体",
        "MasterDetail" => "主子结构",
        "MasterDetailGrandchild" => "主子孙结构",
        _ => type
    };

    private string GetStructureTypeColor(string type) => type switch
    {
        "Single" => "default",
        "MasterDetail" => "blue",
        "MasterDetailGrandchild" => "purple",
        _ => "default"
    };

    private string GetStructureTypeDescription(string type) => type switch
    {
        "Single" => "独立的实体表，无父子关系",
        "MasterDetail" => "两层结构：主表 + 多个子表（如订单 + 订单行）",
        "MasterDetailGrandchild" => "三层结构：主表 + 子表 + 孙表（如订单 + 订单行 + 订单行属性）",
        _ => ""
    };

    // DTO Classes
    public class EntityDefinitionDto
    {
        public Guid Id { get; set; }
        public string EntityName { get; set; } = "";
        public string DisplayNameKey { get; set; } = "";
        public string FullTypeName { get; set; } = "";
        public string StructureType { get; set; } = "Single";
    }

    public class MasterDetailConfigRequest
    {
        public string StructureType { get; set; } = "Single";
        public List<ChildEntityConfig>? Children { get; set; }
    }

    public class ChildEntityConfig
    {
        public Guid ChildEntityId { get; set; }
        public string ChildEntityName { get; set; } = "";
        public string ForeignKeyField { get; set; } = "";
        public string CollectionProperty { get; set; } = "";
        public string CascadeDeleteBehavior { get; set; } = "NoAction";
        public bool AutoCascadeSave { get; set; } = true;
    }

    public class EntityCandidateDto
    {
        public Guid Id { get; set; }
        public string EntityName { get; set; } = "";
        public string FullTypeName { get; set; } = "";
        public string StructureType { get; set; } = "";
        public string DisplayNameKey { get; set; } = "";
        public int FieldCount { get; set; }
    }

    public class ChildrenResponseDto
    {
        public Guid EntityId { get; set; }
        public string EntityName { get; set; } = "";
        public string StructureType { get; set; } = "";
        public int ChildCount { get; set; }
        public List<ChildEntityDto> Children { get; set; } = new();
    }

    public class ChildEntityDto
    {
        public Guid Id { get; set; }
        public string EntityName { get; set; } = "";
        public string FullTypeName { get; set; } = "";
        public string StructureType { get; set; } = "";
        public string? ParentForeignKeyField { get; set; }
        public string? ParentCollectionProperty { get; set; }
        public string? CascadeDeleteBehavior { get; set; }
        public bool? AutoCascadeSave { get; set; }
        public int FieldCount { get; set; }
    }
}
