@page "/entity-definitions/{EntityId:guid}/master-detail"
@rendermode RenderMode.InteractiveServer
@inject HttpClient Http
@inject BobCrm.App.Services.I18nService I18n
@inject NavigationManager Nav
@inject IMessageService Message
@using System.Text.Json
@using System.Net.Http.Json

<AuthChecker>
    <PageHeader Title="@I18n.T("LBL_MASTER_DETAIL_CONFIG")" OnBack="GoBack">
        <PageHeaderExtra>
            <Space>
                <SpaceItem>
                    <Button OnClick="HandleSave" Type="@ButtonType.Primary" Loading="@_saving" Disabled="@(!_hasChanges)">
                        <Icon Type="save" /> @I18n.T("BTN_SAVE_CONFIG")
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button OnClick="PreviewStructure" Loading="@_previewing">
                        <Icon Type="eye" /> @I18n.T("BTN_PREVIEW_STRUCTURE")
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button OnClick="GoBack">
                        @I18n.T("BTN_CANCEL")
                    </Button>
                </SpaceItem>
            </Space>
        </PageHeaderExtra>
    </PageHeader>

    @if (_loading)
    {
        <div style="text-align: center; padding: 50px;">
            <Spin Size="large" />
        </div>
    }
    else if (_entity == null)
    {
        <Result Status="404" Title="@I18n.T("MSG_ENTITY_NOT_FOUND")" SubTitle="@I18n.T("MSG_ENTITY_NOT_FOUND_DESC")" />
    }
    else
    {
        <!-- 实体基本信息 -->
        <Card Title="@I18n.T("LBL_ENTITY_INFO")" Style="margin-bottom: 16px;">
            <Descriptions Bordered Column="2">
                <DescriptionsItem Title="@I18n.T("LBL_ENTITY_NAME")">@_entity.EntityName</DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("LBL_DISPLAY_NAME")">@_entity.DisplayNameKey</DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("LBL_FULL_TYPE")">@_entity.FullTypeName</DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("LBL_CURRENT_STRUCTURE")">
                    <Tag Color="@GetStructureTypeColor(_entity.StructureType)">@GetStructureTypeText(_entity.StructureType)</Tag>
                </DescriptionsItem>
            </Descriptions>
        </Card>

        <!-- 结构类型配置 -->
        <Card Title="@I18n.T("LBL_STRUCTURE_TYPE")" Style="margin-bottom: 16px;">
            <Form Model="@_config" LabelColSpan="4" WrapperColSpan="20">
                <FormItem Label="@I18n.T("LBL_STRUCTURE_TYPE")">
                    <RadioGroup Value="@_config.StructureType" ValueChanged="@(EventCallback.Factory.Create<string>(this, HandleStructureTypeChanged))">
                        <Radio Value="@("Single")">
                            <Icon Type="file" /> @I18n.T("LBL_SINGLE_ENTITY")
                        </Radio>
                        <Radio Value="@("MasterDetail")">
                            <Icon Type="node-index" /> @I18n.T("LBL_MASTER_DETAIL_TWO_LEVEL")
                        </Radio>
                        <Radio Value="@("MasterDetailGrandchild")">
                            <Icon Type="apartment" /> @I18n.T("LBL_MASTER_DETAIL_THREE_LEVEL")
                        </Radio>
                    </RadioGroup>
                    <div class="ant-form-text" style="margin-top: 8px;">
                        @GetStructureTypeDescription(_config.StructureType)
                    </div>
                </FormItem>
            </Form>
        </Card>

        <!-- 子实体配置（仅在主子结构时显示） -->
        @if (_config.StructureType != "Single")
        {
            <Card Title="@I18n.T("LBL_CHILD_ENTITY_CONFIG")" Style="margin-bottom: 16px;">
                <Extra>
                    <Button OnClick="ShowAddChildDialog" Type="@ButtonType.Dashed" Size="@ButtonSize.Small">
                        <Icon Type="plus" /> @I18n.T("BTN_ADD_CHILD_ENTITY")
                    </Button>
                </Extra>
                <Body>
                @if (_config.Children == null || !_config.Children.Any())
                {
                    <div>
                        <Empty Description="@I18n.T("MSG_NO_CHILD_ENTITY_CONFIGURED")" />
                        <div style="text-align: center; margin-top: 16px;">
                            <Button Type="@ButtonType.Primary" OnClick="ShowAddChildDialog">
                                @I18n.T("BTN_ADD_NOW")
                            </Button>
                        </div>
                    </div>
                }
                else
                {
                    <Table TItem="ChildEntityConfig" DataSource="@_config.Children" Bordered Size="@TableSize.Small">
                        <PropertyColumn Property="c => c.ChildEntityName" Title="@I18n.T("LBL_CHILD_ENTITY_NAME")" />
                        <PropertyColumn Property="c => c.ForeignKeyField" Title="@I18n.T("LBL_FOREIGN_KEY_FIELD")">
                            <Input @bind-Value="@context.ForeignKeyField" Size="small" Placeholder="@I18n.T("TXT_PLACEHOLDER_ORDER_ID")" Class="field-control" />
                        </PropertyColumn>
                        <PropertyColumn Property="c => c.CollectionProperty" Title="@I18n.T("LBL_COLLECTION_PROPERTY")">
                            <Input @bind-Value="@context.CollectionProperty" Size="small" Placeholder="@I18n.T("TXT_PLACEHOLDER_ORDER_LINES")" Class="field-control" />
                        </PropertyColumn>
                        <PropertyColumn Property="c => c.CascadeDeleteBehavior" Title="@I18n.T("LBL_CASCADE_DELETE")">
                            <Select TItemValue="string" TItem="string" @bind-Value="@context.CascadeDeleteBehavior" Size="small" Style="width: 120px;">
                                <SelectOptions>
                                    <SelectOption TItemValue="string" TItem="string" Value="@("NoAction")" Label="@I18n.T("LBL_CASCADE_NO_ACTION")" />
                                    <SelectOption TItemValue="string" TItem="string" Value="@("Cascade")" Label="@I18n.T("LBL_CASCADE_DELETE")" />
                                    <SelectOption TItemValue="string" TItem="string" Value="@("SetNull")" Label="@I18n.T("LBL_CASCADE_SET_NULL")" />
                                    <SelectOption TItemValue="string" TItem="string" Value="@("Restrict")" Label="@I18n.T("LBL_CASCADE_RESTRICT")" />
                                </SelectOptions>
                            </Select>
                        </PropertyColumn>
                        <PropertyColumn Property="c => c.AutoCascadeSave" Title="@I18n.T("LBL_AUTO_SAVE")">
                            <Switch @bind-Value="@context.AutoCascadeSave" Size="small" />
                        </PropertyColumn>
                        <ActionColumn Title="@I18n.T("LBL_ACTIONS")">
                            <Space>
                                <SpaceItem>
                                    <Button Size="@ButtonSize.Small" Danger OnClick="() => RemoveChild(context)">
                                        <Icon Type="delete" /> @I18n.T("BTN_REMOVE")
                                    </Button>
                                </SpaceItem>
                            </Space>
                        </ActionColumn>
                    </Table>
                }
                </Body>
            </Card>
        }

        <!-- 配置说明 -->
        <Card Title="@I18n.T("LBL_CONFIG_DESCRIPTION")">
            <Descriptions Bordered Column="1">
                <DescriptionsItem Title="@I18n.T("LBL_FOREIGN_KEY_FIELD")">
                    @I18n.T("TXT_FOREIGN_KEY_FIELD_DESC")
                </DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("LBL_COLLECTION_PROPERTY")">
                    @I18n.T("TXT_COLLECTION_PROPERTY_DESC")
                </DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("LBL_CASCADE_DELETE_BEHAVIOR")">
                    <ul style="margin: 0; padding-left: 20px;">
                        <li><strong>@I18n.T("LBL_CASCADE_NO_ACTION")</strong>：@I18n.T("TXT_CASCADE_NO_ACTION_DESC")</li>
                        <li><strong>@I18n.T("LBL_CASCADE_DELETE")</strong>：@I18n.T("TXT_CASCADE_DELETE_DESC")</li>
                        <li><strong>@I18n.T("LBL_CASCADE_SET_NULL")</strong>：@I18n.T("TXT_CASCADE_SET_NULL_DESC")</li>
                        <li><strong>@I18n.T("LBL_CASCADE_RESTRICT")</strong>：@I18n.T("TXT_CASCADE_RESTRICT_DESC")</li>
                    </ul>
                </DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("LBL_AUTO_CASCADE_SAVE")">
                    @I18n.T("TXT_AUTO_CASCADE_SAVE_DESC")
                </DescriptionsItem>
            </Descriptions>
        </Card>
    }

    <!-- 添加子实体对话框 -->
    <Modal Title="@I18n.T("LBL_ADD_CHILD_ENTITY")" WrapClassName="calm-modal"
           @bind-Visible="@_showAddChildDialog"
           OnOk="HandleAddChild"
           OnCancel="() => _showAddChildDialog = false"
           OkText="@I18n.T("BTN_ADD")"
           CancelText="@I18n.T("BTN_CANCEL")">
        <Form Model="@_newChild" LabelColSpan="6" WrapperColSpan="18">
            <FormItem Label="@I18n.T("LBL_CHILD_ENTITY")">
                <Select TItemValue="Guid" TItem="ChildEntityDto" @bind-Value="@_newChild.ChildEntityId"
                        Placeholder="@I18n.T("TXT_SELECT_CHILD_ENTITY")"
                        AllowClear
                        ShowSearch
                        Loading="@_loadingCandidates">
                    <SelectOptions>
                        @foreach (var candidate in _childCandidates)
                        {
                            <SelectOption TItemValue="Guid" TItem="ChildEntityDto" Value="@candidate.Id" Label="@candidate.EntityName">
                                <Space>
                                    <SpaceItem>@candidate.EntityName</SpaceItem>
                                    <SpaceItem><Tag>@candidate.StructureType</Tag></SpaceItem>
                                </Space>
                            </SelectOption>
                        }
                    </SelectOptions>
                </Select>
            </FormItem>

            <FormItem Label="@I18n.T("LBL_FOREIGN_KEY_FIELD")">
                <Input @bind-Value="@_newChild.ForeignKeyField" Placeholder="@I18n.T("TXT_PLACEHOLDER_ORDER_ID")" Class="field-control" />
            </FormItem>

            <FormItem Label="@I18n.T("LBL_COLLECTION_PROPERTY")">
                <Input @bind-Value="@_newChild.CollectionProperty" Placeholder="@I18n.T("TXT_PLACEHOLDER_ORDER_LINES")" Class="field-control" />
            </FormItem>

            <FormItem Label="@I18n.T("LBL_CASCADE_DELETE")">
                <RadioGroup @bind-Value="@_newChild.CascadeDeleteBehavior">
                    <Radio Value="@("NoAction")">@I18n.T("LBL_CASCADE_NO_ACTION")</Radio>
                    <Radio Value="@("Cascade")">@I18n.T("LBL_CASCADE_DELETE")</Radio>
                    <Radio Value="@("SetNull")">@I18n.T("LBL_CASCADE_SET_NULL")</Radio>
                    <Radio Value="@("Restrict")">@I18n.T("LBL_CASCADE_RESTRICT")</Radio>
                </RadioGroup>
            </FormItem>

            <FormItem Label="@I18n.T("LBL_AUTO_SAVE")">
                <Switch @bind-Value="@_newChild.AutoCascadeSave" CheckedChildren="@I18n.T("TXT_YES")" UnCheckedChildren="@I18n.T("TXT_NO")" />
            </FormItem>
        </Form>
    </Modal>

    <!-- 结构预览对话框 -->
    <Modal Title="@I18n.T("LBL_ENTITY_STRUCTURE_PREVIEW")" WrapClassName="calm-modal"
           @bind-Visible="@_showPreviewDialog"
           Width="800"
           Footer="null">
        @if (_structurePreview != null)
        {
            <div style="font-family: 'Courier New', monospace; background: #f5f5f5; padding: 16px; border-radius: 4px;">
                <pre>@_structurePreview</pre>
            </div>
        }
    </Modal>
</AuthChecker>

@code {
    [Parameter]
    public Guid EntityId { get; set; }

    [CascadingParameter]
    public int I18nRenderVersion { get; set; }

    private bool _loading = true;
    private bool _saving = false;
    private bool _previewing = false;
    private bool _hasChanges = false;
    private bool _loadingCandidates = false;
    private bool _showAddChildDialog = false;
    private bool _showPreviewDialog = false;
    private int _lastI18nRenderVersion = -1;

    private EntityDefinitionDto? _entity;
    private MasterDetailConfigRequest _config = new();
    private List<EntityCandidateDto> _childCandidates = new();
    private ChildEntityConfig _newChild = new();
    private string? _structurePreview;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntity();
        await LoadChildCandidates();
    }

    protected override void OnParametersSet()
    {
        if (_lastI18nRenderVersion != I18nRenderVersion)
        {
            _lastI18nRenderVersion = I18nRenderVersion;
            StateHasChanged();
        }
    }

    private async Task LoadEntity()
    {
        _loading = true;
        try
        {
            // 加载实体基本信息
            var response = await Http.GetAsync($"/api/entity-definitions/{EntityId}");
            if (response.IsSuccessStatusCode)
            {
                _entity = await response.Content.ReadFromJsonAsync<EntityDefinitionDto>();
                if (_entity != null)
                {
                    _config.StructureType = _entity.StructureType;

                    // 加载已配置的子实体
                    var childrenResponse = await Http.GetAsync($"/api/entity-advanced/{EntityId}/children");
                    if (childrenResponse.IsSuccessStatusCode)
                    {
                        var childrenData = await childrenResponse.Content.ReadFromJsonAsync<ChildrenResponseDto>();
                        if (childrenData?.Children != null)
                        {
                            _config.Children = childrenData.Children.Select(c => new ChildEntityConfig
                            {
                                ChildEntityId = c.Id,
                                ChildEntityName = c.EntityName,
                                ForeignKeyField = c.ParentForeignKeyField ?? "",
                                CollectionProperty = c.ParentCollectionProperty ?? "",
                                CascadeDeleteBehavior = c.CascadeDeleteBehavior ?? "NoAction",
                                AutoCascadeSave = c.AutoCascadeSave ?? true
                            }).ToList();
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            await Message.Error($"{I18n.T("MSG_LOAD_FAILED")}: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadChildCandidates()
    {
        _loadingCandidates = true;
        try
        {
            var response = await Http.GetAsync("/api/entity-advanced/detail-candidates");
            if (response.IsSuccessStatusCode)
            {
                _childCandidates = await response.Content.ReadFromJsonAsync<List<EntityCandidateDto>>() ?? new();
            }
        }
        catch (Exception ex)
        {
            await Message.Error($"{I18n.T("MSG_LOAD_CANDIDATES_FAILED")}: {ex.Message}");
        }
        finally
        {
            _loadingCandidates = false;
        }
    }

    private void HandleStructureTypeChanged(string newValue)
    {
        _config.StructureType = newValue;
        _hasChanges = true;
        if (newValue == "Single")
        {
            _config.Children?.Clear();
        }
    }

    private void ShowAddChildDialog()
    {
        _newChild = new ChildEntityConfig
        {
            CascadeDeleteBehavior = "NoAction",
            AutoCascadeSave = true
        };
        _showAddChildDialog = true;
    }

    private void HandleAddChild()
    {
        if (_newChild.ChildEntityId == Guid.Empty)
        {
            Message.Warning(I18n.T("MSG_PLEASE_SELECT_CHILD_ENTITY"));
            return;
        }

        if (string.IsNullOrWhiteSpace(_newChild.ForeignKeyField))
        {
            Message.Warning(I18n.T("MSG_PLEASE_INPUT_FOREIGN_KEY"));
            return;
        }

        if (string.IsNullOrWhiteSpace(_newChild.CollectionProperty))
        {
            Message.Warning(I18n.T("MSG_PLEASE_INPUT_COLLECTION_PROPERTY"));
            return;
        }

        // 检查是否已添加
        if (_config.Children?.Any(c => c.ChildEntityId == _newChild.ChildEntityId) == true)
        {
            Message.Warning(I18n.T("MSG_CHILD_ENTITY_ALREADY_ADDED"));
            return;
        }

        // 设置子实体名称
        var candidate = _childCandidates.FirstOrDefault(c => c.Id == _newChild.ChildEntityId);
        if (candidate != null)
        {
            _newChild.ChildEntityName = candidate.EntityName;
        }

        _config.Children ??= new List<ChildEntityConfig>();
        _config.Children.Add(_newChild);
        _hasChanges = true;
        _showAddChildDialog = false;
    }

    private void RemoveChild(ChildEntityConfig child)
    {
        _config.Children?.Remove(child);
        _hasChanges = true;
    }

    private async Task HandleSave()
    {
        _saving = true;
        try
        {
            var response = await Http.PostAsJsonAsync($"/api/entity-advanced/{EntityId}/configure-master-detail", _config);
            if (response.IsSuccessStatusCode)
            {
                await Message.Success(I18n.T("MSG_CONFIG_SAVED"));
                _hasChanges = false;
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await Message.Error($"{I18n.T("MSG_SAVE_FAILED")}: {error}");
            }
        }
        catch (Exception ex)
        {
            await Message.Error($"{I18n.T("MSG_SAVE_FAILED")}: {ex.Message}");
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task PreviewStructure()
    {
        _previewing = true;
        try
        {
            // 生成结构预览
            var sb = new System.Text.StringBuilder();
            sb.AppendLine($"{I18n.T("LBL_ENTITY")}: {_entity?.EntityName}");
            sb.AppendLine($"{I18n.T("LBL_STRUCTURE_TYPE")}: {GetStructureTypeText(_config.StructureType)}");
            sb.AppendLine();

            if (_config.Children?.Any() == true)
            {
                sb.AppendLine($"{I18n.T("LBL_CHILD_ENTITIES")}:");
                foreach (var child in _config.Children)
                {
                    sb.AppendLine($"  ├─ {child.ChildEntityName}");
                    sb.AppendLine($"  │  {I18n.T("LBL_FOREIGN_KEY")}: {child.ForeignKeyField}");
                    sb.AppendLine($"  │  {I18n.T("LBL_COLLECTION")}: {child.CollectionProperty}");
                    sb.AppendLine($"  │  {I18n.T("LBL_CASCADE_DELETE")}: {child.CascadeDeleteBehavior}");
                    sb.AppendLine($"  │  {I18n.T("LBL_AUTO_SAVE")}: {(child.AutoCascadeSave ? I18n.T("TXT_YES") : I18n.T("TXT_NO"))}");
                    sb.AppendLine();
                }
            }

            _structurePreview = sb.ToString();
            _showPreviewDialog = true;
        }
        catch (Exception ex)
        {
            await Message.Error($"{I18n.T("MSG_PREVIEW_FAILED")}: {ex.Message}");
        }
        finally
        {
            _previewing = false;
        }
    }

    private void GoBack()
    {
        Nav.NavigateTo("/entity-definitions");
    }

    private string GetStructureTypeText(string type) => type switch
    {
        "Single" => I18n.T("LBL_SINGLE_ENTITY"),
        "MasterDetail" => I18n.T("LBL_MASTER_DETAIL"),
        "MasterDetailGrandchild" => I18n.T("LBL_MASTER_DETAIL_GRANDCHILD"),
        _ => type
    };

    private string GetStructureTypeColor(string type) => type switch
    {
        "Single" => "default",
        "MasterDetail" => "blue",
        "MasterDetailGrandchild" => "purple",
        _ => "default"
    };

    private string GetStructureTypeDescription(string type) => type switch
    {
        "Single" => I18n.T("TXT_SINGLE_ENTITY_DESC"),
        "MasterDetail" => I18n.T("TXT_MASTER_DETAIL_DESC"),
        "MasterDetailGrandchild" => I18n.T("TXT_MASTER_DETAIL_GRANDCHILD_DESC"),
        _ => ""
    };

    // DTO Classes
    public class EntityDefinitionDto
    {
        public Guid Id { get; set; }
        public string EntityName { get; set; } = "";
        public string DisplayNameKey { get; set; } = "";
        public string FullTypeName { get; set; } = "";
        public string StructureType { get; set; } = "Single";
    }

    public class MasterDetailConfigRequest
    {
        public string StructureType { get; set; } = "Single";
        public List<ChildEntityConfig>? Children { get; set; }
    }

    public class ChildEntityConfig
    {
        public Guid ChildEntityId { get; set; }
        public string ChildEntityName { get; set; } = "";
        public string ForeignKeyField { get; set; } = "";
        public string CollectionProperty { get; set; } = "";
        public string CascadeDeleteBehavior { get; set; } = "NoAction";
        public bool AutoCascadeSave { get; set; } = true;
    }

    public class EntityCandidateDto
    {
        public Guid Id { get; set; }
        public string EntityName { get; set; } = "";
        public string FullTypeName { get; set; } = "";
        public string StructureType { get; set; } = "";
        public string DisplayNameKey { get; set; } = "";
        public int FieldCount { get; set; }
    }

    public class ChildrenResponseDto
    {
        public Guid EntityId { get; set; }
        public string EntityName { get; set; } = "";
        public string StructureType { get; set; } = "";
        public int ChildCount { get; set; }
        public List<ChildEntityDto> Children { get; set; } = new();
    }

    public class ChildEntityDto
    {
        public Guid Id { get; set; }
        public string EntityName { get; set; } = "";
        public string FullTypeName { get; set; } = "";
        public string StructureType { get; set; } = "";
        public string? ParentForeignKeyField { get; set; }
        public string? ParentCollectionProperty { get; set; }
        public string? CascadeDeleteBehavior { get; set; }
        public bool? AutoCascadeSave { get; set; }
        public int FieldCount { get; set; }
    }
}
