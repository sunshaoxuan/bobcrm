@page "/enums"
@rendermode RenderMode.InteractiveServer
@inject BobCrm.App.Services.EnumDefinitionService EnumService
@inject BobCrm.App.Services.I18nService I18n
@inject BobCrm.App.Services.ToastService ToastService
@inject NavigationManager Nav
@using AntDesign
@using BobCrm.Api.Contracts.DTOs
@using System.Linq

<AuthChecker>
    <div class="collection-shell">
        <CollectionHeader Title="@I18n.T("LBL_ENUM_DEFINITION")"
                          Subtitle='@I18n.T("ENUM_SUBTITLE")'
                          Eyebrow="@I18n.T("LBL_COLLECTION")">
            <Actions>
                <Button Type="@ButtonType.Default" OnClick="LoadData" Icon="@IconType.Outline.Reload">
                    @I18n.T("BTN_REFRESH")
                </Button>
                <Button Type="@ButtonType.Primary" OnClick="NavigateToCreate" Icon="@IconType.Outline.Plus">
                    @I18n.T("BTN_NEW_ENUM")
                </Button>
            </Actions>
            <Filters>
                <div class="collection-search">
                    <Input Placeholder="@I18n.T("LBL_SEARCH")"
                           PrefixIcon="@IconType.Outline.Search"
                           AllowClear
                           @bind-Value="_search"
                           Class="field-control" />
                </div>
                <Select TItemValue="bool?" TItem="string" @bind-Value="_isEnabledFilter" Style="min-width:160px">
                    <SelectOption Value="@((bool?)null)">@I18n.T("ENUM_FILTER_ALL")</SelectOption>
                    <SelectOption Value="@((bool?)true)">@I18n.T("ENUM_FILTER_ENABLED")</SelectOption>
                    <SelectOption Value="@((bool?)false)">@I18n.T("ENUM_FILTER_DISABLED")</SelectOption>
                </Select>
            </Filters>
        </CollectionHeader>

        @if (_loading)
        {
            <div style="text-align: center; padding: 50px;">
                <Spin Size="@SpinSize.Large" />
            </div>
        }
        else
        {
            <Card>
                <Table TItem="EnumDefinitionDto"
                       DataSource="@FilteredEnums()"
                       Bordered
                       Size="@TableSize.Small">
                    <Column Title="@I18n.T("LBL_ENUM_CODE")" TData="string" Width="200px">
                        <strong>@context.Code</strong>
                    </Column>
                    <Column Title="@I18n.T("ENUM_COL_DISPLAY_NAME")" TData="string">
                        @GetDisplayName(context.DisplayName, context.DisplayNameTranslations)
                    </Column>
                    <Column Title="@I18n.T("LBL_ENUM_OPTIONS")" TData="int" Width="120px" Align="ColumnAlign.Center">
                        <Tag>@string.Format(I18n.T("ENUM_OPTIONS_COUNT"), context.Options.Count)</Tag>
                    </Column>
                    <Column Title="@I18n.T("ENUM_COL_STATUS")" TData="bool" Width="100px" Align="ColumnAlign.Center">
                        @if (context.IsEnabled)
                        {
                            <Tag Color="@PresetColor.Green.ToString()">@I18n.T("ENUM_STATUS_ENABLED")</Tag>
                        }
                        else
                        {
                            <Tag Color="@PresetColor.Red.ToString()">@I18n.T("ENUM_STATUS_DISABLED")</Tag>
                        }
                    </Column>
                    <ActionColumn Title="@I18n.T("LBL_ACTIONS")" Width="250px" Fixed="ColumnFixPlacement.Right">
                        <Space Size="@("small")">
                            <SpaceItem>
                                <Button Size="@ButtonSize.Small"
                                        Icon="@IconType.Outline.Eye"
                                        OnClick="() => ViewEnum(context.Id)"
                                        Title="@I18n.T("ENUM_BTN_VIEW")">
                                    @I18n.T("ENUM_BTN_VIEW")
                                </Button>
                            </SpaceItem>
                            <SpaceItem>
                                <Button Size="@ButtonSize.Small"
                                        Icon="@IconType.Outline.Edit"
                                        OnClick="() => NavigateToEdit(context.Id)"
                                        Title="@I18n.T("BTN_EDIT")">
                                    @I18n.T("BTN_EDIT")
                                </Button>
                            </SpaceItem>
                            <SpaceItem>
                                <Popconfirm Title="@I18n.T("MSG_CONFIRM_DELETE_ENUM")"
                                            OnConfirm="() => HandleDelete(context.Id)"
                                            OkText="@I18n.T("BTN_DELETE")"
                                            CancelText="@I18n.T("BTN_CANCEL")">
                                    <Button Size="@ButtonSize.Small"
                                            Danger
                                            Icon="@IconType.Outline.Delete"
                                            Title="@I18n.T("BTN_DELETE")">
                                        @I18n.T("BTN_DELETE")
                                    </Button>
                                </Popconfirm>
                            </SpaceItem>
                        </Space>
                    </ActionColumn>
                </Table>
            </Card>
        }
    </div>

    @* View detail modal *@
    <Modal Title="@_viewModalTitle"
           Visible="_viewModalVisible"
           OnOk="CloseViewModal"
           OnCancel="CloseViewModal"
           Footer="null"
           Width="800">
        @if (_viewingEnum != null)
        {
            <Descriptions Bordered Column="2" Size="@DescriptionsSize.Small">
                <DescriptionsItem Title="@I18n.T("LBL_ENUM_CODE")" Span="2">
                    <strong>@_viewingEnum.Code</strong>
                </DescriptionsItem>
                <DescriptionsItem Title='@I18n.T("ENUM_COL_NAME_ZH")'>
                    @(GetDisplayName(_viewingEnum.DisplayName, _viewingEnum.DisplayNameTranslations, "zh-CN") ?? "-")
                </DescriptionsItem>
                <DescriptionsItem Title='@I18n.T("ENUM_COL_NAME_JA")'>
                    @(GetDisplayName(_viewingEnum.DisplayName, _viewingEnum.DisplayNameTranslations, "ja-JP") ?? "-")
                </DescriptionsItem>
                <DescriptionsItem Title='@I18n.T("ENUM_COL_NAME_EN")'>
                    @(GetDisplayName(_viewingEnum.DisplayName, _viewingEnum.DisplayNameTranslations, "en-US") ?? "-")
                </DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("ENUM_COL_STATUS")">
                    @if (_viewingEnum.IsEnabled)
                    {
                        <Tag Color="@PresetColor.Green.ToString()">@I18n.T("ENUM_STATUS_ENABLED")</Tag>
                    }
                    else
                    {
                        <Tag Color="@PresetColor.Red.ToString()">@I18n.T("ENUM_STATUS_DISABLED")</Tag>
                    }
                </DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("ENUM_COL_DESCRIPTION")" Span="2">
                    @(GetDisplayName(_viewingEnum.Description, _viewingEnum.DescriptionTranslations, I18n.CurrentLang) ?? "-")
                </DescriptionsItem>
            </Descriptions>

            <Divider>@I18n.T("LBL_ENUM_OPTIONS")</Divider>

            <Table TItem="EnumOptionDto"
                   DataSource="@_viewingEnum.Options"
                   Bordered
                   Size="@TableSize.Small"
                   PageSize="999">
                <Column Title="@I18n.T("LBL_OPTION_VALUE")" TData="string" Width="200px">
                    <strong>@context.Value</strong>
                </Column>
                <Column Title='@I18n.T("ENUM_COL_NAME_ZH")' TData="string">
                    @(GetDisplayName(context.DisplayName, context.DisplayNameTranslations, "zh-CN") ?? "-")
                </Column>
                <Column Title='@I18n.T("ENUM_COL_NAME_JA")' TData="string">
                    @(GetDisplayName(context.DisplayName, context.DisplayNameTranslations, "ja-JP") ?? "-")
                </Column>
                <Column Title='@I18n.T("ENUM_COL_NAME_EN")' TData="string">
                    @(GetDisplayName(context.DisplayName, context.DisplayNameTranslations, "en-US") ?? "-")
                </Column>
                <Column Title="@I18n.T("LBL_COLOR_TAG")" TData="string" Width="120px" Align="ColumnAlign.Center">
                    @if (!string.IsNullOrEmpty(context.ColorTag))
                    {
                        <Tag Color="@context.ColorTag">@context.ColorTag</Tag>
                    }
                    else
                    {
                        <span>-</span>
                    }
                </Column>
            </Table>

            <div style="margin-top: 16px; text-align: right;">
                <Button Type="@ButtonType.Default" OnClick="CloseViewModal">
                    @I18n.T("BTN_CLOSE")
                </Button>
            </div>
        }
    </Modal>
</AuthChecker>

@code {
    private bool _loading = false;
    private List<EnumDefinitionDto> _enums = new();
    private string _search = string.Empty;
    private bool? _isEnabledFilter = null;

    // View modal state
    private bool _viewModalVisible = false;
    private string _viewModalTitle = "";
    private EnumDefinitionDto? _viewingEnum = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            _enums = await EnumService.GetAllAsync();
        }
        catch (Exception ex)
        {
            ToastService.Error($"{I18n.T("MSG_ENUM_LOAD_FAILED")}: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private IEnumerable<EnumDefinitionDto> FilteredEnums()
    {
        var query = _enums.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(_search))
        {
            query = query.Where(e =>
                e.Code.Contains(_search, StringComparison.OrdinalIgnoreCase)
                || (!string.IsNullOrWhiteSpace(e.DisplayName) && e.DisplayName.Contains(_search, StringComparison.OrdinalIgnoreCase))
                || (e.DisplayNameTranslations != null && e.DisplayNameTranslations.Values.Any(v =>
                    v != null && v.Contains(_search, StringComparison.OrdinalIgnoreCase))));
        }

        if (_isEnabledFilter.HasValue)
        {
            query = query.Where(e => e.IsEnabled == _isEnabledFilter.Value);
        }

        return query.OrderBy(e => e.Code);
    }

    private string GetDisplayName(string? single, Dictionary<string, string?>? translations, string? lang = null)
    {
        if (!string.IsNullOrWhiteSpace(single))
        {
            return single!;
        }

        if (translations == null || translations.Count == 0)
            return "-";

        var langOrder = new[]
        {
            lang ?? I18n.CurrentLang,
            "ja",
            "zh",
            "en"
        };

        foreach (var l in langOrder)
        {
            if (translations.TryGetValue(l, out var name) && !string.IsNullOrWhiteSpace(name))
            {
                return name!;
            }
        }

        return translations.Values.FirstOrDefault(v => !string.IsNullOrWhiteSpace(v)) ?? "-";
    }

    private void NavigateToCreate()
    {
        Nav.NavigateTo("/enums/create");
    }

    private void NavigateToEdit(Guid id)
    {
        Nav.NavigateTo($"/enums/edit/{id}");
    }

    private async Task ViewEnum(Guid id)
    {
        try
        {
            _viewingEnum = await EnumService.GetByIdAsync(id);
            if (_viewingEnum != null)
            {
                _viewModalTitle = $"{I18n.T("LBL_ENUM_DEFINITION")}: {_viewingEnum.Code}";
                _viewModalVisible = true;
            }
            else
            {
                ToastService.Error(I18n.T("MSG_ENUM_LOAD_FAILED"));
            }
        }
        catch (Exception ex)
        {
            ToastService.Error($"{I18n.T("MSG_ENUM_LOAD_FAILED")}: {ex.Message}");
        }
    }

    private void CloseViewModal()
    {
        _viewModalVisible = false;
        _viewingEnum = null;
        _viewModalTitle = "";
    }

    private async Task HandleDelete(Guid id)
    {
        try
        {
            await EnumService.DeleteAsync(id);
            ToastService.Success(I18n.T("MSG_ENUM_DELETE_SUCCESS"));
            await LoadData();
        }
        catch (Exception ex)
        {
            // Check referential integrity constraint
            if (ex.Message.Contains("in use"))
            {
                ToastService.Error(I18n.T("MSG_ENUM_IN_USE"));
            }
            else
            {
                ToastService.Error($"{I18n.T("MSG_DELETE_FAILED")}: {ex.Message}");
            }
        }
    }
}





