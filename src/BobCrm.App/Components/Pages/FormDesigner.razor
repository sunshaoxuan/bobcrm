@page "/designer"
@page "/designer/{TemplateId}"
@rendermode RenderMode.InteractiveServer
@implements IDisposable

@using BobCrm.App.Models
@using BobCrm.App.Models.Widgets
@using BobCrm.App.Services.Widgets
@using BobCrm.App.Services.Widgets.Rendering
@using Microsoft.AspNetCore.Components.Rendering
@inject AntDesign.IMessageService _message
@using BobCrm.App.Components.Designer.ContainerRenderers
@using BobCrm.App.Components.Designer
@using BobCrm.App.Components.Designer.WidgetPreviews
@using BobCrm.App.Services.Designer
@using ListItem = BobCrm.App.Models.Widgets.ListItem;

@inject BobCrm.App.Services.AuthService Auth
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject BobCrm.App.Services.I18nService I18n
@inject IMessageService Message
@inject IDesignWidgetContentRenderer DesignRenderer
@inject IDesignContainerRenderer ContainerRenderer
@inject IWidgetPropertyProvider PropertyProvider

<script src="/js/form-designer-resize.js"></script>

<AuthChecker>
@if (loading)
{
    <div class="text-muted">@I18n.T("LBL_LOADING")...</div>
}
else if (error != null)
{
    <Alert Message="@error" Type="AlertType.Error" ShowIcon="true" />
    <div style="margin-top:16px">
        <Button OnClick="RetryLoad" Style="margin-right:8px">@I18n.T("BTN_RETRY")</Button>
        <Button OnClick="@(() => Nav.NavigateTo("/templates"))">@I18n.T("BTN_BACK")</Button>
    </div>
}
else
{
    <div class="designer-shell">
        <header class="designer-header">
            <div class="designer-header-meta">
                <div>
                    <p class="designer-eyebrow">@I18n.T("MODE_DESIGN")</p>
                    <h2>@templateName</h2>
                </div>
                <Tag Color="@TagColor.Blue">@entityType</Tag>
            </div>
            <div class="designer-header-actions">
                <Button OnClick="CancelAndReturn" Icon="@IconType.Outline.Left">@I18n.T("BTN_CANCEL")</Button>
                <Button Ghost OnClick="@(() => Nav.NavigateTo("/templates"))" Icon="@IconType.Outline.Close">@I18n.T("BTN_EXIT_DESIGN")</Button>
                <Button Type="@ButtonType.Primary" OnClick="SaveLayout" Icon="@IconType.Outline.Save">@I18n.T("BTN_SAVE_LAYOUT")</Button>
            </div>
        </header>

        <div class="designer-main">
            <aside class="designer-panel designer-toolbox" @onclick:stopPropagation>
                <h3>@I18n.T("LBL_COMPONENTS")</h3>
                <Collapse Accordion="true" DefaultActiveKey="@(new[] { "entity" })">
                    <Panel Header="@I18n.T("LBL_ENTITY_STRUCTURE")" Key="entity">
                        <EntityMetadataTree EntityType="@entityType" OnFieldDragStarted="@OnEntityFieldDragStart" />
                    </Panel>
                    <Panel Header="@I18n.T("LBL_BASIC_COMPONENTS")" Key="1">
                        <div class="designer-palette">
                            @foreach (var comp in WidgetRegistry.BasicWidgets)
                            {
                                <div class="designer-palette-item" draggable="true" data-drag-type="component" data-drag-data="@comp.Type"
                                     @ondragstart="@((e) => OnDragStart(e, comp))" @ondragstart:preventDefault="false" @ondragend="OnDragEnd">
                                    <Icon Type="@comp.Icon" />
                                    <span>@I18n.T(comp.LabelKey)</span>
                                </div>
                            }
                        </div>
                    </Panel>
                    <Panel Header="@I18n.T("LBL_LAYOUT_COMPONENTS")" Key="2">
                        <div class="designer-palette">
                            @foreach (var comp in WidgetRegistry.LayoutWidgets)
                            {
                                <div class="designer-palette-item" draggable="true" data-drag-type="component" data-drag-data="@comp.Type"
                                     @ondragstart="@((e) => OnDragStart(e, comp))" @ondragstart:preventDefault="false" @ondragend="OnDragEnd">
                                    <Icon Type="@comp.Icon" />
                                    <span>@I18n.T(comp.LabelKey)</span>
                                </div>
                            }
                        </div>
                    </Panel>
                </Collapse>
            </aside>

            <section class="designer-canvas"
                 @ondrop="OnDrop" @ondrop:preventDefault @ondrop:stopPropagation @ondragover="OnDragOver" @ondragover:preventDefault
                 @onclick="OnCanvasBackgroundClick">
                <div @ref="canvasRef" class="designer-canvas-content layout-widgets-container"
                     @onclick:stopPropagation>
                    @foreach (var widget in layoutWidgets)
                    {
                        @if (widget.NewLine)
                        {
                            <div style="width:100%; height:0; flex-basis:100%"></div>
                        }

                        <div class="layout-widget @(selectedWidget == widget ? "selected" : "")"
                             draggable="@(resizingIds.Contains(widget.Id) ? "false" : "true")"
                             data-drag-type="widget"
                             data-drag-data="@widget.Id"
                             data-widget-id="@widget.Id"
                             @ondragstart="@((e) => OnWidgetDragStart(e, widget))"
                             @ondragstart:preventDefault="@(resizingIds.Contains(widget.Id))"
                             @ondragstart:stopPropagation
                             @ondragend="OnDragEnd"
                             @onclick="@(() => SelectWidget(widget))"
                             style="@(WidgetStyleHelper.GetFlowWidgetStyle(widget, selectedWidget == widget))">

                            @if (selectedWidget == widget)
                            {
                                <div class="resize-handle"
                                     draggable="false"
                                     @onmousedown="@((e) => OnResizeStart(e, widget))"
                                     @onmousedown:stopPropagation
                                     @onmousedown:preventDefault
                                     @ondragstart:preventDefault="true">
                                </div>
                            }

                            <div class="widget-content" style="width:100%; pointer-events:none">
                                @RenderWidgetVisual(widget)
                            </div>
                        </div>
                    }
                    @if (!layoutWidgets.Any())
                    {
                        <div class="designer-empty-state">
                            <Icon Type="@IconType.Outline.Inbox" Style="font-size:48px; margin-bottom:12px" />
                            <div>@I18n.T("LBL_DRAG_COMPONENT_HERE")</div>
                        </div>
                    }
                </div>
            </section>

            <aside class="designer-panel designer-properties"
                 @onclick="OnCanvasBackgroundClick">
                @if (selectedWidget != null)
                {
                    <div class="designer-section" @onclick:stopPropagation>
                        <h3>@I18n.T("LBL_WIDGET_PROPERTIES")</h3>

                        <div class="designer-field">
                            <label>@I18n.T("LBL_COMPONENT_TYPE")</label>
                            <Input Value="@selectedWidget.Type" Disabled Class="field-control" />
                        </div>

                        <div class="designer-field">
                            <label>@I18n.T("LBL_LABEL")</label>
                            <Input @bind-Value="selectedWidget.Label" OnChange="@((string value) => UpdateWidget())" Class="field-control" />
                        </div>

                        <div class="designer-field designer-field-inline">
                            <div class="designer-field">
                                <label>@I18n.T("LBL_WIDTH")</label>
                                @{
                                    var widthMax = selectedWidget.GetMaxWidth();
                                }
                                @if (widthMax.HasValue)
                                {
                                    <AntDesign.InputNumber TValue="int" @bind-Value="selectedWidget.Width" Min="1" Max="@widthMax.Value" OnChange="@(value => UpdateWidget())" />
                                }
                                else
                                {
                                    <AntDesign.InputNumber TValue="int" @bind-Value="selectedWidget.Width" Min="1" OnChange="@(value => UpdateWidget())" />
                                }
                            </div>
                            <div class="designer-field">
                                <label>@I18n.T("LBL_WIDTH_UNIT")</label>
                                <Select TItemValue="string" TItem="string"
                                        Value="@selectedWidget.WidthUnit"
                                        OnSelectedItemChanged="@(value => { selectedWidget.WidthUnit = value; UpdateWidget(); })">
                                    <SelectOptions>
                                        <SelectOption TItemValue="string" TItem="string" Value="@("%")" Label="%"/>
                                        <SelectOption TItemValue="string" TItem="string" Value="@("px")" Label="px"/>
                                    </SelectOptions>
                                </Select>
                            </div>
                        </div>

                        <div class="designer-field">
                            <label>@I18n.T("LBL_DATA_SOURCE")</label>
                            <Select TItemValue="string" TItem="string" @bind-Value="selectedWidget.DataField" AllowClear OnSelectedItemChanged="@(item => UpdateWidget())">
                                @foreach (var field in availableFields)
                                {
                                    <SelectOption Value="@field.Key" Label="@field.DisplayName" />
                                }
                            </Select>
                        </div>

                        <div class="designer-switch-row">
                            <label>@I18n.T("LBL_VISIBLE")</label>
                            <Switch @bind-Value="selectedWidget.Visible" OnChange="@(value => UpdateWidget())" />
                        </div>

                        <div class="designer-switch-row">
                            <label>@I18n.T("LBL_NEW_LINE")</label>
                            <Switch @bind-Value="selectedWidget.NewLine" OnChange="@(value => UpdateWidget())" />
                        </div>

                        @RenderTypeSpecificPropertyPanel(selectedWidget)

                        <hr class="designer-divider" />

                        <Button Danger OnClick="DeleteSelectedWidget" Icon="@IconType.Outline.Delete">@I18n.T("BTN_DELETE")</Button>
                    </div>
                }
                else
                {
                    <div class="designer-section" @onclick:stopPropagation>
                        <h3>@I18n.T("LBL_TEMPLATE_PROPERTIES")</h3>

                        <div class="designer-field">
                            <label>@I18n.T("LBL_TEMPLATE_NAME")</label>
                            <Input @bind-Value="templateName" Placeholder="@I18n.T("LBL_ENTER_TEMPLATE_NAME")" Class="field-control" />
                        </div>

                        <div class="designer-field">
                            <label>@I18n.T("LBL_DESCRIPTION")</label>
                            <TextArea @bind-Value="description" Placeholder="@I18n.T("LBL_ENTER_TEMPLATE_DESCRIPTION")" Rows="3" />
                        </div>

                        <div class="designer-field">
                            <label>@I18n.T("LBL_ENTITY_TYPE")</label>

                            @if (isEntityTypeLocked)
                            {
                                <Input Value="@GetEntityDisplayName()" Disabled Class="field-control" />
                                <div class="designer-badge">
                                    ğŸ”’ @I18n.T("LBL_ENTITY_TYPE_LOCKED")
                                </div>
                            }
                            else
                            {
                                <EntitySelector TEntity="EntityTypeItem"
                                                @bind-Value="entityType"
                                                Title="@I18n.T("LBL_SELECT_ENTITY_TYPE")"
                                                Placeholder="@I18n.T("LBL_CLICK_TO_SELECT_ENTITY")"
                                                EmptyText="@I18n.T("LBL_NO_AVAILABLE_ENTITIES")"
                                                DataLoader="LoadAvailableEntitiesForSelector"
                                                ValueGetter="@(e => e.EntityType)"
                                                DisplayTextGetter="@(e => e.DisplayName)"
                                                EnableSearch="true">
                                    <TitleRenderer>
                                        @context.DisplayName
                                    </TitleRenderer>
                                    <DescriptionRenderer>
                                        @if (!string.IsNullOrWhiteSpace(context.Description))
                                        {
                                            @context.Description
                                        }
                                    </DescriptionRenderer>
                                    <IconRenderer>
                                        @if (!string.IsNullOrWhiteSpace(context.Icon))
                                        {
                                            <Icon Type="@context.Icon" Style="font-size:28px; color:var(--primary)" />
                                        }
                                    </IconRenderer>
                                    <MetadataRenderer>
                                        <Tag Color="@TagColor.Blue">@context.EntityName</Tag>
                                        <Tag Color="@TagColor.Default">@context.ApiEndpoint</Tag>
                                    </MetadataRenderer>
                                </EntitySelector>
                                <div class="designer-hint">
                                    @I18n.T("LBL_ENTITY_TYPE_HINT")
                                </div>
                            }
                        </div>

                        <div class="designer-field">
                            <label>@I18n.T("LBL_COMPONENTS")</label>
                            <div class="designer-count">@layoutWidgets.Count</div>
                        </div>

                        <div class="designer-hint">
                            <Icon Type="@IconType.Outline.InfoCircle" /> @I18n.T("LBL_TEMPLATE_INFO_HINT")
                        </div>

                        <hr class="designer-divider" />

                        <Button Type="@ButtonType.Primary" OnClick="SaveLayout" Icon="@IconType.Outline.Save">@I18n.T("BTN_SAVE_LAYOUT")</Button>
                    </div>
                }
            </aside>
        </div>
    </div>
}
</AuthChecker>

@code {
    [Parameter] public string? TemplateId { get; set; }

    private int? templateIdNumeric = null; // æ¨¡æ¿çš„æ•°å­—IDï¼ˆç”¨äºæ›´æ–°å·²æœ‰æ¨¡æ¿ï¼‰
    private string templateName = "";
    private string description = ""; // æ¨¡æ¿æè¿°
    private string entityType = "";
    private string? originalEntityType = null; // æ¨¡æ¿åŸå§‹çš„å®ä½“ç±»å‹ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦é”å®šï¼‰
    private bool isEntityTypeLocked = false; // å®ä½“ç±»å‹æ˜¯å¦å·²é”å®šï¼ˆå·²è®¾ç½®çš„æ¨¡æ¿ä¸å…è®¸ä¿®æ”¹å®ä½“ç±»å‹ï¼‰
    private bool loading = true;
    private string? error;

    private List<DraggableWidget> layoutWidgets = new();
    private DraggableWidget? selectedWidget;
    private HashSet<string> resizingIds = new();
    private ElementReference canvasRef;

    // â­ å¯ç”¨å­—æ®µåˆ—è¡¨ï¼ˆä»FieldDefinitions APIåŠ è½½ï¼Œéå®ä½“ç»‘å®šï¼‰
    private List<FieldDefinitionItem> availableFields = new();

    // â­ å½“å‰å®ä½“å­—æ®µåˆ—è¡¨ï¼ˆæ¥è‡ªå®ä½“å®šä¹‰ï¼‰
    private List<EntityFieldDto> entityFields = new();

    // â­ å¯ç”¨å®ä½“ç±»å‹åˆ—è¡¨ï¼ˆä¾› EntitySelector ä½¿ç”¨ï¼‰
    private List<EntityTypeItem> availableEntityTypes = new();

    // æ‹–æ”¾çŠ¶æ€
    private WidgetRegistry.WidgetDefinition? draggedDefinition;
    private DraggableWidget? draggedWidget;
    private DraggableWidget? draggedParentContainer;
    private EntityFieldNode? draggedEntityField; // æ‹–æ‹½çš„å®ä½“å­—æ®µ
    private bool dropSucceeded = false;
    private bool isProcessingDrop = false; // é˜²æŠ¤æ ‡å¿—ï¼šæ­£åœ¨å¤„ç†dropï¼Œé˜²æ­¢OnDragEndæ¸…ç©ºçŠ¶æ€

    // Tabç®¡ç†
    private readonly TabStateManager tabStateManager = new();

    protected override void OnInitialized()
    {
        templateName = I18n.T("LBL_NEW_TEMPLATE");
        I18n.OnChanged += HandleI18nChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            await JS.InvokeVoidAsync("bobcrm.initDragDrop");
            await InitializeDesignerAsync();
        }
        catch (Exception ex)
        {
            error = ex.Message;
            loading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task InitializeDesignerAsync()
    {
        error = null;
        loading = true;
        await InvokeAsync(StateHasChanged);

        // 1. åŠ è½½å¯ç”¨å®ä½“å’Œå­—æ®µï¼ˆè®¾è®¡å™¨å¿…éœ€ï¼‰
        await LoadAvailableEntities();
        await LoadAvailableFields();

        // 2. åŠ è½½æ¨¡æ¿
        if (string.IsNullOrWhiteSpace(TemplateId))
        {
            InitializeEmptyTemplate();
        }
        else
        {
            await LoadTemplate();
        }

        if (!string.IsNullOrWhiteSpace(entityType))
        {
            await LoadEntityFields(entityType);
        }

        loading = false;
        await InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// EntitySelector çš„æ•°æ®åŠ è½½å™¨
    /// </summary>
    private async Task<List<EntityTypeItem>> LoadAvailableEntitiesForSelector()
    {
        if (availableEntityTypes.Any())
        {
            return availableEntityTypes;
        }

        try
        {
            await LoadAvailableEntities();
            return availableEntityTypes;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[FormDesigner] Failed to load entities: {ex.Message}");
            return new List<EntityTypeItem>();
        }
    }

    private async Task LoadAvailableEntities()
    {
        await JS.InvokeVoidAsync("console.log", "[FormDesigner] Loading entities for selector...");

        var resp = await Auth.GetWithRefreshAsync("/api/entities");

        if (!resp.IsSuccessStatusCode)
        {
            throw new InvalidOperationException($"{I18n.T("MSG_LOAD_FAILED")}: {resp.StatusCode}");
        }

        var content = await resp.Content.ReadAsStringAsync();
        var jsonOptions = new System.Text.Json.JsonSerializerOptions
        {
            PropertyNameCaseInsensitive = true
        };

        var entities = System.Text.Json.JsonSerializer.Deserialize<List<EntityApiItem>>(content, jsonOptions) ?? new();

        availableEntityTypes = entities.Select(e => new EntityTypeItem
        {
            EntityType = e.EntityType ?? string.Empty,
            EntityName = e.EntityName ?? string.Empty,
            ApiEndpoint = e.ApiEndpoint,
            Icon = e.Icon,
            Category = e.Category,
            DisplayName = ResolveMultilingual(e.DisplayName, e.EntityName ?? e.EntityType ?? string.Empty),
            Description = ResolveMultilingual(e.Description, string.Empty)
        }).ToList();

        await JS.InvokeVoidAsync("console.log", $"[FormDesigner] Loaded {availableEntityTypes.Count} entity types for selector (with translations)");
    }

    private async Task LoadAvailableFields()
    {
        try
        {
            var resp = await Auth.GetWithRefreshAsync("/api/fields");
            if (!resp.IsSuccessStatusCode)
            {
                throw new InvalidOperationException($"{I18n.T("MSG_LOAD_FAILED")}: {resp.StatusCode}");
            }

            var fields = await resp.Content.ReadFromJsonAsync<List<FieldDefinitionItem>>();
            availableFields = fields ?? new();
        }
        catch (Exception ex)
        {
            error = $"{I18n.T("MSG_LOAD_FAILED")}: {ex.Message}";
            await JS.InvokeVoidAsync("console.error", $"[FormDesigner] Failed to load fields: {ex.Message}");
            throw;
        }
    }

    private async Task LoadEntityFields(string entity)
    {
        try
        {
            entityFields = new();

            foreach (var candidate in BuildEntityTypeCandidates(entity))
            {
                var definition = await TryLoadDefinition(candidate);
                if (definition == null) continue;

            entityFields = definition.Fields?.Select(f => new EntityFieldDto
            {
                PropertyName = f.PropertyName ?? string.Empty,
                DisplayName = f.DisplayName,
                DataType = f.DataType ?? string.Empty,
                    SortOrder = f.SortOrder,
                    IsRequired = f.IsRequired,
                    Length = f.Length,
                    EnumDefinitionId = f.EnumDefinitionId,
                    IsMultiSelect = f.IsMultiSelect
            }).ToList() ?? new();

            if (entityFields.Any())
            {
                await JS.InvokeVoidAsync("console.log", $"[FormDesigner] Loaded {entityFields.Count} entity fields for {candidate}");
                return;
            }
        }

            await JS.InvokeVoidAsync("console.warn", $"[FormDesigner] No entity fields found for {entity}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[FormDesigner] Failed to load entity fields: {ex.Message}");
            entityFields = new();
        }
    }

    private void InitializeEmptyTemplate()
    {
        templateIdNumeric = null;
        templateName = I18n.T("LBL_NEW_TEMPLATE");
        description = "";
        entityType = ""; // æ–°å»ºæ¨¡æ¿ï¼Œä¸è®¾ç½®é»˜è®¤å®ä½“ç±»å‹
        originalEntityType = null;
        isEntityTypeLocked = false; // æ–°å»ºæ¨¡æ¿ï¼Œå…è®¸é€‰æ‹©å®ä½“ç±»å‹
        layoutWidgets = new();
    }
    
    /// <summary>
    /// è·å–å½“å‰å®ä½“ç±»å‹çš„æ˜¾ç¤ºåç§°ï¼ˆç”¨äºå·²é”å®šçš„å®ä½“ç±»å‹æ˜¾ç¤ºï¼‰
    /// </summary>
    private string GetEntityDisplayName()
    {
        if (string.IsNullOrWhiteSpace(entityType))
        {
            return I18n.T("LBL_ENTITY_TYPE_NOT_SET");
        }
        
        // å¦‚æœå·²ç»åŠ è½½äº†å®ä½“åˆ—è¡¨ï¼Œä»åˆ—è¡¨ä¸­æŸ¥æ‰¾
        var entity = availableEntityTypes.FirstOrDefault(e => e.EntityType == entityType);
        if (entity != null)
        {
            return string.IsNullOrWhiteSpace(entity.DisplayName)
                ? entity.EntityName
                : entity.DisplayName;
        }

        // å¦‚æœæ²¡æœ‰åŠ è½½åˆ—è¡¨ï¼Œæ ¹æ®å®ä½“ç±»å‹æ¨æ–­æ˜¾ç¤ºåç§°
        // ä¾‹å¦‚ï¼šcustomer -> ENTITY_CUSTOMER
        var displayKey = $"ENTITY_{entityType.ToUpper()}";
        return I18n.T(displayKey);
    }

    private void OnCanvasBackgroundClick()
    {
        // ç‚¹å‡»ç”»å¸ƒèƒŒæ™¯æ—¶ï¼Œå–æ¶ˆé€‰ä¸­Widgetï¼Œæ˜¾ç¤ºæ¨¡æ¿å±æ€§
        selectedWidget = null;
        StateHasChanged();
    }

    private async Task RetryLoad()
    {
        await InitializeDesignerAsync();
    }

    private void CancelAndReturn()
    {
        Nav.NavigateTo("/templates");
    }

    private async Task LoadTemplate()
    {
        try
        {
            // â­ æ–°é€»è¾‘ï¼šä½¿ç”¨ FormTemplate API
            // è·¯ç”±ï¼š/designer/newï¼ˆæ–°å»ºï¼‰æˆ– /designer/{id}ï¼ˆç¼–è¾‘ï¼‰

            if (TemplateId == "new" || string.IsNullOrWhiteSpace(TemplateId))
            {
                // æ–°å»ºæ¨¡æ¿
                InitializeEmptyTemplate();
                await JS.InvokeVoidAsync("console.log", "[FormDesigner] Creating new template");
                return;
            }

            // å°è¯•è§£æä¸ºæ•°å­—ID
            if (int.TryParse(TemplateId, out var id))
            {
                templateIdNumeric = id;

                // ä» FormTemplate API åŠ è½½
                var resp = await Auth.GetWithRefreshAsync($"/api/templates/{id}");

                if (!resp.IsSuccessStatusCode)
                {
                    error = $"{I18n.T("MSG_TEMPLATE_LOAD_FAILED")}: {resp.StatusCode}";
                    await JS.InvokeVoidAsync("console.error", $"[FormDesigner] Failed to load template {id}: {resp.StatusCode}");
                    return;
                }

                var content = await resp.Content.ReadAsStringAsync();
                var template = System.Text.Json.JsonSerializer.Deserialize<FormTemplateDto>(
                    content,
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                if (template == null)
                {
                    error = I18n.T("MSG_TEMPLATE_PARSE_FAILED");
                    return;
                }

                // å¡«å……æ¨¡æ¿ä¿¡æ¯
                templateName = ResolveTemplateName(template.Name);
                description = template.Description ?? "";
                entityType = NormalizeEntityType(template.EntityType);
                originalEntityType = template.EntityType;

                // ä»æ¨¡æ¿åæå–å®ä½“ï¼ˆé˜²æ­¢ç³»ç»Ÿæ¨¡æ¿ EntityType ä¸ºç©ºå¯¼è‡´ç»“æ„æ ‘ç¼ºå¤±ï¼‰
                if (string.IsNullOrWhiteSpace(entityType) && TryParseEntityFromTemplateKey(template.Name, out var parsedEntity))
                {
                    entityType = parsedEntity;
                }

                // å¦‚æœæ¨¡æ¿æœ‰å®ä½“ç±»å‹ï¼Œé”å®šå®ƒï¼ˆä¸å…è®¸ä¿®æ”¹ï¼‰
                isEntityTypeLocked = !string.IsNullOrWhiteSpace(template.EntityType);
                if (!string.IsNullOrWhiteSpace(entityType))
                {
                    await LoadEntityFields(entityType);
                }

                // è§£æå¸ƒå±€JSONï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
                layoutWidgets = new List<DraggableWidget>();
                if (!string.IsNullOrWhiteSpace(template.LayoutJson))
                {
                    var doc = System.Text.Json.JsonDocument.Parse(template.LayoutJson);
                    var root = doc.RootElement;

                    if (root.ValueKind == System.Text.Json.JsonValueKind.Object &&
                        root.TryGetProperty("items", out var itemsEl))
                    {
                        foreach (var item in itemsEl.EnumerateObject())
                        {
                            TryAddWidget(item.Value);
                        }
                    }
                    else if (root.ValueKind == System.Text.Json.JsonValueKind.Array)
                    {
                        foreach (var el in root.EnumerateArray())
                        {
                            TryAddWidget(el);
                        }
                    }
                }

                if (!layoutWidgets.Any() && IsLikelyListTemplate(template))
                {
                    ApplyDefaultListLayout(template.EntityType);
                    Message.Info("Default list layout applied. Undo?");
                }

                await JS.InvokeVoidAsync("console.log", $"[FormDesigner] Loaded template {id}: {layoutWidgets.Count} widgets, entityType={entityType}, locked={isEntityTypeLocked}");
            }
            else
            {
                // ä¸æ˜¯æ•°å­—IDï¼Œå¯èƒ½æ˜¯æ—§æ ¼å¼ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
                await JS.InvokeVoidAsync("console.warn", $"[FormDesigner] Unknown TemplateId format: {TemplateId}, initializing empty template");
                InitializeEmptyTemplate();
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[FormDesigner] LoadTemplate failed: {ex.Message}");
            error = $"{I18n.T("MSG_LOAD_FAILED")}: {ex.Message}";
        }
    }

    private bool IsLikelyListTemplate(FormTemplateDto template)
    {
        if (template.UsageType == TemplateUsageType.List) return true;
        if (template.Name?.Contains("list", StringComparison.OrdinalIgnoreCase) == true) return true;
        return template.Name?.StartsWith("TEMPLATE_NAME_LIST", StringComparison.OrdinalIgnoreCase) == true;
    }

    private string ResolveTemplateName(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return I18n.T("LBL_TEMPLATE_NAME");

        var translated = I18n.T(name);
        if (!string.Equals(translated, name, StringComparison.Ordinal))
        {
            return translated;
        }

        if (TryRenderTemplateNameFromKey(name, out var rendered))
        {
            return rendered;
        }

        return name;
    }

    private bool TryParseEntityFromTemplateKey(string name, out string entity)
    {
        entity = string.Empty;
        const string prefix = "TEMPLATE_NAME_";
        if (!name.StartsWith(prefix, StringComparison.OrdinalIgnoreCase)) return false;

        var parts = name[prefix.Length..].Split('_', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length < 2) return false;

        entity = string.Join('_', parts.Skip(1)).ToLowerInvariant();
        return true;
    }

    private bool TryRenderTemplateNameFromKey(string name, out string rendered)
    {
        rendered = name;
        const string prefix = "TEMPLATE_NAME_";
        if (!name.StartsWith(prefix, StringComparison.OrdinalIgnoreCase)) return false;

        var parts = name[prefix.Length..].Split('_', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length < 2) return false;

        var usage = parts[0];
        var entity = string.Join('_', parts.Skip(1));

        var usageLabel = usage.ToLowerInvariant() switch
        {
            "list" => I18n.T("TPL_USAGE_LIST"),
            "edit" => I18n.T("TPL_USAGE_EDIT"),
            "detail" => I18n.T("TPL_USAGE_DETAIL"),
            _ => usage
        };

        var entityKey = $"ENTITY_{entity.ToUpperInvariant()}";
        var entityLabel = I18n.T(entityKey);
        if (string.Equals(entityLabel, entityKey, StringComparison.OrdinalIgnoreCase))
        {
            entityLabel = entity.ToLowerInvariant();
        }

        rendered = $"{usageLabel} - {entityLabel}";
        return true;
    }

    private string NormalizeEntityType(string? entity)
    {
        if (string.IsNullOrWhiteSpace(entity)) return string.Empty;

        if (entity.StartsWith("ENTITY_", StringComparison.OrdinalIgnoreCase))
        {
            return entity["ENTITY_".Length..].ToLowerInvariant();
        }

        return entity;
    }

    private void ApplyDefaultListLayout(string? templateEntityType)
    {
        var targetEntity = !string.IsNullOrWhiteSpace(entityType)
            ? entityType
            : (templateEntityType ?? string.Empty);

        var sourceFields = entityFields.Any()
            ? entityFields.OrderBy(f => f.SortOrder).ThenBy(f => f.PropertyName).ToList()
            : availableFields.Select((f, idx) => new EntityFieldDto
            {
                PropertyName = f.Key,
                DisplayName = new Dictionary<string, string?> { ["en"] = f.DisplayName },
                SortOrder = idx + 1,
                DataType = "String",
                IsRequired = false
            }).ToList();

        var columns = sourceFields.Take(6).Select((f, index) => new
        {
            field = f.PropertyName.ToLowerInvariant(),
            label = ResolveMultilingual(f.DisplayName, f.PropertyName),
            width = 140 + (index % 2) * 20,
            sortable = true,
            enumDefinitionId = f.EnumDefinitionId,
            isMultiSelect = f.IsMultiSelect
        }).ToList();

        if (!columns.Any())
        {
            columns.Add(new { field = "name", label = I18n.T("LBL_NAME"), width = 160, sortable = true, enumDefinitionId = (Guid?)null, isMultiSelect = false });
        }

        var rowActions = new[]
        {
            new { action = "view", label = "BTN_VIEW", icon = "eye" },
            new { action = "edit", label = "BTN_EDIT", icon = "edit" }
        };

        var datagrid = new DataGridWidget
        {
            Id = Guid.NewGuid().ToString(),
            Type = "datagrid",
            Code = "datagrid1",
            Label = I18n.T("TPL_USAGE_LIST"),
            EntityType = targetEntity,
            ApiEndpoint = string.IsNullOrWhiteSpace(targetEntity) ? null : $"/api/{targetEntity}s",
            ColumnsJson = System.Text.Json.JsonSerializer.Serialize(columns),
            RowActionsJson = System.Text.Json.JsonSerializer.Serialize(rowActions),
            ShowPagination = true,
            PageSize = 20,
            AllowMultiSelect = true,
            ShowSearch = true,
            SearchPlaceholderKey = "LBL_SEARCH",
            ShowRefreshButton = true,
            ShowBordered = true,
            Size = "middle",
            EmptyTextKey = "MSG_NO_DATA",
            Width = 100,
            WidthUnit = "%"
        };

        layoutWidgets.Add(datagrid);
    }

    /// <summary>
    /// FormTemplate DTOï¼ˆä¸åç«¯ FormTemplate å¯¹åº”ï¼‰
    /// </summary>
    private class FormTemplateDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? EntityType { get; set; }
        public string? LayoutJson { get; set; }
        public string? Description { get; set; }
        public bool IsUserDefault { get; set; }
        public bool IsSystemDefault { get; set; }
        public TemplateUsageType UsageType { get; set; } = TemplateUsageType.Detail;
    }

    private class EntityDefinitionDto
    {
        public List<EntityFieldDto>? Fields { get; set; }
    }

    private async Task<EntityDefinitionDto?> TryLoadDefinition(string candidate)
    {
        var options = new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true };

        // First try new endpoint
        var resp = await Auth.GetWithRefreshAsync($"/api/entities/{Uri.EscapeDataString(candidate)}/definition");
        if (resp.IsSuccessStatusCode)
        {
            var content = await resp.Content.ReadAsStringAsync();
            return System.Text.Json.JsonSerializer.Deserialize<EntityDefinitionDto>(content, options);
        }

        // Fallback to old endpoint
        resp = await Auth.GetWithRefreshAsync($"/api/entity-definitions/by-type/{Uri.EscapeDataString(candidate)}");
        if (resp.IsSuccessStatusCode)
        {
            var content = await resp.Content.ReadAsStringAsync();
            return System.Text.Json.JsonSerializer.Deserialize<EntityDefinitionDto>(content, options);
        }

        await JS.InvokeVoidAsync("console.warn", $"[FormDesigner] Entity fields load failed for {candidate}: {resp.StatusCode}");
        return null;
    }

    private IEnumerable<string> BuildEntityTypeCandidates(string entity)
    {
        var cleaned = entity?.Trim().Trim('/').ToLowerInvariant() ?? string.Empty;
        if (string.IsNullOrWhiteSpace(cleaned)) yield break;

        if (cleaned.StartsWith("entity_"))
        {
            cleaned = cleaned["entity_".Length..];
        }

        yield return cleaned;

        if (cleaned.EndsWith("s"))
        {
            yield return cleaned.TrimEnd('s');
        }
        else
        {
            yield return $"{cleaned}s";
        }
    }

    private class FieldDefinitionItem
    {
        public string Key { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
    }

    private class EntityFieldDto
    {
        public string PropertyName { get; set; } = string.Empty;
        public Dictionary<string, string?>? DisplayName { get; set; }
        public string DataType { get; set; } = string.Empty;
        public int SortOrder { get; set; }
        public bool IsRequired { get; set; }
        public int? Length { get; set; }
        public Guid? EnumDefinitionId { get; set; }
        public bool IsMultiSelect { get; set; }
    }

    /// <summary>
    /// å®ä½“ç±»å‹é¡¹ - å®ç° ISelectableEntity æ¥å£ï¼Œç¡®ä¿å¯ç”¨äº EntitySelector
    /// </summary>
    private class EntityApiItem
    {
        public string? EntityType { get; set; }
        public string? EntityName { get; set; }
        public Dictionary<string, string?>? DisplayName { get; set; }
        public Dictionary<string, string?>? Description { get; set; }
        public string? ApiEndpoint { get; set; }
        public string? Icon { get; set; }
        public string? Category { get; set; }
    }

    private class EntityTypeItem : BobCrm.App.Abstractions.ISelectableEntity
    {
        public string EntityType { get; set; } = string.Empty;  // è·¯ç”±åï¼ˆcustomerï¼‰
        public string EntityName { get; set; } = string.Empty;  // ç±»åï¼ˆCustomerï¼‰
        public string DisplayName { get; set; } = string.Empty;  // ç¿»è¯‘åçš„æ˜¾ç¤ºåç§°ï¼ˆç”±å‰ç«¯å¡«å……ï¼‰
        public string? Description { get; set; }  // ç¿»è¯‘åçš„æè¿°ï¼ˆç”±å‰ç«¯å¡«å……ï¼‰
        public string? ApiEndpoint { get; set; }
        public string? Icon { get; set; }
        public string? Category { get; set; }
        
        // ISelectableEntity æ¥å£å®ç°
        string BobCrm.App.Abstractions.ISelectableEntity.Value => EntityType;
        string BobCrm.App.Abstractions.ISelectableEntity.DisplayName => DisplayName;
        string? BobCrm.App.Abstractions.ISelectableEntity.Description => Description;
        string? BobCrm.App.Abstractions.ISelectableEntity.Icon => Icon;
    }

    private string ResolveMultilingual(Dictionary<string, string?>? source, string fallback)
    {
        if (source == null || source.Count == 0)
        {
            return I18n.T(fallback);
        }

        var lang = I18n.CurrentLang;
        if (source.TryGetValue(lang, out var val) && !string.IsNullOrWhiteSpace(val))
        {
            return val!;
        }

        var first = source.Values.FirstOrDefault(v => !string.IsNullOrWhiteSpace(v));
        return first ?? fallback;
    }

    private async Task SaveLayout()
    {
        try
        {
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (string.IsNullOrWhiteSpace(templateName))
            {
                Message.Error(I18n.T("MSG_TEMPLATE_NAME_REQUIRED"));
                return;
            }

            if (string.IsNullOrWhiteSpace(entityType))
            {
                Message.Error(I18n.T("MSG_ENTITY_TYPE_REQUIRED"));
                return;
            }

            // åºåˆ—åŒ–å¸ƒå±€ä¸ºJSON
            var items = new Dictionary<string, object>();
            for (int i = 0; i < layoutWidgets.Count; i++)
            {
                var key = $"item_{i}";
                var itemData = WidgetSerializationHelper.SerializeWidget(layoutWidgets[i], i);
                items[key] = itemData;
            }

            // æ„å»ºå®Œæ•´çš„å¸ƒå±€æ•°æ®
            var layoutData = new Dictionary<string, object>
            {
                ["items"] = items
            };

            // åºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²
            var layoutJson = System.Text.Json.JsonSerializer.Serialize(layoutData);

            var client = await Auth.CreateClientWithAuthAsync();
            System.Net.Http.HttpResponseMessage resp;

            if (templateIdNumeric.HasValue)
            {
                // æ›´æ–°ç°æœ‰æ¨¡æ¿
                var updatePayload = new
                {
                    name = templateName,
                    description = description,
                    layoutJson = layoutJson,
                    entityType = entityType
                };

                resp = await client.PutAsJsonAsync($"/api/templates/{templateIdNumeric.Value}", updatePayload);

                if (resp.IsSuccessStatusCode)
                {
                    Message.Success(I18n.T("MSG_TEMPLATE_UPDATE_SUCCESS"));
                }
                else
                {
                    var errorContent = await resp.Content.ReadAsStringAsync();
                    error = $"{I18n.T("MSG_UPDATE_FAILED")}: {resp.StatusCode} - {errorContent}";
                    Message.Error(error);
                }
            }
            else
            {
                // åˆ›å»ºæ–°æ¨¡æ¿
                var createPayload = new
                {
                    name = templateName,
                    description = description,
                    entityType = entityType,
                    layoutJson = layoutJson,
                    isUserDefault = false // æ–°å»ºæ¨¡æ¿é»˜è®¤ä¸æ˜¯ç”¨æˆ·é»˜è®¤
                };

                resp = await client.PostAsJsonAsync("/api/templates", createPayload);

                if (resp.IsSuccessStatusCode)
                {
                    // è·å–æ–°åˆ›å»ºçš„æ¨¡æ¿ID
                    var content = await resp.Content.ReadAsStringAsync();
                    var newTemplate = System.Text.Json.JsonSerializer.Deserialize<FormTemplateDto>(
                        content,
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                    if (newTemplate != null)
                    {
                        templateIdNumeric = newTemplate.Id;
                        isEntityTypeLocked = true; // ä¿å­˜åé”å®šå®ä½“ç±»å‹
                        originalEntityType = entityType;
                        Message.Success(I18n.T("MSG_TEMPLATE_CREATE_SUCCESS"));

                        // æ›´æ–°URLä»¥åæ˜ æ–°çš„æ¨¡æ¿IDï¼ˆé¿å…é‡å¤åˆ›å»ºï¼‰
                        Nav.NavigateTo($"/designer/{newTemplate.Id}", forceLoad: false);
                    }
                }
                else
                {
                    var errorContent = await resp.Content.ReadAsStringAsync();
                    error = $"{I18n.T("MSG_CREATE_FAILED")}: {resp.StatusCode} - {errorContent}";
                    Message.Error(error);
                }
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
            await JS.InvokeVoidAsync("console.error", $"[FormDesigner] Save failed: {ex.Message}");
        }
    }

    /// <summary>
    /// æ¸²æŸ“æ§ä»¶ç‰¹å®šçš„å±æ€§é¢æ¿
    /// ä½¿ç”¨å…ƒæ•°æ®é©±åŠ¨çš„é€šç”¨å±æ€§ç¼–è¾‘å™¨
    /// </summary>
    private RenderFragment RenderTypeSpecificPropertyPanel(DraggableWidget widget) => __builder =>
    {
        var properties = PropertyProvider.GetProperties(widget);
        <PropertyEditor Properties="@properties" Widget="@widget" AllWidgets="@GetAllWidgets()" OnPropertyChanged="UpdateWidget" />
    };

    /// <summary>
    /// æ¸²æŸ“ç»„ä»¶çš„çº¯è§†è§‰å¤–è§‚ï¼ˆä»…ç”¨äºé¡¶å±‚åŒ…è£¹å±‚å†…éƒ¨ï¼Œä¸åŒ…å«äº¤äº’åŠŸèƒ½ï¼‰
    /// ä½¿ç”¨åŠ¨æ€ç»„ä»¶æ¸²æŸ“ï¼Œå®Œå…¨è§£è€¦ï¼Œç¬¦åˆ OOP åŸåˆ™
    /// æ— éœ€ switchï¼šæ¯ä¸ª Widget ç±»å£°æ˜è‡ªå·±çš„é¢„è§ˆç»„ä»¶ç±»å‹
    /// </summary>
    private RenderFragment RenderWidgetVisual(DraggableWidget widget) => __builder =>
    {
        if (widget is ContainerWidget container)
        {
            // å®¹å™¨ï¼šç›´æ¥æ¸²æŸ“å®¹å™¨è®¾è®¡å¤–è§‚
            @RenderContainerDesign(container)
        }
        else
        {
            // æ™®é€šç»„ä»¶ï¼šæ˜¾ç¤ºæ ‡ç­¾ + ä½¿ç”¨åŠ¨æ€ç»„ä»¶æ¸²æŸ“
            <div style="font-size:12px; color:#666; margin-bottom:4px">@widget.Label</div>
            
            @if (widget.PreviewComponentType != null)
            {
                // åŠ¨æ€æ¸²æŸ“ Widget å£°æ˜çš„é¢„è§ˆç»„ä»¶
                <DynamicComponent Type="@widget.PreviewComponentType"
                                 Parameters="@(new Dictionary<string, object> { ["Widget"] = widget })" />
            }
            else
            {
                // é™çº§å¤„ç†ï¼šæ— é¢„è§ˆç»„ä»¶æ—¶æ˜¾ç¤ºé»˜è®¤è¾“å…¥æ¡†
                <div style="height:32px; background:#fff; border:1px solid #e0e0e0; border-radius:2px"></div>
            }
        }
    };

    /// <summary>
    /// æ¸²æŸ“ç»„ä»¶çš„å®Œæ•´è®¾è®¡æ€ï¼ˆåŒ…å«äº¤äº’å±‚ï¼Œç”¨äºå®¹å™¨å†…å­ç»„ä»¶çš„é€’å½’æ¸²æŸ“ï¼‰
    /// </summary>
    private RenderFragment RenderDesignWidget(DraggableWidget widget) => __builder =>
    {
        var isSelected = selectedWidget == widget;
        var borderColor = isSelected ? "#1890ff" : "#d9d9d9";
        var backgroundColor = isSelected ? "#e6f7ff" : "#fff";
        
        // è®¡ç®—å®½åº¦æ ·å¼
        var widthStyle = "";
        var displayStyle = "display:block;"; // é»˜è®¤å—çº§å…ƒç´ ï¼Œå æ»¡çˆ¶å®¹å™¨
        
        if (widget is IFlowSized flowWidget && flowWidget.Width > 0)
        {
            widthStyle = $"width:{flowWidget.Width}{flowWidget.WidthUnit};";
            displayStyle = "display:block;"; // æœ‰æ˜ç¡®å®½åº¦æ—¶ä¹Ÿä¿æŒå—çº§
        }
        
        // æ ¹æ®ç»„ä»¶ç±»å‹æ¸²æŸ“ä¸åŒçš„å¤–è§‚
        if (widget is ContainerWidget container)
        {
            // æ¸²æŸ“å®¹å™¨ç»„ä»¶ï¼ˆå¸¦æ‹–æ‹½ã€é€‰ä¸­å’ŒresizeåŠŸèƒ½ï¼‰
            // ç­–ç•¥ï¼š
            // - wrapperå¿…é¡»æœ‰@ondragover/@ondropå¤„ç†å™¨ï¼Œå¦åˆ™æµè§ˆå™¨ä¸å…è®¸drop
            // - å½“æ‹–åŠ¨åˆ°å·²æœ‰å­æ§ä»¶ä¸Šæ—¶ï¼Œpointeråœ¨wrapperä¸Šï¼Œäº‹ä»¶å¿…é¡»ä»wrapperå¼€å§‹å¤„ç†
            // - wrapperå¤„ç†å®ŒåstopPropagationï¼Œé¿å…äº‹ä»¶ç»§ç»­å†’æ³¡åˆ°frame-drop-zoneé‡å¤å¤„ç†
            <div class="container-child-wrapper @(isSelected ? "selected" : "")"
                 data-widget-id="@container.Id"
                 @onclick="@(() => SelectWidget(container))" @onclick:stopPropagation
                 @ondragover="OnDragOver" @ondragover:preventDefault
                 @ondrop="@(e => OnContainerDrop(e, container))" @ondrop:preventDefault @ondrop:stopPropagation
                 style="@widthStyle @displayStyle position:relative; margin:4px; outline:@(isSelected ? "2px solid #1890ff" : "none"); outline-offset:2px;">
                @if (isSelected)
                {
                    @* æ ‡ç­¾æ ï¼šåŒ…å«å®¹å™¨åç§°ã€æ‹–æ‹½æ‰‹æŸ„å’Œåˆ é™¤æŒ‰é’® *@
                    <div style="position:absolute; top:-28px; left:0; right:0; display:flex; justify-content:space-between; align-items:center; z-index:10;">
                        @* æ‹–æ‹½æ‰‹æŸ„ï¼ˆå·¦ä¾§ï¼‰*@
                        <div draggable="true"
                             @ondragstart="@((e) => OnWidgetDragStart(e, container))" @ondragstart:preventDefault="false" @ondragstart:stopPropagation
                             @ondragend="OnDragEnd"
                             style="background:#1890ff; color:#fff; padding:2px 8px; border-radius:4px 4px 0 0; font-size:11px; cursor:move; pointer-events:auto; display:flex; align-items:center; gap:4px;">
                            <span style="font-size:10px;">â‹®â‹®</span>
                            @container.Label
                        </div>
                        @* åˆ é™¤æŒ‰é’®ï¼ˆå³ä¾§ï¼‰*@
                        <div @onclick="@(() => DeleteWidget(container))" @onclick:stopPropagation
                             style="background:#ff4d4f; color:#fff; padding:2px 8px; border-radius:4px 4px 0 0; font-size:11px; cursor:pointer; pointer-events:auto; font-weight:bold;">
                            Ã—
                        </div>
                    </div>
                    @* Resize handle *@
                    <div draggable="false"
                         @onmousedown="@((e) => OnResizeStart(e, container))" @onmousedown:stopPropagation @onmousedown:preventDefault
                         @ondragstart:preventDefault="true"
                         style="position:absolute; right:-6px; top:50%; transform:translateY(-50%); width:8px; height:48px; cursor:ew-resize; background:#1890ff; border-radius:2px; z-index:10; box-shadow:0 2px 8px rgba(24,144,255,0.6); pointer-events:auto;">
                    </div>
                }
                @RenderContainerDesign(container)
            </div>
        }
        else
        {
            // æ¸²æŸ“æ™®é€šç»„ä»¶ï¼ˆå¸¦æ‹–æ‹½ã€é€‰ä¸­å’ŒresizeåŠŸèƒ½ï¼‰
            // å¤–å±‚ div åªè´Ÿè´£äº¤äº’ï¼Œä½¿ç”¨ outline è€Œé borderï¼Œé¿å…åŒå±‚è¾¹æ¡†
            <div class="container-child-widget @(isSelected ? "selected" : "")"
                 draggable="true"
                 data-widget-id="@widget.Id"
                 @ondragstart="@((e) => OnWidgetDragStart(e, widget))" @ondragstart:preventDefault="false" @ondragstart:stopPropagation @ondragend="OnDragEnd"
                 @onclick="@(() => SelectWidget(widget))" @onclick:stopPropagation
                 style="@widthStyle @displayStyle position:relative; cursor:move; margin:4px; outline:@(isSelected ? "2px solid #1890ff" : "1px dashed #d9d9d9"); outline-offset:0px; padding:8px; background:@backgroundColor; border-radius:4px;">
                @if (isSelected)
                {
                    <div style="position:absolute; top:-28px; right:0; background:#1890ff; color:#fff; padding:2px 8px; border-radius:4px 4px 0 0; font-size:11px; z-index:10">
                        @widget.Label
                        <span @onclick="@(() => DeleteWidget(widget))" @onclick:stopPropagation style="margin-left:8px; cursor:pointer; font-weight:bold">Ã—</span>
                    </div>
                    @* Resize handle *@
                    <div draggable="false"
                         @onmousedown="@((e) => OnResizeStart(e, widget))" @onmousedown:stopPropagation @onmousedown:preventDefault
                         @ondragstart:preventDefault="true"
                         style="position:absolute; right:-6px; top:50%; transform:translateY(-50%); width:8px; height:48px; cursor:ew-resize; background:#1890ff; border-radius:2px; z-index:10; box-shadow:0 2px 8px rgba(24,144,255,0.6);">
                    </div>
                }
                <div style="font-size:12px; color:#666; margin-bottom:4px">@widget.Label</div>
                <div style="height:32px; background:#fff; border:1px solid #e0e0e0; border-radius:2px"></div>
            </div>
        }
    };

    /// <summary>
    /// æ¸²æŸ“å®¹å™¨ç»„ä»¶çš„è®¾è®¡æ€å¤–è§‚
    /// ä½¿ç”¨ä¸“ç”¨çš„æ¸²æŸ“å™¨ç»„ä»¶ï¼ŒèŒè´£åˆ†ç¦»
    /// </summary>
    private RenderFragment RenderContainerDesign(ContainerWidget container) => __builder =>
    {
        // æ ¹æ®å®¹å™¨ç±»å‹ä½¿ç”¨å¯¹åº”çš„æ¸²æŸ“å™¨ç»„ä»¶
        switch (container)
        {
            case GridWidget grid:
                <GridDesignRenderer Grid="@grid" 
                                  RenderChild="@RenderDesignWidget"
                                  OnDrop="@(e => OnContainerDrop(e, grid))"
                                  OnDragOver="@OnDragOver" />
                break;
            
            case PanelWidget panel:
                <PanelDesignRenderer Panel="@panel"
                                   RenderChild="@RenderDesignWidget"
                                   OnDrop="@(e => OnContainerDrop(e, panel))"
                                   OnDragOver="@OnDragOver" />
                break;
            
            case SectionWidget sectionWidget:
                <SectionDesignRenderer Section="@sectionWidget"
                                     RenderChild="@RenderDesignWidget"
                                     OnDrop="@(e => OnContainerDrop(e, sectionWidget))"
                                     OnDragOver="@OnDragOver" />
                break;
            
            case FrameWidget frame:
                <FrameDesignRenderer Frame="@frame"
                                   RenderChild="@RenderDesignWidget"
                                   OnDrop="@(e => OnContainerDrop(e, frame))"
                                   OnDragOver="@OnDragOver" />
                break;
            
            case TabContainerWidget tabContainer:
                <TabContainerDesignRenderer TabContainer="@tabContainer"
                                          RenderChild="@RenderDesignWidget"
                                          OnDrop="@(e => OnContainerDrop(e, tabContainer))"
                                          OnDragOver="@OnDragOver" />
                break;
            
            default:
                <GenericContainerDesignRenderer Container="@container"
                                              RenderChild="@RenderDesignWidget"
                                              OnDrop="@(e => OnContainerDrop(e, container))"
                                              OnDragOver="@OnDragOver" />
                break;
        }
    };

    // æ‹–æ”¾å¤„ç†æ–¹æ³•ï¼ˆä»CustomerDetailå¤åˆ¶ï¼‰
    private async Task OnDragStart(Microsoft.AspNetCore.Components.Web.DragEventArgs e, WidgetRegistry.WidgetDefinition definition)
    {
        dropSucceeded = false;
        draggedDefinition = definition;
        // æ³¨æ„ï¼šä¸è°ƒç”¨StateHasChanged()ï¼åœ¨drag-startä¸­é‡æ–°æ¸²æŸ“ä¼šå¯¼è‡´æµè§ˆå™¨ç»ˆæ­¢æ‹–æ‹½
        // ä¾èµ–JSçš„body.is-draggingæ¥æ§åˆ¶CSSï¼Œæ— éœ€Blazoré‡æ–°æ¸²æŸ“
        try { await JS.InvokeVoidAsync("console.log", $"[FormDesigner] OnDragStart: {definition.Type}"); } catch { }
    }

    private async Task OnWidgetDragStart(Microsoft.AspNetCore.Components.Web.DragEventArgs e, DraggableWidget widget)
    {
        dropSucceeded = false;
        draggedWidget = widget;
        draggedParentContainer = WidgetNavigationHelper.FindParentContainer(layoutWidgets, widget);
        // æ³¨æ„ï¼šä¸è°ƒç”¨StateHasChanged()ï¼åœ¨drag-startä¸­é‡æ–°æ¸²æŸ“ä¼šå¯¼è‡´æµè§ˆå™¨ç»ˆæ­¢æ‹–æ‹½
        // ä¾èµ–JSçš„body.is-draggingæ¥æ§åˆ¶CSSï¼Œæ— éœ€Blazoré‡æ–°æ¸²æŸ“
        try { await JS.InvokeVoidAsync("console.log", $"[FormDesigner] OnWidgetDragStart: {widget.Id}"); } catch { }
    }

    private void OnEntityFieldDragStart(EntityFieldNode field)
    {
        dropSucceeded = false;
        draggedEntityField = field;
        // æ³¨æ„ï¼šä¸è°ƒç”¨StateHasChanged()ï¼åœ¨drag-startä¸­é‡æ–°æ¸²æŸ“ä¼šå¯¼è‡´æµè§ˆå™¨ç»ˆæ­¢æ‹–æ‹½
    }

    private void OnDragOver(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        // Allow drop
    }

    private async Task OnDrop(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        if (draggedDefinition != null)
        {
            var newWidget = WidgetRegistry.Create(draggedDefinition.Type, I18n.T(draggedDefinition.LabelKey));

            // è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„ Code
            newWidget.Code = WidgetCodeGenerator.GenerateUniqueCode(newWidget, GetAllWidgets());

            layoutWidgets.Add(newWidget);
            selectedWidget = newWidget;
            dropSucceeded = true;
            draggedDefinition = null;
            await InvokeAsync(StateHasChanged);
        }
        else if (draggedEntityField != null)
        {
            // ä»å®ä½“å­—æ®µåˆ›å»ºç»„ä»¶
            var widgetType = draggedEntityField.SuggestedWidgetType;
            var label = draggedEntityField.DisplayName;

            var newWidget = WidgetRegistry.Create(widgetType, label);

            // è®¾ç½®æ•°æ®å­—æ®µç»‘å®š
            newWidget.DataField = draggedEntityField.PropertyName;
            newWidget.Label = label;

            // è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„ Code
            newWidget.Code = WidgetCodeGenerator.GenerateUniqueCode(newWidget, GetAllWidgets());

            layoutWidgets.Add(newWidget);
            selectedWidget = newWidget;
            dropSucceeded = true;
            draggedEntityField = null;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnDragEnd(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        // âš ï¸ Guardï¼šå¦‚æœæ­£åœ¨å¤„ç†dropï¼Œä¸è¦æ¸…ç©ºçŠ¶æ€ï¼ˆè®©OnContainerDropå®Œæˆï¼‰
        if (isProcessingDrop)
        {
            return;
        }

        if (!dropSucceeded)
        {
            draggedDefinition = null;
            draggedWidget = null;
            draggedEntityField = null;
        }
        dropSucceeded = false;
        await InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// å¤„ç†å®¹å™¨å†…çš„æ‹–æ”¾äº‹ä»¶
    /// </summary>
    private async Task OnContainerDrop(Microsoft.AspNetCore.Components.Web.DragEventArgs e, ContainerWidget targetContainer)
    {
        // âš ï¸ å…³é”®ï¼šå¿…é¡»åœ¨ç¬¬ä¸€è¡Œï¼ˆä»»ä½•awaitä¹‹å‰ï¼‰è®¾ç½®guardå¹¶ä¿å­˜å¿«ç…§
        // é˜²æ­¢ç«æ€æ¡ä»¶ï¼šawaitæœŸé—´æµè§ˆå™¨è§¦å‘dragendï¼ŒOnDragEndæ¸…ç©ºå­—æ®µ
        isProcessingDrop = true;
        var definition = draggedDefinition;
        var movingWidget = draggedWidget;
        var originalParent = draggedParentContainer;

        try
        {
            // è¯Šæ–­æ—¥å¿—ï¼šéªŒè¯å¿«ç…§æ˜¯å¦æˆåŠŸä¿å­˜
            await JS.InvokeVoidAsync("console.log",
                $"[FormDesigner] OnContainerDrop start: container={targetContainer.Id}, " +
                $"def={definition?.Type ?? "null"}, widget={movingWidget?.Id ?? "null"}");

            // ä½¿ç”¨ JavaScript è®¡ç®—æ’å…¥ç´¢å¼•
            var containerSelector = $".frame-drop-zone[data-container-id=\"{targetContainer.Id}\"]";
            var insertIndex = await JS.InvokeAsync<int>("bobcrm.getInsertIndex", containerSelector, e.ClientX, e.ClientY);

            // ä»å·¥å…·ç®±æ‹–å…¥æ–°ç»„ä»¶
            if (definition != null)
            {
                var newWidget = WidgetRegistry.Create(definition.Type, I18n.T(definition.LabelKey));

                // è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„ Code
                newWidget.Code = WidgetCodeGenerator.GenerateUniqueCode(newWidget, GetAllWidgets());

                // åˆå§‹åŒ– Children åˆ—è¡¨
                if (targetContainer.Children == null)
                {
                    targetContainer.Children = new List<DraggableWidget>();
                }

                // åœ¨æŒ‡å®šä½ç½®æ’å…¥
                if (insertIndex >= 0 && insertIndex < targetContainer.Children.Count)
                {
                    targetContainer.Children.Insert(insertIndex, newWidget);
                }
                else
                {
                    targetContainer.Children.Add(newWidget);
                }

                selectedWidget = newWidget;
                dropSucceeded = true;
                draggedDefinition = null;

                await JS.InvokeVoidAsync("console.log", $"[FormDesigner] Added new widget to container at index {insertIndex}");
                await InvokeAsync(StateHasChanged);
            }
            // ä»å®ä½“å­—æ®µåˆ›å»ºç»„ä»¶å¹¶æ·»åŠ åˆ°å®¹å™¨
            else if (draggedEntityField != null)
            {
                var widgetType = draggedEntityField.SuggestedWidgetType;
                var label = draggedEntityField.DisplayName;

                var newWidget = WidgetRegistry.Create(widgetType, label);

                // è®¾ç½®æ•°æ®å­—æ®µç»‘å®š
                newWidget.DataField = draggedEntityField.PropertyName;
                newWidget.Label = label;

                // è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„ Code
                newWidget.Code = WidgetCodeGenerator.GenerateUniqueCode(newWidget, GetAllWidgets());

                // åˆå§‹åŒ– Children åˆ—è¡¨
                if (targetContainer.Children == null)
                {
                    targetContainer.Children = new List<DraggableWidget>();
                }

                // åœ¨æŒ‡å®šä½ç½®æ’å…¥
                if (insertIndex >= 0 && insertIndex < targetContainer.Children.Count)
                {
                    targetContainer.Children.Insert(insertIndex, newWidget);
                }
                else
                {
                    targetContainer.Children.Add(newWidget);
                }

                selectedWidget = newWidget;
                dropSucceeded = true;
                draggedEntityField = null;

                await JS.InvokeVoidAsync("console.log", $"[FormDesigner] Added entity field widget to container at index {insertIndex}");
                await InvokeAsync(StateHasChanged);
            }
            // ç§»åŠ¨å·²æœ‰ç»„ä»¶åˆ°å®¹å™¨
            else if (movingWidget != null)
            {
                // æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€ä¸ªå®¹å™¨å†…ç§»åŠ¨
                var isSameContainer = originalParent != null && ReferenceEquals(originalParent, targetContainer);

                // ä»åŸä½ç½®ç§»é™¤
                if (originalParent != null && originalParent.Children != null)
                {
                    var oldIndex = originalParent.Children.IndexOf(movingWidget);
                    originalParent.Children.Remove(movingWidget);

                    // å¦‚æœåœ¨åŒä¸€ä¸ªå®¹å™¨å†…ç§»åŠ¨ï¼Œéœ€è¦è°ƒæ•´æ’å…¥ç´¢å¼•
                    if (isSameContainer && oldIndex >= 0 && insertIndex > oldIndex)
                    {
                        insertIndex--;
                    }
                }
                // ä»é¡¶å±‚ layoutWidgets ä¸­ç§»é™¤
                else
                {
                    layoutWidgets.Remove(movingWidget);
                }

                // åˆå§‹åŒ– Children åˆ—è¡¨
                if (targetContainer.Children == null)
                {
                    targetContainer.Children = new List<DraggableWidget>();
                }

                // åœ¨æŒ‡å®šä½ç½®æ’å…¥
                if (insertIndex >= 0 && insertIndex < targetContainer.Children.Count)
                {
                    targetContainer.Children.Insert(insertIndex, movingWidget);
                }
                else
                {
                    targetContainer.Children.Add(movingWidget);
                }

                dropSucceeded = true;
                draggedWidget = null;
                draggedParentContainer = null;

                await JS.InvokeVoidAsync("console.log", $"[FormDesigner] Moved widget to container at index {insertIndex}");
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[FormDesigner] OnContainerDrop error: {ex.Message}");
        }
        finally
        {
            // ç¡®ä¿æ— è®ºæˆåŠŸè¿˜æ˜¯å¼‚å¸¸éƒ½é‡ç½®guardæ ‡å¿—
            isProcessingDrop = false;
        }
    }

    private void SelectWidget(DraggableWidget widget)
    {
        selectedWidget = widget;
        StateHasChanged();
    }

    private void UpdateWidget()
    {
        StateHasChanged();
    }

    private void DeleteSelectedWidget()
    {
        if (selectedWidget != null)
        {
            layoutWidgets.Remove(selectedWidget);
            selectedWidget = null;
            StateHasChanged();
        }
    }

    /// <summary>
    /// åˆ é™¤æŒ‡å®šçš„ç»„ä»¶ï¼ˆä»é¡¶å±‚æˆ–çˆ¶å®¹å™¨ä¸­ï¼‰
    /// </summary>
    private void DeleteWidget(DraggableWidget widget)
    {
        // å°è¯•ä»é¡¶å±‚åˆ é™¤
        if (layoutWidgets.Remove(widget))
        {
            if (selectedWidget == widget)
            {
                selectedWidget = null;
            }
            StateHasChanged();
            return;
        }

        // å°è¯•ä»çˆ¶å®¹å™¨ä¸­åˆ é™¤
        var parentContainer = WidgetNavigationHelper.FindParentContainer(layoutWidgets, widget);
        if (parentContainer?.Children != null && parentContainer.Children.Remove(widget))
        {
            if (selectedWidget == widget)
            {
                selectedWidget = null;
            }
            StateHasChanged();
        }
    }

    // Resize åŠŸèƒ½çŠ¶æ€
    private DraggableWidget? resizingWidget = null;
    private DotNetObjectReference<FormDesigner>? resizeDotNetRef = null;

    private async Task OnResizeStart(Microsoft.AspNetCore.Components.Web.MouseEventArgs e, DraggableWidget widget)
    {
        resizingWidget = widget;
        
        // åˆ›å»º .NET å¯¹è±¡å¼•ç”¨
        resizeDotNetRef?.Dispose(); // æ¸…ç†æ—§çš„å¼•ç”¨
        resizeDotNetRef = DotNetObjectReference.Create(this);

        // åˆå§‹åŒ– JavaScript resize å¤„ç†å™¨
        await JS.InvokeVoidAsync("FormDesignerResize.start", resizeDotNetRef, widget.Id, e.ClientX);
    }

    [JSInvokable]
    public void OnResizeMove(string widgetId, int newWidth)
    {
        if (resizingWidget == null || resizingWidget.Id != widgetId) return;

        // æ›´æ–°ç»„ä»¶å®½åº¦
        if (resizingWidget is IFlowSized flowWidget)
        {
            flowWidget.Width = Math.Max(50, newWidth); // æœ€å°å®½åº¦50px
            flowWidget.WidthUnit = "px"; // resizeæ—¶ä½¿ç”¨px
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void OnResizeEnd()
    {
        resizingWidget = null;
        
        // æ¸…ç† DotNetObjectReferenceï¼ˆä½†ä¸ç«‹å³disposeï¼Œç­‰å¾…ä¸‹æ¬¡resizeæˆ–ç»„ä»¶é”€æ¯æ—¶ï¼‰
        // resizeDotNetRef?.Dispose();
        // resizeDotNetRef = null;
    }

    public void Dispose()
    {
        I18n.OnChanged -= HandleI18nChanged;
        resizeDotNetRef?.Dispose();
    }

    private void HandleI18nChanged()
    {
        // è¯­è¨€åˆ‡æ¢æ—¶æ›´æ–°é»˜è®¤æ¨¡æ¿åç§°
        if (templateName == I18n.T("LBL_NEW_TEMPLATE") || string.IsNullOrWhiteSpace(TemplateId))
        {
            templateName = I18n.T("LBL_NEW_TEMPLATE");
        }
        try { InvokeAsync(StateHasChanged); } catch { }
    }

    private void TryAddWidget(System.Text.Json.JsonElement element)
    {
        try
        {
            var widget = LayoutMapper.FromJsonElement(element);
            layoutWidgets.Add(widget);
        }
        catch (Exception ex)
        {
            _ = JS.InvokeVoidAsync("console.error", $"[FormDesigner] Failed to parse widget: {ex.Message}");
        }
    }

    /// <summary>
    /// è·å–æ‰€æœ‰ Widgetï¼ˆåŒ…æ‹¬åµŒå¥—çš„å­ç»„ä»¶ï¼‰
    /// </summary>
    private IEnumerable<DraggableWidget> GetAllWidgets()
    {
        return WidgetNavigationHelper.GetAllWidgets(layoutWidgets);
    }
}

<style>
    .designer-toolbox {
        flex-basis: 350px !important;
        width: 350px !important;
        min-width: 350px !important;
    }

    .compact-tooltip .ant-tooltip-inner {
        padding: 6px 8px !important;
        min-height: unset !important;
    }
    
    .compact-tooltip .ant-tooltip-title {
        margin-bottom: 0 !important;
    }
</style>

