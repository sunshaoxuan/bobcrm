@page "/designer"
@page "/designer/{TemplateId}"
@rendermode RenderMode.InteractiveServer
@implements IDisposable

@using BobCrm.App.Models
@using BobCrm.App.Models.Widgets
@using BobCrm.App.Services.Widgets
@using BobCrm.App.Services.Widgets.Rendering
@using Microsoft.AspNetCore.Components.Rendering
@using BobCrm.App.Components.Designer.ContainerRenderers
@using BobCrm.App.Components.Designer
@using BobCrm.App.Components.Designer.WidgetPreviews
@using BobCrm.App.Services.Designer
@using ListItem = BobCrm.App.Models.Widgets.ListItem;

@inject BobCrm.App.Services.AuthService Auth
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject BobCrm.App.Services.I18nService I18n
@inject IDesignWidgetContentRenderer DesignRenderer
@inject IDesignContainerRenderer ContainerRenderer
@inject IWidgetPropertyProvider PropertyProvider

<script src="/js/form-designer-resize.js"></script>

<AuthChecker>
@if (loading)
{
    <div class="text-muted">@I18n.T("LBL_LOADING")...</div>
}
else if (error != null)
{
    <Alert Message="@error" Type="AlertType.Error" ShowIcon="true" />
    <div style="margin-top:16px">
        <Button OnClick="@(() => Nav.NavigateTo("/templates"))">@I18n.T("BTN_BACK")</Button>
    </div>
}
else
{
    <!-- Full screen designer -->
    <div class="designer-container" style="position:fixed; top:0; left:0; right:0; bottom:0; background:#fff; z-index:1000; display:flex; flex-direction:column">
        <!-- Designer Header -->
        <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 20px; border-bottom:1px solid var(--border); background:var(--card-bg)">
            <div style="display:flex; align-items:center; gap:16px">
                <h2 style="margin:0; font-size:18px">@I18n.T("MODE_DESIGN") - @templateName</h2>
                <Tag Color="blue">@entityType</Tag>
            </div>
            <div style="display:flex; gap:8px">
                <Button Type="@ButtonType.Primary" OnClick="SaveLayout" Icon="@IconType.Outline.Save">@I18n.T("BTN_SAVE_LAYOUT")</Button>
                <Button OnClick="@(() => Nav.NavigateTo("/templates"))" Icon="@IconType.Outline.Close">@I18n.T("BTN_EXIT_DESIGN")</Button>
            </div>
        </div>

        <!-- Designer Main Area -->
        <div style="display:flex; flex:1; overflow:hidden">
            <!-- Left Toolbox -->
            <div class="designer-toolbox" style="width:240px; border-right:1px solid var(--border); overflow-y:auto; background:#fafafa">
                <div style="padding:16px">
                    <h3 style="margin:0 0 12px 0; font-size:14px; font-weight:600">@I18n.T("LBL_COMPONENTS")</h3>
                    <Collapse Accordion="false" DefaultActiveKey="@(new[]{"1","2"})">
                        <Panel Header="@I18n.T("LBL_BASIC_COMPONENTS")" Key="1">
                            <div style="display:flex; flex-direction:column; gap:8px">
                                @foreach (var comp in WidgetRegistry.BasicWidgets)
                                {
                                    <div class="component-item" draggable="true" data-drag-type="component" data-drag-data="@comp.Type" 
                                         @ondragstart="@((e) => OnDragStart(e, comp))" @ondragstart:preventDefault="false" @ondragend="OnDragEnd"
                                         style="padding:8px 12px; background:#fff; border:1px solid #d9d9d9; border-radius:4px; cursor:move; display:flex; align-items:center; gap:8px">
                                        <Icon Type="@comp.Icon" />
                                        <span style="font-size:13px">@I18n.T(comp.LabelKey)</span>
                                    </div>
                                }
                            </div>
                        </Panel>
                        <Panel Header="@I18n.T("LBL_LAYOUT_COMPONENTS")" Key="2">
                            <div style="display:flex; flex-direction:column; gap:8px">
                                @foreach (var comp in WidgetRegistry.LayoutWidgets)
                                {
                                    <div class="component-item" draggable="true" data-drag-type="component" data-drag-data="@comp.Type" 
                                         @ondragstart="@((e) => OnDragStart(e, comp))" @ondragstart:preventDefault="false" @ondragend="OnDragEnd"
                                         style="padding:8px 12px; background:#fff; border:1px solid #d9d9d9; border-radius:4px; cursor:move; display:flex; align-items:center; gap:8px">
                                        <Icon Type="@comp.Icon" />
                                        <span style="font-size:13px">@I18n.T(comp.LabelKey)</span>
                                    </div>
                                }
                            </div>
                        </Panel>
                    </Collapse>
                </div>
            </div>

            <!-- Center Canvas -->
            <div class="designer-canvas" style="flex:1; overflow:auto; background-image:radial-gradient(circle, #d0d0d0 1px, transparent 1px); background-size:5px 5px; background-color:#fafafa;"
                 @ondrop="OnDrop" @ondrop:preventDefault @ondrop:stopPropagation @ondragover="OnDragOver" @ondragover:preventDefault
                 @onclick="OnCanvasBackgroundClick">
                <div @ref="canvasRef" class="layout-widgets-container" style="display:flex; flex-wrap:wrap; align-content:flex-start; align-items:flex-start; padding:24px; position:relative"
                     @onclick:stopPropagation>
                    @foreach (var widget in layoutWidgets)
                    {
                        @if (widget.NewLine)
                        {
                            <div style="width:100%; height:0; flex-basis:100%"></div>
                        }

                        <div class="layout-widget @(selectedWidget == widget ? "selected" : "")"
                             draggable="@(resizingIds.Contains(widget.Id) ? "false" : "true")"
                             data-drag-type="widget"
                             data-drag-data="@widget.Id"
                             data-widget-id="@widget.Id"
                             @ondragstart="@((e) => OnWidgetDragStart(e, widget))"
                             @ondragstart:preventDefault="@(resizingIds.Contains(widget.Id))"
                             @ondragstart:stopPropagation
                             @ondragend="OnDragEnd"
                             @onclick="@(() => SelectWidget(widget))"
                             style="@(WidgetStyleHelper.GetFlowWidgetStyle(widget, selectedWidget == widget))">

                            @if (selectedWidget == widget)
                            {
                                <div class="resize-handle"
                                     draggable="false"
                                     @onmousedown="@((e) => OnResizeStart(e, widget))"
                                     @onmousedown:stopPropagation
                                     @onmousedown:preventDefault
                                     @ondragstart:preventDefault="true"
                                     style="position:absolute; right:-2px; top:50%; transform:translateY(-50%); width:4px; height:48px; cursor:ew-resize; background:#1890ff; border-radius:2px; z-index:10; box-shadow:0 2px 8px rgba(24,144,255,0.6); opacity:0.8;">
                                </div>
                            }

                            <div class="widget-content" style="width:100%; pointer-events:none">
                                @RenderWidgetVisual(widget)
                            </div>
                        </div>
                    }
                    @if (!layoutWidgets.Any())
                    {
                        <div style="width:100%; text-align:center; padding:60px 20px; color:#999; pointer-events:none">
                            <Icon Type="@IconType.Outline.Inbox" Style="font-size:48px; margin-bottom:12px" />
                            <div>@I18n.T("LBL_DRAG_COMPONENT_HERE")</div>
                        </div>
                    }
                </div>
            </div>

            <!-- Right Properties Panel -->
            <div class="designer-properties" style="width:280px; border-left:1px solid var(--border); overflow-y:auto; overflow-x:hidden; background:#fafafa"
                 @onclick="OnCanvasBackgroundClick">
                @if (selectedWidget != null)
                {
                    <div style="padding:16px" @onclick:stopPropagation>
                        <h3 style="margin:0 0 16px 0; font-size:14px; font-weight:600">@I18n.T("LBL_WIDGET_PROPERTIES")</h3>

                        <div style="margin-bottom:16px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_COMPONENT_TYPE")</label>
                            <Input Value="@selectedWidget.Type" Disabled />
                        </div>

                        <div style="margin-bottom:16px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_LABEL")</label>
                            <Input @bind-Value="selectedWidget.Label" OnChange="@((string value) => UpdateWidget())" />
                        </div>

                        <div style="margin-bottom:16px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_WIDTH")</label>
                            <InputGroup Compact>
                                @{
                                    var widthMax = selectedWidget.GetMaxWidth();
                                }
                                @if (widthMax.HasValue)
                                {
                                    <AntDesign.InputNumber TValue="int" @bind-Value="selectedWidget.Width" Min="1" Max="@widthMax.Value" Style="width:70%" OnChange="@(value => UpdateWidget())" />
                                }
                                else
                                {
                                    <AntDesign.InputNumber TValue="int" @bind-Value="selectedWidget.Width" Min="1" Style="width:70%" OnChange="@(value => UpdateWidget())" />
                                }
                                <Select TItemValue="string" TItem="string" 
                                       Value="@selectedWidget.WidthUnit" 
                                       Style="width:30%" 
                                       OnSelectedItemChanged="@(value => { selectedWidget.WidthUnit = value; UpdateWidget(); })">
                                    <SelectOptions>
                                        <SelectOption TItemValue="string" TItem="string" Value="@("%")" Label="%" />
                                        <SelectOption TItemValue="string" TItem="string" Value="@("px")" Label="px" />
                                    </SelectOptions>
                                </Select>
                            </InputGroup>
                        </div>

                        <div style="margin-bottom:16px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_DATA_SOURCE")</label>
                            <Select TItemValue="string" TItem="string" @bind-Value="selectedWidget.DataField" AllowClear Style="width:100%" OnSelectedItemChanged="@(item => UpdateWidget())">
                                @* â­ ä»FieldDefinitionsåŠ è½½ï¼Œä¸ä¾èµ–ç‰¹å®šå®ä½“æ•°æ® *@
                                @foreach (var field in availableFields)
                                {
                                    <SelectOption Value="@field.Key" Label="@field.DisplayName" />
                                }
                            </Select>
                        </div>

                        <div style="margin-bottom:16px; display:flex; justify-content:space-between; align-items:center">
                            <label style="font-size:12px; color:#666">@I18n.T("LBL_VISIBLE")</label>
                            <Switch @bind-Value="selectedWidget.Visible" OnChange="@(value => UpdateWidget())" />
                        </div>

                        <div style="margin-bottom:16px; display:flex; justify-content:space-between; align-items:center">
                            <label style="font-size:12px; color:#666">@I18n.T("LBL_NEW_LINE")</label>
                            <Switch @bind-Value="selectedWidget.NewLine" OnChange="@(value => UpdateWidget())" />
                        </div>

                        @* ===== ç‰¹å®šç±»å‹å±æ€§é¢æ¿ ===== *@
                        @RenderTypeSpecificPropertyPanel(selectedWidget)

                        <Divider />

                        <Button Danger Block OnClick="DeleteSelectedWidget" Icon="@IconType.Outline.Delete">@I18n.T("BTN_DELETE")</Button>
                    </div>
                }
                else
                {
                    <div style="padding:16px 16px 8px 16px" @onclick:stopPropagation>
                        <h3 style="margin:0 0 12px 0; font-size:14px; font-weight:600">@I18n.T("LBL_TEMPLATE_PROPERTIES")</h3>
                        
                        <div style="margin-bottom:12px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_TEMPLATE_NAME")</label>
                            <Input @bind-Value="templateName" Placeholder="@I18n.T("LBL_ENTER_TEMPLATE_NAME")" />
                        </div>

                        <div style="margin-bottom:12px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_ENTITY_TYPE")</label>
                            
                            @if (isEntityTypeLocked)
                            {
                                <!-- å®ä½“ç±»å‹å·²é”å®šï¼Œä¸å¯ä¿®æ”¹ -->
                                <Input Value="@GetEntityDisplayName()" Disabled Style="width:100%" />
                                <div style="margin-top:4px; font-size:11px; color:#ff9800">
                                    ğŸ”’ @I18n.T("LBL_ENTITY_TYPE_LOCKED")
                                </div>
                            }
                            else
                            {
                                <!-- æœªè®¾ç½®å®ä½“ç±»å‹ï¼Œä½¿ç”¨é€šç”¨å®ä½“é€‰æ‹©å™¨ -->
                                <EntitySelector TEntity="EntityTypeItem"
                                                @bind-Value="entityType"
                                                Title="@I18n.T("LBL_SELECT_ENTITY_TYPE")"
                                                Placeholder="@I18n.T("LBL_CLICK_TO_SELECT_ENTITY")"
                                                EmptyText="@I18n.T("LBL_NO_AVAILABLE_ENTITIES")"
                                                DataLoader="LoadAvailableEntitiesForSelector"
                                                ValueGetter="@(e => e.EntityType)"
                                                DisplayTextGetter="@(e => e.DisplayName)"
                                                EnableSearch="true">
                                    <TitleRenderer>
                                        @context.DisplayName
                                    </TitleRenderer>
                                    <DescriptionRenderer>
                                        @if (!string.IsNullOrWhiteSpace(context.Description))
                                        {
                                            @context.Description
                                        }
                                    </DescriptionRenderer>
                                    <IconRenderer>
                                        @if (!string.IsNullOrWhiteSpace(context.Icon))
                                        {
                                            <Icon Type="@context.Icon" Style="font-size:28px; color:#1890ff" />
                                        }
                                    </IconRenderer>
                                    <MetadataRenderer>
                                        <Tag Color="blue" Style="margin-right:8px">@context.EntityName</Tag>
                                        <Tag Color="default">@context.ApiEndpoint</Tag>
                                    </MetadataRenderer>
                                </EntitySelector>
                                <div style="margin-top:4px; font-size:11px; color:#999">
                                    @I18n.T("LBL_ENTITY_TYPE_HINT")
                                </div>
                            }
                        </div>

                        <Divider Style="margin:12px 0" />

                        <div style="margin-bottom:12px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_COMPONENTS")</label>
                            <div style="font-size:20px; font-weight:600; color:#1890ff">@layoutWidgets.Count</div>
                        </div>

                        <div style="margin-top:8px; padding:8px; background:#e6f7ff; border:1px solid #91d5ff; border-radius:4px; font-size:11px; color:#666; line-height:1.4">
                            <Icon Type="@IconType.Outline.InfoCircle" Style="color:#1890ff; margin-right:4px" />
                            @I18n.T("LBL_TEMPLATE_INFO_HINT")
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}
</AuthChecker>

@code {
    [Parameter] public string? TemplateId { get; set; }

    private string templateName = "";
    private string entityType = "";
    private string? originalEntityType = null; // æ¨¡æ¿åŸå§‹çš„å®ä½“ç±»å‹ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦é”å®šï¼‰
    private bool isEntityTypeLocked = false; // å®ä½“ç±»å‹æ˜¯å¦å·²é”å®šï¼ˆå·²è®¾ç½®çš„æ¨¡æ¿ä¸å…è®¸ä¿®æ”¹å®ä½“ç±»å‹ï¼‰
    private bool loading = true;
    private string? error;

    private List<DraggableWidget> layoutWidgets = new();
    private DraggableWidget? selectedWidget;
    private HashSet<string> resizingIds = new();
    private ElementReference canvasRef;

    // â­ å¯ç”¨å­—æ®µåˆ—è¡¨ï¼ˆä»FieldDefinitions APIåŠ è½½ï¼‰
    private List<FieldDefinitionItem> availableFields = new();

    // â­ å¯ç”¨å®ä½“ç±»å‹åˆ—è¡¨ï¼ˆä¾› EntitySelector ä½¿ç”¨ï¼‰
    private List<EntityTypeItem> availableEntityTypes = new();

    // æ‹–æ”¾çŠ¶æ€
    private WidgetRegistry.WidgetDefinition? draggedDefinition;
    private DraggableWidget? draggedWidget;
    private DraggableWidget? draggedParentContainer;
    private bool dropSucceeded = false;

    // Tabç®¡ç†
    private readonly TabStateManager tabStateManager = new();

    protected override void OnInitialized()
    {
        templateName = I18n.T("LBL_NEW_TEMPLATE");
        I18n.OnChanged += HandleI18nChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            // 1. åŠ è½½å¯ç”¨å­—æ®µåˆ—è¡¨ï¼ˆè®¾è®¡å™¨å¿…éœ€ï¼‰
            await LoadAvailableFields();

            // 2. åŠ è½½æ¨¡æ¿
            if (string.IsNullOrWhiteSpace(TemplateId))
            {
                InitializeEmptyTemplate();
            }
            else
            {
                await LoadTemplate();
            }
            
            loading = false;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            error = ex.Message;
            loading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    /// <summary>
    /// EntitySelector çš„æ•°æ®åŠ è½½å™¨
    /// </summary>
    private async Task<List<EntityTypeItem>> LoadAvailableEntitiesForSelector()
    {
        try
        {
            await JS.InvokeVoidAsync("console.log", "[FormDesigner] Loading entities for selector...");
            
            var resp = await Auth.GetWithRefreshAsync("/api/entities");
            
            if (resp.IsSuccessStatusCode)
            {
                var content = await resp.Content.ReadAsStringAsync();
                var jsonOptions = new System.Text.Json.JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                };
                
                var entities = System.Text.Json.JsonSerializer.Deserialize<List<EntityTypeItem>>(content, jsonOptions) ?? new();
                
                // â­ å…³é”®ï¼šç¿»è¯‘æ˜¾ç¤ºåç§°å’Œæè¿°ï¼Œå¡«å……åˆ°å®ä½“å¯¹è±¡ä¸­
                foreach (var entity in entities)
                {
                    entity.DisplayName = I18n.T(entity.DisplayNameKey);
                    if (!string.IsNullOrWhiteSpace(entity.DescriptionKey))
                    {
                        entity.Description = I18n.T(entity.DescriptionKey);
                    }
                }
                
                await JS.InvokeVoidAsync("console.log", $"[FormDesigner] Loaded {entities.Count} entity types for selector (with translations)");
                
                return entities;
            }
            else
            {
                await JS.InvokeVoidAsync("console.error", $"[FormDesigner] API failed with status {resp.StatusCode}");
                return new List<EntityTypeItem>();
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[FormDesigner] Exception: {ex.Message}");
            return new List<EntityTypeItem>();
        }
    }


    private async Task LoadAvailableFields()
    {
        try
        {
            var resp = await Auth.GetWithRefreshAsync("/api/fields");
            if (resp.IsSuccessStatusCode)
            {
                var fields = await resp.Content.ReadFromJsonAsync<List<FieldDefinitionItem>>();
                availableFields = fields ?? new();
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[FormDesigner] Failed to load fields: {ex.Message}");
        }
    }

    private void InitializeEmptyTemplate()
    {
        templateName = I18n.T("LBL_NEW_TEMPLATE");
        entityType = ""; // æ–°å»ºæ¨¡æ¿ï¼Œä¸è®¾ç½®é»˜è®¤å®ä½“ç±»å‹
        originalEntityType = null;
        isEntityTypeLocked = false; // æ–°å»ºæ¨¡æ¿ï¼Œå…è®¸é€‰æ‹©å®ä½“ç±»å‹
        layoutWidgets = new();
    }
    
    /// <summary>
    /// è·å–å½“å‰å®ä½“ç±»å‹çš„æ˜¾ç¤ºåç§°ï¼ˆç”¨äºå·²é”å®šçš„å®ä½“ç±»å‹æ˜¾ç¤ºï¼‰
    /// </summary>
    private string GetEntityDisplayName()
    {
        if (string.IsNullOrWhiteSpace(entityType))
        {
            return I18n.T("LBL_ENTITY_TYPE_NOT_SET");
        }
        
        // å¦‚æœå·²ç»åŠ è½½äº†å®ä½“åˆ—è¡¨ï¼Œä»åˆ—è¡¨ä¸­æŸ¥æ‰¾
        var entity = availableEntityTypes.FirstOrDefault(e => e.EntityType == entityType);
        if (entity != null)
        {
            return I18n.T(entity.DisplayNameKey);
        }
        
        // å¦‚æœæ²¡æœ‰åŠ è½½åˆ—è¡¨ï¼Œæ ¹æ®å®ä½“ç±»å‹æ¨æ–­æ˜¾ç¤ºåç§°
        // ä¾‹å¦‚ï¼šcustomer -> ENTITY_CUSTOMER
        var displayKey = $"ENTITY_{entityType.ToUpper()}";
        return I18n.T(displayKey);
    }

    private void OnCanvasBackgroundClick()
    {
        // ç‚¹å‡»ç”»å¸ƒèƒŒæ™¯æ—¶ï¼Œå–æ¶ˆé€‰ä¸­Widgetï¼Œæ˜¾ç¤ºæ¨¡æ¿å±æ€§
        selectedWidget = null;
        StateHasChanged();
    }

    private async Task LoadTemplate()
    {
        try
        {
            // è§£æTemplateIdï¼ˆå¦‚"user-customer"è¡¨ç¤ºç”¨æˆ·çš„å®¢æˆ·æ¨¡æ¿ï¼‰
            string scope = "effective"; // é»˜è®¤åŠ è½½æœ‰æ•ˆå¸ƒå±€
            int customerId = 0; // é»˜è®¤ä¸ºæ¨¡æ¿
            
            if (TemplateId?.StartsWith("user-") == true)
            {
                // user-customerè¡¨ç¤ºç”¨æˆ·çš„å®¢æˆ·æ¨¡æ¿
                scope = "user";
                entityType = TemplateId.Substring(5); // å»æ‰"user-"å‰ç¼€
            }
            else if (TemplateId?.StartsWith("default-") == true)
            {
                // default-customerè¡¨ç¤ºç³»ç»Ÿé»˜è®¤å®¢æˆ·æ¨¡æ¿
                scope = "default";
                entityType = TemplateId.Substring(8); // å»æ‰"default-"å‰ç¼€
            }
            else if (!string.IsNullOrWhiteSpace(TemplateId))
            {
                // å¦‚æœæ˜¯çº¯å®ä½“åï¼ŒåŠ è½½è¯¥å®ä½“çš„æœ‰æ•ˆæ¨¡æ¿
                entityType = TemplateId;
            }

            // ä»APIåŠ è½½å¸ƒå±€
            var resp = await Auth.GetWithRefreshAsync($"/api/layout/{customerId}?scope={scope}");
            
            if (!resp.IsSuccessStatusCode)
            {
                // åŠ è½½å¤±è´¥ï¼Œåˆå§‹åŒ–ç©ºæ¨¡æ¿
                InitializeEmptyTemplate();
                return;
            }

            var content = await resp.Content.ReadAsStringAsync();
            
            // å¤„ç†ç©ºå“åº”
            if (string.IsNullOrWhiteSpace(content) || content == "{}" || content == "null")
            {
                InitializeEmptyTemplate();
                return;
            }

            // è§£æå¸ƒå±€JSON
            var doc = System.Text.Json.JsonDocument.Parse(content);
            var root = doc.RootElement;

            // è®¾ç½®æ¨¡æ¿åç§°
            templateName = scope == "user" ? I18n.T("LBL_USER_TEMPLATE") : 
                          scope == "default" ? I18n.T("LBL_DEFAULT_TEMPLATE") : 
                          I18n.T("LBL_TEMPLATE");

            // è§£æitemsï¼ˆWidgetåˆ—è¡¨ï¼‰
            if (root.TryGetProperty("items", out var itemsEl))
            {
                layoutWidgets = new List<DraggableWidget>();
                
                foreach (var item in itemsEl.EnumerateObject())
                {
                    try
                    {
                        var widget = LayoutMapper.FromJsonElement(item.Value);
                        layoutWidgets.Add(widget);
                    }
                    catch (Exception ex)
                    {
                        await JS.InvokeVoidAsync("console.error", $"[FormDesigner] Failed to parse widget: {ex.Message}");
                    }
                }

                // ä¿æŒJSONä¸­çš„é¡ºåºï¼ˆè®¾è®¡å™¨ä¸­ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨æ‹–æ‹½è°ƒæ•´ï¼‰
            }
            else
            {
                // æ²¡æœ‰itemså±æ€§ï¼Œå¯èƒ½æ˜¯æ—§æ ¼å¼æˆ–ç©ºæ¨¡æ¿
                layoutWidgets = new List<DraggableWidget>();
            }

            // â­ å…³é”®ï¼šåˆ¤æ–­æ˜¯å¦é”å®šå®ä½“ç±»å‹
            // å¦‚æœæ¨¡æ¿å·²ç»æœ‰ç»„ä»¶ï¼ˆlayoutWidgets.Count > 0ï¼‰ï¼Œè¯´æ˜æ˜¯å·²è®¾è®¡çš„æ¨¡æ¿ï¼Œé”å®šå®ä½“ç±»å‹
            // å¦‚æœæ¨¡æ¿ä¸ºç©ºä½†æœ‰æ˜ç¡®çš„ entityTypeï¼Œä¹Ÿé”å®šï¼ˆé¿å…ç©ºæ¨¡æ¿ä¿®æ”¹å®ä½“ç±»å‹å¯¼è‡´æ··ä¹±ï¼‰
            if (layoutWidgets.Count > 0 && !string.IsNullOrWhiteSpace(entityType))
            {
                originalEntityType = entityType;
                isEntityTypeLocked = true;
                await JS.InvokeVoidAsync("console.log", $"[FormDesigner] Entity type locked: {entityType} (has {layoutWidgets.Count} widgets)");
            }
            else
            {
                originalEntityType = null;
                isEntityTypeLocked = false;
                await JS.InvokeVoidAsync("console.log", $"[FormDesigner] Entity type unlocked: new or empty template");
            }

            await JS.InvokeVoidAsync("console.log", $"[FormDesigner] Loaded template: {layoutWidgets.Count} widgets");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[FormDesigner] LoadTemplate failed: {ex.Message}");
            InitializeEmptyTemplate();
        }
    }

    private class FieldDefinitionItem
    {
        public string Key { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
    }

    /// <summary>
    /// å®ä½“ç±»å‹é¡¹ - å®ç° ISelectableEntity æ¥å£ï¼Œç¡®ä¿å¯ç”¨äº EntitySelector
    /// </summary>
    private class EntityTypeItem : BobCrm.App.Abstractions.ISelectableEntity
    {
        public string EntityType { get; set; } = string.Empty;  // è·¯ç”±åï¼ˆcustomerï¼‰
        public string EntityName { get; set; } = string.Empty;  // ç±»åï¼ˆCustomerï¼‰
        public string DisplayNameKey { get; set; } = string.Empty;  // å¤šè¯­è¨€é”®
        public string DisplayName { get; set; } = string.Empty;  // ç¿»è¯‘åçš„æ˜¾ç¤ºåç§°ï¼ˆç”±å‰ç«¯å¡«å……ï¼‰
        public string? DescriptionKey { get; set; }
        public string? Description { get; set; }  // ç¿»è¯‘åçš„æè¿°ï¼ˆç”±å‰ç«¯å¡«å……ï¼‰
        public string? ApiEndpoint { get; set; }
        public string? Icon { get; set; }
        public string? Category { get; set; }
        
        // ISelectableEntity æ¥å£å®ç°
        string BobCrm.App.Abstractions.ISelectableEntity.Value => EntityType;
        string BobCrm.App.Abstractions.ISelectableEntity.DisplayName => DisplayName;
        string? BobCrm.App.Abstractions.ISelectableEntity.Description => Description;
        string? BobCrm.App.Abstractions.ISelectableEntity.Icon => Icon;
    }

    private async Task SaveLayout()
    {
        try
        {
            // åºåˆ—åŒ–å¸ƒå±€ä¸ºJSON
            var items = new Dictionary<string, object>();
            for (int i = 0; i < layoutWidgets.Count; i++)
            {
                var key = $"item_{i}";
                var itemData = WidgetSerializationHelper.SerializeWidget(layoutWidgets[i], i);
                items[key] = itemData;
            }

            var layoutJson = System.Text.Json.JsonSerializer.Serialize(items);

            // ä¿å­˜åˆ°APIï¼ˆæš‚æ—¶ä½¿ç”¨æ—§çš„Layout APIï¼Œåç»­ä¼šåˆ›å»ºTemplate APIï¼‰
            var client = await Auth.CreateClientWithAuthAsync();
            var payload = new { layoutJson };
            var resp = await client.PostAsJsonAsync($"/api/layout/0", payload);
            
            if (resp.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "ä¿å­˜æˆåŠŸ");
            }
            else
            {
                error = "ä¿å­˜å¤±è´¥";
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
            await JS.InvokeVoidAsync("console.error", $"[FormDesigner] Save failed: {ex.Message}");
        }
    }

    /// <summary>
    /// æ¸²æŸ“æ§ä»¶ç‰¹å®šçš„å±æ€§é¢æ¿
    /// ä½¿ç”¨å…ƒæ•°æ®é©±åŠ¨çš„é€šç”¨å±æ€§ç¼–è¾‘å™¨
    /// </summary>
    private RenderFragment RenderTypeSpecificPropertyPanel(DraggableWidget widget) => __builder =>
    {
        var properties = PropertyProvider.GetProperties(widget);
        <PropertyEditor Properties="@properties" Widget="@widget" OnPropertyChanged="UpdateWidget" />
    };

    /// <summary>
    /// æ¸²æŸ“ç»„ä»¶çš„çº¯è§†è§‰å¤–è§‚ï¼ˆä»…ç”¨äºé¡¶å±‚åŒ…è£¹å±‚å†…éƒ¨ï¼Œä¸åŒ…å«äº¤äº’åŠŸèƒ½ï¼‰
    /// ä½¿ç”¨åŠ¨æ€ç»„ä»¶æ¸²æŸ“ï¼Œå®Œå…¨è§£è€¦ï¼Œç¬¦åˆ OOP åŸåˆ™
    /// æ— éœ€ switchï¼šæ¯ä¸ª Widget ç±»å£°æ˜è‡ªå·±çš„é¢„è§ˆç»„ä»¶ç±»å‹
    /// </summary>
    private RenderFragment RenderWidgetVisual(DraggableWidget widget) => __builder =>
    {
        if (widget is ContainerWidget container)
        {
            // å®¹å™¨ï¼šç›´æ¥æ¸²æŸ“å®¹å™¨è®¾è®¡å¤–è§‚
            @RenderContainerDesign(container)
        }
        else
        {
            // æ™®é€šç»„ä»¶ï¼šæ˜¾ç¤ºæ ‡ç­¾ + ä½¿ç”¨åŠ¨æ€ç»„ä»¶æ¸²æŸ“
            <div style="font-size:12px; color:#666; margin-bottom:4px">@widget.Label</div>
            
            @if (widget.PreviewComponentType != null)
            {
                // åŠ¨æ€æ¸²æŸ“ Widget å£°æ˜çš„é¢„è§ˆç»„ä»¶
                <DynamicComponent Type="@widget.PreviewComponentType"
                                 Parameters="@(new Dictionary<string, object> { ["Widget"] = widget })" />
            }
            else
            {
                // é™çº§å¤„ç†ï¼šæ— é¢„è§ˆç»„ä»¶æ—¶æ˜¾ç¤ºé»˜è®¤è¾“å…¥æ¡†
                <div style="height:32px; background:#fff; border:1px solid #e0e0e0; border-radius:2px"></div>
            }
        }
    };

    /// <summary>
    /// æ¸²æŸ“ç»„ä»¶çš„å®Œæ•´è®¾è®¡æ€ï¼ˆåŒ…å«äº¤äº’å±‚ï¼Œç”¨äºå®¹å™¨å†…å­ç»„ä»¶çš„é€’å½’æ¸²æŸ“ï¼‰
    /// </summary>
    private RenderFragment RenderDesignWidget(DraggableWidget widget) => __builder =>
    {
        var isSelected = selectedWidget == widget;
        var borderColor = isSelected ? "#1890ff" : "#d9d9d9";
        var backgroundColor = isSelected ? "#e6f7ff" : "#fff";
        
        // è®¡ç®—å®½åº¦æ ·å¼
        var widthStyle = "";
        var displayStyle = "display:block;"; // é»˜è®¤å—çº§å…ƒç´ ï¼Œå æ»¡çˆ¶å®¹å™¨
        
        if (widget is IFlowSized flowWidget && flowWidget.Width > 0)
        {
            widthStyle = $"width:{flowWidget.Width}{flowWidget.WidthUnit};";
            displayStyle = "display:block;"; // æœ‰æ˜ç¡®å®½åº¦æ—¶ä¹Ÿä¿æŒå—çº§
        }
        
        // æ ¹æ®ç»„ä»¶ç±»å‹æ¸²æŸ“ä¸åŒçš„å¤–è§‚
        if (widget is ContainerWidget container)
        {
            // æ¸²æŸ“å®¹å™¨ç»„ä»¶ï¼ˆå¸¦æ‹–æ‹½ã€é€‰ä¸­å’ŒresizeåŠŸèƒ½ï¼‰
            // å¤–å±‚ div åªè´Ÿè´£äº¤äº’ï¼ˆæ‹–æ‹½ã€é€‰ä¸­ï¼‰ï¼Œä¸æ·»åŠ è§†è§‰è¾¹æ¡†
            // pointer-events:none è®©æ‹–æ”¾äº‹ä»¶èƒ½ç©¿é€åˆ°å†…éƒ¨çš„ frame-drop-zone
            <div draggable="true"
                 data-widget-id="@container.Id"
                 @ondragstart="@((e) => OnWidgetDragStart(e, container))" @ondragstart:preventDefault="false" @ondragstart:stopPropagation @ondragend="OnDragEnd"
                 @onclick="@(() => SelectWidget(container))" @onclick:stopPropagation
                 style="@widthStyle @displayStyle position:relative; margin:4px; outline:@(isSelected ? "2px solid #1890ff" : "none"); outline-offset:2px; pointer-events:none;">
                @if (isSelected)
                {
                    <div style="position:absolute; top:-28px; right:0; background:#1890ff; color:#fff; padding:2px 8px; border-radius:4px 4px 0 0; font-size:11px; z-index:10; pointer-events:auto; cursor:pointer;">
                        @container.Label
                        <span @onclick="@(() => DeleteWidget(container))" @onclick:stopPropagation style="margin-left:8px; cursor:pointer; font-weight:bold">Ã—</span>
                    </div>
                    @* Resize handle *@
                    <div draggable="false"
                         @onmousedown="@((e) => OnResizeStart(e, container))" @onmousedown:stopPropagation @onmousedown:preventDefault
                         @ondragstart:preventDefault="true"
                         style="position:absolute; right:-6px; top:50%; transform:translateY(-50%); width:8px; height:48px; cursor:ew-resize; background:#1890ff; border-radius:2px; z-index:10; box-shadow:0 2px 8px rgba(24,144,255,0.6); pointer-events:auto;">
                    </div>
                }
                @RenderContainerDesign(container)
            </div>
        }
        else
        {
            // æ¸²æŸ“æ™®é€šç»„ä»¶ï¼ˆå¸¦æ‹–æ‹½ã€é€‰ä¸­å’ŒresizeåŠŸèƒ½ï¼‰
            // å¤–å±‚ div åªè´Ÿè´£äº¤äº’ï¼Œä½¿ç”¨ outline è€Œé borderï¼Œé¿å…åŒå±‚è¾¹æ¡†
            <div draggable="true"
                 data-widget-id="@widget.Id"
                 @ondragstart="@((e) => OnWidgetDragStart(e, widget))" @ondragstart:preventDefault="false" @ondragstart:stopPropagation @ondragend="OnDragEnd"
                 @onclick="@(() => SelectWidget(widget))" @onclick:stopPropagation
                 style="@widthStyle @displayStyle position:relative; cursor:move; margin:4px; outline:@(isSelected ? "2px solid #1890ff" : "1px dashed #d9d9d9"); outline-offset:0px; padding:8px; background:@backgroundColor; border-radius:4px;">
                @if (isSelected)
                {
                    <div style="position:absolute; top:-28px; right:0; background:#1890ff; color:#fff; padding:2px 8px; border-radius:4px 4px 0 0; font-size:11px; z-index:10">
                        @widget.Label
                        <span @onclick="@(() => DeleteWidget(widget))" @onclick:stopPropagation style="margin-left:8px; cursor:pointer; font-weight:bold">Ã—</span>
                    </div>
                    @* Resize handle *@
                    <div draggable="false"
                         @onmousedown="@((e) => OnResizeStart(e, widget))" @onmousedown:stopPropagation @onmousedown:preventDefault
                         @ondragstart:preventDefault="true"
                         style="position:absolute; right:-6px; top:50%; transform:translateY(-50%); width:8px; height:48px; cursor:ew-resize; background:#1890ff; border-radius:2px; z-index:10; box-shadow:0 2px 8px rgba(24,144,255,0.6);">
                    </div>
                }
                <div style="font-size:12px; color:#666; margin-bottom:4px">@widget.Label</div>
                <div style="height:32px; background:#fff; border:1px solid #e0e0e0; border-radius:2px"></div>
            </div>
        }
    };

    /// <summary>
    /// æ¸²æŸ“å®¹å™¨ç»„ä»¶çš„è®¾è®¡æ€å¤–è§‚
    /// ä½¿ç”¨ä¸“ç”¨çš„æ¸²æŸ“å™¨ç»„ä»¶ï¼ŒèŒè´£åˆ†ç¦»
    /// </summary>
    private RenderFragment RenderContainerDesign(ContainerWidget container) => __builder =>
    {
        // æ ¹æ®å®¹å™¨ç±»å‹ä½¿ç”¨å¯¹åº”çš„æ¸²æŸ“å™¨ç»„ä»¶
        switch (container)
        {
            case GridWidget grid:
                <GridDesignRenderer Grid="@grid" 
                                  RenderChild="@RenderDesignWidget"
                                  OnDrop="@(e => OnContainerDrop(e, grid))"
                                  OnDragOver="@OnDragOver" />
                break;
            
            case PanelWidget panel:
                <PanelDesignRenderer Panel="@panel"
                                   RenderChild="@RenderDesignWidget"
                                   OnDrop="@(e => OnContainerDrop(e, panel))"
                                   OnDragOver="@OnDragOver" />
                break;
            
            case SectionWidget sectionWidget:
                <SectionDesignRenderer Section="@sectionWidget"
                                     RenderChild="@RenderDesignWidget"
                                     OnDrop="@(e => OnContainerDrop(e, sectionWidget))"
                                     OnDragOver="@OnDragOver" />
                break;
            
            case FrameWidget frame:
                <FrameDesignRenderer Frame="@frame"
                                   RenderChild="@RenderDesignWidget"
                                   OnDrop="@(e => OnContainerDrop(e, frame))"
                                   OnDragOver="@OnDragOver" />
                break;
            
            case TabContainerWidget tabContainer:
                <TabContainerDesignRenderer TabContainer="@tabContainer"
                                          RenderChild="@RenderDesignWidget"
                                          OnDrop="@(e => OnContainerDrop(e, tabContainer))"
                                          OnDragOver="@OnDragOver" />
                break;
            
            default:
                <GenericContainerDesignRenderer Container="@container"
                                              RenderChild="@RenderDesignWidget"
                                              OnDrop="@(e => OnContainerDrop(e, container))"
                                              OnDragOver="@OnDragOver" />
                break;
        }
    };

    // æ‹–æ”¾å¤„ç†æ–¹æ³•ï¼ˆä»CustomerDetailå¤åˆ¶ï¼‰
    private async Task OnDragStart(Microsoft.AspNetCore.Components.Web.DragEventArgs e, WidgetRegistry.WidgetDefinition definition)
    {
        dropSucceeded = false;
        draggedDefinition = definition;
        try { await JS.InvokeVoidAsync("console.log", $"[FormDesigner] OnDragStart: {definition.Type}"); } catch { }
    }

    private async Task OnWidgetDragStart(Microsoft.AspNetCore.Components.Web.DragEventArgs e, DraggableWidget widget)
    {
        dropSucceeded = false;
        draggedWidget = widget;
        draggedParentContainer = WidgetNavigationHelper.FindParentContainer(layoutWidgets, widget);
        try { await JS.InvokeVoidAsync("console.log", $"[FormDesigner] OnWidgetDragStart: {widget.Id}"); } catch { }
    }

    private void OnDragOver(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        // Allow drop
    }

    private async Task OnDrop(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        if (draggedDefinition != null)
        {
            var newWidget = WidgetRegistry.Create(draggedDefinition.Type, I18n.T(draggedDefinition.LabelKey));
            layoutWidgets.Add(newWidget);
            selectedWidget = newWidget;
            dropSucceeded = true;
            draggedDefinition = null;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnDragEnd(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        if (!dropSucceeded)
        {
            draggedDefinition = null;
            draggedWidget = null;
        }
        dropSucceeded = false;
        await InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// å¤„ç†å®¹å™¨å†…çš„æ‹–æ”¾äº‹ä»¶
    /// </summary>
    private async Task OnContainerDrop(Microsoft.AspNetCore.Components.Web.DragEventArgs e, ContainerWidget targetContainer)
    {
        try
        {
            // ä»å·¥å…·ç®±æ‹–å…¥æ–°ç»„ä»¶
            if (draggedDefinition != null)
            {
                var newWidget = WidgetRegistry.Create(draggedDefinition.Type, I18n.T(draggedDefinition.LabelKey));
                
                // åˆå§‹åŒ– Children åˆ—è¡¨
                if (targetContainer.Children == null)
                {
                    targetContainer.Children = new List<DraggableWidget>();
                }
                
                targetContainer.Children.Add(newWidget);
                selectedWidget = newWidget;
                dropSucceeded = true;
                draggedDefinition = null;
                
                await JS.InvokeVoidAsync("console.log", $"[FormDesigner] Added new widget to container: {targetContainer.Type}");
                await InvokeAsync(StateHasChanged);
            }
            // ç§»åŠ¨å·²æœ‰ç»„ä»¶åˆ°å®¹å™¨
            else if (draggedWidget != null)
            {
                // ä»çˆ¶å®¹å™¨ä¸­ç§»é™¤ï¼ˆå¦‚æœæœ‰çˆ¶å®¹å™¨ï¼‰
                if (draggedParentContainer != null && draggedParentContainer.Children != null)
                {
                    draggedParentContainer.Children.Remove(draggedWidget);
                }
                // ä»é¡¶å±‚ layoutWidgets ä¸­ç§»é™¤
                else
                {
                    layoutWidgets.Remove(draggedWidget);
                }
                
                // åˆå§‹åŒ– Children åˆ—è¡¨
                if (targetContainer.Children == null)
                {
                    targetContainer.Children = new List<DraggableWidget>();
                }
                
                // æ·»åŠ åˆ°ç›®æ ‡å®¹å™¨
                targetContainer.Children.Add(draggedWidget);
                dropSucceeded = true;
                draggedWidget = null;
                draggedParentContainer = null;
                
                await JS.InvokeVoidAsync("console.log", $"[FormDesigner] Moved widget to container: {targetContainer.Type}");
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[FormDesigner] OnContainerDrop error: {ex.Message}");
        }
    }

    private void SelectWidget(DraggableWidget widget)
    {
        selectedWidget = widget;
        StateHasChanged();
    }

    private void UpdateWidget()
    {
        StateHasChanged();
    }

    private void DeleteSelectedWidget()
    {
        if (selectedWidget != null)
        {
            layoutWidgets.Remove(selectedWidget);
            selectedWidget = null;
            StateHasChanged();
        }
    }

    /// <summary>
    /// åˆ é™¤æŒ‡å®šçš„ç»„ä»¶ï¼ˆä»é¡¶å±‚æˆ–çˆ¶å®¹å™¨ä¸­ï¼‰
    /// </summary>
    private void DeleteWidget(DraggableWidget widget)
    {
        // å°è¯•ä»é¡¶å±‚åˆ é™¤
        if (layoutWidgets.Remove(widget))
        {
            if (selectedWidget == widget)
            {
                selectedWidget = null;
            }
            StateHasChanged();
            return;
        }

        // å°è¯•ä»çˆ¶å®¹å™¨ä¸­åˆ é™¤
        var parentContainer = WidgetNavigationHelper.FindParentContainer(layoutWidgets, widget);
        if (parentContainer?.Children != null && parentContainer.Children.Remove(widget))
        {
            if (selectedWidget == widget)
            {
                selectedWidget = null;
            }
            StateHasChanged();
        }
    }

    // Resize åŠŸèƒ½çŠ¶æ€
    private DraggableWidget? resizingWidget = null;
    private DotNetObjectReference<FormDesigner>? resizeDotNetRef = null;

    private async Task OnResizeStart(Microsoft.AspNetCore.Components.Web.MouseEventArgs e, DraggableWidget widget)
    {
        resizingWidget = widget;
        
        // åˆ›å»º .NET å¯¹è±¡å¼•ç”¨
        resizeDotNetRef?.Dispose(); // æ¸…ç†æ—§çš„å¼•ç”¨
        resizeDotNetRef = DotNetObjectReference.Create(this);

        // åˆå§‹åŒ– JavaScript resize å¤„ç†å™¨
        await JS.InvokeVoidAsync("FormDesignerResize.start", resizeDotNetRef, widget.Id, e.ClientX);
    }

    [JSInvokable]
    public void OnResizeMove(string widgetId, int newWidth)
    {
        if (resizingWidget == null || resizingWidget.Id != widgetId) return;

        // æ›´æ–°ç»„ä»¶å®½åº¦
        if (resizingWidget is IFlowSized flowWidget)
        {
            flowWidget.Width = Math.Max(50, newWidth); // æœ€å°å®½åº¦50px
            flowWidget.WidthUnit = "px"; // resizeæ—¶ä½¿ç”¨px
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void OnResizeEnd()
    {
        resizingWidget = null;
        
        // æ¸…ç† DotNetObjectReferenceï¼ˆä½†ä¸ç«‹å³disposeï¼Œç­‰å¾…ä¸‹æ¬¡resizeæˆ–ç»„ä»¶é”€æ¯æ—¶ï¼‰
        // resizeDotNetRef?.Dispose();
        // resizeDotNetRef = null;
    }

    public void Dispose()
    {
        I18n.OnChanged -= HandleI18nChanged;
        resizeDotNetRef?.Dispose();
    }

    private void HandleI18nChanged()
    {
        // è¯­è¨€åˆ‡æ¢æ—¶æ›´æ–°é»˜è®¤æ¨¡æ¿åç§°
        if (templateName == I18n.T("LBL_NEW_TEMPLATE") || string.IsNullOrWhiteSpace(TemplateId))
        {
            templateName = I18n.T("LBL_NEW_TEMPLATE");
        }
        try { InvokeAsync(StateHasChanged); } catch { }
    }
}

