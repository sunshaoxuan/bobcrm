@page "/templates/edit"
@page "/template-designer"
@rendermode RenderMode.InteractiveServer
@implements IDisposable

@using BobCrm.App.Models
@using BobCrm.App.Models.Widgets

@inject BobCrm.App.Services.AuthService Auth
@inject BobCrm.App.Services.I18nService I18n
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject BobCrm.App.Services.FieldService FieldService

<PageTitle>@I18n.T("MENU_TEMPLATES") - @I18n.T("MODE_DESIGN")</PageTitle>

<AuthChecker>
@if (loading)
{
    <div class="text-muted">@I18n.T("LBL_LOADING")...</div>
}
else if (!string.IsNullOrEmpty(error))
{
    <Alert Message="@error" Type="AlertType.Error" ShowIcon="true" />
    <div style="margin-top:16px"><Button OnClick="GoBack">@I18n.T("BTN_BACK")</Button></div>
}
else
{
    <div style="position:fixed; inset:0; background:#fff; z-index:1000; display:flex; flex-direction:column">
        <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 20px; border-bottom:1px solid var(--border); background:var(--card-bg)">
            <div style="display:flex; align-items:center; gap:16px">
                <h2 style="margin:0; font-size:18px">@I18n.T("MODE_DESIGN") - @I18n.T("MENU_TEMPLATES")</h2>
            </div>
            <div style="display:flex; gap:8px; align-items:center">
                @if (isAdmin)
                {
                    <div style="display:flex; gap:4px; background:#f5f5f5; padding:4px; border-radius:4px; border:1px solid #d9d9d9">
                        <Button Type="@(saveAsDefault ? ButtonType.Default : ButtonType.Primary)" Size="@ButtonSize.Small" 
                                OnClick="@(() => { saveAsDefault = false; StateHasChanged(); })">
                            @I18n.T("BTN_SAVE_AS_MINE")
                        </Button>
                        <Button Type="@(saveAsDefault ? ButtonType.Primary : ButtonType.Default)" Size="@ButtonSize.Small"
                                OnClick="@(() => { saveAsDefault = true; StateHasChanged(); })">
                            @I18n.T("BTN_SAVE_AS_DEFAULT")
                        </Button>
                    </div>
                }
                <Button Type="@ButtonType.Primary" OnClick="SaveLayout" Icon="@IconType.Outline.Save">@I18n.T("BTN_SAVE_LAYOUT")</Button>
                <Button OnClick="GoBack" Icon="@IconType.Outline.Close">@I18n.T("BTN_EXIT_DESIGN")</Button>
            </div>
        </div>
        <div style="display:flex; flex:1; min-height:0">
            <div style="width:240px; border-right:1px solid var(--border); overflow:auto; background:#fafafa">
                <div style="padding:16px">
                    <h3 style="margin:0 0 12px 0; font-size:14px; font-weight:600">@I18n.T("LBL_COMPONENTS")</h3>
                    <div style="display:flex; flex-direction:column; gap:8px">
                        <div style="font-size:12px; color:#666; margin:4px 0">@I18n.T("LBL_BASIC_COMPONENTS")</div>
                        @foreach (var comp in basicComponents)
                        {
                            <div class="component-item" draggable="true" data-drag-type="component" data-drag-data="@comp.Type"
                                 @ondragstart="@((e) => OnDragStart(e, comp))" @ondragstart:preventDefault="false" @ondragend="OnDragEnd"
                                 style="padding:8px 12px; background:#fff; border:1px solid #d9d9d9; border-radius:4px; cursor:move; display:flex; align-items:center; gap:8px">
                                <Icon Type="@comp.Icon" />
                                <span style="font-size:13px">@I18n.T(comp.Label)</span>
                            </div>
                        }
                        <div style="font-size:12px; color:#666; margin:8px 0 4px">@I18n.T("LBL_LAYOUT_COMPONENTS")</div>
                        @foreach (var comp in layoutComponents)
                        {
                            <div class="component-item" draggable="true" data-drag-type="component" data-drag-data="@comp.Type"
                                 @ondragstart="@((e) => OnDragStart(e, comp))" @ondragstart:preventDefault="false" @ondragend="OnDragEnd"
                                 style="padding:8px 12px; background:#fff; border:1px solid #d9d9d9; border-radius:4px; cursor:move; display:flex; align-items:center; gap:8px">
                                <Icon Type="@comp.Icon" />
                                <span style="font-size:13px">@I18n.T(comp.Label)</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div style="flex:1; overflow:auto; background:#f5f5f5; padding:24px">
                <div class="layout-widgets-container" @ref="canvasRef"
                     @ondrop="OnDrop" @ondrop:preventDefault @ondrop:stopPropagation 
                     @ondragover="OnDragOver" @ondragover:preventDefault
                     style="display:flex; flex-wrap:wrap; align-content:flex-start; align-items:flex-start; background:#fff; border-radius:8px; padding:12px">
                    @foreach (var widget in layoutWidgets)
                    {
                        @* 换行占位符：NewLine=true 时强制控件从新行开始 *@
                        @if (widget.NewLine)
                        {
                            <div class="flow-break" style="flex-basis:100%; width:100%; height:0; padding:0; margin:0;"></div>
                        }
                        
                        <div class="layout-widget @(selectedWidget == widget ? "selected" : "")"
                             draggable="@(resizingIds.Contains(widget.Id) ? "false" : "true")"
                             data-drag-type="widget" data-drag-data="@widget.Id"
                             data-widget-id="@widget.Id"
                             @ondragstart="@((e) => OnWidgetDragStart(e, widget))" 
                             @ondragstart:preventDefault="@(resizingIds.Contains(widget.Id))" 
                             @ondragend="OnDragEnd"
                             @onclick="@(() => SelectWidget(widget))"
                             style="@GetFlowWidgetStyle(widget)">
                            @if (selectedWidget == widget)
                            {
                                <div class="resize-handle"
                                     draggable="false"
                                     @onmousedown="@((e) => OnResizeStart(e, widget))"
                                     @onmousedown:stopPropagation
                                     @onmousedown:preventDefault
                                     @ondragstart:preventDefault="true"
                                     style="position:absolute; right:-2px; top:50%; transform:translateY(-50%); width:4px; height:48px; cursor:ew-resize; background:#1890ff; border-radius:2px; z-index:10; box-shadow:0 2px 8px rgba(24,144,255,0.6); opacity:0.8;">
                                </div>
                            }
                            <div class="widget-content" style="width:100%;">
                                @if (widget.Type == "frame" || widget.Type == "section")
                                {
                                    @* 容器类型：显示为可容纳子控件的框 *@
                                    <div style="border:2px dashed #1890ff; border-radius:4px; background:@GetWidgetBackgroundColor(widget); padding:12px; pointer-events:auto; @(widget.Children == null || !widget.Children.Any() ? "min-height:80px;" : "")">
                                        <div style="@GetWidgetTextStyle(widget) margin-bottom:8px; font-weight:600; color:#1890ff; pointer-events:none;">@widget.Label</div>
                                        @* 容器内部拖放区域 *@
                                        <div class="frame-drop-zone" 
                                             data-container-id="@widget.Id"
                                             @ondrop="@((e) => OnDropToContainer(e, widget))" 
                                             @ondrop:preventDefault 
                                             @ondrop:stopPropagation
                                             @ondragover:preventDefault
                                             style="display:flex; flex-wrap:wrap; gap:8px; align-content:flex-start; align-items:flex-start; position:relative; @(widget.Children == null || !widget.Children.Any() ? "min-height:48px;" : "")">
                                            @if (widget.Children != null && widget.Children.Any())
                                            {
                                                @foreach (var child in widget.Children)
                                                {
                                                    @* 换行占位符：NewLine=true 时强制子控件从新行开始 *@
                                                    @if (child.NewLine)
                                                    {
                                                        <div class="flow-break" style="flex-basis:100%; width:100%; height:0; padding:0; margin:0;"></div>
                                                    }
                                                    @* 递归渲染子控件（支持嵌套容器） *@
                                                    <div class="container-child-widget @(selectedWidget == child ? "selected" : "")"
                                                         draggable="@(resizingIds.Contains(child.Id) ? "false" : "true")"
                                                         data-drag-type="widget" data-drag-data="@child.Id"
                                                         data-widget-id="@child.Id"
                                                         @ondragstart="@((e) => OnWidgetDragStart(e, child))" @ondragstart:stopPropagation
                                                         @ondragstart:preventDefault="@(resizingIds.Contains(child.Id))"
                                                         @ondragend="OnDragEnd"
                                                         @onclick="@(() => SelectWidget(child))"
                                                         @onclick:stopPropagation
                                                         style="@GetContainerChildStyle(child)">
                                                        @if (selectedWidget == child)
                                                        {
                                                            <div class="resize-handle"
                                                                 draggable="false"
                                                                 @onmousedown="@((e) => OnResizeStart(e, child))"
                                                                 @onmousedown:stopPropagation
                                                                 @onmousedown:preventDefault
                                                                 @ondragstart:preventDefault="true"
                                                                 style="position:absolute; right:-2px; top:50%; transform:translateY(-50%); width:4px; height:48px; cursor:ew-resize; background:#1890ff; border-radius:2px; z-index:10; box-shadow:0 2px 8px rgba(24,144,255,0.6); opacity:0.8;">
                                                            </div>
                                                        }
                                                        @RenderWidgetContent(child)
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div style="text-align:center; color:#999; font-size:12px; padding:20px; width:100%; pointer-events:none;">@I18n.T("LBL_DRAG_COMPONENT_HERE")</div>
                                            }
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    @* 普通控件 *@
                                    <div style="padding:8px; border:1px solid #d9d9d9; border-radius:4px; background:@GetWidgetBackgroundColor(widget); width:100%; pointer-events:none;">
                                        <div style="@GetWidgetTextStyle(widget) margin-bottom:4px">@widget.Label</div>
                                    <div style="height:32px; background:#fff; border:1px solid #e0e0e0; border-radius:2px"></div>
                                </div>
                                }
                            </div>
                        </div>
                    }
                    @if (!layoutWidgets.Any())
                    {
                        <div style="width:100%; text-align:center; padding:60px 20px; color:#999">
                            <Icon Type="@IconType.Outline.Inbox" Style="font-size:48px; margin-bottom:12px" />
                            <div>@I18n.T("LBL_DRAG_COMPONENT_HERE")</div>
                        </div>
                    }
                </div>
            </div>
            <div style="width:300px; border-left:1px solid var(--border); overflow:auto; background:#fafafa">
                <div style="padding:16px">
                    <h3 style="margin:0 0 16px 0; font-size:14px; font-weight:600">@I18n.T("LBL_PROPERTIES")</h3>
                    @if (selectedWidget != null)
                    {
                        <div style="margin-bottom:16px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_COMPONENT_TYPE")</label>
                            <Input Value="@selectedWidget.Type" Disabled />
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_LABEL")</label>
                            <Input @bind-Value="selectedWidget.Label" @bind-Value:after="UpdateWidget" />
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_WIDTH")</label>
                            <InputGroup Compact>
                                <AntDesign.InputNumber TValue="int" @bind-Value="selectedWidget.Width" Min="1" Max="100" Style="width:70%" @bind-Value:after="UpdateWidget" />
                                <Select TItemValue="string" TItem="string" 
                                       Value="@selectedWidget.WidthUnit" 
                                       Style="width:30%" 
                                       OnSelectedItemChanged="@(value => { selectedWidget.WidthUnit = value; UpdateWidget(); })">
                                    <SelectOptions>
                                        <SelectOption TItemValue="string" TItem="string" Value="@("%")" Label="%" />
                                        <SelectOption TItemValue="string" TItem="string" Value="@("px")" Label="px" />
                                    </SelectOptions>
                                </Select>
                            </InputGroup>
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_HEIGHT")</label>
                            <InputGroup Compact>
                                <AntDesign.InputNumber TValue="int" @bind-Value="selectedWidget.Height" Min="20" Max="500" Style="width:70%" @bind-Value:after="UpdateWidget" />
                                <Select TItemValue="string" TItem="string" 
                                       Value="@selectedWidget.HeightUnit" 
                                       Style="width:30%"
                                       OnSelectedItemChanged="@(value => { selectedWidget.HeightUnit = value; UpdateWidget(); })">
                                    <SelectOptions>
                                        <SelectOption TItemValue="string" TItem="string" Value="@("px")" Label="px" />
                                        <SelectOption TItemValue="string" TItem="string" Value="@("auto")" Label="auto" />
                                    </SelectOptions>
                                </Select>
                            </InputGroup>
                        </div>
                        <div style="margin-bottom:16px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_DATA_SOURCE")</label>
                            <Select TItemValue="string" TItem="string" @bind-Value="selectedWidget.DataField" AllowClear Style="width:100%" OnSelectedItemChanged="@(item => UpdateWidget())">
                                @if (fieldDefs != null)
                                {
                                    @foreach (var f in fieldDefs)
                                    {
                                        <SelectOption Value="@f.key" Label="@f.label" />
                                    }
                                }
                            </Select>
                        </div>
                        <Divider Style="margin:12px 0" />
                        @if (selectedWidget is TextboxWidget)
                        {
                            <div style="margin-bottom:16px">
                                <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_DEFAULT_VALUE")</label>
                                <Input @bind-Value="SelectedWidgetDefaultValue" />
                            </div>
                            <div style="margin-bottom:16px">
                                <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_PLACEHOLDER")</label>
                                <Input @bind-Value="SelectedWidgetPlaceholder" />
                            </div>
                            <div style="margin-bottom:16px">
                                <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_MAX_LENGTH")</label>
                                <AntDesign.InputNumber TValue="int?" @bind-Value="SelectedWidgetMaxLength" Min="1" Max="10000" />
                            </div>
                            <Divider Style="margin:12px 0" />
                            <div style="margin-bottom:16px; display:flex; justify-content:space-between; align-items:center">
                                <label style="font-size:12px; color:#666">@I18n.T("LBL_REQUIRED")</label>
                                <Switch @bind-Value="SelectedWidgetRequired" />
                            </div>
                            <div style="margin-bottom:16px; display:flex; justify-content:space-between; align-items:center">
                                <label style="font-size:12px; color:#666">@I18n.T("LBL_READONLY")</label>
                                <Switch @bind-Value="SelectedWidgetReadonly" />
                            </div>
                        }
                        <div style="margin-bottom:16px; display:flex; justify-content:space-between; align-items:center">
                            <label style="font-size:12px; color:#666">@I18n.T("LBL_VISIBLE")</label>
                            <Switch @bind-Value="selectedWidget.Visible" @bind-Value:after="UpdateWidget" />
                        </div>
                        
                        <div style="margin-bottom:16px; display:flex; justify-content:space-between; align-items:center">
                            <label style="font-size:12px; color:#666">@I18n.T("LBL_NEW_LINE")</label>
                            <Switch @bind-Value="selectedWidget.NewLine" @bind-Value:after="UpdateWidget" />
                        </div>
                        
                        <Divider Style="margin:16px 0" />
                        <div style="font-weight:600; margin-bottom:12px; font-size:13px; color:#333">@I18n.T("LBL_STYLE_SETTINGS")</div>
                        
                        @* 文本样式（支持所有控件类型） *@
                        <div style="margin-bottom:16px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_FONT_FAMILY")</label>
                            <Select TItemValue="string" TItem="string" 
                                   Value="@GetStyleValue("fontFamily")" 
                                   Style="width:100%"
                                   AllowClear
                                   Placeholder="@I18n.T("PH_DEFAULT_FONT")"
                                   OnSelectedItemChanged="@(value => SetStyleValue("fontFamily", value))">
                                <SelectOptions>
                                    <SelectOption TItemValue="string" TItem="string" Value="@("Microsoft YaHei")" Label="@I18n.T("FONT_MICROSOFT_YAHEI")" />
                                    <SelectOption TItemValue="string" TItem="string" Value="@("SimHei")" Label="@I18n.T("FONT_SIMHEI")" />
                                    <SelectOption TItemValue="string" TItem="string" Value="@("SimSun")" Label="@I18n.T("FONT_SIMSUN")" />
                                    <SelectOption TItemValue="string" TItem="string" Value="@("Arial")" Label="Arial" />
                                    <SelectOption TItemValue="string" TItem="string" Value="@("monospace")" Label="@I18n.T("FONT_MONOSPACE")" />
                                </SelectOptions>
                            </Select>
                        </div>
                        
                        <div style="margin-bottom:16px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_FONT_SIZE") (px)</label>
                            <Select TItemValue="string" TItem="string" 
                                   Value="@GetStyleValue("fontSize")" 
                                   Style="width:100%"
                                   AllowClear
                                   Placeholder="@I18n.T("PH_DEFAULT")"
                                   OnSelectedItemChanged="@(value => SetStyleValue("fontSize", value))">
                                <SelectOptions>
                                    <SelectOption TItemValue="string" TItem="string" Value="@("12px")" Label="12px" />
                                    <SelectOption TItemValue="string" TItem="string" Value="@("14px")" Label="14px" />
                                    <SelectOption TItemValue="string" TItem="string" Value="@("16px")" Label="16px" />
                                    <SelectOption TItemValue="string" TItem="string" Value="@("18px")" Label="18px" />
                                    <SelectOption TItemValue="string" TItem="string" Value="@("20px")" Label="20px" />
                                    <SelectOption TItemValue="string" TItem="string" Value="@("24px")" Label="24px" />
                                </SelectOptions>
                            </Select>
                        </div>
                        
                        <div style="margin-bottom:16px">
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_FONT_COLOR")</label>
                            <Input Value="@GetStyleValue("fontColor")" 
                                  Placeholder="#333333" 
                                  OnChange="@((string val) => SetStyleValue("fontColor", val))" />
                        </div>
                        
                        @* 容器背景色（仅容器类控件） *@
                        @if (selectedWidget.Type == "frame" || selectedWidget.Type == "section")
                        {
                            <div style="margin-bottom:16px">
                                <label style="display:block; font-size:12px; color:#666; margin-bottom:4px">@I18n.T("LBL_BG_COLOR")</label>
                                <Input Value="@GetStyleValue("backgroundColor")" 
                                      Placeholder="@I18n.T("PH_TRANSPARENT")" 
                                      OnChange="@((string val) => SetStyleValue("backgroundColor", val))" />
                                <div style="margin-top:8px; display:flex; gap:4px; flex-wrap:wrap">
                                    <button type="button" @onclick="@(() => SetStyleValue("backgroundColor", "transparent"))" 
                                           style="padding:4px 8px; border:1px solid #d9d9d9; border-radius:4px; background:#fff; cursor:pointer; font-size:11px">@I18n.T("PH_TRANSPARENT")</button>
                                    <button type="button" @onclick="@(() => SetStyleValue("backgroundColor", "#f0f0f0"))" 
                                           style="padding:4px 8px; border:1px solid #d9d9d9; border-radius:4px; background:#f0f0f0; cursor:pointer; font-size:11px">@I18n.T("COLOR_LIGHT_GRAY")</button>
                                    <button type="button" @onclick="@(() => SetStyleValue("backgroundColor", "#e6f7ff"))" 
                                           style="padding:4px 8px; border:1px solid #d9d9d9; border-radius:4px; background:#e6f7ff; cursor:pointer; font-size:11px">@I18n.T("COLOR_LIGHT_BLUE")</button>
                                    <button type="button" @onclick="@(() => SetStyleValue("backgroundColor", "#fff7e6"))" 
                                           style="padding:4px 8px; border:1px solid #d9d9d9; border-radius:4px; background:#fff7e6; cursor:pointer; font-size:11px">@I18n.T("COLOR_LIGHT_YELLOW")</button>
                                </div>
                            </div>
                        }
                        
                        <Divider />
                        <Button Danger Block OnClick="DeleteSelectedWidget" Icon="@IconType.Outline.Delete">@I18n.T("BTN_DELETE")</Button>
                    }
                    else
                    {
                        <div style="text-align:center; padding:40px 20px; color:#999; border:2px dashed #d9d9d9; border-radius:4px">
                            <Icon Type="@IconType.Outline.Select" Style="font-size:36px; margin-bottom:8px" />
                            <div style="font-size:12px">@I18n.T("LBL_SELECT_COMPONENT")</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}
</AuthChecker>

@code {
    private bool loading = true;
    private string error = string.Empty;
    private ElementReference canvasRef;
    private bool isAdmin = false;
    private bool saveAsDefault = false;

    private List<DraggableWidget> layoutWidgets = new();
    private DraggableWidget? selectedWidget = null;
    private DraggableWidget? draggedWidget = null;
    private ComponentDefinition? draggedComponent = null;
    private DraggableWidget? draggedParentContainer = null;  // 拖放子控件时，记录其父容器
    private bool dropSucceeded = false;
    private List<BobCrm.App.Services.FieldService.FieldDefinitionDto>? fieldDefs;
    private HashSet<string> resizingIds = new();  // 正在调整大小的控件ID集合

    protected override void OnInitialized()
    {
        I18n.OnChanged += HandleI18nChanged;
    }
    public void Dispose() { I18n.OnChanged -= HandleI18nChanged; }
    private void HandleI18nChanged() { try { InvokeAsync(StateHasChanged); } catch { } }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        try
        {
            // 认证预检查：确保已登录，否则导航到登录页
            var isAuthenticated = await Auth.EnsureAuthenticatedAsync();
            if (!isAuthenticated)
            {
                await JS.InvokeVoidAsync("console.warn", "[TemplateDesigner] Not authenticated, redirecting to login");
                Nav.NavigateTo("/login", forceLoad: true);
                return;
            }

            await JS.InvokeVoidAsync("bobcrm.initDragDrop");
            var lang = await JS.InvokeAsync<string?>("bobcrm.getCookie", "lang") ?? "ja";
            await I18n.LoadAsync(lang);
            
            // 检查是否为管理员
            var meResp = await Auth.GetWithRefreshAsync("/api/auth/me");
            if (meResp.IsSuccessStatusCode)
            {
                var meData = await meResp.Content.ReadFromJsonAsync<System.Text.Json.JsonElement>();
                if (meData.TryGetProperty("roles", out var roles))
                {
                    foreach (var role in roles.EnumerateArray())
                    {
                        if (role.GetString()?.Equals("admin", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            isAdmin = true;
                            break;
                        }
                    }
                }
            }
            
            fieldDefs = await FieldService.GetDefinitionsAsync();
            await LoadLayoutFromServer();
            loading = false; await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        { error = ex.Message; loading = false; await InvokeAsync(StateHasChanged); }
    }

    private void GoBack() => Nav.NavigateTo("/templates");

    private async Task LoadLayoutFromServer()
    {
        try
        {
            var resp = await Auth.GetWithRefreshAsync("/api/layout/customer?scope=effective");
            if (resp.IsSuccessStatusCode)
            {
                var json = await resp.Content.ReadAsStringAsync();
                var root = System.Text.Json.JsonDocument.Parse(json).RootElement;
                if (root.TryGetProperty("mode", out var modeEl) && modeEl.GetString() == "flow" && root.TryGetProperty("items", out var items))
                {
                    layoutWidgets.Clear();
                    foreach (var prop in items.EnumerateObject().OrderBy(p => p.Value.TryGetProperty("order", out var o) ? o.GetInt32() : 0))
                    {
                        // 使用 LayoutMapper 加载基础属性（支持递归 children，自动推断具体类型）
                        var widget = LayoutMapper.FromJsonElement(prop.Value);

                        // 设置特定属性（DataField 优先使用 JSON 中的，其次用 key）
                        if (string.IsNullOrEmpty(widget.Id))
                            widget.Id = Guid.NewGuid().ToString();
                        if (string.IsNullOrEmpty(widget.DataField))
                            widget.DataField = prop.Name;
                        if (string.IsNullOrEmpty(widget.Label))
                            widget.Label = prop.Name;

                        // 调试输出：检查加载的控件信息
                        var childCount = widget.Children?.Count ?? 0;
                        await JS.InvokeVoidAsync("console.debug", 
                            $"[LoadLayout] Loaded widget: type={widget.Type}, label={widget.Label}, width={widget.Width}{widget.WidthUnit}, " +
                            $"height={widget.Height}{widget.HeightUnit}, visible={widget.Visible}, dataField={widget.DataField}, childrenCount={childCount}");

                        layoutWidgets.Add(widget);
                    }

                    await JS.InvokeVoidAsync("console.log", $"[LoadLayout] Total widgets loaded: {layoutWidgets.Count}");

                    // 自动选中第一个控件（如果还没有选中任何控件）
                    if (layoutWidgets.Any() && selectedWidget == null)
                    {
                        selectedWidget = layoutWidgets[0];
                    }
                    return;
                }
            }
            // fallback: generate from fields
            layoutWidgets.Clear();
            if (fieldDefs != null)
            {
                foreach (var f in fieldDefs)
                {
                    var widget = CreateWidgetByType("textbox", f.label);
                    widget.DataField = f.key;
                    layoutWidgets.Add(widget);
                }

                // 自动选中第一个控件
                if (layoutWidgets.Any() && selectedWidget == null)
                {
                    selectedWidget = layoutWidgets[0];
                }
            }
        }
        catch { }
    }

    private async Task SaveLayout()
    {
        try
        {
            var items = new Dictionary<string, object>();
            for (int i = 0; i < layoutWidgets.Count; i++)
            {
                var w = layoutWidgets[i];
                var key = w.DataField ?? w.Id;

                // 保存完整的尺寸和单位信息，包括 NewLine
                var itemData = new Dictionary<string, object>
                {
                    ["order"] = i,
                    ["id"] = w.Id,
                    ["w"] = (int)Math.Round(w.Width / 8.33),  // 保留用于向后兼容
                    ["Width"] = w.Width,
                    ["WidthUnit"] = w.WidthUnit ?? "%",  // 确保单位不为 null
                    ["Height"] = w.Height,
                    ["HeightUnit"] = w.HeightUnit ?? "auto",
                    ["visible"] = w.Visible,
                    ["label"] = w.Label,
                    ["type"] = w.Type,
                    ["dataField"] = w.DataField ?? w.Id,
                    ["newLine"] = w.NewLine
                };
                // 统一：newLine 始终写入（上面已写）
                
                // 特定控件属性（安全访问）
                if (w is TextboxWidget textbox)
                {
                    if (!string.IsNullOrWhiteSpace(textbox.DefaultValue))
                        itemData["defaultValue"] = textbox.DefaultValue;
                    if (!string.IsNullOrWhiteSpace(textbox.Placeholder))
                        itemData["placeholder"] = textbox.Placeholder;
                    if (textbox.Required)
                        itemData["required"] = textbox.Required;
                    if (textbox.Readonly)
                        itemData["readonly"] = textbox.Readonly;
                    if (textbox.MaxLength.HasValue)
                        itemData["maxLength"] = textbox.MaxLength.Value;
                }
                
                // 保存扩展属性（样式等）
                if (w.ExtendedProperties != null && w.ExtendedProperties.Any())
                {
                    foreach (var kvp in w.ExtendedProperties)
                    {
                        if (!string.IsNullOrWhiteSpace(kvp.Key) && kvp.Value != null)
                        {
                            itemData[kvp.Key] = kvp.Value;
                        }
                    }
                }
                
                // 递归保存子控件（容器嵌套）
                if (w.Children != null && w.Children.Any())
                {
                    itemData["children"] = SerializeChildren(w.Children);
                }

                items[key] = itemData;
            }
            var layout = new { mode = "flow", items };
            
            // 根据 saveAsDefault 决定保存作用域
            var scope = (isAdmin && saveAsDefault) ? "default" : "user";
            var url = $"/api/layout/customer?scope={scope}";
            
            var resp = await Auth.PostAsJsonWithRefreshAsync(url, layout);
            if (resp.IsSuccessStatusCode)
            {
                var msg = saveAsDefault ? I18n.T("MSG_DEFAULT_TEMPLATE_SAVED_SHORT") : I18n.T("MSG_TEMPLATE_SAVED_SHORT");
                await JS.InvokeVoidAsync("alert", msg);
                
                // 保存后重新加载，确保显示与持久化一致
                await JS.InvokeVoidAsync("console.log", "[TemplateDesigner] Reloading layout after save");
                await LoadLayoutFromServer();
                StateHasChanged();
            }
            else
            {
                await JS.InvokeVoidAsync("console.error", $"[TemplateDesigner] Save failed: {resp.StatusCode}");
                await JS.InvokeVoidAsync("alert", string.Format(I18n.T("MSG_SAVE_FAILED_STATUS"), resp.StatusCode));
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[TemplateDesigner] Save error: {ex.Message}");
            await JS.InvokeVoidAsync("alert", string.Format(I18n.T("MSG_SAVE_FAILED_ERROR"), ex.Message));
        }
    }

    private async Task OnDragStart(Microsoft.AspNetCore.Components.Web.DragEventArgs e, ComponentDefinition comp)
    { dropSucceeded = false; draggedComponent = comp; try { await JS.InvokeVoidAsync("console.log", $"[drag] start new {comp.Type}"); } catch { } }
    private async Task OnWidgetDragStart(Microsoft.AspNetCore.Components.Web.DragEventArgs e, DraggableWidget w)
    { 
        dropSucceeded = false; 
        draggedWidget = w;
        
        // 查找父容器（如果在容器内）
        draggedParentContainer = FindParentContainer(w);
        
        try { await JS.InvokeVoidAsync("console.log", $"[drag] start widget {w.Id}, parent={draggedParentContainer?.Id ?? "root"}"); } catch { } 
    }
    private void OnDragOver(Microsoft.AspNetCore.Components.Web.DragEventArgs e) { }
    private async Task OnDrop(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        try
        {
            await JS.InvokeVoidAsync("console.log", $"[OnDrop Root] Component={draggedComponent?.Type}, Widget={draggedWidget?.Id}, Parent={draggedParentContainer?.Id}");
            
            // 情况1：从工具栏拖放新组件
        if (draggedComponent != null)
        {
                var nw = CreateWidgetByType(draggedComponent.Type, I18n.T(draggedComponent.Label));
                
            try
            {
                var idx = await JS.InvokeAsync<int>("bobcrm.getInsertIndexStrict", ".layout-widgets-container", e.ClientX, e.ClientY);
                    if (idx >= 0 && idx <= layoutWidgets.Count) 
                        layoutWidgets.Insert(idx, nw); 
                    else 
                        layoutWidgets.Add(nw);
                    await JS.InvokeVoidAsync("console.log", $"[OnDrop Root] New component inserted at index {idx}");
            }
            catch { layoutWidgets.Add(nw); }
                
                selectedWidget = nw; 
                dropSucceeded = true; 
                draggedComponent = null; 
                StateHasChanged(); 
                return;
            }
            
            // 情况2 & 3：拖放现有控件（可能来自顶层或容器内）
        if (draggedWidget != null)
        {
                var w = draggedWidget;
                var originalIndex = layoutWidgets.IndexOf(w);
                
                // 从原位置移除（顶层或容器内）
                if (draggedParentContainer != null)
                {
                    // 来自容器内 → 拖回根画布
                    await JS.InvokeVoidAsync("console.log", $"[OnDrop Root] Moving from container {draggedParentContainer.Id} to root");
                    RemoveWidgetFromContainer(draggedParentContainer, w);
                }
                else if (originalIndex >= 0)
                {
                    // 顶层移动
                    await JS.InvokeVoidAsync("console.log", $"[OnDrop Root] Moving within root from index {originalIndex}");
                    layoutWidgets.RemoveAt(originalIndex);
                }
                else
                {
                    // 保险：使用递归移除
                    await JS.InvokeVoidAsync("console.warn", $"[OnDrop Root] Widget not found in top level, using recursive remove");
                    RemoveWidgetFromTree(w);
                }
                
                // 添加到顶层画布的新位置
                try
                {
                    var idx = await JS.InvokeAsync<int>("bobcrm.getInsertIndexStrict", ".layout-widgets-container", e.ClientX, e.ClientY);
                    
                    // 如果是顶层内移动，且插入点在原位置之后，需要减1（因为已经移除了）
                    if (draggedParentContainer == null && originalIndex >= 0 && idx > originalIndex)
                    {
                        idx--;
                    }
                    
                    if (idx >= 0 && idx <= layoutWidgets.Count) 
                    {
                        layoutWidgets.Insert(idx, w);
                        await JS.InvokeVoidAsync("console.log", $"[OnDrop Root] Inserted at index {idx}");
                    }
                    else 
                    {
                        layoutWidgets.Add(w);
                        await JS.InvokeVoidAsync("console.log", $"[OnDrop Root] Added to end");
                    }
                }
                catch (Exception ex)
                { 
                    layoutWidgets.Add(w); 
                    await JS.InvokeVoidAsync("console.error", $"[OnDrop Root] getInsertIndexStrict failed: {ex.Message}");
                }
                
                    selectedWidget = w;
                dropSucceeded = true; 
                draggedWidget = null;
                draggedParentContainer = null;
                StateHasChanged();
                }
            }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[OnDrop Root] Error: {ex.Message}");
        }
    }
    private async Task OnDragEnd(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    { 
        try { await Task.Delay(50); } catch { } 
        if (!dropSucceeded) 
        { 
            draggedComponent = null; 
            draggedWidget = null; 
            draggedParentContainer = null;
        } 
        dropSucceeded = false; 
    }

    private void SelectWidget(DraggableWidget w) { selectedWidget = w; StateHasChanged(); }
    private void UpdateWidget() { StateHasChanged(); }
    private void DeleteSelectedWidget() 
    { 
        if (selectedWidget != null) 
        { 
            // 递归删除（支持删除容器内的控件）
            RemoveWidgetFromTree(selectedWidget); 
            selectedWidget = null; 
            StateHasChanged(); 
        } 
    }

    /// <summary>
    /// 开始调整控件大小 - 使用统一的 DragManager
    /// </summary>
    private async Task OnResizeStart(Microsoft.AspNetCore.Components.Web.MouseEventArgs e, DraggableWidget widget)
    {
        try
        {
            // 0. 标记为正在调整大小，禁止原生拖拽
            resizingIds.Add(widget.Id);
            await InvokeAsync(StateHasChanged);
            
            // 1. 让控件保存初始状态
            widget.OnResizeStart();

            // 2. 获取容器宽度（使用正确的容器引用：layout-widgets-container）
            var canvasWidth = await JS.InvokeAsync<double>("bobcrm.getElementWidth", canvasRef);

            await JS.InvokeVoidAsync("console.log", $"[TemplateDesigner] OnResizeStart: widget={widget.Id}, canvasWidth={canvasWidth}");

            // 如果获取失败，尝试备用方法
            if (canvasWidth <= 0)
            {
                canvasWidth = await JS.InvokeAsync<double>("bobcrm.getElementWidthBySelector", ".layout-widgets-container");
                await JS.InvokeVoidAsync("console.warn", $"[TemplateDesigner] Fallback selector width: {canvasWidth}");
            }

            // 最后的保底值
            if (canvasWidth <= 0)
            {
                canvasWidth = 1200;
                await JS.InvokeVoidAsync("console.error", "[TemplateDesigner] Container width is 0, using fallback 1200px");
            }

            // 3. 存储容器宽度供后续使用
            widgetContainerWidths[widget.Id] = canvasWidth;

            // 4. 启动通用拖拽管理器
            var dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("dragManager.registerCallback", dotNetRef);
            await JS.InvokeVoidAsync("dragManager.startResize", widget.Id, e.ClientX, e.ClientY, "horizontal");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[TemplateDesigner] Resize start failed: {ex.Message}");
        }
    }

    /// <summary>
    /// 响应拖拽管理器的resize事件 - 使用 IResizable 接口
    /// </summary>
    [JSInvokable]
    public async Task OnResizeDrag(string widgetId, string direction, int deltaX, int deltaY, int totalDeltaX, int totalDeltaY)
    {
        var widget = FindWidgetRecursive(widgetId);
        if (widget == null)
        {
            await JS.InvokeVoidAsync("console.error", $"[TemplateDesigner OnResizeDrag] Widget not found: {widgetId}");
            return;
        }

        var containerWidth = widgetContainerWidths.GetValueOrDefault(widgetId, 1200);

        // 让控件自己响应调整大小事件（通过 IResizable 接口）
        widget.OnResize(direction, deltaX, deltaY, totalDeltaX, totalDeltaY, containerWidth);

        await InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// 调整大小结束事件
    /// </summary>
    [JSInvokable]
    public async Task OnResizeEnd(string widgetId, string direction, int totalDeltaX, int totalDeltaY)
    {
        var widget = FindWidgetRecursive(widgetId);
        if (widget != null)
        {
            widget.OnResizeEnd();
            widgetContainerWidths.Remove(widgetId);
            resizingIds.Remove(widgetId);  // 恢复可拖拽状态
            await InvokeAsync(StateHasChanged);
        }
    }

    // 存储控件的容器宽度
    private Dictionary<string, double> widgetContainerWidths = new();
    
    // ===== 样式辅助方法 =====
    
    /// <summary>
    /// 从 ExtendedProperties 获取样式值
    /// </summary>
    private string? GetStyleValue(string key)
    {
        if (selectedWidget == null || selectedWidget.ExtendedProperties == null)
            return null;
        
        return selectedWidget.ExtendedProperties.TryGetValue(key, out var value) 
            ? value?.ToString() 
            : null;
    }
    
    /// <summary>
    /// 设置样式值到 ExtendedProperties
    /// </summary>
    private void SetStyleValue(string key, string? value)
    {
        if (selectedWidget == null)
            return;
        
        if (selectedWidget.ExtendedProperties == null)
            selectedWidget.ExtendedProperties = new Dictionary<string, object>();
        
        if (string.IsNullOrWhiteSpace(value))
            selectedWidget.ExtendedProperties.Remove(key);
        else
            selectedWidget.ExtendedProperties[key] = value;
        
        UpdateWidget();
    }
    
    /// <summary>
    /// 获取控件文本样式（从 ExtendedProperties）
    /// </summary>
    private string GetWidgetTextStyle(DraggableWidget widget)
    {
        if (widget?.ExtendedProperties == null)
            return "font-size:12px; color:#666;";
        
        var parts = new List<string>();
        
        if (widget.ExtendedProperties.TryGetValue("fontFamily", out var ff) && ff != null)
            parts.Add($"font-family:{ff}");
        if (widget.ExtendedProperties.TryGetValue("fontSize", out var fs) && fs != null)
            parts.Add($"font-size:{fs}");
        else
            parts.Add("font-size:12px");
        
        if (widget.ExtendedProperties.TryGetValue("fontColor", out var fc) && fc != null)
            parts.Add($"color:{fc}");
        else
            parts.Add("color:#666");
        
        return string.Join("; ", parts) + ";";
    }
    
    /// <summary>
    /// 获取控件背景颜色（从 ExtendedProperties）
    /// </summary>
    private string GetWidgetBackgroundColor(DraggableWidget widget)
    {
        if (widget?.ExtendedProperties == null)
            return "#fafafa";
        
        if (widget.ExtendedProperties.TryGetValue("backgroundColor", out var bg) && bg != null)
            return bg.ToString() ?? "#fafafa";
        
        return "#fafafa";
    }

    private string GetFlowWidgetStyle(DraggableWidget w)
    {
        var basis = w.WidthUnit == "%" ? $"calc({w.Width}% - 6px)" : $"{w.Width}px";
        
        // 高度策略：
        // - 显式 px：输出 height
        // - auto 且叶子控件：给小的 min-height 确保可见性（不拉伸）
        // - auto 且容器：不设高度（由子控件决定）
        var isContainer = w.Type == "frame" || w.Type == "section";
        // 使用 min-height 避免裁切内容；容器在 auto 时不强制高度
        var heightStyle = w.HeightUnit == "px"
            ? $"min-height:{Math.Max(w.Height, 32)}px;"
            : (isContainer ? "" : "min-height:32px;");
        
        // 选中态边框和 z-index
        var border = selectedWidget == w ? "2px solid #1890ff" : "1px solid #e0e0e0";
        var zIndex = selectedWidget == w ? "z-index:100" : "z-index:1";
        
        return $"flex:0 0 {basis}; max-width:{basis}; {heightStyle} background:#fff; border-radius:4px; border:{border}; box-shadow:0 1px 3px rgba(0,0,0,0.1); user-select:none; position:relative; margin:4px; {zIndex} box-sizing:border-box; display:flex; flex-direction:column;".Replace("  ", " ");
    }

    /// <summary>
    /// 容器内子控件的样式
    /// </summary>
    private string GetContainerChildStyle(DraggableWidget w)
    {
        var basis = w.WidthUnit == "%" ? $"calc({w.Width}% - 8px)" : $"{w.Width}px";
        
        // 设计期统一叶子控件的可视最小高度，忽略数据中的 px 高度，避免“原生字段”和“新加控件”显示不一致
        var heightStyle = "min-height:32px;";
        
        var border = selectedWidget == w ? "2px solid #ff4d4f" : "1px solid #d0d0d0";
        var zIndex = selectedWidget == w ? "z-index:100" : "z-index:1";
        
        return $"flex:0 0 {basis}; max-width:{basis}; {heightStyle} background:#fff; border-radius:4px; border:{border}; box-shadow:0 1px 2px rgba(0,0,0,0.08); user-select:none; position:relative; {zIndex} box-sizing:border-box; display:flex; flex-direction:column;".Replace("  ", " ");
    }

    /// <summary>
    /// 递归渲染控件内容（支持嵌套容器）
    /// </summary>
    private RenderFragment RenderWidgetContent(DraggableWidget widget) => __builder =>
    {
        if (widget.Type == "frame" || widget.Type == "section")
        {
            // 嵌套容器：递归渲染
            <div style="border:1px dashed #52c41a; border-radius:4px; background:@GetWidgetBackgroundColor(widget); padding:8px; pointer-events:auto; @(widget.Children == null || !widget.Children.Any() ? "min-height:80px;" : "")">
                <div style="@GetWidgetTextStyle(widget) margin-bottom:4px; font-weight:600; font-size:11px; color:#52c41a; pointer-events:none;">@widget.Label (嵌套)</div>
                <div class="frame-drop-zone"
                     data-container-id="@widget.Id"
                     @ondrop="@((e) => OnDropToContainer(e, widget))"
                     @ondrop:preventDefault
                     @ondrop:stopPropagation
                     @ondragover:preventDefault
                     style="display:flex; flex-wrap:wrap; align-content:flex-start; align-items:flex-start; gap:4px; @(widget.Children == null || !widget.Children.Any() ? "min-height:48px;" : "")">
                    @if (widget.Children != null && widget.Children.Any())
                    {
                        @foreach (var child in widget.Children)
                        {
                            @* 换行占位符（嵌套层）：NewLine=true 时占一整行 *@
                            @if (child.NewLine)
                            {
                                <div class="flow-break" style="flex-basis:100%; width:100%; height:0; padding:0; margin:0;"></div>
                            }
                            <div class="container-child-widget @(selectedWidget == child ? "selected" : "")" 
                                 draggable="true" data-drag-type="widget" data-drag-data="@child.Id"
                                 @ondragstart="@((e) => OnWidgetDragStart(e, child))" @ondragstart:stopPropagation
                                 @ondragend="OnDragEnd"
                                 @onclick="@(() => SelectWidget(child))"
                                 @onclick:stopPropagation
                                 style="@GetNestedChildStyle(child)">
                                @* 递归渲染嵌套子控件的完整内容 *@
                                @RenderWidgetContent(child)
                            </div>
                        }
                    }
                    else
                    {
                        <div style="text-align:center; color:#999; font-size:10px; padding:10px; width:100%; pointer-events:none;">可拖放</div>
                    }
                </div>
            </div>
        }
        else if (widget is TextboxWidget)
        {
            // 文本框
            <div style="padding:6px; background:@GetWidgetBackgroundColor(widget); pointer-events:none;">
                <div style="@GetWidgetTextStyle(widget) font-size:11px; margin-bottom:2px;">@widget.Label</div>
                <div style="height:32px; background:#fff; border:1px solid #e0e0e0; border-radius:2px;"></div>
            </div>
        }
        else if (widget is LabelWidget)
        {
            // 标签
            <div style="padding:6px; background:@GetWidgetBackgroundColor(widget); pointer-events:none;">
                <div style="@GetWidgetTextStyle(widget) font-size:11px; font-weight:500;">@widget.Label</div>
            </div>
        }
        else if (widget is CalendarWidget)
        {
            // 日历
            <div style="padding:6px; background:@GetWidgetBackgroundColor(widget); pointer-events:none;">
                <div style="@GetWidgetTextStyle(widget) font-size:11px; margin-bottom:2px;">@widget.Label</div>
                <div style="height:32px; background:#fff; border:1px solid #e0e0e0; border-radius:2px; display:flex; align-items:center; padding:0 4px;">
                    <span style="font-size:10px; color:#999;">📅</span>
                </div>
            </div>
        }
        else if (widget is ListboxWidget)
        {
            // 列表框
            <div style="padding:6px; background:@GetWidgetBackgroundColor(widget); pointer-events:none;">
                <div style="@GetWidgetTextStyle(widget) font-size:11px; margin-bottom:2px;">@widget.Label</div>
                <div style="height:32px; background:#fff; border:1px solid #e0e0e0; border-radius:2px; display:flex; align-items:center; padding:0 4px;">
                    <span style="font-size:10px; color:#999;">▼</span>
                </div>
            </div>
        }
        else
        {
            // 未识别类型：也按“复合控件”方式预览，保证高度与交互一致
            <div style="padding:6px; background:@GetWidgetBackgroundColor(widget); pointer-events:none;">
                <div style="@GetWidgetTextStyle(widget) font-size:11px; margin-bottom:2px;">@widget.Label</div>
                <div style="height:32px; background:#fff; border:1px solid #e0e0e0; border-radius:2px;"></div>
            </div>
        }
    };
    
    /// <summary>
    /// 嵌套子控件的样式
    /// </summary>
    private string GetNestedChildStyle(DraggableWidget w)
    {
        var basis = w.WidthUnit == "%" ? $"calc({w.Width}% - 4px)" : $"{w.Width}px";
        
        // 设计期统一叶子控件的可视最小高度
        var heightStyle = "min-height:32px;";
        
        var border = selectedWidget == w ? "2px solid #ff4d4f" : "1px solid #d0d0d0";
        var zIndex = selectedWidget == w ? "z-index:100" : "z-index:1";
        
        return $"flex:0 0 {basis}; max-width:{basis}; {heightStyle} background:#fff; border-radius:2px; border:{border}; box-shadow:0 1px 2px rgba(0,0,0,0.05); user-select:none; position:relative; {zIndex} box-sizing:border-box; cursor:move; display:flex; flex-direction:column;".Replace("  ", " ");
    }

    /// <summary>
    /// 容器内拖放处理
    /// </summary>
    private async Task OnDropToContainer(Microsoft.AspNetCore.Components.Web.DragEventArgs e, DraggableWidget container)
    {
        try
        {
            await JS.InvokeVoidAsync("console.log", $"[OnDropToContainer] Dropping into container {container.Id}");
            
            // 确保容器有 Children 列表
            if (container.Children == null)
            {
                container.Children = new List<DraggableWidget>();
            }

            if (draggedComponent != null)
            {
                // 从工具栏拖放新控件到容器
                var nw = CreateWidgetByType(draggedComponent.Type, I18n.T(draggedComponent.Label));
                // 保持与容器外相同的默认宽度（不再强制缩窄）
                // 计算插入位置（与根画布一致的严格模式）
                var sel = $".frame-drop-zone[data-container-id='" + container.Id + "']";
                int insertIndex = -1;
                try { insertIndex = await JS.InvokeAsync<int>("bobcrm.getInsertIndexStrict", sel, e.ClientX, e.ClientY); } catch { insertIndex = -1; }
                if (insertIndex < 0 || insertIndex > container.Children.Count) insertIndex = container.Children.Count;
                container.Children.Insert(insertIndex, nw);
                selectedWidget = nw;
                dropSucceeded = true;
                draggedComponent = null;
                
                await JS.InvokeVoidAsync("console.log", $"[OnDropToContainer] Added new widget {nw.Id} to container at {insertIndex}");
            }
            else if (draggedWidget != null)
            {
                // 如果拖动的是容器（frame/section），不允许嵌套到其他容器内。
                // 改为：在根画布内重排（放到目标容器前/后，取决于指针位置）。
                if (draggedWidget.Type == "frame" || draggedWidget.Type == "section")
                {
                    await JS.InvokeVoidAsync("console.log", $"[OnDropToContainer] Container drag detected. Redirect to root reorder.");
                    var containerWidget = draggedWidget;
                    var originalIndex = layoutWidgets.IndexOf(containerWidget);
                    if (draggedParentContainer != null)
                    {
                        RemoveWidgetFromContainer(draggedParentContainer, containerWidget);
                    }
                    else if (originalIndex >= 0)
                    {
                        layoutWidgets.RemoveAt(originalIndex);
                    }

                    int idx = -1;
                    try { idx = await JS.InvokeAsync<int>("bobcrm.getInsertIndexStrict", ".layout-widgets-container", e.ClientX, e.ClientY); } catch { idx = -1; }
                    if (draggedParentContainer == null && originalIndex >= 0 && idx > originalIndex) idx--;
                    if (idx < 0 || idx > layoutWidgets.Count) idx = layoutWidgets.Count;
                    layoutWidgets.Insert(idx, containerWidget);

                    selectedWidget = containerWidget;
                    dropSucceeded = true;
                    draggedWidget = null;
                    draggedParentContainer = null;
                    StateHasChanged();
                    return;
                }

                // 移动非容器控件到容器
                var movedWidget = draggedWidget;

                // 是否在同一父容器内移动
                var sameParent = draggedParentContainer != null && draggedParentContainer == container;
                var originalIndexInContainer = sameParent && container.Children != null ? container.Children.IndexOf(movedWidget) : -1;

                // 注意：为了让插入索引基于当前DOM（仍包含原位置）计算，先算索引再从数据结构中移除
                var sel = $".frame-drop-zone[data-container-id='" + container.Id + "']";
                int insertIndex = -1;
                try { insertIndex = await JS.InvokeAsync<int>("bobcrm.getInsertIndexStrict", sel, e.ClientX, e.ClientY); } catch { insertIndex = -1; }

                // 现在从原位置移除
                if (draggedParentContainer != null)
                {
                    await JS.InvokeVoidAsync("console.log", $"[OnDropToContainer] Moving from parent {draggedParentContainer.Id} to container {container.Id}");
                    RemoveWidgetFromContainer(draggedParentContainer, movedWidget);
                }
                else
                {
                    await JS.InvokeVoidAsync("console.log", $"[OnDropToContainer] Moving from root to container {container.Id}");
                    RemoveWidgetFromTree(movedWidget);
                }

                if (container.Children == null)
                    container.Children = new List<DraggableWidget>();

                // 如果在同一容器内移动且插入点在原位置之后，需减1（DOM仍包含原项时计算的）
                if (sameParent && originalIndexInContainer >= 0 && insertIndex > originalIndexInContainer)
                {
                    insertIndex--;
                }
                if (insertIndex < 0 || insertIndex > container.Children.Count) insertIndex = container.Children.Count;
                container.Children.Insert(insertIndex, movedWidget);
                selectedWidget = movedWidget;
                dropSucceeded = true;
                draggedWidget = null;
                draggedParentContainer = null;
                
                await JS.InvokeVoidAsync("console.log", $"[OnDropToContainer] Moved widget {movedWidget.Id} to container at {insertIndex}");
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[OnDropToContainer] Error: {ex.Message}");
        }
    }

    /// <summary>
    /// 递归序列化子控件列表
    /// </summary>
    private List<Dictionary<string, object>> SerializeChildren(List<DraggableWidget> children)
    {
        var result = new List<Dictionary<string, object>>();
        
        for (int i = 0; i < children.Count; i++)
        {
            var child = children[i];
            var childData = new Dictionary<string, object>
            {
                ["id"] = child.Id,
                ["type"] = child.Type,
                ["label"] = child.Label,
                ["order"] = i,
                ["Width"] = child.Width,
                ["WidthUnit"] = child.WidthUnit ?? "%",
                ["Height"] = child.Height,
                ["HeightUnit"] = child.HeightUnit ?? "auto",
                ["visible"] = child.Visible,
                ["dataField"] = child.DataField ?? child.Id,  // 总是写 dataField，避免回放时丢失绑定
                ["newLine"] = child.NewLine
            };
            // 统一：newLine 始终写入（上面已写）
            
            // 特定控件属性（安全访问）
            if (child is TextboxWidget textbox)
            {
                if (!string.IsNullOrWhiteSpace(textbox.DefaultValue))
                    childData["defaultValue"] = textbox.DefaultValue;
                if (!string.IsNullOrWhiteSpace(textbox.Placeholder))
                    childData["placeholder"] = textbox.Placeholder;
                if (textbox.Required)
                    childData["required"] = textbox.Required;
                if (textbox.Readonly)
                    childData["readonly"] = textbox.Readonly;
                if (textbox.MaxLength.HasValue)
                    childData["maxLength"] = textbox.MaxLength.Value;
            }
                
            // 扩展属性
            if (child.ExtendedProperties != null && child.ExtendedProperties.Any())
            {
                foreach (var kvp in child.ExtendedProperties)
                {
                    if (!string.IsNullOrWhiteSpace(kvp.Key) && kvp.Value != null)
                    {
                        childData[kvp.Key] = kvp.Value;
                    }
                }
            }
            
            // 递归保存嵌套子控件
            if (child.Children != null && child.Children.Any())
            {
                childData["children"] = SerializeChildren(child.Children);
            }
            
            result.Add(childData);
        }
        
        return result;
    }

    /// <summary>
    /// 查找控件的父容器（如果在顶层则返回null）
    /// </summary>
    private DraggableWidget? FindParentContainer(DraggableWidget widget)
    {
        // 检查所有顶层控件
        foreach (var container in layoutWidgets.Where(w => w.Children != null))
        {
            if (container.Children!.Contains(widget))
                return container;
                
            // 递归查找
            var parent = FindParentInContainer(container, widget);
            if (parent != null)
                return parent;
        }
        
        return null;  // 在顶层，无父容器
    }

    /// <summary>
    /// 在容器的子树中查找控件的父容器
    /// </summary>
    private DraggableWidget? FindParentInContainer(DraggableWidget container, DraggableWidget widget)
    {
        if (container.Children == null)
            return null;
        
        // 遍历直接子控件
        foreach (var child in container.Children)
        {
            if (child.Children != null)
            {
                if (child.Children.Contains(widget))
                    return child;  // child 是 widget 的父容器
                    
                // 递归向下查找
                var parent = FindParentInContainer(child, widget);
                if (parent != null)
                    return parent;
            }
        }
        
        return null;
    }

    /// <summary>
    /// 递归查找控件（支持嵌套）
    /// </summary>
    private DraggableWidget? FindWidgetRecursive(string widgetId)
    {
        // 在顶层查找
        var widget = layoutWidgets.FirstOrDefault(x => x.Id == widgetId);
        if (widget != null)
            return widget;
            
        // 在所有容器中递归查找
        foreach (var container in layoutWidgets.Where(w => w.Children != null))
        {
            widget = FindWidgetInContainer(container, widgetId);
            if (widget != null)
                return widget;
        }
        
        return null;
    }

    /// <summary>
    /// 在容器及其子容器中递归查找控件
    /// </summary>
    private DraggableWidget? FindWidgetInContainer(DraggableWidget container, string widgetId)
    {
        if (container.Children == null)
            return null;
            
        // 直接子控件
        var widget = container.Children.FirstOrDefault(w => w.Id == widgetId);
        if (widget != null)
            return widget;
            
        // 递归查找子容器
        foreach (var child in container.Children.Where(c => c.Children != null))
        {
            widget = FindWidgetInContainer(child, widgetId);
            if (widget != null)
                return widget;
        }
        
        return null;
    }

    /// <summary>
    /// 从整个树中移除控件（递归搜索）
    /// </summary>
    private bool RemoveWidgetFromTree(DraggableWidget widget)
    {
        // 从顶层移除
        if (layoutWidgets.Remove(widget))
        {
            return true;
        }
        
        // 从所有容器中递归移除
        foreach (var container in layoutWidgets.Where(w => w.Children != null))
        {
            if (RemoveWidgetFromContainer(container, widget))
            {
                return true;
            }
        }
        
        return false;
    }

    /// <summary>
    /// 从容器及其子容器中递归移除控件
    /// </summary>
    private bool RemoveWidgetFromContainer(DraggableWidget container, DraggableWidget widget)
    {
        if (container.Children == null)
            return false;
            
        // 直接子控件
        if (container.Children.Remove(widget))
        {
            return true;
        }
        
        // 递归检查子容器
        foreach (var child in container.Children.Where(c => c.Children != null))
        {
            if (RemoveWidgetFromContainer(child, widget))
            {
                return true;
            }
        }
        
        return false;
    }

    private record ComponentDefinition(string Type, string Label, string Icon);
    private List<ComponentDefinition> basicComponents = new()
    {
        new("textbox","LBL_TEXTBOX", IconType.Outline.Edit),
        new("label","LBL_LABEL", IconType.Outline.FileText),
        new("calendar","LBL_CALENDAR", IconType.Outline.Calendar),
        new("listbox","LBL_LISTBOX", IconType.Outline.UnorderedList)
    };
    private List<ComponentDefinition> layoutComponents = new()
    {
        new("section","LBL_SECTION", IconType.Outline.AppstoreAdd),
        new("frame","LBL_FRAME", IconType.Outline.BorderOuter),
        new("tabbox","LBL_TABBOX", IconType.Outline.Appstore)
    };

    // ===== 控件工厂方法 =====

    /// <summary>
    /// 根据类型字符串创建具体控件实例
    /// 统一控件创建，避免页面私有类型导致的转换异常
    /// </summary>
    private DraggableWidget CreateWidgetByType(string type, string label)
    {
        DraggableWidget widget = type.ToLower() switch
        {
            "textbox" => new TextboxWidget(),
            "label" => new LabelWidget(),
            "calendar" => new CalendarWidget(),
            "listbox" => new ListboxWidget(),
            "frame" => new FrameWidget(),
            "section" => new SectionWidget(),
            _ => new TextboxWidget()
        };
        
        // 设置默认属性
        widget.Id = Guid.NewGuid().ToString();
        widget.Type = type;
        widget.Label = label;
        widget.Width = 48;
        widget.WidthUnit = "%";
        widget.Visible = true;
        
        // 为容器类型初始化 Children
        if (type == "frame" || type == "section" || type == "tabbox")
        {
            widget.Children = new List<DraggableWidget>();
        }
        
        return widget;
    }
    
    // ===== ExtendedProperties 辅助方法 =====
    
    /// <summary>
    /// 获取扩展属性值
    /// </summary>
    private T? GetExtProp<T>(DraggableWidget widget, string key, T? defaultValue = default)
    {
        if (widget.ExtendedProperties == null || !widget.ExtendedProperties.TryGetValue(key, out var value))
            return defaultValue;
            
        try
        {
            if (value is T typedValue)
                return typedValue;
            return (T?)Convert.ChangeType(value, typeof(T));
        }
        catch
        {
            return defaultValue;
        }
    }
    
    /// <summary>
    /// 设置扩展属性值
    /// </summary>
    private void SetExtProp(DraggableWidget widget, string key, object? value)
    {
        if (widget.ExtendedProperties == null)
            widget.ExtendedProperties = new Dictionary<string, object>();
            
        if (value == null)
            widget.ExtendedProperties.Remove(key);
        else
            widget.ExtendedProperties[key] = value;
    }
    
    // ===== 属性面板辅助属性（桥接 DraggableWidget 和具体控件类型） =====
    
    private string? SelectedWidgetDefaultValue
    {
        get => selectedWidget is TextboxWidget tb ? tb.DefaultValue : null;
        set { if (selectedWidget is TextboxWidget tb) { tb.DefaultValue = value; UpdateWidget(); } }
    }
    
    private string? SelectedWidgetPlaceholder
    {
        get => selectedWidget is TextboxWidget tb ? tb.Placeholder : null;
        set { if (selectedWidget is TextboxWidget tb) { tb.Placeholder = value; UpdateWidget(); } }
    }
    
    private int? SelectedWidgetMaxLength
    {
        get => selectedWidget is TextboxWidget tb ? tb.MaxLength : null;
        set { if (selectedWidget is TextboxWidget tb) { tb.MaxLength = value; UpdateWidget(); } }
    }
    
    private bool SelectedWidgetRequired
    {
        get => selectedWidget is TextboxWidget tb ? tb.Required : false;
        set { if (selectedWidget is TextboxWidget tb) { tb.Required = value; UpdateWidget(); } }
    }
    
    private bool SelectedWidgetReadonly
    {
        get => selectedWidget is TextboxWidget tb ? tb.Readonly : false;
        set { if (selectedWidget is TextboxWidget tb) { tb.Readonly = value; UpdateWidget(); } }
    }
}
