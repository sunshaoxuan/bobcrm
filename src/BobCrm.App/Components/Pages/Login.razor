@page "/login"
@rendermode RenderMode.InteractiveServer
@layout BobCrm.App.Components.Layout.AuthLayout

@inject IHttpClientFactory HttpFactory
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject BobCrm.App.Services.I18nService I18n
@inject IWebHostEnvironment Env
@using System.Linq

<AuthShell HeroTitle='@I18n.T("TXT_AUTH_HERO_TITLE")'
           HeroSubtitle='@I18n.T("TXT_AUTH_HERO_SUBTITLE")'
           ShowHeroContent="false"
           BrandInHero='true'
           BrandText='OneCRM'
           HeroImageUrl='@heroImageUrl'
           HeroImageUrlAlt='@heroImageUrlAlt'
           HeroImageUseAlt='@heroUseAlt'
           Eyebrow='@I18n.T("LBL_SECURE")'
           PanelEyebrow='@I18n.T("LBL_WELCOME_BACK")'
           FormTitle='@I18n.T("LBL_LOGIN_TITLE")'>
    <ChildContent>
        <EditForm Model="model" OnValidSubmit="OnLoginAsync" FormName="login" class="auth-form">
            <DataAnnotationsValidator />
            <ValidationSummary class="auth-message error" />
            <div class="auth-field">
                <div class="auth-field-header">
                    <label for="login-username">@I18n.T("LBL_USERNAME_OR_EMAIL")</label>
                    <span class="auth-field-hint">@I18n.T("TXT_LOGIN_DESCRIPTION")</span>
                </div>
                <Input id="login-username" @bind-Value="model.username" Placeholder="admin" Class="field-control" />
            </div>
            <div class="auth-field">
                <label for="login-password">@I18n.T("LBL_PASSWORD")</label>
                <Input id="login-password" Password="true" @bind-Value="model.password" Class="field-control" />
            </div>
            <Button Type="ButtonType.Primary" HtmlType="ButtonHtmlType.Submit" Loading="loading">@I18n.T("LBL_LOGIN_TITLE")</Button>
        </EditForm>
        @if (!string.IsNullOrEmpty(error))
        {
            <div class="auth-message error">@error</div>
        }
    </ChildContent>
    <Footer>
        <div class="auth-footer">
            <div class="auth-tagline">@I18n.T("TXT_AUTH_TAGLINE")</div>
            <span>@I18n.T("TXT_NO_ACCOUNT") <a href="/register">@I18n.T("BTN_REGISTER")</a></span>
        </div>
    </Footer>
</AuthShell>

@code {
    private LoginModel model = new();
    private bool loading = false;
    private string? error;
    private static readonly List<string> DefaultHeroImages = new()
    {
        "/images/slider/tokyo01.jpg",
        "/images/slider/fujisann01.jpg"
    };

    private string? heroImageUrl = "/images/slider/tokyo01.jpg";
    private string? heroImageUrlAlt = "/images/slider/fujisann01.jpg";
    private bool heroUseAlt;
    private List<string> slider = new();
    private string sliderSignature = string.Empty;
    private readonly Random heroRng = new();
    private int sliderIndex = 0;
    private CancellationTokenSource? cts;

    // Hero points removed per new guideline (two lines only)

    protected override void OnInitialized()
    {
        I18n.OnChanged += HandleI18nChanged;
    }

    private void HandleI18nChanged()
    {
        try { InvokeAsync(StateHasChanged); } catch { }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var savedLang = await JS.InvokeAsync<string?>("bobcrm.getCookie", "lang");
                var langToLoad = !string.IsNullOrWhiteSpace(savedLang) ? savedLang! : "ja";
                await I18n.LoadAsync(langToLoad); try { await JS.InvokeVoidAsync("bobcrm.setLang", langToLoad); } catch { }
                // Check backend whether admin exists; avoid localStorage
                try
                {
                    var http = await new BobCrm.App.Services.AuthService(HttpFactory, JS).CreateClientWithLangAsync();
                    var resp = await http.GetAsync("/api/setup/admin");
                    if (resp.IsSuccessStatusCode)
                    {
                        var info = await resp.Content.ReadFromJsonAsync<AdminInfo>();
                        if (info is not null && info.exists == false)
                        { Nav.NavigateTo("/setup"); return; }
                    }
                }
                catch { }
                var token = await JS.InvokeAsync<string?>("localStorage.getItem", "accessToken");
                if (!string.IsNullOrWhiteSpace(token))
                {
                    Nav.NavigateTo("/", forceLoad: true);
                    return;
                }
                // Initialize hero slider images
                try
                {
                    InitializeHeroImages();
                    _ = RunSliderAsync();
                }
                catch { }

                StateHasChanged();
            }
            catch { }
        }
    }

    private void InitializeHeroImages() => ReloadSliderImages(forceShuffle: true);

    private async Task RunSliderAsync()
    {
        cts?.Cancel();
        cts = new CancellationTokenSource();
        var token = cts.Token;
        while (!token.IsCancellationRequested)
        {
            try { await Task.Delay(8000, token); } catch { break; }
            var reloaded = ReloadSliderImages();
            if (slider.Count == 0) continue;
            if (reloaded)
            {
                try { await InvokeAsync(StateHasChanged); } catch { }
                continue;
            }
            sliderIndex = (sliderIndex + 1) % slider.Count;
            var next = slider[sliderIndex];
            if (!heroUseAlt)
            {
                heroImageUrlAlt = next;
                heroUseAlt = true;
            }
            else
            {
                heroImageUrl = next;
                heroUseAlt = false;
            }
            try { await InvokeAsync(StateHasChanged); } catch { }
        }
    }

    private bool ReloadSliderImages(bool forceShuffle = false)
    {
        try
        {
            var discovered = DiscoverSliderImages();
            var signature = string.Join("|", discovered);
            if (!forceShuffle && signature == sliderSignature)
            {
                return false;
            }
            sliderSignature = signature;
            if (discovered.Count > 1)
            {
                discovered = discovered.OrderBy(_ => heroRng.Next()).ToList();
            }
            slider = discovered;
            sliderIndex = 0;
            heroImageUrl = slider.FirstOrDefault() ?? heroImageUrl;
            heroImageUrlAlt = slider.Skip(1).FirstOrDefault() ?? heroImageUrl;
            heroUseAlt = false;
            return true;
        }
        catch
        {
            return false;
        }
    }

    private List<string> DiscoverSliderImages()
    {
        var results = new List<string>();
        var webRoot = ResolveWebRootPath();
        void Collect(string relative)
        {
            var physical = Path.Combine(webRoot, relative.Replace('/', Path.DirectorySeparatorChar));
            if (!Directory.Exists(physical)) return;
            var files = Directory.GetFiles(physical)
                .Where(IsSupportedImage)
                .OrderBy(f => f)
                .Select(f => "/" + relative.Trim('/').Replace('\\', '/') + "/" + Path.GetFileName(f));
            results.AddRange(files);
        }

        Collect("images/slider");
        if (results.Count == 0)
        {
            Collect("images");
        }
        if (results.Count == 0)
        {
            results.AddRange(DefaultHeroImages);
        }
        return results.Distinct().ToList();
    }

    private static bool IsSupportedImage(string filePath)
    {
        var ext = Path.GetExtension(filePath);
        return ext.Equals(".jpg", StringComparison.OrdinalIgnoreCase)
            || ext.Equals(".jpeg", StringComparison.OrdinalIgnoreCase)
            || ext.Equals(".png", StringComparison.OrdinalIgnoreCase)
            || ext.Equals(".webp", StringComparison.OrdinalIgnoreCase)
            || ext.Equals(".avif", StringComparison.OrdinalIgnoreCase);
    }

    private string ResolveWebRootPath()
    {
        if (!string.IsNullOrWhiteSpace(Env?.WebRootPath) && Directory.Exists(Env.WebRootPath))
        {
            return Env.WebRootPath;
        }
        return Path.Combine(AppContext.BaseDirectory, "wwwroot");
    }

    public void Dispose()
    {
        cts?.Cancel();
        cts?.Dispose();
        I18n.OnChanged -= HandleI18nChanged;
    }

    private async Task OnLoginAsync()
    {
        loading = true; error = null;
        StateHasChanged(); // 立即更新UI显示loading状态
        
        try
        {
            // Validate input
            if (string.IsNullOrWhiteSpace(model.username))
            {
                error = I18n.T("ERR_USERNAME_REQUIRED");
                loading = false;
                StateHasChanged();
                return;
            }
            if (string.IsNullOrWhiteSpace(model.password))
            {
                error = I18n.T("ERR_PASSWORD_REQUIRED");
                loading = false;
                StateHasChanged();
                return;
            }
            
            System.Diagnostics.Debug.WriteLine($"[Login] Attempting login with username: '{model.username}'");
            await JS.InvokeVoidAsync("console.log", $"[Login] Attempting login with username: '{model.username}'");
            
            var http = HttpFactory.CreateClient("api");
            // allow local override: localStorage -> cookie -> origin
            try {
                var baseUrl = await JS.InvokeAsync<string?>("localStorage.getItem", "apiBase");
                if (string.IsNullOrWhiteSpace(baseUrl)) baseUrl = await JS.InvokeAsync<string?>("bobcrm.getCookie", "apiBase");
                if (string.IsNullOrWhiteSpace(baseUrl)) baseUrl = await JS.InvokeAsync<string?>("bobcrm.getOrigin");
                if (!string.IsNullOrWhiteSpace(baseUrl)) http.BaseAddress = new Uri(baseUrl!, UriKind.Absolute);
                await JS.InvokeVoidAsync("console.log", $"[Login] Using API base: {http.BaseAddress}");
            } catch { }
            // attach X-Lang header
            try { var lang = await JS.InvokeAsync<string?>("localStorage.getItem", "lang"); if (string.IsNullOrWhiteSpace(lang)) lang = await JS.InvokeAsync<string?>("bobcrm.getCookie", "lang"); if (!string.IsNullOrWhiteSpace(lang)) { if (http.DefaultRequestHeaders.Contains("X-Lang")) http.DefaultRequestHeaders.Remove("X-Lang"); http.DefaultRequestHeaders.Add("X-Lang", lang!.ToLowerInvariant()); } } catch { }
            
            // 保存当前输入，避免验证失败后被清空
            var usernameToSend = model.username;
            var passwordToSend = model.password;
            
            await JS.InvokeVoidAsync("console.log", $"[Login] Sending login request to: {http.BaseAddress}api/auth/login");
            var resp = await http.PostAsJsonAsync("/api/auth/login", new { username = usernameToSend, password = passwordToSend });
            System.Diagnostics.Debug.WriteLine($"[Login] Response: {(int)resp.StatusCode} {resp.StatusCode}");
            await JS.InvokeVoidAsync("console.log", $"[Login] Response: {(int)resp.StatusCode} {resp.StatusCode}");
            if (!resp.IsSuccessStatusCode)
            {
                // 获取详细错误信息
                string detailedError = I18n.T("ERR_LOGIN_FAILED");
                try
                {
                    var errorContent = await resp.Content.ReadAsStringAsync();
                    System.Diagnostics.Debug.WriteLine($"[Login] Error response: {errorContent}");
                    await JS.InvokeVoidAsync("console.log", $"[Login] Error response: {errorContent}");
                    if (!string.IsNullOrWhiteSpace(errorContent))
                    {
                        try
                        {
                            var errorObj = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, object>>(errorContent);
                            if (errorObj != null && errorObj.ContainsKey("error"))
                            {
                                detailedError = errorObj["error"]?.ToString() ?? detailedError;
                            }
                        }
                        catch { }
                    }
                }
                catch { }
                
                error = detailedError;
                // 恢复输入值
                model.username = usernameToSend;
                model.password = passwordToSend;
                loading = false;
                StateHasChanged();
                return;
            }
            var json = await resp.Content.ReadFromJsonAsync<LoginResult>();
            if (json is null)
            {
                error = I18n.T("ERR_PARSE_RESPONSE"); return;
            }
            await JS.InvokeVoidAsync("localStorage.setItem", "accessToken", json.accessToken);
            await JS.InvokeVoidAsync("localStorage.setItem", "refreshToken", json.refreshToken);
            var userStr = System.Text.Json.JsonSerializer.Serialize(json.user);
            await JS.InvokeVoidAsync("localStorage.setItem", "user", userStr);
            Nav.NavigateTo("/", forceLoad: true);
        }
        catch (Exception ex)
        {
            error = $"{I18n.T("ERR_LOGIN_FAILED")}: {ex.Message}";
            System.Diagnostics.Debug.WriteLine($"[Login] Exception: {ex}");
            await JS.InvokeVoidAsync("console.error", $"[Login] Exception: {ex}");
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    public class LoginModel
    {
        public string username { get; set; } = string.Empty;
        public string password { get; set; } = string.Empty;
    }
    public record LoginResult(string accessToken, string refreshToken, UserDto user);
    public record UserDto(string id, string username, string role);
    public class AdminInfo { public bool exists { get; set; } public string? username { get; set; } public string? email { get; set; } }

    
}
