@page "/login"
@layout BobCrm.App.Components.Layout.EmptyLayout

@inject IHttpClientFactory HttpFactory
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject BobCrm.App.Services.I18nService I18n

<h1>@I18n.T("LBL_LOGIN_TITLE")</h1>

<EditForm Model="model" OnValidSubmit="OnLoginAsync" FormName="login">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div>
        <div>
            <Input @bind-Value="model.username" />
        </div>
        <div>
            <InputPassword @bind-Value="model.password" />
        </div>
        <div>
            <Button Type="ButtonType.Primary" HtmlType="ButtonHtmlType.Submit" Loading="loading">@I18n.T("LBL_LOGIN_TITLE")</Button>
        </div>
    </div>
    
</EditForm>

@if (!string.IsNullOrEmpty(error))
{
    <Alert Message="@error" Type="AlertType.Error" ShowIcon="true" />
}

@code {
    private LoginModel model = new();
    private bool loading = false;
    private string? error;

    protected override void OnInitialized()
    {
        I18n.OnChanged += HandleI18nChanged;
    }

    private void HandleI18nChanged()
    {
        try { InvokeAsync(StateHasChanged); } catch { }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var savedLang = await JS.InvokeAsync<string?>("bobcrm.getCookie", "lang");
                var langToLoad = !string.IsNullOrWhiteSpace(savedLang) ? savedLang! : "ja";
                await I18n.LoadAsync(langToLoad); try { await JS.InvokeVoidAsync("bobcrm.setLang", langToLoad); } catch { }
                // Check backend whether admin exists; avoid localStorage
                try
                {
                    var http = await new BobCrm.App.Services.AuthService(HttpFactory, JS).CreateClientWithLangAsync();
                    var resp = await http.GetAsync("/api/setup/admin");
                    if (resp.IsSuccessStatusCode)
                    {
                        var info = await resp.Content.ReadFromJsonAsync<AdminInfo>();
                        if (info is not null && info.exists == false)
                        { Nav.NavigateTo("/setup"); return; }
                    }
                }
                catch { }
                var token = await JS.InvokeAsync<string?>("localStorage.getItem", "accessToken");
                if (!string.IsNullOrWhiteSpace(token))
                {
                    Nav.NavigateTo("/customers", forceLoad: true);
                    return;
                }
                StateHasChanged();
            }
            catch { }
        }
    }

    private async Task OnLoginAsync()
    {
        loading = true; error = null;
        try
        {
            // Validate input
            if (string.IsNullOrWhiteSpace(model.username))
            {
                error = "用户名不能为空";
                return;
            }
            if (string.IsNullOrWhiteSpace(model.password))
            {
                error = "密码不能为空";
                return;
            }
            
            System.Diagnostics.Debug.WriteLine($"[Login] Attempting login with username: '{model.username}'");
            await JS.InvokeVoidAsync("console.log", $"[Login] Attempting login with username: '{model.username}'");
            
            var http = HttpFactory.CreateClient("api");
            // allow local override: localStorage -> cookie -> origin
            try {
                var baseUrl = await JS.InvokeAsync<string?>("localStorage.getItem", "apiBase");
                if (string.IsNullOrWhiteSpace(baseUrl)) baseUrl = await JS.InvokeAsync<string?>("bobcrm.getCookie", "apiBase");
                if (string.IsNullOrWhiteSpace(baseUrl)) baseUrl = await JS.InvokeAsync<string?>("bobcrm.getOrigin");
                if (!string.IsNullOrWhiteSpace(baseUrl)) http.BaseAddress = new Uri(baseUrl!, UriKind.Absolute);
                await JS.InvokeVoidAsync("console.log", $"[Login] Using API base: {http.BaseAddress}");
            } catch { }
            // attach X-Lang header
            try { var lang = await JS.InvokeAsync<string?>("localStorage.getItem", "lang"); if (string.IsNullOrWhiteSpace(lang)) lang = await JS.InvokeAsync<string?>("bobcrm.getCookie", "lang"); if (!string.IsNullOrWhiteSpace(lang)) { if (http.DefaultRequestHeaders.Contains("X-Lang")) http.DefaultRequestHeaders.Remove("X-Lang"); http.DefaultRequestHeaders.Add("X-Lang", lang!.ToLowerInvariant()); } } catch { }
            
            await JS.InvokeVoidAsync("console.log", $"[Login] Sending login request to: {http.BaseAddress}api/auth/login");
            var resp = await http.PostAsJsonAsync("/api/auth/login", new { username = model.username, password = model.password });
            System.Diagnostics.Debug.WriteLine($"[Login] Response: {(int)resp.StatusCode} {resp.StatusCode}");
            await JS.InvokeVoidAsync("console.log", $"[Login] Response: {(int)resp.StatusCode} {resp.StatusCode}");
            if (!resp.IsSuccessStatusCode)
            {
                error = I18n.T("ERR_LOGIN_FAILED");
                return;
            }
            var json = await resp.Content.ReadFromJsonAsync<LoginResult>();
            if (json is null)
            {
                error = I18n.T("ERR_PARSE_RESPONSE"); return;
            }
            await JS.InvokeVoidAsync("localStorage.setItem", "accessToken", json.accessToken);
            await JS.InvokeVoidAsync("localStorage.setItem", "refreshToken", json.refreshToken);
            var userStr = System.Text.Json.JsonSerializer.Serialize(json.user);
            await JS.InvokeVoidAsync("localStorage.setItem", "user", userStr);
            Nav.NavigateTo("/customers", forceLoad: true);
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    public class LoginModel
    {
        public string username { get; set; } = string.Empty;
        public string password { get; set; } = string.Empty;
    }
    public record LoginResult(string accessToken, string refreshToken, UserDto user);
    public record UserDto(string id, string username, string role);
    public class AdminInfo { public bool exists { get; set; } public string? username { get; set; } public string? email { get; set; } }

    public void Dispose()
    {
        I18n.OnChanged -= HandleI18nChanged;
    }
}















