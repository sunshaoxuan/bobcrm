@page "/setup"
@layout BobCrm.App.Components.Layout.EmptyLayout
@rendermode RenderMode.InteractiveServer

@inject IJSRuntime JS
@inject NavigationManager Nav
@inject BobCrm.App.Services.I18nService I18n
@inject BobCrm.App.Services.AuthService Auth
@inject MessageService Message
@inject IConfiguration Configuration
@using BobCrm.App.Models.Setup

<h1>@I18n.T("LBL_SETUP")</h1>


<div>

    <div class="section">
        <div class="heading">
            @I18n.T("LBL_API_BASE") <span class="text-muted small">(@I18n.T("LBL_OPTIONAL_DEFAULT"): @(defaultApiBase ?? "http://localhost:5200"))</span>
        </div>
        <Input @bind-Value="apiBase" Placeholder="@placeholderText" Class="field-control" />
        <div class="text-muted small" style="margin-top:6px">
            @I18n.T("SETUP_API_BASE_HINT")
        </div>
    </div>

    <div class="section"><div class="heading">@I18n.T("LBL_LANG")</div>
        <select value="@lang" @onchange="OnLangChanged" class="field-control" style="width:220px">
            @if (langs.Count == 0)
            {
                <option value="zh">@I18n.T("LANG_ZH_SIMPLIFIED")</option>
                <option value="ja">@I18n.T("LANG_JA")</option>
                <option value="en">@I18n.T("LANG_EN")</option>
            }
            else
            {
                @foreach (var l in langs)
                {
                    <option value="@l.code">@l.name</option>
                }
            }
        </select>
    </div>
    <Divider />

    <h3>@I18n.T("LBL_ADMIN_ACCOUNT")</h3>

    <div class="section"><div class="heading">@I18n.T("LBL_ADMIN_USERNAME")</div>

        <Input @bind-Value="adminUser" Placeholder="admin" Class="field-control" />

    </div>

    <div class="section"><div class="heading">@I18n.T("LBL_ADMIN_EMAIL")</div>

        <Input @bind-Value="adminEmail" Placeholder="admin@local" Class="field-control" />

    </div>

    <div class="section"><div class="heading">@I18n.T("LBL_ADMIN")@I18n.T("LBL_PASSWORD")</div>
        <InputPassword @bind-Value="adminPassword" />
    </div>
    <div>

        <Space>
            <Button Type="ButtonType.Primary" OnClick="SaveAsync" Loading="saving">@I18n.T("BTN_SAVE_AND_GO_LOGIN")</Button>
            <Button OnClick="GotoLogin">@I18n.T("BTN_GO_LOGIN")</Button>
            <Button Type="ButtonType.Default" Danger="true" OnClick="ResetSetup" Loading="resetting">@I18n.T("SETUP_BTN_RESET")</Button>
        </Space>
    </div>

</div>



@code {

    private string? apiBase;
    private string? defaultApiBase;
    private string placeholderText = "";

    private string lang = "ja";
    private List<SetupLangItem> langs = new();
    private bool saving;

    // Initialize empty to avoid flashing hardcoded defaults before API response
    private string adminUser = string.Empty;

    private string adminEmail = string.Empty;

    private string adminPassword = ""; // Keep password empty by default
    private bool resetting = false;
    
    protected override void OnInitialized()
    {
        // Infer API base from current host first (supports distributed deployments)
        var currentUri = new Uri(Nav.BaseUri);
        var apiPort = 5200; // Default to 5200 to avoid falling back to 8081
        
        // Use current request host and scheme instead of localhost
        var inferredBase = $"{currentUri.Scheme}://{currentUri.Host}:{apiPort}";
        
        // If config base contains localhost, swap host to current host
        var configBase = Configuration["Api:BaseUrl"];
        if (!string.IsNullOrWhiteSpace(configBase) && configBase.Contains("localhost"))
        {
            // Config uses localhost; replace with current host
            var configUri = new Uri(configBase);
            defaultApiBase = $"{currentUri.Scheme}://{currentUri.Host}:{configUri.Port}";
        }
        else if (!string.IsNullOrWhiteSpace(configBase))
        {
            // Config has explicit host; use as-is
            defaultApiBase = configBase;
        }
        else
        {
            // No config; use inferred address
            defaultApiBase = inferredBase;
        }
        
        apiBase = defaultApiBase; // Start with default value
        placeholderText = string.Format(I18n.T("PH_DEFAULT_VALUE"), defaultApiBase);
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Resolve effective API base (localStorage -> cookie -> current/default)
                var lsBase = await JS.InvokeAsync<string?>("localStorage.getItem", "apiBase");
                var cookieBase = await JS.InvokeAsync<string?>("bobcrm.getCookie", "apiBase");
                if (!string.IsNullOrWhiteSpace(lsBase))
                {
                    apiBase = lsBase;
                }
                else if (!string.IsNullOrWhiteSpace(cookieBase))
                {
                    apiBase = cookieBase;
                }
                else
                {
                    var currentUri = new Uri(Nav.BaseUri);
                    var apiPort = 5200; // Default to 5200
                    apiBase ??= $"{currentUri.Scheme}://{currentUri.Host}:{apiPort}";
                }
                defaultApiBase = apiBase;
                placeholderText = string.Format(I18n.T("PH_DEFAULT_VALUE"), defaultApiBase);
                // Persist apiBase for I18nService/named clients
                try { await JS.InvokeVoidAsync("bobcrm.setCookie", "apiBase", apiBase, 365); } catch { }
                try { await JS.InvokeVoidAsync("localStorage.setItem", "apiBase", apiBase); } catch { }

                // Load language (cookie or default)
                var savedLang = await JS.InvokeAsync<string?>("bobcrm.getCookie", "lang");
                var langToLoad = !string.IsNullOrWhiteSpace(savedLang) ? savedLang! : lang;
                await I18n.LoadAsync(langToLoad);
                try { await JS.InvokeVoidAsync("bobcrm.setLang", langToLoad); } catch { }
                
                // Load current admin info from backend (if already configured)
                try
                {
                    // Compute effective API base: current input/state -> cookie -> default/origin
                    var cb = await JS.InvokeAsync<string?>("bobcrm.getCookie", "apiBase");
                    var effectiveBase = apiBase ?? (!string.IsNullOrWhiteSpace(cb) ? cb! : null) ?? defaultApiBase ?? await JS.InvokeAsync<string>("bobcrm.getOrigin");

                    async Task<bool> TryFetchAdminAsync(string baseUrl)
                    {
                        try
                        {
                            await JS.InvokeVoidAsync("console.log", $"[Setup] Fetching admin info from (browser): {baseUrl}");
                            var url = (baseUrl ?? string.Empty).TrimEnd('/') + "/api/setup/admin";
                            var adminInfo = await JS.InvokeAsync<SetupAdminInfo?>("bobcrm.fetchJson", url);
                            if (adminInfo is null) return false;
                            var u = adminInfo.username;
                            var m = adminInfo.email;
                            if (!string.IsNullOrWhiteSpace(u))
                            {
                                adminUser = u!;
                                if (!string.IsNullOrWhiteSpace(m)) adminEmail = m!;
                                apiBase = baseUrl; defaultApiBase = baseUrl;
                                try { await JS.InvokeVoidAsync("bobcrm.setCookie", "apiBase", baseUrl, 365); } catch { }
                                await JS.InvokeVoidAsync("console.log", $"[Setup] Loaded admin from database: username='{adminUser}', email='{adminEmail}'");
                                StateHasChanged();
                                return true;
                            }
                            return false;
                        }
                        catch { return false; }
                    }

                    // Single attempt; no automatic port fallback
                    await TryFetchAdminAsync(effectiveBase);
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"[Setup] Failed to load admin info from API: {ex.Message}");
                    await JS.InvokeVoidAsync("console.log", $"[Setup] Could not load admin from API (API may not be running): {ex.Message}");
                }
                
                // load languages list from API (works without auth) using effective base
                try
                {
                    var cookieBase2 = await JS.InvokeAsync<string?>("bobcrm.getCookie", "apiBase");
                    var base2 = apiBase ?? (!string.IsNullOrWhiteSpace(cookieBase2) ? cookieBase2! : null) ?? defaultApiBase ?? await JS.InvokeAsync<string>("bobcrm.getOrigin");
                    await JS.InvokeVoidAsync("console.log", $"[Setup] Loading languages from: {base2}");
                    async Task<bool> TryFetchAsync(string b)
                    {
                        try
                        {
                            using var tmp = new HttpClient { BaseAddress = new Uri((b ?? string.Empty).TrimEnd('/') + "/", UriKind.Absolute) };
                            try { tmp.DefaultRequestHeaders.Remove("X-Lang"); tmp.DefaultRequestHeaders.Add("X-Lang", (lang ?? "ja").ToLowerInvariant()); } catch { }
                            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(2));
                            var r = await tmp.GetAsync("/api/i18n/languages", cts.Token);
                            if (!r.IsSuccessStatusCode) return false;
                            var json = await r.Content.ReadFromJsonAsync<List<SetupLangItem>>();
                            if (json is null || json.Count == 0) return false;
                            langs = json; apiBase = b; defaultApiBase = b;
                            try { await JS.InvokeVoidAsync("bobcrm.setCookie", "apiBase", b, 365); } catch { }
                            return true;
                        }
                        catch { return false; }
                    }

                    // Single attempt; no automatic port fallback
                    await TryFetchAsync(base2);
                }
                catch { }
                StateHasChanged();
            }
            catch { }
        }
    }


    private async Task SaveAsync()
    {
        try
        {
            // Debug: Log method entry - multiple ways to ensure we see it
            await JS.InvokeVoidAsync("console.log", "[Setup] SaveAsync method called!", apiBase, adminUser, adminEmail);
            System.Diagnostics.Debug.WriteLine($"[Setup] SaveAsync called. apiBase={apiBase}, adminUser={adminUser}, adminEmail={adminEmail}");
            
            saving = true;
            StateHasChanged();
            await Task.Yield(); // Ensure UI updates
            
            
            // Validate input - fall back to defaults when missing
            if (string.IsNullOrWhiteSpace(apiBase))
            {
                apiBase = defaultApiBase ?? "http://localhost:5200";
            }
            
            // Ensure API address is valid
            if (!Uri.TryCreate(apiBase, UriKind.Absolute, out var uri) || (uri.Scheme != "http" && uri.Scheme != "https"))
            {
                var errorMsg = string.Format(I18n.T("ERR_INVALID_API_BASE"), apiBase);
                System.Diagnostics.Debug.WriteLine($"[Setup] Validation failed: {errorMsg}");
                Message.Error(errorMsg);
                StateHasChanged();
                return;
            }
            if (string.IsNullOrWhiteSpace(adminUser))
            {
                var errorMsg = I18n.T("ERR_ADMIN_USERNAME_EMPTY");
                System.Diagnostics.Debug.WriteLine($"[Setup] Validation failed: {errorMsg}");
                Message.Error(errorMsg);
                StateHasChanged();
                return;
            }
            if (string.IsNullOrWhiteSpace(adminEmail))
            {
                var errorMsg = I18n.T("ERR_ADMIN_EMAIL_EMPTY");
                System.Diagnostics.Debug.WriteLine($"[Setup] Validation failed: {errorMsg}");
                Message.Error(errorMsg);
                StateHasChanged();
                return;
            }
            if (string.IsNullOrWhiteSpace(adminPassword))
            {
                var errorMsg = I18n.T("ERR_ADMIN_PASSWORD_EMPTY");
                System.Diagnostics.Debug.WriteLine($"[Setup] Validation failed: {errorMsg}");
                Message.Error(errorMsg);
                StateHasChanged();
                return;
            }
            
            System.Diagnostics.Debug.WriteLine("[Setup] Validation passed, starting save process...");

            // Persist base and language locally first (even if backend save fails)
            try { if (!string.IsNullOrWhiteSpace(apiBase)) await JS.InvokeVoidAsync("localStorage.setItem", "apiBase", apiBase); } catch { }
            try { if (!string.IsNullOrWhiteSpace(apiBase)) await JS.InvokeVoidAsync("bobcrm.setCookie", "apiBase", apiBase, 365); } catch { }
            try { await JS.InvokeVoidAsync("localStorage.setItem", "lang", lang); } catch { }

            // reload i18n immediately so UI switches language before navigation
            try { await I18n.LoadAsync(lang); await JS.InvokeVoidAsync("bobcrm.setLang", lang); } catch { }

            // call backend to save admin; await to ensure it's actually saved
            bool ok = false; string? err = null;
            try
            {
                using (var http = new HttpClient { BaseAddress = new Uri((apiBase ?? defaultApiBase ?? await JS.InvokeAsync<string>("bobcrm.getOrigin")).TrimEnd('/') + "/", UriKind.Absolute) })
                {
                    // Set language header
                    var langHeader = lang.ToLowerInvariant();
                    if (http.DefaultRequestHeaders.Contains("X-Lang"))
                        http.DefaultRequestHeaders.Remove("X-Lang");
                    http.DefaultRequestHeaders.Add("X-Lang", langHeader);
                    
                    using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(15));
                    var requestUrl = http.BaseAddress + "api/setup/admin";
                    System.Diagnostics.Debug.WriteLine($"[Setup] Sending POST request to: {requestUrl}");
                    await JS.InvokeVoidAsync("console.log", $"[Setup] Sending POST request to: {requestUrl}, username: {adminUser}, email: {adminEmail}");
                    
                    var resp = await http.PostAsJsonAsync("/api/setup/admin", new { username = adminUser, email = adminEmail, password = adminPassword }, cts.Token);
                    ok = resp.IsSuccessStatusCode;
                    System.Diagnostics.Debug.WriteLine($"[Setup] Response status: {(int)resp.StatusCode} {resp.StatusCode}, Success: {ok}");
                    await JS.InvokeVoidAsync("console.log", $"[Setup] Response: {(int)resp.StatusCode} {resp.StatusCode}, Success: {ok}");
                    
                    if (!ok)
                    {
                        var errorContent = await resp.Content.ReadAsStringAsync();
                        err = $"HTTP {(int)resp.StatusCode} {resp.StatusCode}: {errorContent}";
                        System.Diagnostics.Debug.WriteLine($"[Setup] Error response: {err}");
                        await JS.InvokeVoidAsync("console.error", $"[Setup] Error: {err}");
                    }
                    else
                    {
                        var successContent = await resp.Content.ReadAsStringAsync();
                        System.Diagnostics.Debug.WriteLine($"[Setup] Success response: {successContent}");
                        await JS.InvokeVoidAsync("console.log", $"[Setup] Success: {successContent}");
                        ok = true; // Explicitly mark as saved
                    }
                }
            }
            catch (TaskCanceledException)
            {
                err = string.Format(I18n.T("ERR_REQUEST_TIMEOUT"), apiBase);
                ok = false;
            }
            catch (HttpRequestException httpEx)
            {
                err = string.Format(I18n.T("ERR_CANNOT_CONNECT_API"), apiBase, httpEx.Message);
                ok = false;
            }
            catch (Exception ex)
            {
                err = string.Format(I18n.T("ERR_EXCEPTION_OCCURRED"), ex.GetType().Name, ex.Message, ex.StackTrace);
                System.Diagnostics.Debug.WriteLine($"[Setup] Exception details: {ex}");
                ok = false;
            }

            if (!ok)
            {
                var errorMsg = I18n.T("LBL_SAVE_FAILED");
                if (!string.IsNullOrWhiteSpace(err))
                {
                    errorMsg += ": " + err;
                }
                System.Diagnostics.Debug.WriteLine($"[Setup] Save failed: {errorMsg}");
                
                // Show detailed error message with admin account info
                var fullErrorMsg = string.Format(I18n.T("ERR_SAVE_FAILED_ADMIN"), apiBase, adminUser, adminEmail, errorMsg);
                
                try
                {
                    Message.Error(fullErrorMsg);
                }
                catch (Exception msgEx)
                {
                    System.Diagnostics.Debug.WriteLine($"[Setup] Message.Error failed: {msgEx.Message}");
                    // Fallback: try to show alert
                    try { await JS.InvokeVoidAsync("alert", fullErrorMsg); } catch { }
                    try { await JS.InvokeVoidAsync("console.error", errorMsg); } catch { }
                }
                StateHasChanged();
                return;
            }

            System.Diagnostics.Debug.WriteLine("[Setup] Save successful, navigating to home...");
            
            // Admin info saved to database; no extra persistence needed
            
            // mark configured and navigate to home
            try { await JS.InvokeVoidAsync("bobcrm.setCookie", "apiBase", (apiBase ?? defaultApiBase ?? await JS.InvokeAsync<string>("bobcrm.getOrigin")), 365); } catch { }
            try { await JS.InvokeVoidAsync("localStorage.setItem", "configured", "true"); } catch { }
            try
            {
                Message.Success(I18n.T("MSG_SETTINGS_SAVED_REDIRECTING"));
            }
            catch (Exception msgEx)
            {
                System.Diagnostics.Debug.WriteLine($"[Setup] Message.Success failed: {msgEx.Message}");
            }
            await Task.Delay(500); // Give time for message to show
            Nav.NavigateTo("/", forceLoad: true);
        }
        catch (Exception ex)
        {
            // Catch all unhandled exceptions
            System.Diagnostics.Debug.WriteLine($"[Setup] Unhandled exception in SaveAsync: {ex}");
            var errorMsg = string.Format(I18n.T("ERR_OCCURRED"), ex.Message);
            try
            {
                Message.Error(errorMsg);
            }
            catch
            {
                try { await JS.InvokeVoidAsync("console.error", errorMsg); } catch { }
                try { await JS.InvokeVoidAsync("alert", errorMsg); } catch { }
            }
        }
        finally
        {
            saving = false;
            StateHasChanged();
        }
    }


    private void GotoLogin() => Nav.NavigateTo("/login", forceLoad: true);

    private async Task ResetSetup()
    {
        resetting = true;
        StateHasChanged();
        
        try
        {
            var confirmMsg = I18n.T("MSG_RESET_CONFIRM") ?? "Reset setup? This removes the current admin account and requires reconfiguration.";
            var confirm = await JS.InvokeAsync<bool>("confirm", confirmMsg);
            if (!confirm)
            {
                resetting = false;
                StateHasChanged();
                return;
            }
            
            using var http = new HttpClient { BaseAddress = new Uri((apiBase ?? defaultApiBase ?? "http://localhost:5200").TrimEnd('/') + "/", UriKind.Absolute) };
            http.Timeout = TimeSpan.FromSeconds(10);
            
            var resp = await http.PostAsync("/api/debug/reset-setup", null);
            if (resp.IsSuccessStatusCode)
            {
                var result = await resp.Content.ReadFromJsonAsync<Dictionary<string, object>>();
                var message = result?.GetValueOrDefault("message")?.ToString() ?? I18n.T("MSG_RESET_SETUP_SUCCESS") ?? "Reset succeeded";
                Message.Success(message);
                
                // Clear form
                adminUser = string.Empty;
                adminEmail = string.Empty;
                adminPassword = string.Empty;
                StateHasChanged();
            }
            else
            {
                var error = await resp.Content.ReadAsStringAsync();
                var errorMsg = I18n.T("ERR_RESET_SETUP_FAILED") ?? "Reset failed";
                Message.Error($"{errorMsg}: {error}");
            }
        }
        catch (Exception ex)
        {
            var errorMsg = I18n.T("ERR_RESET_SETUP_FAILED") ?? "Reset failed";
            Message.Error($"{errorMsg}: {ex.Message}");
        }
        finally
        {
            resetting = false;
            StateHasChanged();
        }
    }

    private async Task OnLangChanged(ChangeEventArgs e)
    {
        var value = e?.Value?.ToString() ?? "ja";
        lang = value;
        try { await JS.InvokeVoidAsync("localStorage.setItem", "lang", lang); } catch { }

        // If the API base is typed but not saved yet, try to fetch dictionary directly
        try
        {
            if (!string.IsNullOrWhiteSpace(apiBase))
            {
                using var http = new HttpClient { BaseAddress = new Uri(apiBase!, UriKind.Absolute) };
                using var resp = await http.GetAsync($"/api/i18n/{lang}");
                if (resp.IsSuccessStatusCode)
                {
                    var json = await resp.Content.ReadAsStringAsync();
                    await JS.InvokeVoidAsync("localStorage.setItem", $"i18n:{lang}:v1", json);
                }
            }
        }
        catch { }

        await I18n.LoadAsync(lang);
        try { await JS.InvokeVoidAsync("bobcrm.setLang", lang); } catch { }
        StateHasChanged();
    }
}



