@page "/entity-definitions"
@rendermode RenderMode.InteractiveServer
@inject BobCrm.App.Services.EntityDefinitionService EntityDefService
@inject BobCrm.App.Services.I18nService I18n
@inject NavigationManager Nav
@using BobCrm.App.Models
@using System.Linq

<AuthChecker>
    <div class="collection-shell">
        <CollectionHeader Title="@I18n.T("LBL_ENTITY_DEFINITION_MANAGEMENT")"
                          Subtitle="@I18n.T("TXT_ENTITY_DEFINITION_DESC")"
                          Eyebrow="@I18n.T("LBL_COLLECTION")">
            <Actions>
                <Button Type="@ButtonType.Default" OnClick="LoadData" Icon="@IconType.Outline.Reload">
                    @I18n.T("BTN_REFRESH")
                </Button>
                <Button Type="@ButtonType.Primary" OnClick="NavigateToCreate" Icon="@IconType.Outline.Plus">
                    @I18n.T("BTN_NEW_ENTITY")
                </Button>
            </Actions>
            <Filters>
                <div class="collection-search">
                    <Input Placeholder="@I18n.T("LBL_SEARCH")" PrefixIcon="@IconType.Outline.Search" AllowClear @bind-Value="_search" Class="field-control" />
                </div>
                <Select TItemValue="string" TItem="string" @bind-Value="_sourceFilter" Style="min-width:160px">
                    <SelectOption Value="@("all")">@I18n.T("LBL_SOURCE_ALL")</SelectOption>
                    <SelectOption Value="@("system")">@I18n.T("LBL_SOURCE_SYSTEM")</SelectOption>
                    <SelectOption Value="@("custom")">@I18n.T("LBL_SOURCE_CUSTOM")</SelectOption>
                </Select>
                <Select TItemValue="string" TItem="string" @bind-Value="_statusFilter" Style="min-width:160px">
                    <SelectOption Value="@("all")">@I18n.T("LBL_STATUS_ALL")</SelectOption>
                    <SelectOption Value="@("published")">@I18n.T("LBL_STATUS_PUBLISHED")</SelectOption>
                    <SelectOption Value="@("draft")">@I18n.T("LBL_STATUS_DRAFT")</SelectOption>
                </Select>
            </Filters>
        </CollectionHeader>

        @{
            var filtered = FilteredEntities().ToList();
        }

        @if (_loading)
        {
            <div style="text-align: center; padding: 50px;">
                <Spin Size="@SpinSize.Large" />
            </div>
        }
    else
    {
        <Card>
            <Tabs DefaultActiveKey="all">
                <TabPane Key="all" Tab="@I18n.T("TAB_ALL")">
                    <EntityDefinitionsTable Entities="@filtered" OnEdit="NavigateToEdit" OnPublish="NavigateToPublish" OnDelete="HandleDelete" OnReload="LoadData" />
                </TabPane>
                <TabPane Key="system" Tab="@I18n.T("TAB_SYSTEM_ENTITIES")">
                    <EntityDefinitionsTable Entities="@filtered.Where(e => e.Source == EntitySource.System).ToList()" OnEdit="NavigateToEdit" OnPublish="NavigateToPublish" OnDelete="HandleDelete" OnReload="LoadData" />
                </TabPane>
                <TabPane Key="custom" Tab="@I18n.T("TAB_CUSTOM_ENTITIES")">
                    <EntityDefinitionsTable Entities="@filtered.Where(e => e.Source == EntitySource.Custom).ToList()" OnEdit="NavigateToEdit" OnPublish="NavigateToPublish" OnDelete="HandleDelete" OnReload="LoadData" />
                </TabPane>
                <TabPane Key="draft" Tab="@I18n.T("TAB_DRAFT")">
                    <EntityDefinitionsTable Entities="@filtered.Where(e => e.Status == EntityStatus.Draft).ToList()" OnEdit="NavigateToEdit" OnPublish="NavigateToPublish" OnDelete="HandleDelete" OnReload="LoadData" />
                </TabPane>
            </Tabs>
        </Card>
    }
    </div>
</AuthChecker>

@code {
    private bool _loading = false;
    private List<EntityDefinitionDto> _entities = new();
    private string _search = string.Empty;
    private string _sourceFilter = "all";
    private string _statusFilter = "all";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            _entities = await EntityDefService.GetAllAsync();
        }
        catch (Exception ex)
        {
            MessageService.Error($"{I18n.T("ED_MSG_LOAD_FAILED")}: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private IEnumerable<EntityDefinitionDto> FilteredEntities()
    {
        var query = _entities.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(_search))
        {
            query = query.Where(e =>
                e.EntityName.Contains(_search, StringComparison.OrdinalIgnoreCase)
                || (e.DisplayName != null && e.DisplayName.Values.Any(v =>
                    v != null && v.Contains(_search, StringComparison.OrdinalIgnoreCase))));
        }

        if (_sourceFilter != "all")
        {
            query = query.Where(e => (_sourceFilter == "system" && e.Source == EntitySource.System)
                                     || (_sourceFilter == "custom" && e.Source == EntitySource.Custom));
        }

        if (_statusFilter != "all")
        {
            query = query.Where(e => (_statusFilter == "published" && e.Status == EntityStatus.Published)
                                     || (_statusFilter == "draft" && e.Status == EntityStatus.Draft));
        }

        return query;
    }

    private void NavigateToCreate()
    {
        Nav.NavigateTo("/entity-definitions/create");
    }

    private void NavigateToEdit(Guid id)
    {
        Nav.NavigateTo($"/entity-definitions/edit/{id}");
    }

    private void NavigateToPublish(Guid id)
    {
        Nav.NavigateTo($"/entity-definitions/publish/{id}");
    }

    private async Task HandleDelete(Guid id)
    {
        var confirmed = await ModalService.ConfirmAsync(new ConfirmOptions
        {
            Title = I18n.T("ED_CONFIRM_DELETE_TITLE"),
            Content = I18n.T("ED_CONFIRM_DELETE_CONTENT"),
            ClassName = "calm-modal",
            OkText = I18n.T("BTN_DELETE"),
            CancelText = I18n.T("BTN_CANCEL"),
            OkType = ButtonType.Primary
        });

        if (confirmed)
        {
            try
            {
                await EntityDefService.DeleteAsync(id);
                MessageService.Success(I18n.T("MSG_DELETE_SUCCESS"));
                await LoadData();
            }
            catch (Exception ex)
            {
                MessageService.Error($"{I18n.T("MSG_DELETE_FAILED")}: {ex.Message}");
            }
        }
    }

    [Inject] private IMessageService MessageService { get; set; } = default!;
    [Inject] private ModalService ModalService { get; set; } = default!;
}


