@page "/enums/create"
@page "/enums/edit/{Id:guid}"
@rendermode RenderMode.InteractiveServer
@inject BobCrm.App.Services.EnumDefinitionService EnumService
@inject BobCrm.App.Services.I18nService I18n
@inject BobCrm.App.Services.ToastService ToastService
@inject NavigationManager Nav
@using BobCrm.Api.Contracts.DTOs
@using BobCrm.App.Models

<AuthChecker>
    <PageHeader Title="@_pageTitle" OnBack="GoBack">
        <PageHeaderExtra>
            <Space>
                <SpaceItem>
                    <Button Type="@ButtonType.Default" OnClick="GoBack">
                        @I18n.T("BTN_CANCEL")
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Primary" OnClick="HandleSave" Loading="_saving">
                        @I18n.T("BTN_SAVE")
                    </Button>
                </SpaceItem>
            </Space>
        </PageHeaderExtra>
    </PageHeader>

    <div style="padding: 24px; max-width: 1200px; margin: 0 auto;">
        @if (_loading)
        {
            <div style="text-align: center; padding: 50px;">
                <Spin Size="@SpinSize.Large" />
            </div>
        }
        else
        {
            <Card Title="基本信息" Style="margin-bottom: 16px;">
                <Form Layout="@FormLayout.Vertical">
                    <FormItem Label="@I18n.T("LBL_ENUM_CODE")">
                        <Input @bind-Value="_model.Code"
                               Placeholder="例如: ORDER_STATUS"
                               Disabled="@IsEditMode"
                               MaxLength="100" />
                        <span style="color: #8c8c8c; font-size: 12px;">枚举代码，创建后不可修改</span>
                    </FormItem>

                    <FormItem Label="显示名称（多语言）">
                        <MultilingualInput @bind-Value="_model.DisplayName" />
                    </FormItem>

                    <FormItem Label="描述（多语言）">
                        <MultilingualInput @bind-Value="_model.Description" />
                    </FormItem>

                    <FormItem Label="是否启用">
                        <Switch @bind-Value="_model.IsEnabled" />
                    </FormItem>
                </Form>
            </Card>

            <Card Title="@I18n.T("LBL_ENUM_OPTIONS")">
                <div style="margin-bottom: 16px;">
                    <Button Type="@ButtonType.Dashed"
                            Icon="@IconType.Outline.Plus"
                            OnClick="AddOption"
                            Block>
                        @I18n.T("BTN_ADD_OPTION")
                    </Button>
                </div>

                <Table TItem="EnumOptionViewModel"
                       DataSource="@_options"
                       Bordered
                       Size="@TableSize.Small">
                    <Column Title="@I18n.T("LBL_OPTION_VALUE")" TData="string" Width="200px">
                        @if (context.IsEditing)
                        {
                            <Input @bind-Value="context.Value"
                                   Placeholder="例如: PENDING"
                                   MaxLength="50" />
                        }
                        else
                        {
                            <strong>@context.Value</strong>
                        }
                    </Column>
                    <Column Title="显示名称" TData="string">
                        @if (context.IsEditing)
                        {
                            <MultilingualInput @bind-Value="context.DisplayName" />
                        }
                        else
                        {
                            @GetDisplayName(context.DisplayName)
                        }
                    </Column>
                    <Column Title="@I18n.T("LBL_COLOR_TAG")" TData="string" Width="150px">
                        @if (context.IsEditing)
                        {
                            <Select TItemValue="string" TItem="string" @bind-Value="context.ColorTag" Style="width: 120px;">
                                <SelectOption Value="">无</SelectOption>
                                <SelectOption Value="blue">蓝色</SelectOption>
                                <SelectOption Value="green">绿色</SelectOption>
                                <SelectOption Value="red">红色</SelectOption>
                                <SelectOption Value="orange">橙色</SelectOption>
                                <SelectOption Value="purple">紫色</SelectOption>
                                <SelectOption Value="cyan">青色</SelectOption>
                                <SelectOption Value="magenta">洋红</SelectOption>
                                <SelectOption Value="gold">金色</SelectOption>
                            </Select>
                        }
                        else
                        {
                            @if (!string.IsNullOrEmpty(context.ColorTag))
                            {
                                <Tag Color="@context.ColorTag">@context.ColorTag</Tag>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        }
                    </Column>
                    <Column Title="@I18n.T("LBL_ACTIONS")" TData="string" Width="180px">
                        @if (context.IsEditing)
                        {
                            <Space Size="@("small")">
                                <SpaceItem>
                                    <Button Size="@ButtonSize.Small"
                                            Type="@ButtonType.Primary"
                                            Icon="@IconType.Outline.Check"
                                            OnClick="() => SaveOption(context)">
                                        保存
                                    </Button>
                                </SpaceItem>
                                <SpaceItem>
                                    <Button Size="@ButtonSize.Small"
                                            Icon="@IconType.Outline.Close"
                                            OnClick="() => CancelEditOption(context)">
                                        取消
                                    </Button>
                                </SpaceItem>
                            </Space>
                        }
                        else
                        {
                            <Space Size="@("small")">
                                <SpaceItem>
                                    <Button Size="@ButtonSize.Small"
                                            Icon="@IconType.Outline.Edit"
                                            OnClick="() => EditOption(context)">
                                        编辑
                                    </Button>
                                </SpaceItem>
                                <SpaceItem>
                                    <Popconfirm Title="确定删除此选项？"
                                                OnConfirm="() => DeleteOption(context)"
                                                OkText="删除"
                                                CancelText="取消">
                                        <Button Size="@ButtonSize.Small"
                                                Danger
                                                Icon="@IconType.Outline.Delete">
                                            删除
                                        </Button>
                                    </Popconfirm>
                                </SpaceItem>
                            </Space>
                        }
                    </Column>
                </Table>
            </Card>
        }
    </div>
</AuthChecker>

@code {
    [Parameter]
    public Guid? Id { get; set; }

    private bool IsEditMode => Id.HasValue && Id.Value != Guid.Empty;
    private string _pageTitle => IsEditMode ? I18n.T("LBL_EDIT_ENUM") : I18n.T("LBL_CREATE_ENUM");

    private bool _loading = false;
    private bool _saving = false;
    private CreateEnumDefinitionRequest _model = new();
    private List<EnumOptionViewModel> _options = new();
    private Dictionary<Guid, EnumOptionViewModel> _backupOptions = new();

    protected override async Task OnInitializedAsync()
    {
        if (IsEditMode)
        {
            await LoadEnum();
        }
        else
        {
            // 新建模式，初始化空模型
            _model = new CreateEnumDefinitionRequest
            {
                DisplayName = new MultilingualTextDto(),
                Description = new MultilingualTextDto(),
                IsEnabled = true,
                Options = new List<EnumOptionDto>()
            };
        }
    }

    private async Task LoadEnum()
    {
        _loading = true;
        try
        {
            var enumDef = await EnumService.GetByIdAsync(Id!.Value);
            if (enumDef == null)
            {
                ToastService.Error(I18n.T("MSG_ENUM_LOAD_FAILED"));
                GoBack();
                return;
            }

            _model = new CreateEnumDefinitionRequest
            {
                Code = enumDef.Code,
                DisplayName = new MultilingualTextDto(enumDef.DisplayName),
                Description = enumDef.Description != null ? new MultilingualTextDto(enumDef.Description) : new MultilingualTextDto(),
                IsEnabled = enumDef.IsEnabled,
                Options = new List<EnumOptionDto>()
            };

            _options = enumDef.Options.Select(o => new EnumOptionViewModel
            {
                TempId = Guid.NewGuid(),
                Value = o.Value,
                DisplayName = new MultilingualTextDto(o.DisplayName),
                ColorTag = o.ColorTag,
                IsEditing = false
            }).ToList();
        }
        catch (Exception ex)
        {
            ToastService.Error($"{I18n.T("MSG_ENUM_LOAD_FAILED")}: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task HandleSave()
    {
        // 验证
        if (string.IsNullOrWhiteSpace(_model.Code))
        {
            ToastService.Error(I18n.T("MSG_ENUM_CODE_REQUIRED"));
            return;
        }

        if (_options.Any(o => o.IsEditing))
        {
            ToastService.Warning("请先保存或取消正在编辑的选项");
            return;
        }

        if (_options.Count == 0)
        {
            ToastService.Warning("请至少添加一个枚举选项");
            return;
        }

        // 转换选项
        _model.Options = _options.Select(o => new EnumOptionDto
        {
            Value = o.Value,
            DisplayName = o.DisplayName.ToDictionary(),
            ColorTag = o.ColorTag
        }).ToList();

        _saving = true;
        try
        {
            if (IsEditMode)
            {
                var updateRequest = new UpdateEnumDefinitionRequest
                {
                    DisplayName = _model.DisplayName.ToDictionary(),
                    Description = _model.Description?.ToDictionary(),
                    IsEnabled = _model.IsEnabled,
                    Options = _model.Options
                };
                await EnumService.UpdateAsync(Id!.Value, updateRequest);
                ToastService.Success(I18n.T("MSG_ENUM_UPDATE_SUCCESS"));
            }
            else
            {
                await EnumService.CreateAsync(_model);
                ToastService.Success(I18n.T("MSG_ENUM_CREATE_SUCCESS"));
            }

            GoBack();
        }
        catch (Exception ex)
        {
            ToastService.Error($"{I18n.T("MSG_ENUM_SAVE_FAILED")}: {ex.Message}");
        }
        finally
        {
            _saving = false;
        }
    }

    private void AddOption()
    {
        // 取消其他正在编辑的选项
        CancelAllEditing();

        var newOption = new EnumOptionViewModel
        {
            TempId = Guid.NewGuid(),
            Value = "",
            DisplayName = new MultilingualTextDto(),
            ColorTag = "",
            IsEditing = true
        };

        _options.Add(newOption);
    }

    private void EditOption(EnumOptionViewModel option)
    {
        // 取消其他正在编辑的选项
        CancelAllEditing();

        // 备份当前选项
        _backupOptions[option.TempId] = option.Clone();
        option.IsEditing = true;
    }

    private void SaveOption(EnumOptionViewModel option)
    {
        // 验证
        if (string.IsNullOrWhiteSpace(option.Value))
        {
            ToastService.Error(I18n.T("MSG_OPTION_VALUE_REQUIRED"));
            return;
        }

        // 检查值的唯一性
        var duplicate = _options.FirstOrDefault(o =>
            o.TempId != option.TempId &&
            o.Value.Equals(option.Value, StringComparison.OrdinalIgnoreCase));

        if (duplicate != null)
        {
            ToastService.Error($"选项值 '{option.Value}' 已存在");
            return;
        }

        option.IsEditing = false;
        _backupOptions.Remove(option.TempId);
    }

    private void CancelEditOption(EnumOptionViewModel option)
    {
        if (_backupOptions.TryGetValue(option.TempId, out var backup))
        {
            // 恢复原值
            var index = _options.IndexOf(option);
            if (index >= 0)
            {
                _options[index] = backup;
            }
            _backupOptions.Remove(option.TempId);
        }
        else
        {
            // 新增选项取消，直接删除
            _options.Remove(option);
        }
    }

    private void DeleteOption(EnumOptionViewModel option)
    {
        _options.Remove(option);
    }

    private void CancelAllEditing()
    {
        foreach (var option in _options.Where(o => o.IsEditing).ToList())
        {
            if (_backupOptions.TryGetValue(option.TempId, out var backup))
            {
                var index = _options.IndexOf(option);
                if (index >= 0)
                {
                    _options[index] = backup;
                }
                _backupOptions.Remove(option.TempId);
            }
            else
            {
                // 新增选项取消
                _options.Remove(option);
            }
        }
    }

    private string GetDisplayName(MultilingualTextDto displayName)
    {
        if (displayName == null || !displayName.Any())
            return "-";

        if (displayName.TryGetValue(I18n.CurrentLang, out var name) && !string.IsNullOrEmpty(name))
            return name;

        return displayName.Values.FirstOrDefault(v => !string.IsNullOrEmpty(v)) ?? "-";
    }

    private void GoBack()
    {
        Nav.NavigateTo("/enums");
    }

    // ViewModel for enum options with editing state
    private class EnumOptionViewModel
    {
        public Guid TempId { get; set; } = Guid.NewGuid();
        public string Value { get; set; } = string.Empty;
        public MultilingualTextDto DisplayName { get; set; } = new();
        public string? ColorTag { get; set; }
        public bool IsEditing { get; set; }

        public EnumOptionViewModel Clone()
        {
            return new EnumOptionViewModel
            {
                TempId = this.TempId,
                Value = this.Value,
                DisplayName = new MultilingualTextDto(this.DisplayName),
                ColorTag = this.ColorTag,
                IsEditing = this.IsEditing
            };
        }
    }
}
