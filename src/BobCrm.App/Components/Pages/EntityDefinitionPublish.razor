@page "/entity-definitions/publish/{Id:guid}"
@rendermode RenderMode.InteractiveServer
@inject BobCrm.App.Services.EntityDefinitionService EntityDefService
@inject NavigationManager Nav
@using BobCrm.App.Models

<AuthChecker>
    <PageHeader Title="实体发布" OnBack="GoBack">
        <PageHeaderExtra>
            <Space>
                @if (!string.IsNullOrEmpty(_entity?.Status) && (_entity.Status == EntityStatus.Draft || _entity.Status == EntityStatus.Modified))
                {
                    <SpaceItem>
                        <Button Type="@ButtonType.Primary" OnClick="HandlePublish" Loading="@_publishing">
                            <Icon Type="upload" /> 发布实体
                        </Button>
                    </SpaceItem>
                }
                <SpaceItem>
                    <Button OnClick="HandleGenerateCode" Loading="@_generatingCode">
                        <Icon Type="code" /> 生成代码
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button OnClick="HandleCompile" Loading="@_compiling">
                        <Icon Type="build" /> 编译
                    </Button>
                </SpaceItem>
            </Space>
        </PageHeaderExtra>
    </PageHeader>

    @if (_loading)
    {
        <div style="text-align: center; padding: 50px;">
            <Spin Size="large" />
        </div>
    }
    else if (_entity != null)
    {
        <Card Title="实体信息" Style="margin-bottom: 16px;">
            <Descriptions Bordered Column="2">
                <DescriptionsItem Title="实体名称">@_entity.EntityName</DescriptionsItem>
                <DescriptionsItem Title="命名空间">@_entity.Namespace</DescriptionsItem>
                <DescriptionsItem Title="完整类型名">@_entity.FullTypeName</DescriptionsItem>
                <DescriptionsItem Title="状态">
                    @if (_entity.Status == EntityStatus.Draft)
                    {
                        <Tag Color="orange">草稿</Tag>
                    }
                    else if (_entity.Status == EntityStatus.Published)
                    {
                        <Tag Color="green">已发布</Tag>
                    }
                    else if (_entity.Status == EntityStatus.Modified)
                    {
                        <Tag Color="blue">已修改</Tag>
                    }
                </DescriptionsItem>
                <DescriptionsItem Title="来源">
                    <Tag Color="@(_entity.Source == EntitySource.System ? "blue" : "green")">
                        @_entity.Source
                    </Tag>
                </DescriptionsItem>
                <DescriptionsItem Title="是否锁定">
                    @(_entity.IsLocked ? "是" : "否")
                </DescriptionsItem>
                <DescriptionsItem Title="字段数">@_entity.Fields.Count</DescriptionsItem>
                <DescriptionsItem Title="接口数">@_entity.Interfaces.Count</DescriptionsItem>
            </Descriptions>
        </Card>

        <Tabs DefaultActiveKey="ddl">
            <TabPane Key="ddl" Tab="DDL脚本">
                <Card Title="DDL预览" Style="margin-bottom: 16px;">
                    <Extra>
                        <Button OnClick="LoadDDLPreview" Size="@ButtonSize.Small">
                            <Icon Type="reload" /> 刷新
                        </Button>
                    </Extra>
                    <Body>
                        @if (_loadingDDL)
                        {
                            <Spin />
                        }
                        else if (!string.IsNullOrEmpty(_ddlScript))
                        {
                            <pre style="background: #f5f5f5; padding: 16px; border-radius: 4px; overflow-x: auto;">@_ddlScript</pre>
                        }
                        else
                        {
                            <Empty Description="@("暂无DDL脚本")" />
                        }
                    </Body>
                </Card>

                <Card Title="DDL历史">
                    <Table TItem="DDLHistoryDto" DataSource="@_ddlHistory" Loading="@_loadingHistory" Size="@TableSize.Small">
                        <PropertyColumn Property="h => h.ScriptType" Title="类型">
                            <Tag>@context.ScriptType</Tag>
                        </PropertyColumn>
                        <PropertyColumn Property="h => h.Status" Title="状态">
                            @if (context.Status == "Success")
                            {
                                <Tag Color="green">成功</Tag>
                            }
                            else if (context.Status == "Failed")
                            {
                                <Tag Color="red">失败</Tag>
                            }
                            else
                            {
                                <Tag Color="orange">@context.Status</Tag>
                            }
                        </PropertyColumn>
                        <PropertyColumn Property="h => h.CreatedAt" Title="创建时间" Format="yyyy-MM-dd HH:mm:ss" />
                        <PropertyColumn Property="h => h.ExecutedAt" Title="执行时间" Format="yyyy-MM-dd HH:mm:ss" />
                        <PropertyColumn Property="h => h.CreatedBy" Title="创建人" />
                        <PropertyColumn Property="h => h.ScriptPreview" Title="脚本预览">
                            <Text Ellipsis>@context.ScriptPreview</Text>
                        </PropertyColumn>
                    </Table>
                </Card>
            </TabPane>

            <TabPane Key="code" Tab="生成代码">
                <Card>
                    @if (!string.IsNullOrEmpty(_generatedCode))
                    {
                        <pre style="background: #f5f5f5; padding: 16px; border-radius: 4px; overflow-x: auto; max-height: 600px;">@_generatedCode</pre>
                    }
                    else
                    {
                        <Empty Description='@("点击\"生成代码\"按钮查看")' />
                    }
                </Card>
            </TabPane>

            <TabPane Key="compilation" Tab="编译状态">
                <Card>
                    @if (_compilationResult != null)
                    {
                        <Result Status="@(_compilationResult.Success ? "success" : "error")"
                                Title="@(_compilationResult.Success ? "编译成功" : "编译失败")"
                                SubTitle="@_compilationResult.Message">
                            <Extra>
                                @if (_compilationResult.Success)
                                {
                                    <Descriptions Bordered>
                                        <DescriptionsItem Title="程序集">@_compilationResult.AssemblyName</DescriptionsItem>
                                        <DescriptionsItem Title="加载的类型">
                                            @foreach (var type in _compilationResult.LoadedTypes)
                                            {
                                                <Tag>@type</Tag>
                                            }
                                        </DescriptionsItem>
                                    </Descriptions>
                                }
                                else if (_compilationResult.Errors.Any())
                                {
                                    <Alert Type="@AlertType.Error" Message="编译错误" ShowIcon="true">
                                        <MessageTemplate>
                                            <ul>
                                                @foreach (var error in _compilationResult.Errors)
                                                {
                                                    <li>
                                                        <strong>[@error.Code]</strong> 第@error.Line行,第@error.Column列: @error.Message
                                                    </li>
                                                }
                                            </ul>
                                        </MessageTemplate>
                                    </Alert>
                                }
                            </Extra>
                        </Result>
                    }
                    else
                    {
                        <Empty Description='@("点击\"编译\"按钮查看")' />
                    }
                </Card>
            </TabPane>
        </Tabs>
    }
</AuthChecker>

@code {
    [Parameter] public Guid Id { get; set; }
    [Inject] private IMessageService MessageService { get; set; } = default!;

    private bool _loading = false;
    private bool _loadingDDL = false;
    private bool _loadingHistory = false;
    private bool _publishing = false;
    private bool _generatingCode = false;
    private bool _compiling = false;

    private EntityDefinitionDto? _entity;
    private string _ddlScript = string.Empty;
    private List<DDLHistoryDto> _ddlHistory = new();
    private string _generatedCode = string.Empty;
    private CompilationResponse? _compilationResult;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntity();
        await LoadDDLPreview();
        await LoadDDLHistory();
    }

    private async Task LoadEntity()
    {
        _loading = true;
        try
        {
            _entity = await EntityDefService.GetByIdAsync(Id);
        }
        catch (Exception ex)
        {
            await MessageService.Error($"加载失败: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadDDLPreview()
    {
        _loadingDDL = true;
        try
        {
            var preview = await EntityDefService.PreviewDDLAsync(Id);
            _ddlScript = preview?.DDLScript ?? string.Empty;
        }
        catch (Exception ex)
        {
            await MessageService.Error($"加载DDL失败: {ex.Message}");
        }
        finally
        {
            _loadingDDL = false;
        }
    }

    private async Task LoadDDLHistory()
    {
        _loadingHistory = true;
        try
        {
            _ddlHistory = await EntityDefService.GetDDLHistoryAsync(Id);
        }
        catch (Exception ex)
        {
            await MessageService.Error($"加载历史失败: {ex.Message}");
        }
        finally
        {
            _loadingHistory = false;
        }
    }

    private async Task HandlePublish()
    {
        _publishing = true;
        try
        {
            PublishResponse? result;
            if (_entity?.Status == EntityStatus.Draft)
            {
                result = await EntityDefService.PublishAsync(Id);
            }
            else
            {
                result = await EntityDefService.PublishChangesAsync(Id);
            }

            if (result?.Success == true)
            {
                await MessageService.Success("发布成功！");
                await LoadEntity();
                await LoadDDLHistory();
            }
            else
            {
                await MessageService.Error($"发布失败: {result?.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            await MessageService.Error($"发布失败: {ex.Message}");
        }
        finally
        {
            _publishing = false;
        }
    }

    private async Task HandleGenerateCode()
    {
        _generatingCode = true;
        try
        {
            var result = await EntityDefService.GenerateCodeAsync(Id);
            _generatedCode = result?.Code ?? string.Empty;
            await MessageService.Success("代码生成成功");
        }
        catch (Exception ex)
        {
            await MessageService.Error($"生成代码失败: {ex.Message}");
        }
        finally
        {
            _generatingCode = false;
        }
    }

    private async Task HandleCompile()
    {
        _compiling = true;
        try
        {
            _compilationResult = await EntityDefService.CompileAsync(Id);
            if (_compilationResult?.Success == true)
            {
                await MessageService.Success("编译成功！");
            }
            else
            {
                await MessageService.Error("编译失败，请查看错误详情");
            }
        }
        catch (Exception ex)
        {
            await MessageService.Error($"编译失败: {ex.Message}");
        }
        finally
        {
            _compiling = false;
        }
    }

    private void GoBack()
    {
        Nav.NavigateTo("/entity-definitions");
    }
}
