@page "/entity-definitions/publish/{Id:guid}"
@rendermode RenderMode.InteractiveServer
@inject BobCrm.App.Services.EntityDefinitionService EntityDefService
@inject BobCrm.App.Services.I18nService I18n
@inject NavigationManager Nav
@using BobCrm.App.Models

<AuthChecker>
    <PageHeader Title="@I18n.T("LBL_ENTITY_PUBLISH")" OnBack="GoBack">
        <PageHeaderExtra>
            <Space>
                @if (!string.IsNullOrEmpty(_entity?.Status) && (_entity.Status == EntityStatus.Draft || _entity.Status == EntityStatus.Modified))
                {
                    <SpaceItem>
                        <Button Type="@ButtonType.Primary" OnClick="HandlePublish" Loading="@_publishing">
                            <Icon Type="upload" /> @I18n.T("BTN_PUBLISH_ENTITY")
                        </Button>
                    </SpaceItem>
                }
                <SpaceItem>
                    <Button OnClick="HandleGenerateCode" Loading="@_generatingCode">
                        <Icon Type="code" /> @I18n.T("BTN_GENERATE_CODE")
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button OnClick="HandleCompile" Loading="@_compiling">
                        <Icon Type="build" /> @I18n.T("BTN_COMPILE")
                    </Button>
                </SpaceItem>
            </Space>
        </PageHeaderExtra>
    </PageHeader>

    @if (_loading)
    {
        <div style="text-align: center; padding: 50px;">
            <Spin Size="large" />
        </div>
    }
    else if (_entity != null)
    {
        <Card Title="@I18n.T("LBL_ENTITY_INFO")" Style="margin-bottom: 16px;">
            <Descriptions Bordered Column="2">
                <DescriptionsItem Title="@I18n.T("LBL_ENTITY_NAME")">@_entity.EntityName</DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("LBL_NAMESPACE")">@_entity.Namespace</DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("LBL_FULL_TYPE_NAME")">@_entity.FullTypeName</DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("LBL_STATUS")">
                    @if (_entity.Status == EntityStatus.Draft)
                    {
                        <Tag Color="orange">@I18n.T("LBL_DRAFT")</Tag>
                    }
                    else if (_entity.Status == EntityStatus.Published)
                    {
                        <Tag Color="green">@I18n.T("LBL_PUBLISHED")</Tag>
                    }
                    else if (_entity.Status == EntityStatus.Modified)
                    {
                        <Tag Color="blue">@I18n.T("LBL_MODIFIED")</Tag>
                    }
                </DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("LBL_SOURCE")">
                    <Tag Color="@(_entity.Source == EntitySource.System ? "blue" : "green")">
                        @_entity.Source
                    </Tag>
                </DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("LBL_IS_LOCKED")">
                    @(_entity.IsLocked ? I18n.T("TXT_YES") : I18n.T("TXT_NO"))
                </DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("LBL_FIELD_COUNT")">@_entity.Fields.Count</DescriptionsItem>
                <DescriptionsItem Title="@I18n.T("LBL_INTERFACE_COUNT")">@_entity.Interfaces.Count</DescriptionsItem>
            </Descriptions>
        </Card>

        <Tabs DefaultActiveKey="ddl">
            <TabPane Key="ddl" Tab="@I18n.T("LBL_DDL_SCRIPT")">
                <Card Title="@I18n.T("LBL_DDL_PREVIEW")" Style="margin-bottom: 16px;">
                    <Extra>
                        <Button OnClick="LoadDDLPreview" Size="@ButtonSize.Small">
                            <Icon Type="reload" /> @I18n.T("BTN_REFRESH")
                        </Button>
                    </Extra>
                    <Body>
                        @if (_loadingDDL)
                        {
                            <Spin />
                        }
                        else if (!string.IsNullOrEmpty(_ddlScript))
                        {
                            <pre style="background: #f5f5f5; padding: 16px; border-radius: 4px; overflow-x: auto;">@_ddlScript</pre>
                        }
                        else
                        {
                            <Empty Description="@I18n.T("MSG_NO_DDL_SCRIPT")" />
                        }
                    </Body>
                </Card>

                <Card Title="@I18n.T("LBL_DDL_HISTORY")">
                    <Table TItem="DDLHistoryDto" DataSource="@_ddlHistory" Loading="@_loadingHistory" Size="@TableSize.Small">
                        <PropertyColumn Property="h => h.ScriptType" Title="@I18n.T("LBL_TYPE")">
                            <Tag>@context.ScriptType</Tag>
                        </PropertyColumn>
                        <PropertyColumn Property="h => h.Status" Title="@I18n.T("LBL_STATUS")">
                            @if (context.Status == "Success")
                            {
                                <Tag Color="green">@I18n.T("LBL_SUCCESS")</Tag>
                            }
                            else if (context.Status == "Failed")
                            {
                                <Tag Color="red">@I18n.T("LBL_FAILED")</Tag>
                            }
                            else
                            {
                                <Tag Color="orange">@context.Status</Tag>
                            }
                        </PropertyColumn>
                        <PropertyColumn Property="h => h.CreatedAt" Title="@I18n.T("LBL_CREATED_TIME")" Format="yyyy-MM-dd HH:mm:ss" />
                        <PropertyColumn Property="h => h.ExecutedAt" Title="@I18n.T("LBL_EXECUTED_TIME")" Format="yyyy-MM-dd HH:mm:ss" />
                        <PropertyColumn Property="h => h.CreatedBy" Title="@I18n.T("LBL_CREATED_BY")" />
                        <PropertyColumn Property="h => h.ScriptPreview" Title="@I18n.T("LBL_SCRIPT_PREVIEW")">
                            <Text Ellipsis>@context.ScriptPreview</Text>
                        </PropertyColumn>
                    </Table>
                </Card>
            </TabPane>

            <TabPane Key="code" Tab="@I18n.T("LBL_GENERATED_CODE")">
                <Card>
                    @if (!string.IsNullOrEmpty(_generatedCode))
                    {
                        <pre style="background: #f5f5f5; padding: 16px; border-radius: 4px; overflow-x: auto; max-height: 600px;">@_generatedCode</pre>
                    }
                    else
                    {
                        <Empty Description="@I18n.T("MSG_CLICK_GENERATE_CODE")" />
                    }
                </Card>
            </TabPane>

            <TabPane Key="compilation" Tab="@I18n.T("LBL_COMPILATION_STATUS")">
                <Card>
                    @if (_compilationResult != null)
                    {
                        <Result Status="@(_compilationResult.Success ? "success" : "error")"
                                Title="@(_compilationResult.Success ? I18n.T("MSG_COMPILATION_SUCCESS") : I18n.T("MSG_COMPILATION_FAILED"))"
                                SubTitle="@_compilationResult.Message">
                            <Extra>
                                @if (_compilationResult.Success)
                                {
                                    <Descriptions Bordered>
                                        <DescriptionsItem Title="@I18n.T("LBL_ASSEMBLY")">@_compilationResult.AssemblyName</DescriptionsItem>
                                        <DescriptionsItem Title="@I18n.T("LBL_LOADED_TYPES")">
                                            @foreach (var type in _compilationResult.LoadedTypes)
                                            {
                                                <Tag>@type</Tag>
                                            }
                                        </DescriptionsItem>
                                    </Descriptions>
                                }
                                else if (_compilationResult.Errors.Any())
                                {
                                    <Alert Type="@AlertType.Error" Message="@I18n.T("MSG_COMPILATION_ERROR")" ShowIcon="true">
                                        <MessageTemplate>
                                            <ul>
                                                @foreach (var error in _compilationResult.Errors)
                                                {
                                                    <li>
                                                        <strong>[@error.Code]</strong> @I18n.T("LBL_LINE")@error.Line@I18n.T("LBL_COLUMN")@error.Column: @error.Message
                                                    </li>
                                                }
                                            </ul>
                                        </MessageTemplate>
                                    </Alert>
                                }
                            </Extra>
                        </Result>
                    }
                    else
                    {
                        <Empty Description="@I18n.T("MSG_CLICK_COMPILE")" />
                    }
                </Card>
            </TabPane>
        </Tabs>
    }
</AuthChecker>

@code {
    [Parameter] public Guid Id { get; set; }
    [CascadingParameter] public int I18nRenderVersion { get; set; }
    [Inject] private IMessageService MessageService { get; set; } = default!;

    private bool _loading = false;
    private bool _loadingDDL = false;
    private bool _loadingHistory = false;
    private bool _publishing = false;
    private bool _generatingCode = false;
    private bool _compiling = false;
    private int _lastI18nRenderVersion = -1;

    private EntityDefinitionDto? _entity;
    private string _ddlScript = string.Empty;
    private List<DDLHistoryDto> _ddlHistory = new();
    private string _generatedCode = string.Empty;
    private CompilationResponse? _compilationResult;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntity();
        await LoadDDLPreview();
        await LoadDDLHistory();
    }

    protected override void OnParametersSet()
    {
        if (_lastI18nRenderVersion != I18nRenderVersion)
        {
            _lastI18nRenderVersion = I18nRenderVersion;
            StateHasChanged();
        }
    }

    private async Task LoadEntity()
    {
        _loading = true;
        try
        {
            _entity = await EntityDefService.GetByIdAsync(Id);
        }
        catch (Exception ex)
        {
            await MessageService.Error($"{I18n.T("MSG_LOAD_FAILED")}: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadDDLPreview()
    {
        _loadingDDL = true;
        try
        {
            var preview = await EntityDefService.PreviewDDLAsync(Id);
            _ddlScript = preview?.DDLScript ?? string.Empty;
        }
        catch (Exception ex)
        {
            await MessageService.Error($"{I18n.T("MSG_LOAD_DDL_FAILED")}: {ex.Message}");
        }
        finally
        {
            _loadingDDL = false;
        }
    }

    private async Task LoadDDLHistory()
    {
        _loadingHistory = true;
        try
        {
            _ddlHistory = await EntityDefService.GetDDLHistoryAsync(Id);
        }
        catch (Exception ex)
        {
            await MessageService.Error($"{I18n.T("MSG_LOAD_HISTORY_FAILED")}: {ex.Message}");
        }
        finally
        {
            _loadingHistory = false;
        }
    }

    private async Task HandlePublish()
    {
        _publishing = true;
        try
        {
            PublishResponse? result;
            if (_entity?.Status == EntityStatus.Draft)
            {
                result = await EntityDefService.PublishAsync(Id);
            }
            else
            {
                result = await EntityDefService.PublishChangesAsync(Id);
            }

            if (result?.Success == true)
            {
                await MessageService.Success(I18n.T("MSG_PUBLISH_SUCCESS"));
                await LoadEntity();
                await LoadDDLHistory();
            }
            else
            {
                await MessageService.Error($"{I18n.T("MSG_PUBLISH_FAILED")}: {result?.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            await MessageService.Error($"{I18n.T("MSG_PUBLISH_FAILED")}: {ex.Message}");
        }
        finally
        {
            _publishing = false;
        }
    }

    private async Task HandleGenerateCode()
    {
        _generatingCode = true;
        try
        {
            var result = await EntityDefService.GenerateCodeAsync(Id);
            _generatedCode = result?.Code ?? string.Empty;
            await MessageService.Success(I18n.T("MSG_CODE_GENERATION_SUCCESS"));
        }
        catch (Exception ex)
        {
            await MessageService.Error($"{I18n.T("MSG_CODE_GENERATION_FAILED")}: {ex.Message}");
        }
        finally
        {
            _generatingCode = false;
        }
    }

    private async Task HandleCompile()
    {
        _compiling = true;
        try
        {
            _compilationResult = await EntityDefService.CompileAsync(Id);
            if (_compilationResult?.Success == true)
            {
                await MessageService.Success(I18n.T("MSG_COMPILATION_SUCCESS"));
            }
            else
            {
                await MessageService.Error(I18n.T("MSG_COMPILATION_FAILED_DETAIL"));
            }
        }
        catch (Exception ex)
        {
            await MessageService.Error($"{I18n.T("MSG_COMPILATION_FAILED")}: {ex.Message}");
        }
        finally
        {
            _compiling = false;
        }
    }

    private void GoBack()
    {
        Nav.NavigateTo("/entity-definitions");
    }
}
