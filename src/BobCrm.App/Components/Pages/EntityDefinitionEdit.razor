@page "/entity-definitions/create"
@page "/entity-definitions/edit/{Id:guid}"
@rendermode RenderMode.InteractiveServer
@inject BobCrm.App.Services.EntityDefinitionService EntityDefService
@inject BobCrm.App.Services.EntityDomainService DomainService
@inject BobCrm.App.Services.EnumDefinitionService EnumService
@inject BobCrm.App.Services.I18nService I18n
@inject BobCrm.App.Services.ToastService ToastService
@inject NavigationManager Nav
@using BobCrm.App.Models
@using BobCrm.App.Services.Multilingual
@using System.Globalization
@using System.Net.Http.Json
@using System.Linq
@using AntDesign
@using BobCrm.Api.Contracts.DTOs
@inject IMultilingualTextResolver MultilingualResolver
@inject BobCrm.App.Services.AuthService Auth

<AuthChecker>
    <PageHeader Title="@(_isNew ? I18n.T("LBL_CREATE_ENTITY_DEF") : I18n.T("LBL_EDIT_ENTITY_DEF"))" OnBack="GoBack">
        <PageHeaderExtra>
            <Space>
                <SpaceItem>
                    <Button OnClick="HandleSave" Type="@ButtonType.Primary" Loading="@_saving">
                        <Icon Type="save" /> @I18n.T("BTN_SAVE")
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button OnClick="GoBack">
                        @I18n.T("BTN_CANCEL")
                    </Button>
                </SpaceItem>
            </Space>
        </PageHeaderExtra>
    </PageHeader>

    @if (_loading)
    {
        <div style="text-align: center; padding: 50px;">
            <Spin Size="@SpinSize.Large" />
        </div>
    }
    else
    {
        <Card Class="entity-section-card">
            <div class="entity-section-toggle" role="button" tabindex="0" @onclick="ToggleEntityInfoPanel">
                <span>@I18n.T("LBL_ENTITY_INFO")</span>
                <Icon Type="@(_entityInfoExpanded ? "up" : "down")" />
            </div>
            @if (_entityInfoExpanded)
            {
                <Form Model="@_model" LabelColSpan="4" WrapperColSpan="20">
                        <FormItem Label="@I18n.T("LBL_DOMAIN")">
                            <Select TItemValue="string" TItem="string"
                                    Value="_model.Category"
                                    ValueChanged="OnDomainChanged"
                                    ValueExpression="() => _model.Category"
                                    Disabled="@(_domainOptions.Count == 0)"
                                    Style="width: 220px;">
                                @foreach (var option in _domainOptions)
                                {
                                    var label = MultilingualResolver.Resolve(option.Name, option.Code);
                                    <SelectOption TItemValue="string" TItem="string" Value="@option.Code" Label="@label">
                                        <ChildContent Context="optionContent">@label</ChildContent>
                                    </SelectOption>
                                }
                            </Select>
                            <div class="ant-form-text">
                                @I18n.T("TXT_DOMAIN_HINT")
                            </div>
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_ENTITY_NAME")">
                            <Input Value="@EntityNameInput"
                                   ValueExpression="() => EntityNameInput"
                                   OnInput="HandleEntityNameInput"
                                   Disabled="@(!_isNew)"
                                   Placeholder="@I18n.T("TXT_ENTITY_NAME_PLACEHOLDER")"
                                   Class="field-control" />
                            <div class="ant-form-text">
                                @I18n.T("TXT_ENTITY_NAME_HINT")
                            </div>
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_NAMESPACE")">
                            <Input Value="@_model.Namespace"
                                   ValueExpression="() => _model.Namespace"
                                   ReadOnly="true"
                                   Placeholder="@I18n.T("TXT_NAMESPACE_PLACEHOLDER")"
                                   Class="field-control" />
                            <div class="ant-form-text">
                                @I18n.T("TXT_NAMESPACE_AUTO_HINT")
                            </div>
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_DISPLAY_NAME")">
                            <MultilingualInput @bind-Value="@_model.DisplayName" />
                            <div class="ant-form-text">
                                @I18n.T("TXT_MULTILINGUAL_DISPLAY_NAME_HINT")
                            </div>
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_DESCRIPTION")">
                            <MultilingualInput @bind-Value="@_model.Description" />
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_STRUCTURE_TYPE")">
                            <RadioGroup @bind-Value="@_model.StructureType" Disabled="@(!_isNew)">
                                <Radio Value="@("Single")">@I18n.T("LBL_SINGLE_ENTITY")</Radio>
                                <Radio Value="@("MasterDetail")">@I18n.T("LBL_MASTER_DETAIL_ENTITY")</Radio>
                                <Radio Value="@("MasterDetailGrandchild")">@I18n.T("LBL_MASTER_DETAIL_GRANDCHILD_ENTITY")</Radio>
                            </RadioGroup>
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_INTERFACES")">
                            <Space Direction="@SpaceDirection.Vertical" Size="@SpaceSize.Middle">
                                <SpaceItem>
                                    <Checkbox @bind-Value="@IsBaseSelected" Disabled="@(!_isNew)">
                                        <strong>@I18n.T("INTERFACE_BASE")</strong>
                                        <span class="interface-hint">@I18n.T("INTERFACE_BASE_DESC")</span>
                                    </Checkbox>
                                </SpaceItem>
                                <SpaceItem>
                                    <Checkbox @bind-Value="@IsArchiveSelected" Disabled="@(!_isNew)">
                                        <strong>@I18n.T("INTERFACE_ARCHIVE")</strong>
                                        <span class="interface-hint">@I18n.T("INTERFACE_ARCHIVE_DESC")</span>
                                    </Checkbox>
                                </SpaceItem>
                                <SpaceItem>
                                    <Checkbox @bind-Value="@IsAuditSelected" Disabled="@(!_isNew)">
                                        <strong>@I18n.T("INTERFACE_AUDIT")</strong>
                                        <span class="interface-hint">@I18n.T("INTERFACE_AUDIT_DESC")</span>
                                    </Checkbox>
                                </SpaceItem>
                                <SpaceItem>
                                    <Checkbox @bind-Value="@IsOrganizationSelected" Disabled="@(!_isNew)">
                                        <strong>@I18n.T("INTERFACE_ORGANIZATION")</strong>
                                        <span class="interface-hint">@I18n.T("INTERFACE_ORGANIZATION_DESC")</span>
                                    </Checkbox>
                                </SpaceItem>
                                <SpaceItem>
                                    <Checkbox @bind-Value="@IsVersionSelected" Disabled="@(!_isNew)">
                                        <strong>@I18n.T("INTERFACE_VERSION")</strong>
                                        <span class="interface-hint">@I18n.T("INTERFACE_VERSION_DESC")</span>
                                    </Checkbox>
                                </SpaceItem>
                                <SpaceItem>
                                    <Checkbox @bind-Value="@IsTimeVersionSelected" Disabled="@(!_isNew)">
                                        <strong>@I18n.T("INTERFACE_TIME_VERSION")</strong>
                                        <span class="interface-hint">@I18n.T("INTERFACE_TIME_VERSION_DESC")</span>
                                    </Checkbox>
                                </SpaceItem>
                                <div class="interface-tip">@I18n.T("TXT_INTERFACE_AUTO_FIELDS_TIP")</div>
                            </Space>
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_ICON")">
                            <div class="icon-input-wrapper">
                                <div class="icon-input-column">
                                    <Input @bind-Value="@_model.Icon"
                                           Placeholder="@I18n.T("TXT_ICON_FIELD_PLACEHOLDER")"
                                           Class="field-control" />
                                    <div class="interface-tip icon-help-tip">
                                        <div>@I18n.T("TXT_ICON_FIELD_HINT_ANTD")</div>
                                        <div>@I18n.T("TXT_ICON_FIELD_HINT_URL")</div>
                                    </div>
                                </div>
                                <div class="icon-preview-box">
                                    @if (IsIconUrl(_model.Icon))
                                    {
                                        <img src="@_model.Icon" alt="icon preview" class="icon-preview-img" />
                                    }
                                    else
                                    {
                                        <Icon Type="@GetIconName()" Style="font-size: 20px; color: #1890ff;" />
                                    }
                                </div>
                            </div>
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_SORT_ORDER")">
                            <AntDesign.InputNumber TValue="int" @bind-Value="@_model.Order" Min="0" />
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_ENABLED")">
                            <Switch @bind-Value="@_model.IsEnabled" />
                        </FormItem>
                </Form>
            }
        </Card>

        <Card Title="@I18n.T("LBL_FIELD_DEFINITION")" Class="entity-section-card" Style="margin-top: 16px;">
            <Extra>
                <Button OnClick="AddFieldRow" Type="@ButtonType.Dashed" Size="@ButtonSize.Small">
                    <Icon Type="plus" /> @I18n.T("BTN_ADD_FIELD")
                </Button>
            </Extra>
            <Body>
                <div class="field-editor-table">
                    <table class="ant-table">
                        <thead>
                            <tr>
                                <th>@I18n.T("LBL_PROPERTY_NAME")</th>
                                <th>@I18n.T("LBL_DISPLAY_NAME")</th>
                                <th>@I18n.T("LBL_DATA_TYPE")</th>
                                <th>@I18n.T("LBL_LENGTH")</th>
                                <th>@I18n.T("LBL_PRECISION")</th>
                                <th>@I18n.T("LBL_SCALE")</th>
                                <th>@I18n.T("LBL_REQUIRED")</th>
                                <th>@I18n.T("LBL_DEFAULT_VALUE")</th>
                                <th>@I18n.T("LBL_SORT_ORDER")</th>
                                <th>@I18n.T("LBL_SOURCE")</th>
                                <th>@I18n.T("LBL_ACTIONS")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (_model.Fields != null)
                            {
                                foreach (var field in _model.Fields)
                                {
                                    var isProtected = IsProtectedField(field);
                                    var sourceLabel = GetFieldSourceLabel(field);
                                    <tr>
                                        <td>
                                            <Input @bind-Value="field.PropertyName"
                                                   Disabled="@isProtected"
                                                   Placeholder="Code"
                                                   Class="field-control" />
                                        </td>
                                        <td class="field-display-name">
                                            <MultilingualInput Value="field.DisplayName"
                                                               ValueChanged="value => OnFieldDisplayNameChanged(field, value)"
                                                               DefaultLanguage="@I18n.CurrentLang" />
                                        </td>
                                        <td>
                                            <Select TItemValue="string" TItem="string"
                                                    Value="field.DataType"
                                                    ValueChanged="value => OnFieldDataTypeChanged(field, value)"
                                                    ValueExpression="() => field.DataType"
                                                    Disabled="@isProtected"
                                                    Style="width: 140px;">
                                                <SelectOptions>
                                                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.String" Label="String"><ChildContent Context="opt">String</ChildContent></SelectOption>
                                                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.Integer" Label="Integer"><ChildContent Context="opt">Integer</ChildContent></SelectOption>
                                                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.Long" Label="Long"><ChildContent Context="opt">Long</ChildContent></SelectOption>
                                                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.Decimal" Label="Decimal"><ChildContent Context="opt">Decimal</ChildContent></SelectOption>
                                                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.Boolean" Label="Boolean"><ChildContent Context="opt">Boolean</ChildContent></SelectOption>
                                                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.DateTime" Label="DateTime"><ChildContent Context="opt">DateTime</ChildContent></SelectOption>
                                                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.Date" Label="Date"><ChildContent Context="opt">Date</ChildContent></SelectOption>
                                                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.Text" Label="Text"><ChildContent Context="opt">Text</ChildContent></SelectOption>
                                                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.Guid" Label="Guid"><ChildContent Context="opt">Guid</ChildContent></SelectOption>
                                                </SelectOptions>
                                            </Select>
                                        </td>
                                        <td>
                                            <AntDesign.InputNumber TValue="int?" @bind-Value="field.Length"
                                                                    Disabled="@isProtected"
                                                                    Placeholder="-" Style="width: 100px;" />
                                        </td>
                                        <td>
                                            <AntDesign.InputNumber TValue="int?" @bind-Value="field.Precision"
                                                                    Disabled="@isProtected"
                                                                    Placeholder="-" Style="width: 100px;" />
                                        </td>
                                        <td>
                                            <AntDesign.InputNumber TValue="int?" @bind-Value="field.Scale"
                                                                    Disabled="@isProtected"
                                                                    Placeholder="-" Style="width: 100px;" />
                                        </td>
                                        <td class="field-required">
                                            <Switch @bind-Value="field.IsRequired"
                                                    Disabled="@isProtected" />
                                        </td>
                                        <td>
                                            <Input @bind-Value="field.DefaultValue"
                                                   Disabled="@isProtected"
                                                   Placeholder="@I18n.T("TXT_DEFAULT_VALUE_HINT")"
                                                   Class="field-control" />
                                        </td>
                                        <td>
                                            <AntDesign.InputNumber TValue="int" @bind-Value="field.SortOrder"
                                                                    Disabled="@isProtected"
                                                                    Min="0" Style="width: 100px;" />
                                        </td>
                                        <td>
                                            <Tag>@sourceLabel</Tag>
                                        </td>
                                        <td>
                                            <Button Danger Size="@ButtonSize.Small"
                                                    Disabled="@isProtected"
                                                    OnClick="async () => await RequestFieldDeletion(field)">
                                                @I18n.T("BTN_DELETE")
                                            </Button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </Body>
        </Card>

        @* 子实体管理（仅MasterDetail和MasterDetailGrandchild结构） *@
        @if (_model.StructureType == "MasterDetail" || _model.StructureType == "MasterDetailGrandchild")
        {
            <Card Title="@I18n.T("LBL_SUB_ENTITY_MANAGEMENT")" Class="entity-section-card" Style="margin-top: 16px;">
                <Body>
                    <SubEntityTabs SubEntities="@_subEntities"
                                  OnSubEntityAdded="@HandleSubEntityAdded"
                                  OnSubEntityRemoved="@HandleSubEntityRemoved"
                                  OnFieldChanged="@HandleFieldChanged"
                                  OnFieldAdded="@HandleFieldAdded"
                                  OnFieldRemoved="@HandleFieldRemoved" />
                </Body>
            </Card>
        }
    }
</AuthChecker>

@code {
    [Parameter] public Guid? Id { get; set; }
    [CascadingParameter] public int I18nRenderVersion { get; set; }
    [Inject] private IMessageService MessageService { get; set; } = default!;
    [Inject] private ModalService ModalService { get; set; } = default!;

    private bool _isNew => !Id.HasValue;
    private bool _loading = false;
    private bool _saving = false;
    private int _lastI18nRenderVersion = -1;
    private const string DefaultIconType = "appstore";
    private const string NamespaceRoot = "BobCrm.";
    private const string SystemNamespacePrefix = "BobCrm.Api.";
    private const int DefaultStringLength = 50;
    private const int DefaultDecimalPrecision = 18;
    private const int DefaultDecimalScale = 2;
    private const string ResourceKeyFieldDefaultName = "TXT_FIELD_DEFAULT_NAME";
    private const string ResourceKeyFieldId = "LBL_FIELD_ID";
    private const string ResourceKeyFieldIsDeleted = "LBL_FIELD_IS_DELETED";
    private const string ResourceKeyFieldDeletedAt = "LBL_FIELD_DELETED_AT";
    private const string ResourceKeyFieldDeletedBy = "LBL_FIELD_DELETED_BY";
    private const string ResourceKeyFieldCode = "LBL_FIELD_CODE";
    private const string ResourceKeyFieldName = "LBL_FIELD_NAME";
    private const string ResourceKeyFieldCreatedAt = "LBL_FIELD_CREATED_AT";
    private const string ResourceKeyFieldCreatedBy = "LBL_FIELD_CREATED_BY";
    private const string ResourceKeyFieldUpdatedAt = "LBL_FIELD_UPDATED_AT";
    private const string ResourceKeyFieldUpdatedBy = "LBL_FIELD_UPDATED_BY";
    private const string ResourceKeyFieldVersion = "LBL_FIELD_VERSION";
    private const string ResourceKeyFieldValidFrom = "LBL_FIELD_VALID_FROM";
    private const string ResourceKeyFieldValidTo = "LBL_FIELD_VALID_TO";
    private const string ResourceKeyFieldVersionNo = "LBL_FIELD_VERSION_NO";
    private const string ResourceKeyFieldOrganizationId = "LBL_FIELD_ORGANIZATION_ID";
    private static readonly HashSet<string> RequiredResourceKeys = new(StringComparer.OrdinalIgnoreCase)
    {
        ResourceKeyFieldDefaultName,
        ResourceKeyFieldId,
        ResourceKeyFieldIsDeleted,
        ResourceKeyFieldDeletedAt,
        ResourceKeyFieldDeletedBy,
        ResourceKeyFieldCode,
        ResourceKeyFieldName,
        ResourceKeyFieldCreatedAt,
        ResourceKeyFieldCreatedBy,
        ResourceKeyFieldUpdatedAt,
        ResourceKeyFieldUpdatedBy,
        ResourceKeyFieldVersion,
        ResourceKeyFieldValidFrom,
        ResourceKeyFieldValidTo,
        ResourceKeyFieldVersionNo,
        ResourceKeyFieldOrganizationId
    };
    private bool _entityInfoExpanded = true;
    private string[] _languageCodes = Array.Empty<string>();
    private bool _interfaceTemplatesInitialized;
    private Dictionary<string, List<InterfaceFieldTemplate>> _interfaceFieldTemplates = new(StringComparer.OrdinalIgnoreCase);
    private readonly Dictionary<string, Dictionary<string, string>> _resourceCache = new(StringComparer.OrdinalIgnoreCase);
    private readonly Dictionary<string, string> _interfaceFieldOwnership = new(StringComparer.OrdinalIgnoreCase);
    private List<EntityDomainDto> _domainOptions = new();
    private List<EnumDefinitionDto> _enumDefinitions = new();

    private async Task EnsureLanguagesAsync()
    {
        if (_languageCodes.Length > 0)
        {
            return;
        }

        try
        {
            var http = await Auth.CreateClientWithLangAsync();
            var apiLanguages = await http.GetFromJsonAsync<List<ApiLanguageDto>>("/api/i18n/languages");
            if (apiLanguages != null && apiLanguages.Count > 0)
            {
                _languageCodes = apiLanguages
                    .Where(l => !string.IsNullOrWhiteSpace(l.code))
                    .Select(l => l.code.ToLowerInvariant())
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .ToArray();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[EntityDefinitionEdit] Failed to load languages: {ex.Message}");
        }
    }

    private async Task EnsureLocalizationResourcesAsync()
    {
        if (_resourceCache.Count >= RequiredResourceKeys.Count)
        {
            return;
        }

        try
        {
            var http = await Auth.CreateAuthedClientAsync();
            var resources = await http.GetFromJsonAsync<List<LocalizationResourceDto>>("/api/i18n/resources");
            if (resources == null || resources.Count == 0)
            {
                return;
            }

            foreach (var resource in resources)
            {
                if (string.IsNullOrWhiteSpace(resource.Key)
                    || resource.Translations == null
                    || !RequiredResourceKeys.Contains(resource.Key))
                {
                    continue;
                }

                _resourceCache[resource.Key] = new Dictionary<string, string>(resource.Translations, StringComparer.OrdinalIgnoreCase);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[EntityDefinitionEdit] Failed to load localization resources: {ex.Message}");
        }
    }

    private IReadOnlyList<string> GetLanguageCodes() => _languageCodes;

    private async Task LoadDomainsAsync()
    {
        try
        {
            var domains = await DomainService.GetAllAsync();
            _domainOptions = domains
                .OrderBy(d => d.SortOrder)
                .ThenBy(d => d.Code, StringComparer.OrdinalIgnoreCase)
                .ToList();
            EnsureDefaultDomainSelection();
        }
        catch (Exception ex)
        {
            _domainOptions.Clear();
            MessageService.Error($"{I18n.T("MSG_DOMAIN_LOAD_FAILED")}: {ex.Message}");
        }
    }

    private async Task LoadEnumDefinitionsAsync()
    {
        try
        {
            _enumDefinitions = await EnumService.GetAllAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[EntityDefinitionEdit] Failed to load enum definitions: {ex.Message}");
        }
    }

    private void EnsureDefaultDomainSelection()
    {
        if (_domainOptions.Count == 0)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(_model.Category)
            || !_domainOptions.Any(d => string.Equals(d.Code, _model.Category, StringComparison.OrdinalIgnoreCase)))
        {
            _model.Category = _domainOptions.First().Code;
        }
    }

    private void EnsureInterfaceTemplatesInitialized()
    {
        if (_interfaceTemplatesInitialized)
        {
            return;
        }

        _interfaceFieldTemplates = BuildInterfaceFieldTemplates();
        _interfaceTemplatesInitialized = true;
    }

    private Dictionary<string, List<InterfaceFieldTemplate>> BuildInterfaceFieldTemplates()
    {
        return new Dictionary<string, List<InterfaceFieldTemplate>>(StringComparer.OrdinalIgnoreCase)
        {
            [EntityInterfaceType.Base] = new()
            {
                Template("Id", FieldDataType.Guid, isRequired: true, label: CreateLabelFromResource(ResourceKeyFieldId)),
                Template("IsDeleted", FieldDataType.Boolean, label: CreateLabelFromResource(ResourceKeyFieldIsDeleted)),
                Template("DeletedAt", FieldDataType.DateTime, label: CreateLabelFromResource(ResourceKeyFieldDeletedAt)),
                Template("DeletedBy", FieldDataType.String, length: 64, label: CreateLabelFromResource(ResourceKeyFieldDeletedBy))
            },
            [EntityInterfaceType.Archive] = new()
            {
                Template("Code", FieldDataType.String, isRequired: true, length: 64, label: CreateLabelFromResource(ResourceKeyFieldCode)),
                Template("Name", FieldDataType.String, isRequired: true, length: 200, label: CreateLabelFromResource(ResourceKeyFieldName))
            },
            [EntityInterfaceType.Audit] = new()
            {
                Template("CreatedAt", FieldDataType.DateTime, isRequired: true, label: CreateLabelFromResource(ResourceKeyFieldCreatedAt)),
                Template("CreatedBy", FieldDataType.String, length: 64, label: CreateLabelFromResource(ResourceKeyFieldCreatedBy)),
                Template("UpdatedAt", FieldDataType.DateTime, isRequired: true, label: CreateLabelFromResource(ResourceKeyFieldUpdatedAt)),
                Template("UpdatedBy", FieldDataType.String, length: 64, label: CreateLabelFromResource(ResourceKeyFieldUpdatedBy))
            },
            [EntityInterfaceType.Version] = new()
            {
                Template("Version", FieldDataType.Integer, isRequired: true, label: CreateLabelFromResource(ResourceKeyFieldVersion))
            },
            [EntityInterfaceType.TimeVersion] = new()
            {
                Template("ValidFrom", FieldDataType.DateTime, isRequired: true, label: CreateLabelFromResource(ResourceKeyFieldValidFrom)),
                Template("ValidTo", FieldDataType.DateTime, isRequired: true, label: CreateLabelFromResource(ResourceKeyFieldValidTo)),
                Template("VersionNo", FieldDataType.Integer, isRequired: true, label: CreateLabelFromResource(ResourceKeyFieldVersionNo))
            },
            [EntityInterfaceType.Organization] = new()
            {
                Template("OrganizationId", FieldDataType.Guid, isRequired: true, label: CreateLabelFromResource(ResourceKeyFieldOrganizationId), isEntityRef: true, referenceTable: "OrganizationNodes")
            }
        };
    }

    private EditModel _model = new();
    private string[] _selectedInterfaces = Array.Empty<string>();
    private List<SubEntityViewModel> _subEntities = new();

    // Checkbox 绑定属性
    private bool IsBaseSelected
    {
        get => _selectedInterfaces.Contains("Base");
        set => UpdateInterfaceSelection("Base", value);
    }

    private bool IsArchiveSelected
    {
        get => _selectedInterfaces.Contains("Archive");
        set => UpdateInterfaceSelection("Archive", value);
    }

    private bool IsAuditSelected
    {
        get => _selectedInterfaces.Contains("Audit");
        set => UpdateInterfaceSelection("Audit", value);
    }

    private bool IsOrganizationSelected
    {
        get => _selectedInterfaces.Contains(EntityInterfaceType.Organization);
        set => UpdateInterfaceSelection(EntityInterfaceType.Organization, value);
    }

    private bool IsVersionSelected
    {
        get => _selectedInterfaces.Contains("Version");
        set => UpdateInterfaceSelection("Version", value);
    }

    private bool IsTimeVersionSelected
    {
        get => _selectedInterfaces.Contains("TimeVersion");
        set => UpdateInterfaceSelection("TimeVersion", value);
    }

    private void UpdateInterfaceSelection(string interfaceType, bool isSelected)
    {
        var list = _selectedInterfaces.ToList();
        if (isSelected && !list.Contains(interfaceType))
        {
            list.Add(interfaceType);
        }
        else if (!isSelected && list.Contains(interfaceType))
        {
            list.Remove(interfaceType);
        }
        _selectedInterfaces = list.ToArray();
        SyncInterfaceFields();
        _ = InvokeAsync(StateHasChanged);
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDomainsAsync();
        await LoadEnumDefinitionsAsync();
        await EnsureLanguagesAsync();
        await EnsureLocalizationResourcesAsync();
        EnsureInterfaceTemplatesInitialized();

        if (!_isNew)
        {
            await LoadEntity();
        }
        else
        {
            // 默认选中Base接口
            _selectedInterfaces = new[] { "Base" };
            SyncInterfaceFields();
            UpdateNamespaceFromEntityName();
        }
    }

    protected override void OnParametersSet()
    {
        if (_lastI18nRenderVersion != I18nRenderVersion)
        {
            _lastI18nRenderVersion = I18nRenderVersion;
            StateHasChanged();
        }
    }

    private async Task LoadEntity()
    {
        _loading = true;
        try
        {
            var entity = await EntityDefService.GetByIdAsync(Id!.Value);
            if (entity != null)
            {
                _model = new EditModel
                {
                    Namespace = entity.Namespace,
                    EntityName = entity.EntityName,
                    DisplayName = entity.DisplayName != null
                        ? new MultilingualTextDto(entity.DisplayName)
                        : new MultilingualTextDto(),
                    Description = entity.Description != null
                        ? new MultilingualTextDto(entity.Description)
                        : null,
                    StructureType = entity.StructureType,
                    Icon = entity.Icon,
                    Order = entity.Order,
                    IsEnabled = entity.IsEnabled,
                    Fields = entity.Fields.Select(f => new FieldMetadataDto
                    {
                        Id = f.Id,
                        PropertyName = f.PropertyName,
                        DisplayName = f.DisplayName != null ? new MultilingualTextDto(f.DisplayName) : new MultilingualTextDto(),
                        DataType = NormalizeDataTypeForUi(f.DataType),
                        Length = f.Length,
                        Precision = f.Precision,
                        Scale = f.Scale,
                        IsRequired = f.IsRequired,
                        IsEntityRef = f.IsEntityRef,
                        ReferencedEntityId = f.ReferencedEntityId,
                        TableName = f.TableName,
                        SortOrder = f.SortOrder,
                        DefaultValue = f.DefaultValue,
                        ValidationRules = f.ValidationRules,
                        Source = f.Source ?? FieldSource.Custom,
                        EnumDefinitionId = f.EnumDefinitionId,
                        IsMultiSelect = f.IsMultiSelect
                    }).ToList()
                };

                EnsureFieldDefaults(_model.Fields);
                _model.Category = ResolveExistingDomain(entity.Category, entity.Namespace);
                EnsureDefaultDomainSelection();
                _selectedInterfaces = entity.Interfaces.Where(i => i.IsEnabled).Select(i => i.InterfaceType).ToArray();
                SyncInterfaceFields();
                EnsureFieldDefaults(_model.Fields);
            }
        }
        catch (Exception ex)
        {
            MessageService.Error($"{I18n.T("MSG_LOAD_FAILED")}: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task HandleSave()
    {
        _saving = true;
        try
        {
            // 验证多语言显示名
            if (_model.DisplayName == null || !_model.DisplayName.HasValue())
            {
                ToastService.Error(I18n.T("MSG_DISPLAY_NAME_REQUIRED"));
                _saving = false;
                return;
            }

            if (!ValidateFields())
            {
                _saving = false;
                return;
            }

            if (_isNew)
            {
                var request = new CreateEntityDefinitionRequest
                {
                    Namespace = _model.Namespace,
                    EntityName = _model.EntityName,
                    DisplayName = _model.DisplayName,
                    Description = _model.Description,
                    Icon = _model.Icon,
                    Category = _model.Category,
                    StructureType = _model.StructureType,
                    Interfaces = _selectedInterfaces.ToList(),
                    Fields = CloneFieldsForApi(_model.Fields)
                };

                await EntityDefService.CreateAsync(request);
                ToastService.Success(I18n.T("MSG_CREATE_SUCCESS"));
            }
            else
            {
                var request = new UpdateEntityDefinitionRequest
                {
                    DisplayName = _model.DisplayName,
                    Description = _model.Description,
                    Icon = _model.Icon,
                    Category = _model.Category,
                    IsEnabled = _model.IsEnabled,
                    Order = _model.Order,
                    Fields = CloneFieldsForApi(_model.Fields),
                    Interfaces = _selectedInterfaces.ToList()
                };

                await EntityDefService.UpdateAsync(Id!.Value, request);
                ToastService.Success(I18n.T("MSG_UPDATE_SUCCESS"));
            }

            GoBack();
        }
        catch (Exception ex)
        {
            ToastService.Error($"{I18n.T("MSG_SAVE_FAILED")}: {ex.Message}");
        }
        finally
        {
            _saving = false;
        }
    }

    private void AddFieldRow()
    {
        if (_model.Fields == null)
        {
            _model.Fields = new List<FieldMetadataDto>();
        }

        var sortOrder = _model.Fields.Any() ? _model.Fields.Max(f => f.SortOrder) + 10 : 100;
        var propertyName = GenerateDefaultFieldName();
        var field = new FieldMetadataDto
        {
            Id = Guid.NewGuid(),
            PropertyName = propertyName,
            DataType = FieldDataType.String,
            IsRequired = false,
            SortOrder = sortOrder,
            Source = FieldSource.Custom
        };

        EnsureFieldDefaults(field);
        _model.Fields.Add(field);
    }

    private void EnsureFieldDefaults(IEnumerable<FieldMetadataDto>? fields)
    {
        if (fields == null)
        {
            return;
        }

        foreach (var field in fields)
        {
            EnsureFieldDefaults(field);
        }
    }

    private void EnsureFieldDefaults(FieldMetadataDto? field)
    {
        if (field == null)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(field.PropertyName))
        {
            field.PropertyName = GenerateDefaultFieldName();
        }

        if (field.DisplayName == null || !field.DisplayName.HasValue())
        {
            field.DisplayName = CreateDefaultDisplayName(field.PropertyName);
        }
        else
        {
            EnsureDisplayNameLanguages(field.DisplayName, field.PropertyName);
        }

        ApplyDataTypeDefaults(field);
    }

    private void EnsureDisplayNameLanguages(MultilingualTextDto? label, string? fallbackHint = null)
    {
        if (label == null)
        {
            return;
        }

        var fallback = !string.IsNullOrWhiteSpace(fallbackHint)
            ? fallbackHint!
            : label.Values.FirstOrDefault(v => !string.IsNullOrWhiteSpace(v)) ?? string.Empty;

        foreach (var code in GetLanguageCodes())
        {
            if (!label.ContainsKey(code))
            {
                label[code] = fallback;
            }
        }
    }

    private Task OnFieldDisplayNameChanged(FieldMetadataDto field, MultilingualTextDto? value)
    {
        field.DisplayName = value ?? new MultilingualTextDto();
        EnsureDisplayNameLanguages(field.DisplayName, field.PropertyName);
        return Task.CompletedTask;
    }

    private void OnFieldDataTypeChanged(FieldMetadataDto field, string? newType)
    {
        if (field == null)
        {
            return;
        }

        field.DataType = newType ?? FieldDataType.String;
        ApplyDataTypeDefaults(field);
    }

    private void ApplyDataTypeDefaults(FieldMetadataDto field)
    {
        if (field == null)
        {
            return;
        }

        var normalizedType = NormalizeDataTypeForApi(field.DataType);

        if (IsStringType(normalizedType))
        {
            field.Length ??= DefaultStringLength;
            field.Precision = null;
            field.Scale = null;
            return;
        }

        if (string.Equals(normalizedType, FieldDataType.Decimal, StringComparison.OrdinalIgnoreCase))
        {
            field.Length = null;

            if (!field.Precision.HasValue || field.Precision.Value <= 0)
            {
                field.Precision = DefaultDecimalPrecision;
            }

            if (!field.Scale.HasValue || field.Scale.Value < 0)
            {
                field.Scale = DefaultDecimalScale;
            }

            if (field.Scale.Value >= field.Precision.Value)
            {
                field.Scale = Math.Max(0, field.Precision.Value - 1);
            }

            return;
        }

        field.Length = null;
        field.Precision = null;
        field.Scale = null;
    }

    private void RemoveField(FieldMetadataDto field)
    {
        if (field == null)
        {
            return;
        }

        // 受保护的字段不能删除（接口字段和系统字段）
        if (IsProtectedField(field))
        {
            return;
        }

        _model.Fields.Remove(field);
    }

    private async Task RequestFieldDeletion(FieldMetadataDto field)
    {
        if (field == null || IsProtectedField(field))
        {
            return;
        }

        var confirmed = await ModalService.ConfirmAsync(new ConfirmOptions
        {
            Title = I18n.T("MSG_CONFIRM_DELETE"),
            Content = I18n.T("TXT_DELETE_FIELD_WARNING"),
            OkText = I18n.T("BTN_DELETE"),
            CancelText = I18n.T("BTN_CANCEL"),
            OkType = ButtonType.Primary,
            Centered = true
        });

        if (confirmed)
        {
            RemoveField(field);
        }
    }

    // 子实体事件处理
    private Task HandleSubEntityAdded(SubEntityViewModel subEntity)
    {
        // 创建新列表引用以触发子组件参数变更检测
        _subEntities = _subEntities.Concat(new[] { subEntity }).ToList();
        return InvokeAsync(StateHasChanged);
    }

    private Task HandleSubEntityRemoved(Guid subEntityId)
    {
        // 创建新列表引用以触发子组件参数变更检测
        _subEntities = _subEntities.Where(s => s.TempId != subEntityId).ToList();
        return InvokeAsync(StateHasChanged);
    }

    private void HandleFieldChanged((Guid SubEntityId, FieldViewModel Field) args)
    {
        // 子实体字段已更新，无需额外处理
        StateHasChanged();
    }

    private void HandleFieldAdded((Guid SubEntityId, FieldViewModel Field) args)
    {
        // 子实体字段已添加，无需额外处理
        StateHasChanged();
    }

    private void HandleFieldRemoved((Guid SubEntityId, Guid FieldId) args)
    {
        // 子实体字段已移除，无需额外处理
        StateHasChanged();
    }

    private void ToggleEntityInfoPanel()
    {
        _entityInfoExpanded = !_entityInfoExpanded;
    }

    private string EntityNameInput
    {
        get => _model.EntityName;
        set
        {
            _model.EntityName = value ?? string.Empty;
            UpdateNamespaceFromEntityName();
        }
    }

    private Task HandleEntityNameInput(ChangeEventArgs args)
    {
        EntityNameInput = args?.Value?.ToString() ?? string.Empty;
        return Task.CompletedTask;
    }

    private Task OnDomainChanged(string value)
    {
        _model.Category = EnsureDomainCode(value);
        UpdateNamespaceFromEntityName();
        return Task.CompletedTask;
    }

    private void UpdateNamespaceFromEntityName()
    {
        if (!_isNew)
        {
            return;
        }

        _model.Namespace = BuildNamespace(_model.EntityName);
    }

    private string BuildNamespace(string? entityName)
    {
        var name = (entityName ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(name))
        {
            return string.Empty;
        }

        var domain = ResolveDomainCode();
        return $"{NamespaceRoot}{domain}.{name}";
    }

    private string ResolveDomainCode()
    {
        return EnsureDomainCode(_model?.Category);
    }

    private string GenerateDefaultFieldName()
    {
        const string prefix = "Field";
        var taken = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        if (_model?.Fields != null)
        {
            foreach (var name in _model.Fields.Select(f => f.PropertyName).Where(n => !string.IsNullOrWhiteSpace(n)))
            {
                taken.Add(name!.Trim());
            }
        }

        foreach (var key in _interfaceFieldOwnership.Keys)
        {
            if (!string.IsNullOrWhiteSpace(key))
            {
                taken.Add(key.Trim());
            }
        }

        var index = 1;
        string candidate;
        do
        {
            candidate = $"{prefix}{index}";
            index++;
        } while (taken.Contains(candidate));

        return candidate;
    }

    private MultilingualTextDto CreateDefaultDisplayName(string propertyName)
    {
        var index = ExtractNumericSuffix(propertyName);
        if (index <= 0)
        {
            index = (_model?.Fields?.Count ?? 0) + 1;
        }

        var label = new MultilingualTextDto();
        var translations = GetResourceTranslations(ResourceKeyFieldDefaultName);

        foreach (var code in GetLanguageCodes())
        {
            var format = ResolveResourceValue(translations, code);
            label[code] = string.IsNullOrWhiteSpace(format)
                ? string.Empty
                : string.Format(CultureInfo.InvariantCulture, format, index);
        }

        return label;
    }

    private static int ExtractNumericSuffix(string propertyName)
    {
        if (string.IsNullOrWhiteSpace(propertyName))
        {
            return 0;
        }

        var digits = new string(propertyName.Reverse()
            .TakeWhile(char.IsDigit)
            .Reverse()
            .ToArray());

        return int.TryParse(digits, out var result) ? result : 0;
    }

    private static string NormalizeDataTypeForUi(string? serverType)
    {
        if (string.IsNullOrWhiteSpace(serverType))
        {
            return FieldDataType.String;
        }

        return serverType switch
        {
            "Int32" => FieldDataType.Integer,
            "Int64" => FieldDataType.Long,
            _ => serverType
        };
    }

    private static string NormalizeDataTypeForApi(string? uiType)
    {
        var value = uiType ?? FieldDataType.String;

        return value switch
        {
            var v when string.Equals(v, FieldDataType.Integer, StringComparison.OrdinalIgnoreCase) => "Int32",
            var v when string.Equals(v, FieldDataType.Long, StringComparison.OrdinalIgnoreCase) => "Int64",
            var v when string.Equals(v, FieldDataType.Text, StringComparison.OrdinalIgnoreCase) => FieldDataType.String,
            _ => value
        };
    }

    private static List<FieldMetadataDto> CloneFieldsForApi(IEnumerable<FieldMetadataDto> source)
    {
        return source.Select(field => new FieldMetadataDto
        {
            Id = field.Id,
            PropertyName = field.PropertyName,
            DisplayName = field.DisplayName != null ? new MultilingualTextDto(field.DisplayName) : null,
            DataType = NormalizeDataTypeForApi(field.DataType),
            Length = field.Length,
            Precision = field.Precision,
            Scale = field.Scale,
            IsRequired = field.IsRequired,
            IsEntityRef = field.IsEntityRef,
            ReferencedEntityId = field.ReferencedEntityId,
            TableName = field.TableName,
            SortOrder = field.SortOrder,
            DefaultValue = field.DefaultValue,
            ValidationRules = field.ValidationRules,
            Source = field.Source,
            EnumDefinitionId = field.EnumDefinitionId,
            IsMultiSelect = field.IsMultiSelect
        }).ToList();
    }

    private bool ValidateFields()
    {
        if (_model.Fields == null || !_model.Fields.Any())
        {
            return true;
        }

        foreach (var field in _model.Fields)
        {
            var label = string.IsNullOrWhiteSpace(field.PropertyName)
                ? I18n.T("LBL_FIELD_UNNAMED")
                : field.PropertyName;

            if (string.IsNullOrWhiteSpace(field.PropertyName))
            {
                MessageService.Error(string.Format(I18n.T("MSG_FIELD_PROPERTY_REQUIRED"), label));
                return false;
            }

            if (field.DisplayName == null || !field.DisplayName.HasValue())
            {
                MessageService.Error(string.Format(I18n.T("MSG_FIELD_DISPLAYNAME_REQUIRED"), label));
                return false;
            }

            var normalizedType = NormalizeDataTypeForApi(field.DataType);
            if (string.IsNullOrWhiteSpace(normalizedType))
            {
                MessageService.Error(string.Format(I18n.T("MSG_FIELD_TYPE_REQUIRED"), label));
                return false;
            }

            if (IsStringType(normalizedType))
            {
                if (!field.Length.HasValue || field.Length.Value <= 0)
                {
                    MessageService.Error(string.Format(I18n.T("MSG_FIELD_STRING_LENGTH_REQUIRED"), label));
                    return false;
                }
            }
            else if (string.Equals(normalizedType, FieldDataType.Decimal, StringComparison.OrdinalIgnoreCase))
            {
                if (!field.Precision.HasValue || field.Precision.Value <= 0 ||
                    !field.Scale.HasValue || field.Scale.Value < 0 ||
                    field.Scale.Value > field.Precision.Value)
                {
                    MessageService.Error(string.Format(I18n.T("MSG_FIELD_DECIMAL_REQUIRED"), label));
                    return false;
                }
            }
        }

        return true;
    }

    private static bool IsStringType(string dataType)
    {
        return string.Equals(dataType, FieldDataType.String, StringComparison.OrdinalIgnoreCase)
               || string.Equals(dataType, FieldDataType.Text, StringComparison.OrdinalIgnoreCase);
    }

    private string ResolveExistingDomain(string? category, string? namespaceValue)
    {
        if (TryMatchDomain(category, out var normalized))
        {
            return normalized;
        }

        if (!string.IsNullOrWhiteSpace(namespaceValue) && _domainOptions.Count > 0)
        {
            foreach (var option in _domainOptions)
            {
                if (string.Equals(option.Code, "System", StringComparison.OrdinalIgnoreCase))
                {
                    continue;
                }

                var prefix = $"{NamespaceRoot}{option.Code}.";
                if (namespaceValue.StartsWith(prefix, StringComparison.OrdinalIgnoreCase))
                {
                    return option.Code;
                }
            }

            if (namespaceValue.StartsWith(SystemNamespacePrefix, StringComparison.OrdinalIgnoreCase))
            {
                if (TryMatchDomain("System", out var systemDomain))
                {
                    return systemDomain;
                }
            }
        }

        return EnsureDomainCode(category);
    }

    private string EnsureDomainCode(string? candidate)
    {
        if (TryMatchDomain(candidate, out var normalized))
        {
            return normalized;
        }

        if (_domainOptions.Count > 0)
        {
            return _domainOptions.First().Code;
        }

        return string.IsNullOrWhiteSpace(candidate) ? "Custom" : candidate;
    }

    private bool TryMatchDomain(string? candidate, out string normalized)
    {
        normalized = string.Empty;

        if (string.IsNullOrWhiteSpace(candidate))
        {
            return false;
        }

        if (_domainOptions.Count == 0)
        {
            return false;
        }

        var match = _domainOptions
            .Select(opt => opt.Code)
            .FirstOrDefault(code => string.Equals(code, candidate, StringComparison.OrdinalIgnoreCase));

        if (!string.IsNullOrEmpty(match))
        {
            normalized = match;
            return true;
        }

        return false;
    }

    private bool IsInterfaceField(string? propertyName)
    {
        return !string.IsNullOrWhiteSpace(propertyName)
            && _interfaceFieldOwnership.ContainsKey(propertyName);
    }

    private bool IsProtectedField(FieldMetadataDto field)
    {
        // 接口字段受保护
        if (IsInterfaceField(field.PropertyName))
        {
            return true;
        }

        // 系统字段受保护
        if (field.Source == FieldSource.System)
        {
            return true;
        }

        return false;
    }

    private string? GetFieldSourceLabel(FieldMetadataDto field)
    {
        // 优先显示接口来源
        if (IsInterfaceField(field.PropertyName))
        {
            return GetInterfaceFieldLabel(field.PropertyName);
        }

        // 显示字段来源
        if (field.Source == FieldSource.System)
        {
            return I18n!.T("LBL_SOURCE_SYSTEM");
        }

        if (field.Source == FieldSource.Interface)
        {
            return I18n!.T("LBL_SOURCE_INTERFACE");
        }

        return I18n!.T("LBL_SOURCE_CUSTOM");
    }

    private string? GetInterfaceFieldLabel(string? propertyName)
    {
        if (string.IsNullOrWhiteSpace(propertyName))
        {
            return null;
        }

        if (!_interfaceFieldOwnership.TryGetValue(propertyName, out var interfaceType))
        {
            return null;
        }

        var key = interfaceType switch
        {
            EntityInterfaceType.Base => "INTERFACE_BASE",
            EntityInterfaceType.Archive => "INTERFACE_ARCHIVE",
            EntityInterfaceType.Audit => "INTERFACE_AUDIT",
            EntityInterfaceType.Version => "INTERFACE_VERSION",
            EntityInterfaceType.TimeVersion => "INTERFACE_TIME_VERSION",
            EntityInterfaceType.Organization => "INTERFACE_ORGANIZATION",
            _ => null
        };

        return key == null ? null : I18n!.T(key);
    }

    private void SyncInterfaceFields()
    {
        if (_model == null)
        {
            _model = new EditModel();
        }

        if (_model.Fields == null)
        {
            _model.Fields = new List<FieldMetadataDto>();
        }

        var required = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        EnsureInterfaceTemplatesInitialized();

        foreach (var interfaceType in _selectedInterfaces)
        {
            if (!_interfaceFieldTemplates.TryGetValue(interfaceType, out var templates))
            {
                continue;
            }

            foreach (var template in templates)
            {
                var field = _model!.Fields.FirstOrDefault(f => string.Equals(f.PropertyName, template.PropertyName, StringComparison.OrdinalIgnoreCase));
                if (field == null)
                {
                    field = CreateInterfaceField(template);
                    _model.Fields.Add(field);
                }
                else
                {
                    ApplyTemplate(field, template);
                }

                required[field.PropertyName] = interfaceType;
            }
        }

        if (_interfaceFieldOwnership.Count > 0)
        {
            _model!.Fields.RemoveAll(f =>
                _interfaceFieldOwnership.ContainsKey(f.PropertyName) &&
                !required.ContainsKey(f.PropertyName));
        }

        _interfaceFieldOwnership.Clear();
        foreach (var kvp in required)
        {
            _interfaceFieldOwnership[kvp.Key] = kvp.Value;
        }

        _model!.Fields = _model.Fields.OrderBy(f => f.SortOrder).ToList();
    }

    private FieldMetadataDto CreateInterfaceField(InterfaceFieldTemplate template)
    {
        var field = new FieldMetadataDto
        {
            Id = Guid.NewGuid(),
            PropertyName = template.PropertyName,
            DisplayName = CloneLabel(template.Label),
            DataType = template.DataType,
            Length = template.Length,
            Precision = template.Precision,
            Scale = template.Scale,
            IsRequired = template.IsRequired,
            IsEntityRef = template.IsEntityRef,
            TableName = template.ReferenceTable,
            SortOrder = GetNextSortOrder(),
            Source = FieldSource.Interface
        };

        ApplyDataTypeDefaults(field);
        return field;
    }

    private void ApplyTemplate(FieldMetadataDto field, InterfaceFieldTemplate template)
    {
        field.DataType = template.DataType;
        field.Length = template.Length;
        field.Precision = template.Precision;
        field.Scale = template.Scale;
        field.IsRequired = template.IsRequired;
        field.IsEntityRef = template.IsEntityRef;
        field.TableName = template.ReferenceTable;

        if (field.DisplayName == null || !field.DisplayName.HasValue())
        {
            field.DisplayName = CloneLabel(template.Label);
        }

        if (field.SortOrder == 0)
        {
            field.SortOrder = GetNextSortOrder();
        }

        ApplyDataTypeDefaults(field);
    }

    private MultilingualTextDto CreateLabelFromResource(string resourceKey)
    {
        var label = new MultilingualTextDto();
        var translations = GetResourceTranslations(resourceKey);

        foreach (var code in GetLanguageCodes())
        {
            label[code] = ResolveResourceValue(translations, code);
        }

        return label;
    }

    private string ResolveResourceValue(IReadOnlyDictionary<string, string>? translations, string langCode)
    {
        if (translations == null || translations.Count == 0)
        {
            return string.Empty;
        }

        if (TryGetTranslationValue(translations, langCode, out var specific))
        {
            return specific;
        }

        foreach (var fallback in translations.Values)
        {
            if (!string.IsNullOrWhiteSpace(fallback))
            {
                return fallback;
            }
        }

        return string.Empty;
    }

    private IReadOnlyDictionary<string, string>? GetResourceTranslations(string resourceKey)
    {
        if (string.IsNullOrWhiteSpace(resourceKey))
        {
            return null;
        }

        return _resourceCache.TryGetValue(resourceKey, out var translations) ? translations : null;
    }

    private static bool TryGetTranslationValue(IReadOnlyDictionary<string, string> translations, string? langCode, out string value)
    {
        value = string.Empty;
        if (string.IsNullOrWhiteSpace(langCode))
        {
            return false;
        }

        if (translations.TryGetValue(langCode, out var direct) && !string.IsNullOrWhiteSpace(direct))
        {
            value = direct;
            return true;
        }

        var neutral = langCode.Contains('-')
            ? langCode.Split('-', 2)[0]
            : langCode;

        if (!string.Equals(neutral, langCode, StringComparison.OrdinalIgnoreCase)
            && translations.TryGetValue(neutral, out var neutralValue)
            && !string.IsNullOrWhiteSpace(neutralValue))
        {
            value = neutralValue;
            return true;
        }

        return false;
    }

    private static InterfaceFieldTemplate Template(
        string propertyName,
        string dataType,
        bool isRequired = false,
        int? length = null,
        int? precision = null,
        int? scale = null,
        MultilingualTextDto? label = null,
        bool isEntityRef = false,
        string? referenceTable = null)
    {
        return new InterfaceFieldTemplate
        {
            PropertyName = propertyName,
            DataType = dataType,
            IsRequired = isRequired,
            Length = length,
            Precision = precision,
            Scale = scale,
            Label = label ?? new MultilingualTextDto(),
            IsEntityRef = isEntityRef,
            ReferenceTable = referenceTable
        };
    }

    private MultilingualTextDto CloneLabel(MultilingualTextDto source)
    {
        var clone = new MultilingualTextDto(source);
        EnsureDisplayNameLanguages(clone);
        return clone;
    }

    private int GetNextSortOrder()
    {
        if (_model?.Fields == null || _model.Fields.Count == 0)
        {
            return 100;
        }

        return _model.Fields.Max(f => f.SortOrder) + 10;
    }
    private bool IsIconUrl(string? iconValue)
    {
        if (string.IsNullOrWhiteSpace(iconValue))
        {
            return false;
        }

        var candidate = iconValue.Trim();
        if (candidate.StartsWith("data:", StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        if (Uri.TryCreate(candidate, UriKind.Absolute, out var uri))
        {
            return string.Equals(uri.Scheme, Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase)
                || string.Equals(uri.Scheme, Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase);
        }

        return false;
    }

    private string GetIconName()
    {
        var raw = _model.Icon;
        if (string.IsNullOrWhiteSpace(raw) || IsIconUrl(raw))
        {
            return DefaultIconType;
        }

        var icon = raw.Trim();
        if (icon.Contains(':', StringComparison.Ordinal))
        {
            icon = icon.Split(':', 2)[1];
        }

        icon = icon.Replace("icon-", string.Empty, StringComparison.OrdinalIgnoreCase)
                   .Replace('_', '-')
                   .ToLowerInvariant();

        return string.IsNullOrWhiteSpace(icon) ? DefaultIconType : icon;
    }

    private void GoBack()
    {
        Nav.NavigateTo("/entity-definitions");
    }

    private class ApiLanguageDto
    {
        public string code { get; set; } = string.Empty;
        public string name { get; set; } = string.Empty;
    }

    private class LocalizationResourceDto
    {
        public string Key { get; set; } = string.Empty;
        public Dictionary<string, string>? Translations { get; set; }
    }

    private class EditModel
    {
        public string Namespace { get; set; } = string.Empty;
        public string EntityName { get; set; } = string.Empty;
        public MultilingualTextDto DisplayName { get; set; } = new();
        public MultilingualTextDto? Description { get; set; }
        public string StructureType { get; set; } = "Single";
        public string? Icon { get; set; }
        public string? Category { get; set; } = "Custom";
        public int Order { get; set; }
        public bool IsEnabled { get; set; } = true;
        public List<FieldMetadataDto> Fields { get; set; } = new();
    }

    private sealed class InterfaceFieldTemplate
    {
        public string PropertyName { get; init; } = string.Empty;
        public string DataType { get; init; } = FieldDataType.String;
        public bool IsRequired { get; init; }
        public int? Length { get; init; }
        public int? Precision { get; init; }
        public int? Scale { get; init; }
        public MultilingualTextDto Label { get; init; } = new();
        public bool IsEntityRef { get; init; }
        public string? ReferenceTable { get; init; }
    }
}




