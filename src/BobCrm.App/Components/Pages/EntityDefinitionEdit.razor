@page "/entity-definitions/create"
@page "/entity-definitions/edit/{Id:guid}"
@rendermode RenderMode.InteractiveServer
@inject BobCrm.App.Services.EntityDefinitionService EntityDefService
@inject BobCrm.App.Services.I18nService I18n
@inject NavigationManager Nav
@using BobCrm.App.Models
@using BobCrm.App.Services.Multilingual
@using AntDesign
@inject IMultilingualTextResolver MultilingualResolver

<AuthChecker>
    <PageHeader Title="@(_isNew ? I18n.T("LBL_CREATE_ENTITY_DEF") : I18n.T("LBL_EDIT_ENTITY_DEF"))" OnBack="GoBack">
        <PageHeaderExtra>
            <Space>
                <SpaceItem>
                    <Button OnClick="HandleSave" Type="@ButtonType.Primary" Loading="@_saving">
                        <Icon Type="save" /> @I18n.T("BTN_SAVE")
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button OnClick="GoBack">
                        @I18n.T("BTN_CANCEL")
                    </Button>
                </SpaceItem>
            </Space>
        </PageHeaderExtra>
    </PageHeader>

    @if (_loading)
    {
        <div style="text-align: center; padding: 50px;">
            <Spin Size="@SpinSize.Large" />
        </div>
    }
    else
    {
        <Card Class="entity-section-card">
            <div class="entity-section-toggle" role="button" tabindex="0" @onclick="ToggleEntityInfoPanel">
                <span>@I18n.T("LBL_ENTITY_INFO")</span>
                <Icon Type="@(_entityInfoExpanded ? "up" : "down")" />
            </div>
            @if (_entityInfoExpanded)
            {
                <Form Model="@_model" LabelColSpan="4" WrapperColSpan="20">
                        <FormItem Label="@I18n.T("LBL_NAMESPACE")">
                            <Input @bind-Value="@_model.Namespace" Disabled="@(!_isNew)" Placeholder="BobCrm.Domain.Custom" Class="field-control" />
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_ENTITY_NAME")">
                            <Input @bind-Value="@_model.EntityName" Disabled="@(!_isNew)" Placeholder="Product" Class="field-control" />
                            <div class="ant-form-text">
                                @I18n.T("TXT_ENTITY_NAME_HINT")
                            </div>
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_DISPLAY_NAME")">
                            <MultilingualInput @bind-Value="@_model.DisplayName" />
                            <div class="ant-form-text">
                                @I18n.T("TXT_MULTILINGUAL_DISPLAY_NAME_HINT")
                            </div>
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_DESCRIPTION")">
                            <MultilingualInput @bind-Value="@_model.Description" />
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_STRUCTURE_TYPE")">
                            <RadioGroup @bind-Value="@_model.StructureType" Disabled="@(!_isNew)">
                                <Radio Value="@("Single")">@I18n.T("LBL_SINGLE_ENTITY")</Radio>
                                <Radio Value="@("MasterDetail")">@I18n.T("LBL_MASTER_DETAIL_ENTITY")</Radio>
                                <Radio Value="@("MasterDetailGrandchild")">@I18n.T("LBL_MASTER_DETAIL_GRANDCHILD_ENTITY")</Radio>
                            </RadioGroup>
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_INTERFACES")">
                            <Space Direction="@SpaceDirection.Vertical" Size="@SpaceSize.Middle">
                                <SpaceItem>
                                    <Checkbox @bind-Value="@IsBaseSelected" Disabled="@(!_isNew)">
                                        <strong>@I18n.T("INTERFACE_BASE")</strong>
                                        <span class="interface-hint">@I18n.T("INTERFACE_BASE_DESC")</span>
                                    </Checkbox>
                                </SpaceItem>
                                <SpaceItem>
                                    <Checkbox @bind-Value="@IsArchiveSelected" Disabled="@(!_isNew)">
                                        <strong>@I18n.T("INTERFACE_ARCHIVE")</strong>
                                        <span class="interface-hint">@I18n.T("INTERFACE_ARCHIVE_DESC")</span>
                                    </Checkbox>
                                </SpaceItem>
                                <SpaceItem>
                                    <Checkbox @bind-Value="@IsAuditSelected" Disabled="@(!_isNew)">
                                        <strong>@I18n.T("INTERFACE_AUDIT")</strong>
                                        <span class="interface-hint">@I18n.T("INTERFACE_AUDIT_DESC")</span>
                                    </Checkbox>
                                </SpaceItem>
                                <SpaceItem>
                                    <Checkbox @bind-Value="@IsVersionSelected" Disabled="@(!_isNew)">
                                        <strong>@I18n.T("INTERFACE_VERSION")</strong>
                                        <span class="interface-hint">@I18n.T("INTERFACE_VERSION_DESC")</span>
                                    </Checkbox>
                                </SpaceItem>
                                <SpaceItem>
                                    <Checkbox @bind-Value="@IsTimeVersionSelected" Disabled="@(!_isNew)">
                                        <strong>@I18n.T("INTERFACE_TIME_VERSION")</strong>
                                        <span class="interface-hint">@I18n.T("INTERFACE_TIME_VERSION_DESC")</span>
                                    </Checkbox>
                                </SpaceItem>
                                <div class="interface-tip">@I18n.T("TXT_INTERFACE_AUTO_FIELDS_TIP")</div>
                            </Space>
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_ICON")">
                            <div class="icon-input-wrapper">
                                <Input @bind-Value="@_model.Icon"
                                       Placeholder="@I18n.T("TXT_ICON_FIELD_PLACEHOLDER")"
                                       Class="field-control" />
                                <div class="icon-preview-zone">
                                    @if (IsIconUrl(_model.Icon))
                                    {
                                        <img src="@_model.Icon" alt="icon preview" class="icon-preview-img" />
                                    }
                                    else
                                    {
                                        <Icon Type="@GetIconName()" Style="font-size: 28px; color: #1890ff;" />
                                    }
                                    <div class="icon-hint">@I18n.T("TXT_ICON_FIELD_HINT")</div>
                                </div>
                            </div>
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_CATEGORY")">
                            <Input @bind-Value="@_model.Category" Placeholder="@I18n.T("TXT_CATEGORY_PLACEHOLDER")" Class="field-control" />
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_SORT_ORDER")">
                            <AntDesign.InputNumber TValue="int" @bind-Value="@_model.Order" Min="0" />
                        </FormItem>

                        <FormItem Label="@I18n.T("LBL_ENABLED")">
                            <Switch @bind-Value="@_model.IsEnabled" />
                        </FormItem>
                </Form>
            }
        </Card>

        <Card Title="@I18n.T("LBL_FIELD_DEFINITION")" Class="entity-section-card" Style="margin-top: 16px;">
            <Extra>
                <Button OnClick="AddField" Type="@ButtonType.Dashed" Size="@ButtonSize.Small">
                    <Icon Type="plus" /> @I18n.T("BTN_ADD_FIELD")
                </Button>
            </Extra>
            <Body>
                <Table TItem="FieldMetadataDto" DataSource="@_model.Fields" Loading="@false" Size="@TableSize.Small">
                    <PropertyColumn Property="f => f.PropertyName" Title="@I18n.T("LBL_PROPERTY_NAME")" />
                    <Column TData="string" Title="@I18n.T("LBL_DISPLAY_NAME")">
                        @MultilingualResolver.Resolve(context.DisplayName, context.PropertyName)
                    </Column>
                    <PropertyColumn Property="f => f.DataType" Title="@I18n.T("LBL_DATA_TYPE")">
                        <Tag>@context.DataType</Tag>
                    </PropertyColumn>
                    <PropertyColumn Property="f => f.Length" Title="@I18n.T("LBL_LENGTH")" />
                    <PropertyColumn Property="f => f.IsRequired" Title="@I18n.T("LBL_REQUIRED")">
                        @(context.IsRequired ? I18n.T("TXT_YES") : I18n.T("TXT_NO"))
                    </PropertyColumn>
                    <PropertyColumn Property="f => f.SortOrder" Title="@I18n.T("LBL_SORT_ORDER")" />
                    <Column TData="string" Title="@I18n.T("LBL_SOURCE")">
                        @{
                            var interfaceLabel = GetInterfaceFieldLabel(context.PropertyName);
                        }
                        @if (!string.IsNullOrEmpty(interfaceLabel))
                        {
                            <Tag>@interfaceLabel</Tag>
                        }
                        else
                        {
                            <Tag>@I18n.T("LBL_SOURCE_CUSTOM")</Tag>
                        }
                    </Column>
                    <ActionColumn Title="@I18n.T("LBL_ACTIONS")">
                        <Space>
                            <SpaceItem>
                                <Button Size="@ButtonSize.Small" Disabled="@IsInterfaceField(context.PropertyName)" OnClick="() => EditField(context)">
                                    @I18n.T("BTN_EDIT")
                                </Button>
                            </SpaceItem>
                            <SpaceItem>
                                <Popconfirm Title="@I18n.T("MSG_CONFIRM_DELETE")" OnConfirm="() => RemoveField(context)" Disabled="@IsInterfaceField(context.PropertyName)">
                                    <Button Danger Size="@ButtonSize.Small" Disabled="@IsInterfaceField(context.PropertyName)">
                                        @I18n.T("BTN_DELETE")
                                    </Button>
                                </Popconfirm>
                            </SpaceItem>
                        </Space>
                    </ActionColumn>
                </Table>
            </Body>
        </Card>

        @* 子实体管理（仅MasterDetail和MasterDetailGrandchild结构） *@
        @if (_model.StructureType == "MasterDetail" || _model.StructureType == "MasterDetailGrandchild")
        {
            <Card Title="@I18n.T("LBL_SUB_ENTITY_MANAGEMENT")" Class="entity-section-card" Style="margin-top: 16px;">
                <Body>
                    <SubEntityTabs SubEntities="@_subEntities"
                                  OnSubEntityAdded="@HandleSubEntityAdded"
                                  OnSubEntityRemoved="@HandleSubEntityRemoved"
                                  OnFieldChanged="@HandleFieldChanged"
                                  OnFieldAdded="@HandleFieldAdded"
                                  OnFieldRemoved="@HandleFieldRemoved" />
                </Body>
            </Card>
        }
    }
</AuthChecker>

<!-- 字段编辑模态框 -->
<Modal Title="@(_editingField.Id == Guid.Empty ? I18n.T("LBL_CREATE_FIELD") : I18n.T("LBL_EDIT_FIELD"))" WrapClassName="calm-modal" @bind-Visible="@_fieldModalVisible" OnOk="SaveField" OnCancel="CancelFieldEdit">
    <Form Model="@_editingField" LabelColSpan="6" WrapperColSpan="18">
        <FormItem Label="@I18n.T("LBL_PROPERTY_NAME")">
            <Input @bind-Value="@_editingField.PropertyName" Placeholder="Price" Class="field-control" />
        </FormItem>
        <FormItem Label="@I18n.T("LBL_DISPLAY_NAME")">
            <MultilingualInput @bind-Value="@_editingField.DisplayName" />
        </FormItem>
        <FormItem Label="@I18n.T("LBL_DATA_TYPE")">
            <Select TItemValue="string" TItem="string" @bind-Value="@_editingField.DataType" Class="field-control">
                <SelectOptions>
                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.String" Label="String">
                        <ChildContent Context="optionContent">String</ChildContent>
                    </SelectOption>
                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.Integer" Label="Integer">
                        <ChildContent Context="optionContent">Integer</ChildContent>
                    </SelectOption>
                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.Long" Label="Long">
                        <ChildContent Context="optionContent">Long</ChildContent>
                    </SelectOption>
                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.Decimal" Label="Decimal">
                        <ChildContent Context="optionContent">Decimal</ChildContent>
                    </SelectOption>
                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.Boolean" Label="Boolean">
                        <ChildContent Context="optionContent">Boolean</ChildContent>
                    </SelectOption>
                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.DateTime" Label="DateTime">
                        <ChildContent Context="optionContent">DateTime</ChildContent>
                    </SelectOption>
                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.Date" Label="Date">
                        <ChildContent Context="optionContent">Date</ChildContent>
                    </SelectOption>
                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.Text" Label="Text">
                        <ChildContent Context="optionContent">Text</ChildContent>
                    </SelectOption>
                    <SelectOption TItemValue="string" TItem="string" Value="@FieldDataType.Guid" Label="Guid">
                        <ChildContent Context="optionContent">Guid</ChildContent>
                    </SelectOption>
                </SelectOptions>
            </Select>
        </FormItem>
        <FormItem Label="@I18n.T("LBL_LENGTH")">
            <AntDesign.InputNumber TValue="int?" Value="@_editingField.Length" Min="0" Placeholder="@I18n.T("TXT_FOR_STRING_TYPE")" ValueChanged="@((int? val) => _editingField.Length = val)" />
        </FormItem>
        <FormItem Label="@I18n.T("LBL_PRECISION")">
            <AntDesign.InputNumber TValue="int?" Value="@_editingField.Precision" Min="0" Placeholder="@I18n.T("TXT_FOR_DECIMAL_TYPE")" ValueChanged="@((int? val) => _editingField.Precision = val)" />
        </FormItem>
        <FormItem Label="@I18n.T("LBL_SCALE")">
            <AntDesign.InputNumber TValue="int?" Value="@_editingField.Scale" Min="0" Placeholder="@I18n.T("TXT_FOR_DECIMAL_TYPE")" ValueChanged="@((int? val) => _editingField.Scale = val)" />
        </FormItem>
        <FormItem Label="@I18n.T("LBL_REQUIRED")">
            <Switch @bind-Value="@_editingField.IsRequired" />
        </FormItem>
        <FormItem Label="@I18n.T("LBL_DEFAULT_VALUE")">
            <Input @bind-Value="@_editingField.DefaultValue" Placeholder="@I18n.T("TXT_DEFAULT_VALUE_HINT")" Class="field-control" />
        </FormItem>
        <FormItem Label="@I18n.T("LBL_SORT_ORDER")">
            <AntDesign.InputNumber TValue="int?" Value="@_editingField.SortOrder" Min="0" ValueChanged="@((int? val) => _editingField.SortOrder = val ?? 0)" />
        </FormItem>
    </Form>
</Modal>

@code {
    [Parameter] public Guid? Id { get; set; }
    [CascadingParameter] public int I18nRenderVersion { get; set; }
    [Inject] private IMessageService MessageService { get; set; } = default!;

    private bool _isNew => !Id.HasValue;
    private bool _loading = false;
    private bool _saving = false;
    private bool _fieldModalVisible = false;
    private int _lastI18nRenderVersion = -1;
    private const string DefaultIconType = "appstore";
    private bool _entityInfoExpanded = true;
    private readonly Dictionary<string, string> _interfaceFieldOwnership = new(StringComparer.OrdinalIgnoreCase);
    private static readonly Dictionary<string, List<InterfaceFieldTemplate>> InterfaceFieldTemplates = new(StringComparer.OrdinalIgnoreCase)
    {
        [EntityInterfaceType.Base] = new()
        {
            Template("Id", FieldDataType.Guid, isRequired: true, label: CreateLabel("标识", "ID", "Id")),
            Template("IsDeleted", FieldDataType.Boolean, label: CreateLabel("已删除", "削除フラグ", "Is Deleted")),
            Template("DeletedAt", FieldDataType.DateTime, label: CreateLabel("删除时间", "削除日時", "Deleted At")),
            Template("DeletedBy", FieldDataType.String, length: 64, label: CreateLabel("删除人", "削除者", "Deleted By"))
        },
        [EntityInterfaceType.Archive] = new()
        {
            Template("Code", FieldDataType.String, isRequired: true, length: 64, label: CreateLabel("编码", "コード", "Code")),
            Template("Name", FieldDataType.String, isRequired: true, length: 200, label: CreateLabel("名称", "名称", "Name"))
        },
        [EntityInterfaceType.Audit] = new()
        {
            Template("CreatedAt", FieldDataType.DateTime, isRequired: true, label: CreateLabel("创建时间", "作成日時", "Created At")),
            Template("CreatedBy", FieldDataType.String, length: 64, label: CreateLabel("创建人", "作成者", "Created By")),
            Template("UpdatedAt", FieldDataType.DateTime, isRequired: true, label: CreateLabel("修改时间", "更新日時", "Updated At")),
            Template("UpdatedBy", FieldDataType.String, length: 64, label: CreateLabel("修改人", "更新者", "Updated By"))
        },
        [EntityInterfaceType.Version] = new()
        {
            Template("Version", FieldDataType.Integer, isRequired: true, label: CreateLabel("版本号", "バージョン", "Version"))
        },
        [EntityInterfaceType.TimeVersion] = new()
        {
            Template("ValidFrom", FieldDataType.DateTime, isRequired: true, label: CreateLabel("生效开始", "有効開始", "Valid From")),
            Template("ValidTo", FieldDataType.DateTime, isRequired: true, label: CreateLabel("生效结束", "有効終了", "Valid To")),
            Template("VersionNo", FieldDataType.Integer, isRequired: true, label: CreateLabel("时间版本", "時系列バージョン", "Version No"))
        }
    };

    private EditModel _model = new();
    private FieldMetadataDto _editingField = new();
    private string[] _selectedInterfaces = Array.Empty<string>();
    private List<SubEntityViewModel> _subEntities = new();

    // Checkbox 绑定属性
    private bool IsBaseSelected
    {
        get => _selectedInterfaces.Contains("Base");
        set => UpdateInterfaceSelection("Base", value);
    }

    private bool IsArchiveSelected
    {
        get => _selectedInterfaces.Contains("Archive");
        set => UpdateInterfaceSelection("Archive", value);
    }

    private bool IsAuditSelected
    {
        get => _selectedInterfaces.Contains("Audit");
        set => UpdateInterfaceSelection("Audit", value);
    }

    private bool IsVersionSelected
    {
        get => _selectedInterfaces.Contains("Version");
        set => UpdateInterfaceSelection("Version", value);
    }

    private bool IsTimeVersionSelected
    {
        get => _selectedInterfaces.Contains("TimeVersion");
        set => UpdateInterfaceSelection("TimeVersion", value);
    }

    private void UpdateInterfaceSelection(string interfaceType, bool isSelected)
    {
        var list = _selectedInterfaces.ToList();
        if (isSelected && !list.Contains(interfaceType))
        {
            list.Add(interfaceType);
        }
        else if (!isSelected && list.Contains(interfaceType))
        {
            list.Remove(interfaceType);
        }
        _selectedInterfaces = list.ToArray();
        SyncInterfaceFields();
        _ = InvokeAsync(StateHasChanged);
    }

    protected override async Task OnInitializedAsync()
    {
        if (!_isNew)
        {
            await LoadEntity();
        }
        else
        {
            // 默认选中Base接口
            _selectedInterfaces = new[] { "Base" };
            SyncInterfaceFields();
        }
    }

    protected override void OnParametersSet()
    {
        if (_lastI18nRenderVersion != I18nRenderVersion)
        {
            _lastI18nRenderVersion = I18nRenderVersion;
            StateHasChanged();
        }
    }

    private async Task LoadEntity()
    {
        _loading = true;
        try
        {
            var entity = await EntityDefService.GetByIdAsync(Id!.Value);
            if (entity != null)
            {
                _model = new EditModel
                {
                    Namespace = entity.Namespace,
                    EntityName = entity.EntityName,
                    DisplayName = entity.DisplayName != null
                        ? new MultilingualTextDto(entity.DisplayName)
                        : new MultilingualTextDto(),
                    Description = entity.Description != null
                        ? new MultilingualTextDto(entity.Description)
                        : null,
                    StructureType = entity.StructureType,
                    Icon = entity.Icon,
                    Category = entity.Category,
                    Order = entity.Order,
                    IsEnabled = entity.IsEnabled,
                    Fields = entity.Fields.Select(f => new FieldMetadataDto
                    {
                        Id = f.Id,
                        PropertyName = f.PropertyName,
                        DisplayName = f.DisplayName,
                        DataType = f.DataType,
                        Length = f.Length,
                        Precision = f.Precision,
                        Scale = f.Scale,
                        IsRequired = f.IsRequired,
                        IsEntityRef = f.IsEntityRef,
                        ReferencedEntityId = f.ReferencedEntityId,
                        TableName = f.TableName,
                        SortOrder = f.SortOrder,
                        DefaultValue = f.DefaultValue,
                        ValidationRules = f.ValidationRules
                    }).ToList()
                };

                _selectedInterfaces = entity.Interfaces.Where(i => i.IsEnabled).Select(i => i.InterfaceType).ToArray();
                SyncInterfaceFields();
            }
        }
        catch (Exception ex)
        {
            MessageService.Error($"{I18n.T("MSG_LOAD_FAILED")}: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task HandleSave()
    {
        _saving = true;
        try
        {
            // 验证多语言显示名
            if (_model.DisplayName == null || !_model.DisplayName.HasValue())
            {
                MessageService.Error(I18n.T("MSG_DISPLAY_NAME_REQUIRED"));
                _saving = false;
                return;
            }

            if (_isNew)
            {
                var request = new CreateEntityDefinitionRequest
                {
                    Namespace = _model.Namespace,
                    EntityName = _model.EntityName,
                    DisplayName = _model.DisplayName,
                    Description = _model.Description,
                    StructureType = _model.StructureType,
                    Interfaces = _selectedInterfaces.ToList(),
                    Fields = _model.Fields
                };

                await EntityDefService.CreateAsync(request);
                MessageService.Success(I18n.T("MSG_CREATE_SUCCESS"));
            }
            else
            {
                var request = new UpdateEntityDefinitionRequest
                {
                    DisplayName = _model.DisplayName,
                    Description = _model.Description,
                    Icon = _model.Icon,
                    Category = _model.Category,
                    IsEnabled = _model.IsEnabled,
                    Order = _model.Order,
                    Fields = _model.Fields,
                    Interfaces = _selectedInterfaces.ToList()
                };

                await EntityDefService.UpdateAsync(Id!.Value, request);
                MessageService.Success(I18n.T("MSG_UPDATE_SUCCESS"));
            }

            GoBack();
        }
        catch (Exception ex)
        {
            MessageService.Error($"{I18n.T("MSG_SAVE_FAILED")}: {ex.Message}");
        }
        finally
        {
            _saving = false;
        }
    }

    private void AddField()
    {
        _editingField = new FieldMetadataDto
        {
            Id = Guid.Empty,
            SortOrder = (_model.Fields != null && _model.Fields.Any() ? _model.Fields.Max(f => f.SortOrder) + 10 : 100),
            DataType = FieldDataType.String,
            DisplayName = new MultilingualTextDto()
        };
        _fieldModalVisible = true;
    }

    private void EditField(FieldMetadataDto field)
    {
        _editingField = new FieldMetadataDto
        {
            Id = field.Id,
            PropertyName = field.PropertyName,
            DisplayName = field.DisplayName ?? new MultilingualTextDto(),
            DataType = field.DataType,
            Length = field.Length,
            Precision = field.Precision,
            Scale = field.Scale,
            IsRequired = field.IsRequired,
            DefaultValue = field.DefaultValue,
            SortOrder = field.SortOrder
        };
        _fieldModalVisible = true;
    }

    private Task SaveField()
    {
        // 验证字段显示名
        if (_editingField.DisplayName == null || !_editingField.DisplayName.HasValue())
        {
            MessageService.Error(I18n.T("MSG_FIELD_DISPLAY_NAME_REQUIRED"));
            return Task.CompletedTask;
        }

        if (_editingField.Id == Guid.Empty)
        {
            _editingField.Id = Guid.NewGuid();
            if (_model.Fields == null)
            {
                _model.Fields = new List<FieldMetadataDto>();
            }
            _model.Fields.Add(new FieldMetadataDto
            {
                Id = _editingField.Id,
                PropertyName = _editingField.PropertyName,
                DisplayName = _editingField.DisplayName,
                DataType = _editingField.DataType,
                Length = _editingField.Length,
                Precision = _editingField.Precision,
                Scale = _editingField.Scale,
                IsRequired = _editingField.IsRequired,
                DefaultValue = _editingField.DefaultValue,
                SortOrder = _editingField.SortOrder
            });
        }
        else
        {
            if (_model.Fields != null)
            {
                var index = _model.Fields.FindIndex(f => f.Id == _editingField.Id);
                if (index >= 0)
                {
                    _model.Fields[index] = new FieldMetadataDto
                    {
                        Id = _editingField.Id,
                        PropertyName = _editingField.PropertyName,
                        DisplayName = _editingField.DisplayName,
                        DataType = _editingField.DataType,
                        Length = _editingField.Length,
                        Precision = _editingField.Precision,
                        Scale = _editingField.Scale,
                        IsRequired = _editingField.IsRequired,
                        DefaultValue = _editingField.DefaultValue,
                        SortOrder = _editingField.SortOrder
                    };
                }
            }
        }

        _fieldModalVisible = false;
        return Task.CompletedTask;
    }

    private void CancelFieldEdit()
    {
        _fieldModalVisible = false;
    }

    private void RemoveField(FieldMetadataDto field)
    {
        if (field == null)
        {
            return;
        }

        if (IsInterfaceField(field.PropertyName))
        {
            return;
        }

        _model.Fields.Remove(field);
    }

    // 子实体事件处理
    private Task HandleSubEntityAdded(SubEntityViewModel subEntity)
    {
        // 创建新列表引用以触发子组件参数变更检测
        _subEntities = _subEntities.Concat(new[] { subEntity }).ToList();
        return InvokeAsync(StateHasChanged);
    }

    private Task HandleSubEntityRemoved(Guid subEntityId)
    {
        // 创建新列表引用以触发子组件参数变更检测
        _subEntities = _subEntities.Where(s => s.TempId != subEntityId).ToList();
        return InvokeAsync(StateHasChanged);
    }

    private void HandleFieldChanged((Guid SubEntityId, FieldViewModel Field) args)
    {
        // 子实体字段已更新，无需额外处理
        StateHasChanged();
    }

    private void HandleFieldAdded((Guid SubEntityId, FieldViewModel Field) args)
    {
        // 子实体字段已添加，无需额外处理
        StateHasChanged();
    }

    private void HandleFieldRemoved((Guid SubEntityId, Guid FieldId) args)
    {
        // 子实体字段已移除，无需额外处理
        StateHasChanged();
    }

    private void ToggleEntityInfoPanel()
    {
        _entityInfoExpanded = !_entityInfoExpanded;
    }

    private bool IsInterfaceField(string? propertyName)
    {
        return !string.IsNullOrWhiteSpace(propertyName)
            && _interfaceFieldOwnership.ContainsKey(propertyName);
    }

    private string? GetInterfaceFieldLabel(string? propertyName)
    {
        if (string.IsNullOrWhiteSpace(propertyName))
        {
            return null;
        }

        if (!_interfaceFieldOwnership.TryGetValue(propertyName, out var interfaceType))
        {
            return null;
        }

        var key = interfaceType switch
        {
            EntityInterfaceType.Base => "INTERFACE_BASE",
            EntityInterfaceType.Archive => "INTERFACE_ARCHIVE",
            EntityInterfaceType.Audit => "INTERFACE_AUDIT",
            EntityInterfaceType.Version => "INTERFACE_VERSION",
            EntityInterfaceType.TimeVersion => "INTERFACE_TIME_VERSION",
            _ => null
        };

        return key == null ? null : I18n!.T(key);
    }

    private void SyncInterfaceFields()
    {
        if (_model == null)
        {
            _model = new EditModel();
        }

        if (_model.Fields == null)
        {
            _model.Fields = new List<FieldMetadataDto>();
        }

        var required = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        foreach (var interfaceType in _selectedInterfaces)
        {
            if (!InterfaceFieldTemplates.TryGetValue(interfaceType, out var templates))
            {
                continue;
            }

            foreach (var template in templates)
            {
                var field = _model!.Fields.FirstOrDefault(f => string.Equals(f.PropertyName, template.PropertyName, StringComparison.OrdinalIgnoreCase));
                if (field == null)
                {
                    field = CreateInterfaceField(template);
                    _model.Fields.Add(field);
                }
                else
                {
                    ApplyTemplate(field, template);
                }

                required[field.PropertyName] = interfaceType;
            }
        }

        if (_interfaceFieldOwnership.Count > 0)
        {
            _model!.Fields.RemoveAll(f =>
                _interfaceFieldOwnership.ContainsKey(f.PropertyName) &&
                !required.ContainsKey(f.PropertyName));
        }

        _interfaceFieldOwnership.Clear();
        foreach (var kvp in required)
        {
            _interfaceFieldOwnership[kvp.Key] = kvp.Value;
        }

        _model!.Fields = _model.Fields.OrderBy(f => f.SortOrder).ToList();
    }

    private FieldMetadataDto CreateInterfaceField(InterfaceFieldTemplate template)
    {
        return new FieldMetadataDto
        {
            Id = Guid.NewGuid(),
            PropertyName = template.PropertyName,
            DisplayName = CloneLabel(template.Label),
            DataType = template.DataType,
            Length = template.Length,
            Precision = template.Precision,
            Scale = template.Scale,
            IsRequired = template.IsRequired,
            SortOrder = GetNextSortOrder()
        };
    }

    private void ApplyTemplate(FieldMetadataDto field, InterfaceFieldTemplate template)
    {
        field.DataType = template.DataType;
        field.Length = template.Length;
        field.Precision = template.Precision;
        field.Scale = template.Scale;
        field.IsRequired = template.IsRequired;

        if (field.DisplayName == null || !field.DisplayName.HasValue())
        {
            field.DisplayName = CloneLabel(template.Label);
        }

        if (field.SortOrder == 0)
        {
            field.SortOrder = GetNextSortOrder();
        }
    }

    private static MultilingualTextDto CreateLabel(string zh, string ja, string en)
    {
        return new MultilingualTextDto
        {
            ["zh"] = zh,
            ["ja"] = ja,
            ["en"] = en
        };
    }

    private static InterfaceFieldTemplate Template(
        string propertyName,
        string dataType,
        bool isRequired = false,
        int? length = null,
        int? precision = null,
        int? scale = null,
        MultilingualTextDto? label = null)
    {
        return new InterfaceFieldTemplate
        {
            PropertyName = propertyName,
            DataType = dataType,
            IsRequired = isRequired,
            Length = length,
            Precision = precision,
            Scale = scale,
            Label = label ?? new MultilingualTextDto()
        };
    }

    private MultilingualTextDto CloneLabel(MultilingualTextDto source)
    {
        return new MultilingualTextDto(source);
    }

    private int GetNextSortOrder()
    {
        if (_model?.Fields == null || _model.Fields.Count == 0)
        {
            return 100;
        }

        return _model.Fields.Max(f => f.SortOrder) + 10;
    }
    private bool IsIconUrl(string? iconValue)
    {
        if (string.IsNullOrWhiteSpace(iconValue))
        {
            return false;
        }

        var candidate = iconValue.Trim();
        if (candidate.StartsWith("data:", StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        if (Uri.TryCreate(candidate, UriKind.Absolute, out var uri))
        {
            return string.Equals(uri.Scheme, Uri.UriSchemeHttp, StringComparison.OrdinalIgnoreCase)
                || string.Equals(uri.Scheme, Uri.UriSchemeHttps, StringComparison.OrdinalIgnoreCase);
        }

        return false;
    }

    private string GetIconName()
    {
        var raw = _model.Icon;
        if (string.IsNullOrWhiteSpace(raw) || IsIconUrl(raw))
        {
            return DefaultIconType;
        }

        var icon = raw.Trim();
        if (icon.Contains(':', StringComparison.Ordinal))
        {
            icon = icon.Split(':', 2)[1];
        }

        icon = icon.Replace("icon-", string.Empty, StringComparison.OrdinalIgnoreCase)
                   .Replace('_', '-')
                   .ToLowerInvariant();

        return string.IsNullOrWhiteSpace(icon) ? DefaultIconType : icon;
    }    private void GoBack()
    {
        Nav.NavigateTo("/entity-definitions");
    }

    private class EditModel
    {
        public string Namespace { get; set; } = "BobCrm.Domain.Custom";
        public string EntityName { get; set; } = string.Empty;
        public MultilingualTextDto DisplayName { get; set; } = new();
        public MultilingualTextDto? Description { get; set; }
        public string StructureType { get; set; } = "Single";
        public string? Icon { get; set; }
        public string? Category { get; set; }
        public int Order { get; set; }
        public bool IsEnabled { get; set; } = true;
        public List<FieldMetadataDto> Fields { get; set; } = new();
    }

    private sealed class InterfaceFieldTemplate
    {
        public string PropertyName { get; init; } = string.Empty;
        public string DataType { get; init; } = FieldDataType.String;
        public bool IsRequired { get; init; }
        public int? Length { get; init; }
        public int? Precision { get; init; }
        public int? Scale { get; init; }
        public MultilingualTextDto Label { get; init; } = new();
    }
}




