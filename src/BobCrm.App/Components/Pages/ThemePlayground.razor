@page "/theme-playground"
@rendermode RenderMode.InteractiveServer
@using AntDesign
@using BobCrm.App.Services
@implements IDisposable
@inject ThemeState ThemeState
@inject I18nService I18n

<PageTitle>@I18n.T("TP_PAGE_TITLE")</PageTitle>

<div class="tp-root">
    <header class="tp-header">
        <div>
            <p class="tp-eyebrow">Calm Neumorphic Glass CRM</p>
            <h1>Theme Playground</h1>
            <p class="tp-subtitle">@I18n.T("TP_SUBTITLE")</p>
        </div>
        <div class="tp-theme-switch">
            <span>Theme</span>
            <Button OnClick="() => SwitchTheme(ThemeState.CalmLight)" Type="@ButtonType.Default">Calm Light</Button>
            <Button OnClick="() => SwitchTheme(ThemeState.CalmDark)" Type="@ButtonType.Dashed">Calm Dark</Button>
        </div>
    </header>

    <section class="tp-grid tp-grid-3">
        @foreach (var metric in Metrics)
        {
            <article class="tp-card card metric-card">
                <p class="tp-label">@I18n.T(metric.LabelKey)</p>
                <div class="tp-metric">
                    <span>@metric.Value</span>
                    <span class="tp-chip @metric.Tone">@I18n.T(metric.ChangeKey)</span>
                </div>
                <p class="tp-meta">@I18n.T(metric.MetaKey)</p>
            </article>
        }
    </section>

    <section class="tp-grid tp-grid-2">
        <article class="tp-card card">
            <h2>Buttons</h2>
            <div class="tp-row">
                <Button Type="@ButtonType.Primary">Primary</Button>
                <Button Type="@ButtonType.Default">Default</Button>
                <Button Ghost>Ghost</Button>
                <Button Danger>Danger</Button>
                <Button Type="@ButtonType.Link">Link</Button>
            </div>
        </article>
        <article class="tp-card card">
            <h2>Inputs</h2>
            <div class="tp-column">
                <Input TValue="string" Placeholder="Full name" Class="field-control" />
                <Input TValue="string" Placeholder="Email address" Class="field-control" />
                <select class="tp-html-select">
                    <option>Lead</option>
                    <option>Opportunity</option>
                    <option>Won</option>
                </select>
                <Input TValue="string" TextArea Placeholder="Notes..." Rows="3" Class="field-control field-textarea" />
            </div>
        </article>
    </section>

    <section class="tp-grid tp-grid-2">
        <article class="tp-card card">
            <h2>Mock Table</h2>
            <table class="tp-table">
                <thead>
                    <tr>
                        <th>@I18n.T("TP_TABLE_CUSTOMER")</th>
                        <th>@I18n.T("TP_TABLE_STAGE")</th>
                        <th>@I18n.T("TP_TABLE_OWNER")</th>
                        <th>@I18n.T("TP_TABLE_UPDATED")</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var row in Customers)
                    {
                        <tr>
                            <td>@row.Name</td>
                            <td>
                                <span class="tp-pill @row.Stage">@row.StageLabel</span>
                            </td>
                            <td>@row.Owner</td>
                            <td>@I18n.T(row.UpdatedKey)</td>
                        </tr>
                    }
                </tbody>
            </table>
        </article>
        <article class="tp-card card">
            <h2>Timeline</h2>
            <ul class="tp-timeline">
                @foreach (var log in Timeline)
                {
                    <li>
                        <div class="tp-dot"></div>
                        <div class="tp-timeline-content">
                            <div class="tp-timeline-head">
                                <strong>@I18n.T(log.TitleKey)</strong>
                                <span>@I18n.T(log.TimeKey)</span>
                            </div>
                            <p>@I18n.T(log.DescriptionKey)</p>
                        </div>
                    </li>
                }
            </ul>
        </article>
    </section>

    <section class="tp-grid tp-grid-2">
        <article class="tp-card card">
            <h2>Status & Alerts</h2>
            <div class="tp-row">
                <span class="tp-chip success">Active</span>
                <span class="tp-chip warning">Pending</span>
                <span class="tp-chip danger">Failed</span>
                <span class="tp-chip info">Info</span>
            </div>
            <Alert Message='@I18n.T("TP_ALERT_SYNC_SUCCESS")' Type="AlertType.Success" ShowIcon="true" />
            <Alert Message='@I18n.T("TP_ALERT_PENDING_TEMPLATES")' Type="AlertType.Warning" ShowIcon="true" />
            <Alert Message='@I18n.T("TP_ALERT_IMPORT_FAILED")' Type="AlertType.Error" ShowIcon="true" />
        </article>
        <article class="tp-card card">
            <h2>Form Layout (mock)</h2>
            <div class="tp-form">
                <label>@I18n.T("TP_LABEL_CUSTOMER_NAME")</label>
                <Input TValue="string" Placeholder="ACME Inc." Class="field-control" />
                <label>@I18n.T("TP_LABEL_OWNER")</label>
                <select class="tp-html-select">
                    <option>Alice</option>
                    <option>Bob</option>
                </select>
                <label>@I18n.T("TP_LABEL_NOTE")</label>
                <Input TValue="string" TextArea Rows="3" Placeholder='@I18n.T("TP_PLACEHOLDER_INTERNAL_NOTE")' Class="field-control field-textarea" />
                <div class="tp-form-actions">
                    <Button Ghost>@I18n.T("TP_BTN_CANCEL")</Button>
                    <Button Type="@ButtonType.Primary">@I18n.T("TP_BTN_SAVE")</Button>
                </div>
            </div>
        </article>
    </section>

    <section class="tp-grid tp-grid-2">
        <article class="tp-card card">
            <h2>Overlay Tokens</h2>
            <p class="tp-meta">@I18n.T("TP_OVERLAY_META")</p>
            <div class="tp-overlay-actions">
                <Button Type="@ButtonType.Primary" OnClick="OpenOverlayModal">@I18n.T("TP_BTN_OPEN_MODAL")</Button>
                <Button Ghost OnClick="OpenOverlayDrawer">@I18n.T("TP_BTN_OPEN_DRAWER")</Button>
            </div>
            <ul class="tp-overlay-hints">
                <li>@I18n.T("TP_HINT_MODAL_OFFSET")</li>
                <li>@I18n.T("TP_HINT_OVERLAY_BACKDROP")</li>
                <li>@I18n.T("TP_HINT_FOOTER_SPACING")</li>
            </ul>
        </article>
        <article class="tp-card card">
            <h2>Popover & Context Menu</h2>
            <div class="tp-overlay-stack">
                <Popover Title='@I18n.T("TP_POPOVER_TITLE")' OverlayClassName="calm-popover" Trigger="@(new[] { Trigger.Hover, Trigger.Click })">
                    <ContentTemplate>
                        <div class="tp-popover-content">
                            <p>@I18n.T("TP_POPOVER_BODY1")</p>
                            <p class="tp-popover-meta">@I18n.T("TP_POPOVER_BODY2")</p>
                        </div>
                    </ContentTemplate>
                    <ChildContent>
                        <Button Type="@ButtonType.Link">@I18n.T("TP_BTN_VIEW_POPOVER")</Button>
                    </ChildContent>
                </Popover>
                <Dropdown OverlayClassName="calm-dropdown" Trigger="@(new[] { Trigger.Click })">
                    <ChildContent>
                        <Button>@I18n.T("TP_BTN_QUICK_MENU")</Button>
                    </ChildContent>
                    <Overlay>
                        <div class="calm-dropdown-panel">
                            <div class="calm-dropdown-menu">
                                <button type="button">@I18n.T("TP_MENU_ASSIGN_OWNER")<span>@I18n.T("TP_MENU_ASSIGN_OWNER_DESC")</span></button>
                                <button type="button">@I18n.T("TP_MENU_SHARE_LINK")<span>@I18n.T("TP_MENU_SHARE_LINK_DESC")</span></button>
                                <button type="button">@I18n.T("TP_MENU_SAVE_TEMPLATE")<span>@I18n.T("TP_MENU_SAVE_TEMPLATE_DESC")</span></button>
                            </div>
                        </div>
                    </Overlay>
                </Dropdown>
                <Dropdown OverlayClassName="calm-dropdown" Trigger="@(new[] { Trigger.ContextMenu })">
                    <ChildContent>
                        <div class="tp-context-target" tabindex="0">
                            @I18n.T("TP_CONTEXT_HINT")
                        </div>
                    </ChildContent>
                    <Overlay>
                        <div class="calm-dropdown-panel">
                            <div class="calm-dropdown-menu">
                                <button type="button">@I18n.T("TP_CONTEXT_COPY_LINK")<span>Copy link</span></button>
                                <button type="button">@I18n.T("TP_CONTEXT_FOLLOW")<span>Follow updates</span></button>
                                <button type="button">@I18n.T("TP_CONTEXT_DELETE_DRAFT")<span>Move to archive</span></button>
                            </div>
                        </div>
                    </Overlay>
                </Dropdown>
            </div>
        </article>
    </section>

    <Modal Title='@I18n.T("TP_MODAL_TITLE")'
           WrapClassName="calm-modal"
           @bind-Visible="_overlayModalVisible"
           OnOk="CloseOverlayModal"
           OnCancel="CloseOverlayModal"
           OkText="@ModalOkText"
           CancelText="@ModalCancelText">
        <div class="tp-modal-body">
            <p>@I18n.T("TP_MODAL_BODY")</p>
            <ul>
                <li>@I18n.T("TP_MODAL_HINT_BG")</li>
                <li>@I18n.T("TP_MODAL_HINT_TYPEFACE")</li>
                <li>@I18n.T("TP_MODAL_HINT_MASK")</li>
            </ul>
        </div>
    </Modal>

    @if (_overlayDrawerVisible)
    {
        <div class="drawer-demo-root">
            <div class="ant-drawer ant-drawer-open ant-drawer-right">
                <div class="ant-drawer-mask" @onclick="CloseOverlayDrawer"></div>
                <div class="ant-drawer-content-wrapper calm-drawer">
                    <div class="ant-drawer-content">
                        <div class="ant-drawer-wrapper-body">
                            <div class="ant-drawer-header">
                                <div class="ant-drawer-title">@I18n.T("TP_DRAWER_TITLE")</div>
                                <button type="button" class="ant-drawer-close" @onclick="CloseOverlayDrawer">
                                    <Icon Type="close" />
                                </button>
                            </div>
                            <div class="ant-drawer-body">
                                <div class="tp-drawer-section">
                                    <h3>@I18n.T("TP_DRAWER_SECTION_TITLE")</h3>
                                    <p>@I18n.T("TP_DRAWER_SECTION_DESC")</p>
                                    <div class="tp-drawer-fields">
                                        <div>
                                            <label>@I18n.T("TP_LABEL_BLOCK_TITLE")</label>
                                            <Input TValue="string" Placeholder='@I18n.T("TP_PLACEHOLDER_BLOCK_TITLE")' Class="field-control" />
                                        </div>
                                        <div>
                                            <label>@I18n.T("TP_LABEL_DENSITY")</label>
                                            <Select TItem="string" TItemValue="string" TValue="string" Class="field-control" @bind-Value="_drawerDensity">
                                                <SelectOption TItem="string" TItemValue="string" Value="@("comfortable")" Label='@I18n.T("TP_DENSITY_COMFORTABLE")' />
                                                <SelectOption TItem="string" TItemValue="string" Value="@("compact")" Label='@I18n.T("TP_DENSITY_COMPACT")' />
                                            </Select>
                                        </div>
                                    </div>
                                    <div class="tp-drawer-footer">
                                        <Button Ghost OnClick="CloseOverlayDrawer">@I18n.T("TP_BTN_CANCEL")</Button>
                                        <Button Type="@ButtonType.Primary">@I18n.T("TP_BTN_SAVE_CONFIG")</Button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private record MetricItem(string LabelKey, string Value, string ChangeKey, string Tone, string MetaKey);
    private record CustomerRow(string Name, string Stage, string StageLabel, string Owner, string UpdatedKey);
    private record TimelineEntry(string TitleKey, string DescriptionKey, string TimeKey);

    private List<MetricItem> Metrics { get; } =
    [
        new("TP_METRIC_LABEL_ARR", "Â¥ 2.18M", "TP_METRIC_CHANGE_ARR", "success", "TP_METRIC_META_ARR"),
        new("TP_METRIC_LABEL_DEALS", "54", "TP_METRIC_CHANGE_DEALS", "info", "TP_METRIC_META_DEALS"),
        new("TP_METRIC_LABEL_TICKETS", "17", "TP_METRIC_CHANGE_TICKETS", "warning", "TP_METRIC_META_TICKETS")
    ];

    private List<CustomerRow> Customers { get; } =
    [
        new("ACME Holdings", "success", "Won", "Alice", "TP_UPDATED_TODAY_0930"),
        new("Helios Labs", "warning", "Negotiation", "Bob", "TP_UPDATED_YESTERDAY_1710"),
        new("Nova Retail", "danger", "Escalated", "Carol", "TP_UPDATED_TWO_DAYS_AGO")
    ];

    private List<TimelineEntry> Timeline { get; } =
    [
        new("TP_TIMELINE_CREATE", "TP_TIMELINE_CREATE_DESC", "TP_TIMELINE_TIME_TODAY"),
        new("TP_TIMELINE_APPROVAL", "TP_TIMELINE_APPROVAL_DESC", "TP_TIMELINE_TIME_YESTERDAY"),
        new("TP_TIMELINE_FOLLOWUP", "TP_TIMELINE_FOLLOWUP_DESC", "TP_TIMELINE_TIME_MONDAY")
    ];

    protected override void OnInitialized()
    {
        base.OnInitialized();
        I18n.OnChanged += HandleI18nChanged;
    }

    private void HandleI18nChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        I18n.OnChanged -= HandleI18nChanged;
    }

    private async Task SwitchTheme(string theme)
    {
        await ThemeState.SetThemeAsync(theme);
        StateHasChanged();
    }

    private bool _overlayModalVisible;
    private bool _overlayDrawerVisible;
    private string _drawerDensity = "comfortable";
    private string ModalOkText => I18n.T("TP_BTN_CONFIRM");
    private string ModalCancelText => I18n.T("TP_BTN_CANCEL");

    private void OpenOverlayModal() => _overlayModalVisible = true;
    private void CloseOverlayModal() => _overlayModalVisible = false;
    private void OpenOverlayDrawer() => _overlayDrawerVisible = true;
    private void CloseOverlayDrawer() => _overlayDrawerVisible = false;
}



