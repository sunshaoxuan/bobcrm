@page "/theme-playground"
@rendermode RenderMode.InteractiveServer
@using AntDesign
@using BobCrm.App.Services
@inject ThemeState ThemeState

<PageTitle>Calm Theme Playground</PageTitle>

<div class="tp-root">
    <header class="tp-header">
        <div>
            <p class="tp-eyebrow">Calm Neumorphic Glass CRM</p>
            <h1>Theme Playground</h1>
            <p class="tp-subtitle">设计 Token、Light / Dark 主题与 Ant Design 覆写的可视校验页。</p>
        </div>
        <div class="tp-theme-switch">
            <span>Theme</span>
            <Button OnClick="() => SwitchTheme(ThemeState.CalmLight)" Type="@ButtonType.Default">Calm Light</Button>
            <Button OnClick="() => SwitchTheme(ThemeState.CalmDark)" Type="@ButtonType.Dashed">Calm Dark</Button>
        </div>
    </header>

    <section class="tp-grid tp-grid-3">
        @foreach (var metric in Metrics)
        {
            <article class="tp-card card metric-card">
                <p class="tp-label">@metric.Label</p>
                <div class="tp-metric">
                    <span>@metric.Value</span>
                    <span class="tp-chip @metric.Tone">@metric.Change</span>
                </div>
                <p class="tp-meta">@metric.Meta</p>
            </article>
        }
    </section>

    <section class="tp-grid tp-grid-2">
        <article class="tp-card card">
            <h2>Buttons</h2>
            <div class="tp-row">
                <Button Type="@ButtonType.Primary">Primary</Button>
                <Button Type="@ButtonType.Default">Default</Button>
                <Button Ghost>Ghost</Button>
                <Button Danger>Danger</Button>
                <Button Type="@ButtonType.Link">Link</Button>
            </div>
        </article>
        <article class="tp-card card">
            <h2>Inputs</h2>
            <div class="tp-column">
                <Input TValue="string" Placeholder="Full name" Class="field-control" />
                <Input TValue="string" Placeholder="Email address" Class="field-control" />
                <select class="tp-html-select">
                    <option>Lead</option>
                    <option>Opportunity</option>
                    <option>Won</option>
                </select>
                <Input TValue="string" TextArea Placeholder="Notes..." Rows="3" Class="field-control field-textarea" />
            </div>
        </article>
    </section>

    <section class="tp-grid tp-grid-2">
        <article class="tp-card card">
            <h2>Mock Table</h2>
            <table class="tp-table">
                <thead>
                    <tr>
                        <th>客户</th>
                        <th>阶段</th>
                        <th>负责人</th>
                        <th>更新时间</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var row in Customers)
                    {
                        <tr>
                            <td>@row.Name</td>
                            <td>
                                <span class="tp-pill @row.Stage">@row.StageLabel</span>
                            </td>
                            <td>@row.Owner</td>
                            <td>@row.Updated</td>
                        </tr>
                    }
                </tbody>
            </table>
        </article>
        <article class="tp-card card">
            <h2>Timeline</h2>
            <ul class="tp-timeline">
                @foreach (var log in Timeline)
                {
                    <li>
                        <div class="tp-dot"></div>
                        <div class="tp-timeline-content">
                            <div class="tp-timeline-head">
                                <strong>@log.Title</strong>
                                <span>@log.Time</span>
                            </div>
                            <p>@log.Description</p>
                        </div>
                    </li>
                }
            </ul>
        </article>
    </section>

    <section class="tp-grid tp-grid-2">
        <article class="tp-card card">
            <h2>Status & Alerts</h2>
            <div class="tp-row">
                <span class="tp-chip success">Active</span>
                <span class="tp-chip warning">Pending</span>
                <span class="tp-chip danger">Failed</span>
                <span class="tp-chip info">Info</span>
            </div>
            <Alert Message="成功同步客户数据" Type="AlertType.Success" ShowIcon="true" />
            <Alert Message="待审核的模板" Type="AlertType.Warning" ShowIcon="true" />
            <Alert Message="导入失败，请重试" Type="AlertType.Error" ShowIcon="true" />
        </article>
        <article class="tp-card card">
            <h2>Form Layout (mock)</h2>
            <div class="tp-form">
                <label>客户名称</label>
                <Input TValue="string" Placeholder="ACME Inc." Class="field-control" />
                <label>负责人</label>
                <select class="tp-html-select">
                    <option>Alice</option>
                    <option>Bob</option>
                </select>
                <label>备注</label>
                <Input TValue="string" TextArea Rows="3" Placeholder="内部备注..." Class="field-control field-textarea" />
                <div class="tp-form-actions">
                    <Button Ghost>取消</Button>
                    <Button Type="@ButtonType.Primary">保存</Button>
                </div>
            </div>
        </article>
    </section>

    <section class="tp-grid tp-grid-2">
        <article class="tp-card card">
            <h2>Overlay Tokens</h2>
            <p class="tp-meta">Calm Modal / Drawer 统一阴影、玻璃与分隔。</p>
            <div class="tp-overlay-actions">
                <Button Type="@ButtonType.Primary" OnClick="OpenOverlayModal">打开 Modal</Button>
                <Button Ghost OnClick="OpenOverlayDrawer">打开 Drawer</Button>
            </div>
            <ul class="tp-overlay-hints">
                <li>Modal 自 72px 顶部偏移，保持与 Header 间距。</li>
                <li>遮罩使用 `--overlay-backdrop` + blur，Light/Dark 自动切换。</li>
                <li>Footer 统一右对齐，按钮间距 `var(--spacing-3)`。</li>
            </ul>
        </article>
        <article class="tp-card card">
            <h2>Popover & Context Menu</h2>
            <div class="tp-overlay-stack">
                <Popover Title="提醒" OverlayClassName="calm-popover" Trigger="@(new[] { Trigger.Hover, Trigger.Click })">
                    <ContentTemplate>
                        <div class="tp-popover-content">
                            <p>使用 Calm 语义色变量，不写死 #hex。</p>
                            <p class="tp-popover-meta">Hover / Click 均可触发。</p>
                        </div>
                    </ContentTemplate>
                    <ChildContent>
                        <Button Type="@ButtonType.Link">查看 Popover</Button>
                    </ChildContent>
                </Popover>
                <Dropdown OverlayClassName="calm-dropdown" Trigger="@(new[] { Trigger.Click })">
                    <ChildContent>
                        <Button>快捷菜单</Button>
                    </ChildContent>
                    <Overlay>
                        <div class="calm-dropdown-panel">
                            <div class="calm-dropdown-menu">
                                <button type="button">指派拥有者<span>同步表单设计器</span></button>
                                <button type="button">生成共享链接<span>有效期 48 小时</span></button>
                                <button type="button">存为模板<span>保存当前布局</span></button>
                            </div>
                        </div>
                    </Overlay>
                </Dropdown>
                <Dropdown OverlayClassName="calm-dropdown" Trigger="@(new[] { Trigger.ContextMenu })">
                    <ChildContent>
                        <div class="tp-context-target" tabindex="0">
                            右键/长按此处预览 Context Menu
                        </div>
                    </ChildContent>
                    <Overlay>
                        <div class="calm-dropdown-panel">
                            <div class="calm-dropdown-menu">
                                <button type="button">复制链接<span>Copy link</span></button>
                                <button type="button">标记为关注<span>Follow updates</span></button>
                                <button type="button">删除草稿<span>Move to archive</span></button>
                            </div>
                        </div>
                    </Overlay>
                </Dropdown>
            </div>
        </article>
    </section>

    <Modal Title="Calm Modal 示例"
           WrapClassName="calm-modal"
           @bind-Visible="_overlayModalVisible"
           OnOk="CloseOverlayModal"
           OnCancel="CloseOverlayModal"
           OkText="@_modalOkText"
           CancelText="@_modalCancelText">
        <div class="tp-modal-body">
            <p>Modal 内容区遵循 24px 垂直节奏，支持分段文本、说明以及表单元素。</p>
            <ul>
                <li>背景使用 `--surface-elevated`，可透出底层玻璃。</li>
                <li>标题 / 内容 / Metadata 分别映射 Title/SubBody/Meta 字体。</li>
                <li>默认禁止 mask 点击关闭，避免误触。</li>
            </ul>
        </div>
    </Modal>

    @if (_overlayDrawerVisible)
    {
        <div class="drawer-demo-root">
            <div class="ant-drawer ant-drawer-open ant-drawer-right">
                <div class="ant-drawer-mask" @onclick="CloseOverlayDrawer"></div>
                <div class="ant-drawer-content-wrapper calm-drawer">
                    <div class="ant-drawer-content">
                        <div class="ant-drawer-wrapper-body">
                            <div class="ant-drawer-header">
                                <div class="ant-drawer-title">Calm Drawer 示例</div>
                                <button type="button" class="ant-drawer-close" @onclick="CloseOverlayDrawer">
                                    <Icon Type="close" />
                                </button>
                            </div>
                            <div class="ant-drawer-body">
                                <div class="tp-drawer-section">
                                    <h3>属性字段</h3>
                                    <p>Drawer 主体建议使用栅格或列表，便于在 Form Designer 中重用。</p>
                                    <div class="tp-drawer-fields">
                                        <div>
                                            <label>区块标题</label>
                                            <Input TValue="string" Placeholder="如：客户标签" Class="field-control" />
                                        </div>
                                        <div>
                                            <label>显示密度</label>
                                            <Select TItem="string" TItemValue="string" TValue="string" Class="field-control" @bind-Value="_drawerDensity">
                                                <SelectOption TItem="string" TItemValue="string" Value="@("comfortable")" Label="舒适" />
                                                <SelectOption TItem="string" TItemValue="string" Value="@("compact")" Label="紧凑" />
                                            </Select>
                                        </div>
                                    </div>
                                    <div class="tp-drawer-footer">
                                        <Button Ghost OnClick="CloseOverlayDrawer">取消</Button>
                                        <Button Type="@ButtonType.Primary">保存配置</Button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private record MetricItem(string Label, string Value, string Change, string Tone, string Meta);
    private record CustomerRow(string Name, string Stage, string StageLabel, string Owner, string Updated);
    private record TimelineEntry(string Title, string Description, string Time);

    private List<MetricItem> Metrics { get; } =
    [
        new("Total ARR", "¥ 2.18M", "+8.4% MoM", "success", "本月新增 12 个合同"),
        new("Active Deals", "54", "+3 环比", "info", "平均周期 23 天"),
        new("Support Tickets", "17", "-2 QoQ", "warning", "3 个 SLA 即将到期")
    ];

    private List<CustomerRow> Customers { get; } =
    [
        new("ACME Holdings", "success", "Won", "Alice", "今天 09:30"),
        new("Helios Labs", "warning", "Negotiation", "Bob", "昨天 17:10"),
        new("Nova Retail", "danger", "Escalated", "Carol", "两天前")
    ];

    private List<TimelineEntry> Timeline { get; } =
    [
        new("创建商机", "Alice 创建了 ACME 商机并分配给销售团队。", "今天 08:40"),
        new("报价审批", "Bob 上传新版报价并完成审批流程。", "昨天 15:25"),
        new("客户回访", "Carol 与 Nova 客户完成季度回访。", "本周一")
    ];

    private async Task SwitchTheme(string theme)
    {
        await ThemeState.SetThemeAsync(theme);
        StateHasChanged();
    }

    private bool _overlayModalVisible;
    private bool _overlayDrawerVisible;
    private string _drawerDensity = "comfortable";
    private readonly string _modalOkText = "确认";
    private readonly string _modalCancelText = "取消";

    private void OpenOverlayModal() => _overlayModalVisible = true;
    private void CloseOverlayModal() => _overlayModalVisible = false;
    private void OpenOverlayDrawer() => _overlayDrawerVisible = true;
    private void CloseOverlayDrawer() => _overlayDrawerVisible = false;
}

