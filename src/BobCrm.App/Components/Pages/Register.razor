@page "/register"

@inject BobCrm.App.Services.I18nService I18n
@layout BobCrm.App.Components.Layout.AuthLayout

<AuthShell HeroTitle='@I18n.T("TXT_AUTH_REGISTER_TITLE")'
           HeroSubtitle='@I18n.T("TXT_AUTH_REGISTER_SUBTITLE")'
           Eyebrow='@I18n.T("LBL_SECURE")'
           PanelEyebrow='@I18n.T("LBL_CREATE_ACCOUNT")'
           FormTitle='@I18n.T("LBL_REGISTER")'
           FormDescription='@I18n.T("TXT_REGISTER_DESCRIPTION")'>
    <ChildContent>
        <EditForm Model="_model" OnValidSubmit="HandleRegisterAsync" class="auth-form">
            <DataAnnotationsValidator />
            <ValidationSummary class="auth-message error" />
            <div class="auth-field">
                <label for="register-username">@I18n.T("LBL_USERNAME")</label>
                <Input id="register-username" @bind-Value="_model.Username" Class="field-control" />
            </div>
            <div class="auth-field">
                <label for="register-email">@I18n.T("LBL_EMAIL")</label>
                <Input id="register-email" @bind-Value="_model.Email" Class="field-control" />
            </div>
            <div class="auth-field">
                <label for="register-password">@I18n.T("LBL_PASSWORD")</label>
                <input id="register-password"
                       type="password"
                       class="field-control"
                       @bind="_model.Password"
                       @bind:event="oninput" />
            </div>
            <Button Type="ButtonType.Primary" HtmlType="submit" Loading="_submitting">@I18n.T("BTN_REGISTER")</Button>
        </EditForm>
        @if (!string.IsNullOrEmpty(_error))
        {
            <div class="auth-message error">@_error</div>
        }
    </ChildContent>
    <Footer>
        <span>@I18n.T("TXT_REGISTER_HELP") <a href="/activate">@I18n.T("LBL_ACTIVATE_TITLE")</a></span>
    </Footer>
</AuthShell>

@code {
    private RegModel _model = new();
    private string? _error;
    private bool _submitting;
    private bool _initialized;

    [Inject] public IHttpClientFactory HttpFactory { get; set; } = default!;
    [Inject] public MessageService Message { get; set; } = default!;
    [Inject] public NavigationManager Nav { get; set; } = default!;
    [Inject] public BobCrm.App.Services.IJsInteropService JS { get; set; } = default!;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_initialized)
        {
            return;
        }

        try
        {
            var (jsReady, _) = await JS.TryInvokeAsync<string?>("bobcrm.getLocalStorageItem", "lang");
            if (!jsReady)
            {
                return;
            }

            var (_, savedLang) = await JS.TryInvokeAsync<string?>("bobcrm.getCookie", "lang");
            var langToLoad = !string.IsNullOrWhiteSpace(savedLang) ? savedLang! : "ja";
            await I18n.LoadAsync(langToLoad);
            await JS.TryInvokeVoidAsync("bobcrm.setLang", langToLoad);
            _initialized = true;
        }
        catch { /* Ignore: retry next render */ }
    }

    private async Task HandleRegisterAsync()
    {
        _submitting = true;
        _error = null;
        try
        {
            var http = HttpFactory.CreateClient("api");
            var (langOk, lang) = await JS.TryInvokeAsync<string?>("bobcrm.getLocalStorageItem", "lang");
            if (langOk && !string.IsNullOrWhiteSpace(lang))
            {
                if (http.DefaultRequestHeaders.Contains("X-Lang"))
                {
                    http.DefaultRequestHeaders.Remove("X-Lang");
                }
                http.DefaultRequestHeaders.Add("X-Lang", lang!.ToLowerInvariant());
            }

            var resp = await http.PostAsJsonAsync("/api/auth/register", new { username = _model.Username, password = _model.Password, email = _model.Email });
            if (!resp.IsSuccessStatusCode)
            {
                _error = await resp.Content.ReadAsStringAsync();
                return;
            }

            Message.Success(I18n.T("MSG_REGISTER_SUCCESS"));
            Nav.NavigateTo("/activate");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _submitting = false;
        }
    }

    class RegModel
    {
        public string Username { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}


