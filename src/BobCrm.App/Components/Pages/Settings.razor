@page "/settings"
@rendermode RenderMode.InteractiveServer
@implements IDisposable
@inject BobCrm.App.Services.AuthService Auth
@inject BobCrm.App.Services.I18nService I18n
@inject IJSRuntime JS
@inject NavigationManager Nav

<PageTitle>@I18n.T("MENU_SETTINGS") - OneCRM</PageTitle>

<div style="max-width:1200px; margin:0 auto">
    <h2 style="margin-bottom:24px; color:var(--text); font-size:24px; font-weight:600">@I18n.T("MENU_SETTINGS")</h2>

    @if (loading)
    {
        <div style="padding:48px; text-align:center; color:var(--muted)">
            @I18n.T("LBL_LOADING")...
        </div>
    }
    else
    {
        <div style="display:grid; gap:24px">
            <!-- Language Settings -->
            <div class="settings-section">
                <h3 class="section-title">@I18n.T("LBL_LANGUAGE")</h3>
                <div class="settings-card">
                    <div class="setting-item">
                        <label class="setting-label">@I18n.T("LBL_LANGUAGE")</label>
                        <select @bind="currentLanguage" @bind:after="SaveLanguagePreference" class="field-control" style="max-width:300px">
                            <option value="zh">中文</option>
                            <option value="ja">日本語</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Save Status -->
            @if (!string.IsNullOrWhiteSpace(saveMessage))
            {
                <div class="save-message @(saveSuccess ? "success" : "error")">
                    @saveMessage
                </div>
            }
        </div>
    }
</div>

<style>
    .settings-section {
        margin-bottom: 16px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--primary);
    }

    .settings-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        box-shadow: var(--shadow);
    }

    .setting-item {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 16px;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border);
    }

    .setting-item:last-child {
        border-bottom: none;
    }

    .setting-label {
        font-weight: 500;
        color: var(--text);
        font-size: 14px;
    }

    .save-message {
        padding: 12px 16px;
        border-radius: 6px;
        font-size: 14px;
        text-align: center;
        animation: slideIn 0.3s ease;
    }

    .save-message.success {
        background: #f0f9ff;
        color: #0c4a6e;
        border: 1px solid #7dd3fc;
    }

    .save-message.error {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }

    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

@code {
    private bool loading = true;
    private string currentLanguage = "ja";
    private string saveMessage = "";
    private bool saveSuccess = false;

    protected override void OnInitialized()
    {
        I18n.OnChanged += HandleI18nChanged;
    }

    private void HandleI18nChanged()
    {
        try { InvokeAsync(StateHasChanged); } catch { }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            // 预检查：确保已认证，触发单飞刷新机制，避免并发刷新
            var authenticated = await Auth.EnsureAuthenticatedAsync();
            if (!authenticated)
            {
                // 全局 OnUnauthorized 事件会处理跳转
                loading = false;
                await InvokeAsync(StateHasChanged);
                return;
            }

            // Load current preferences from server (database)
            var prefsResp = await Auth.GetWithRefreshAsync("/api/user/preferences");
            if (prefsResp.IsSuccessStatusCode)
            {
                var prefs = await prefsResp.Content.ReadFromJsonAsync<UserPreferencesDto>();
                currentLanguage = prefs?.language ?? "ja";
                await JS.InvokeVoidAsync("console.log", $"[Settings] Loaded from server: language={currentLanguage}");
            }
            else
            {
                currentLanguage = await JS.InvokeAsync<string?>("bobcrm.getCookie", "lang") ?? "ja";
            }

            loading = false;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[Settings] Error: {ex.Message}");
            loading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SaveLanguagePreference()
    {
        try
        {
            // 保存语言到cookie（365天有效期）
            await JS.InvokeVoidAsync("bobcrm.setCookie", "lang", currentLanguage, 365);
            // 加载新语言资源
            await I18n.LoadAsync(currentLanguage);
            var saved = await SaveToServer();
            ShowMessage(saved ? "Language saved successfully" : "Language saved locally", saved);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[Settings] Save language error: {ex.Message}");
            ShowMessage("Failed to save language", false);
        }
    }

    private async Task<bool> SaveToServer()
    {
        try
        {
            var prefs = new
            {
                language = currentLanguage
            };
            var resp = await Auth.PutAsJsonWithRefreshAsync("/api/user/preferences", prefs);
            if (!resp.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("console.error", $"[Settings] Server save failed: {resp.StatusCode}");
                return false;
            }
            else
            {
                await JS.InvokeVoidAsync("console.log", $"[Settings] Preferences saved to server: language={currentLanguage}");
                return true;
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"[Settings] SaveToServer error: {ex.Message}");
            return false;
        }
    }

    private void ShowMessage(string message, bool success)
    {
        saveMessage = message;
        saveSuccess = success;
        StateHasChanged();

        // Clear message after 3 seconds
        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            saveMessage = "";
            InvokeAsync(StateHasChanged);
        });
    }

    public void Dispose()
    {
        I18n.OnChanged -= HandleI18nChanged;
    }

    private class UserPreferencesDto
    {
        public string? language { get; set; }
    }
}
