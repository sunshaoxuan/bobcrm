@page "/activate"
@layout BobCrm.App.Components.Layout.AuthLayout

<AuthShell HeroTitle='@I18n.T("TXT_AUTH_ACTIVATE_TITLE")'
           HeroSubtitle='@I18n.T("TXT_AUTH_ACTIVATE_SUBTITLE")'
           Eyebrow='@I18n.T("LBL_SECURE")'
           PanelEyebrow='@I18n.T("LBL_ACTIVATE_TITLE")'
           FormTitle='@I18n.T("LBL_ACTIVATE_TITLE")'
           FormDescription='@I18n.T("TXT_ACTIVATE_DESCRIPTION")'>
    <ChildContent>
        <div class="auth-form">
            <div class="auth-field">
                <label for="activate-user">@I18n.T("LBL_USER_ID")</label>
                <Input id="activate-user" @bind-Value="_userId" Class="field-control" />
            </div>
            <div class="auth-field">
                <label for="activate-code">@I18n.T("LBL_CODE")</label>
                <Input id="activate-code" @bind-Value="_code" Class="field-control" />
            </div>
            <Button Type="ButtonType.Primary" OnClick="HandleActivateAsync" Loading="_activating">@I18n.T("BTN_ACTIVATE")</Button>
            @if (!string.IsNullOrWhiteSpace(_msg))
            {
                <div class="auth-message error">@_msg</div>
            }
        </div>
    </ChildContent>
    <Footer>
        <span>@I18n.T("TXT_BACK_TO_LOGIN") <a href="/login">@I18n.T("LBL_LOGIN_TITLE")</a></span>
    </Footer>
</AuthShell>

@code {
    private string? _userId;
    private string? _code;
    private string? _msg;
    private bool _activating;

    [Inject] public IHttpClientFactory HttpFactory { get; set; } = default!;
    [Inject] public NavigationManager Nav { get; set; } = default!;
    [Inject] public MessageService Message { get; set; } = default!;
    [Inject] public IJSRuntime JS { get; set; } = default!;

    [Inject] public BobCrm.App.Services.I18nService I18n { get; set; } = default!;

    protected override Task OnInitializedAsync()
    {
        // 支持从 URL 查询参数预填
        var uri = new Uri(Nav.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        _userId = query["userId"] ?? _userId;
        _code = query["code"] ?? _code;
        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var savedLang = await JS.InvokeAsync<string?>("bobcrm.getCookie", "lang");
                var langToLoad = !string.IsNullOrWhiteSpace(savedLang) ? savedLang! : "ja";
                await I18n.LoadAsync(langToLoad); try { await JS.InvokeVoidAsync("bobcrm.setLang", langToLoad); } catch { }
            }
            catch { }
        }
    }

    private async Task HandleActivateAsync()
    {
        if (string.IsNullOrWhiteSpace(_userId) || string.IsNullOrWhiteSpace(_code))
        {
            _msg = I18n.T("ERR_ACTIVATE_FILL");
            return;
        }

        _activating = true;
        _msg = null;
        try
        {
            var http = HttpFactory.CreateClient("api");
            try
            {
                var lang = await JS.InvokeAsync<string?>("localStorage.getItem", "lang");
                if (!string.IsNullOrWhiteSpace(lang))
                {
                    if (http.DefaultRequestHeaders.Contains("X-Lang"))
                    {
                        http.DefaultRequestHeaders.Remove("X-Lang");
                    }
                    http.DefaultRequestHeaders.Add("X-Lang", lang!.ToLowerInvariant());
                }
            }
            catch { }

            var url = $"/api/auth/activate?userId={Uri.EscapeDataString(_userId)}&code={Uri.EscapeDataString(_code)}";
            var resp = await http.GetAsync(url);
            if (resp.IsSuccessStatusCode)
            {
                await Message.Success(I18n.T("MSG_ACTIVATE_SUCCESS"));
                Nav.NavigateTo("/login");
            }
            else
            {
                _msg = $"{I18n.T("ERR_ACTIVATE_FAILED")}: {resp.StatusCode} {await resp.Content.ReadAsStringAsync()}";
            }
        }
        finally
        {
            _activating = false;
        }
    }
}
