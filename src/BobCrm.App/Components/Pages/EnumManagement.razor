@page "/system/enums"
@using System.Net.Http.Json
@inject HttpClient Http
@inject BobCrm.App.Services.ToastService Toast
@inject NavigationManager Navigation

<PageTitle>枚举管理 - Enum Management</PageTitle>

<div class="enum-management-page">
    <h2>枚举管理 / Enum Management</h2>

    @if (_isLoading)
    {
        <p>加载中...</p>
    }
    else
    {
        <div class="enum-list">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>代码 / Code</th>
                        <th>显示名 / Display Name</th>
                        <th>系统枚举 / System</th>
                        <th>启用 / Enabled</th>
                        <th>选项数 / Options</th>
                        <th>操作 / Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var enumDef in _enums)
                    {
                        <tr>
                            <td><code>@enumDef.Code</code></td>
                            <td>@GetDisplayName(enumDef.DisplayName)</td>
                            <td>@(enumDef.IsSystem ? "✓" : "")</td>
                            <td>@(enumDef.IsEnabled ? "✓" : "✗")</td>
                            <td>@enumDef.Options.Count</td>
                            <td>
                                <button @onclick="() => ViewEnum(enumDef.Id)">查看</button>
                                @if (!enumDef.IsSystem)
                                {
                                    <button @onclick="() => DeleteEnum(enumDef.Id)">删除</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<style>
.enum-management-page {
    padding: 24px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
}

.data-table th,
.data-table td {
    border: 1px solid #ddd;
    padding: 12px;
    text-align: left;
}

.data-table th {
    background-color: #f5f5f5;
    font-weight: 600;
}

.data-table tr:hover {
    background-color: #f9f9f9;
}

.data-table button {
    margin-right: 8px;
    padding: 6px 12px;
    border: 1px solid #d9d9d9;
    background: white;
    cursor: pointer;
    border-radius: 4px;
}

.data-table button:hover {
    border-color: #40a9ff;
    color: #40a9ff;
}
</style>

@code {
    private bool _isLoading = true;
    private List<EnumDefinitionDto> _enums = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadEnumsAsync();
    }

    private async Task LoadEnumsAsync()
    {
        _isLoading = true;

        try
        {
            var response = await Http.GetAsync("/api/enums?includeDisabled=true");
            if (response.IsSuccessStatusCode)
            {
                _enums = await response.Content.ReadFromJsonAsync<List<EnumDefinitionDto>>() ?? new();
            }
            else
            {
                Toast.Error("加载枚举列表失败");
            }
        }
        catch (Exception ex)
        {
            Toast.Error($"加载失败: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ViewEnum(Guid id)
    {
        // TODO: 导航到详情页面或显示详情
        Toast.Info($"查看枚举: {id}");
    }

    private async Task DeleteEnum(Guid id)
    {
        if (!confirm("确定要删除此枚举吗？"))
        {
            return;
        }

        try
        {
            var response = await Http.DeleteAsync($"/api/enums/{id}");
            if (response.IsSuccessStatusCode)
            {
                Toast.Success("删除成功");
                await LoadEnumsAsync();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Toast.Error($"删除失败: {error}");
            }
        }
        catch (Exception ex)
        {
            Toast.Error($"删除失败: {ex.Message}");
        }
    }

    private bool confirm(string message)
    {
        // TODO: 使用更好的确认对话框
        return true; // 暂时自动确认
    }

    private string GetDisplayName(Dictionary<string, string?> displayName)
    {
        if (displayName.TryGetValue("zh", out var name) && !string.IsNullOrEmpty(name))
        {
            return name;
        }
        return displayName.Values.FirstOrDefault(v => !string.IsNullOrEmpty(v)) ?? "";
    }

    private class EnumDefinitionDto
    {
        public Guid Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public Dictionary<string, string?> DisplayName { get; set; } = new();
        public bool IsSystem { get; set; }
        public bool IsEnabled { get; set; }
        public List<EnumOptionDto> Options { get; set; } = new();
    }

    private class EnumOptionDto
    {
        public Guid Id { get; set; }
        public string Value { get; set; } = string.Empty;
        public Dictionary<string, string?> DisplayName { get; set; } = new();
        public int SortOrder { get; set; }
        public bool IsEnabled { get; set; }
    }
}
