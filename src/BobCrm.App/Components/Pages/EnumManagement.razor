@page "/system/enums"
@using BobCrm.Api.Contracts.DTOs
@using BobCrm.Api.Contracts.DTOs.Enum
@using AntDesign
@inject EnumDefinitionService EnumService
@inject I18nService I18n
@inject NavigationManager Nav
@inject ToastService Toast
@inject ModalService Modal

<PageTitle>@I18n.T("MENU_ENUM_MANAGEMENT")</PageTitle>

<AuthChecker>
    <PageHeader Title="@I18n.T("MENU_ENUM_MANAGEMENT")">
        <PageHeaderExtra>
            <Button Type="@ButtonType.Primary" Icon="@IconType.Outline.Plus" OnClick="CreateEnum">
                @I18n.T("BTN_NEW_ENUM")
            </Button>
        </PageHeaderExtra>
    </PageHeader>

    <div style="padding: 24px;">
        @if (_loading)
        {
            <Spin Tip="@I18n.T("LBL_LOADING")" />
        }
        else
        {
            <table class="enum-table">
                <thead>
                    <tr>
                        <th>@I18n.T("LBL_ENUM_CODE")</th>
                        <th>@I18n.T("LBL_DISPLAY_NAME")</th>
                        <th>@I18n.T("LBL_ENUM_OPTIONS")</th>
                        <th>@I18n.T("LBL_ENABLED")</th>
                        <th>@I18n.T("LBL_SYSTEM")</th>
                        <th>@I18n.T("LBL_ACTIONS")</th>
                    </tr>
                </thead>
                <tbody>
                    @if (_enums.Count == 0)
                    {
                        <tr>
                            <td colspan="6" style="text-align:center;padding:16px;">@I18n.T("LBL_NO_DATA")</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var enumDef in _enums)
                        {
                            <tr>
                                <td><Tag>@enumDef.Code</Tag></td>
                                <td>@GetDisplayName(enumDef.DisplayName, enumDef.DisplayNameTranslations)</td>
                                <td><span class="enum-option-count">@enumDef.Options.Count</span></td>
                                <td>
                                    <Tag Color="@((enumDef.IsEnabled ? "green" : "red"))">
                                        @(enumDef.IsEnabled ? I18n.T("LBL_ENABLED") : I18n.T("LBL_DISABLED"))
                                    </Tag>
                                </td>
                                <td>
                                    @if (enumDef.IsSystem)
                                    {
                                        <Tag Color="@("blue")">@I18n.T("LBL_SYSTEM")</Tag>
                                    }
                                </td>
                                <td>
                                    <Space>
                                        <SpaceItem>
                                            <Button Size="@ButtonSize.Small" OnClick="() => ViewEnum(enumDef.Id)">
                                                @I18n.T("BTN_VIEW")
                                            </Button>
                                        </SpaceItem>
                                        <SpaceItem>
                                            <Button Size="@ButtonSize.Small" OnClick="() => EditEnum(enumDef.Id)">
                                                @I18n.T("BTN_EDIT")
                                            </Button>
                                        </SpaceItem>
                                        @if (!enumDef.IsSystem)
                                        {
                                            <SpaceItem>
                                                <Button Size="@ButtonSize.Small" Danger OnClick="() => ConfirmDelete(enumDef.Id)">
                                                    @I18n.T("BTN_DELETE")
                                                </Button>
                                            </SpaceItem>
                                        }
                                    </Space>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        }
    </div>
</AuthChecker>

@code {
    private List<EnumDefinitionDto> _enums = new();
    private bool _loading;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            _loading = true;
            _enums = await EnumService.GetAllAsync();
        }
        catch (Exception ex)
        {
            Toast.Error($"{I18n.T("MSG_ENUM_LOAD_FAILED")}: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private void CreateEnum() => Nav.NavigateTo("/system/enums/create");
    private void ViewEnum(Guid id) => Nav.NavigateTo($"/system/enums/edit/{id}");
    private void EditEnum(Guid id) => Nav.NavigateTo($"/system/enums/edit/{id}");

    private async Task ConfirmDelete(Guid id)
    {
        var confirmed = await Modal.ConfirmAsync(new ConfirmOptions
        {
            Title = I18n.T("MSG_CONFIRM_DELETE_ENUM"),
            OkText = I18n.T("BTN_DELETE"),
            OkType = ButtonType.Primary,
            OkButtonProps = new ButtonProps { Danger = true },
            CancelText = I18n.T("BTN_CANCEL")
        });

        if (!confirmed) return;

        try
        {
            await EnumService.DeleteAsync(id);
            Toast.Success(I18n.T("MSG_ENUM_DELETE_SUCCESS"));
            await LoadAsync();
        }
        catch (Exception ex)
        {
            Toast.Error($"{I18n.T("MSG_ENUM_SAVE_FAILED")}: {ex.Message}");
        }
    }

    private string GetDisplayName(string? single, Dictionary<string, string?>? translations)
    {
        if (!string.IsNullOrWhiteSpace(single))
        {
            return single!;
        }

        if (translations == null) return string.Empty;

        var langOrder = new[]
        {
            I18n.CurrentLang,
            "ja",
            "zh",
            "en"
        };

        foreach (var lang in langOrder)
        {
            if (translations.TryGetValue(lang, out var value) && !string.IsNullOrWhiteSpace(value))
            {
                return value!;
            }
        }

        return translations.Values.FirstOrDefault(v => !string.IsNullOrWhiteSpace(v)) ?? string.Empty;
    }
}
