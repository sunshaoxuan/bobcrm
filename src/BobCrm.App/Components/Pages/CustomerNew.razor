@page "/customers/new"
@rendermode RenderMode.InteractiveServer

@inject BobCrm.App.Services.AuthService Auth
@inject NavigationManager Nav
@inject BobCrm.App.Services.IJsInteropService JS
@inject BobCrm.App.Services.I18nService I18n

<h1>@I18n.T("LBL_NEW_CUSTOMER")</h1>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger" role="alert" style="margin-bottom:16px; padding:12px; background:#fee; border:1px solid #fcc; border-radius:4px; color:#c33">
        @error
    </div>
}

<div class="card" style="max-width:600px; padding:24px">
    <div class="field" style="margin-bottom:16px">
        <label class="field-label">@I18n.T("COL_CODE") <span style="color:red">*</span></label>
        <input type="text" @bind="code" class="field-control" />
        <small class="field-hint">@I18n.T("LBL_CUSTOMER_CODE_HINT")</small>
    </div>

    <div class="field" style="margin-bottom:16px">
        <label class="field-label">@I18n.T("COL_NAME") <span style="color:red">*</span></label>
        <input type="text" @bind="name" class="field-control" />
    </div>

    <div style="display:flex; gap:12px">
        <button @onclick="Save" disabled="@saving" class="btn btn-primary">
            @(saving ? I18n.T("LBL_SAVING") : I18n.T("BTN_SAVE"))
        </button>
        <button @onclick="Cancel" class="btn btn-ghost">
            @I18n.T("BTN_CANCEL")
        </button>
    </div>
</div>

@code {
    private string code = string.Empty;
    private string name = string.Empty;
    private string? error;
    private bool saving = false;

    protected override void OnInitialized()
    {
        I18n.OnChanged += HandleI18nChanged;
    }

    private void HandleI18nChanged()
    {
        try { _ = InvokeAsync(StateHasChanged); }
        catch (ObjectDisposedException) { }
        catch (InvalidOperationException) { }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Load i18n first
            var (_, saved) = await JS.TryInvokeAsync<string?>("bobcrm.getCookie", "lang");
            var langToLoad = !string.IsNullOrWhiteSpace(saved) ? saved! : "ja";
            await I18n.LoadAsync(langToLoad);

            // Wait for UI to update after i18n load
            await InvokeAsync(StateHasChanged);

            // simple auth guard
            var (_, token) = await JS.TryInvokeAsync<string?>("localStorage.getItem", "accessToken");
            if (string.IsNullOrWhiteSpace(token)) { Nav.NavigateTo("/login"); return; }
        }
    }

    private async Task Save()
    {
        error = null;

        // Validation
        if (string.IsNullOrWhiteSpace(code))
        {
            error = I18n.T("ERR_CUSTOMER_CODE_REQUIRED");
            return;
        }

        if (string.IsNullOrWhiteSpace(name))
        {
            error = I18n.T("ERR_CUSTOMER_NAME_REQUIRED");
            return;
        }

        try
        {
            saving = true;
            StateHasChanged();

            var payload = new { code = code.Trim(), name = name.Trim() };
            var resp = await Auth.PostAsJsonWithRefreshAsync("/api/customers", payload);

            if (resp.IsSuccessStatusCode)
            {
                var result = await resp.Content.ReadFromJsonAsync<CreateCustomerResult>();
                if (result != null)
                {
                    // Navigate to the newly created customer
                    Nav.NavigateTo($"/customer/{result.id}");
                }
                else
                {
                    Nav.NavigateTo("/customers");
                }
            }
            else
            {
                var errorResponse = await resp.Content.ReadAsStringAsync();
                try
                {
                    var errorObj = System.Text.Json.JsonSerializer.Deserialize<ErrorResponse>(errorResponse);
                    error = errorObj?.error ?? $"{I18n.T("LBL_SAVE_FAILED")}: {(int)resp.StatusCode}";
                }
                catch
                {
                    error = $"{I18n.T("LBL_SAVE_FAILED")}: {(int)resp.StatusCode}";
                }
            }
        }
        catch (Exception ex)
        {
            error = $"{I18n.T("LBL_SAVE_FAILED")}: {ex.Message}";
        }
        finally
        {
            saving = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        Nav.NavigateTo("/customers");
    }

    private class CreateCustomerResult
    {
        public int id { get; set; }
        public string? code { get; set; }
        public string? name { get; set; }
    }

    private class ErrorResponse
    {
        public string? error { get; set; }
    }
}

