@rendermode RenderMode.InteractiveServer
@using BobCrm.App.Services
@implements IDisposable
@inject BobCrm.App.Services.AuthService Auth
@inject NavigationManager Nav
@inject I18nService I18n

<div class="@($"app-stage {( _isReady ? "ready" : "loading")}")">
    <BobCrm.App.Components.Shared.ThemeInitializer />
    <BobCrm.App.Components.Shared.PreferencesManager />
    <CascadingValue Value="_i18nRenderVersion">
        <Router AppAssembly="typeof(App).Assembly">
            <Found Context="routeData">
                <RouteView RouteData="routeData" DefaultLayout="typeof(BobCrm.App.Components.Layout.MainLayout)" />
                <FocusOnNavigate RouteData="routeData" Selector="h1" />
            </Found>
        </Router>
    </CascadingValue>
</div>
@if (!_isReady)
{
    <div class="app-splash">
        <div class="app-splash-card">
            <strong>OneCRM</strong>
            <p>@GetSplashText()</p>
        </div>
    </div>
}
@* 初次运行引导：如果未配置，建议用户访问 /setup *@

@code {
    private bool _isReady;
    private int _i18nRenderVersion;

    protected override void OnInitialized()
    {
        _isReady = I18n.IsLoaded;
        // 订阅全局未授权事件，统一跳转登录页
        Auth.OnUnauthorized += HandleUnauthorized;
        I18n.OnChanged += HandleI18nChanged;
    }

    private void HandleUnauthorized()
    {
        // 跳转到登录页并强制刷新，确保清理所有状态
        Nav.NavigateTo("/login", forceLoad: true);
    }

    private void HandleI18nChanged()
    {
        _isReady = true;
        if (I18n.IsLoaded)
        {
            _i18nRenderVersion++;
        }
        try { _ = InvokeAsync(StateHasChanged); }
        catch (ObjectDisposedException) { }
        catch (InvalidOperationException) { }
    }

    private string GetSplashText()
    {
        // I18n 未加载时避免展示资源键，使用固定文本兜底
        if (!I18n.IsLoaded)
        {
            return "Loading...";
        }

        var text = I18n.T("MSG_APP_LOADING");
        if (string.IsNullOrWhiteSpace(text) || text == "MSG_APP_LOADING")
        {
            return "Loading...";
        }

        return text;
    }

    public void Dispose()
    {
        Auth.OnUnauthorized -= HandleUnauthorized;
        I18n.OnChanged -= HandleI18nChanged;
    }
}

