@using BobCrm.App.Services
@implements IDisposable
@inject BobCrm.App.Services.AuthService Auth
@inject NavigationManager Nav
@inject I18nService I18n

<div class="@($"app-stage {(I18n.IsLoaded ? "ready" : "loading")}")">
    <BobCrm.App.Components.Shared.ThemeInitializer />
    <BobCrm.App.Components.Shared.PreferencesManager />
    <Router AppAssembly="typeof(Program).Assembly">
        <Found Context="routeData">
            <RouteView RouteData="routeData" DefaultLayout="typeof(BobCrm.App.Components.Layout.MainLayout)" />
            <FocusOnNavigate RouteData="routeData" Selector="h1" />
        </Found>
    </Router>
</div>

@if (!I18n.IsLoaded)
{
    <div class="app-splash">
        <div class="app-splash-card">
            <strong>OneCRM</strong>
            <p>正在准备界面，请稍候…</p>
        </div>
    </div>
}
@* 初次运行引导：如果未配置，建议用户访问 /setup *@

@code {
    protected override void OnInitialized()
    {
        // 订阅全局未授权事件，统一跳转登录页
        Auth.OnUnauthorized += HandleUnauthorized;
        I18n.OnChanged += HandleI18nChanged;
    }

    private void HandleUnauthorized()
    {
        // 跳转到登录页并强制刷新，确保清理所有状态
        Nav.NavigateTo("/login", forceLoad: true);
    }

    private void HandleI18nChanged()
    {
        try { InvokeAsync(StateHasChanged); } catch { }
    }

    public void Dispose()
    {
        Auth.OnUnauthorized -= HandleUnauthorized;
        I18n.OnChanged -= HandleI18nChanged;
    }
}
