@rendermode RenderMode.InteractiveServer
@using BobCrm.App.Services
@implements IDisposable
@inject BobCrm.App.Services.AuthService Auth
@inject NavigationManager Nav
@inject I18nService I18n
@inject IJsInteropService JS

<div class="@($"app-stage {( _isReady ? "ready" : "loading")}")">
    <BobCrm.App.Components.Shared.ThemeInitializer />
    <BobCrm.App.Components.Shared.PreferencesManager />
    <CascadingValue Value="_i18nRenderVersion">
        <Router AppAssembly="typeof(App).Assembly">
            <Found Context="routeData">
                <RouteView RouteData="routeData" DefaultLayout="typeof(BobCrm.App.Components.Layout.MainLayout)" />
                <FocusOnNavigate RouteData="routeData" Selector="h1" />
            </Found>
        </Router>
    </CascadingValue>
</div>
@if (!_isReady)
{
    <div class="app-splash">
        <div class="app-splash-card">
            <strong>OneCRM</strong>
            <p>@GetSplashText()</p>
        </div>
    </div>
}
@* 初次运行引导：如果未配置，建议用户访问 /setup *@

@code {
    private bool _isReady;
    private int _i18nRenderVersion;
    private bool _initialized;
    private bool _initRetryScheduled;
    private readonly CancellationTokenSource _failOpenCts = new();
    private bool _failOpenScheduled;

    protected override void OnInitialized()
    {
        _isReady = I18n.IsLoaded;
        // 订阅全局未授权事件，统一跳转登录页
        Auth.OnUnauthorized += HandleUnauthorized;
        I18n.OnChanged += HandleI18nChanged;

        // Fail-open: never block the entire UI on i18n load.
        // This is intentionally independent from JS availability; errors are logged via Console in prerender.
        if (!_isReady && !_failOpenScheduled)
        {
            _failOpenScheduled = true;
            _ = Task.Run(async () =>
            {
                try
                {
                    await Task.Delay(TimeSpan.FromSeconds(3), _failOpenCts.Token);
                    if (_isReady)
                    {
                        return;
                    }

                    _isReady = true;
                    Console.WriteLine("[Routes] I18n load timeout (>3s). Fail-open: hide splash and continue.");
                    try { await InvokeAsync(StateHasChanged); } catch { /* Ignored */ }
                }
                catch (OperationCanceledException) { }
                catch (Exception ex)
                {
                    Console.WriteLine($"[Routes] Fail-open timer error: {ex}");
                }
            });
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_initialized || I18n.IsLoaded)
        {
            return;
        }

        // Avoid initializing during prerender; retry when JS is available.
        var (jsReady, _) = await JS.TryInvokeAsync<string?>("bobcrm.getLocalStorageItem", "lang");
        if (!jsReady)
        {
            if (!_initRetryScheduled)
            {
                _initRetryScheduled = true;
                _ = Task.Run(async () =>
                {
                    try
                    {
                        await Task.Delay(300);
                        await InvokeAsync(StateHasChanged);
                    }
                    catch { /* Ignored */ }
                });
            }
            return;
        }

        try
        {
            var (_, savedLang) = await JS.TryInvokeAsync<string?>("bobcrm.getCookie", "lang");
            var langToLoad = !string.IsNullOrWhiteSpace(savedLang) ? savedLang! : "ja";

            var timeoutTask = Task.Delay(TimeSpan.FromSeconds(3), _failOpenCts.Token);
            var loadTask = I18n.LoadAsync(langToLoad);
            var completed = await Task.WhenAny(loadTask, timeoutTask);

            if (completed == timeoutTask)
            {
                _isReady = true;
                await JS.TryInvokeVoidAsync("console.warn", $"[Routes] I18n load did not finish within 3s (lang={langToLoad}). Fail-open: render UI without localization.");
            }
            else
            {
                await loadTask;
            }

            _initialized = true;
        }
        catch (Exception ex)
        {
            _isReady = true;
            _initialized = true;
            await JS.TryInvokeVoidAsync("console.error", $"[Routes] Init failed: {ex.Message}");
            Console.WriteLine($"[Routes] Init failed: {ex}");
        }
    }

    private void HandleUnauthorized()
    {
        // 跳转到登录页并强制刷新，确保清理所有状态
        Nav.NavigateTo("/login", forceLoad: true);
    }

    private void HandleI18nChanged()
    {
        _isReady = true;
        if (I18n.IsLoaded)
        {
            _i18nRenderVersion++;
        }
        try { _ = InvokeAsync(StateHasChanged); }
        catch (ObjectDisposedException) { }
        catch (InvalidOperationException) { }
    }

    private string GetSplashText()
    {
        // I18n 未加载时避免展示资源键，使用固定文本兜底
        if (!I18n.IsLoaded)
        {
            return "Loading...";
        }

        var text = I18n.T("MSG_APP_LOADING");
        if (string.IsNullOrWhiteSpace(text) || text == "MSG_APP_LOADING")
        {
            return "Loading...";
        }

        return text;
    }

    public void Dispose()
    {
        Auth.OnUnauthorized -= HandleUnauthorized;
        I18n.OnChanged -= HandleI18nChanged;
        _failOpenCts.Cancel();
        _failOpenCts.Dispose();
    }
}

