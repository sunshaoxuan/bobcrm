@using AntDesign
@using BobCrm.App.Models
@using BobCrm.App.Models.Widgets
@using BobCrm.App.Services.Widgets
@using System.Globalization
@using System.Text.Json

@if (Context is null)
{
    <span style="color:#999; font-size:12px;">Missing FormRuntimeContext</span>
}
else if (Context.RenderMode == FormRuntimeContext.Mode.Design)
{
    <div style="padding:6px; background:#fafafa; border:1px dashed #d9d9d9; border-radius:6px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <span style="font-size:12px; font-weight:600;">@Widget.Label</span>
            <Tag Color="@TagColor.Blue">Design</Tag>
        </div>
        <DatePicker Value="@currentDate"
                    ValueChanged="(DateTime? value) => OnDateChanged(value)"
                    Picker="DatePickerType.Date"
                    ShowTime="@Widget.ShowTime"
                    Disabled="true"
                    Style="width:100%;" />
    </div>
}
else if (Context.RenderMode == FormRuntimeContext.Mode.Edit)
{
    var errors = GetFieldErrors();
    var hasErrors = errors.Count > 0;
    <div style="display:flex; flex-direction:column; gap:6px;">
        <div class="runtime-field-label">@Widget.Label</div>
        <DatePicker Value="@currentDate"
                    ValueChanged="(DateTime? value) => OnDateChanged(value)"
                    Picker="DatePickerType.Date"
                    ShowTime="@Widget.ShowTime"
                    Disabled="false"
                    Style="width:100%;" />
        @if (hasErrors)
        {
            <div style="color:#cf1322; font-size:12px; line-height:1.4;">
                @foreach (var err in errors)
                {
                    <div>@err</div>
                }
            </div>
        }
    </div>
}
else
{
    var display = FormatDate(currentDate);
    <div style="display:flex; flex-direction:column; gap:4px; padding:4px 0;">
        <div class="runtime-field-label">@Widget.Label</div>
        <span>@(string.IsNullOrWhiteSpace(display) ? "--" : display)</span>
    </div>
}

@code {
    [Parameter, EditorRequired] public CalendarWidget Widget { get; set; } = default!;
    [CascadingParameter] public FormRuntimeContext? Context { get; set; }

    private DateTime? currentDate;

    protected override void OnParametersSet()
    {
        currentDate = ParseDate(GetValue());
    }

    private Task OnDateChanged(DateTime? value)
    {
        currentDate = value;
        SetValue(FormatDateForStore(value));
        ValidateField(value);
        return Task.CompletedTask;
    }

    private string? FormatDate(DateTime? dt)
    {
        if (!dt.HasValue) return null;
        try
        {
            return dt.Value.ToString(Widget.Format, CultureInfo.InvariantCulture);
        }
        catch
        {
            return dt.Value.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture);
        }
    }

    private string? FormatDateForStore(DateTime? dt) => FormatDate(dt);

    private DateTime? ParseDate(string? raw)
    {
        if (string.IsNullOrWhiteSpace(raw))
        {
            return Widget.DefaultValue;
        }

        if (DateTime.TryParse(raw, CultureInfo.InvariantCulture, DateTimeStyles.AssumeLocal, out var parsed))
        {
            return parsed;
        }

        if (DateTime.TryParse(raw, out parsed))
        {
            return parsed;
        }

        return Widget.DefaultValue;
    }

    private string? GetValue()
    {
        if (Context?.Data is null || string.IsNullOrWhiteSpace(Widget.DataField))
        {
            return Widget.DefaultValue?.ToString(Widget.Format, CultureInfo.InvariantCulture);
        }

        if (Context.Data is EditValueManager evm)
        {
            return evm.GetValue(Widget.DataField);
        }

        if (Context.Data is JsonElement json)
        {
            return GetValueFromJson(json, Widget.DataField);
        }

        if (Context.Data is IDictionary<string, object?> dict)
        {
            return dict.TryGetValue(Widget.DataField, out var v) ? v?.ToString() : null;
        }

        var prop = Context.Data.GetType().GetProperty(Widget.DataField);
        return prop?.GetValue(Context.Data)?.ToString();
    }

    private void SetValue(string? value)
    {
        if (Context?.Data is null || string.IsNullOrWhiteSpace(Widget.DataField))
        {
            return;
        }

        if (Context.Data is EditValueManager evm)
        {
            evm.SetValue(Widget.DataField, value);
            return;
        }

        if (Context.Data is IDictionary<string, object?> dict)
        {
            dict[Widget.DataField] = value;
            return;
        }

        var prop = Context.Data.GetType().GetProperty(Widget.DataField);
        if (prop?.CanWrite == true)
        {
            prop.SetValue(Context.Data, value);
        }
    }

    private void ValidateField(DateTime? value)
    {
        if (Context is null || string.IsNullOrWhiteSpace(Widget.DataField))
        {
            return;
        }

        Context.ValidateField(Widget.DataField, value);
    }

    private IReadOnlyList<string> GetFieldErrors()
    {
        if (Context is null || string.IsNullOrWhiteSpace(Widget.DataField))
        {
            return Array.Empty<string>();
        }

        return Context.GetErrors(Widget.DataField);
    }

    private static string? GetValueFromJson(JsonElement json, string key)
    {
        if (json.ValueKind == JsonValueKind.Object)
        {
            if (json.TryGetProperty("fields", out var fieldsElement) && fieldsElement.ValueKind == JsonValueKind.Array)
            {
                foreach (var field in fieldsElement.EnumerateArray())
                {
                    if (field.ValueKind != JsonValueKind.Object) continue;
                    if (field.TryGetProperty("key", out var keyProp) &&
                        string.Equals(keyProp.GetString(), key, StringComparison.OrdinalIgnoreCase) &&
                        field.TryGetProperty("value", out var valueProp))
                    {
                        return valueProp.GetString() ?? valueProp.ToString();
                    }
                }
            }

            foreach (var prop in json.EnumerateObject())
            {
                if (string.Equals(prop.Name, key, StringComparison.OrdinalIgnoreCase))
                {
                    return prop.Value.ToString();
                }
            }
        }

        return null;
    }
}
