@using AntDesign
@using BobCrm.App.Models
@using BobCrm.App.Models.Widgets
@using BobCrm.App.Services.Widgets
@using System.Text.Json
@inject BobCrm.App.Services.I18nService I18n

@if (Context is null)
{
    <span style="color:#999; font-size:12px;">Missing FormRuntimeContext</span>
}
else if (Context.RenderMode == FormRuntimeContext.Mode.Design)
{
    <div style="padding:6px; background:#fafafa; border:1px dashed #d9d9d9; border-radius:6px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <span style="font-size:12px; font-weight:600;">@Widget.Label</span>
            <Tag Color="@TagColor.Blue">Design</Tag>
        </div>
        <div style="min-height:64px; background:#fff; border:1px solid #e0e0e0; border-radius:2px; padding:6px;">
            <span style="font-size:12px; color:#999;">
                @(string.IsNullOrWhiteSpace(Widget.Placeholder) ? "--" : Widget.Placeholder)
            </span>
        </div>
    </div>
}
else if (Context.RenderMode == FormRuntimeContext.Mode.Edit || Context.RenderMode == FormRuntimeContext.Mode.Disabled)
{
    var disabled = Context.RenderMode == FormRuntimeContext.Mode.Disabled;
    var errors = GetFieldErrors();
    var hasErrors = errors.Count > 0;
    <div style="display:flex; flex-direction:column; gap:6px;">
        <div class="runtime-field-label">@Widget.Label</div>
        <TextArea Value="@currentValue"
                  OnChange="@OnValueChanged"
                  Placeholder="@Widget.Placeholder"
                  Rows="@GetRows()"
                  AutoSize="@Widget.AutoSize"
                  Disabled="@disabled"
                  @attributes="GetExtraAttributes()" />
        @if (hasErrors)
        {
            <div style="color:#cf1322; font-size:12px; line-height:1.4;">
                @foreach (var err in errors)
                {
                    <div>@err</div>
                }
            </div>
        }
    </div>
}
else
{
    var display = GetValue() ?? string.Empty;
    <div style="display:flex; flex-direction:column; gap:4px; padding:4px 0;">
        <div class="runtime-field-label">@Widget.Label</div>
        <span>@(string.IsNullOrWhiteSpace(display) ? "--" : display)</span>
    </div>
}

@code {
    [Parameter, EditorRequired] public TextareaWidget Widget { get; set; } = default!;
    [CascadingParameter] public FormRuntimeContext? Context { get; set; }

    private string currentValue = string.Empty;
    private bool _validatorsRegistered;

    protected override void OnParametersSet()
    {
        TryRegisterValidators();
        currentValue = GetValue() ?? string.Empty;
    }

    private Task OnValueChanged(string value)
    {
        if (Context?.RenderMode == FormRuntimeContext.Mode.Disabled)
        {
            return Task.CompletedTask;
        }

        currentValue = value ?? string.Empty;
        SetValue(currentValue);
        ValidateField(currentValue);
        return Task.CompletedTask;
    }

    private uint GetRows()
    {
        if (Widget.Rows <= 0)
        {
            return 3;
        }

        return (uint)Math.Min(50, Widget.Rows);
    }

    private IReadOnlyDictionary<string, object?> GetExtraAttributes()
    {
        if (!Widget.MaxLength.HasValue)
        {
            return new Dictionary<string, object?>(0);
        }

        return new Dictionary<string, object?>
        {
            ["MaxLength"] = Widget.MaxLength.Value
        };
    }

    private void TryRegisterValidators()
    {
        if (_validatorsRegistered)
        {
            return;
        }

        if (Context is null || string.IsNullOrWhiteSpace(Widget.DataField))
        {
            return;
        }

        var field = Widget.DataField;

        if (Widget.MinLength.HasValue && Widget.MinLength.Value > 0)
        {
            var min = Widget.MinLength.Value;
            Context.RegisterValidator(field, value =>
            {
                var s = value?.ToString() ?? string.Empty;
                return s.Length < min ? string.Format(I18n.T("MSG_VALIDATION_MIN_LENGTH"), min) : null;
            });
        }

        if (Widget.MaxLength.HasValue && Widget.MaxLength.Value > 0)
        {
            var max = Widget.MaxLength.Value;
            Context.RegisterValidator(field, value =>
            {
                var s = value?.ToString() ?? string.Empty;
                return s.Length > max ? string.Format(I18n.T("MSG_VALIDATION_MAX_LENGTH"), max) : null;
            });
        }

        _validatorsRegistered = true;
    }

    private void ValidateField(string? value)
    {
        if (Context is null || string.IsNullOrWhiteSpace(Widget.DataField))
        {
            return;
        }

        Context.ValidateField(Widget.DataField, value);
    }

    private IReadOnlyList<string> GetFieldErrors()
    {
        if (Context is null || string.IsNullOrWhiteSpace(Widget.DataField))
        {
            return Array.Empty<string>();
        }

        return Context.GetErrors(Widget.DataField);
    }

    private string? GetValue()
    {
        if (Context?.Data is null || string.IsNullOrWhiteSpace(Widget.DataField))
        {
            return Widget.DefaultValue;
        }

        if (Context.Data is EditValueManager evm)
        {
            return evm.GetValue(Widget.DataField);
        }

        if (Context.Data is JsonElement json)
        {
            return GetValueFromJson(json, Widget.DataField);
        }

        if (Context.Data is IDictionary<string, object?> dict)
        {
            return dict.TryGetValue(Widget.DataField, out var v) ? v?.ToString() : null;
        }

        var prop = Context.Data.GetType().GetProperty(Widget.DataField);
        return prop?.GetValue(Context.Data)?.ToString();
    }

    private void SetValue(string? value)
    {
        if (Context?.Data is null || string.IsNullOrWhiteSpace(Widget.DataField))
        {
            return;
        }

        if (Context.Data is EditValueManager evm)
        {
            evm.SetValue(Widget.DataField, value);
            return;
        }

        if (Context.Data is IDictionary<string, object?> dict)
        {
            dict[Widget.DataField] = value;
            return;
        }

        var prop = Context.Data.GetType().GetProperty(Widget.DataField);
        if (prop?.CanWrite == true)
        {
            prop.SetValue(Context.Data, value);
        }
    }

    private static string? GetValueFromJson(JsonElement json, string key)
    {
        if (json.ValueKind == JsonValueKind.Object)
        {
            if (json.TryGetProperty("fields", out var fieldsElement) && fieldsElement.ValueKind == JsonValueKind.Array)
            {
                foreach (var field in fieldsElement.EnumerateArray())
                {
                    if (field.ValueKind != JsonValueKind.Object) continue;
                    if (field.TryGetProperty("key", out var keyProp) &&
                        string.Equals(keyProp.GetString(), key, StringComparison.OrdinalIgnoreCase) &&
                        field.TryGetProperty("value", out var valueProp))
                    {
                        return valueProp.GetString() ?? valueProp.ToString();
                    }
                }
            }

            foreach (var prop in json.EnumerateObject())
            {
                if (string.Equals(prop.Name, key, StringComparison.OrdinalIgnoreCase))
                {
                    return prop.Value.ToString();
                }
            }
        }

        return null;
    }
}
