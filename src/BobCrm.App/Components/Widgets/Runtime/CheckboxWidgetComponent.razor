@using AntDesign
@using BobCrm.App.Models
@using BobCrm.App.Models.Widgets
@using BobCrm.App.Services.Widgets
@using System.Text.Json
@inject BobCrm.App.Services.I18nService I18n

@if (Context is null)
{
    <span style="color:#999; font-size:12px;">Missing FormRuntimeContext</span>
}
else if (Context.RenderMode == FormRuntimeContext.Mode.Design)
{
    <div style="padding:6px; background:#fafafa; border:1px dashed #d9d9d9; border-radius:6px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <span style="font-size:12px; font-weight:600;">@Widget.Label</span>
            <Tag Color="@TagColor.Blue">Design</Tag>
        </div>

        <div style="display:flex; flex-wrap:wrap; gap:8px;">
            @for (var i = 0; i < Math.Min(Widget.Items.Count == 0 ? 1 : Widget.Items.Count, 3); i++)
            {
                <div style="display:flex; align-items:center; gap:6px;">
                    <div style="width:14px; height:14px; border:1px solid #d9d9d9; border-radius:2px; background:#fff;"></div>
                    <span style="font-size:12px; color:#999;">
                        @(Widget.Items.Count == 0 ? Widget.Label : (Widget.Items[i].Label ?? Widget.Items[i].Value))
                    </span>
                </div>
            }
        </div>
    </div>
}
else if (Context.RenderMode == FormRuntimeContext.Mode.Edit || Context.RenderMode == FormRuntimeContext.Mode.Disabled)
{
    var disabled = Context.RenderMode == FormRuntimeContext.Mode.Disabled;
    var errors = GetFieldErrors();
    var hasErrors = errors.Count > 0;
    <div style="display:flex; flex-direction:column; gap:6px;">
        <div class="runtime-field-label">@Widget.Label</div>
        <div style="display:flex; flex-direction:@(Widget.Direction == "vertical" ? "column" : "row"); gap:8px; flex-wrap:wrap;">
            @if (Widget.Items.Count == 0)
            {
                <Checkbox @bind-Value="singleChecked" Disabled="@disabled" CheckedChanged="@OnSingleCheckedChanged">
                    @Widget.Label
                </Checkbox>
            }
            else
            {
                @foreach (var item in Widget.Items)
                {
                    var isChecked = selectedValues.Contains(item.Value);
                    <Checkbox Checked="@isChecked" Disabled="@disabled" CheckedChanged="@((bool v) => OnItemCheckedChanged(item.Value, v))">
                        @(item.Label ?? item.Value)
                    </Checkbox>
                }
            }
        </div>
        @if (hasErrors)
        {
            <div style="color:#cf1322; font-size:12px; line-height:1.4;">
                @foreach (var err in errors)
                {
                    <div>@err</div>
                }
            </div>
        }
    </div>
}
else
{
    var raw = GetValue() ?? string.Empty;
    var selected = raw.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(v => v.Trim()).ToHashSet(StringComparer.OrdinalIgnoreCase);
    var display = Widget.Items.Count > 0
        ? string.Join(", ", selected.Select(v => Widget.Items.FirstOrDefault(i => i.Value == v)?.Label ?? v))
        : (string.IsNullOrWhiteSpace(raw) ? "No" : "Yes");
    <div style="display:flex; flex-direction:column; gap:4px; padding:4px 0;">
        <div class="runtime-field-label">@Widget.Label</div>
        <span>@display</span>
    </div>
}

@code {
    [Parameter, EditorRequired] public CheckboxWidget Widget { get; set; } = default!;
    [CascadingParameter] public FormRuntimeContext? Context { get; set; }

    private bool singleChecked;
    private HashSet<string> selectedValues = new(StringComparer.OrdinalIgnoreCase);

    protected override void OnParametersSet()
    {
        var raw = GetValue() ?? string.Empty;
        selectedValues = raw.Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(v => v.Trim())
            .Where(v => !string.IsNullOrWhiteSpace(v))
            .ToHashSet(StringComparer.OrdinalIgnoreCase);
        singleChecked = !string.IsNullOrWhiteSpace(raw);
        TryRegisterValidators();
    }

    private Task OnSingleCheckedChanged(bool value)
    {
        if (Context?.RenderMode == FormRuntimeContext.Mode.Disabled)
        {
            return Task.CompletedTask;
        }

        singleChecked = value;
        SetValue(value ? "true" : string.Empty);
        ValidateField(value ? "true" : string.Empty);
        return Task.CompletedTask;
    }

    private void OnItemCheckedChanged(string itemValue, bool isChecked)
    {
        if (Context?.RenderMode == FormRuntimeContext.Mode.Disabled)
        {
            return;
        }

        if (isChecked)
        {
            selectedValues.Add(itemValue);
        }
        else
        {
            selectedValues.Remove(itemValue);
        }

        SetValue(string.Join(",", selectedValues));
        ValidateField(string.Join(",", selectedValues));
    }

    private string? GetValue()
    {
        if (Context?.Data is null || string.IsNullOrWhiteSpace(Widget.DataField))
        {
            return Widget.DefaultValue;
        }

        if (Context.Data is EditValueManager evm)
        {
            return evm.GetValue(Widget.DataField);
        }

        if (Context.Data is JsonElement json)
        {
            return GetValueFromJson(json, Widget.DataField);
        }

        if (Context.Data is IDictionary<string, object?> dict)
        {
            return dict.TryGetValue(Widget.DataField, out var v) ? v?.ToString() : null;
        }

        var prop = Context.Data.GetType().GetProperty(Widget.DataField);
        return prop?.GetValue(Context.Data)?.ToString();
    }

    private void SetValue(string? value)
    {
        if (Context?.Data is null || string.IsNullOrWhiteSpace(Widget.DataField))
        {
            return;
        }

        if (Context.Data is EditValueManager evm)
        {
            evm.SetValue(Widget.DataField, value);
            return;
        }

        if (Context.Data is IDictionary<string, object?> dict)
        {
            dict[Widget.DataField] = value;
            return;
        }

        var prop = Context.Data.GetType().GetProperty(Widget.DataField);
        if (prop?.CanWrite == true)
        {
            prop.SetValue(Context.Data, value);
        }
    }

    private void ValidateField(string? value)
    {
        if (Context is null || string.IsNullOrWhiteSpace(Widget.DataField))
        {
            return;
        }

        Context.ValidateField(Widget.DataField, value);
    }

    private bool _validatorsRegistered;

    private void TryRegisterValidators()
    {
        if (_validatorsRegistered)
        {
            return;
        }

        if (Context is null || string.IsNullOrWhiteSpace(Widget.DataField))
        {
            return;
        }

        if (Widget.Required)
        {
            var field = Widget.DataField;
            Context.RegisterValidator(field, value =>
            {
                var s = value?.ToString();
                return string.IsNullOrWhiteSpace(s) ? I18n.T("MSG_VALIDATION_REQUIRED") : null;
            });
        }

        _validatorsRegistered = true;
    }

    private IReadOnlyList<string> GetFieldErrors()
    {
        if (Context is null || string.IsNullOrWhiteSpace(Widget.DataField))
        {
            return Array.Empty<string>();
        }

        return Context.GetErrors(Widget.DataField);
    }

    private static string? GetValueFromJson(JsonElement json, string key)
    {
        if (json.ValueKind == JsonValueKind.Object)
        {
            if (json.TryGetProperty("fields", out var fieldsElement) && fieldsElement.ValueKind == JsonValueKind.Array)
            {
                foreach (var field in fieldsElement.EnumerateArray())
                {
                    if (field.ValueKind != JsonValueKind.Object) continue;
                    if (field.TryGetProperty("key", out var keyProp) &&
                        string.Equals(keyProp.GetString(), key, StringComparison.OrdinalIgnoreCase) &&
                        field.TryGetProperty("value", out var valueProp))
                    {
                        return valueProp.GetString() ?? valueProp.ToString();
                    }
                }
            }

            foreach (var prop in json.EnumerateObject())
            {
                if (string.Equals(prop.Name, key, StringComparison.OrdinalIgnoreCase))
                {
                    return prop.Value.ToString();
                }
            }
        }

        return null;
    }
}
