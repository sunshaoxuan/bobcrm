@rendermode RenderMode.InteractiveServer
@using BobCrm.App.Services
@inject PreferencesService PrefsService
@inject AuthService Auth
@inject IJSRuntime JS
@inject BobCrm.App.Services.I18nService I18n
@inject NavigationManager Nav
@implements IDisposable

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        try
        {
            var authenticated = await Auth.EnsureAuthenticatedAsync();
            if (!authenticated)
            {
                return;
            }

            var prefs = await PrefsService.LoadPreferencesAsync();
            var lang = !string.IsNullOrWhiteSpace(prefs.Language) ? prefs.Language! : "ja";

            try { await JS.InvokeVoidAsync("bobcrm.setCookie", "lang", lang, 365); } catch { }
            try { await JS.InvokeVoidAsync("bobcrm.setLang", lang); } catch { }
            await I18n.LoadAsync(lang);
        }
        catch
        {
            // Ignore preference initialization errors
        }
    }

    public void Dispose()
    {
        // No cleanup needed
    }
}
