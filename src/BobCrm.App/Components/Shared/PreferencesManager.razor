@rendermode RenderMode.InteractiveServer
@using BobCrm.App.Services
@inject PreferencesService PrefsService
@inject AuthService Auth
@inject IJSRuntime JS
@inject BobCrm.App.Services.I18nService I18n
@inject ThemeState ThemeState
@inject LayoutState Layout
@implements IDisposable

@code {
    private bool _initialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _initialized)
        {
            return;
        }

        _initialized = true;

        try
        {
            var authenticated = await Auth.EnsureAuthenticatedAsync();
            if (!authenticated)
            {
                await LoadLanguageFallbackAsync();
                return;
            }

            var snapshot = await PrefsService.LoadSnapshotAsync();
            if (snapshot is null)
            {
                await LoadLanguageFallbackAsync();
                return;
            }

            await ApplySnapshotAsync(snapshot);
        }
        catch
        {
            await LoadLanguageFallbackAsync();
        }
    }

    private async Task ApplySnapshotAsync(PreferencesService.UserSettingsSnapshot snapshot)
    {
        var lang = string.IsNullOrWhiteSpace(snapshot.Effective.Language)
            ? "ja"
            : snapshot.Effective.Language;
        await I18n.LoadAsync(lang);
        await ThemeState.SetThemeAsync(snapshot.Effective.Theme);
        Layout.SetNavMode(PreferencesService.ToLayoutMode(snapshot.Effective.NavDisplayMode));
    }

    private async Task LoadLanguageFallbackAsync()
    {
        var lang = "ja";
        try
        {
            lang = await JS.InvokeAsync<string?>("bobcrm.getCookie", "lang") ?? "ja";
        }
        catch
        {
            // JS 尚未准备好时直接使用默认语言
        }

        await I18n.LoadAsync(lang);
    }

    public void Dispose()
    {
        // no-op
    }
}
