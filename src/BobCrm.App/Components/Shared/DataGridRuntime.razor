@using BobCrm.App.Models.Widgets
@using BobCrm.App.Services
@using System.Text.Json
@using System.Linq
@using System.Globalization
@inject AuthService Auth
@inject BobCrm.App.Services.EnumDefinitionService EnumService
@inject BobCrm.App.Services.I18nService I18n
@inject NavigationManager Nav
@inject ILogger<DataGridRuntime> Logger

@* DataGrid widget runtime renderer *@

<div class="datagrid-runtime" style="@ContainerStyle">
    @if (!string.IsNullOrWhiteSpace(Widget.Label))
    {
        <div class="datagrid-header" style="font-weight:600; margin-bottom:12px; font-size:16px;">
            @Widget.Label
        </div>
    }

    @if (_isLoading)
    {
        <div style="padding:24px; text-align:center;">
            <span>@I18n.T("DGR_LOADING")</span>
        </div>
    }
    else if (_error != null)
    {
        <div style="padding:16px; background:#fff2f0; border:1px solid #ffccc7; border-radius:4px; color:#cf1322;">
            <strong>@I18n.T("DGR_ERROR_PREFIX"):</strong> @_error
        </div>
    }
    else if (_data != null)
    {
        <div class="datagrid-table" style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; @GetTableStyle()">
                <thead>
                    <tr style="background:#fafafa;">
                        @if (Widget.AllowMultiSelect)
                        {
                            <th style="width:40px; padding:12px; border:1px solid #e0e0e0; text-align:center;">
                                <input type="checkbox" />
                            </th>
                        }
                        @foreach (var column in _columns)
                        {
                            <th style="padding:12px; border:1px solid #e0e0e0; text-align:left; font-weight:600;">
                                @column.Label
                                @if (column.Sortable)
                                {
                                    <span style="margin-left:4px; cursor:pointer;">‚Üï</span>
                                }
                            </th>
                        }
                        @if (!string.IsNullOrWhiteSpace(Widget.RowActionsJson))
                        {
                            <th style="width:120px; padding:12px; border:1px solid #e0e0e0; text-align:center;">@I18n.T("LBL_ACTIONS")</th>
                        }
                    </tr>
                </thead>

                <tbody>
                    @if (_dataRows.Any())
                    {
                        @foreach (var row in _dataRows)
                        {
                            <tr style="background:#fff; cursor:pointer;" @onclick="@(() => HandleRowClick(row))">
                                @if (Widget.AllowMultiSelect)
                                {
                                    <td style="padding:12px; border:1px solid #e0e0e0; text-align:center;" @onclick:stopPropagation="true">
                                        <input type="checkbox" />
                                    </td>
                                }
                                @foreach (var column in _columns)
                                {
                                    <td style="padding:12px; border:1px solid #e0e0e0;">
                                        @GetCellValue(row, column.Field)
                                    </td>
                                }
                                @if (!string.IsNullOrWhiteSpace(Widget.RowActionsJson))
                                {
                                    <td style="padding:12px; border:1px solid #e0e0e0; text-align:center;" @onclick:stopPropagation="true">
                                        @foreach (var action in _rowActions)
                                        {
                                            <BobCrm.App.Components.Shared.IconActionButton Icon="@GetActionIcon(action)"
                                                                                           Tooltip="@action.Label"
                                                                                           OnClick="() => HandleRowAction(action, row)" />
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="@GetColumnCount()" style="padding:24px; text-align:center; color:#999;">
                                @{
                                    var emptyTextKey = Widget.EmptyTextKey;
                                    var emptyText = string.IsNullOrWhiteSpace(emptyTextKey)
                                        ? I18n.T("DGR_EMPTY_DEFAULT")
                                        : I18n.T(emptyTextKey);
                                    emptyText = string.IsNullOrWhiteSpace(emptyText) ? I18n.T("DGR_EMPTY_DEFAULT") : emptyText;
                                }
                                @emptyText
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (Widget.ShowPagination)
        {
            <div class="datagrid-pagination" style="margin-top:16px; display:flex; justify-content:space-between; align-items:center;">
                <div style="color:#666;">
                    @string.Format(I18n.T("DGR_TOTAL_RECORDS"), _totalCount)
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button disabled="@(_currentPage <= 1)" @onclick="PreviousPage">@I18n.T("DGR_PREVIOUS")</button>
                    <span>@string.Format(I18n.T("DGR_PAGE_LABEL"), _currentPage, _totalPages)</span>
                    <button disabled="@(_currentPage >= _totalPages)" @onclick="NextPage">@I18n.T("DGR_NEXT")</button>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public DataGridWidget Widget { get; set; } = null!;

    [Parameter]
    public string? ContainerStyle { get; set; }

    private const int DefaultPageSize = 20;
    private bool _isLoading = true;
    private string? _error;
    private JsonDocument? _data;
    private List<DataGridColumn> _columns = new();
    private List<JsonElement> _dataRows = new();
    private int _currentPage = 1;
    private int _totalCount = 0;
    private int _totalPages = 1;
    private List<BobCrm.Api.Contracts.DTOs.EnumDefinitionDto> _enumDefinitions = new();
    private List<RowAction> _rowActions = new();
    private string? _entityType;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _enumDefinitions = await EnumService.GetAllAsync();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load enum definitions");
        }

        var jsonOptions = new JsonSerializerOptions
        {
            PropertyNameCaseInsensitive = true
        };

        // ÂÖúÂ∫ïÈ°µÂ§ßÂ∞èÔºåÈÅøÂÖçÊ®°ÊùøÊú™ËÆæÁΩÆÂØºËá¥ÂÖ®ÈáèÂä†ËΩΩ
        if (Widget.PageSize <= 0)
        {
            Widget.PageSize = DefaultPageSize;
        }

        if (!string.IsNullOrWhiteSpace(Widget.ColumnsJson))
        {
            try
            {
                _columns = JsonSerializer.Deserialize<List<DataGridColumn>>(Widget.ColumnsJson, jsonOptions) ?? new();
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to deserialize columns");
                _columns = new();
            }
        }
        EnsureColumns();
        LocalizeColumns();

        if (!string.IsNullOrWhiteSpace(Widget.RowActionsJson))
        {
            try
            {
                _rowActions = JsonSerializer.Deserialize<List<RowAction>>(Widget.RowActionsJson, jsonOptions) ?? new();
                LocalizeRowActions();
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to deserialize row actions");
                _rowActions = new();
            }
        }

        _entityType = Widget.EntityType;
        if (string.IsNullOrWhiteSpace(_entityType) && !string.IsNullOrWhiteSpace(Widget.ApiEndpoint))
        {
            var match = System.Text.RegularExpressions.Regex.Match(Widget.ApiEndpoint, @"\/api\/([^\/\?]+)");
            if (match.Success)
            {
                _entityType = match.Groups[1].Value.TrimEnd('s');
            }
        }

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _isLoading = true;
            _error = null;
            StateHasChanged();

            var client = await Auth.CreateClientWithAuthAsync();

                if (Widget.DataSetId.HasValue)
                {
                    var request = new
                    {
                        Page = _currentPage,
                        PageSize = GetPageSize(),
                        SortField = Widget.DefaultSortField,
                        SortDirection = Widget.DefaultSortDirection
                    };

                    var response = await client.PostAsJsonAsync($"/api/datasets/{Widget.DataSetId.Value}/execute", request);

                if (!response.IsSuccessStatusCode)
                {
                    _error = $"Failed to load data: {response.StatusCode}";
                    return;
                }

                var result = await response.Content.ReadFromJsonAsync<DataSetExecutionResponse>();
                ProcessDataSetResult(result);
            }
            else if (!string.IsNullOrWhiteSpace(Widget.ApiEndpoint))
            {
                var url = Widget.ApiEndpoint;
                
                if (!url.StartsWith("http") && !url.StartsWith("/api/"))
                {
                    if (!string.IsNullOrWhiteSpace(Widget.EntityType))
                    {
                        url = $"/api/{Widget.EntityType}s";
                    }
                    else if (!string.IsNullOrWhiteSpace(_entityType))
                    {
                        url = $"/api/{_entityType}s";
                    }
                }
                
                if (url.Contains("?")) url += "&"; else url += "?";
                url += $"page={_currentPage}&pageSize={GetPageSize()}";
                
                if (!string.IsNullOrWhiteSpace(Widget.DefaultSortField))
                {
                    url += $"&sort={Widget.DefaultSortField}&dir={Widget.DefaultSortDirection}";
                }

                var response = await client.GetAsync(url);
                if (!response.IsSuccessStatusCode)
                {
                    _error = $"Failed to load data: {response.StatusCode}";
                    return;
                }

                try 
                {
                    var result = await response.Content.ReadFromJsonAsync<DataSetExecutionResponse>();
                    if (result != null && result.DataJson != null)
                    {
                        ProcessDataSetResult(result);
                        return;
                    }
                }
                catch {}

                var content = await response.Content.ReadAsStringAsync();
                var doc = JsonDocument.Parse(content);
                ProcessApiResponse(doc);
            }
            else
            {
                _error = "Neither DataSetId nor ApiEndpoint is configured";
            }
        }
        catch (Exception ex)
        {
            _error = $"Exception: {ex.Message}";
            Logger.LogError(ex, "Error loading DataGrid");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void ProcessDataSetResult(DataSetExecutionResponse? result)
    {
        if (result == null)
        {
            _error = "Response is null";
            return;
        }

        _totalCount = result.TotalCount;
        _totalPages = result.TotalPages > 0 ? result.TotalPages : 1;

        if (!string.IsNullOrWhiteSpace(result.DataJson))
        {
            _data = JsonDocument.Parse(result.DataJson);
            if (_data.RootElement.ValueKind == JsonValueKind.Array)
            {
                _dataRows = _data.RootElement.EnumerateArray().ToList();
            }
        }
        
        Logger.LogInformation("Loaded {Count} rows", _dataRows.Count);
    }

    private void ProcessApiResponse(JsonDocument doc)
    {
        if (doc.RootElement.ValueKind == JsonValueKind.Array)
        {
            _data = doc;
            var allRows = _data.RootElement.EnumerateArray().ToList();
            ApplyPagination(allRows, null, null);
            return;
        }

        if (doc.RootElement.ValueKind == JsonValueKind.Object)
        {
            var root = doc.RootElement;
            JsonElement itemsElement;
            if (root.TryGetProperty("items", out itemsElement) || root.TryGetProperty("Items", out itemsElement))
            {
                if (itemsElement.ValueKind == JsonValueKind.Array)
                {
                    var allRows = itemsElement.EnumerateArray().ToList();
                    int? totalCount = TryGetInt(root, "totalCount", "TotalCount", "count", "total");
                    int? totalPages = TryGetInt(root, "totalPages", "TotalPages");
                    ApplyPagination(allRows, totalCount, totalPages);
                    return;
                }
            }

            // Â¶ÇÊûúÊ≤°Êúâ items Â≠óÊÆµÔºåÂ∞ùËØïÂΩì‰ΩúÂçïË°åÂØπË±°ÂàóË°®
            _data = doc;
            var allRowsFallback = new List<JsonElement> { root };
            ApplyPagination(allRowsFallback, 1, 1);
            return;
        }

        _error = "Unexpected API response format";
    }

    private void ApplyPagination(List<JsonElement> allRows, int? totalCount, int? totalPages)
    {
        var pageSize = GetPageSize();
        _totalCount = totalCount ?? allRows.Count;
        _totalPages = totalPages ?? Math.Max(1, (int)Math.Ceiling(_totalCount / (double)pageSize));
        if (_totalPages < 1) _totalPages = 1;
        if (_currentPage > _totalPages) _currentPage = _totalPages;
        var skip = Math.Max(0, (_currentPage - 1) * pageSize);
        _dataRows = allRows.Skip(skip).Take(pageSize).ToList();
    }

    private int? TryGetInt(JsonElement root, params string[] keys)
    {
        foreach (var key in keys)
        {
            if (root.TryGetProperty(key, out var value))
            {
                if (value.ValueKind == JsonValueKind.Number && value.TryGetInt32(out var num))
                {
                    return num;
                }
                if (value.ValueKind == JsonValueKind.String && int.TryParse(value.GetString(), NumberStyles.Any, CultureInfo.InvariantCulture, out var parsed))
                {
                    return parsed;
                }
            }
        }
        return null;
    }

    private string GetCellValue(JsonElement row, string field)
    {
        if (row.TryGetProperty(field, out var value))
        {
            var rawValue = value.ValueKind switch
            {
                JsonValueKind.String => value.GetString() ?? "",
                JsonValueKind.Number => value.GetRawText(),
                JsonValueKind.True => "Yes",
                JsonValueKind.False => "No",
                JsonValueKind.Null => "",
                _ => value.GetRawText()
            };

            var column = _columns.FirstOrDefault(c => c.Field == field);
            if (column != null && column.EnumDefinitionId.HasValue)
            {
                return GetEnumLabel(column.EnumDefinitionId.Value, rawValue, column.IsMultiSelect);
            }

            return rawValue;
        }
        return "";
    }

    private string GetEnumLabel(Guid enumId, string value, bool isMultiSelect)
    {
        var enumDef = _enumDefinitions.FirstOrDefault(e => e.Id == enumId);
        if (enumDef == null) return value;

        if (isMultiSelect)
        {
            try
            {
                var values = JsonSerializer.Deserialize<List<string>>(value);
                if (values != null)
                {
                    var labels = values.Select(v => enumDef.Options.FirstOrDefault(o => o.Value == v)?.DisplayName.GetValueOrDefault(I18n.CurrentLang) ?? v);
                    return string.Join(", ", labels);
                }
            }
            catch
            {
            }
        }

        var option = enumDef.Options.FirstOrDefault(o => o.Value == value);
        return option?.DisplayName.GetValueOrDefault(I18n.CurrentLang) ?? value; 
    }

    private string GetTableStyle()
    {
        var styles = new List<string>();
        if (Widget.ShowBordered)
        {
            styles.Add("border:1px solid #e0e0e0");
        }
        return string.Join("; ", styles);
    }

    private int GetColumnCount()
    {
        int count = _columns.Count;
        if (Widget.AllowMultiSelect) count++;
        if (!string.IsNullOrWhiteSpace(Widget.RowActionsJson)) count++;
        return count;
    }

    private void EnsureColumns()
    {
        if (_columns.Count == 0)
        {
            _columns = GetDefaultColumns();
        }

        foreach (var column in _columns)
        {
            if (string.IsNullOrWhiteSpace(column.Label) && !string.IsNullOrWhiteSpace(column.Field))
            {
                column.Label = column.Field;
            }
            else if (IsTranslationKey(column.Label))
            {
                var translated = I18n.T(column.Label);
                if (!string.IsNullOrWhiteSpace(translated) &&
                    !string.Equals(translated, column.Label, StringComparison.Ordinal))
                {
                    column.Label = translated;
                }
            }
        }
    }

    private void LocalizeColumns()
    {
        foreach (var column in _columns)
        {
            // Â∞ùËØïÁõ¥Êé•Êåâ label ‰Ωú‰∏∫Â§öËØ≠ÈîÆ
            var translated = I18n.T(column.Label);
            if (!string.IsNullOrWhiteSpace(translated) &&
                !string.Equals(translated, column.Label, StringComparison.Ordinal))
            {
                column.Label = translated;
                continue;
            }

            // Â∞ùËØï‰ΩøÁî®Â≠óÊÆµÂêç‰Ωú‰∏∫Â§öËØ≠ÈîÆÔºàÂ¶Ç FIELD_CODEÔºâ
            if (!string.IsNullOrWhiteSpace(column.Field))
            {
                var fieldKey = $"FIELD_{column.Field.ToUpperInvariant()}";
                translated = I18n.T(fieldKey);
                if (!string.IsNullOrWhiteSpace(translated) &&
                    !string.Equals(translated, fieldKey, StringComparison.Ordinal))
                {
                    column.Label = translated;
                }
            }
        }
    }

    private static List<DataGridColumn> GetDefaultColumns() => new()
    {
        new() { Field = "id", Label = "ID", Width = 80, Sortable = true },
        new() { Field = "name", Label = "Name", Width = 200, Sortable = true },
        new() { Field = "code", Label = "Code", Width = 150, Sortable = true }
    };

    private static bool IsTranslationKey(string? label)
    {
        if (string.IsNullOrWhiteSpace(label)) return false;
        return label.All(ch => char.IsLetterOrDigit(ch) || ch == '_' || ch == '-');
    }

    private async Task PreviousPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
            await LoadDataAsync();
        }
    }

    private async Task NextPage()
    {
        if (_currentPage < _totalPages)
        {
            _currentPage++;
            await LoadDataAsync();
        }
    }

    private void LocalizeRowActions()
    {
        foreach (var action in _rowActions)
        {
            var label = action.Label;
            if (string.IsNullOrWhiteSpace(label)) continue;

            var translated = I18n.T(label);
            if (!string.IsNullOrWhiteSpace(translated) &&
                !string.Equals(translated, label, StringComparison.Ordinal))
            {
                action.Label = translated;
                continue;
            }

            var upper = label.ToUpperInvariant();
            foreach (var key in new[] { $"ACTION_{upper}", $"BTN_{upper}", upper })
            {
                translated = I18n.T(key);
                if (!string.IsNullOrWhiteSpace(translated) &&
                    !string.Equals(translated, key, StringComparison.Ordinal))
                {
                    action.Label = translated;
                    break;
                }
            }
        }
    }

    private void HandleRowClick(JsonElement row)
    {
        var id = GetRowId(row);
        if (id == null) return;

        var entityType = _entityType ?? Widget.EntityType ?? "customer";
        Nav.NavigateTo($"/{entityType}/{id}");
    }

    private async Task HandleRowAction(RowAction action, JsonElement row)
    {
        var id = GetRowId(row);
        if (id == null) return;

        var entityType = _entityType ?? Widget.EntityType ?? "customer";

        switch (action.Action?.ToLowerInvariant())
        {
            case "edit":
                Nav.NavigateTo($"/{entityType}/{id}");
                break;
            case "delete":
                await HandleDeleteAsync(id, entityType);
                break;
            default:
                Logger.LogWarning("Unknown row action: {Action}", action.Action);
                break;
        }
    }

    private string GetActionIcon(RowAction action)
    {
        var iconKey = (action.Icon ?? action.Action ?? string.Empty).Trim().ToLowerInvariant();
        switch (iconKey)
        {
            case "edit":
            case "edit-outline":
            case "edit-outlined":
            case "edit-fill":
            case "editfilled":
                return "‚úèÔ∏è";
            case "delete":
            case "remove":
            case "trash":
            case "delete-outline":
            case "delete-outlined":
                return "üóëÔ∏è";
            case "view":
            case "eye":
            case "preview":
            case "open":
                return "üëÅÔ∏è";
            default:
                // Â¶ÇÊûú Icon Â≠óÊÆµÊòØÂ∑≤Ëá™Â∏¶ÁöÑÁ¨¶Âè∑ÔºàÂçïÂ≠óÁ¨¶Êàñ emojiÔºâÔºåÁõ¥Êé•ËøîÂõû
                if (!string.IsNullOrWhiteSpace(action.Icon) && action.Icon.Length <= 3)
                {
                    return action.Icon;
                }
                return "‚Ä¢";
        }
    }

    private string? GetRowId(JsonElement row)
    {
        var idFields = new[] { "id", "Id", "ID", "customerId", "CustomerId" };
        foreach (var field in idFields)
        {
            if (row.TryGetProperty(field, out var idValue))
            {
                return idValue.ValueKind switch
                {
                    JsonValueKind.String => idValue.GetString(),
                    JsonValueKind.Number => idValue.GetRawText(),
                    _ => idValue.GetRawText()
                };
            }
        }
        return null;
    }

    private async Task HandleDeleteAsync(string id, string entityType)
    {
        try
        {
            var client = await Auth.CreateClientWithAuthAsync();
            var response = await client.DeleteAsync($"/api/{entityType}s/{id}");
            
            if (response.IsSuccessStatusCode)
            {
                await LoadDataAsync();
            }
            else
            {
                Logger.LogError("Failed to delete {EntityType} {Id}: {StatusCode}", entityType, id, response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting {EntityType} {Id}", entityType, id);
        }
    }

    private int GetPageSize() => Widget.PageSize > 0 ? Widget.PageSize : DefaultPageSize;

    private class RowAction
    {
        public string Action { get; set; } = string.Empty;
        public string Label { get; set; } = string.Empty;
        public string? Icon { get; set; }
    }

    private class DataGridColumn
    {
        public string Field { get; set; } = string.Empty;
        public string Label { get; set; } = string.Empty;
        public int Width { get; set; } = 120;
        public bool Sortable { get; set; } = false;
        public Guid? EnumDefinitionId { get; set; }
        public bool IsMultiSelect { get; set; }
    }

    private class DataSetExecutionResponse
    {
        public string DataJson { get; set; } = string.Empty;
        public int TotalCount { get; set; }
        public int Page { get; set; }
        public int PageSize { get; set; }
        public int TotalPages { get; set; }
    }
}
