@using BobCrm.App.Models.Widgets
@using BobCrm.App.Services
@using System.Text.Json
@inject AuthService Auth
@inject BobCrm.App.Services.EnumDefinitionService EnumService
@inject BobCrm.App.Services.I18nService I18n
@inject NavigationManager Nav
@inject ILogger<DataGridRuntime> Logger

@* DataGrid Widget 运行时渲染组件 *@

<div class="datagrid-runtime" style="@ContainerStyle">
    @if (!string.IsNullOrWhiteSpace(Widget.Label))
    {
        <div class="datagrid-header" style="font-weight:600; margin-bottom:12px; font-size:16px;">
            @Widget.Label
        </div>
    }

    @if (_isLoading)
    {
        <div style="padding:24px; text-align:center;">
            <span>Loading data...</span>
        </div>
    }
    else if (_error != null)
    {
        <div style="padding:16px; background:#fff2f0; border:1px solid #ffccc7; border-radius:4px; color:#cf1322;">
            <strong>Error:</strong> @_error
        </div>
    }
    else if (_data != null)
    {
        <div class="datagrid-table" style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; @GetTableStyle()">
                @* 表头 *@
                <thead>
                    <tr style="background:#fafafa;">
                        @if (Widget.AllowMultiSelect)
                        {
                            <th style="width:40px; padding:12px; border:1px solid #e0e0e0; text-align:center;">
                                <input type="checkbox" />
                            </th>
                        }
                        @foreach (var column in _columns)
                        {
                            <th style="padding:12px; border:1px solid #e0e0e0; text-align:left; font-weight:600;">
                                @column.Label
                                @if (column.Sortable)
                                {
                                    <span style="margin-left:4px; cursor:pointer;">⇅</span>
                                }
                            </th>
                        }
                        @if (!string.IsNullOrWhiteSpace(Widget.RowActionsJson))
                        {
                            <th style="width:120px; padding:12px; border:1px solid #e0e0e0; text-align:center;">Actions</th>
                        }
                    </tr>
                </thead>

                @* 数据行 *@
                <tbody>
                    @if (_dataRows.Any())
                    {
                        @foreach (var row in _dataRows)
                        {
                            <tr style="background:#fff; cursor:pointer;" @onclick="@(() => HandleRowClick(row))">
                                @if (Widget.AllowMultiSelect)
                                {
                                    <td style="padding:12px; border:1px solid #e0e0e0; text-align:center;" @onclick:stopPropagation="true">
                                        <input type="checkbox" />
                                    </td>
                                }
                                @foreach (var column in _columns)
                                {
                                    <td style="padding:12px; border:1px solid #e0e0e0;">
                                        @GetCellValue(row, column.Field)
                                    </td>
                                }
                                @if (!string.IsNullOrWhiteSpace(Widget.RowActionsJson))
                                {
                                    <td style="padding:12px; border:1px solid #e0e0e0; text-align:center;" @onclick:stopPropagation="true">
                                        @foreach (var action in _rowActions)
                                        {
                                            <button 
                                                style="margin:0 4px; padding:4px 8px; cursor:pointer;"
                                                @onclick="@(() => HandleRowAction(action, row))"
                                                title="@action.Label">
                                                @action.Label
                                            </button>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="@GetColumnCount()" style="padding:24px; text-align:center; color:#999;">
                                @(Widget.EmptyTextKey ?? "No data")
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @* 分页 *@
        @if (Widget.ShowPagination && _totalCount > 0)
        {
            <div class="datagrid-pagination" style="margin-top:16px; display:flex; justify-content:space-between; align-items:center;">
                <div style="color:#666;">
                    Total: @_totalCount records
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button disabled="@(_currentPage <= 1)" @onclick="PreviousPage">Previous</button>
                    <span>Page @_currentPage / @_totalPages</span>
                    <button disabled="@(_currentPage >= _totalPages)" @onclick="NextPage">Next</button>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public DataGridWidget Widget { get; set; } = null!;

    [Parameter]
    public string? ContainerStyle { get; set; }

    private bool _isLoading = true;
    private string? _error;
    private JsonDocument? _data;
    private List<DataGridColumn> _columns = new();
    private List<JsonElement> _dataRows = new();
    private int _currentPage = 1;
    private int _totalCount = 0;
    private int _totalPages = 0;
    private List<BobCrm.Api.Contracts.DTOs.EnumDefinitionDto> _enumDefinitions = new();
    private List<RowAction> _rowActions = new();
    private string? _entityType;

    protected override async Task OnInitializedAsync()
    {
        // 加载枚举定义
        try
        {
            _enumDefinitions = await EnumService.GetAllAsync();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load enum definitions");
        }

        // 解析列定义
        if (!string.IsNullOrWhiteSpace(Widget.ColumnsJson))
        {
            try
            {
                _columns = JsonSerializer.Deserialize<List<DataGridColumn>>(Widget.ColumnsJson) ?? new();
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to deserialize columns");
                _columns = new();
            }
        }
        EnsureColumns();

        // 解析行操作定义
        if (!string.IsNullOrWhiteSpace(Widget.RowActionsJson))
        {
            try
            {
                _rowActions = JsonSerializer.Deserialize<List<RowAction>>(Widget.RowActionsJson) ?? new();
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to deserialize row actions");
                _rowActions = new();
            }
        }

        // 确定实体类型（从EntityType或ApiEndpoint推断）
        _entityType = Widget.EntityType;
        if (string.IsNullOrWhiteSpace(_entityType) && !string.IsNullOrWhiteSpace(Widget.ApiEndpoint))
        {
            // 从ApiEndpoint推断：/api/customers -> customer
            var match = System.Text.RegularExpressions.Regex.Match(Widget.ApiEndpoint, @"\/api\/([^\/\?]+)");
            if (match.Success)
            {
                _entityType = match.Groups[1].Value.TrimEnd('s'); // 简单复数处理
            }
        }

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _isLoading = true;
            _error = null;
            StateHasChanged();

            var client = await Auth.CreateClientWithAuthAsync();

            if (Widget.DataSetId.HasValue)
            {
                // Mode 1: DataSet Execution (POST)
                var request = new
                {
                    Page = _currentPage,
                    PageSize = Widget.PageSize,
                    SortField = Widget.DefaultSortField,
                    SortDirection = Widget.DefaultSortDirection
                };

                var response = await client.PostAsJsonAsync($"/api/datasets/{Widget.DataSetId.Value}/execute", request);

                if (!response.IsSuccessStatusCode)
                {
                    _error = $"Failed to load data: {response.StatusCode}";
                    return;
                }

                var result = await response.Content.ReadFromJsonAsync<DataSetExecutionResponse>();
                ProcessDataSetResult(result);
            }
            else if (!string.IsNullOrWhiteSpace(Widget.ApiEndpoint))
            {
                // Mode 2: Direct Entity API (GET)
                // 确保ApiEndpoint正确映射到实体API
                var url = Widget.ApiEndpoint;
                
                // 如果ApiEndpoint是相对路径，确保以/api/开头
                if (!url.StartsWith("http") && !url.StartsWith("/api/"))
                {
                    // 从EntityType推断API端点
                    if (!string.IsNullOrWhiteSpace(Widget.EntityType))
                    {
                        url = $"/api/{Widget.EntityType}s";
                    }
                    else if (!string.IsNullOrWhiteSpace(_entityType))
                    {
                        url = $"/api/{_entityType}s";
                    }
                }
                
                // Try to append query parameters
                if (url.Contains("?")) url += "&"; else url += "?";
                url += $"page={_currentPage}&pageSize={Widget.PageSize}";
                
                if (!string.IsNullOrWhiteSpace(Widget.DefaultSortField))
                {
                    url += $"&sort={Widget.DefaultSortField}&dir={Widget.DefaultSortDirection}";
                }

                var response = await client.GetAsync(url);
                if (!response.IsSuccessStatusCode)
                {
                    _error = $"Failed to load data: {response.StatusCode}";
                    return;
                }

                // Try to parse as Paged Result first
                try 
                {
                    var result = await response.Content.ReadFromJsonAsync<DataSetExecutionResponse>();
                    if (result != null && result.DataJson != null)
                    {
                        ProcessDataSetResult(result);
                        return;
                    }
                }
                catch {}

                // Fallback: Parse as Array (Client-side paging or full list)
                var content = await response.Content.ReadAsStringAsync();
                var doc = JsonDocument.Parse(content);
                if (doc.RootElement.ValueKind == JsonValueKind.Array)
                {
                    _data = doc;
                    _dataRows = _data.RootElement.EnumerateArray().ToList();
                    _totalCount = _dataRows.Count;
                    _totalPages = 1; // Assume full list for now
                    
                    // TODO: Implement client-side paging if needed
                }
                else
                {
                     _error = "Unexpected API response format";
                }
            }
            else
            {
                _error = "Neither DataSetId nor ApiEndpoint is configured";
            }
        }
        catch (Exception ex)
        {
            _error = $"Exception: {ex.Message}";
            Logger.LogError(ex, "Error loading data for DataGrid");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void ProcessDataSetResult(DataSetExecutionResponse? result)
    {
        if (result == null)
        {
            _error = "Response is null";
            return;
        }

        _totalCount = result.TotalCount;
        _totalPages = result.TotalPages;

        if (!string.IsNullOrWhiteSpace(result.DataJson))
        {
            _data = JsonDocument.Parse(result.DataJson);
            if (_data.RootElement.ValueKind == JsonValueKind.Array)
            {
                _dataRows = _data.RootElement.EnumerateArray().ToList();
            }
        }
        
        Logger.LogInformation("Loaded {Count} rows", _dataRows.Count);
    }

    private string GetCellValue(JsonElement row, string field)
    {
        if (row.TryGetProperty(field, out var value))
        {
            var rawValue = value.ValueKind switch
            {
                JsonValueKind.String => value.GetString() ?? "",
                JsonValueKind.Number => value.GetRawText(),
                JsonValueKind.True => "Yes",
                JsonValueKind.False => "No",
                JsonValueKind.Null => "",
                _ => value.GetRawText()
            };

            // 尝试查找列定义
            var column = _columns.FirstOrDefault(c => c.Field == field);
            if (column != null && column.EnumDefinitionId.HasValue)
            {
                return GetEnumLabel(column.EnumDefinitionId.Value, rawValue, column.IsMultiSelect);
            }

            return rawValue;
        }
        return "";
    }

    private string GetEnumLabel(Guid enumId, string value, bool isMultiSelect)
    {
        var enumDef = _enumDefinitions.FirstOrDefault(e => e.Id == enumId);
        if (enumDef == null) return value;

        if (isMultiSelect)
        {
            // 解析 JSON 数组
            try
            {
                var values = JsonSerializer.Deserialize<List<string>>(value);
                if (values != null)
                {
                    var labels = values.Select(v => enumDef.Options.FirstOrDefault(o => o.Value == v)?.DisplayName.GetValueOrDefault(I18n.CurrentLang) ?? v);
                    return string.Join(", ", labels);
                }
            }
            catch
            {
                // 解析失败，可能是单个值或格式错误
            }
        }

        var option = enumDef.Options.FirstOrDefault(o => o.Value == value);
        return option?.DisplayName.GetValueOrDefault(I18n.CurrentLang) ?? value; 
    }

    private string GetTableStyle()
    {
        var styles = new List<string>();
        if (Widget.ShowBordered)
        {
            styles.Add("border:1px solid #e0e0e0");
        }
        return string.Join("; ", styles);
    }

    private int GetColumnCount()
    {
        int count = _columns.Count;
        if (Widget.AllowMultiSelect) count++;
        if (!string.IsNullOrWhiteSpace(Widget.RowActionsJson)) count++;
        return count;
    }

    private void EnsureColumns()
    {
        if (_columns.Count == 0)
        {
            _columns = GetDefaultColumns();
        }

        foreach (var column in _columns)
        {
            if (string.IsNullOrWhiteSpace(column.Label) && !string.IsNullOrWhiteSpace(column.Field))
            {
                column.Label = column.Field;
            }
            else if (IsTranslationKey(column.Label))
            {
                var translated = I18n.T(column.Label);
                if (!string.IsNullOrWhiteSpace(translated) &&
                    !string.Equals(translated, column.Label, StringComparison.Ordinal))
                {
                    column.Label = translated;
                }
            }
        }
    }

    private static List<DataGridColumn> GetDefaultColumns() => new()
    {
        new() { Field = "id", Label = "ID", Width = 80, Sortable = true },
        new() { Field = "name", Label = "Name", Width = 200, Sortable = true },
        new() { Field = "code", Label = "Code", Width = 150, Sortable = true }
    };

    private static bool IsTranslationKey(string? label)
    {
        if (string.IsNullOrWhiteSpace(label)) return false;
        return label.All(ch => char.IsLetterOrDigit(ch) || ch == '_' || ch == '-');
    }

    private async Task PreviousPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
            await LoadDataAsync();
        }
    }

    private async Task NextPage()
    {
        if (_currentPage < _totalPages)
        {
            _currentPage++;
            await LoadDataAsync();
        }
    }

    private void HandleRowClick(JsonElement row)
    {
        // 获取行的ID（尝试多个可能的字段名）
        var id = GetRowId(row);
        if (id == null) return;

        // 导航到详情页
        var entityType = _entityType ?? Widget.EntityType ?? "customer";
        Nav.NavigateTo($"/{entityType}/{id}");
    }

    private async Task HandleRowAction(RowAction action, JsonElement row)
    {
        var id = GetRowId(row);
        if (id == null) return;

        var entityType = _entityType ?? Widget.EntityType ?? "customer";

        switch (action.Action?.ToLowerInvariant())
        {
            case "edit":
                Nav.NavigateTo($"/{entityType}/{id}");
                break;
            case "delete":
                await HandleDeleteAsync(id, entityType);
                break;
            default:
                Logger.LogWarning("Unknown row action: {Action}", action.Action);
                break;
        }
    }

    private string? GetRowId(JsonElement row)
    {
        // 尝试多个可能的ID字段名
        var idFields = new[] { "id", "Id", "ID", "customerId", "CustomerId" };
        foreach (var field in idFields)
        {
            if (row.TryGetProperty(field, out var idValue))
            {
                return idValue.ValueKind switch
                {
                    JsonValueKind.String => idValue.GetString(),
                    JsonValueKind.Number => idValue.GetRawText(),
                    _ => idValue.GetRawText()
                };
            }
        }
        return null;
    }

    private async Task HandleDeleteAsync(string id, string entityType)
    {
        try
        {
            var client = await Auth.CreateClientWithAuthAsync();
            var response = await client.DeleteAsync($"/api/{entityType}s/{id}");
            
            if (response.IsSuccessStatusCode)
            {
                // 刷新数据
                await LoadDataAsync();
            }
            else
            {
                Logger.LogError("Failed to delete {EntityType} {Id}: {StatusCode}", entityType, id, response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting {EntityType} {Id}", entityType, id);
        }
    }

    // 数据模型
    private class RowAction
    {
        public string Action { get; set; } = string.Empty;
        public string Label { get; set; } = string.Empty;
        public string? Icon { get; set; }
    }

    private class DataGridColumn
    {
        public string Field { get; set; } = string.Empty;
        public string Label { get; set; } = string.Empty;
        public int Width { get; set; } = 120;
        public bool Sortable { get; set; } = false;
        public Guid? EnumDefinitionId { get; set; }
        public bool IsMultiSelect { get; set; }
    }

    private class DataSetExecutionResponse
    {
        public string DataJson { get; set; } = string.Empty;
        public int TotalCount { get; set; }
        public int Page { get; set; }
        public int PageSize { get; set; }
        public int TotalPages { get; set; }
    }
}
