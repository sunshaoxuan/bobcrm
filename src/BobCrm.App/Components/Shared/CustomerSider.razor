@using Microsoft.AspNetCore.Components
@using AntDesign
@using BobCrm.App.Services
@rendermode RenderMode.InteractiveServer
@inject BobCrm.App.Services.AuthService Auth
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject BobCrm.App.Services.I18nService I18n
@inject LayoutState Layout

<div class="customer-sider">
  <div class="sider-search-box">
    <div class="sider-search-field">
        <Icon Type="@IconType.Outline.Search" />
        <input type="text"
               placeholder='@($"{I18n.T("LBL_SEARCH")}{I18n.T("COL_NAME")}/{I18n.T("COL_CODE")}")'
               @bind="keyword" />
    </div>
    <div class="sider-actions">
        <button @onclick="CreateNew" class="btn btn-primary">
            + @I18n.T("BTN_NEW_CUSTOMER")
        </button>
    </div>
  </div>
  @if (!string.IsNullOrWhiteSpace(error))
  {
    <div class="sider-message">@error</div>
  }
  else if (loading)
  {
    <div class="sider-message loading">@I18n.T("LBL_LOADING")...</div>
  }
  <ul class="sider-list">
    @foreach (var c in Filtered())
    {
      var cls = c.id == selectedId ? "sider-item selected" : "sider-item";
      <li class="@cls" @onclick="(() => SelectAndGo(c.id))">
        <div>
          <div class="name">@c.name</div>
          <div class="code">@c.code</div>
        </div>
        <Icon Type="@IconType.Outline.Right" />
      </li>
    }
  </ul>
  @if (!loading && _data.Count == 0 && string.IsNullOrWhiteSpace(error))
  {
    <div class="sider-empty">@I18n.T("LBL_NOT_FOUND")</div>
  }
</div>

@code {
  private List<Item> _data = new();
  private string keyword = string.Empty;
  private string? error;
  private int selectedId;
  private bool loading = true;

  protected override void OnInitialized()
  {
    I18n.OnChanged += HandleI18nChanged;
    Nav.LocationChanged += HandleLocationChanged;
  }
  
  private void HandleI18nChanged() => SafeRender();
  
  private void SafeRender()
  {
    try { _ = InvokeAsync(StateHasChanged); }
    catch (ObjectDisposedException) { }
    catch (InvalidOperationException) { }
  }
  
  private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
  {
    TrySyncSelectedFromUrl();
    SafeRender();
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender) return;
    
    try
    {
      await JS.InvokeVoidAsync("console.log", "[CustomerSider] OnAfterRenderAsync started");
      
      // 认证预检查：确保已登录，否则导航到登录页
      var isAuthenticated = await Auth.EnsureAuthenticatedAsync();
      if (!isAuthenticated)
      {
        await JS.InvokeVoidAsync("console.warn", "[CustomerSider] Not authenticated, redirecting to login");
        Nav.NavigateTo("/login", forceLoad: true);
        return;
      }
      
      // Register for cross-component customer events
      await JS.InvokeVoidAsync("bobcrm.registerCustomerEvents", DotNetObjectReference.Create(this));

      // Load i18n first
      var saved = await JS.InvokeAsync<string?>("bobcrm.getCookie", "lang");
      var langToLoad = !string.IsNullOrWhiteSpace(saved) ? saved! : "ja";
      await I18n.LoadAsync(langToLoad);
      
      await JS.InvokeVoidAsync("console.log", "[CustomerSider] i18n loaded");
      
      // Wait for UI to update
      await InvokeAsync(StateHasChanged);
      
      // Load customers
      await JS.InvokeVoidAsync("console.log", "[CustomerSider] Loading customers...");
      var resp = await Auth.GetWithRefreshAsync("/api/customers");
      await JS.InvokeVoidAsync("console.log", $"[CustomerSider] Response status: {(int)resp.StatusCode}");
      
      if (resp.IsSuccessStatusCode)
      {
        _data = await resp.Content.ReadFromJsonAsync<List<Item>>() ?? new();
        await JS.InvokeVoidAsync("console.log", $"[CustomerSider] Loaded {_data.Count} customers");
        TrySyncSelectedFromUrl();
      }
      else 
      { 
        error = I18n.T("ERR_LOGIN_EXPIRED");
        await JS.InvokeVoidAsync("console.error", $"[CustomerSider] Error: {error}");
      }
      
      loading = false;
      StateHasChanged();
      await JS.InvokeVoidAsync("console.log", "[CustomerSider] StateHasChanged called");
    }
    catch (Exception ex)
    {
      error = $"Error: {ex.Message}";
      loading = false;
      await JS.InvokeVoidAsync("console.error", $"[CustomerSider] Exception: {ex.Message}");
      StateHasChanged();
    }
  }

  

  private IEnumerable<Item> Filtered()
  {
    if (string.IsNullOrWhiteSpace(keyword)) return _data;
    return _data.Where(x => (x.name ?? "").Contains(keyword, StringComparison.OrdinalIgnoreCase) || (x.code ?? "").Contains(keyword, StringComparison.OrdinalIgnoreCase));
  }

  private void SelectAndGo(int id)
  {
    Nav.NavigateTo($"/customer/{id}");
    Layout.SetSiderOverlay(false);
  }

  private void CreateNew()
  {
    Nav.NavigateTo("/customers/new");
  }

  private void TrySyncSelectedFromUrl()
  {
    if (!Uri.TryCreate(Nav.Uri, UriKind.Absolute, out var uri))
    {
      return;
    }

    var seg = uri.AbsolutePath.Split('/', StringSplitOptions.RemoveEmptyEntries);
    if (seg.Length >= 2 && seg[0] == "customer" && int.TryParse(seg[1], out var id))
    {
      selectedId = id;
    }
  }

  public class Item { public int id { get; set; } public string? code { get; set; } public string? name { get; set; } }

  [JSInvokable]
  public Task OnCustomerUpdated(int id, string code, string name)
  {
    var item = _data.FirstOrDefault(x => x.id == id);
    if (item != null)
    {
      item.code = code;
      item.name = name;
      SafeRender();
    }
    return Task.CompletedTask;
  }
}

