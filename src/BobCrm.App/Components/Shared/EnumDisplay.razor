@using BobCrm.Api.Contracts.DTOs
@using BobCrm.Api.Contracts.DTOs.Enum
@using AntDesign
@using System.Net.Http.Json
@inject HttpClient Http
@inject I18nService I18n

@*
    EnumDisplay - read-only enum display component
    Shows enum value read-only in forms or lists
*@

@if (_isLoading)
{
    <Spin Size="@SpinSize.Small" />
}
else if (_error != null)
{
    <span style="color: red;">@_error</span>
}
else if (_displayValue != null)
{
    @if (!string.IsNullOrEmpty(_option?.ColorTag))
    {
        <Tag Color="@_option.ColorTag">
            @if (!string.IsNullOrEmpty(_option.Icon))
            {
                <Icon Type="@_option.Icon" Theme="@IconThemeType.Outline" />
                <span> </span>
            }
            @_displayValue
        </Tag>
    }
    else
    {
        @if (!string.IsNullOrEmpty(_option?.Icon))
        {
            <Icon Type="@_option.Icon" Theme="@IconThemeType.Outline" />
            <span> </span>
        }
        <span>@_displayValue</span>
    }
}
else
{
    <span style="color: #999;">-</span>
}

@code {
    /// <summary>
    /// Enum code (for loading enum definition)
    /// </summary>
    [Parameter, EditorRequired]
    public string EnumCode { get; set; } = string.Empty;

    /// <summary>
    /// Enum option value
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// Current language
    /// </summary>
    [Parameter]
    public string CurrentLanguage { get; set; } = "zh";

    /// <summary>
    /// Render as Tag (with color/icon)
    /// </summary>
    [Parameter]
    public bool AsTag { get; set; } = true;

    private bool _isLoading = true;
    private string? _error;
    private string? _displayValue;
    private EnumOptionDto? _option;

    protected override async Task OnInitializedAsync()
    {
        await LoadDisplayValueAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (string.IsNullOrEmpty(Value))
        {
            _displayValue = null;
            _option = null;
            _isLoading = false;
            return;
        }

        await LoadDisplayValueAsync();
    }

    /// <summary>
    /// Load display value for enum option
    /// </summary>
    private async Task LoadDisplayValueAsync()
    {
        if (string.IsNullOrEmpty(EnumCode) || string.IsNullOrEmpty(Value))
        {
            _isLoading = false;
            return;
        }

        _isLoading = true;
        _error = null;

        try
        {
            var response = await Http.GetAsync($"/api/enums/by-code/{EnumCode}");

            if (response.IsSuccessStatusCode)
            {
                var enumDef = await response.Content.ReadFromJsonAsync<EnumDefinitionDto>();
                if (enumDef != null)
                {
                    _option = enumDef.Options.FirstOrDefault(o => o.Value == Value);
                    if (_option != null)
                    {
                        _displayValue = GetDisplayName(_option.DisplayName, _option.DisplayNameTranslations);
                    }
                    else
                    {
                        _displayValue = Value; // Fallback to raw value
                    }
                }
            }
            else
            {
                _error = $"{I18n.T("MSG_ENUM_LOAD_FAILED")} '{EnumCode}'";
            }
        }
        catch (Exception ex)
        {
            _error = $"{I18n.T("MSG_ERROR")}: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    /// <summary>
    /// Get display name of enum option
    /// </summary>
    private string GetDisplayName(string? single, MultilingualText? translations)
    {
        if (!string.IsNullOrWhiteSpace(single))
        {
            return single!;
        }

        if (translations == null || translations.Count == 0)
        {
            return Value ?? string.Empty;
        }

        if (translations.TryGetValue(CurrentLanguage, out var name) && !string.IsNullOrWhiteSpace(name))
        {
            return name!;
        }

        foreach (var lang in new[] { "zh", "en", "ja" })
        {
            if (translations.TryGetValue(lang, out var fallback) && !string.IsNullOrWhiteSpace(fallback))
            {
                return fallback!;
            }
        }

        return translations.Values.FirstOrDefault(v => !string.IsNullOrWhiteSpace(v)) ?? Value ?? string.Empty;
    }
}
