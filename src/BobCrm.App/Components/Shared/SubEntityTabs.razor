@using BobCrm.App.Models
@using BobCrm.App.Services.Multilingual
@inject IMultilingualTextResolver MultilingualTextResolver
@inject BobCrm.App.Services.I18nService I18n

<div class="sub-entity-tabs-container">
    <div class="sub-entity-toolbar">
        <Space>
            <SpaceItem>
                <Text Strong>@I18n.T("LBL_SUB_ENTITY_MANAGEMENT")</Text>
            </SpaceItem>
            <SpaceItem>
                <Button Type="@ButtonType.Primary"
                        Icon="@IconType.Outline.Plus"
                        Size="@ButtonSize.Small"
                        OnClick="@ShowAddSubEntityModal">
                    @I18n.T("LBL_ADD_SUB_ENTITY")
                </Button>
            </SpaceItem>
        </Space>
    </div>

    @if (SubEntities != null && SubEntities.Any())
    {
        <Tabs @bind-ActiveKey="@_activeKey"
              Type="@TabType.Card"
              OnEdit="@((key, action) => OnTabEdit(key, action))">

            @foreach (var subEntity in SubEntities)
            {
                <TabPane Key="@subEntity.TempId.ToString()"
                         Closable="true">
                    <TabTemplate>
                        <span class="@GetTabClass(subEntity)">
                            @GetDisplayName(subEntity.DisplayName)
                            @if (subEntity.HasValidationErrors)
                            {
                                <Badge Count="@subEntity.ValidationErrorCount"
                                       Style="margin-left: 8px;"
                                       Title="@string.Join("; ", subEntity.ValidationErrors)" />
                            }
                        </span>
                    </TabTemplate>
                    <ChildContent>
                        <div class="sub-entity-panel">
                            <div class="sub-entity-header">
                                <Descriptions Title="@I18n.T("LBL_SUB_ENTITY_INFO")" Size="@DescriptionsSize.Small" Bordered Column="2">
                                    <DescriptionsItem Title="@I18n.T("LBL_SUB_ENTITY_CODE")">@subEntity.Code</DescriptionsItem>
                                    <DescriptionsItem Title="@I18n.T("LBL_DISPLAY_NAME")">@GetDisplayName(subEntity.DisplayName)</DescriptionsItem>
                                    <DescriptionsItem Title="@I18n.T("LBL_SORT_ORDER")" Span="2">@subEntity.SortOrder</DescriptionsItem>
                                </Descriptions>
                            </div>

                            <Divider />

                            <FieldGrid Fields="@subEntity.Fields"
                                      OnFieldChanged="@(field => OnFieldChanged.InvokeAsync((subEntity.TempId, field)))"
                                      OnFieldAdded="@(field => OnFieldAdded.InvokeAsync((subEntity.TempId, field)))"
                                      OnFieldRemoved="@(fieldId => OnFieldRemoved.InvokeAsync((subEntity.TempId, fieldId)))" />
                        </div>
                    </ChildContent>
                </TabPane>
            }
        </Tabs>
    }
    else
    {
        <Empty Description="@I18n.T("LBL_NO_SUB_ENTITIES")">
            <ChildContent>
                <Icon Type="@IconType.Outline.Inbox" Style="font-size: 48px; color: #d9d9d9;" />
            </ChildContent>
        </Empty>
    }
</div>

<Modal Title="@I18n.T("LBL_ADD_SUB_ENTITY")"
       @bind-Visible="@_addModalVisible"
       OnOk="@(() => OnAddSubEntityConfirm())"
       OnCancel="@(() => OnAddSubEntityCancel())"
       Width="600">
    <Form Model="@_newSubEntity" @ref="_addForm" LabelCol="new ColLayoutParam { Span = 6 }" WrapperCol="new ColLayoutParam { Span = 18 }">
        <FormItem Label="@I18n.T("LBL_SUB_ENTITY_CODE")" Required>
            <Input @bind-Value="@_newSubEntity.Code"
                   Placeholder="@I18n.T("例如: Lines, Items")"
                   MaxLength="100" />
            <p style="font-size: 12px; color: #8c8c8c; margin-top: 4px;">
                @I18n.T("LBL_SUB_ENTITY_CODE_HINT")
            </p>
        </FormItem>

        <FormItem Label="@I18n.T("LBL_DISPLAY_NAME")" Required>
            <MultilingualInput @bind-Value="@_newSubEntity.DisplayName" />
        </FormItem>

        <FormItem Label="@I18n.T("LBL_DESCRIPTION")">
            <MultilingualInput @bind-Value="@_newSubEntity.Description" />
        </FormItem>

        <FormItem Label="@I18n.T("LBL_SORT_ORDER")">
            <AntDesign.InputNumber @bind-Value="@_newSubEntity.SortOrder" Min="0" Style="width: 100%;" />
        </FormItem>

        <FormItem Label="@I18n.T("LBL_FOREIGN_KEY_FIELD")">
            <Input @bind-Value="@_newSubEntity.ForeignKeyField"
                   Placeholder="@I18n.T("LBL_FOREIGN_KEY_HINT")" />
        </FormItem>

        <FormItem Label="@I18n.T("LBL_COLLECTION_PROPERTY")">
            <Input @bind-Value="@_newSubEntity.CollectionPropertyName"
                   Placeholder="@I18n.T("LBL_COLLECTION_PROPERTY_HINT")" />
        </FormItem>
    </Form>
</Modal>

@code {
    [Parameter] public List<SubEntityViewModel> SubEntities { get; set; } = new();
    [Parameter] public EventCallback<SubEntityViewModel> OnSubEntityAdded { get; set; }
    [Parameter] public EventCallback<Guid> OnSubEntityRemoved { get; set; }
    [Parameter] public EventCallback<(Guid SubEntityId, FieldViewModel Field)> OnFieldChanged { get; set; }
    [Parameter] public EventCallback<(Guid SubEntityId, FieldViewModel Field)> OnFieldAdded { get; set; }
    [Parameter] public EventCallback<(Guid SubEntityId, Guid FieldId)> OnFieldRemoved { get; set; }
    [Inject] private IMessageService MessageService { get; set; } = default!;

    private string _activeKey = string.Empty;
    private bool _addModalVisible = false;
    private SubEntityViewModel _newSubEntity = new();
    private Form<SubEntityViewModel>? _addForm;

    protected override void OnParametersSet()
    {
        if (SubEntities != null && SubEntities.Any() && string.IsNullOrEmpty(_activeKey))
        {
            _activeKey = SubEntities.First().TempId.ToString();
        }
    }

    private string GetTabClass(SubEntityViewModel subEntity)
    {
        return subEntity.HasValidationErrors ? "tab-with-errors" : "";
    }

    private string GetDisplayName(MultilingualTextDto? displayName)
    {
        return MultilingualTextResolver.Resolve(displayName, "未命名");
    }

    private void ShowAddSubEntityModal()
    {
        _newSubEntity = new SubEntityViewModel
        {
            TempId = Guid.NewGuid(),
            SortOrder = SubEntities?.Count ?? 0
        };
        _addModalVisible = true;
    }

    private async Task OnAddSubEntityConfirm()
    {
        // 验证子实体编码
        if (string.IsNullOrWhiteSpace(_newSubEntity.Code))
        {
            await MessageService.Error(I18n.T("MSG_SUB_ENTITY_CODE_REQUIRED"));
            return;
        }

        if (!char.IsUpper(_newSubEntity.Code[0]) || !_newSubEntity.Code.All(c => char.IsLetterOrDigit(c)))
        {
            await MessageService.Error(I18n.T("MSG_SUB_ENTITY_CODE_FORMAT"));
            return;
        }

        // 检查编码唯一性
        if (SubEntities != null && SubEntities.Any(s => s.Code.Equals(_newSubEntity.Code, StringComparison.OrdinalIgnoreCase)))
        {
            await MessageService.Error(I18n.T("MSG_SUB_ENTITY_CODE_EXISTS"));
            return;
        }

        // 验证显示名称
        if (_newSubEntity.DisplayName == null || !_newSubEntity.DisplayName.Any())
        {
            await MessageService.Error(I18n.T("MSG_SUB_ENTITY_DISPLAY_NAME_REQUIRED"));
            return;
        }

        // 初始化字段列表
        if (_newSubEntity.Fields == null)
        {
            _newSubEntity.Fields = new List<FieldViewModel>();
        }

        // 通知父组件添加子实体
        await OnSubEntityAdded.InvokeAsync(_newSubEntity);

        _addModalVisible = false;
    }

    private void OnAddSubEntityCancel()
    {
        _addModalVisible = false;
    }

    private async Task<bool> OnTabEdit(string key, string action)
    {
        if (action == "remove")
        {
            var subEntityId = Guid.Parse(key);
            var subEntity = SubEntities?.FirstOrDefault(s => s.TempId == subEntityId);

            if (subEntity != null && SubEntities != null)
            {
                // 通知父组件删除子实体（父组件会更新列表）
                await OnSubEntityRemoved.InvokeAsync(subEntityId);

                // 更新活动Tab
                if (_activeKey == key && SubEntities.Any())
                {
                    _activeKey = SubEntities.First().TempId.ToString();
                }

                StateHasChanged();
                return true;
            }
        }

        return false;
    }
}
