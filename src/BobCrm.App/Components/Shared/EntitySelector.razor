@typeparam TEntity where TEntity : BobCrm.App.Abstractions.ISelectableEntity
@using AntDesign
@inject IJSRuntime JS
@inject BobCrm.App.Services.I18nService I18n

<div class="@($"entity-selector-trigger {(Disabled ? "is-disabled" : string.Empty)}")">
    <Input Value="@DisplayText"
           Placeholder="@Placeholder"
           ReadOnly
           Class="entity-selector-input field-control"
           Disabled="@Disabled"
           @onclick="OpenSelector" />
    <Icon Type="@IconType.Outline.Search"
          Class="entity-selector-trigger-icon"
          @onclick="OpenSelector" />
</div>

<Modal Title="@Title"
       WrapClassName="calm-modal"
       Visible="@modalVisible"
       OnOk="@(() => modalVisible = false)"
       OnCancel="@(() => modalVisible = false)"
       Footer="null"
       Width="700">
    @if (loading)
    {
        <div class="entity-selector-feedback">
            <Spin Size="@SpinSize.Large" />
            <div>@I18n.T("LBL_LOADING")</div>
        </div>
    }
    else if (string.IsNullOrWhiteSpace(errorMessage) == false)
    {
        <Result Status="@ResultStatus.Error"
                Title="@I18n.T("LBL_LOAD_FAILED")" 
                SubTitle="@errorMessage">
            <Extra>
                <Button Type="@ButtonType.Primary" OnClick="ReloadData">@I18n.T("LBL_RETRY")</Button>
            </Extra>
        </Result>
    }
    else if (!dataSource.Any())
    {
        <Empty Description="@EmptyText" />
    }
    else
    {
        @if (EnableSearch)
        {
            <div class="entity-selector-search">
                <Input @bind-Value="searchKeyword"
                       Placeholder="@I18n.T("LBL_SEARCH_PLACEHOLDER")"
                       AllowClear
                       @bind-Value:after="OnSearchChanged" />
            </div>
        }
        
        <div class="entity-selector-list">
            @foreach (var item in filteredData)
            {
                <div @onclick="@(() => SelectItem(item))" 
                     class="entity-selector-item">
                    @if (IconRenderer != null)
                    {
                        <div class="entity-selector-avatar">
                            @IconRenderer(item)
                        </div>
                    }
                    <div class="entity-selector-content">
                        @if (TitleRenderer != null)
                        {
                            <div class="entity-selector-title">
                                @TitleRenderer(item)
                            </div>
                        }
                        @if (DescriptionRenderer != null)
                        {
                            <div class="entity-selector-description">
                                @DescriptionRenderer(item)
                            </div>
                        }
                        @if (MetadataRenderer != null)
                        {
                            <div class="entity-selector-meta">
                                @MetadataRenderer(item)
                            </div>
                        }
                    </div>
                    <Icon Type="@IconType.Outline.Right" Class="entity-selector-chevron" />
                </div>
            }
        </div>
        
        @if (filteredData.Count < dataSource.Count)
        {
            <div class="entity-selector-empty-tip">
                @I18n.T("LBL_SHOWING") @filteredData.Count / @totalCount @I18n.T("LBL_ITEMS")
            </div>
        }

        @if (usePagedLoader && totalPages > 1)
        {
            <div style="margin-top:12px; display:flex; justify-content:center;">
                <Pagination Current="@currentPage"
                            Total="@totalCount"
                            PageSize="@PageSize"
                            OnChange="OnPageChanged"
                            ShowSizeChanger="false" />
            </div>
        }
    }
</Modal>

@code {
    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> ValueChanged { get; set; }
    
    [Parameter] public string Title { get; set; } = string.Empty;
    [Parameter] public string Placeholder { get; set; } = string.Empty;
    [Parameter] public string EmptyText { get; set; } = string.Empty;
    [Parameter] public bool Disabled { get; set; } = false;
    [Parameter] public bool EnableSearch { get; set; } = true;
    [Parameter] public int PageSize { get; set; } = 20;
    
    [Parameter] public Func<Task<List<TEntity>>>? DataLoader { get; set; }
    [Parameter] public Func<string?, int, int, Task<(List<TEntity> Items, int Total)>>? PagedDataLoader { get; set; }
    [Parameter] public Func<string, Task<TEntity?>>? ItemLoader { get; set; }
    [Parameter] public Func<TEntity, string>? ValueGetter { get; set; }
    [Parameter] public Func<TEntity, string>? DisplayTextGetter { get; set; }  // 获取显示文本
    [Parameter] public RenderFragment<TEntity>? TitleRenderer { get; set; }
    [Parameter] public RenderFragment<TEntity>? DescriptionRenderer { get; set; }
    [Parameter] public RenderFragment<TEntity>? IconRenderer { get; set; }
    [Parameter] public RenderFragment<TEntity>? MetadataRenderer { get; set; }
    
    private bool modalVisible = false;
    private bool loading = false;
    private bool dataLoaded = false;
    private string? errorMessage = null;
    private string searchKeyword = "";
    private int currentPage = 1;
    private int totalCount = 0;
    private int totalPages = 1;
    private string? selectedDisplayText;
    
    private List<TEntity> dataSource = new();
    private List<TEntity> filteredData = new();
    
    private bool usePagedLoader => PagedDataLoader != null;
    private string DisplayText => string.IsNullOrWhiteSpace(Value)
        ? ""
        : (!string.IsNullOrWhiteSpace(selectedDisplayText) ? selectedDisplayText! : GetDisplayTextForValue(Value));
    
    protected override void OnInitialized()
    {
        Title = string.IsNullOrWhiteSpace(Title) ? I18n.T("LBL_SELECT_ENTITY") : Title;
        Placeholder = string.IsNullOrWhiteSpace(Placeholder) ? I18n.T("PH_SELECT_ENTITY") : Placeholder;
        EmptyText = string.IsNullOrWhiteSpace(EmptyText) ? I18n.T("LBL_NO_DATA") : EmptyText;
    }

    protected override async Task OnParametersSetAsync()
    {
        // 如果有初始值但数据未加载，预加载数据以显示 DisplayName
        if (!string.IsNullOrWhiteSpace(Value) && !dataLoaded && (DataLoader != null || PagedDataLoader != null))
        {
            await LoadData();
        }

        if (!string.IsNullOrWhiteSpace(Value) && ItemLoader != null && string.IsNullOrWhiteSpace(selectedDisplayText))
        {
            try
            {
                var item = await ItemLoader(Value);
                if (item != null)
                {
                    selectedDisplayText = DisplayTextGetter?.Invoke(item) ?? item.DisplayName;
                }
            }
            catch
            {
            }
        }
    }
    
    private async Task OpenSelector()
    {
        if (Disabled) return;
        
        modalVisible = true;
        StateHasChanged();
        
        if (!dataLoaded && (DataLoader != null || PagedDataLoader != null))
        {
            await LoadData();
        }
    }
    
    private async Task LoadData()
    {
        try
        {
            loading = true;
            errorMessage = null;
            StateHasChanged();

            if (usePagedLoader && PagedDataLoader != null)
            {
                await LoadPageAsync(1);
            }
            else if (DataLoader != null)
            {
                dataSource = await DataLoader() ?? new();
                totalCount = dataSource.Count;
                totalPages = 1;
                currentPage = 1;
                filteredData = dataSource;
                dataLoaded = true;
                await JS.InvokeVoidAsync("console.log", $"[EntitySelector] Loaded {dataSource.Count} items");
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            await JS.InvokeVoidAsync("console.error", $"[EntitySelector] Load failed: {ex.Message}");
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadPageAsync(int page)
    {
        if (PagedDataLoader == null)
        {
            return;
        }

        currentPage = Math.Max(1, page);
        var (items, total) = await PagedDataLoader(searchKeyword, currentPage, Math.Max(1, PageSize));
        dataSource = items ?? new();
        filteredData = dataSource;
        totalCount = Math.Max(0, total);
        totalPages = Math.Max(1, (int)Math.Ceiling(totalCount / (double)Math.Max(1, PageSize)));
        dataLoaded = true;
    }
    
    private async Task ReloadData()
    {
        dataLoaded = false;
        await LoadData();
    }
    
    private async Task OnSearchChanged()
    {
        if (usePagedLoader)
        {
            try
            {
                loading = true;
                await LoadPageAsync(1);
            }
            catch
            {
            }
            finally
            {
                loading = false;
                StateHasChanged();
            }
            return;
        }

        FilterDataClientSide();
    }

    private void FilterDataClientSide()
    {
        if (string.IsNullOrWhiteSpace(searchKeyword))
        {
            filteredData = dataSource;
        }
        else
        {
            var keyword = searchKeyword.ToLowerInvariant();
            filteredData = dataSource.Where(item =>
            {
                var text = (DisplayTextGetter?.Invoke(item) ?? item.DisplayName ?? ValueGetter?.Invoke(item) ?? item.Value) ?? "";
                return text.ToLowerInvariant().Contains(keyword);
            }).ToList();
        }
        StateHasChanged();
    }

    private async Task OnPageChanged(PaginationEventArgs args)
    {
        if (!usePagedLoader)
        {
            return;
        }

        try
        {
            loading = true;
            await LoadPageAsync(args.Page);
        }
        catch
        {
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }
    
    private async Task SelectItem(TEntity item)
    {
        if (ValueGetter != null)
        {
            var value = ValueGetter(item);
            Value = value;
            await ValueChanged.InvokeAsync(value);
        }
        selectedDisplayText = DisplayTextGetter?.Invoke(item) ?? item.DisplayName;
        
        modalVisible = false;
        StateHasChanged();
    }
    
    private string GetDisplayTextForValue(string? value)
    {
        if (string.IsNullOrWhiteSpace(value)) return "";
        
        // 从数据源中查找对应的项
        var item = dataSource.FirstOrDefault(i => ValueGetter?.Invoke(i) == value);
        
        if (item != null && DisplayTextGetter != null)
        {
            return DisplayTextGetter(item);
        }

        if (item != null)
        {
            return item.DisplayName;
        }
        
        // 如果找不到或没有 DisplayTextGetter，返回 value 本身
        return value ?? "";
    }
}


