@using BobCrm.App.Models
@using BobCrm.App.Models.Widgets
@using BobCrm.App.Services
@using BobCrm.App.Services.Widgets
@using BobCrm.App.Services.Widgets.Rendering
@using System.Text.Json
@inject AuthService Auth
@inject BobCrm.App.Services.I18nService I18n
@inject IRuntimeWidgetRenderer Renderer
@inject ILogger<ListTemplateHost> Logger

@* 列表模板运行宿主 - 渲染 UsageType=List 的模板 *@

<div class="list-template-host @(string.IsNullOrWhiteSpace(CssClass) ? string.Empty : CssClass)">
    @if (_isLoading)
    {
        <div class="runtime-state loading">
            <strong>@I18n.T("LBL_LOADING")</strong>
            <span>@I18n.T("LBL_LOADING")...</span>
        </div>
    }
    else if (_error != null)
    {
        <div class="runtime-state error">
            <div>@_error</div>
            <Button Type="@ButtonType.Primary" Size="ButtonSize.Small" OnClick="RefreshAsync">@I18n.T("BTN_RETRY")</Button>
        </div>
    }
    else if (_templateResponse != null)
    {
        <div class="list-template-header">
            <div class="list-template-meta">
                <div class="list-template-usage">@(_templateResponse.Template?.UsageType.ToString() ?? string.Empty)</div>
                <h2 class="list-template-name">@TemplateDisplayName</h2>
                <div class="runtime-template-meta">@EntityType.ToUpperInvariant() ・ @(_templateResponse.Template?.Id.ToString() ?? "-")</div>
            </div>
            <Button Type="@ButtonType.Default" Size="ButtonSize.Small" OnClick="RefreshAsync">
                @I18n.T("BTN_RETRY")
            </Button>
        </div>

        <div class="runtime-stack">
            @if (_widgets.Any())
            {
                @foreach (var widget in _widgets)
                {
                    <div class="runtime-widget-shell">
                        @RenderWidget(widget)
                    </div>
                }
            }
            else
            {
                <div class="runtime-empty">
                    <strong>@I18n.T("MSG_TEMPLATE_EMPTY")</strong>
                    <div>@I18n.T("MSG_TEMPLATE_EMPTY_HINT")</div>
                    <div style="margin-top:var(--space-3, 12px);">
                        <Button OnClick="RefreshAsync" Type="@ButtonType.Primary" Ghost="true">@I18n.T("BTN_RETRY")</Button>
                    </div>
                </div>
            }
        </div>

        @* 调试信息 *@
        @if (ShowDebugInfo)
        {
                 <div class="runtime-state" style="font-family:monospace; font-size:12px;">
                <div><strong>Template:</strong> @(_templateResponse.Template?.Name ?? "(null)") (ID: @(_templateResponse.Template?.Id.ToString() ?? "-"))</div>
                <div><strong>Entity Type:</strong> @EntityType</div>
                <div><strong>Applied Scopes:</strong> @string.Join(", ", _templateResponse.AppliedScopes)</div>
                <div><strong>Full Access:</strong> @_templateResponse.HasFullAccess</div>
                <div><strong>Widget Count:</strong> @_widgets.Count</div>
            </div>
        }
    }
</div>

@code {
    /// <summary>
    /// 实体类型
    /// </summary>
    [Parameter]
    public string EntityType { get; set; } = string.Empty;

    /// <summary>
    /// 是否显示调试信息
    /// </summary>
    [Parameter]
    public bool ShowDebugInfo { get; set; } = false;

    /// <summary>
    /// 自定义 CSS 类
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    private bool _isLoading = true;
    private string? _error;
    private TemplateRuntimeResponse? _templateResponse;
    private List<DraggableWidget> _widgets = new();
    private readonly FormRuntimeContext formContext = new() { RenderMode = FormRuntimeContext.Mode.Browse };

    private string TemplateDisplayName
    {
        get
        {
            var name = _templateResponse?.Template?.Name ?? EntityType;
            if (string.IsNullOrWhiteSpace(name))
            {
                return EntityType;
            }

            // 模板名为默认 key 时直接使用实体菜单翻译兜底
            if (name.StartsWith("TEMPLATE_NAME_", StringComparison.OrdinalIgnoreCase))
            {
                var entityLabel = TranslateMenuForEntity();
                if (!string.IsNullOrWhiteSpace(entityLabel))
                {
                    return entityLabel;
                }
            }

            // 优先按模板名翻译
            var translated = I18n.T(name);
            if (!string.IsNullOrWhiteSpace(translated) && !string.Equals(translated, name, StringComparison.Ordinal))
            {
                return translated;
            }

            // 模板名为多语 Key 但未配置翻译时，尝试用实体菜单多语兜底（兼容单复数）
            var menuLabel = TranslateMenuForEntity();
            if (!string.IsNullOrWhiteSpace(menuLabel)) return menuLabel;

            return name;
        }
    }

    private string? TranslateMenuForEntity()
    {
        var upperEntity = EntityType.ToUpperInvariant();
        foreach (var key in new[] { $"MENU_{upperEntity}S", $"MENU_{upperEntity}" })
        {
            var translated = I18n.T(key);
            if (!string.IsNullOrWhiteSpace(translated) && !string.Equals(translated, key, StringComparison.Ordinal))
            {
                return translated;
            }
        }
        return null;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplateAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!_isLoading)
        {
            await LoadTemplateAsync();
        }
    }

    private async Task LoadTemplateAsync()
    {
        try
        {
            _isLoading = true;
            _error = null;
            _widgets.Clear();
            StateHasChanged();

            // 调用后端 API 获取运行时模板上下文
            var request = new TemplateRuntimeRequest
            {
                UsageType = TemplateUsageType.List
            };

            var client = await Auth.CreateClientWithAuthAsync();
            var response = await client.PostAsJsonAsync($"/api/templates/runtime/{EntityType}", request);

            if (!response.IsSuccessStatusCode)
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                _error = string.Format(I18n.T("TPL_LOAD_FAILED"), response.StatusCode);
                Logger.LogError("Failed to load template for {EntityType}: {Status} - {Error}", EntityType, response.StatusCode, errorContent);
                return;
            }

            _templateResponse = await ApiResponseHelper.ReadDataAsync<TemplateRuntimeResponse>(response);

            if (_templateResponse == null)
            {
                _error = string.Format(I18n.T("TPL_LOAD_FAILED"), "empty response");
                return;
            }

            // 解析模板中的 widgets
            if (!string.IsNullOrWhiteSpace(_templateResponse.Template?.LayoutJson))
            {
                try
                {
                    _widgets = JsonSerializer.Deserialize<List<DraggableWidget>>(_templateResponse.Template.LayoutJson,
                        new JsonSerializerOptions
                        {
                            PropertyNameCaseInsensitive = true,
                            Converters = { new WidgetJsonConverter() }
                        }) ?? new List<DraggableWidget>();
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "Failed to deserialize widgets from template {TemplateId}", _templateResponse.Template.Id);
                    _widgets = new List<DraggableWidget>();
                }
            }
        }
        catch (Exception ex)
        {
            _error = string.Format(I18n.T("TPL_LOAD_FAILED"), ex.Message);
            Logger.LogError(ex, "Error loading template for {EntityType}", EntityType);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private RenderFragment RenderWidget(DraggableWidget widget)
    {
        return builder =>
        {
            // 使用 RuntimeWidgetRenderer 渲染 widget
            var renderRequest = new RuntimeWidgetRenderRequest
            {
                Widget = widget,
                Mode = RuntimeWidgetRenderMode.Browse, // List 模板默认浏览模式
                FormContext = formContext,
                EventTarget = this,
                Label = widget.Label ?? widget.Type,
                ValueGetter = null, // List 模板中不需要对字段值取值
                ValueSetter = null,
                GetWidgetTextStyle = null,
                GetWidgetBackground = null,
                Items = null
            };

            var fragment = Renderer.Render(renderRequest);
            fragment(builder);
        };
    }

    /// <summary>
    /// 刷新模板数据
    /// </summary>
    public async Task RefreshAsync()
    {
        await LoadTemplateAsync();
    }
}
