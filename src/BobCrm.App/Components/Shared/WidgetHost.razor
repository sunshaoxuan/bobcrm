@using BobCrm.App.Models.Widgets
@inject IJSRuntime JS

@* 换行占位符：NewLine=true 时强制控件从新行开始 *@
@if (Widget.NewLine)
{
    <div class="flow-break" style="flex-basis:100%; width:100%; height:0; padding:0; margin:0;"></div>
}

@* 统一的 Widget 宿主组件：负责渲染、选中、resize、防原生拖拽干扰 *@
<div class="layout-widget @(Selected ? "selected" : "")"
     draggable="@(isResizing ? "false" : "true")"
     data-drag-type="widget"
     data-drag-data="@Widget.Id"
     data-widget-id="@Widget.Id"
     @ondragstart="OnDragStart"
     @ondragstart:preventDefault="@isResizing"
     @ondragend="OnDragEnd"
     @onclick="HandleClick"
     @onclick:stopPropagation
     style="@GetWidgetStyle()">

    @* Resize 句柄（仅选中时显示） *@
    @if (Selected && AllowResize)
    {
        <div class="resize-handle"
             draggable="false"
             @onmousedown="HandleResizeStart"
             @onmousedown:stopPropagation
             @onmousedown:preventDefault
             @ondragstart:preventDefault="true"
             style="position:absolute; right:-2px; top:50%; transform:translateY(-50%); width:4px; height:48px; cursor:ew-resize; background:#1890ff; border-radius:2px; z-index:10; box-shadow:0 2px 8px rgba(24,144,255,0.6); opacity:0.8;">
        </div>
    }

    @* Widget 内容（禁用指针事件，确保点击落到 wrapper） *@
    <div class="widget-content" style="width:100%; pointer-events:none;">
        @ChildContent
    </div>
</div>

@code {
    /// <summary>
    /// Widget 数据模型
    /// </summary>
    [Parameter, EditorRequired]
    public DraggableWidget Widget { get; set; } = default!;

    /// <summary>
    /// 是否选中
    /// </summary>
    [Parameter]
    public bool Selected { get; set; }

    /// <summary>
    /// 是否正在调整大小（由父组件控制）
    /// </summary>
    [Parameter]
    public bool IsResizing { get; set; }

    /// <summary>
    /// 选中回调
    /// </summary>
    [Parameter]
    public EventCallback<DraggableWidget> OnSelect { get; set; }

    /// <summary>
    /// 拖拽开始回调
    /// </summary>
    [Parameter]
    public EventCallback<(Microsoft.AspNetCore.Components.Web.DragEventArgs e, DraggableWidget widget)> OnWidgetDragStart { get; set; }

    /// <summary>
    /// 拖拽结束回调
    /// </summary>
    [Parameter]
    public EventCallback<Microsoft.AspNetCore.Components.Web.DragEventArgs> OnWidgetDragEnd { get; set; }

    /// <summary>
    /// Resize 开始回调
    /// </summary>
    [Parameter]
    public EventCallback<(Microsoft.AspNetCore.Components.Web.MouseEventArgs e, DraggableWidget widget)> OnResizeStart { get; set; }

    /// <summary>
    /// 是否允许 resize（默认 true）
    /// </summary>
    [Parameter]
    public bool AllowResize { get; set; } = true;

    /// <summary>
    /// 自定义内容渲染
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// 额外的 CSS 类名
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    // 使用父组件传入的 isResizing 而不是自己管理
    private bool isResizing => IsResizing;

    /// <summary>
    /// 处理点击选中
    /// </summary>
    private async Task HandleClick()
    {
        if (OnSelect.HasDelegate)
        {
            await OnSelect.InvokeAsync(Widget);
        }
    }

    /// <summary>
    /// 处理拖拽开始
    /// </summary>
    private async Task OnDragStart(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        if (OnWidgetDragStart.HasDelegate)
        {
            await OnWidgetDragStart.InvokeAsync((e, Widget));
        }
    }

    /// <summary>
    /// 处理拖拽结束
    /// </summary>
    private async Task OnDragEnd(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        if (OnWidgetDragEnd.HasDelegate)
        {
            await OnWidgetDragEnd.InvokeAsync(e);
        }
    }

    /// <summary>
    /// 处理 resize 开始
    /// </summary>
    private async Task HandleResizeStart(Microsoft.AspNetCore.Components.Web.MouseEventArgs e)
    {
        if (OnResizeStart.HasDelegate)
        {
            await OnResizeStart.InvokeAsync((e, Widget));
        }
    }

    /// <summary>
    /// 计算 Widget 样式（基于 LayoutOptions + 选中态）
    /// </summary>
    private string GetWidgetStyle()
    {
        var parts = new List<string>();

        // 基础布局样式
        var widthValue = Widget.Width;
        var flexBasis = Widget.WidthUnit == "%"
            ? $"calc({widthValue}% - 8px)"
            : $"{widthValue}px";
        parts.Add($"flex:0 0 {flexBasis}");

        // 高度
        var minHeight = Widget.HeightUnit == "auto" ? "64px" : $"{Widget.Height}px";
        parts.Add($"min-height:{minHeight}");

        // 背景和圆角
        parts.Add("background:#fff");
        parts.Add("border-radius:4px");

        // 边框（选中态）
        var border = Selected
            ? "border:2px solid #1890ff"
            : "border:1px solid #e0e0e0";
        parts.Add(border);

        // 阴影
        parts.Add("box-shadow:0 1px 3px rgba(0,0,0,0.1)");

        // 选中态 z-index
        var zIndex = Selected ? "z-index:100" : "z-index:1";
        parts.Add(zIndex);

        // 其他基础样式
        parts.Add("user-select:none");
        parts.Add("position:relative");
        parts.Add("box-sizing:border-box");
        parts.Add("margin:4px");

        // 可见性
        if (!Widget.Visible)
        {
            parts.Add("opacity:0.3");
        }

        // 额外的 CSS 类
        if (!string.IsNullOrWhiteSpace(CssClass))
        {
            parts.Add(CssClass);
        }

        return string.Join("; ", parts);
    }
}

