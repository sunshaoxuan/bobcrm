@using BobCrm.App.Models.Widgets
@inject IJSRuntime JS

@* Line break placeholder: when NewLine=true force widget to start on a new row *@
@if (Widget.NewLine)
{
    <div class="flow-break" style="flex-basis:100%; width:100%; height:0; padding:0; margin:0;"></div>
}

@* Unified widget host: renders widget, handles selection, resize, and blocks native drag interference *@
<div class="layout-widget @(Selected ? "selected" : "")"
     draggable="@(isResizing ? "false" : "true")"
     data-drag-type="widget"
     data-drag-data="@Widget.Id"
     data-widget-id="@Widget.Id"
     @ondragstart="OnDragStart"
     @ondragstart:preventDefault="@isResizing"
     @ondragend="OnDragEnd"
     @onclick="HandleClick"
     @onclick:stopPropagation
     style="@GetWidgetStyle()">

    @* Resize handle (only visible when selected) *@
    @if (Selected && AllowResize)
    {
        <div class="resize-handle"
             draggable="false"
             @onmousedown="HandleResizeStart"
             @onmousedown:stopPropagation
             @onmousedown:preventDefault
             @ondragstart:preventDefault="true"
             style="position:absolute; right:-2px; top:50%; transform:translateY(-50%); width:4px; height:48px; cursor:ew-resize; background:#1890ff; border-radius:2px; z-index:10; box-shadow:0 2px 8px rgba(24,144,255,0.6); opacity:0.8;">
        </div>
    }

    @* Widget content (pointer-events disabled so clicks land on wrapper) *@
    <div class="widget-content" style="width:100%; pointer-events:none;">
        @ChildContent
    </div>
</div>

@code {
    /// <summary>
    /// Widget data model
    /// </summary>
    [Parameter, EditorRequired]
    public DraggableWidget Widget { get; set; } = default!;

    /// <summary>
    /// Whether this widget is selected
    /// </summary>
    [Parameter]
    public bool Selected { get; set; }

    /// <summary>
    /// Whether resizing is in progress (controlled by parent)
    /// </summary>
    [Parameter]
    public bool IsResizing { get; set; }

    /// <summary>
    /// Selection callback
    /// </summary>
    [Parameter]
    public EventCallback<DraggableWidget> OnSelect { get; set; }

    /// <summary>
    /// Drag start callback
    /// </summary>
    [Parameter]
    public EventCallback<(Microsoft.AspNetCore.Components.Web.DragEventArgs e, DraggableWidget widget)> OnWidgetDragStart { get; set; }

    /// <summary>
    /// Drag end callback
    /// </summary>
    [Parameter]
    public EventCallback<Microsoft.AspNetCore.Components.Web.DragEventArgs> OnWidgetDragEnd { get; set; }

    /// <summary>
    /// Resize start callback
    /// </summary>
    [Parameter]
    public EventCallback<(Microsoft.AspNetCore.Components.Web.MouseEventArgs e, DraggableWidget widget)> OnResizeStart { get; set; }

    /// <summary>
    /// Whether resize is allowed (default true)
    /// </summary>
    [Parameter]
    public bool AllowResize { get; set; } = true;

    /// <summary>
    /// Custom content renderer
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Additional CSS class names
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    // Use parent-provided IsResizing instead of managing locally
    private bool isResizing => IsResizing;

    /// <summary>
    /// Handle click selection
    /// </summary>
    private async Task HandleClick()
    {
        if (OnSelect.HasDelegate)
        {
            await OnSelect.InvokeAsync(Widget);
        }
    }

    /// <summary>
    /// Handle drag start
    /// </summary>
    private async Task OnDragStart(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        if (OnWidgetDragStart.HasDelegate)
        {
            await OnWidgetDragStart.InvokeAsync((e, Widget));
        }
    }

    /// <summary>
    /// Handle drag end
    /// </summary>
    private async Task OnDragEnd(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        if (OnWidgetDragEnd.HasDelegate)
        {
            await OnWidgetDragEnd.InvokeAsync(e);
        }
    }

    /// <summary>
    /// Handle resize start
    /// </summary>
    private async Task HandleResizeStart(Microsoft.AspNetCore.Components.Web.MouseEventArgs e)
    {
        if (OnResizeStart.HasDelegate)
        {
            await OnResizeStart.InvokeAsync((e, Widget));
        }
    }

    /// <summary>
    /// Compute widget style (layout options + selection)
    /// </summary>
    private string GetWidgetStyle()
    {
        var parts = new List<string>();

        // Base layout styles
        var widthValue = Widget.Width;
        var flexBasis = Widget.WidthUnit == "%"
            ? $"calc({widthValue}% - 8px)"
            : $"{widthValue}px";
        parts.Add($"flex:0 0 {flexBasis}");

        // Height
        var minHeight = Widget.HeightUnit == "auto" ? "64px" : $"{Widget.Height}px";
        parts.Add($"min-height:{minHeight}");

        // Background and corner radius
        parts.Add("background:#fff");
        parts.Add("border-radius:4px");

        // Border when selected
        var border = Selected
            ? "border:2px solid #1890ff"
            : "border:1px solid #e0e0e0";
        parts.Add(border);

        // Shadow
        parts.Add("box-shadow:0 1px 3px rgba(0,0,0,0.1)");

        // z-index when selected
        var zIndex = Selected ? "z-index:100" : "z-index:1";
        parts.Add(zIndex);

        // Other base styles
        parts.Add("user-select:none");
        parts.Add("position:relative");
        parts.Add("box-sizing:border-box");
        parts.Add("margin:4px");

        // Visibility
        if (!Widget.Visible)
        {
            parts.Add("opacity:0.3");
        }

        // Extra CSS classes
        if (!string.IsNullOrWhiteSpace(CssClass))
        {
            parts.Add(CssClass);
        }

        return string.Join("; ", parts);
    }
}


