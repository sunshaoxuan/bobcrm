@using BobCrm.App.Models
@using BobCrm.App.Services
@inject IRoleService RoleService
@inject IMessageService Message
@inject I18nService I18n
@inject IMultilingualTextResolver MultilingualResolver

<div class="role-permission-tree">
    @if (_loading)
    {
        <Spin />
    }
    else
    {
        <div class="permission-header">
            <h4>@I18n.T("LBL_ROLE_PERMISSIONS")</h4>
        </div>

        <Tabs DefaultActiveKey="1" Type="@TabType.Card">
            <TabPane Key="1" Tab="@I18n.T("LBL_FUNCTION_PERMISSIONS")">
                <div class="permission-tab-content">
                    <div class="permission-tree-header">
                        <Space>
                <SpaceItem>
                    <Button Size="@ButtonSize.Small" Icon="@IconType.Outline.CheckSquare" OnClick="SelectAll">
                        @I18n.T("BTN_SELECT_ALL")
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Size="@ButtonSize.Small" Icon="@IconType.Outline.MinusSquare" OnClick="DeselectAll">
                        @I18n.T("BTN_DESELECT_ALL")
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Size="@ButtonSize.Small" Icon="@IconType.Outline.ExpandAlt" OnClick="ExpandAll">
                        @I18n.T("BTN_EXPAND_ALL")
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Size="@ButtonSize.Small" Icon="@IconType.Outline.Compress" OnClick="CollapseAll">
                        @I18n.T("BTN_COLLAPSE_ALL")
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Primary"
                            Size="@ButtonSize.Small"
                            Icon="@IconType.Outline.Save"
                            Loading="_saving"
                            OnClick="SavePermissionsAsync">
                        @I18n.T("BTN_SAVE")
                    </Button>
                </SpaceItem>
            </Space>
        </div>

        @if (ShowSearch)
        {
            <div class="permission-tree-search">
                <Input Placeholder="@I18n.T("LBL_SEARCH_PERMISSIONS")"
                       @bind-Value="_searchText"
                       AllowClear
                       Suffix="@_searchSuffix" />
            </div>
        }

        <div class="permission-tree-container">
            @if (_treeData.Count == 0)
            {
                <Empty Description="@I18n.T("TXT_NO_PERMISSIONS")" />
            }
            else
            {
                <Tree TItem="TreeNode<Guid>"
                      DataSource="_treeData"
                      TitleExpression="x => x.DataItem.Title"
                      KeyExpression="x => x.DataItem.Key"
                      ChildrenExpression="x => x.DataItem.Children"
                      IsLeafExpression="x => x.DataItem.IsLeaf"
                      Checkable
                      Selectable="false"
                      @bind-CheckedKeys="_checkedKeys"
                      @bind-ExpandedKeys="_expandedKeys"
                      DefaultExpandAll="@DefaultExpandAll" />
            }
        </div>

        @if (ShowStatistics)
        {
            <div class="permission-tree-stats">
                <Statistic Title="@I18n.T("LBL_TOTAL_FUNCTIONS")" Value="_totalFunctions" />
                <Statistic Title="@I18n.T("LBL_SELECTED_PERMISSIONS")" Value="_checkedKeys.Length" />
            </div>
        }
                </div>
            </TabPane>

            <TabPane Key="2" Tab="@I18n.T("LBL_FIELD_PERMISSIONS")">
                <div class="permission-tab-content">
                    <RoleFieldPermissions RoleId="@RoleId" />
                </div>
            </TabPane>
        </Tabs>
    }
</div>

<style>
.role-permission-tree {
    padding: 16px;
}

.permission-header {
    margin-bottom: 16px;
}

.permission-header h4 {
    margin: 0;
}

.permission-tab-content {
    padding: 16px 0;
}

.permission-tree-header {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-bottom: 16px;
}

.permission-tree-search {
    margin-bottom: 16px;
}

.permission-tree-container {
    min-height: 300px;
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    padding: 12px;
    background: #fafafa;
}

.permission-tree-stats {
    margin-top: 16px;
    display: flex;
    gap: 24px;
}
</style>

@code {
    [Parameter]
    public Guid? RoleId { get; set; }

    [Parameter]
    public bool ShowSearch { get; set; } = true;

    [Parameter]
    public bool ShowStatistics { get; set; } = true;

    [Parameter]
    public bool DefaultExpandAll { get; set; } = false;

    [Parameter]
    public bool CascadeSelect { get; set; } = true;

    private bool _loading = true;
    private bool _saving = false;
    private string _searchText = "";
    private List<TreeNode<Guid>> _treeData = new();
    private string[] _checkedKeys = Array.Empty<string>();
    private string[] _expandedKeys = Array.Empty<string>();
    private int _totalFunctions = 0;
    private Dictionary<Guid, FunctionMenuNode> _functionLookup = new();
    private List<Guid> _initialCheckedFunctions = new();

    private RenderFragment _searchSuffix => @<Icon Type="@IconType.Outline.Search" />;

    protected override async Task OnParametersSetAsync()
    {
        if (RoleId.HasValue)
        {
            await LoadDataAsync();
        }
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        try
        {
            // 获取功能树
            var treeResponse = await RoleService.GetFunctionTreeAsync();
            var functions = treeResponse.Tree;

            // 获取角色详情（包含权限）
            RoleProfileDto? role = null;
            if (RoleId.HasValue)
            {
                role = await RoleService.GetRoleAsync(RoleId.Value);
            }

            // 构建查找表
            _functionLookup.Clear();
            BuildFunctionLookup(functions);

            // 构建树数据
            _treeData = functions.Select(f => BuildTreeNode(f)).ToList();
            _totalFunctions = _functionLookup.Count;

            // 设置已选中的权限
            if (role != null && role.Functions != null)
            {
                _initialCheckedFunctions = role.Functions.Select(f => f.FunctionId).ToList();
                _checkedKeys = role.Functions.Select(f => f.FunctionId.ToString()).ToArray();
            }
        }
        catch (Exception ex)
        {
            Message.Error($"{I18n.T("MSG_LOAD_FAILED")}: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private void BuildFunctionLookup(List<FunctionMenuNode> nodes)
    {
        foreach (var node in nodes)
        {
            _functionLookup[node.Id] = node;
            if (node.Children.Count > 0)
            {
                BuildFunctionLookup(node.Children);
            }
        }
    }

    private TreeNode<Guid> BuildTreeNode(FunctionMenuNode function)
    {
        var title = MultilingualResolver.Resolve(function.DisplayNameTranslations, function.Name);
        var node = new TreeNode<Guid>
        {
            Key = function.Id.ToString(),
            Title = $"{title} ({function.Code})",
            IsLeaf = function.Children.Count == 0,
            Children = function.Children.Select(BuildTreeNode).ToList()
        };
        return node;
    }

    // Removed OnTreeCheck and OnTreeExpand as we use @bind-CheckedKeys and @bind-ExpandedKeys

    private void SelectAll()
    {
        _checkedKeys = _functionLookup.Keys.Select(k => k.ToString()).ToArray();
        Message.Info(I18n.T("MSG_ALL_SELECTED"));
    }

    private void DeselectAll()
    {
        _checkedKeys = Array.Empty<string>();
        Message.Info(I18n.T("MSG_ALL_DESELECTED"));
    }

    private void ExpandAll()
    {
        _expandedKeys = _functionLookup.Keys.Select(k => k.ToString()).ToArray();
    }

    private void CollapseAll()
    {
        _expandedKeys = Array.Empty<string>();
    }

    private async Task SavePermissionsAsync()
    {
        if (!RoleId.HasValue)
        {
            return;
        }

        _saving = true;
        try
        {
            var selectedFunctionIds = _checkedKeys.Select(Guid.Parse).ToList();

            var request = new UpdatePermissionsRequestDto
            {
                FunctionIds = selectedFunctionIds,
                FunctionPermissions = new List<FunctionPermissionSelectionDto>()
            };

            var success = await RoleService.UpdatePermissionsAsync(RoleId.Value, request);

            if (success)
            {
                Message.Success(I18n.T("MSG_SAVE_SUCCESS"));
                _initialCheckedFunctions = selectedFunctionIds;
            }
            else
            {
                Message.Error(I18n.T("MSG_SAVE_FAILED"));
            }
        }
        catch (Exception ex)
        {
            Message.Error($"{I18n.T("MSG_SAVE_FAILED")}: {ex.Message}");
        }
        finally
        {
            _saving = false;
        }
    }

    private class TreeNode<T>
    {
        public string Key { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public bool IsLeaf { get; set; }
        public List<TreeNode<T>> Children { get; set; } = new();
    }
}
