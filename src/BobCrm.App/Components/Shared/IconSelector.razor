@using BobCrm.App.Services.Multilingual
@inject I18nService I18n

<div class="icon-selector">
    <div class="icon-selector-input">
        <InputGroup Compact>
            <Input @bind-Value="@_inputValue"
                   Placeholder="@I18n.T("LBL_ICON_NAME")"
                   OnInput="HandleInputChange"
                   Style="width: calc(100% - 80px)"
                   Prefix="@PrefixTemplate">
            </Input>
            <Button Type="@ButtonType.Default"
                    Icon="@IconType.Outline.AppstoreAdd"
                    OnClick="TogglePicker"
                    Style="width: 80px">
                @I18n.T("BTN_SELECT")
            </Button>
        </InputGroup>
    </div>

    @if (_showPicker)
    {
        <div class="icon-picker-panel">
            <div class="icon-picker-header">
                <Input @bind-Value="@_searchText"
                       Placeholder="@I18n.T("LBL_SEARCH_ICON")"
                       AllowClear="true"
                       OnInput="HandleSearch"
                       Prefix="@SearchPrefixTemplate">
                </Input>
            </div>
            <div class="icon-picker-body">
                @if (_filteredIcons.Count == 0)
                {
                    <div class="icon-picker-empty">
                        <Icon Type="@IconType.Outline.Inbox" Style="font-size: 32px; color: #d9d9d9" />
                        <p>@I18n.T("TXT_NO_ICONS_FOUND")</p>
                    </div>
                }
                else
                {
                    <div class="icon-grid">
                        @foreach (var icon in _filteredIcons)
                        {
                            <div class="icon-item @(Value == icon.Value ? "selected" : "")"
                                 @onclick="() => SelectIcon(icon.Value)"
                                 title="@icon.Label">
                                <Icon Type="@icon.Value" />
                                <span class="icon-label">@icon.Label</span>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string? Value { get; set; }

    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    private string _inputValue = string.Empty;
    private string _searchText = string.Empty;
    private bool _showPicker = false;
    private List<IconItem> _allIcons = new();
    private List<IconItem> _filteredIcons = new();

    private RenderFragment PrefixTemplate => @<text>
        @if (!string.IsNullOrWhiteSpace(Value))
        {
            <Icon Type="@Value" />
        }
    </text>;

    private RenderFragment SearchPrefixTemplate => @<Icon Type="@IconType.Outline.Search" />;

    protected override void OnInitialized()
    {
        InitializeIcons();
        _inputValue = Value ?? string.Empty;
        _filteredIcons = _allIcons;
    }

    protected override void OnParametersSet()
    {
        if (_inputValue != Value)
        {
            _inputValue = Value ?? string.Empty;
        }
    }

    private void InitializeIcons()
    {
        // Common icon list - Ant Design Blazor Outline icons
        _allIcons = new List<IconItem>
        {
            // General
            new("home", "Home"),
            new("setting", "Setting"),
            new("user", "User"),
            new("team", "Team"),
            new("solution", "Solution"),
            new("search", "Search"),
            new("menu", "Menu"),
            new("appstore", "Appstore"),
            new("dashboard", "Dashboard"),
            new("notification", "Notification"),
            new("bell", "Bell"),
            new("message", "Message"),
            new("mail", "Mail"),

            // Files and documents
            new("file", "File"),
            new("file-text", "File Text"),
            new("folder", "Folder"),
            new("folder-open", "Folder Open"),
            new("book", "Book"),
            new("read", "Read"),
            new("save", "Save"),
            new("copy", "Copy"),
            new("file-add", "File Add"),
            new("folder-add", "Folder Add"),

            // Edit actions
            new("edit", "Edit"),
            new("delete", "Delete"),
            new("plus", "Plus"),
            new("plus-circle", "Plus Circle"),
            new("minus", "Minus"),
            new("minus-circle", "Minus Circle"),
            new("close", "Close"),
            new("close-circle", "Close Circle"),
            new("check", "Check"),
            new("check-circle", "Check Circle"),

            // Navigation
            new("left", "Left"),
            new("right", "Right"),
            new("up", "Up"),
            new("down", "Down"),
            new("arrow-left", "Arrow Left"),
            new("arrow-right", "Arrow Right"),
            new("arrow-up", "Arrow Up"),
            new("arrow-down", "Arrow Down"),
            new("rollback", "Rollback"),
            new("enter", "Enter"),

            // Media
            new("picture", "Picture"),
            new("camera", "Camera"),
            new("video-camera", "Video Camera"),
            new("sound", "Sound"),
            new("play-circle", "Play Circle"),

            // Commerce
            new("shop", "Shop"),
            new("shopping", "Shopping"),
            new("shopping-cart", "Shopping Cart"),
            new("dollar", "Dollar"),
            new("credit-card", "Credit Card"),
            new("wallet", "Wallet"),
            new("bank", "Bank"),
            new("gift", "Gift"),

            // Data visualization
            new("table", "Table"),
            new("bar-chart", "Bar Chart"),
            new("pie-chart", "Pie Chart"),
            new("line-chart", "Line Chart"),
            new("area-chart", "Area Chart"),
            new("stock", "Stock"),
            new("fund", "Fund"),

            // Communication
            new("phone", "Phone"),
            new("mobile", "Mobile"),
            new("contacts", "Contacts"),
            new("customer-service", "Customer Service"),
            new("idcard", "ID Card"),

            // Maps and location
            new("environment", "Environment"),
            new("compass", "Compass"),
            new("global", "Global"),

            // Time
            new("clock-circle", "Clock"),
            new("calendar", "Calendar"),
            new("hourglass", "Hourglass"),

            // Tools
            new("tool", "Tool"),
            new("api", "API"),
            new("code", "Code"),
            new("bug", "Bug"),
            new("experiment", "Experiment"),
            new("bulb", "Bulb"),
            new("rocket", "Rocket"),

            // Status
            new("info-circle", "Info"),
            new("question-circle", "Question"),
            new("warning", "Warning"),
            new("exclamation-circle", "Exclamation"),
            new("stop", "Stop"),
            new("loading", "Loading"),

            // Security
            new("lock", "Lock"),
            new("unlock", "Unlock"),
            new("key", "Key"),
            new("safety", "Safety"),
            new("eye", "Eye"),
            new("eye-invisible", "Eye Invisible"),

            // Other
            new("heart", "Heart"),
            new("star", "Star"),
            new("like", "Like"),
            new("dislike", "Dislike"),
            new("fire", "Fire"),
            new("flag", "Flag"),
            new("tag", "Tag"),
            new("tags", "Tags"),
            new("coffee", "Coffee"),
            new("crown", "Crown"),
            new("trophy", "Trophy"),
            new("gift", "Gift"),
            new("skin", "Skin"),
            new("smile", "Smile"),
        };
    }

    private async Task HandleInputChange(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString() ?? string.Empty;
        _inputValue = newValue;
        await UpdateValue(newValue);
    }

    private void HandleSearch(ChangeEventArgs e)
    {
        _searchText = e.Value?.ToString() ?? string.Empty;
        FilterIcons();
    }

    private void FilterIcons()
    {
        if (string.IsNullOrWhiteSpace(_searchText))
        {
            _filteredIcons = _allIcons;
        }
        else
        {
            var searchLower = _searchText.ToLower();
            _filteredIcons = _allIcons
                .Where(icon => icon.Value.Contains(searchLower, StringComparison.OrdinalIgnoreCase)
                            || icon.Label.Contains(searchLower, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }

    private void TogglePicker()
    {
        _showPicker = !_showPicker;
        if (_showPicker)
        {
            _searchText = string.Empty;
            FilterIcons();
        }
    }

    private async Task SelectIcon(string iconValue)
    {
        _inputValue = iconValue;
        _showPicker = false;
        await UpdateValue(iconValue);
    }

    private async Task UpdateValue(string? newValue)
    {
        if (Value != newValue)
        {
            Value = newValue;
            await ValueChanged.InvokeAsync(newValue);
        }
    }

    private record IconItem(string Value, string Label);
}
