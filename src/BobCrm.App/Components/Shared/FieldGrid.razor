@using BobCrm.App.Models
@using BobCrm.Api.Contracts.DTOs
@using BobCrm.App.Services.Multilingual
@inject IMultilingualTextResolver MultilingualTextResolver
@inject BobCrm.App.Services.I18nService I18n

<div class="field-grid-container">
    <Table TItem="FieldViewModel"
           DataSource="@Fields"
           Size="@TableSize.Small"
           Bordered
           Responsive>

        <ChildContent Context="field">
            <Column Title='@I18n.T("FG_COL_CODE")' TData="string" Width="150px">
                @if (field.IsEditing)
                {
                    <Input @bind-Value="@field.PropertyName"
                           Placeholder='@I18n.T("FG_PLACEHOLDER_CODE")'
                           Status="@(string.IsNullOrWhiteSpace(field.PropertyName) ? "error" : "")" />
                }
                else
                {
                    <Text>@field.PropertyName</Text>
                }
            </Column>

            <Column Title='@I18n.T("FG_COL_DISPLAY_NAME")' TData="string" Width="200px">
                @if (field.IsEditing)
                {
                    <MultilingualInput @bind-Value="@field.DisplayName" />
                }
                else
                {
                    <Text>@MultilingualTextResolver.Resolve(field.DisplayName, "-")</Text>
                }
            </Column>

            <Column Title='@I18n.T("FG_COL_DATA_TYPE")' TData="string" Width="120px">
                @if (field.IsEditing)
                {
                    <Select TItem="string"
                            TItemValue="string"
                            Value="@field.DataType"
                            Style="width: 100%"
                            ValueChanged="@(value => { field.DataType = value; OnDataTypeChanged(field); })">
                        <SelectOption Value="@("String")">String</SelectOption>
                        <SelectOption Value="@("Int32")">Int32</SelectOption>
                        <SelectOption Value="@("Int64")">Int64</SelectOption>
                        <SelectOption Value="@("Decimal")">Decimal</SelectOption>
                        <SelectOption Value="@("DateTime")">DateTime</SelectOption>
                        <SelectOption Value="@("Date")">Date</SelectOption>
                        <SelectOption Value="@("Boolean")">Boolean</SelectOption>
                        <SelectOption Value="@("Guid")">Guid</SelectOption>
                        <SelectOption Value="@("Enum")">Enum</SelectOption>
                    </Select>
                }
                else
                {
                    <Text>@field.DataType</Text>
                }
            </Column>

            <Column Title='@I18n.T("FG_COL_LENGTH")' TData="int?" Width="100px">
                @if (field.IsEditing && field.DataType == "String")
                {
                    <AntDesign.InputNumber @bind-Value="@field.Length"
                                 Min="1"
                                 Max="5000"
                                 Placeholder='@I18n.T("FG_PLACEHOLDER_OPTIONAL")' />
                }
                else if (!field.IsEditing)
                {
                    <Text>@(field.Length?.ToString() ?? "-")</Text>
                }
            </Column>

            <Column Title='@I18n.T("FG_COL_ENUM_CONFIG")' TData="string" Width="200px">
                @if (field.IsEditing && field.DataType == "Enum")
                {
                    <div style="display:flex; gap:8px; align-items:center;">
                        <Select TItem="EnumDefinitionDto"
                                TItemValue="Guid?"
                                DataSource="@EnumDefinitions"
                                @bind-Value="@field.EnumDefinitionId"
                                LabelName="@nameof(EnumDefinitionDto.Code)"
                                ValueName="@nameof(EnumDefinitionDto.Id)"
                                Placeholder='@I18n.T("FG_PLACEHOLDER_SELECT_ENUM")'
                                Style="width: 140px;" />
                        <Checkbox @bind-Value="@field.IsMultiSelect">@I18n.T("FG_LABEL_MULTISELECT")</Checkbox>
                    </div>
                }
                else if (!field.IsEditing && field.DataType == "Enum")
                {
                    var enumDef = EnumDefinitions.FirstOrDefault(e => e.Id == field.EnumDefinitionId);
                    <Text>@(enumDef?.Code ?? "-") @(field.IsMultiSelect ? $"({I18n.T("FG_LABEL_MULTISELECT")})" : "")</Text>
                }
                else
                {
                    <Text>-</Text>
                }
            </Column>

            <Column Title='@I18n.T("FG_COL_REQUIRED")' TData="bool" Width="80px" Align="ColumnAlign.Center">
                @if (field.IsEditing)
                {
                    <Checkbox Checked="@field.IsRequired"
                              CheckedChanged="@((bool value) => { field.IsRequired = value; StateHasChanged(); })" />
                }
                else
                {
                    <Checkbox Checked="@field.IsRequired" Disabled />
                }
            </Column>

            <Column Title='@I18n.T("FG_COL_DEFAULT")' TData="string" Width="120px">
                @if (field.IsEditing)
                {
                    <Input @bind-Value="@field.DefaultValue"
                           Placeholder='@I18n.T("FG_PLACEHOLDER_OPTIONAL")' />
                }
                else
                {
                    <Text>@(field.DefaultValue ?? "-")</Text>
                }
            </Column>

                        <Column Title='''@I18n.T("FG_COL_ACTIONS")''' TData="string" Width="180px">
                @if (field.IsEditing)
                {
                    <Space Size="@("small")">
                        <SpaceItem>
                            <Button Size="@ButtonSize.Small"
                                    Type="@ButtonType.Primary"
                                    Icon="@IconType.Outline.Check"
                                    OnClick="@(() => SaveField(field))">
                                @I18n.T("FG_BTN_SAVE")
                            </Button>
                        </SpaceItem>
                        <SpaceItem>
                            <Button Size="@ButtonSize.Small"
                                    Icon="@IconType.Outline.Close"
                                    OnClick="@(() => CancelEdit(field))">
                                @I18n.T("FG_BTN_CANCEL")
                            </Button>
                        </SpaceItem>
                    </Space>
                }
                else
                {
                    <Space Size="@("small")">
                        <SpaceItem>
                            <Button Size="@ButtonSize.Small"
                                    Icon="@IconType.Outline.Edit"
                                    OnClick="@(() => EditField(field))"
                                    Title='''@I18n.T("FG_BTN_EDIT")''' />
                        </SpaceItem>
                        <SpaceItem>
                            <Button Size="@ButtonSize.Small"
                                    Icon="@IconType.Outline.Copy"
                                    OnClick="@(() => CopyField(field))"
                                    Title='''@I18n.T("FG_BTN_COPY")''' />
                        </SpaceItem>
                        <SpaceItem>
                            <Popconfirm Title='''@I18n.T("FG_MSG_DELETE_CONFIRM")'''
                                        OnConfirm="@(() => DeleteField(field))">
                                <Button Size="@ButtonSize.Small"
                                        Icon="@IconType.Outline.Delete"
                                        Danger
                                        Title='''@I18n.T("FG_BTN_DELETE")''' />
                            </Popconfirm>
                        </SpaceItem>
                    </Space>
                }
            </Column>
        </ChildContent>
    </Table>

    @foreach (var field in Fields.Where(f => f.ValidationError != null))
    {
        <Alert Type="@AlertType.Error"
               Message="@field.ValidationError"
               ShowIcon="true"
               Closable />
    }

    <div class="field-grid-actions">
        <Button Type="@ButtonType.Dashed"
                Icon="@IconType.Outline.Plus"
                Block
                OnClick="@AddField">
            @I18n.T("FG_BTN_ADD_FIELD")
        </Button>
    </div>
</div>

@code {
    [Parameter, EditorRequired] public List<FieldViewModel> Fields { get; set; } = new();
    [Parameter] public List<EnumDefinitionDto> EnumDefinitions { get; set; } = new();
    [Parameter] public EventCallback<FieldViewModel> OnFieldChanged { get; set; }
    [Parameter] public EventCallback<FieldViewModel> OnFieldAdded { get; set; }
    [Parameter] public EventCallback<Guid> OnFieldRemoved { get; set; }

    private Dictionary<Guid, FieldViewModel> _backupFields = new();

    private void AddField()
    {
        // Cancel other rows that might be editing
        CancelAllEditing();

        var newField = new FieldViewModel
        {
            TempId = Guid.NewGuid(),
            Id = Guid.Empty,
            IsEditing = true,
            SortOrder = Fields.Count,
            DataType = "String"
        };

        Fields.Add(newField);
        StateHasChanged();
    }

    private void EditField(FieldViewModel field)
    {
        // Cancel other rows that might be editing
        CancelAllEditing();

        // Backup current field before edit
        _backupFields[field.TempId] = field.Clone();
        field.IsEditing = true;
        StateHasChanged();
    }

    private async Task SaveField(FieldViewModel field)
    {
        // Validate input
        if (!field.Validate())
        {
            StateHasChanged();
            return;
        }

        // Enforce unique property name
        var duplicateField = Fields.FirstOrDefault(f =>
            f.TempId != field.TempId &&
            f.PropertyName.Equals(field.PropertyName, StringComparison.OrdinalIgnoreCase));

        if (duplicateField != null)
        {
            field.ValidationError = string.Format(I18n.T("FG_MSG_DUPLICATE_CODE"), field.PropertyName);
            StateHasChanged();
            return;
        }

        field.IsEditing = false;
        field.ValidationError = null;
        _backupFields.Remove(field.TempId);

        if (field.IsNew)
        {
            await OnFieldAdded.InvokeAsync(field);
        }
        else
        {
            await OnFieldChanged.InvokeAsync(field);
        }

        StateHasChanged();
    }

    private void CancelEdit(FieldViewModel field)
    {
        if (_backupFields.TryGetValue(field.TempId, out var backup))
        {
            // Restore original value
            var index = Fields.IndexOf(field);
            if (index >= 0)
            {
                Fields[index] = backup;
            }
            _backupFields.Remove(field.TempId);
        }
        else if (field.IsNew)
        {
            // Cancel new field and remove it
            Fields.Remove(field);
        }

        StateHasChanged();
    }

    private void CopyField(FieldViewModel field)
    {
        // Cancel other rows that might be editing
        CancelAllEditing();

        var newField = field.Clone();
        newField.TempId = Guid.NewGuid();
        newField.Id = Guid.Empty;
        newField.PropertyName = GenerateUniqueName(field.PropertyName);
        newField.IsEditing = true;
        newField.SortOrder = Fields.Count;

        Fields.Add(newField);
        StateHasChanged();
    }

    private async Task DeleteField(FieldViewModel field)
    {
        Fields.Remove(field);
        await OnFieldRemoved.InvokeAsync(field.TempId);
        StateHasChanged();
    }

    private void OnDataTypeChanged(FieldViewModel field)
    {
        // Clear unrelated fields when data type changes
        if (field.DataType != "String")
        {
            field.Length = null;
        }
        if (field.DataType != "Decimal")
        {
            field.Precision = null;
            field.Scale = null;
        }
        if (field.DataType != "Decimal")
        {
            field.Precision = null;
            field.Scale = null;
        }
        if (field.DataType != "Enum")
        {
            field.EnumDefinitionId = null;
            field.IsMultiSelect = false;
        }
        StateHasChanged();
    }

    private void CancelAllEditing()
    {
        foreach (var field in Fields.Where(f => f.IsEditing).ToList())
        {
            if (field.IsNew)
            {
                Fields.Remove(field);
            }
            else if (_backupFields.TryGetValue(field.TempId, out var backup))
            {
                var index = Fields.IndexOf(field);
                if (index >= 0)
                {
                    Fields[index] = backup;
                }
                _backupFields.Remove(field.TempId);
            }
        }
    }

    private string GenerateUniqueName(string baseName)
    {
        var existingNames = Fields.Select(f => f.PropertyName.ToLower()).ToHashSet();
        var newName = baseName;
        var counter = 1;

        while (existingNames.Contains(newName.ToLower()))
        {
            newName = $"{baseName}{counter}";
            counter++;
        }

        return newName;
    }
}









