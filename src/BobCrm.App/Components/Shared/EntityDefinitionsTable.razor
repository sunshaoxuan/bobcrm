@using AntDesign
@using BobCrm.App.Models
@using BobCrm.App.Services.Multilingual
@inject IMultilingualTextResolver MultilingualResolver
@inject BobCrm.App.Services.I18nService I18n

<Table TItem="EntityDefinitionDto" DataSource="@Entities" Loading="@false" PageSize="20">
    <PropertyColumn Property="e => e.EntityName" Title="@I18n.T("EDT_COL_ENTITY_NAME")" Sortable>
        <a @onclick="() => OnEdit.InvokeAsync(context.Id)" style="cursor: pointer;">
            @context.EntityName
        </a>
    </PropertyColumn>
    <Column TData="string" Title="@I18n.T("EDT_COL_DISPLAY_NAME")">
        @MultilingualResolver.Resolve(context.DisplayName, context.EntityName)
    </Column>
    <PropertyColumn Property="e => e.Namespace" Title="@I18n.T("EDT_COL_NAMESPACE")" />
    <PropertyColumn Property="e => e.Source" Title="@I18n.T("EDT_COL_SOURCE")">
        <Tag Color="@GetSourceTagColor(context.Source)">
            @context.Source
        </Tag>
    </PropertyColumn>
    <PropertyColumn Property="e => e.Status" Title="@I18n.T("EDT_COL_STATUS")">
        <Tag Color="@GetStatusTagColor(context.Status)">
            @GetStatusText(context.Status)
        </Tag>
    </PropertyColumn>
    <PropertyColumn Property="e => e.IsLocked" Title="@I18n.T("EDT_COL_LOCKED")">
        @if (context.IsLocked)
        {
            <Icon Type="lock" Theme="@IconThemeType.Outline" />
        }
        else
        {
            <Icon Type="unlock" Theme="@IconThemeType.Outline" />
        }
    </PropertyColumn>
    <PropertyColumn Property="e => e.FieldCount" Title="@I18n.T("EDT_COL_FIELD_COUNT")" />
    <PropertyColumn Property="e => e.UpdatedAt" Title="@I18n.T("EDT_COL_UPDATED_AT")" Format="yyyy-MM-dd HH:mm" />
    <ActionColumn Title="@I18n.T("LBL_ACTIONS")">
        <Space>
            <SpaceItem>
                <Button Size="@ButtonSize.Small" OnClick="() => OnEdit.InvokeAsync(context.Id)">
                    @I18n.T("BTN_EDIT")
                </Button>
            </SpaceItem>
            @if (context.Status == EntityStatus.Draft || context.Status == EntityStatus.Modified)
            {
                <SpaceItem>
                    <Button Type="@ButtonType.Primary" Size="@ButtonSize.Small" OnClick="() => OnPublish.InvokeAsync(context.Id)">
                        @I18n.T("EDT_BTN_PUBLISH")
                    </Button>
                </SpaceItem>
            }
            @if (context.Source == EntitySource.Custom && context.Status == EntityStatus.Draft)
            {
                <SpaceItem>
                    <Popconfirm Title="@I18n.T("EDT_CONFIRM_DELETE")" OnConfirm="() => OnDelete.InvokeAsync(context.Id)">
                        <Button Danger Size="@ButtonSize.Small">
                            @I18n.T("BTN_DELETE")
                        </Button>
                    </Popconfirm>
                </SpaceItem>
            }
        </Space>
    </ActionColumn>
</Table>

@code {
    [Parameter] public List<EntityDefinitionDto> Entities { get; set; } = new();
    [Parameter] public EventCallback<Guid> OnEdit { get; set; }
    [Parameter] public EventCallback<Guid> OnPublish { get; set; }
    [Parameter] public EventCallback<Guid> OnDelete { get; set; }
    [Parameter] public EventCallback OnReload { get; set; }

    private TagColor GetSourceTagColor(string? source)
        => string.Equals(source, EntitySource.System, StringComparison.OrdinalIgnoreCase)
            ? TagColor.Default
            : TagColor.Success;

    private TagColor GetStatusTagColor(string? status) => (status ?? string.Empty) switch
    {
        EntityStatus.Draft => TagColor.Warning,
        EntityStatus.Published => TagColor.Success,
        EntityStatus.Modified => TagColor.Processing,
        _ => TagColor.Default
    };

    private string GetStatusText(string? status) => (status ?? string.Empty) switch
    {
        EntityStatus.Draft => I18n.T("LBL_STATUS_DRAFT"),
        EntityStatus.Published => I18n.T("LBL_STATUS_PUBLISHED"),
        EntityStatus.Modified => I18n.T("LBL_STATUS_MODIFIED"),
        _ => status ?? string.Empty
    };
}
