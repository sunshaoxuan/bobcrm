@using AntDesign
@using BobCrm.App.Models
@using BobCrm.App.Services.Multilingual
@inject IMultilingualTextResolver MultilingualResolver

<Table TItem="EntityDefinitionDto" DataSource="@Entities" Loading="@false" PageSize="20">
    <PropertyColumn Property="e => e.EntityName" Title="实体名" Sortable>
        <a @onclick="() => OnEdit.InvokeAsync(context.Id)" style="cursor: pointer;">
            @context.EntityName
        </a>
    </PropertyColumn>
    <Column TData="string" Title="显示名">
        @MultilingualResolver.Resolve(context.DisplayName, context.EntityName)
    </Column>
    <PropertyColumn Property="e => e.Namespace" Title="命名空间" />
    <PropertyColumn Property="e => e.Source" Title="来源">
        <Tag Color="@GetSourceTagColor(context.Source)">
            @context.Source
        </Tag>
    </PropertyColumn>
    <PropertyColumn Property="e => e.Status" Title="状态">
        <Tag Color="@GetStatusTagColor(context.Status)">
            @GetStatusText(context.Status)
        </Tag>
    </PropertyColumn>
    <PropertyColumn Property="e => e.IsLocked" Title="锁定">
        @if (context.IsLocked)
        {
            <Icon Type="lock" Theme="@IconThemeType.Outline" />
        }
        else
        {
            <Icon Type="unlock" Theme="@IconThemeType.Outline" />
        }
    </PropertyColumn>
    <PropertyColumn Property="e => e.Fields.Count" Title="字段数" />
    <PropertyColumn Property="e => e.UpdatedAt" Title="更新时间" Format="yyyy-MM-dd HH:mm" />
    <ActionColumn Title="操作">
        <Space>
            <SpaceItem>
                <Button Size="@ButtonSize.Small" OnClick="() => OnEdit.InvokeAsync(context.Id)">
                    编辑
                </Button>
            </SpaceItem>
            @if (context.Status == EntityStatus.Draft || context.Status == EntityStatus.Modified)
            {
                <SpaceItem>
                    <Button Type="@ButtonType.Primary" Size="@ButtonSize.Small" OnClick="() => OnPublish.InvokeAsync(context.Id)">
                        发布
                    </Button>
                </SpaceItem>
            }
            @if (context.Source == EntitySource.Custom && context.Status == EntityStatus.Draft)
            {
                <SpaceItem>
                    <Popconfirm Title="确认发布?" OnConfirm="() => OnDelete.InvokeAsync(context.Id)">
                        <Button Danger Size="@ButtonSize.Small">
                            删除
                        </Button>
                    </Popconfirm>
                </SpaceItem>
            }
        </Space>
    </ActionColumn>
</Table>

@code {
    [Parameter] public List<EntityDefinitionDto> Entities { get; set; } = new();
    [Parameter] public EventCallback<Guid> OnEdit { get; set; }
    [Parameter] public EventCallback<Guid> OnPublish { get; set; }
    [Parameter] public EventCallback<Guid> OnDelete { get; set; }
    [Parameter] public EventCallback OnReload { get; set; }

    private TagColor GetSourceTagColor(string? source)
        => string.Equals(source, EntitySource.System, StringComparison.OrdinalIgnoreCase)
            ? TagColor.Default
            : TagColor.Success;

    private TagColor GetStatusTagColor(string? status) => (status ?? string.Empty) switch
    {
        EntityStatus.Draft => TagColor.Warning,
        EntityStatus.Published => TagColor.Success,
        EntityStatus.Modified => TagColor.Processing,
        _ => TagColor.Default
    };

    private string GetStatusText(string? status) => (status ?? string.Empty) switch
    {
        EntityStatus.Draft => "草稿",
        EntityStatus.Published => "已发布",
        EntityStatus.Modified => "已修改",
        _ => status ?? string.Empty
    };
}

