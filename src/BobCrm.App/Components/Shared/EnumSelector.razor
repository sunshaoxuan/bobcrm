@using System.Net.Http.Json
@using BobCrm.Api.Contracts.DTOs
@using AntDesign
@inject HttpClient Http
@inject BobCrm.App.Services.ToastService Toast
@inject I18nService I18n

@*
    EnumSelector - 枚举选择器组件
    动态加载枚举选项的下拉选择器，使用 Ant Design 组件
*@

@if (_isLoading)
{
    <Spin Size="@SpinSize.Small" />
}
else if (_error != null)
{
    <Alert Type="@AlertType.Error" Message="@_error" ShowIcon />
}
else if (MultiSelect)
{
    <Select Mode="multiple"
            Value="_selectedValues"
            OnSelectedItemsChanged="HandleMultiSelectChangeAsync"
            Placeholder="@Placeholder"
            AllowClear
            ShowSearch
            Disabled="@Disabled"
            Style="width: 100%;">
        <SelectOptions>
            @foreach (var option in _options)
            {
                <SelectOption TItemValue="string" TItem="string" Value="@option.Value" Label="@GetDisplayName(option)">
                    @if (!string.IsNullOrEmpty(option.ColorTag))
                    {
                        <Tag Color="@option.ColorTag">
                            @if (!string.IsNullOrEmpty(option.Icon))
                            {
                                <Icon Type="@option.Icon" Theme="outline" />
                                <span> </span>
                            }
                            @GetDisplayName(option)
                        </Tag>
                    }
                    else
                    {
                        @if (!string.IsNullOrEmpty(option.Icon))
                        {
                            <Icon Type="@option.Icon" Theme="outline" />
                            <span> </span>
                        }
                        @GetDisplayName(option)
                    }
                </SelectOption>
            }
        </SelectOptions>
    </Select>
}
else
{
    <Select Value="@_selectedValue"
            OnSelectedItemChanged="HandleSingleSelectChangeAsync"
            Placeholder="@Placeholder"
            AllowClear
            ShowSearch
            Disabled="@Disabled"
            Style="width: 100%;">
        <SelectOptions>
            @foreach (var option in _options)
            {
                <SelectOption TItemValue="string" TItem="string" Value="@option.Value" Label="@GetDisplayName(option)">
                    @if (!string.IsNullOrEmpty(option.ColorTag))
                    {
                        <Tag Color="@option.ColorTag">
                            @if (!string.IsNullOrEmpty(option.Icon))
                            {
                                <Icon Type="@option.Icon" Theme="outline" />
                                <span> </span>
                            }
                            @GetDisplayName(option)
                        </Tag>
                    }
                    else
                    {
                        @if (!string.IsNullOrEmpty(option.Icon))
                        {
                            <Icon Type="@option.Icon" Theme="outline" />
                            <span> </span>
                        }
                        @GetDisplayName(option)
                    }
                </SelectOption>
            }
        </SelectOptions>
    </Select>
}

@code {
    /// <summary>
    /// 枚举代码（用于加载枚举定义）
    /// </summary>
    [Parameter, EditorRequired]
    public string EnumCode { get; set; } = string.Empty;

    /// <summary>
    /// 单选模式的值
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// 单选值变更回调
    /// </summary>
    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    /// <summary>
    /// 多选模式的值
    /// </summary>
    [Parameter]
    public IEnumerable<string>? Values { get; set; }

    /// <summary>
    /// 多选值变更回调
    /// </summary>
    [Parameter]
    public EventCallback<IEnumerable<string>?> ValuesChanged { get; set; }

    /// <summary>
    /// 是否多选模式
    /// </summary>
    [Parameter]
    public bool MultiSelect { get; set; } = false;

    /// <summary>
    /// 占位符文本
    /// </summary>
    [Parameter]
    public string Placeholder { get; set; } = "请选择...";

    /// <summary>
    /// 当前语言
    /// </summary>
    [Parameter]
    public string CurrentLanguage { get; set; } = "zh";

    /// <summary>
    /// 是否禁用
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; } = false;

    private bool _isLoading = true;
    private string? _error;
    private List<EnumOptionDto> _options = new();
    private string? _selectedValue;
    private IEnumerable<string>? _selectedValues;

    protected override async Task OnInitializedAsync()
    {
        await LoadOptionsAsync();
        _selectedValue = Value;
        _selectedValues = Values;
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        // Sync local state with parameters when they change externally
        if (MultiSelect)
        {
            _selectedValues = Values;
        }
        else
        {
            _selectedValue = Value;
        }
    }

    /// <summary>
    /// 处理单选值变更
    /// </summary>
    private async Task HandleSingleSelectChangeAsync(string value)
    {
        _selectedValue = value;

        if (ValueChanged.HasDelegate)
        {
            await ValueChanged.InvokeAsync(value);
        }
    }

    /// <summary>
    /// 处理多选值变更
    /// </summary>
    private async Task HandleMultiSelectChangeAsync(IEnumerable<string> values)
    {
        _selectedValues = values;

        if (ValuesChanged.HasDelegate)
        {
            await ValuesChanged.InvokeAsync(values);
        }
    }

    /// <summary>
    /// 加载枚举选项
    /// </summary>
    private async Task LoadOptionsAsync()
    {
        _isLoading = true;
        _error = null;

        try
        {
            var response = await Http.GetAsync($"/api/enums/by-code/{EnumCode}");

            if (response.IsSuccessStatusCode)
            {
                var enumDef = await response.Content.ReadFromJsonAsync<EnumDefinitionDto>();
                if (enumDef != null)
                {
                    _options = enumDef.Options
                        .Where(o => o.IsEnabled)
                        .OrderBy(o => o.SortOrder)
                        .ToList();
                }
            }
            else
            {
                _error = $"{I18n.T("MSG_ENUM_LOAD_FAILED")} '{EnumCode}'";
            }
        }
        catch (Exception ex)
        {
            _error = $"{I18n.T("MSG_ERROR")}: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    /// <summary>
    /// 获取枚举选项的显示名称
    /// </summary>
    private string GetDisplayName(EnumOptionDto option)
    {
        if (option.DisplayName.TryGetValue(CurrentLanguage, out var name) && !string.IsNullOrEmpty(name))
        {
            return name;
        }

        return option.DisplayName.Values.FirstOrDefault(v => !string.IsNullOrEmpty(v)) ?? option.Value;
    }
}
