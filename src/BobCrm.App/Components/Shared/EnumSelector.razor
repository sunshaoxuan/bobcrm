@using System.Net.Http.Json
@using BobCrm.Api.Contracts.DTOs
@using AntDesign
@inject HttpClient Http
@inject BobCrm.App.Services.ToastService Toast
@inject I18nService I18n

@*
    EnumSelector - enum selector component
    Dropdown that loads enum options dynamically using Ant Design
*@

@if (_isLoading)
{
    <Spin Size="@SpinSize.Small" />
}
else if (_error != null)
{
    <Alert Type="@AlertType.Error" Message="@_error" ShowIcon="true" />
}
else if (MultiSelect)
{
    <Select TItemValue="string"
            TItem="string"
            Mode="@SelectMode.Multiple"
            Values="@_selectedValues"
            ValuesChanged="@(EventCallback.Factory.Create<IEnumerable<string>>(this, HandleMultiSelectChangeAsync))"
            Placeholder="@Placeholder"
            AllowClear
            ShowSearch
            Disabled="@Disabled"
            Style="width: 100%;">
        <SelectOptions>
            @foreach (var option in _options)
            {
                <SelectOption TItemValue="string" TItem="string" Value="@option.Value" Label="@GetDisplayName(option)">
                    @if (!string.IsNullOrEmpty(option.ColorTag))
                    {
                        <Tag Color="@option.ColorTag">
                            @if (!string.IsNullOrEmpty(option.Icon))
                            {
                                <Icon Type="@option.Icon" Theme="@IconThemeType.Outline" />
                                <span> </span>
                            }
                            @GetDisplayName(option)
                        </Tag>
                    }
                    else
                    {
                        @if (!string.IsNullOrEmpty(option.Icon))
                        {
                            <Icon Type="@option.Icon" Theme="@IconThemeType.Outline" />
                            <span> </span>
                        }
                        @GetDisplayName(option)
                    }
                </SelectOption>
            }
        </SelectOptions>
    </Select>
}
else
{
    <Select TItemValue="string"
            TItem="string"
            Value="@_selectedValue"
            OnSelectedItemChanged="@(EventCallback.Factory.Create<string>(this, HandleSingleSelectChangeAsync))"
            Placeholder="@Placeholder"
            AllowClear
            ShowSearch
            Disabled="@Disabled"
            Style="width: 100%;">
        <SelectOptions>
            @foreach (var option in _options)
            {
                <SelectOption TItemValue="string" TItem="string" Value="@option.Value" Label="@GetDisplayName(option)">
                    @if (!string.IsNullOrEmpty(option.ColorTag))
                    {
                        <Tag Color="@option.ColorTag">
                            @if (!string.IsNullOrEmpty(option.Icon))
                            {
                                <Icon Type="@option.Icon" Theme="@IconThemeType.Outline" />
                                <span> </span>
                            }
                            @GetDisplayName(option)
                        </Tag>
                    }
                    else
                    {
                        @if (!string.IsNullOrEmpty(option.Icon))
                        {
                            <Icon Type="@option.Icon" Theme="@IconThemeType.Outline" />
                            <span> </span>
                        }
                        @GetDisplayName(option)
                    }
                </SelectOption>
            }
        </SelectOptions>
    </Select>
}

@code {
    /// <summary>
    /// Enum code (used to load enum definition)
    /// </summary>
    [Parameter, EditorRequired]
    public string EnumCode { get; set; } = string.Empty;

    /// <summary>
    /// Single-select value
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// Single-select value changed callback
    /// </summary>
    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    /// <summary>
    /// Multi-select values
    /// </summary>
    [Parameter]
    public IEnumerable<string>? Values { get; set; }

    /// <summary>
    /// Multi-select values changed callback
    /// </summary>
    [Parameter]
    public EventCallback<IEnumerable<string>?> ValuesChanged { get; set; }

    /// <summary>
    /// Enable multi-select mode
    /// </summary>
    [Parameter]
    public bool MultiSelect { get; set; } = false;

    /// <summary>
    /// Placeholder text
    /// </summary>
    [Parameter]
    public string Placeholder { get; set; } = "Select...";

    /// <summary>
    /// Current language
    /// </summary>
    [Parameter]
    public string CurrentLanguage { get; set; } = "zh";

    /// <summary>
    /// Disable selector
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; } = false;

    private bool _isLoading = true;
    private string? _error;
    private List<EnumOptionDto> _options = new();
    private string? _selectedValue;
    private IEnumerable<string>? _selectedValues;

    protected override async Task OnInitializedAsync()
    {
        await LoadOptionsAsync();
        _selectedValue = Value;
        _selectedValues = Values;
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        // Sync local state with parameters when they change externally
        if (MultiSelect)
        {
            _selectedValues = Values;
        }
        else
        {
            _selectedValue = Value;
        }
    }

    /// <summary>
    /// Handle single-select changes
    /// </summary>
    private async Task HandleSingleSelectChangeAsync(string value)
    {
        _selectedValue = value;

        if (ValueChanged.HasDelegate)
        {
            await ValueChanged.InvokeAsync(value);
        }
    }

    /// <summary>
    /// Handle multi-select changes
    /// </summary>
    private async Task HandleMultiSelectChangeAsync(IEnumerable<string> values)
    {
        _selectedValues = values;

        if (ValuesChanged.HasDelegate)
        {
            await ValuesChanged.InvokeAsync(values);
        }
    }

    /// <summary>
    /// Load enum data
    /// </summary>
    private async Task LoadOptionsAsync()
    {
        _isLoading = true;
        _error = null;

        try
        {
            var response = await Http.GetAsync($"/api/enums/by-code/{EnumCode}");

            if (response.IsSuccessStatusCode)
            {
                var enumDef = await response.Content.ReadFromJsonAsync<EnumDefinitionDto>();
                if (enumDef != null)
                {
                    _options = enumDef.Options
                        .Where(o => o.IsEnabled)
                        .OrderBy(o => o.SortOrder)
                        .ToList();
                }
            }
            else
            {
                _error = $"{I18n.T("MSG_ENUM_LOAD_FAILED")} '{EnumCode}'";
            }
        }
        catch (Exception ex)
        {
            _error = $"{I18n.T("MSG_ERROR")}: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    /// <summary>
    /// Get display name for an enum option
    /// </summary>
    private string GetDisplayName(EnumOptionDto option)
    {
        if (option.DisplayName.TryGetValue(CurrentLanguage, out var name) && !string.IsNullOrEmpty(name))
        {
            return name;
        }

        return option.DisplayName.Values.FirstOrDefault(v => !string.IsNullOrEmpty(v)) ?? option.Value;
    }
}

