============================= test session starts =============================
platform win32 -- Python 3.12.10, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\sunsx\AppData\Local\Programs\Python\Python312\python.exe
cachedir: .pytest_cache
rootdir: C:\workspace\bobcrm
plugins: base-url-2.1.0, playwright-0.7.2
collecting ... collected 1 item

tests/e2e/cases/06_form_design/test_batch2_runtime.py::test_batch2_003_runtime_renders_tabbox_and_number_input[chromium] Checking TabContainer visibility...
TabContainer is visible.
Checking ID Widget visibility...
ID Widget is visible.
ID Widget contains entity ID.
FAILED

================================== FAILURES ===================================
______ test_batch2_003_runtime_renders_tabbox_and_number_input[chromium] ______

auth_admin = <Page url='http://localhost:3000/product/44'>
page = <Page url='http://localhost:3000/product/44'>
standard_product = {'entity_id': '32fe42e4-6103-4886-8f37-5fce03e6f7e8', 'entity_route': 'product', 'full_type_name': 'BobCrm.Base.Custom.Product'}

    def test_batch2_003_runtime_renders_tabbox_and_number_input(auth_admin, page: Page, standard_product):
        page = auth_admin
        entity_type = standard_product["entity_route"]
        full_type = standard_product["full_type_name"]
    
        # Ensure no stale polymorphic bindings override our updates
        db_helper.execute_query(f"DELETE FROM \"TemplateStateBindings\" WHERE \"EntityType\" = '{entity_type}'")
    
        _ensure_template_has_tabbox(entity_type)
        entity_id = _ensure_product_instance(full_type)
    
        # Verify API route used by PageLoader exists before UI (reduce flaky UI failures)
        assert api_helper.login_as_admin()
        check = requests.get(
            f"{API_BASE}/api/{entity_type}s/{entity_id}",
            headers=api_helper.get_headers(),
            timeout=30,
        )
        assert check.status_code == 200, check.text
    
        try:
            page.goto(f"{BASE_URL}/product/{entity_id}")
            page.wait_for_selector(".runtime-shell")
    
            # ��֤ TabBox ��Ⱦ
            print("Checking TabContainer visibility...")
            # .runtime-tab-container ��ʾ TabContainerWidget ��Ⱦ�ɹ�
            expect(page.locator(".runtime-tab-container")).to_be_visible()
            print("TabContainer is visible.")
    
            # ��֤ Number ����� (Id) ��Ⱦ (View Mode)
            print("Checking ID Widget visibility...")
            # ���� label=Id �� .runtime-widget-shell
            id_widget = page.locator(".runtime-widget-shell[data-field='Id']")
            expect(id_widget).to_be_visible()
            print("ID Widget is visible.")
    
            # View Mode renders value in span or div, just check containment
            expect(id_widget).to_contain_text(str(entity_id))
            print("ID Widget contains entity ID.")
        except:
            import os
            debug_path = os.path.join(os.getcwd(), "debug_page_content.html")
            print("WRITING DEBUG HTML TO debug_page_content.html")
            with open("c:/workspace/bobcrm/debug_page_content.html", "w", encoding="utf-8") as f:
                f.write(page.content())
            try:
                page.screenshot(path="c:/workspace/bobcrm/debug_page_screenshot.png")
                print("WRITING DEBUG SCREENSHOT TO debug_page_screenshot.png")
            except:
                print("FAILED TO WRITE SCREENSHOT")
            raise
    
        # Enter edit mode to assert input controls exist
        page.locator(".test-runtime-mode-edit").click()
>       expect(page.locator(".ant-input-number")).to_be_visible(timeout=15000)
E       AssertionError: Locator expected to be visible
E       Actual value: None
E       Error: strict mode violation: locator(".ant-input-number") resolved to 2 elements:
E           1) <div class="ant-input-number" id="ant-blazor-bbe7075b-8d3e-49f3-a32c-908a9ce7f300">��</div> aka locator("#ant-blazor-bbe7075b-8d3e-49f3-a32c-908a9ce7f300")
E           2) <div class="ant-input-number" id="ant-blazor-63978f3d-e936-4197-94f6-5a5442fad7f2">��</div> aka locator("#ant-blazor-63978f3d-e936-4197-94f6-5a5442fad7f2")
E        
E       Call log:
E         - Expect "to_be_visible" with timeout 15000ms
E         - waiting for locator(".ant-input-number")

tests\e2e\cases\06_form_design\test_batch2_runtime.py:289: AssertionError
=========================== short test summary info ===========================
FAILED tests/e2e/cases/06_form_design/test_batch2_runtime.py::test_batch2_003_runtime_renders_tabbox_and_number_input[chromium]
============================= 1 failed in 45.50s ==============================
